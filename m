Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id BD9843D5A7
	for <lists+spice-devel@lfdr.de>; Tue, 11 Jun 2019 20:42:50 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id A86288915F;
	Tue, 11 Jun 2019 18:42:48 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mail.codeweavers.com (mail.codeweavers.com [50.203.203.244])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 6D90E8915F
 for <spice-devel@lists.freedesktop.org>; Tue, 11 Jun 2019 18:42:47 +0000 (UTC)
Received: from 82-64-54-218.subs.proxad.net ([82.64.54.218] helo=amboise)
 by mail.codeweavers.com with esmtpsa (TLS1.2:ECDHE_RSA_AES_256_GCM_SHA384:256)
 (Exim 4.89) (envelope-from <fgouget@free.fr>) id 1halju-0004dL-Rb
 for spice-devel@lists.freedesktop.org; Tue, 11 Jun 2019 13:43:23 -0500
Received: from fgouget by amboise with local (Exim 4.92)
 (envelope-from <fgouget@amboise.dolphin>) id 1haljI-00014m-8z
 for spice-devel@lists.freedesktop.org; Tue, 11 Jun 2019 20:42:44 +0200
Date: Tue, 11 Jun 2019 20:42:44 +0200 (CEST)
From: Francois Gouget <fgouget@codeweavers.com>
To: Spice devel <spice-devel@lists.freedesktop.org>
User-Agent: Alpine 2.21 (DEB 202 2017-01-01)
MIME-Version: 1.0
Message-Id: <E1haljI-00014m-8z@amboise>
X-Spam-Score: -103.7
X-Spam-Report: Spam detection software,
 running on the system "mail.codeweavers.com", 
 has NOT identified this incoming email as spam.  The original
 message has been attached to this so you can view it or label
 similar future email.  If you have any questions, see
 the administrator of that system for details.
 Content preview: schedule_frame() only pulls frames out of GStreamer's
 pipeline
 once all previous decoded frames have been displayed. Thus when the video
 delay is high a decoded frame may have to wait for several fram [...] 
 Content analysis details:   (-103.7 points, 5.0 required)
 pts rule name              description
 ---- ---------------------- --------------------------------------------------
 -100 USER_IN_WHITELIST      From: address is in the user's white-list
 -6.0 ALL_TRUSTED            Passed through trusted hosts only via SMTP
 0.0 TVD_RCVD_IP            Message was received from an IP address
 1.0 FREEMAIL_FROM          Sender email is commonly abused enduser mail
 provider (fgouget[at]free.fr)
 1.0 HEADER_FROM_DIFFERENT_DOMAINS From and EnvelopeFrom 2nd level
 mail domains are different
 0.2 FREEMAIL_FORGED_FROMDOMAIN 2nd level domains in From and
 EnvelopeFrom freemail headers are different
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt;
 c=relaxed/relaxed; 
 d=codeweavers.com; s=6377696661; h=Message-Id:Content-Type:MIME-Version:
 Subject:To:From:Date:Sender:Reply-To:Cc:Content-Transfer-Encoding:Content-ID:
 Content-Description:Resent-Date:Resent-From:Resent-Sender:Resent-To:Resent-Cc
 :Resent-Message-ID:In-Reply-To:References:List-Id:List-Help:List-Unsubscribe:
 List-Subscribe:List-Post:List-Owner:List-Archive;
 bh=wHLAhIJXY+ur1UCxaX7CKimBy3/+WAzEFej3IQbre4M=; b=ppTMh+gtHQoX4fHvr7Sl5KcKIY
 /Zy2bUWWKLo+9y/R0F5E13eZmbipdkZd7XWJaxFjEAxQDenfG6M8/574L7TimX7j0QGAHcJEtiC7I
 doNb8vdDLo0r/XUvjoF0ekWnv21B9aQXfBDgXb2FcJM+d5uYscIr9MJ1nX87qszG2Nuo=;
Subject: [Spice-devel] [client] gstreamer: Fix the decoding time when not
 using GstVideoOverlay
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

c2NoZWR1bGVfZnJhbWUoKSBvbmx5IHB1bGxzIGZyYW1lcyBvdXQgb2YgR1N0cmVhbWVyJ3MgcGlw
ZWxpbmUgb25jZSBhbGwKcHJldmlvdXMgZGVjb2RlZCBmcmFtZXMgaGF2ZSBiZWVuIGRpc3BsYXll
ZC4gVGh1cyB3aGVuIHRoZSB2aWRlbyBkZWxheQppcyBoaWdoIGEgZGVjb2RlZCBmcmFtZSBtYXkg
aGF2ZSB0byB3YWl0IGZvciBzZXZlcmFsIGZyYW1lIGludGVydmFscwpiZWZvcmUgZ2V0X2RlY29k
ZWRfZnJhbWUoKSBsb29rcyBhdCBpdCBhbmQgY29tcHV0ZXMgaXRzIGRlY29kaW5nIHRpbWUuCgpT
byBhdHRhY2ggZGVjb2RlZCBmcmFtZSBzYW1wbGVzIHRvIHRoZSBjb3JyZXNwb25kaW5nIGRlY29k
aW5nX3F1ZXVlCmVudHJ5IGFzIHNvb24gYXMgbmV3X3NhbXBsZSgpIGlzIGNhbGxlZCwgYW5kIGNv
bXB1dGUgdGhlIGRlY29kaW5nIHRpbWUKYW5kIGFzc29jaWF0ZWQgc3RhdGlzdGljcyB0aGVuLiBT
aW1pbGFybHksIG1hdGNoIHNpbmtfZXZlbnRfcHJvYmUoKSdzCm5ldyBidWZmZXIgdG8gYSBkZWNv
ZGluZ19xdWV1ZSBlbnRyeSBhbmQgdXBkYXRlIHRoZSBzdGF0aXN0aWNzIGluIHRoZQpwcm9jZXNz
LiBUaGlzIGVuc3VyZXMgdGhhdCB0aGVyZSBpcyBubyBleHRyYSBkZWxheSBpbiBlaXRoZXIgY2Fz
ZS4KClNpZ25lZC1vZmYtYnk6IEZyYW5jb2lzIEdvdWdldCA8ZmdvdWdldEBjb2Rld2VhdmVycy5j
b20+Ci0tLQogc3JjL2NoYW5uZWwtZGlzcGxheS1nc3QuYyB8IDE4MyArKysrKysrKysrKysrKysr
KysrKy0tLS0tLS0tLS0tLS0tLS0tLQogMSBmaWxlIGNoYW5nZWQsIDk2IGluc2VydGlvbnMoKyks
IDg3IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL3NyYy9jaGFubmVsLWRpc3BsYXktZ3N0LmMg
Yi9zcmMvY2hhbm5lbC1kaXNwbGF5LWdzdC5jCmluZGV4IDkxZWNlMGZhLi5mZWQ3MzU5MiAxMDA2
NDQKLS0tIGEvc3JjL2NoYW5uZWwtZGlzcGxheS1nc3QuYworKysgYi9zcmMvY2hhbm5lbC1kaXNw
bGF5LWdzdC5jCkBAIC0xLDYgKzEsNiBAQAogLyogLSotIE1vZGU6IEM7IGMtYmFzaWMtb2Zmc2V0
OiA0OyBpbmRlbnQtdGFicy1tb2RlOiBuaWwgLSotICovCiAvKgotICAgQ29weXJpZ2h0IChDKSAy
MDE1LTIwMTYgQ29kZVdlYXZlcnMsIEluYworICAgQ29weXJpZ2h0IChDKSAyMDE1LTIwMTYsIDIw
MTkgQ29kZVdlYXZlcnMsIEluYwogCiAgICBUaGlzIGxpYnJhcnkgaXMgZnJlZSBzb2Z0d2FyZTsg
eW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yCiAgICBtb2RpZnkgaXQgdW5kZXIgdGhlIHRl
cm1zIG9mIHRoZSBHTlUgTGVzc2VyIEdlbmVyYWwgUHVibGljCkBAIC01NCw5ICs1NCw5IEBAIHR5
cGVkZWYgc3RydWN0IFNwaWNlR3N0RGVjb2RlciB7CiAKICAgICBHTXV0ZXggcXVldWVzX211dGV4
OwogICAgIEdRdWV1ZSAqZGVjb2RpbmdfcXVldWU7CisgICAgZ3VpbnQgZGVjb2RlZF9mcmFtZXM7
CiAgICAgU3BpY2VHc3RGcmFtZSAqZGlzcGxheV9mcmFtZTsKICAgICBndWludCB0aW1lcl9pZDsK
LSAgICBndWludCBwZW5kaW5nX3NhbXBsZXM7CiB9IFNwaWNlR3N0RGVjb2RlcjsKIAogI2RlZmlu
ZSBWQUxJRF9WSURFT19DT0RFQ19UWVBFKGNvZGVjKSBcCkBAIC0xMjAsOCArMTIwLDYgQEAgc3Rh
dGljIHZvaWQgZnJlZV9nc3RfZnJhbWUoU3BpY2VHc3RGcmFtZSAqZ3N0ZnJhbWUpCiAvKiAtLS0t
LS0tLS0tIEdTdHJlYW1lciBwaXBlbGluZSAtLS0tLS0tLS0tICovCiAKIHN0YXRpYyB2b2lkIHNj
aGVkdWxlX2ZyYW1lKFNwaWNlR3N0RGVjb2RlciAqZGVjb2Rlcik7Ci1zdGF0aWMgdm9pZCBmZXRj
aF9wZW5kaW5nX3NhbXBsZShTcGljZUdzdERlY29kZXIgKmRlY29kZXIpOwotc3RhdGljIFNwaWNl
R3N0RnJhbWUgKmdldF9kZWNvZGVkX2ZyYW1lKFNwaWNlR3N0RGVjb2RlciAqZGVjb2RlciwgR3N0
QnVmZmVyICpidWZmZXIpOwogCiBSRUNPUkRFUihmcmFtZXNfc3RhdHMsIDY0LCAiRnJhbWVzIHN0
YXRpc3RpY3MiKTsKIApAQCAtMTkxLDIxICsxODksMjYgQEAgc3RhdGljIHZvaWQgc2NoZWR1bGVf
ZnJhbWUoU3BpY2VHc3REZWNvZGVyICpkZWNvZGVyKQogICAgIGdfbXV0ZXhfbG9jaygmZGVjb2Rl
ci0+cXVldWVzX211dGV4KTsKIAogICAgIHdoaWxlICghZGVjb2Rlci0+dGltZXJfaWQpIHsKLSAg
ICAgICAgd2hpbGUgKGRlY29kZXItPmRpc3BsYXlfZnJhbWUgPT0gTlVMTCAmJiBkZWNvZGVyLT5w
ZW5kaW5nX3NhbXBsZXMpIHsKLSAgICAgICAgICAgIGZldGNoX3BlbmRpbmdfc2FtcGxlKGRlY29k
ZXIpOworICAgICAgICBHTGlzdCAqaGVhZCA9IGdfcXVldWVfcGVla19oZWFkX2xpbmsoZGVjb2Rl
ci0+ZGVjb2RpbmdfcXVldWUpOworICAgICAgICBpZiAoIWhlYWQpIHsKKyAgICAgICAgICAgIC8q
IE5vIGZyYW1lIGluIHRoZSBxdWV1ZSAqLworICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgIH0K
LQotICAgICAgICBTcGljZUdzdEZyYW1lICpnc3RmcmFtZSA9IGRlY29kZXItPmRpc3BsYXlfZnJh
bWU7Ci0gICAgICAgIGlmICghZ3N0ZnJhbWUpIHsKKyAgICAgICAgU3BpY2VHc3RGcmFtZSAqZ3N0
ZnJhbWUgPSBoZWFkLT5kYXRhOworICAgICAgICBpZiAoIWdzdGZyYW1lLT5kZWNvZGVkX3NhbXBs
ZSkgeworICAgICAgICAgICAgLyogVGhpcyBmcmFtZSBoYXMgbm90IGJlZW4gZGVjb2RlZCB5ZXQg
Ki8KICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICB9CisgICAgICAgIGdfcXVldWVfcG9wX2hl
YWQoZGVjb2Rlci0+ZGVjb2RpbmdfcXVldWUpOworICAgICAgICBkZWNvZGVyLT5kaXNwbGF5X2Zy
YW1lID0gZ3N0ZnJhbWU7CisgICAgICAgIGRlY29kZXItPmRlY29kZWRfZnJhbWVzLS07CiAKICAg
ICAgICAgaWYgKHNwaWNlX21tdGltZV9kaWZmKGdzdGZyYW1lLT5lbmNvZGVkX2ZyYW1lLT5tbV90
aW1lLCBub3cpID49IDApIHsKICAgICAgICAgICAgIGRlY29kZXItPnRpbWVyX2lkID0gZ190aW1l
b3V0X2FkZChnc3RmcmFtZS0+ZW5jb2RlZF9mcmFtZS0+bW1fdGltZSAtIG5vdywKICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5X2ZyYW1lLCBkZWNv
ZGVyKTsKLSAgICAgICAgfSBlbHNlIGlmIChkZWNvZGVyLT5kaXNwbGF5X2ZyYW1lICYmICFkZWNv
ZGVyLT5wZW5kaW5nX3NhbXBsZXMpIHsKLSAgICAgICAgICAgIC8qIFN0aWxsIGF0dGVtcHQgdG8g
ZGlzcGxheSB0aGUgbGVhc3Qgb3V0IG9mIGRhdGUgZnJhbWUgc28gdGhlCi0gICAgICAgICAgICAg
KiB2aWRlbyBpcyBub3QgY29tcGxldGVseSBmcm96ZW4gZm9yIGFuIGV4dGVuZGVkIHBlcmlvZCBv
ZiB0aW1lLgorICAgICAgICB9IGVsc2UgaWYgKGRlY29kZXItPmRpc3BsYXlfZnJhbWUgJiYgZGVj
b2Rlci0+ZGVjb2RlZF9mcmFtZXMgPT0gMCkgeworICAgICAgICAgICAgLyogVGhpcyBpcyB0aGUg
bGVhc3Qgb3V0IG9mIGRhdGUgZnJhbWUuIERpc3BsYXkgaXQgc2luY2UgdGhhdCdzCisgICAgICAg
ICAgICAgKiBiZXR0ZXIgdGhhbiBoYXZpbmcgZnJvemVuIHZpZGVvIGZvciBhbiBleHRlbmRlZCBw
ZXJpb2Qgb2YgdGltZS4KICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgZGVjb2Rlci0+dGlt
ZXJfaWQgPSBnX3RpbWVvdXRfYWRkKDAsIGRpc3BsYXlfZnJhbWUsIGRlY29kZXIpOwogICAgICAg
ICB9IGVsc2UgewpAQCAtMjIxLDEyICsyMjQsMTYgQEAgc3RhdGljIHZvaWQgc2NoZWR1bGVfZnJh
bWUoU3BpY2VHc3REZWNvZGVyICpkZWNvZGVyKQogICAgIGdfbXV0ZXhfdW5sb2NrKCZkZWNvZGVy
LT5xdWV1ZXNfbXV0ZXgpOwogfQogCi0vKiBHZXQgdGhlIGRlY29kZWQgZnJhbWUgcmVsYXRpdmUg
dG8gYnVmZmVyIG9yIE5VTEwgaWYgbm90IGZvdW5kLgotICogRGVxdWV1ZSB0aGUgZnJhbWUgZnJv
bSBkZWNvZGluZ19xdWV1ZSBhbmQgcmV0dXJuIGl0LCBjYWxsZXIKLSAqIGlzIHJlc3BvbnNpYmxl
IHRvIGZyZWUgdGhlIHBvaW50ZXIuCisvKiBSZXR1cm5zIHRoZSBkZWNvZGluZyBxdWV1ZSBlbnRy
eSB0aGF0IG1hdGNoZXMgdGhlIHNwZWNpZmllZCBHU3RyZWFtZXIgYnVmZmVyLgorICoKKyAqIFRo
ZSBlbnRyeSBpcyBpZGVudGlmaWVkIGJhc2VkIG9uIHRoZSBidWZmZXIgdGltZXN0YW1wLiBIb3dl
dmVyIHNvbWV0aW1lcworICogR1N0cmVhbWVyIHJldHVybnMgdGhlIHNhbWUgYnVmZmVyIHR3aWNl
IChhbmQgdGhlIHNlY29uZCB0aW1lIHRoZSBlbnRyeSBtYXkKKyAqIGhhdmUgYmVlbiByZW1vdmVk
IGFscmVhZHkpIG9yIGJ1ZmZlcnMgdGhhdCBoYXZlIGEgbW9kaWZpZWQsIGFuZCB0aHVzCisgKiB1
bnJlY29nbml6YWJsZSwgdGltZXN0YW1wLiBJbiBzdWNoIGNhc2VzIE5VTEwgaXMgcmV0dXJuZWQu
CisgKgogICogcXVldWVzX211dGV4IG11c3QgYmUgaGVsZC4KICAqLwotc3RhdGljIFNwaWNlR3N0
RnJhbWUgKmdldF9kZWNvZGVkX2ZyYW1lKFNwaWNlR3N0RGVjb2RlciAqZGVjb2RlciwgR3N0QnVm
ZmVyICpidWZmZXIpCitzdGF0aWMgR0xpc3QgKmZpbmRfZGVjb2RlZF9lbnRyeShTcGljZUdzdERl
Y29kZXIgKmRlY29kZXIsIEdzdEJ1ZmZlciAqYnVmZmVyKQogewogICAgIEdzdENsb2NrVGltZSBi
dWZmZXJfdHMgPSBHU1RfQlVGRkVSX1BUUyhidWZmZXIpOwogI2lmIEdTVF9DSEVDS19WRVJTSU9O
KDEsMTQsMCkKQEAgLTIzOCw4MSArMjQ1LDcxIEBAIHN0YXRpYyBTcGljZUdzdEZyYW1lICpnZXRf
ZGVjb2RlZF9mcmFtZShTcGljZUdzdERlY29kZXIgKmRlY29kZXIsIEdzdEJ1ZmZlciAqYnVmCiAg
ICAgfQogI2VuZGlmCiAKLSAgICAvKiBHc3RyZWFtZXIgc29tZXRpbWVzIHJldHVybnMgdGhlIHNh
bWUgYnVmZmVyIHR3aWNlCi0gICAgICogb3IgYnVmZmVycyB0aGF0IGhhdmUgYSBtb2RpZmllZCwg
YW5kIHRodXMgdW5yZWNvZ25pemFibGUsIFBUUy4KLSAgICAgKiBCbGluZGx5IHJlbW92aW5nIGZy
YW1lcyBmcm9tIHRoZSBkZWNvZGluZ19xdWV1ZSB1bnRpbCB3ZSBmaW5kIGEKLSAgICAgKiBtYXRj
aCB3b3VsZCBvbmx5IGVtcHR5IHRoZSBxdWV1ZSwgcmVzdWx0aW5nIGluIGxhdGVyIGJ1ZmZlcnMg
bm90Ci0gICAgICogZmluZGluZyBhIG1hdGNoIGVpdGhlciwgZXRjLiBTbyBjaGVjayB0aGUgYnVm
ZmVyIGhhcyBhIG1hdGNoaW5nCi0gICAgICogZnJhbWUgZmlyc3QuCi0gICAgICovCi0gICAgU3Bp
Y2VHc3RGcmFtZSAqZ3N0ZnJhbWUgPSBOVUxMOwogICAgIEdMaXN0ICpsID0gZ19xdWV1ZV9wZWVr
X2hlYWRfbGluayhkZWNvZGVyLT5kZWNvZGluZ19xdWV1ZSk7CiAgICAgd2hpbGUgKGwpIHsKLSAg
ICAgICAgZ3N0ZnJhbWUgPSBsLT5kYXRhOworICAgICAgICBTcGljZUdzdEZyYW1lICpnc3RmcmFt
ZSA9IGwtPmRhdGE7CiAgICAgICAgIGlmIChnc3RmcmFtZS0+dGltZXN0YW1wID09IGJ1ZmZlcl90
cykgewotICAgICAgICAgICAgYnJlYWs7CisgICAgICAgICAgICAvKiBVcGRhdGUgdGhlIHN0YXRp
c3RpY3MgKi8KKyAgICAgICAgICAgIGNvbnN0IFNwaWNlRnJhbWUgKmZyYW1lID0gZ3N0ZnJhbWUt
PmVuY29kZWRfZnJhbWU7CisgICAgICAgICAgICBpbnQ2NF90IGR1cmF0aW9uID0gZ19nZXRfbW9u
b3RvbmljX3RpbWUoKSAtIGZyYW1lLT5jcmVhdGlvbl90aW1lOworICAgICAgICAgICAgcmVjb3Jk
KGZyYW1lc19zdGF0cywKKyAgICAgICAgICAgICAgICAgICAiZnJhbWUgbW1fdGltZSAldSBzaXpl
ICV1IGNyZWF0aW9uIHRpbWUgJSIgUFJJZDY0CisgICAgICAgICAgICAgICAgICAgIiBkZWNvZGVk
IHRpbWUgJSIgUFJJZDY0ICIgcXVldWUgJXUiLAorICAgICAgICAgICAgICAgICAgIGZyYW1lLT5t
bV90aW1lLCBmcmFtZS0+c2l6ZSwgZnJhbWUtPmNyZWF0aW9uX3RpbWUsCisgICAgICAgICAgICAg
ICAgICAgZHVyYXRpb24sIGRlY29kZXItPmRlY29kaW5nX3F1ZXVlLT5sZW5ndGgpOworICAgICAg
ICAgICAgcmV0dXJuIGw7CiAgICAgICAgIH0KLSAgICAgICAgZ3N0ZnJhbWUgPSBOVUxMOwogICAg
ICAgICBsID0gbC0+bmV4dDsKICAgICB9CiAKLSAgICBpZiAoZ3N0ZnJhbWUgIT0gTlVMTCkgewot
ICAgICAgICAvKiBOb3cgdGhhdCB3ZSBrbm93IHRoZXJlIGlzIGEgbWF0Y2gsIHJlbW92ZSBpdCBh
bmQgdGhlIG9sZGVyCi0gICAgICAgICAqIGZyYW1lcyBmcm9tIHRoZSBkZWNvZGluZyBxdWV1ZSAq
LwotICAgICAgICBTcGljZUdzdEZyYW1lICpsYXRlX2ZyYW1lOwotICAgICAgICBndWludCBudW1f
ZnJhbWVzX2Ryb3BwZWQgPSAwOwotCi0gICAgICAgIC8qIFRoZSBHU3RyZWFtZXIgcGlwZWxpbmUg
ZHJvcHBlZCB0aGUgY29ycmVzcG9uZGluZyBidWZmZXIuICovCi0gICAgICAgIHdoaWxlICgobGF0
ZV9mcmFtZSA9IGdfcXVldWVfcG9wX2hlYWQoZGVjb2Rlci0+ZGVjb2RpbmdfcXVldWUpKSAhPSBn
c3RmcmFtZSkgewotICAgICAgICAgICAgbnVtX2ZyYW1lc19kcm9wcGVkKys7Ci0gICAgICAgICAg
ICBmcmVlX2dzdF9mcmFtZShsYXRlX2ZyYW1lKTsKLSAgICAgICAgfQotCi0gICAgICAgIGlmIChu
dW1fZnJhbWVzX2Ryb3BwZWQgIT0gMCkgewotICAgICAgICAgICAgU1BJQ0VfREVCVUcoInRoZSBH
U3RyZWFtZXIgcGlwZWxpbmUgZHJvcHBlZCAldSBmcmFtZXMiLCBudW1fZnJhbWVzX2Ryb3BwZWQp
OwotICAgICAgICB9Ci0KLSAgICAgICAgY29uc3QgU3BpY2VGcmFtZSAqZnJhbWUgPSBnc3RmcmFt
ZS0+ZW5jb2RlZF9mcmFtZTsKLSAgICAgICAgaW50NjRfdCBkdXJhdGlvbiA9IGdfZ2V0X21vbm90
b25pY190aW1lKCkgLSBmcmFtZS0+Y3JlYXRpb25fdGltZTsKLSAgICAgICAgcmVjb3JkKGZyYW1l
c19zdGF0cywKLSAgICAgICAgICAgICAgICJmcmFtZSBtbV90aW1lICV1IHNpemUgJXUgY3JlYXRp
b24gdGltZSAlIiBQUklkNjQKLSAgICAgICAgICAgICAgICIgZGVjb2RlZCB0aW1lICUiIFBSSWQ2
NCAiIHF1ZXVlICV1IiwKLSAgICAgICAgICAgICAgIGZyYW1lLT5tbV90aW1lLCBmcmFtZS0+c2l6
ZSwgZnJhbWUtPmNyZWF0aW9uX3RpbWUsCi0gICAgICAgICAgICAgICBkdXJhdGlvbiwgZGVjb2Rl
ci0+ZGVjb2RpbmdfcXVldWUtPmxlbmd0aCk7Ci0gICAgfQotICAgIHJldHVybiBnc3RmcmFtZTsK
KyAgICByZXR1cm4gTlVMTDsKIH0KIAotc3RhdGljIHZvaWQgZmV0Y2hfcGVuZGluZ19zYW1wbGUo
U3BpY2VHc3REZWNvZGVyICpkZWNvZGVyKQorLyogQXR0YWNoZXMgdGhlIHNwZWNpZmllZCBHU3Ry
ZWFtZXIgc2FtcGxlIHRvIHRoZSBjb3JyZXNwb25kaW5nIFNwaWNlR3N0RnJhbWUKKyAqIGluIHRo
ZSBkZWNvZGluZyBxdWV1ZSBhbmQgcmV0dXJucyBUUlVFLiBSZXR1cm5zIEZBTFNFIGlmIG5vIG1h
dGNoIHdhcyBmb3VuZC4KKyAqCisgKiBUaGlzIGFsc28gcmVtb3ZlcyBhbnkgb2xkZXIgZnJhbWUg
dGhhdCBoYXZlIG5vdCBiZWVuIGRlY29kZWQgeWV0IGFzCisgKiBpdCBtZWFucyBHU3RyZWFtZXIg
ZHJvcHBlZCB0aGVtLiBUaGlzIGVuc3VyZXMgdGhlIGRlY29kZWQgZnJhbWVzIGZvcm0gYQorICog
Y29udGlndW91cyBibG9jayBhdCB0aGUgaGVhZCBvZiB0aGUgZGVjb2RpbmcgcXVldWUuCisgKgor
ICogcXVldWVzX211dGV4IG11c3QgYmUgaGVsZC4KKyAqLworc3RhdGljIGdib29sZWFuIGF0dGFj
aF9kZWNvZGVkX3NhbXBsZShTcGljZUdzdERlY29kZXIgKmRlY29kZXIsIEdzdFNhbXBsZSAqc2Ft
cGxlKQogewotICAgIEdzdFNhbXBsZSAqc2FtcGxlID0gZ3N0X2FwcF9zaW5rX3B1bGxfc2FtcGxl
KGRlY29kZXItPmFwcHNpbmspOwotICAgIGlmIChzYW1wbGUpIHsKLSAgICAgICAgLy8gYWNjb3Vu
dCBmb3IgdGhlIGZldGNoZWQgc2FtcGxlCi0gICAgICAgIGRlY29kZXItPnBlbmRpbmdfc2FtcGxl
cy0tOworICAgIEdzdEJ1ZmZlciAqYnVmZmVyID0gZ3N0X3NhbXBsZV9nZXRfYnVmZmVyKHNhbXBs
ZSk7CisgICAgR0xpc3QgKmwgPSBmaW5kX2RlY29kZWRfZW50cnkoZGVjb2RlciwgYnVmZmVyKTsK
KyAgICBpZiAobCA9PSBOVUxMKSB7CisgICAgICAgIHJldHVybiBGQUxTRTsKKyAgICB9CiAKLSAg
ICAgICAgR3N0QnVmZmVyICpidWZmZXIgPSBnc3Rfc2FtcGxlX2dldF9idWZmZXIoc2FtcGxlKTsK
KyAgICBTcGljZUdzdEZyYW1lICpnc3RmcmFtZSA9IGwtPmRhdGE7CisgICAgZ3N0ZnJhbWUtPmRl
Y29kZWRfc2FtcGxlID0gc2FtcGxlOworICAgIGRlY29kZXItPmRlY29kZWRfZnJhbWVzKys7CiAK
LSAgICAgICAgLyogZ3N0X2FwcF9zaW5rX3B1bGxfc2FtcGxlKCkgc29tZXRpbWVzIHJldHVybnMg
dGhlIHNhbWUgYnVmZmVyIHR3aWNlCi0gICAgICAgICAqIG9yIGJ1ZmZlcnMgdGhhdCBoYXZlIGEg
bW9kaWZpZWQsIGFuZCB0aHVzIHVucmVjb2duaXphYmxlLCBQVFMuCi0gICAgICAgICAqIEJsaW5k
bHkgcmVtb3ZpbmcgZnJhbWVzIGZyb20gdGhlIGRlY29kaW5nX3F1ZXVlIHVudGlsIHdlIGZpbmQg
YQotICAgICAgICAgKiBtYXRjaCB3b3VsZCBvbmx5IGVtcHR5IHRoZSBxdWV1ZSwgcmVzdWx0aW5n
IGluIGxhdGVyIGJ1ZmZlcnMgbm90Ci0gICAgICAgICAqIGZpbmRpbmcgYSBtYXRjaCBlaXRoZXIs
IGV0Yy4gU28gY2hlY2sgdGhlIGJ1ZmZlciBoYXMgYSBtYXRjaGluZwotICAgICAgICAgKiBmcmFt
ZSBmaXJzdC4KLSAgICAgICAgICovCi0gICAgICAgIFNwaWNlR3N0RnJhbWUgKmdzdGZyYW1lID0g
Z2V0X2RlY29kZWRfZnJhbWUoZGVjb2RlciwgYnVmZmVyKTsKLSAgICAgICAgaWYgKGdzdGZyYW1l
KSB7Ci0gICAgICAgICAgICAvKiBUaGUgZnJhbWUgaXMgbm93IHJlYWR5IGZvciBkaXNwbGF5ICov
Ci0gICAgICAgICAgICBnc3RmcmFtZS0+ZGVjb2RlZF9zYW1wbGUgPSBzYW1wbGU7Ci0gICAgICAg
ICAgICBkZWNvZGVyLT5kaXNwbGF5X2ZyYW1lID0gZ3N0ZnJhbWU7Ci0gICAgICAgIH0gZWxzZSB7
Ci0gICAgICAgICAgICBzcGljZV93YXJuaW5nKCJnb3QgYW4gdW5leHBlY3RlZCBkZWNvZGVkIGJ1
ZmZlciEiKTsKLSAgICAgICAgICAgIGdzdF9zYW1wbGVfdW5yZWYoc2FtcGxlKTsKKyAgICAvKiBB
bnkgb2xkZXIgdW5kZWNvZGVkIGZyYW1lIG11c3QgaGF2ZSBiZWVuIGRyb3BwZWQgYnkgdGhlIEdT
dHJlYW1lcgorICAgICAqIHBpcGVsaW5lIHNvIHRoZXJlIGlzIG5vIHBvaW50IGluIGtlZXBpbmcg
aXQgYXJvdW5kLgorICAgICAqLworICAgIGd1aW50IG51bV9mcmFtZXNfZHJvcHBlZCA9IDA7Cisg
ICAgbCA9IGwtPnByZXY7CisgICAgd2hpbGUgKGwpIHsKKyAgICAgICAgZ3N0ZnJhbWUgPSBsLT5k
YXRhOworICAgICAgICBpZiAoZ3N0ZnJhbWUtPmRlY29kZWRfc2FtcGxlKSB7CisgICAgICAgICAg
ICAvKiBJdCdzIG9ubHkgZGVjb2RlZCBmcmFtZXMgZnJvbSB0aGVyZSB0byB0aGUgZmlyc3Qgb25l
ICovCisgICAgICAgICAgICBicmVhazsKICAgICAgICAgfQotICAgIH0gZWxzZSB7Ci0gICAgICAg
IC8vIG5vIG1vcmUgc2FtcGxlcyB0byBnZXQsIHBvc3NpYmx5IHNvbWUgc2FtcGxlIHdhcyBkcm9w
cGVkCi0gICAgICAgIGRlY29kZXItPnBlbmRpbmdfc2FtcGxlcyA9IDA7Ci0gICAgICAgIHNwaWNl
X3dhcm5pbmcoIkdTdHJlYW1lciBlcnJvcjogY291bGQgbm90IHB1bGwgc2FtcGxlIik7CisKKyAg
ICAgICAgbnVtX2ZyYW1lc19kcm9wcGVkKys7CisgICAgICAgIGZyZWVfZ3N0X2ZyYW1lKGdzdGZy
YW1lKTsKKyAgICAgICAgR0xpc3QgKnAgPSBsLT5wcmV2OworICAgICAgICBnX3F1ZXVlX2RlbGV0
ZV9saW5rKGRlY29kZXItPmRlY29kaW5nX3F1ZXVlLCBsKTsKKworICAgICAgICBsID0gcDsKICAg
ICB9CisgICAgaWYgKG51bV9mcmFtZXNfZHJvcHBlZCkgeworICAgICAgICBTUElDRV9ERUJVRygi
dGhlIEdTdHJlYW1lciBwaXBlbGluZSBkcm9wcGVkICV1IGZyYW1lcyIsIG51bV9mcmFtZXNfZHJv
cHBlZCk7CisgICAgfQorCisgICAgcmV0dXJuIFRSVUU7CiB9CiAKIC8qIEdTdHJlYW1lciB0aHJl
YWQKQEAgLTMyNywxNSArMzI0LDE4IEBAIHN0YXRpYyBHc3RGbG93UmV0dXJuIG5ld19zYW1wbGUo
R3N0QXBwU2luayAqZ3N0YXBwc2luaywgZ3BvaW50ZXIgdmlkZW9fZGVjb2RlcikKIHsKICAgICBT
cGljZUdzdERlY29kZXIgKmRlY29kZXIgPSB2aWRlb19kZWNvZGVyOwogCi0gICAgZ19tdXRleF9s
b2NrKCZkZWNvZGVyLT5xdWV1ZXNfbXV0ZXgpOwotICAgIGRlY29kZXItPnBlbmRpbmdfc2FtcGxl
cysrOwotICAgIGlmIChkZWNvZGVyLT50aW1lcl9pZCAmJiBkZWNvZGVyLT5kaXNwbGF5X2ZyYW1l
KSB7CisgICAgR3N0U2FtcGxlICpzYW1wbGUgPSBnc3RfYXBwX3NpbmtfcHVsbF9zYW1wbGUoZGVj
b2Rlci0+YXBwc2luayk7CisgICAgaWYgKHNhbXBsZSkgeworICAgICAgICBnX211dGV4X2xvY2so
JmRlY29kZXItPnF1ZXVlc19tdXRleCk7CisgICAgICAgIGlmICghYXR0YWNoX2RlY29kZWRfc2Ft
cGxlKGRlY29kZXIsIHNhbXBsZSkgfHwgZGVjb2Rlci0+dGltZXJfaWQpIHsKKyAgICAgICAgICAg
IGdfbXV0ZXhfdW5sb2NrKCZkZWNvZGVyLT5xdWV1ZXNfbXV0ZXgpOworICAgICAgICAgICAgcmV0
dXJuIEdTVF9GTE9XX09LOworCisgICAgICAgIH0KICAgICAgICAgZ19tdXRleF91bmxvY2soJmRl
Y29kZXItPnF1ZXVlc19tdXRleCk7Ci0gICAgICAgIHJldHVybiBHU1RfRkxPV19PSzsKLSAgICB9
Ci0gICAgZ19tdXRleF91bmxvY2soJmRlY29kZXItPnF1ZXVlc19tdXRleCk7CiAKLSAgICBzY2hl
ZHVsZV9mcmFtZShkZWNvZGVyKTsKKyAgICAgICAgc2NoZWR1bGVfZnJhbWUoZGVjb2Rlcik7Cisg
ICAgfQogCiAgICAgcmV0dXJuIEdTVF9GTE9XX09LOwogfQpAQCAtNDI5LDEwICs0MjksMTkgQEAg
c2lua19ldmVudF9wcm9iZShHc3RQYWQgKnBhZCwgR3N0UGFkUHJvYmVJbmZvICppbmZvLCBncG9p
bnRlciBkYXRhKQogICAgIGlmIChpbmZvLT50eXBlICYgR1NUX1BBRF9QUk9CRV9UWVBFX0JVRkZF
UikgeyAvLyBCdWZmZXIgYXJyaXZlZAogICAgICAgICBHc3RCdWZmZXIgKmJ1ZmZlciA9IEdTVF9Q
QURfUFJPQkVfSU5GT19CVUZGRVIoaW5mbyk7CiAgICAgICAgIGdfbXV0ZXhfbG9jaygmZGVjb2Rl
ci0+cXVldWVzX211dGV4KTsKLSAgICAgICAgU3BpY2VHc3RGcmFtZSAqZ3N0ZnJhbWUgPSBnZXRf
ZGVjb2RlZF9mcmFtZShkZWNvZGVyLCBidWZmZXIpOwotICAgICAgICBpZiAoZ3N0ZnJhbWUpIHsK
LSAgICAgICAgICAgIGZyZWVfZ3N0X2ZyYW1lKGdzdGZyYW1lKTsKKworICAgICAgICAvKiBBcyBh
IHNpZGUtZWZmZWN0IHRoaXMgdXBkYXRlcyB0aGUgZGVjb2RlciBzdGF0aXN0aWNzICovCisgICAg
ICAgIEdMaXN0ICpsID0gZmluZF9kZWNvZGVkX2VudHJ5KGRlY29kZXIsIGJ1ZmZlcik7CisKKyAg
ICAgICAgLyogRHJvcCBhbGwgZW50cmllcyB1cCB0byB0aGlzIG9uZSAqLworICAgICAgICB3aGls
ZSAobCkgeworICAgICAgICAgICAgZnJlZV9nc3RfZnJhbWUoKFNwaWNlR3N0RnJhbWUqKWwtPmRh
dGEpOworCisgICAgICAgICAgICBHTGlzdCAqcCA9IGwtPnByZXY7CisgICAgICAgICAgICBnX3F1
ZXVlX2RlbGV0ZV9saW5rKGRlY29kZXItPmRlY29kaW5nX3F1ZXVlLCBsKTsKKyAgICAgICAgICAg
IGwgPSBwOwogICAgICAgICB9CisKICAgICAgICAgZ19tdXRleF91bmxvY2soJmRlY29kZXItPnF1
ZXVlc19tdXRleCk7CiAgICAgfQogICAgIHJldHVybiBHU1RfUEFEX1BST0JFX09LOwotLSAKMi4y
MC4xCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClNwaWNl
LWRldmVsIG1haWxpbmcgbGlzdApTcGljZS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0
cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9zcGljZS1kZXZlbA==
