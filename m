Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id DCD8131BB5
	for <lists+spice-devel@lfdr.de>; Sat,  1 Jun 2019 14:14:24 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 763DB89B5F;
	Sat,  1 Jun 2019 12:14:22 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id C7A0889B5F
 for <spice-devel@lists.freedesktop.org>; Sat,  1 Jun 2019 12:14:20 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx01.intmail.prod.int.phx2.redhat.com
 [10.5.11.11])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 71F823086209
 for <spice-devel@lists.freedesktop.org>; Sat,  1 Jun 2019 12:14:20 +0000 (UTC)
Received: from fziglio.remote.csb (unknown [10.33.32.3])
 by smtp.corp.redhat.com (Postfix) with ESMTP id A0748600D1;
 Sat,  1 Jun 2019 12:14:19 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Sat,  1 Jun 2019 13:14:13 +0100
Message-Id: <20190601121413.932-3-fziglio@redhat.com>
In-Reply-To: <20190601121413.932-1-fziglio@redhat.com>
References: <20190601121413.932-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.11
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.42]); Sat, 01 Jun 2019 12:14:20 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-server 3/3] spicevmc: Avoids DoS if
 client is not able to get data faster enough
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

VGhpcyBmaXggaGFsZiAob25lIGRpcmVjdGlvbikgb2YKaHR0cHM6Ly9naXRsYWIuZnJlZWRlc2t0
b3Aub3JnL3NwaWNlL3NwaWNlL2lzc3Vlcy8yOS4KU3BlY2lmaWNhbGx5IGlmIHlvdSBoYXZlIGF0
dGVtcHQgdG8gdHJhbnNmZXIgYSBmaWxlIHRvIHRoZSBjbGllbnQKdXNpbmcgV2ViREFWLgpQcmV2
aW91c2x5IHRoZSBxdWV1ZSB0byB0aGUgY2xpZW50IHdhcyB1bmJvdW5kLiBJZiBjbGllbnQgd2Fz
IG5vdApnZXR0aW5nIGRhdGEgZmFzdCBlbm91Z2ggdGhlIHNlcnZlciBzdGFydGVkIHF1ZXVpbmcg
ZGF0YS4KVG8gZWFzaWx5IHRlc3QgdGhpcyB5b3UgY2FuIHVzZSBhIHRvb2wgdG8gbGltaXQgYmFu
ZHdpZHRoIGFuZAp0cmFuc2ZlciBhIGJpZyBmaWxlIChJIHVzZWQgYSAiZGQgaWY9L2Rldi96ZXJv
IGJzPTFNIG9mPXRlc3QiKSBmcm9tCnRoZSBndWVzdC4KClNpZ25lZC1vZmYtYnk6IEZyZWRpYW5v
IFppZ2xpbyA8ZnppZ2xpb0ByZWRoYXQuY29tPgotLS0KIHNlcnZlci9zcGljZXZtYy5jIHwgMjkg
KysrKysrKysrKysrKysrKysrKysrKysrKystLS0KIDEgZmlsZSBjaGFuZ2VkLCAyNiBpbnNlcnRp
b25zKCspLCAzIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL3NlcnZlci9zcGljZXZtYy5jIGIv
c2VydmVyL3NwaWNldm1jLmMKaW5kZXggOGM0MTU3M2FlLi45MDZjMjQ0MWUgMTAwNjQ0Ci0tLSBh
L3NlcnZlci9zcGljZXZtYy5jCisrKyBiL3NlcnZlci9zcGljZXZtYy5jCkBAIC00Miw2ICs0Miwx
MCBAQAogI2RlZmluZSBCVUZfU0laRSAoNjQgKiAxMDI0ICsgMzIpCiAjZGVmaW5lIENPTVBSRVNT
X1RIUkVTSE9MRCAxMDAwCiAKKy8vIGxpbWl0IG9mIHRoZSBxdWV1ZWQgZGF0YSwgYXQgdGhpcyBs
aW1pdCB3ZSBzdG9wIHJlYWRpbmcgZnJvbSBkZXZpY2UgdG8KKy8vIGF2b2lkIERvUworI2RlZmlu
ZSBRVUVVRURfREFUQV9MSU1JVCAoMTAyNCoxMDI0KQorCiBTUElDRV9ERUNMQVJFX1RZUEUoUmVk
Q2hhckRldmljZVNwaWNlVm1jLCByZWRfY2hhcl9kZXZpY2Vfc3BpY2V2bWMsIENIQVJfREVWSUNF
X1NQSUNFVk1DKTsKICNkZWZpbmUgUkVEX1RZUEVfQ0hBUl9ERVZJQ0VfU1BJQ0VWTUMgcmVkX2No
YXJfZGV2aWNlX3NwaWNldm1jX2dldF90eXBlKCkKIApAQCAtODMsNiArODcsNyBAQCBzdHJ1Y3Qg
UmVkQ2hhckRldmljZVNwaWNlVm1jQ2xhc3MKIHN0YXRpYyBSZWRDaGFyRGV2aWNlICpyZWRfY2hh
cl9kZXZpY2Vfc3BpY2V2bWNfbmV3KFNwaWNlQ2hhckRldmljZUluc3RhbmNlICpzaW4sCiAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBSZWRzU3RhdGUg
KnJlZHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBSZWRWbWNDaGFubmVsICpjaGFubmVsKTsKK3N0YXRpYyB2b2lkIHNwaWNldm1jX3JlZF9jaGFu
bmVsX3F1ZXVlX2RhdGEoUmVkVm1jQ2hhbm5lbCAqY2hhbm5lbCwgUmVkVm1jUGlwZUl0ZW0gKml0
ZW0pOwogCiBHX0RFRklORV9UWVBFKFJlZENoYXJEZXZpY2VTcGljZVZtYywgcmVkX2NoYXJfZGV2
aWNlX3NwaWNldm1jLCBSRURfVFlQRV9DSEFSX0RFVklDRSkKIApAQCAtOTYsNiArMTAxLDcgQEAg
c3RydWN0IFJlZFZtY0NoYW5uZWwKICAgICBSZWRWbWNQaXBlSXRlbSAqcGlwZV9pdGVtOwogICAg
IFJlZENoYXJEZXZpY2VXcml0ZUJ1ZmZlciAqcmVjdl9mcm9tX2NsaWVudF9idWY7CiAgICAgdWlu
dDhfdCBwb3J0X29wZW5lZDsKKyAgICB1aW50MzJfdCBxdWV1ZWRfZGF0YTsKICAgICBSZWRTdGF0
Q291bnRlciBpbl9kYXRhOwogICAgIFJlZFN0YXRDb3VudGVyIGluX2NvbXByZXNzZWQ7CiAgICAg
UmVkU3RhdENvdW50ZXIgaW5fZGVjb21wcmVzc2VkOwpAQCAtMzM3LDcgKzM0Myw3IEBAIHN0YXRp
YyBSZWRQaXBlSXRlbSAqc3BpY2V2bWNfY2hhcmRldl9yZWFkX21zZ19mcm9tX2RldihSZWRDaGFy
RGV2aWNlICpzZWxmLAogCiAgICAgc2lmID0gc3BpY2VfY2hhcl9kZXZpY2VfZ2V0X2ludGVyZmFj
ZShzaW4pOwogCi0gICAgaWYgKCFjaGFubmVsLT5yY2MpIHsKKyAgICBpZiAoIWNoYW5uZWwtPnJj
YyB8fCBjaGFubmVsLT5xdWV1ZWRfZGF0YSA+PSBRVUVVRURfREFUQV9MSU1JVCkgewogICAgICAg
ICByZXR1cm4gTlVMTDsKICAgICB9CiAKQEAgLTM2MCwxNCArMzY2LDE0IEBAIHN0YXRpYyBSZWRQ
aXBlSXRlbSAqc3BpY2V2bWNfY2hhcmRldl9yZWFkX21zZ19mcm9tX2RldihSZWRDaGFyRGV2aWNl
ICpzZWxmLAogCiAgICAgICAgIG1zZ19pdGVtX2NvbXByZXNzZWQgPSB0cnlfY29tcHJlc3NfbHo0
KGNoYW5uZWwsIG4sIG1zZ19pdGVtKTsKICAgICAgICAgaWYgKG1zZ19pdGVtX2NvbXByZXNzZWQg
IT0gTlVMTCkgewotICAgICAgICAgICAgcmVkX2NoYW5uZWxfY2xpZW50X3BpcGVfYWRkX3B1c2go
Y2hhbm5lbC0+cmNjLCAmbXNnX2l0ZW1fY29tcHJlc3NlZC0+YmFzZSk7CisgICAgICAgICAgICBz
cGljZXZtY19yZWRfY2hhbm5lbF9xdWV1ZV9kYXRhKGNoYW5uZWwsIG1zZ19pdGVtX2NvbXByZXNz
ZWQpOwogICAgICAgICAgICAgcmV0dXJuIE5VTEw7CiAgICAgICAgIH0KICNlbmRpZgogICAgICAg
ICBzdGF0X2luY19jb3VudGVyKGNoYW5uZWwtPm91dF9kYXRhLCBuKTsKICAgICAgICAgbXNnX2l0
ZW0tPnVuY29tcHJlc3NlZF9kYXRhX3NpemUgPSBuOwogICAgICAgICBtc2dfaXRlbS0+YnVmX3Vz
ZWQgPSBuOwotICAgICAgICByZWRfY2hhbm5lbF9jbGllbnRfcGlwZV9hZGRfcHVzaChjaGFubmVs
LT5yY2MsICZtc2dfaXRlbS0+YmFzZSk7CisgICAgICAgIHNwaWNldm1jX3JlZF9jaGFubmVsX3F1
ZXVlX2RhdGEoY2hhbm5lbCwgbXNnX2l0ZW0pOwogICAgICAgICByZXR1cm4gTlVMTDsKICAgICB9
CiAgICAgY2hhbm5lbC0+cGlwZV9pdGVtID0gbXNnX2l0ZW07CkBAIC02MDksMTEgKzYxNSwxOSBA
QCBzdGF0aWMgdm9pZCBzcGljZXZtY19yZWRfY2hhbm5lbF9yZWxlYXNlX21zZ19yY3ZfYnVmKFJl
ZENoYW5uZWxDbGllbnQgKnJjYywKICAgICB9CiB9CiAKK3N0YXRpYyB2b2lkCitzcGljZXZtY19y
ZWRfY2hhbm5lbF9xdWV1ZV9kYXRhKFJlZFZtY0NoYW5uZWwgKmNoYW5uZWwsIFJlZFZtY1BpcGVJ
dGVtICppdGVtKQoreworICAgIGNoYW5uZWwtPnF1ZXVlZF9kYXRhICs9IGl0ZW0tPmJ1Zl91c2Vk
OworICAgIHJlZF9jaGFubmVsX2NsaWVudF9waXBlX2FkZF9wdXNoKGNoYW5uZWwtPnJjYywgJml0
ZW0tPmJhc2UpOworfQorCiBzdGF0aWMgdm9pZCBzcGljZXZtY19yZWRfY2hhbm5lbF9zZW5kX2Rh
dGEoUmVkQ2hhbm5lbENsaWVudCAqcmNjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIFNwaWNlTWFyc2hhbGxlciAqbSwKICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICBSZWRQaXBlSXRlbSAqaXRlbSkKIHsKICAgICBSZWRWbWNQaXBl
SXRlbSAqaSA9IFNQSUNFX1VQQ0FTVChSZWRWbWNQaXBlSXRlbSwgaXRlbSk7CisgICAgUmVkVm1j
Q2hhbm5lbCAqY2hhbm5lbCA9IFJFRF9WTUNfQ0hBTk5FTChyZWRfY2hhbm5lbF9jbGllbnRfZ2V0
X2NoYW5uZWwocmNjKSk7CiAKICAgICAvKiBmb3IgY29tcGF0aWJpbGl0eSBzZW5kIHVzaW5nIG5v
dCBjb21wcmVzc2VkIGRhdGEgbWVzc2FnZSAqLwogICAgIGlmIChpLT50eXBlID09IFNQSUNFX0RB
VEFfQ09NUFJFU1NJT05fVFlQRV9OT05FKSB7CkBAIC02MzAsNiArNjQ0LDE0IEBAIHN0YXRpYyB2
b2lkIHNwaWNldm1jX3JlZF9jaGFubmVsX3NlbmRfZGF0YShSZWRDaGFubmVsQ2xpZW50ICpyY2Ms
CiAgICAgcmVkX3BpcGVfaXRlbV9yZWYoaXRlbSk7CiAgICAgc3BpY2VfbWFyc2hhbGxlcl9hZGRf
YnlfcmVmX2Z1bGwobSwgaS0+YnVmLCBpLT5idWZfdXNlZCwKICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICBtYXJzaGFsbGVyX3VucmVmX3BpcGVfaXRlbSwgaXRlbSk7CisKKyAg
ICAvLyBhY2NvdW50IGZvciBzZW50IGRhdGEgYW5kIHdha2UgdXAgZGV2aWNlIGlmIHdhcyBibG9j
a2VkCisgICAgdWludDMyX3Qgb2xkX3F1ZXVlZF9kYXRhID0gY2hhbm5lbC0+cXVldWVkX2RhdGE7
CisgICAgY2hhbm5lbC0+cXVldWVkX2RhdGEgLT0gaS0+YnVmX3VzZWQ7CisgICAgaWYgKGNoYW5u
ZWwtPmNoYXJkZXYgJiYKKyAgICAgICAgb2xkX3F1ZXVlZF9kYXRhID49IFFVRVVFRF9EQVRBX0xJ
TUlUICYmIGNoYW5uZWwtPnF1ZXVlZF9kYXRhIDwgUVVFVUVEX0RBVEFfTElNSVQpIHsKKyAgICAg
ICAgcmVkX2NoYXJfZGV2aWNlX3dha2V1cChjaGFubmVsLT5jaGFyZGV2KTsKKyAgICB9CiB9CiAK
IHN0YXRpYyB2b2lkIHNwaWNldm1jX3JlZF9jaGFubmVsX3NlbmRfbWlncmF0ZV9kYXRhKFJlZENo
YW5uZWxDbGllbnQgKnJjYywKQEAgLTc2OCw2ICs3OTAsNyBAQCBzdGF0aWMgdm9pZCBzcGljZXZt
Y19jb25uZWN0KFJlZENoYW5uZWwgKmNoYW5uZWwsIFJlZENsaWVudCAqY2xpZW50LAogICAgICAg
ICByZXR1cm47CiAgICAgfQogICAgIHZtY19jaGFubmVsLT5yY2MgPSByY2M7CisgICAgdm1jX2No
YW5uZWwtPnF1ZXVlZF9kYXRhID0gMDsKICAgICByZWRfY2hhbm5lbF9jbGllbnRfYWNrX3plcm9f
bWVzc2FnZXNfd2luZG93KHJjYyk7CiAKICAgICBpZiAoc3RyY21wKHNpbi0+c3VidHlwZSwgInBv
cnQiKSA9PSAwKSB7Ci0tIAoyLjIwLjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fClNwaWNlLWRldmVsIG1haWxpbmcgbGlzdApTcGljZS1kZXZlbEBsaXN0
cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9s
aXN0aW5mby9zcGljZS1kZXZlbA==
