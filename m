Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 0B51572CAE
	for <lists+spice-devel@lfdr.de>; Wed, 24 Jul 2019 12:54:13 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 570616E514;
	Wed, 24 Jul 2019 10:54:11 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mail-wm1-x32a.google.com (mail-wm1-x32a.google.com
 [IPv6:2a00:1450:4864:20::32a])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 6198D6E511
 for <spice-devel@lists.freedesktop.org>; Wed, 24 Jul 2019 10:54:09 +0000 (UTC)
Received: by mail-wm1-x32a.google.com with SMTP id p74so41361500wme.4
 for <spice-devel@lists.freedesktop.org>; Wed, 24 Jul 2019 03:54:09 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references;
 bh=+46TJ2CpAh2JJZlD4k8wAcRzioA4KmKxZFFvPVBrDY8=;
 b=EJjHwFk9aWGUHpFX0kpm9jgGB1quPdePUICIPq8U0OyCtOIUznmLMlTryH4VGnhbCb
 SNbldaKfk1ZqsCgtHHis/kmuNT5xm8Abfxk3JbHhc12h0U94bLDhQ4ZDSHIZxrdPMmgS
 i2HdwIHROf0coCLUQkfZN0dj7Qs5UDUT8N+OLFhv0Td8fp7yIW2NQbFYpUyWjeocGrO0
 kJfD9bBwf3BWk2TyopkuXV7PQV5Z4gZhzJpej2BrNWKQ9kKwIcJ3iaUI+NMAfCLc1I1S
 pG9e/TqYTZJNMKFQDl7Ligxfj9d7kMiLSnckT2kbrV+yNRYaNnuCPTiWhsXUZqtB5uAr
 lNnA==
X-Gm-Message-State: APjAAAW+rkTnjMOv9aIlQc3fh+0uKI5Gy+VFHUaTpcYsa0wLYcdkEmX2
 /VDMAuI8w4OVX4/S0E951X3Usnx+
X-Google-Smtp-Source: APXvYqzgNFrKQi/oTFONebsww+jMOpqr82C6aG6txLUBEbc+liADo3gW36KSv2hOdRH8z5pfKKJHTg==
X-Received: by 2002:a7b:c95a:: with SMTP id i26mr77088425wml.175.1563965647389; 
 Wed, 24 Jul 2019 03:54:07 -0700 (PDT)
Received: from f2.redhat.com (bzq-79-182-115-245.red.bezeqint.net.
 [79.182.115.245])
 by smtp.gmail.com with ESMTPSA id r12sm53542137wrt.95.2019.07.24.03.54.06
 (version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
 Wed, 24 Jul 2019 03:54:06 -0700 (PDT)
From: Yuri Benditovich <yuri.benditovich@daynix.com>
To: spice-devel@lists.freedesktop.org
Date: Wed, 24 Jul 2019 13:53:50 +0300
Message-Id: <20190724105351.13753-9-yuri.benditovich@daynix.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190724105351.13753-1-yuri.benditovich@daynix.com>
References: <20190724105351.13753-1-yuri.benditovich@daynix.com>
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=daynix-com.20150623.gappssmtp.com; s=20150623;
 h=from:to:cc:subject:date:message-id:in-reply-to:references;
 bh=+46TJ2CpAh2JJZlD4k8wAcRzioA4KmKxZFFvPVBrDY8=;
 b=R8bSKDoHPip7O4xfTW8NUA/LahMDD7oyHA1f+69Hw/zvJJM0LM4Q4m2bRThq5UJYFB
 NQffjR735iPuFAewYya0vnjsZs6P7Nzgb3Mt4kuRhdlGIqFGsNGCVyf8Ia3h76xKbp4O
 aj4JuAu4J71OEepxV/fopkUoD0g4VCjSG5yjlWv5+MA2WvgOnmui724S2OnVW6zHsh21
 SeOdxVfpY68GAOBWhLDCN5jnPpEMmYhy1W292UxK+iZVxA7UeuOoJSjwA/JxUNs9IVoX
 lSojpGXnfvU2egm4g3Tx97EGZ0kdsY5pYYz2RkPu9kRdIvwuYPMQ4n1czfxftertsIJE
 7VcA==
Subject: [Spice-devel] [spice-gtk 8/9] usb-redir: add implementation of
 emulated CD device
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: yan@daynix.com
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

VGhpcyBtb2R1bGUgY29udGFpbnMgaW1wbGVtZW50YXRpb24gb2YgZW11bGF0ZWQgZGV2aWNlCmlu
dGVyZmFjZSBmb3Igc2hhcmVkIENELgoKU2lnbmVkLW9mZi1ieTogWXVyaSBCZW5kaXRvdmljaCA8
eXVyaS5iZW5kaXRvdmljaEBkYXluaXguY29tPgotLS0KIHNyYy91c2ItZGV2aWNlLWNkLmMgfCA3
OTQgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysKIDEgZmlsZSBj
aGFuZ2VkLCA3OTQgaW5zZXJ0aW9ucygrKQogY3JlYXRlIG1vZGUgMTAwNjQ0IHNyYy91c2ItZGV2
aWNlLWNkLmMKCmRpZmYgLS1naXQgYS9zcmMvdXNiLWRldmljZS1jZC5jIGIvc3JjL3VzYi1kZXZp
Y2UtY2QuYwpuZXcgZmlsZSBtb2RlIDEwMDY0NAppbmRleCAwMDAwMDAwLi4xOGRiY2VhCi0tLSAv
ZGV2L251bGwKKysrIGIvc3JjL3VzYi1kZXZpY2UtY2QuYwpAQCAtMCwwICsxLDc5NCBAQAorLyog
LSotIE1vZGU6IEM7IGMtYmFzaWMtb2Zmc2V0OiA0OyBpbmRlbnQtdGFicy1tb2RlOiBuaWwgLSot
ICovCisvKgorICAgIENvcHlyaWdodCAoQykgMjAxOSBSZWQgSGF0LCBJbmMuCisKKyAgICBSZWQg
SGF0IEF1dGhvcnM6CisgICAgWXVyaSBCZW5kaXRvdmljaDx5YmVuZGl0b0ByZWRoYXQuY29tPgor
CisgICAgVGhpcyBsaWJyYXJ5IGlzIGZyZWUgc29mdHdhcmU7IHlvdSBjYW4gcmVkaXN0cmlidXRl
IGl0IGFuZC9vcgorICAgIG1vZGlmeSBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBMZXNz
ZXIgR2VuZXJhbCBQdWJsaWMKKyAgICBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBT
b2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIKKyAgICB2ZXJzaW9uIDIuMSBvZiB0aGUgTGljZW5z
ZSwgb3IgKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi4KKworICAgIFRoaXMgbGli
cmFyeSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAor
ICAgIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdh
cnJhbnR5IG9mCisgICAgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxB
UiBQVVJQT1NFLiAgU2VlIHRoZSBHTlUKKyAgICBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5z
ZSBmb3IgbW9yZSBkZXRhaWxzLgorCisgICAgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29w
eSBvZiB0aGUgR05VIExlc3NlciBHZW5lcmFsIFB1YmxpYworICAgIExpY2Vuc2UgYWxvbmcgd2l0
aCB0aGlzIGxpYnJhcnk7IGlmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMv
Pi4KKyovCisKKyNpbmNsdWRlICJjb25maWcuaCIKKworI2lmZGVmIFVTRV9VU0JSRURJUgorCisj
aW5jbHVkZSA8Z2xpYi1vYmplY3QuaD4KKyNpbmNsdWRlIDxpbnR0eXBlcy5oPgorI2luY2x1ZGUg
PGdpby9naW8uaD4KKyNpbmNsdWRlIDxnbGliL2dpMThuLWxpYi5oPgorI2luY2x1ZGUgPGVycm5v
Lmg+CisjaW5jbHVkZSA8bGlidXNiLmg+CisjaW5jbHVkZSA8ZmNudGwuaD4KKworI2lmZGVmIEdf
T1NfV0lOMzIKKyNpbmNsdWRlIDx3aW5kb3dzLmg+CisjaW5jbHVkZSA8bnRkZGNkcm0uaD4KKyNp
bmNsdWRlIDxudGRkbW1jLmg+CisjZWxzZQorI2luY2x1ZGUgPHN5cy9zdGF0Lmg+CisjaW5jbHVk
ZSA8c3lzL2lvY3RsLmg+CisjaW5jbHVkZSA8bGludXgvZnMuaD4KKyNpbmNsdWRlIDxsaW51eC9j
ZHJvbS5oPgorI2VuZGlmCisKKyNpbmNsdWRlICJ1c2ItZW11bGF0aW9uLmgiCisjaW5jbHVkZSAi
Y2QtdXNiLWJ1bGstbXNkLmgiCisKK3R5cGVkZWYgc3RydWN0IFNwaWNlQ2RMVQoreworICAgIGNo
YXIgKmZpbGVuYW1lOworICAgIEdGaWxlICpmaWxlX29iamVjdDsKKyAgICBHRmlsZUlucHV0U3Ry
ZWFtICpzdHJlYW07CisgICAgdWludDY0X3Qgc2l6ZTsKKyAgICB1aW50MzJfdCBibG9ja1NpemU7
CisgICAgdWludDMyX3QgbG9hZGVkIDogMTsKKyAgICB1aW50MzJfdCBkZXZpY2UgOiAxOworfSBT
cGljZUNkTFU7CisKKyNkZWZpbmUgTUFYX0xVTl9QRVJfREVWSUNFICAgICAgICAgICAgICAxCisj
ZGVmaW5lIFVTQjJfQkNEICAgICAgICAgICAgICAgICAgICAgICAgMHgyMDAKKyNkZWZpbmUgQ0Rf
REVWX1ZJRCAgICAgICAgICAgICAgICAgICAgICAweDJiMjMKKyNkZWZpbmUgQ0RfREVWX1BJRCAg
ICAgICAgICAgICAgICAgICAgICAweENEQ0QKKyNkZWZpbmUgQ0RfREVWX0NMQVNTICAgICAgICAg
ICAgICAgICAgICA4CisjZGVmaW5lIENEX0RFVl9TVUJDTEFTUyAgICAgICAgICAgICAgICAgNgor
I2RlZmluZSBDRF9ERVZfUFJPVE9DT0wgICAgICAgICAgICAgICAgIDB4NTAKKyNkZWZpbmUgQ0Rf
REVWX0JMT0NLX1NJWkUgICAgICAgICAgICAgICAweDIwMAorI2RlZmluZSBDRF9ERVZfTUFYX1NJ
WkUgICAgICAgICAgICAgICAgIDczNzI4MDAwMAorI2RlZmluZSBEVkRfREVWX0JMT0NLX1NJWkUg
ICAgICAgICAgICAgIDB4ODAwCisjZGVmaW5lIE1BWF9CVUxLX0lOX1JFUVVFU1RTICAgICAgICAg
ICAgNjQKKworc3RydWN0IEJ1ZmZlcmVkQnVsa1JlYWQKK3sKKyAgICBzdHJ1Y3QgdXNiX3JlZGly
X2J1bGtfcGFja2V0X2hlYWRlciBob3V0OworICAgIHVpbnQ2NF90IGlkOworfTsKKworc3RydWN0
IF9TcGljZVVzYkVtdWxhdGVkRGV2aWNlCit7CisgICAgVXNiRGV2aWNlT3BzIGRldl9vcHM7Cisg
ICAgU3BpY2VVc2JCYWNrZW5kICpiYWNrZW5kOworICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAq
cGFyZW50OworICAgIHN0cnVjdCB1c2JyZWRpcnBhcnNlciAqcGFyc2VyOworICAgIHZvaWQgKiBt
c2M7CisgICAgU3BpY2VDZExVIHVuaXRzW01BWF9MVU5fUEVSX0RFVklDRV07CisgICAgZ2Jvb2xl
YW4gbG9ja2VkOworICAgIGdib29sZWFuIGRlbGV0ZV9vbl9lamVjdDsKKyAgICBnYm9vbGVhbiBk
ZWxldGluZzsKKyAgICB1aW50MzJfdCBudW1fcmVhZHM7CisgICAgc3RydWN0IEJ1ZmZlcmVkQnVs
a1JlYWQgcmVhZF9idWxrW01BWF9CVUxLX0lOX1JFUVVFU1RTXTsKKyAgICB1aW50MTZfdCBzZXJp
YWxbNF07CisgICAgdWludDhfdCAgbWF4X2x1bl9pbmRleDsKK307CisKK3R5cGVkZWYgU3BpY2VV
c2JFbXVsYXRlZERldmljZSBVc2JDZDsKKworI2lmbmRlZiBHX09TX1dJTjMyCisKK3N0YXRpYyBp
bnQgY2RfZGV2aWNlX29wZW5fc3RyZWFtKFNwaWNlQ2RMVSAqdW5pdCwgY29uc3QgY2hhciAqZmls
ZW5hbWUpCit7CisgICAgaW50IGVycm9yID0gMDsKKyAgICB1bml0LT5kZXZpY2UgPSAwOworCisg
ICAgaWYgKCF1bml0LT5maWxlbmFtZSAmJiAhZmlsZW5hbWUpIHsKKyAgICAgICAgU1BJQ0VfREVC
VUcoIiVzOiBmaWxlIG5hbWUgbm90IHByb3ZpZGVkIiwgX19GVU5DVElPTl9fKTsKKyAgICAgICAg
cmV0dXJuIC0xOworICAgIH0KKyAgICBpZiAodW5pdC0+ZmlsZW5hbWUgJiYgZmlsZW5hbWUpIHsK
KyAgICAgICAgZ19mcmVlKHVuaXQtPmZpbGVuYW1lKTsKKyAgICAgICAgdW5pdC0+ZmlsZW5hbWUg
PSBOVUxMOworICAgIH0KKyAgICBpZiAoZmlsZW5hbWUpIHsKKyAgICAgICAgdW5pdC0+ZmlsZW5h
bWUgPSBnX3N0cmR1cChmaWxlbmFtZSk7CisgICAgfQorCisgICAgaW50IGZkID0gb3Blbih1bml0
LT5maWxlbmFtZSwgT19SRE9OTFkgfCBPX05PTkJMT0NLKTsKKyAgICBpZiAoZmQgPiAwKSB7Cisg
ICAgICAgIHN0cnVjdCBzdGF0IGZpbGVfc3RhdCA9IHsgMCB9OworICAgICAgICBpZiAoZnN0YXQo
ZmQsICZmaWxlX3N0YXQpIHx8IGZpbGVfc3RhdC5zdF9zaXplID09IDApIHsKKyAgICAgICAgICAg
IGZpbGVfc3RhdC5zdF9zaXplID0gMDsKKyAgICAgICAgICAgIHVuaXQtPmRldmljZSA9IDE7Cisg
ICAgICAgICAgICBpZiAoIWlvY3RsKGZkLCBCTEtHRVRTSVpFNjQsICZmaWxlX3N0YXQuc3Rfc2l6
ZSkgJiYKKyAgICAgICAgICAgICAgICAhaW9jdGwoZmQsIEJMS1NTWkdFVCwgJnVuaXQtPmJsb2Nr
U2l6ZSkpIHsKKyAgICAgICAgICAgIH0KKyAgICAgICAgfQorICAgICAgICB1bml0LT5zaXplID0g
ZmlsZV9zdGF0LnN0X3NpemU7CisgICAgICAgIGNsb3NlKGZkKTsKKyAgICAgICAgaWYgKHVuaXQt
PnNpemUpIHsKKyAgICAgICAgICAgIHVuaXQtPmZpbGVfb2JqZWN0ID0gZ19maWxlX25ld19mb3Jf
cGF0aCh1bml0LT5maWxlbmFtZSk7CisgICAgICAgICAgICB1bml0LT5zdHJlYW0gPSBnX2ZpbGVf
cmVhZCh1bml0LT5maWxlX29iamVjdCwgTlVMTCwgTlVMTCk7CisgICAgICAgIH0KKyAgICAgICAg
aWYgKCF1bml0LT5zdHJlYW0pIHsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlczogY2FuJ3Qg
b3BlbiBzdHJlYW0gb24gJXMiLCBfX0ZVTkNUSU9OX18sIHVuaXQtPmZpbGVuYW1lKTsKKyAgICAg
ICAgICAgIGdfb2JqZWN0X3VucmVmKHVuaXQtPmZpbGVfb2JqZWN0KTsKKyAgICAgICAgICAgIHVu
aXQtPmZpbGVfb2JqZWN0ID0gTlVMTDsKKyAgICAgICAgICAgIGVycm9yID0gLTE7CisgICAgICAg
IH0KKyAgICB9CisgICAgZWxzZSB7CisgICAgICAgIFNQSUNFX0RFQlVHKCIlczogY2FuJ3Qgb3Bl
biBmaWxlICVzIiwgX19GVU5DVElPTl9fLCB1bml0LT5maWxlbmFtZSk7CisgICAgICAgIGVycm9y
ID0gLTE7CisgICAgfQorCisgICAgcmV0dXJuIGVycm9yOworfQorCitzdGF0aWMgaW50IGNkX2Rl
dmljZV9sb2FkKFNwaWNlQ2RMVSAqdW5pdCwgZ2Jvb2xlYW4gbG9hZCkKK3sKKyAgICBpbnQgZXJy
b3I7CisgICAgaWYgKCF1bml0LT5kZXZpY2UgfHwgIXVuaXQtPmZpbGVuYW1lKSB7CisgICAgICAg
IHJldHVybiAtMTsKKyAgICB9CisgICAgaW50IGZkID0gb3Blbih1bml0LT5maWxlbmFtZSwgT19S
RE9OTFkgfCBPX05PTkJMT0NLKTsKKyAgICBpZiAoZmQgPCAwKSB7CisgICAgICAgIHJldHVybiAt
MTsKKyAgICB9CisgICAgaWYgKGxvYWQpIHsKKyAgICAgICAgZXJyb3IgPSBpb2N0bChmZCwgQ0RS
T01DTE9TRVRSQVksIDApOworICAgIH0gZWxzZSB7CisgICAgICAgIGVycm9yID0gaW9jdGwoZmQs
IENEUk9NX0xPQ0tET09SLCAwKTsKKyAgICAgICAgZXJyb3IgPSBpb2N0bChmZCwgQ0RST01FSkVD
VCwgMCk7CisgICAgfQorICAgIGlmIChlcnJvcikgeworICAgICAgICAvLyBub3RlIHRoYXQgZWpl
Y3RpbmcgbWlnaHQgYmUgYXZhaWxhYmxlIG9ubHkgZm9yIHJvb3QKKyAgICAgICAgLy8gbG9hZGlu
ZyBtaWdodCBiZSBhdmFpbGFibGUgYWxzbyBmb3IgcmVndWxhciB1c2VyCisgICAgICAgIFNQSUNF
X0RFQlVHKCIlczogY2FuJ3QgJXNsb2FkICVzLCByZXMgJWQsIGVycm5vICVkIiwKKyAgICAgICAg
ICAgIF9fRlVOQ1RJT05fXywgbG9hZCA/ICIiIDogInVuIiwgdW5pdC0+ZmlsZW5hbWUsIGVycm9y
LCBlcnJubyk7CisgICAgfQorICAgIGNsb3NlKGZkKTsKKyAgICByZXR1cm4gZXJyb3I7Cit9CisK
K3N0YXRpYyBpbnQgY2RfZGV2aWNlX2NoZWNrKFNwaWNlQ2RMVSAqdW5pdCkKK3sKKyAgICBpbnQg
ZXJyb3I7CisgICAgaWYgKCF1bml0LT5kZXZpY2UgfHwgIXVuaXQtPmZpbGVuYW1lKSB7CisgICAg
ICAgIHJldHVybiAtMTsKKyAgICB9CisgICAgaW50IGZkID0gb3Blbih1bml0LT5maWxlbmFtZSwg
T19SRE9OTFkgfCBPX05PTkJMT0NLKTsKKyAgICBpZiAoZmQgPCAwKSB7CisgICAgICAgIHJldHVy
biAtMTsKKyAgICB9CisgICAgZXJyb3IgPSBpb2N0bChmZCwgQ0RST01fRFJJVkVfU1RBVFVTLCAw
KTsKKyAgICBlcnJvciA9IChlcnJvciA9PSBDRFNfRElTQ19PSykgPyAwIDogLTE7CisgICAgaWYg
KCFlcnJvcikgeworICAgICAgICBlcnJvciA9IGlvY3RsKGZkLCBDRFJPTV9ESVNDX1NUQVRVUywg
MCk7CisgICAgICAgIGVycm9yID0gKGVycm9yID09IENEU19EQVRBXzEpID8gMCA6IC0xOworICAg
IH0KKyAgICBjbG9zZShmZCk7CisgICAgcmV0dXJuIGVycm9yOworfQorCisjZWxzZQorCitzdGF0
aWMgZ2Jvb2xlYW4gaXNfZGV2aWNlX25hbWUoY29uc3QgY2hhciAqZmlsZW5hbWUpCit7CisgICAg
Z2Jvb2xlYW4gYiA9IHN0cmxlbihmaWxlbmFtZSkgPT0gMiAmJiBmaWxlbmFtZVsxXSA9PSAnOic7
CisgICAgcmV0dXJuIGI7Cit9CisKK3N0YXRpYyBIQU5ETEUgb3Blbl9maWxlKGNvbnN0IGNoYXIg
KmZpbGVuYW1lKQoreworICAgIEhBTkRMRSBoID0gQ3JlYXRlRmlsZUEoZmlsZW5hbWUsCisgICAg
ICAgICAgICAgICAgICAgICAgICAgICBHRU5FUklDX1JFQUQsCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICBGSUxFX1NIQVJFX1JFQUQgfCBGSUxFX1NIQVJFX1dSSVRFLAorICAgICAgICAgICAg
ICAgICAgICAgICAgICAgTlVMTCwgT1BFTl9FWElTVElORywKKyAgICAgICAgICAgICAgICAgICAg
ICAgICAgIDAsCisgICAgICAgICAgICAgICAgICAgICAgICAgICBOVUxMKTsKKyAgICBpZiAoaCA9
PSBJTlZBTElEX0hBTkRMRV9WQUxVRSkgeworICAgICAgICBoID0gTlVMTDsKKyAgICB9CisgICAg
cmV0dXJuIGg7Cit9CisKK3N0YXRpYyB1aW50MzJfdCBpb2N0bF9vdXQoSEFORExFIGgsIHVpbnQz
Ml90IGNvZGUsIHZvaWQgKm91dF9idWZmZXIsIHVpbnQzMl90IG91dF9zaXplKQoreworICAgIHVp
bnQzMl90IGVycm9yOworICAgIERXT1JEIHJldDsKKyAgICBCT09MIGIgPSBEZXZpY2VJb0NvbnRy
b2woaCwgY29kZSwgTlVMTCwgMCwgb3V0X2J1ZmZlciwgb3V0X3NpemUsICZyZXQsIE5VTEwpOwor
ICAgIGVycm9yID0gYiA/IDAgOiBHZXRMYXN0RXJyb3IoKTsKKyAgICByZXR1cm4gZXJyb3I7Cit9
CisKK3N0YXRpYyB1aW50MzJfdCBpb2N0bF9ub25lKEhBTkRMRSBoLCB1aW50MzJfdCBjb2RlKQor
eworICAgIHJldHVybiBpb2N0bF9vdXQoaCwgY29kZSwgTlVMTCwgMCk7Cit9CisKK3N0YXRpYyBn
Ym9vbGVhbiBjaGVja19kZXZpY2UoSEFORExFIGgpCit7CisgICAgR0VUX0NPTkZJR1VSQVRJT05f
SU9DVExfSU5QVVQgY2ZnSW4gPQorICAgICAgICB7IEZlYXR1cmVDZFJlYWQsIFNDU0lfR0VUX0NP
TkZJR1VSQVRJT05fUkVRVUVTVF9UWVBFX0FMTCwge30gfTsKKyAgICBEV09SRCByZXQ7CisgICAg
R0VUX0NPTkZJR1VSQVRJT05fSEVBREVSIGNmZ091dDsKKyAgICByZXR1cm4gRGV2aWNlSW9Db250
cm9sKGgsIElPQ1RMX0NEUk9NX0dFVF9DT05GSUdVUkFUSU9OLAorICAgICAgICAgICAgICAgICAg
ICAgICAgICAgJmNmZ0luLCBzaXplb2YoY2ZnSW4pLCAmY2ZnT3V0LCBzaXplb2YoY2ZnT3V0KSwK
KyAgICAgICAgICAgICAgICAgICAgICAgICAgICZyZXQsIE5VTEwpOworfQorCitzdGF0aWMgaW50
IGNkX2RldmljZV9vcGVuX3N0cmVhbShTcGljZUNkTFUgKnVuaXQsIGNvbnN0IGNoYXIgKmZpbGVu
YW1lKQoreworICAgIGludCBlcnJvciA9IDA7CisgICAgSEFORExFIGg7CisgICAgdW5pdC0+ZGV2
aWNlID0gMDsKKyAgICBpZiAoIXVuaXQtPmZpbGVuYW1lICYmICFmaWxlbmFtZSkgeworICAgICAg
ICBTUElDRV9ERUJVRygiJXM6IHVubmFtZWQgZmlsZSIsIF9fRlVOQ1RJT05fXyk7CisgICAgICAg
IHJldHVybiAtMTsKKyAgICB9CisgICAgaWYgKHVuaXQtPmZpbGVuYW1lICYmIGZpbGVuYW1lKSB7
CisgICAgICAgIGdfZnJlZSh1bml0LT5maWxlbmFtZSk7CisgICAgICAgIHVuaXQtPmZpbGVuYW1l
ID0gTlVMTDsKKyAgICB9CisgICAgaWYgKCFmaWxlbmFtZSkgeworICAgICAgICAvLyByZW9wZW5p
bmcgdGhlIHN0cmVhbSBvbiBleGlzdGluZyBmaWxlIG5hbWUKKyAgICB9IGVsc2UgaWYgKGlzX2Rl
dmljZV9uYW1lKGZpbGVuYW1lKSkgeworICAgICAgICB1bml0LT5maWxlbmFtZSA9IGdfc3RyZHVw
X3ByaW50ZigiXFxcXC5cXCVzIiwgZmlsZW5hbWUpOworICAgIH0gZWxzZSB7CisgICAgICAgIHVu
aXQtPmZpbGVuYW1lID0gZ19zdHJkdXAoZmlsZW5hbWUpOworICAgIH0KKyAgICBoID0gb3Blbl9m
aWxlKHVuaXQtPmZpbGVuYW1lKTsKKyAgICBpZiAoaCkgeworICAgICAgICBMQVJHRV9JTlRFR0VS
IHNpemUgPSB7IDAgfTsKKyAgICAgICAgaWYgKCFHZXRGaWxlU2l6ZUV4KGgsICZzaXplKSkgewor
ICAgICAgICAgICAgdWludDY0X3QgYnVmZmVyWzI1Nl07CisgICAgICAgICAgICB1aW50MzJfdCBy
ZXM7CisgICAgICAgICAgICB1bml0LT5kZXZpY2UgPSBjaGVja19kZXZpY2UoaCk7CisgICAgICAg
ICAgICBTUElDRV9ERUJVRygiJXM6IENEIGRldmljZSAlc3JlY29nbml6ZWQgb24gJXMiLAorICAg
ICAgICAgICAgICAgIF9fRlVOQ1RJT05fXywgdW5pdC0+ZGV2aWNlID8gIiIgOiAiTk9UICIsIHVu
aXQtPmZpbGVuYW1lKTsKKyAgICAgICAgICAgIHJlcyA9IGlvY3RsX291dChoLCBJT0NUTF9ESVNL
X0dFVF9EUklWRV9HRU9NRVRSWV9FWCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICBidWZm
ZXIsIHNpemVvZihidWZmZXIpKTsKKyAgICAgICAgICAgIGlmICghcmVzKQorICAgICAgICAgICAg
eworICAgICAgICAgICAgICAgIERJU0tfR0VPTUVUUllfRVggKnBnID0gKERJU0tfR0VPTUVUUllf
RVggKilidWZmZXI7CisgICAgICAgICAgICAgICAgdW5pdC0+YmxvY2tTaXplID0gcGctPkdlb21l
dHJ5LkJ5dGVzUGVyU2VjdG9yOworICAgICAgICAgICAgICAgIHNpemUgPSBwZy0+RGlza1NpemU7
CisgICAgICAgICAgICB9IGVsc2UgeworICAgICAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlczog
Y2FuJ3Qgb2J0YWluIHNpemUgb2YgJXMgKGVycm9yICV1KSIsCisgICAgICAgICAgICAgICAgICAg
IF9fRlVOQ1RJT05fXywgdW5pdC0+ZmlsZW5hbWUsIHJlcyk7CisgICAgICAgICAgICB9CisgICAg
ICAgIH0KKyAgICAgICAgdW5pdC0+c2l6ZSA9IHNpemUuUXVhZFBhcnQ7CisgICAgICAgIENsb3Nl
SGFuZGxlKGgpOworICAgICAgICBpZiAodW5pdC0+c2l6ZSkgeworICAgICAgICAgICAgdW5pdC0+
ZmlsZV9vYmplY3QgPSBnX2ZpbGVfbmV3X2Zvcl9wYXRoKHVuaXQtPmZpbGVuYW1lKTsKKyAgICAg
ICAgICAgIHVuaXQtPnN0cmVhbSA9IGdfZmlsZV9yZWFkKHVuaXQtPmZpbGVfb2JqZWN0LCBOVUxM
LCBOVUxMKTsKKyAgICAgICAgfQorICAgICAgICBpZiAoIXVuaXQtPnN0cmVhbSkgeworICAgICAg
ICAgICAgU1BJQ0VfREVCVUcoIiVzOiBjYW4ndCBvcGVuIHN0cmVhbSBvbiAlcyIsIF9fRlVOQ1RJ
T05fXywgdW5pdC0+ZmlsZW5hbWUpOworICAgICAgICAgICAgZ19vYmplY3RfdW5yZWYodW5pdC0+
ZmlsZV9vYmplY3QpOworICAgICAgICAgICAgdW5pdC0+ZmlsZV9vYmplY3QgPSBOVUxMOworICAg
ICAgICAgICAgZXJyb3IgPSAtMTsKKyAgICAgICAgfQorICAgIH0gZWxzZSB7CisgICAgICAgIFNQ
SUNFX0RFQlVHKCIlczogY2FuJ3Qgb3BlbiBmaWxlICVzIiwgX19GVU5DVElPTl9fLCB1bml0LT5m
aWxlbmFtZSk7CisgICAgICAgIGVycm9yID0gLTE7CisgICAgfQorICAgIHJldHVybiBlcnJvcjsK
K30KKworc3RhdGljIGludCBjZF9kZXZpY2VfbG9hZChTcGljZUNkTFUgKnVuaXQsIGdib29sZWFu
IGxvYWQpCit7CisgICAgaW50IGVycm9yID0gMDsKKyAgICBIQU5ETEUgaDsKKyAgICBpZiAoIXVu
aXQtPmRldmljZSB8fCAhdW5pdC0+ZmlsZW5hbWUpIHsKKyAgICAgICAgcmV0dXJuIC0xOworICAg
IH0KKyAgICBoID0gb3Blbl9maWxlKHVuaXQtPmZpbGVuYW1lKTsKKyAgICBpZiAoaCkgeworICAg
ICAgICB1aW50MzJfdCByZXMgPSBpb2N0bF9ub25lKGgsIGxvYWQgPyBJT0NUTF9TVE9SQUdFX0xP
QURfTUVESUEgOiBJT0NUTF9TVE9SQUdFX0VKRUNUX01FRElBKTsKKyAgICAgICAgaWYgKHJlcykg
eworICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBjYW4ndCAlc2xvYWQgJXMsIHdpbiBlcnJv
ciAldSIsCisgICAgICAgICAgICAgICAgICAgICAgICBfX0ZVTkNUSU9OX18sIGxvYWQgPyAiIiA6
ICJ1biIsIHVuaXQtPmZpbGVuYW1lLCByZXMpOworICAgICAgICAgICAgZXJyb3IgPSAtMTsKKyAg
ICAgICAgfSBlbHNlIHsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlczogZGV2aWNlICVzIFsl
c10iLAorICAgICAgICAgICAgICAgICAgICAgICAgX19GVU5DVElPTl9fLCBsb2FkID8gImxvYWRl
ZCIgOiAiZWplY3RlZCIsIHVuaXQtPmZpbGVuYW1lKTsKKyAgICAgICAgfQorICAgICAgICBDbG9z
ZUhhbmRsZShoKTsKKyAgICB9CisgICAgcmV0dXJuIGVycm9yOworfQorCitzdGF0aWMgaW50IGNk
X2RldmljZV9jaGVjayhTcGljZUNkTFUgKnVuaXQpCit7CisgICAgaW50IGVycm9yID0gMDsKKyAg
ICBDRFJPTV9ESVNLX0RBVEEgZGF0YTsKKyAgICBIQU5ETEUgaDsKKyAgICBpZiAoIXVuaXQtPmRl
dmljZSB8fCAhdW5pdC0+ZmlsZW5hbWUpIHsKKyAgICAgICAgcmV0dXJuIC0xOworICAgIH0KKyAg
ICBoID0gb3Blbl9maWxlKHVuaXQtPmZpbGVuYW1lKTsKKyAgICBpZiAoaCkgeworICAgICAgICB1
aW50MzJfdCByZXMgPSBpb2N0bF9ub25lKGgsIElPQ1RMX1NUT1JBR0VfQ0hFQ0tfVkVSSUZZKTsK
KyAgICAgICAgaWYgKCFyZXMpIHsKKyAgICAgICAgICAgIHJlcyA9IGlvY3RsX291dChoLCBJT0NU
TF9DRFJPTV9ESVNLX1RZUEUsICZkYXRhLCBzaXplb2YoZGF0YSkpOworICAgICAgICB9CisgICAg
ICAgIGlmIChyZXMgIT0gMCB8fCBkYXRhLkRpc2tEYXRhICE9IENEUk9NX0RJU0tfREFUQV9UUkFD
SykgeworICAgICAgICAgICAgZXJyb3IgPSAtMTsKKyAgICAgICAgfQorICAgICAgICBDbG9zZUhh
bmRsZShoKTsKKyAgICB9CisgICAgcmV0dXJuIGVycm9yOworfQorCisjZW5kaWYKKworc3RhdGlj
IGdib29sZWFuIG9wZW5fc3RyZWFtKFNwaWNlQ2RMVSAqdW5pdCwgY29uc3QgY2hhciAqZmlsZW5h
bWUpCit7CisgICAgZ2Jvb2xlYW4gYiA9IEZBTFNFOworICAgIGIgPSBjZF9kZXZpY2Vfb3Blbl9z
dHJlYW0odW5pdCwgZmlsZW5hbWUpID09IDA7CisgICAgcmV0dXJuIGI7Cit9CisKK3N0YXRpYyB2
b2lkIGNsb3NlX3N0cmVhbShTcGljZUNkTFUgKnVuaXQpCit7CisgICAgaWYgKHVuaXQtPnN0cmVh
bSkgeworICAgICAgICBnX29iamVjdF91bnJlZih1bml0LT5zdHJlYW0pOworICAgICAgICB1bml0
LT5zdHJlYW0gPSBOVUxMOworICAgIH0KKyAgICBpZiAodW5pdC0+ZmlsZV9vYmplY3QpIHsKKyAg
ICAgICAgZ19vYmplY3RfdW5yZWYodW5pdC0+ZmlsZV9vYmplY3QpOworICAgICAgICB1bml0LT5m
aWxlX29iamVjdCA9IE5VTEw7CisgICAgfQorfQorCitzdGF0aWMgZ2Jvb2xlYW4gbG9hZF9sdW4o
VXNiQ2QgKmQsIGludCB1bml0LCBnYm9vbGVhbiBsb2FkKQoreworICAgIGdib29sZWFuIGIgPSBU
UlVFOworICAgIGlmIChsb2FkICYmIGQtPnVuaXRzW3VuaXRdLmRldmljZSkgeworICAgICAgICAv
LyB0aGVyZSBpcyBvbmUgcG9zc2libGUgcHJvYmxlbSBpbiBjYXNlIG91ciBiYWNrZW5kIGlzIHRo
ZQorICAgICAgICAvLyBsb2NhbCBDRCBkZXZpY2UgYW5kIGl0IGlzIGVqZWN0ZWQKKyAgICAgICAg
Y2RfZGV2aWNlX2xvYWQoJmQtPnVuaXRzW3VuaXRdLCBUUlVFKTsKKyAgICAgICAgY2xvc2Vfc3Ry
ZWFtKCZkLT51bml0c1t1bml0XSk7CisgICAgICAgIGlmIChjZF9kZXZpY2VfY2hlY2soJmQtPnVu
aXRzW3VuaXRdKSB8fCAhb3Blbl9zdHJlYW0oJmQtPnVuaXRzW3VuaXRdLCBOVUxMKSkgeworICAg
ICAgICAgICAgcmV0dXJuIEZBTFNFOworICAgICAgICB9CisgICAgfQorCisgICAgaWYgKGxvYWQp
IHsKKyAgICAgICAgQ2RTY3NpTWVkaWFQYXJhbWV0ZXJzIG1lZGlhX3BhcmFtcyA9IHsgMCB9Owor
CisgICAgICAgIG1lZGlhX3BhcmFtcy5zdHJlYW0gPSBkLT51bml0c1t1bml0XS5zdHJlYW07Cisg
ICAgICAgIG1lZGlhX3BhcmFtcy5zaXplID0gZC0+dW5pdHNbdW5pdF0uc2l6ZTsKKyAgICAgICAg
bWVkaWFfcGFyYW1zLmJsb2NrX3NpemUgPSBkLT51bml0c1t1bml0XS5ibG9ja1NpemU7CisgICAg
ICAgIGlmIChtZWRpYV9wYXJhbXMuYmxvY2tfc2l6ZSA9PSBDRF9ERVZfQkxPQ0tfU0laRSAmJgor
ICAgICAgICAgICAgbWVkaWFfcGFyYW1zLnNpemUgJSBEVkRfREVWX0JMT0NLX1NJWkUgPT0gMCkg
eworICAgICAgICAgICAgbWVkaWFfcGFyYW1zLmJsb2NrX3NpemUgPSBEVkRfREVWX0JMT0NLX1NJ
WkU7CisgICAgICAgIH0KKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBsb2FkaW5nICVzLCBzaXpl
ICUiIFBSSXU2NCAiLCBibG9jayAldSIsCisgICAgICAgICAgICAgICAgICAgIF9fRlVOQ1RJT05f
XywgZC0+dW5pdHNbdW5pdF0uZmlsZW5hbWUsIG1lZGlhX3BhcmFtcy5zaXplLCBtZWRpYV9wYXJh
bXMuYmxvY2tfc2l6ZSk7CisKKyAgICAgICAgYiA9ICFjZF91c2JfYnVsa19tc2RfbG9hZChkLT5t
c2MsIHVuaXQsICZtZWRpYV9wYXJhbXMpOworCisgICAgICAgIGQtPnVuaXRzW3VuaXRdLmxvYWRl
ZCA9ICEhYjsKKworICAgIH0gZWxzZSB7CisgICAgICAgIFNQSUNFX0RFQlVHKCIlczogdW5sb2Fk
aW5nICVzIiwgX19GVU5DVElPTl9fLCBkLT51bml0c1t1bml0XS5maWxlbmFtZSk7CisgICAgICAg
IGNkX3VzYl9idWxrX21zZF91bmxvYWQoZC0+bXNjLCB1bml0KTsKKyAgICAgICAgZC0+dW5pdHNb
dW5pdF0ubG9hZGVkID0gRkFMU0U7CisgICAgfQorICAgIHJldHVybiBiOworfQorCitzdGF0aWMg
dm9pZCB1c2JfY2RfZGVsZXRlKFVzYkNkICpkKQoreworICAgIHVpbnQzMl90IHVuaXQgPSAwOwor
ICAgIGNkX3VzYl9idWxrX21zZF91bnJlYWxpemUoZC0+bXNjLCB1bml0KTsKKyAgICBnX2NsZWFy
X3BvaW50ZXIoJmQtPnVuaXRzW3VuaXRdLmZpbGVuYW1lLCBnX2ZyZWUpOworICAgIGNsb3NlX3N0
cmVhbSgmZC0+dW5pdHNbdW5pdF0pOworICAgIGdfY2xlYXJfcG9pbnRlcigmZC0+bXNjLCBjZF91
c2JfYnVsa19tc2RfZnJlZSk7CisgICAgZ19mcmVlKGQpOworfQorCitzdGF0aWMgZ2Jvb2xlYW4g
dXNiX2NkX2dldF9kZXNjcmlwdG9yKFVzYkNkICpkLCB1aW50OF90IHR5cGUsIHVpbnQ4X3QgaW5k
ZXgsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZvaWQgKipidWZmZXIs
IHVpbnQxNl90ICpzaXplKQoreworICAgIHN0YXRpYyBzdHJ1Y3QgbGlidXNiX2RldmljZV9kZXNj
cmlwdG9yIGRlc2MgPQorICAgIHsKKyAgICAgICAgLmJMZW5ndGggPSAxOCwKKyAgICAgICAgLmJE
ZXNjcmlwdG9yVHlwZSA9IExJQlVTQl9EVF9ERVZJQ0UsCisgICAgICAgIC5iY2RVU0IgPSBVU0Iy
X0JDRCwKKyAgICAgICAgLmJEZXZpY2VDbGFzcyA9IDAsCisgICAgICAgIC5iRGV2aWNlU3ViQ2xh
c3MgPSAwLAorICAgICAgICAuYkRldmljZVByb3RvY29sID0gMCwKKyAgICAgICAgLmJNYXhQYWNr
ZXRTaXplMCA9IDY0LAorICAgICAgICAuaWRWZW5kb3IgPSBDRF9ERVZfVklELAorICAgICAgICAu
aWRQcm9kdWN0ID0gQ0RfREVWX1BJRCwKKyAgICAgICAgLmJjZERldmljZSA9IDB4MTAwLAorICAg
ICAgICAuaU1hbnVmYWN0dXJlciA9IDEsCisgICAgICAgIC5pUHJvZHVjdCA9IDIsCisgICAgICAg
IC5pU2VyaWFsTnVtYmVyID0gMywKKyAgICAgICAgLmJOdW1Db25maWd1cmF0aW9ucyA9IDEKKyAg
ICB9OworICAgIHN0YXRpYyB1aW50OF90IGNmZ1tdID0KKyAgICB7CisgICAgICAgIDksIC8vbGVu
IG9mIGNmZyBkZXNjCisgICAgICAgIExJQlVTQl9EVF9DT05GSUcsIC8vIGRlc2MgdHlwZQorICAg
ICAgICAweDIwLCAvLyB3bGVuCisgICAgICAgIDAsCisgICAgICAgIDEsIC8vIG51bSBpZgorICAg
ICAgICAxLCAvLyBjZmcgdmFsCisgICAgICAgIDAsIC8vIGNmZyBuYW1lCisgICAgICAgIDB4ODAs
IC8vIGJ1cyBwb3dlcmVkCisgICAgICAgIDB4MzIsIC8vIDEwMCBtYQorICAgICAgICA5LCAvLyBs
ZW4gb2YgSUYgZGVzYworICAgICAgICBMSUJVU0JfRFRfSU5URVJGQUNFLAorICAgICAgICAwLCAv
LyBudW0gaWYKKyAgICAgICAgMCwgLy8gYWx0IHNldHRpbmcKKyAgICAgICAgMiwgLy8gbnVtIG9m
IGVuZHBvaW50cworICAgICAgICBDRF9ERVZfQ0xBU1MsCisgICAgICAgIENEX0RFVl9TVUJDTEFT
UywKKyAgICAgICAgQ0RfREVWX1BST1RPQ09MLAorICAgICAgICAwLCAvLyBpZiBuYW1lCisgICAg
ICAgIDcsCisgICAgICAgIExJQlVTQl9EVF9FTkRQT0lOVCwKKyAgICAgICAgMHg4MSwgLy8tPkRp
cmVjdGlvbiA6IElOIC0gRW5kcG9pbnRJRCA6IDEKKyAgICAgICAgMHgwMiwgLy8tPkJ1bGsgVHJh
bnNmZXIgVHlwZQorICAgICAgICAwLCAgICAvL3dNYXhQYWNrZXRTaXplIDogMHgwMjAwID0gMHgy
MDAgbWF4IGJ5dGVzCisgICAgICAgIDIsCisgICAgICAgIDAsICAgIC8vYkludGVydmFsCisgICAg
ICAgIDcsCisgICAgICAgIExJQlVTQl9EVF9FTkRQT0lOVCwKKyAgICAgICAgMHgwMiwgLy8tPkRp
cmVjdGlvbiA6IE9VVCAtIEVuZHBvaW50SUQgOiAyCisgICAgICAgIDB4MDIsIC8vLT5CdWxrIFRy
YW5zZmVyIFR5cGUKKyAgICAgICAgMCwgICAgLy93TWF4UGFja2V0U2l6ZSA6IDB4MDIwMCA9IDB4
MjAwIG1heCBieXRlcworICAgICAgICAyLAorICAgICAgICAwLCAgICAvL2JJbnRlcnZhbAorICAg
IH07CisgICAgc3RhdGljIHVpbnQxNl90IHMwWzJdID0geyAweDMwNCwgMHg0MDkgfTsKKyAgICBz
dGF0aWMgdWludDE2X3QgczFbOF0gPSB7IDB4MzEwLCAnUicsICdlJywgJ2QnLCAnICcsICdIJywg
J2EnLCAndCcgfTsKKyAgICBzdGF0aWMgdWludDE2X3QgczJbOV0gPSB7IDB4MzEyLCAnUycsICdw
JywgJ2knLCAnYycsICdlJywgJyAnLCAnQycsICdEJyB9OworCisgICAgdm9pZCAqcCA9IE5VTEw7
CisgICAgdWludDE2X3QgbGVuID0gMDsKKworICAgIHN3aXRjaCAodHlwZSkKKyAgICB7CisgICAg
ICAgIGNhc2UgTElCVVNCX0RUX0RFVklDRToKKyAgICAgICAgICAgIHAgPSAmZGVzYzsKKyAgICAg
ICAgICAgIGxlbiA9IHNpemVvZihkZXNjKTsKKyAgICAgICAgICAgIGJyZWFrOworICAgICAgICBj
YXNlIExJQlVTQl9EVF9DT05GSUc6CisgICAgICAgICAgICBwID0gY2ZnOworICAgICAgICAgICAg
bGVuID0gc2l6ZW9mKGNmZyk7CisgICAgICAgICAgICBicmVhazsKKyAgICAgICAgY2FzZSBMSUJV
U0JfRFRfU1RSSU5HOgorICAgICAgICAgICAgaWYgKGluZGV4ID09IDApIHsKKyAgICAgICAgICAg
ICAgICBwID0gczA7IGxlbiA9IHNpemVvZihzMCk7CisgICAgICAgICAgICB9IGVsc2UgaWYgKGlu
ZGV4ID09IDEpIHsKKyAgICAgICAgICAgICAgICBwID0gczE7IGxlbiA9IHNpemVvZihzMSk7Cisg
ICAgICAgICAgICB9IGVsc2UgaWYgKGluZGV4ID09IDIpIHsKKyAgICAgICAgICAgICAgICBwID0g
czI7IGxlbiA9IHNpemVvZihzMik7CisgICAgICAgICAgICB9IGVsc2UgaWYgKGluZGV4ID09IDMp
IHsKKyAgICAgICAgICAgICAgICBwID0gZC0+c2VyaWFsOyBsZW4gPSBzaXplb2YoZC0+c2VyaWFs
KTsKKyAgICAgICAgICAgIH0KKyAgICAgICAgICAgIGJyZWFrOworICAgIH0KKworICAgIGlmIChw
KSB7CisgICAgICAgICpidWZmZXIgPSBwOworICAgICAgICAqc2l6ZSA9IGxlbjsKKyAgICB9CisK
KyAgICByZXR1cm4gcCAhPSBOVUxMOworfQorCitzdGF0aWMgdm9pZCB1c2JfY2RfYXR0YWNoKFVz
YkNkICpkZXZpY2UsIHN0cnVjdCB1c2JyZWRpcnBhcnNlciAqcGFyc2VyKQoreworICAgIGRldmlj
ZS0+cGFyc2VyID0gcGFyc2VyOworfQorCitzdGF0aWMgdm9pZCB1c2JfY2RfZGV0YWNoKFVzYkNk
ICpkZXZpY2UpCit7CisgICAgZGV2aWNlLT5wYXJzZXIgPSBOVUxMOworfQorCitzdGF0aWMgdm9p
ZCB1c2JfY2RfcmVzZXQoVXNiQ2QgKmRldmljZSkKK3sKKyAgICBjZF91c2JfYnVsa19tc2RfcmVz
ZXQoZGV2aWNlLT5tc2MpOworfQorCitzdGF0aWMgdm9pZCB1c2JfY2RfY29udHJvbF9yZXF1ZXN0
KFVzYkNkICpkZXZpY2UsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQ4
X3QgKmRhdGEsIGludCBkYXRhX2xlbiwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgc3RydWN0IHVzYl9yZWRpcl9jb250cm9sX3BhY2tldF9oZWFkZXIgKmgsCisgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIHZvaWQgKipidWZmZXIpCit7CisgICAgdWludDhfdCBy
ZXF0eXBlID0gaC0+cmVxdWVzdHR5cGUgJiAweDdmOworICAgIGlmICghZGV2aWNlLT5tc2MpIHsK
KyAgICAgICAgcmV0dXJuOworICAgIH0KKyAgICBpZiAocmVxdHlwZSA9PSAoTElCVVNCX1JFUVVF
U1RfVFlQRV9TVEFOREFSRCB8IExJQlVTQl9SRUNJUElFTlRfRU5EUE9JTlQpKSB7CisgICAgICAg
IC8vIG1pZ2h0IGJlIGNsZWFyIHN0YWxsIHJlcXVlc3QKKyAgICAgICAgaC0+bGVuZ3RoID0gMDsK
KyAgICAgICAgaC0+c3RhdHVzID0gdXNiX3JlZGlyX3N1Y2Nlc3M7OworICAgICAgICByZXR1cm47
CisgICAgfQorCisgICAgaWYgKHJlcXR5cGUgPT0gKExJQlVTQl9SRVFVRVNUX1RZUEVfQ0xBU1Mg
fCBMSUJVU0JfUkVDSVBJRU5UX0lOVEVSRkFDRSkpIHsKKyAgICAgICAgc3dpdGNoIChoLT5yZXF1
ZXN0KSB7CisgICAgICAgICAgICBjYXNlIDB4RkY6CisgICAgICAgICAgICAgICAgLy8gbWFzcy1z
dG9yYWdlIGNsYXNzIHJlcXVlc3QgJ3Jlc2V0JworICAgICAgICAgICAgICAgIHVzYl9jZF9yZXNl
dChkZXZpY2UpOworICAgICAgICAgICAgICAgIGgtPmxlbmd0aCA9IDA7CisgICAgICAgICAgICAg
ICAgaC0+c3RhdHVzID0gdXNiX3JlZGlyX3N1Y2Nlc3M7CisgICAgICAgICAgICAgICAgYnJlYWs7
CisgICAgICAgICAgICBjYXNlIDB4RkU6CisgICAgICAgICAgICAgICAgLy8gbWFzcy1zdG9yYWdl
IGNsYXNzIHJlcXVlc3QgJ2dldCBtYXggbHVuJworICAgICAgICAgICAgICAgIC8vIHJldHVybmlu
ZyBvbmUgYnl0ZQorICAgICAgICAgICAgICAgIGlmIChoLT5sZW5ndGgpIHsKKyAgICAgICAgICAg
ICAgICAgICAgaC0+bGVuZ3RoID0gMTsKKyAgICAgICAgICAgICAgICAgICAgaC0+c3RhdHVzID0g
dXNiX3JlZGlyX3N1Y2Nlc3M7OworICAgICAgICAgICAgICAgICAgICAqYnVmZmVyID0gJmRldmlj
ZS0+bWF4X2x1bl9pbmRleDsKKyAgICAgICAgICAgICAgICB9CisgICAgICAgICAgICAgICAgYnJl
YWs7CisgICAgICAgIH0KKyAgICB9Cit9CisKK3N0YXRpYyB2b2lkIHVzYl9jZF9idWxrX291dF9y
ZXF1ZXN0KFVzYkNkICpkZXZpY2UsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICB1aW50OF90IGVwLCB1aW50OF90ICpkYXRhLCBpbnQgZGF0YV9sZW4sCisgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICB1aW50OF90ICpzdGF0dXMpCit7CisgICAgaWYgKCFjZF91
c2JfYnVsa19tc2Rfd3JpdGUoZGV2aWNlLT5tc2MsIGRhdGEsIGRhdGFfbGVuKSkgeworICAgICAg
ICAqc3RhdHVzID0gdXNiX3JlZGlyX3N1Y2Nlc3M7CisgICAgfQorfQorCit2b2lkIGNkX3VzYl9i
dWxrX21zZF9yZWFkX2NvbXBsZXRlKHZvaWQgKnVzZXJfZGF0YSwKKyAgICB1aW50OF90ICpkYXRh
LCB1aW50MzJfdCBsZW5ndGgsIENkVXNiQnVsa1N0YXR1cyBzdGF0dXMpCit7CisgICAgVXNiQ2Qg
KmQgPSAoVXNiQ2QgKil1c2VyX2RhdGE7CisKKyAgICBpZiAoZC0+ZGVsZXRpbmcpIHsKKyAgICAg
ICAgZC0+ZGVsZXRpbmcgPSBGQUxTRTsKKyAgICAgICAgc3BpY2VfdXNiX2JhY2tlbmRfZGV2aWNl
X2VqZWN0KGQtPmJhY2tlbmQsIGQtPnBhcmVudCk7CisgICAgfQorCisgICAgaWYgKGQtPnBhcnNl
cikgeworICAgICAgICBpbnQgbnJlYWQ7CisgICAgICAgIHVpbnQzMl90IG9mZnNldCA9IDA7CisK
KyAgICAgICAgZm9yIChucmVhZCA9IDA7IG5yZWFkIDwgZC0+bnVtX3JlYWRzOyBucmVhZCsrKSB7
CisgICAgICAgICAgICB1aW50MzJfdCBtYXhfbGVuOworICAgICAgICAgICAgbWF4X2xlbiA9IChk
LT5yZWFkX2J1bGtbbnJlYWRdLmhvdXQubGVuZ3RoX2hpZ2ggPDwgMTYpIHwKKyAgICAgICAgICAg
ICAgICAgICAgICAgIGQtPnJlYWRfYnVsa1tucmVhZF0uaG91dC5sZW5ndGg7CisgICAgICAgICAg
ICBpZiAobWF4X2xlbiA+IGxlbmd0aCkgeworICAgICAgICAgICAgICAgIG1heF9sZW4gPSBsZW5n
dGg7CisgICAgICAgICAgICAgICAgZC0+cmVhZF9idWxrW25yZWFkXS5ob3V0Lmxlbmd0aCA9IGxl
bmd0aDsKKyAgICAgICAgICAgICAgICBkLT5yZWFkX2J1bGtbbnJlYWRdLmhvdXQubGVuZ3RoX2hp
Z2ggPSBsZW5ndGggPj4gMTY7CisgICAgICAgICAgICB9CisKKyAgICAgICAgICAgIHN3aXRjaCAo
c3RhdHVzKSB7CisgICAgICAgICAgICBjYXNlIEJVTEtfU1RBVFVTX0dPT0Q6CisgICAgICAgICAg
ICAgICAgZC0+cmVhZF9idWxrW25yZWFkXS5ob3V0LnN0YXR1cyA9IHVzYl9yZWRpcl9zdWNjZXNz
OworICAgICAgICAgICAgICAgIGJyZWFrOworICAgICAgICAgICAgY2FzZSBCVUxLX1NUQVRVU19D
QU5DRUxFRDoKKyAgICAgICAgICAgICAgICBkLT5yZWFkX2J1bGtbbnJlYWRdLmhvdXQuc3RhdHVz
ID0gdXNiX3JlZGlyX2NhbmNlbGxlZDsKKyAgICAgICAgICAgICAgICBicmVhazsKKyAgICAgICAg
ICAgIGNhc2UgQlVMS19TVEFUVVNfRVJST1I6CisgICAgICAgICAgICAgICAgZC0+cmVhZF9idWxr
W25yZWFkXS5ob3V0LnN0YXR1cyA9IHVzYl9yZWRpcl9pb2Vycm9yOworICAgICAgICAgICAgICAg
IGJyZWFrOworICAgICAgICAgICAgY2FzZSBCVUxLX1NUQVRVU19TVEFMTDoKKyAgICAgICAgICAg
IGRlZmF1bHQ6CisgICAgICAgICAgICAgICAgZC0+cmVhZF9idWxrW25yZWFkXS5ob3V0LnN0YXR1
cyA9IHVzYl9yZWRpcl9zdGFsbDsKKyAgICAgICAgICAgICAgICBicmVhazsKKyAgICAgICAgICAg
IH0KKworICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiByZXNwb25kaW5nICUiIFBSSXU2NCAi
IHdpdGggbGVuICV1IG91dCBvZiAldSwgc3RhdHVzICVkIiwKKyAgICAgICAgICAgICAgICAgICAg
ICAgIF9fRlVOQ1RJT05fXywgZC0+cmVhZF9idWxrW25yZWFkXS5pZCwgbWF4X2xlbiwKKyAgICAg
ICAgICAgICAgICAgICAgICAgIGxlbmd0aCwgZC0+cmVhZF9idWxrW25yZWFkXS5ob3V0LnN0YXR1
cyk7CisgICAgICAgICAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2J1bGtfcGFja2V0KGQtPnBhcnNl
ciwgZC0+cmVhZF9idWxrW25yZWFkXS5pZCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgJmQtPnJlYWRfYnVsa1tucmVhZF0uaG91dCwKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4X2xlbiA/IChkYXRhICsgb2Zmc2V0KSA6
IE5VTEwsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heF9s
ZW4pOworICAgICAgICAgICAgb2Zmc2V0ICs9IG1heF9sZW47CisgICAgICAgICAgICBsZW5ndGgg
LT0gbWF4X2xlbjsKKyAgICAgICAgfQorICAgICAgICBkLT5udW1fcmVhZHMgPSAwOworICAgICAg
ICB1c2JyZWRpcnBhcnNlcl9kb193cml0ZShkLT5wYXJzZXIpOworCisgICAgICAgIGlmIChsZW5n
dGgpIHsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlczogRVJST1I6ICV1IGJ5dGVzIHdlcmUg
bm90IHJlcG9ydGVkISIsIF9fRlVOQ1RJT05fXywgbGVuZ3RoKTsKKyAgICAgICAgfQorCisgICAg
fSBlbHNlIHsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBicm9rZW4gZGV2aWNlPC0+Y2hhbm5l
bCByZWxhdGlvbnNoaXAhIiwgX19GVU5DVElPTl9fKTsKKyAgICB9Cit9CisKKy8qIGRldmljZSBy
ZXNldCBjb21wbGV0aW9uIGNhbGxiYWNrICovCit2b2lkIGNkX3VzYl9idWxrX21zZF9yZXNldF9j
b21wbGV0ZSh2b2lkICp1c2VyX2RhdGEsIGludCBzdGF0dXMpCit7CisgICAgLy8gVXNiQ2QgKmQg
PSAoVXNiQ2QgKil1c2VyX2RhdGE7Cit9CisKK3N0YXRpYyBnYm9vbGVhbiB1c2JfY2RfYnVsa19p
bl9yZXF1ZXN0KFVzYkNkICpkLCB1aW50NjRfdCBpZCwKKyAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgc3RydWN0IHVzYl9yZWRpcl9idWxrX3BhY2tldF9oZWFkZXIgKmgpCit7Cisg
ICAgaW50IHJlczsKKyAgICB1aW50MzJfdCBsZW4gPSAoaC0+bGVuZ3RoX2hpZ2ggPDwgMTYpIHwg
aC0+bGVuZ3RoOworICAgIGlmIChkLT5udW1fcmVhZHMgPj0gTUFYX0JVTEtfSU5fUkVRVUVTVFMp
IHsKKyAgICAgICAgaC0+bGVuZ3RoID0gaC0+bGVuZ3RoX2hpZ2ggPSAwOworICAgICAgICBTUElD
RV9ERUJVRygiJXM6IHRvbyBtYW55IHBlbmRpbmcgcmVhZHMiLCBfX0ZVTkNUSU9OX18pOworICAg
ICAgICBoLT5zdGF0dXMgPSB1c2JfcmVkaXJfYmFiYmxlOworICAgICAgICByZXR1cm4gRkFMU0U7
CisgICAgfQorCisgICAgaWYgKGQtPm51bV9yZWFkcykgeworICAgICAgICBTUElDRV9ERUJVRygi
JXM6IGFscmVhZHkgaGFzICV1IHBlbmRpbmcgcmVhZHMiLCBfX0ZVTkNUSU9OX18sIGQtPm51bV9y
ZWFkcyk7CisgICAgfQorCisgICAgZC0+cmVhZF9idWxrW2QtPm51bV9yZWFkc10uaG91dCA9ICpo
OworICAgIGQtPnJlYWRfYnVsa1tkLT5udW1fcmVhZHNdLmlkID0gaWQ7CisgICAgZC0+bnVtX3Jl
YWRzKys7CisgICAgcmVzID0gY2RfdXNiX2J1bGtfbXNkX3JlYWQoZC0+bXNjLCBsZW4pOworICAg
IGlmICghcmVzKSB7CisgICAgICAgIHJldHVybiBUUlVFOworICAgIH0KKworICAgIFNQSUNFX0RF
QlVHKCIlczogZXJyb3Igb24gYnVsayByZWFkIiwgX19GVU5DVElPTl9fKTsKKyAgICBkLT5udW1f
cmVhZHMtLTsKKyAgICBoLT5sZW5ndGggPSBoLT5sZW5ndGhfaGlnaCA9IDA7CisgICAgaC0+c3Rh
dHVzID0gdXNiX3JlZGlyX2lvZXJyb3I7CisKKyAgICByZXR1cm4gRkFMU0U7Cit9CisKK3N0YXRp
YyB2b2lkIHVzYl9jZF9jYW5jZWxfcmVxdWVzdChVc2JDZCAqZCwgdWludDY0X3QgaWQpCit7Cisg
ICAgdWludDMyX3QgbnJlYWQ7CisKKyAgICBmb3IgKG5yZWFkID0gMDsgbnJlYWQgPCBkLT5udW1f
cmVhZHM7IG5yZWFkKyspIHsKKyAgICAgICAgaWYgKGQtPnJlYWRfYnVsa1tucmVhZF0uaWQgPT0g
aWQpIHsKKyAgICAgICAgICAgIGlmIChjZF91c2JfYnVsa19tc2RfY2FuY2VsX3JlYWQoZC0+bXNj
KSkgeworICAgICAgICAgICAgICAgIGNkX3VzYl9idWxrX21zZF9yZWFkX2NvbXBsZXRlKGQsIE5V
TEwsIDAsIEJVTEtfU1RBVFVTX0NBTkNFTEVEKTsKKyAgICAgICAgICAgIH0KKyAgICAgICAgICAg
IHJldHVybjsKKyAgICAgICAgfQorICAgIH0KKyAgICBTUElDRV9ERUJVRygiJXM6IEVSUk9SOiBu
byBzdWNoIGlkIHRvIGNhbmNlbCEiLCBfX0ZVTkNUSU9OX18pOworfQorCisvLyBjYWxsZWQgd2hl
biBhIGNoYW5nZSBoYXBwZW5zIG9uIFNDU0kgbGF5ZXIKK3ZvaWQgY2RfdXNiX2J1bGtfbXNkX2x1
bl9jaGFuZ2VkKHZvaWQgKnVzZXJfZGF0YSwgdWludDMyX3QgbHVuKQoreworICAgIFVzYkNkICpk
ID0gKFVzYkNkICopdXNlcl9kYXRhOworICAgIENkU2NzaURldmljZUluZm8gY2RfaW5mbzsKKwor
ICAgIGlmICghY2RfdXNiX2J1bGtfbXNkX2dldF9pbmZvKGQtPm1zYywgbHVuLCAmY2RfaW5mbykp
IHsKKyAgICAgICAgLy8gbG9hZCBvciB1bmxvYWQgY29tbWFuZCByZWNlaXZlZCBmcm9tIFNDU0kK
KyAgICAgICAgaWYgKGQtPnVuaXRzW2x1bl0ubG9hZGVkICE9IGNkX2luZm8ubG9hZGVkKSB7Cisg
ICAgICAgICAgICBpZiAoIWxvYWRfbHVuKGQsIGx1biwgY2RfaW5mby5sb2FkZWQpKSB7CisgICAg
ICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBsb2FkIGZhaWxlZCwgdW5sb2FkaW5nIHVuaXQi
LCBfX0ZVTkNUSU9OX18pOworICAgICAgICAgICAgICAgIGNkX3VzYl9idWxrX21zZF91bmxvYWQo
ZC0+bXNjLCBsdW4pOworICAgICAgICAgICAgfQorICAgICAgICB9CisgICAgfQorCisgICAgaWYg
KGQtPmRlbGV0ZV9vbl9lamVjdCkgeworICAgICAgICBkLT5kZWxldGVfb25fZWplY3QgPSBGQUxT
RTsKKyAgICAgICAgZC0+ZGVsZXRpbmcgPSBUUlVFOworICAgIH0gZWxzZSB7CisgICAgICAgIHNw
aWNlX3VzYl9iYWNrZW5kX2RldmljZV9yZXBvcnRfY2hhbmdlKGQtPmJhY2tlbmQsIGQtPnBhcmVu
dCk7CisgICAgfQorfQorCitzdGF0aWMgZ2NoYXIgKnVzYl9jZF9nZXRfcHJvZHVjdF9kZXNjcmlw
dGlvbihVc2JDZCAqZGV2aWNlKQoreworICAgIGdjaGFyICpiYXNlX25hbWUgPSBnX3BhdGhfZ2V0
X2Jhc2VuYW1lKGRldmljZS0+dW5pdHNbMF0uZmlsZW5hbWUpOworICAgIGdjaGFyICpyZXMgPSBn
X3N0cmR1cF9wcmludGYoIlNQSUNFIENEKCVzKSIsIGJhc2VfbmFtZSk7CisgICAgZ19mcmVlKGJh
c2VfbmFtZSk7CisgICAgcmV0dXJuIHJlczsKK30KKworc3RhdGljIGNvbnN0IFVzYkRldmljZU9w
cyBkZXZvcHMgPQoreworICAgIC5nZXRfZGVzY3JpcHRvciA9IHVzYl9jZF9nZXRfZGVzY3JpcHRv
ciwKKyAgICAuZ2V0X3Byb2R1Y3RfZGVzY3JpcHRpb24gPSB1c2JfY2RfZ2V0X3Byb2R1Y3RfZGVz
Y3JpcHRpb24sCisgICAgLmF0dGFjaCA9IHVzYl9jZF9hdHRhY2gsCisgICAgLnJlc2V0ID0gdXNi
X2NkX3Jlc2V0LAorICAgIC5kZXRhY2ggPSB1c2JfY2RfZGV0YWNoLAorICAgIC5jb250cm9sX3Jl
cXVlc3QgPSB1c2JfY2RfY29udHJvbF9yZXF1ZXN0LAorICAgIC5idWxrX291dF9yZXF1ZXN0ID0g
dXNiX2NkX2J1bGtfb3V0X3JlcXVlc3QsCisgICAgLmJ1bGtfaW5fcmVxdWVzdCA9IHVzYl9jZF9i
dWxrX2luX3JlcXVlc3QsCisgICAgLmNhbmNlbF9yZXF1ZXN0ID0gdXNiX2NkX2NhbmNlbF9yZXF1
ZXN0LAorICAgIC5kZWxldGUgPSB1c2JfY2RfZGVsZXRlLAorfTsKKworc3RhdGljIGludCB1c2Jf
Y2RfY3JlYXRlKFNwaWNlVXNiQmFja2VuZCAqYmUsCisgICAgICAgICAgICAgICAgICAgICAgICAg
U3BpY2VVc2JCYWNrZW5kRGV2aWNlICpwYXJlbnQsCisgICAgICAgICAgICAgICAgICAgICAgICAg
VXNiQ3JlYXRlRGV2aWNlUGFyYW1ldGVycyAqcGFyYW0sCisgICAgICAgICAgICAgICAgICAgICAg
ICAgVXNiQ2QgKipkZXYpCit7CisgICAgaW50IGVycm9yID0gMDsKKyAgICB1aW50MzJfdCB1bml0
ID0gMDsKKyAgICBVc2JDZCAqZCA9IGdfbmV3MChVc2JDZCwgMSk7CisgICAgQ2RTY3NpRGV2aWNl
UGFyYW1ldGVycyBkZXZfcGFyYW1zID0geyAwIH07CisKKyAgICBkLT5kZXZfb3BzID0gZGV2b3Bz
OworICAgIGQtPmJhY2tlbmQgPSBiZTsKKyAgICBkLT5wYXJlbnQgID0gcGFyZW50OworICAgIGQt
PmRlbGV0ZV9vbl9lamVjdCA9ICEhcGFyYW0tPmRldmljZV9wYXJhbS5jcmVhdGVfY2QuZGVsZXRl
X29uX2VqZWN0OworICAgIGQtPmxvY2tlZCA9ICFkLT5kZWxldGVfb25fZWplY3Q7CisgICAgZC0+
c2VyaWFsWzBdID0gMHgwMzA4OworICAgIGQtPnNlcmlhbFsxXSA9ICdYJzsKKyAgICBkLT5zZXJp
YWxbMl0gPSAnMCcgKyBwYXJhbS0+YWRkcmVzcyAvIDEwOworICAgIGQtPnNlcmlhbFszXSA9ICcw
JyArIHBhcmFtLT5hZGRyZXNzICUgMTA7CisgICAgZC0+bWF4X2x1bl9pbmRleCA9IE1BWF9MVU5f
UEVSX0RFVklDRSAtIDE7CisKKyAgICBkZXZfcGFyYW1zLnZlbmRvciA9ICJTUElDRSI7CisgICAg
ZGV2X3BhcmFtcy5wcm9kdWN0ID0gInNoYXJlZCBDRCI7CisgICAgZGV2X3BhcmFtcy52ZXJzaW9u
ID0gIjAiOworCisgICAgZC0+bXNjID0gY2RfdXNiX2J1bGtfbXNkX2FsbG9jKGQsIE1BWF9MVU5f
UEVSX0RFVklDRSk7CisgICAgaWYgKCFkLT5tc2MpIHsKKyAgICAgICAgZ19jbGVhcl9wb2ludGVy
KCZkLCBnX2ZyZWUpOworICAgICAgICBwYXJhbS0+ZXJyb3IgPSBnX2Vycm9yX25ldyhTUElDRV9D
TElFTlRfRVJST1IsIFNQSUNFX0NMSUVOVF9FUlJPUl9GQUlMRUQsCisgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIF8oImNhbid0IGFsbG9jYXRlIGRldmljZSIpKTsKKyAgICAgICAg
cmV0dXJuIDE7CisgICAgfQorICAgIGQtPnVuaXRzW3VuaXRdLmJsb2NrU2l6ZSA9IENEX0RFVl9C
TE9DS19TSVpFOworICAgIGlmICghY2RfdXNiX2J1bGtfbXNkX3JlYWxpemUoZC0+bXNjLCB1bml0
LCAmZGV2X3BhcmFtcykpIHsKKyAgICAgICAgaWYgKG9wZW5fc3RyZWFtKCZkLT51bml0c1t1bml0
XSwgcGFyYW0tPmRldmljZV9wYXJhbS5jcmVhdGVfY2QuZmlsZW5hbWUpICYmCisgICAgICAgICAg
ICBsb2FkX2x1bihkLCB1bml0LCBUUlVFKSkgeworICAgICAgICAgICAgaWYgKGQtPmxvY2tlZCkg
eworICAgICAgICAgICAgICAgIGNkX3VzYl9idWxrX21zZF9sb2NrKGQtPm1zYywgdW5pdCwgVFJV
RSk7CisgICAgICAgICAgICB9CisgICAgICAgIH0gZWxzZSB7CisgICAgICAgICAgICBjbG9zZV9z
dHJlYW0oJmQtPnVuaXRzW3VuaXRdKTsKKyAgICAgICAgICAgIGNkX3VzYl9idWxrX21zZF91bnJl
YWxpemUoZC0+bXNjLCB1bml0KTsKKyAgICAgICAgICAgIHBhcmFtLT5lcnJvciA9IGdfZXJyb3Jf
bmV3KFNQSUNFX0NMSUVOVF9FUlJPUiwgU1BJQ0VfQ0xJRU5UX0VSUk9SX0ZBSUxFRCwKKyAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8oImNhbid0IGNyZWF0ZSBkZXZpY2Ug
d2l0aCAlcyIpLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW0t
PmRldmljZV9wYXJhbS5jcmVhdGVfY2QuZmlsZW5hbWUpOworICAgICAgICAgICAgZXJyb3IgPSAz
OworICAgICAgICB9CisgICAgfSBlbHNlIHsKKyAgICAgICAgZXJyb3IgPSAyOworICAgICAgICBw
YXJhbS0+ZXJyb3IgPSBnX2Vycm9yX25ldyhTUElDRV9DTElFTlRfRVJST1IsIFNQSUNFX0NMSUVO
VF9FUlJPUl9GQUlMRUQsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8oImNh
bid0IGFsbG9jYXRlIGRldmljZSIpKTsKKyAgICB9CisgICAgaWYgKGVycm9yKSB7CisgICAgICAg
IGdfY2xlYXJfcG9pbnRlcigmZC0+bXNjLCBjZF91c2JfYnVsa19tc2RfZnJlZSk7CisgICAgICAg
IGdfY2xlYXJfcG9pbnRlcigmZCwgZ19mcmVlKTsKKyAgICB9CisKKyAgICAqZGV2ID0gZDsKKyAg
ICByZXR1cm4gZXJyb3I7Cit9CisKK3ZvaWQgc3BpY2VfdXNiX2RldmljZV9yZWdpc3Rlcl9jZChT
cGljZVVzYkJhY2tlbmQgKmJlKQoreworICAgIHNwaWNlX3VzYl9iYWNrZW5kX3JlZ2lzdGVyX2Rl
dmljZV90eXBlKGJlLCBVU0JfREVWX1RZUEVfQ0QsIHVzYl9jZF9jcmVhdGUpOworfQorCisjZW5k
aWYgLyogVVNFX1VTQlJFRElSICovCi0tIAoyLjE3LjEKCl9fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fClNwaWNlLWRldmVsIG1haWxpbmcgbGlzdApTcGljZS1k
ZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcv
bWFpbG1hbi9saXN0aW5mby9zcGljZS1kZXZlbA==
