Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 461DFBC499
	for <lists+spice-devel@lfdr.de>; Tue, 24 Sep 2019 11:15:11 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 53C6589B78;
	Tue, 24 Sep 2019 09:15:09 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id C31BE89B60
 for <spice-devel@lists.freedesktop.org>; Tue, 24 Sep 2019 09:15:07 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx04.intmail.prod.int.phx2.redhat.com
 [10.5.11.14])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 69339306E171
 for <spice-devel@lists.freedesktop.org>; Tue, 24 Sep 2019 09:15:07 +0000 (UTC)
Received: from wingsuit.mxp.redhat.com (unknown [10.32.181.60])
 by smtp.corp.redhat.com (Postfix) with ESMTP id E556D5D9D5
 for <spice-devel@lists.freedesktop.org>; Tue, 24 Sep 2019 09:15:06 +0000 (UTC)
From: Victor Toso <victortoso@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Tue, 24 Sep 2019 11:15:01 +0200
Message-Id: <20190924091502.16038-6-victortoso@redhat.com>
In-Reply-To: <20190924091502.16038-1-victortoso@redhat.com>
References: <20190924091502.16038-1-victortoso@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.14
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.49]); Tue, 24 Sep 2019 09:15:07 +0000 (UTC)
Subject: [Spice-devel] [spice-gtk v1 5/6] channel-main: migration: set
 target session info early
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

RnJvbTogVmljdG9yIFRvc28gPG1lQHZpY3RvcnRvc28uY29tPgoKVGhlcmUgaXMgbm8gbmVlZCB0
byB3YWl0IHRpbGwgbWlncmF0ZV9jb25uZWN0KCkgYmVpbmcgY2FsbGVkIHRvIHNldAppbmZvcm1h
dGlvbiBhYm91dCB0YXJnZXQgaG9zdC4gV2UgY3JlYXRlIG5ldyBTcGljZVNlc3Npb24gYW5kIGNh
biBzZXQKcmVsYXRlZCBpbmZvIHNpbWlsYXIgcGxhY2UuCgpNb3ZlZCB0byBhIHV0aWxpdHkgZnVu
Y3Rpb24uClRoaXMgaXMgYSBwcmVwYXJhdG9yeSBwYXRjaCBvbiByZWZhY3RvcmluZyBtaWdyYXRp
b24gY29kZS4KClNpZ25lZC1vZmYtYnk6IFZpY3RvciBUb3NvIDx2aWN0b3J0b3NvQHJlZGhhdC5j
b20+Ci0tLQogc3JjL2NoYW5uZWwtbWFpbi5jIHwgNTYgKysrKysrKysrKysrKysrKysrKysrKysr
Ky0tLS0tLS0tLS0tLS0tLS0tLS0tLQogMSBmaWxlIGNoYW5nZWQsIDMxIGluc2VydGlvbnMoKyks
IDI1IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL3NyYy9jaGFubmVsLW1haW4uYyBiL3NyYy9j
aGFubmVsLW1haW4uYwppbmRleCAzZmU4ZDY0Li4zZGJhMzk5IDEwMDY0NAotLS0gYS9zcmMvY2hh
bm5lbC1tYWluLmMKKysrIGIvc3JjL2NoYW5uZWwtbWFpbi5jCkBAIC0yMjg0LDggKzIyODQsNiBA
QCBzdGF0aWMgZ2Jvb2xlYW4gbWlncmF0ZV9jb25uZWN0KGdwb2ludGVyIGRhdGEpCiB7CiAgICAg
c3BpY2VfbWlncmF0ZSAqbWlnID0gZGF0YTsKICAgICBTcGljZUNoYW5uZWxQcml2YXRlICAqYzsK
LSAgICBpbnQgcG9ydCwgc3BvcnQ7Ci0gICAgY29uc3QgY2hhciAqaG9zdDsKIAogICAgIGdfcmV0
dXJuX3ZhbF9pZl9mYWlsKG1pZyAhPSBOVUxMLCBGQUxTRSk7CiAgICAgZ19yZXR1cm5fdmFsX2lm
X2ZhaWwobWlnLT5pbmZvICE9IE5VTEwsIEZBTFNFKTsKQEAgLTIyOTksNDMgKzIyOTcsNDkgQEAg
c3RhdGljIGdib29sZWFuIG1pZ3JhdGVfY29ubmVjdChncG9pbnRlciBkYXRhKQogICAgIFNwaWNl
TWlncmF0aW9uRHN0SW5mbyAqaW5mbyA9IG1pZy0+aW5mbzsKICAgICBTUElDRV9ERUJVRygibWln
cmF0ZV9iZWdpbiAldSAlcyAlZCAlZCIsCiAgICAgICAgICAgICAgICAgaW5mby0+aG9zdF9zaXpl
LCBpbmZvLT5ob3N0X2RhdGEsIGluZm8tPnBvcnQsIGluZm8tPnNwb3J0KTsKLSAgICBwb3J0ID0g
aW5mby0+cG9ydDsKLSAgICBzcG9ydCA9IGluZm8tPnNwb3J0OwotICAgIGhvc3QgPSAoY2hhciop
aW5mby0+aG9zdF9kYXRhOworCisgICAgZ19zaWduYWxfY29ubmVjdChtaWctPnNlc3Npb24sICJj
aGFubmVsLW5ldyIsCisgICAgICAgICAgICAgICAgICAgICBHX0NBTExCQUNLKG1pZ3JhdGVfY2hh
bm5lbF9uZXdfY2IpLCBtaWcpOworCisgICAgZ19zaWduYWxfZW1pdChtaWctPnNyY19jaGFubmVs
LCBzaWduYWxzW1NQSUNFX01JR1JBVElPTl9TVEFSVEVEXSwgMCwKKyAgICAgICAgICAgICAgICAg
IG1pZy0+c2Vzc2lvbik7CisKKyAgICAvKiB0aGUgbWlncmF0aW9uIHByb2Nlc3MgaXMgaW4gMiBz
dGVwcywgZmlyc3QgdGhlIG1haW4gY2hhbm5lbCBhbmQKKyAgICAgICB0aGVuIHRoZSByZXN0IG9m
IHRoZSBjaGFubmVscyAqLworICAgIG1pZ3JhdGVfY2hhbm5lbF9jb25uZWN0KG1pZywgU1BJQ0Vf
Q0hBTk5FTF9NQUlOLCAwKTsKKworICAgIHJldHVybiBGQUxTRTsKK30KKworc3RhdGljIHZvaWQK
K21pZ3JhdGlvbl9zZXNzaW9uX3NldF9kZXN0aW5hdGlvbl9pbmZvKFNwaWNlU2Vzc2lvbiAqdGFy
Z2V0X3Nlc3Npb24sCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTcGlj
ZU1pZ3JhdGlvbkRzdEluZm8gKmluZm8pCit7CisgICAgY29uc3QgY2hhciAqaG9zdCA9IChjb25z
dCBjaGFyICopIGluZm8tPmhvc3RfZGF0YTsKKworICAgIGlmIChnX2dldGVudigiU1BJQ0VfTUlH
X0hPU1QiKSkgeworICAgICAgICBob3N0ID0gZ19nZXRlbnYoIlNQSUNFX01JR19IT1NUIik7Cisg
ICAgfQorCisgICAgZ19vYmplY3Rfc2V0KHRhcmdldF9zZXNzaW9uLCAiaG9zdCIsIGhvc3QsIE5V
TEwpOworICAgIHNwaWNlX3Nlc3Npb25fc2V0X3BvcnQodGFyZ2V0X3Nlc3Npb24sIGluZm8tPnBv
cnQsIEZBTFNFKTsKKyAgICBzcGljZV9zZXNzaW9uX3NldF9wb3J0KHRhcmdldF9zZXNzaW9uLCBp
bmZvLT5zcG9ydCwgVFJVRSk7CiAKICAgICBpZiAoaW5mby0+Y2VydF9zdWJqZWN0X3NpemUgPT0g
MCB8fAogICAgICAgICAgICAgICAgc3RybGVuKChjb25zdCBjaGFyKilpbmZvLT5jZXJ0X3N1Ympl
Y3RfZGF0YSkgPT0gMCkgewogICAgICAgICAvKiBvbmx5IHZlcmlmeSBob3N0bmFtZSBpZiBubyBj
ZXJ0IHN1YmplY3QgKi8KLSAgICAgICAgZ19vYmplY3Rfc2V0KG1pZy0+c2Vzc2lvbiwgInZlcmlm
eSIsIFNQSUNFX1NFU1NJT05fVkVSSUZZX0hPU1ROQU1FLCBOVUxMKTsKKyAgICAgICAgZ19vYmpl
Y3Rfc2V0KHRhcmdldF9zZXNzaW9uLCAidmVyaWZ5IiwgU1BJQ0VfU0VTU0lPTl9WRVJJRllfSE9T
VE5BTUUsIE5VTEwpOwogICAgIH0gZWxzZSB7CiAgICAgICAgIGdjaGFyICpzdWJqZWN0ID0gZ19h
bGxvY2EoaW5mby0+Y2VydF9zdWJqZWN0X3NpemUgKyAxKTsKICAgICAgICAgc3RybmNweShzdWJq
ZWN0LCAoY29uc3QgY2hhciopaW5mby0+Y2VydF9zdWJqZWN0X2RhdGEsIGluZm8tPmNlcnRfc3Vi
amVjdF9zaXplKTsKICAgICAgICAgc3ViamVjdFtpbmZvLT5jZXJ0X3N1YmplY3Rfc2l6ZV0gPSAn
XDAnOwogCiAgICAgICAgIC8vIHNlc3Npb24gZGF0YSBhcmUgYWxyZWFkeSBjb3BpZWQKLSAgICAg
ICAgZ19vYmplY3Rfc2V0KG1pZy0+c2Vzc2lvbiwKKyAgICAgICAgZ19vYmplY3Rfc2V0KHRhcmdl
dF9zZXNzaW9uLAogICAgICAgICAgICAgICAgICAgICAgImNlcnQtc3ViamVjdCIsIHN1YmplY3Qs
CiAgICAgICAgICAgICAgICAgICAgICAidmVyaWZ5IiwgU1BJQ0VfU0VTU0lPTl9WRVJJRllfU1VC
SkVDVCwKICAgICAgICAgICAgICAgICAgICAgIE5VTEwpOwogICAgIH0KLQotICAgIGlmIChnX2dl
dGVudigiU1BJQ0VfTUlHX0hPU1QiKSkKLSAgICAgICAgaG9zdCA9IGdfZ2V0ZW52KCJTUElDRV9N
SUdfSE9TVCIpOwotCi0gICAgZ19vYmplY3Rfc2V0KG1pZy0+c2Vzc2lvbiwgImhvc3QiLCBob3N0
LCBOVUxMKTsKLSAgICBzcGljZV9zZXNzaW9uX3NldF9wb3J0KG1pZy0+c2Vzc2lvbiwgcG9ydCwg
RkFMU0UpOwotICAgIHNwaWNlX3Nlc3Npb25fc2V0X3BvcnQobWlnLT5zZXNzaW9uLCBzcG9ydCwg
VFJVRSk7Ci0gICAgZ19zaWduYWxfY29ubmVjdChtaWctPnNlc3Npb24sICJjaGFubmVsLW5ldyIs
Ci0gICAgICAgICAgICAgICAgICAgICBHX0NBTExCQUNLKG1pZ3JhdGVfY2hhbm5lbF9uZXdfY2Ip
LCBtaWcpOwotCi0gICAgZ19zaWduYWxfZW1pdChtaWctPnNyY19jaGFubmVsLCBzaWduYWxzW1NQ
SUNFX01JR1JBVElPTl9TVEFSVEVEXSwgMCwKLSAgICAgICAgICAgICAgICAgIG1pZy0+c2Vzc2lv
bik7Ci0KLSAgICAvKiB0aGUgbWlncmF0aW9uIHByb2Nlc3MgaXMgaW4gMiBzdGVwcywgZmlyc3Qg
dGhlIG1haW4gY2hhbm5lbCBhbmQKLSAgICAgICB0aGVuIHRoZSByZXN0IG9mIHRoZSBjaGFubmVs
cyAqLwotICAgIG1pZ3JhdGVfY2hhbm5lbF9jb25uZWN0KG1pZywgU1BJQ0VfQ0hBTk5FTF9NQUlO
LCAwKTsKLQotICAgIHJldHVybiBGQUxTRTsKIH0KIAogLyogY29yb3V0aW5lIGNvbnRleHQgKi8K
QEAgLTIzNjMsNiArMjM2Nyw4IEBAIHN0YXRpYyB2b2lkIG1haW5fbWlncmF0ZV9jb25uZWN0KFNw
aWNlQ2hhbm5lbCAqY2hhbm5lbCwKICAgICAgICAgZ290byBlbmQ7CiAgICAgfQogCisgICAgbWln
cmF0aW9uX3Nlc3Npb25fc2V0X2Rlc3RpbmF0aW9uX2luZm8obWlnLnNlc3Npb24sIGRzdF9pbmZv
KTsKKwogICAgIG1haW5fcHJpdi0+bWlncmF0ZV9kYXRhID0gJm1pZzsKIAogICAgIC8qIG5vIG5l
ZWQgdG8gdHJhY2sgaWRsZSwgY2FsbCBpcyBzeW5jIGZvciB0aGlzIGNvcm91dGluZSAqLwotLSAK
Mi4yMS4wCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpT
cGljZS1kZXZlbCBtYWlsaW5nIGxpc3QKU3BpY2UtZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3Jn
Cmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vc3BpY2UtZGV2
ZWw=
