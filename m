Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 0274455426
	for <lists+spice-devel@lfdr.de>; Tue, 25 Jun 2019 18:12:18 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 2711E6E185;
	Tue, 25 Jun 2019 16:12:16 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 99D126E17D
 for <spice-devel@lists.freedesktop.org>; Tue, 25 Jun 2019 16:12:14 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx05.intmail.prod.int.phx2.redhat.com
 [10.5.11.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 46AF62E95B9
 for <spice-devel@lists.freedesktop.org>; Tue, 25 Jun 2019 16:12:14 +0000 (UTC)
Received: from fziglio.remote.csb (unknown [10.33.32.4])
 by smtp.corp.redhat.com (Postfix) with ESMTP id 651CC5D70D;
 Tue, 25 Jun 2019 16:12:12 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Tue, 25 Jun 2019 17:11:40 +0100
Message-Id: <20190625161147.25211-17-fziglio@redhat.com>
In-Reply-To: <20190625161147.25211-1-fziglio@redhat.com>
References: <20190625161147.25211-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.15
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.29]); Tue, 25 Jun 2019 16:12:14 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-server 16/23] websocket: Handle case if
 server cannot write the header entirely
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

UXVpdGUgcmFyZSBjYXNlLCBjYW4gb25seSBoYXBwZW4gd2l0aCBjb25nZXN0aW9uLCBidWZmZXJz
IHZlcnkgbG93CmFuZCBzb21lIHNwYWNlIGxlZnQgaW4gdGhlIGZvcm1lciBwYWNrZXQuCgpTaWdu
ZWQtb2ZmLWJ5OiBGcmVkaWFubyBaaWdsaW8gPGZ6aWdsaW9AcmVkaGF0LmNvbT4KLS0tCiBzZXJ2
ZXIvd2Vic29ja2V0LmMgfCA3OCArKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKy0tLS0t
LS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgNTUgaW5zZXJ0aW9ucygrKSwgMjMgZGVsZXRpb25z
KC0pCgpkaWZmIC0tZ2l0IGEvc2VydmVyL3dlYnNvY2tldC5jIGIvc2VydmVyL3dlYnNvY2tldC5j
CmluZGV4IDk2YzZmY2UxZi4uOWZkNWZkZTUzIDEwMDY0NAotLS0gYS9zZXJ2ZXIvd2Vic29ja2V0
LmMKKysrIGIvc2VydmVyL3dlYnNvY2tldC5jCkBAIC04Myw2ICs4Myw4IEBAIHN0cnVjdCBSZWRz
V2ViU29ja2V0IHsKIAogICAgIHdlYnNvY2tldF9mcmFtZV90IHJlYWRfZnJhbWU7CiAgICAgdWlu
dDY0X3Qgd3JpdGVfcmVtYWluZGVyOworICAgIHVpbnQ4X3Qgd3JpdGVfaGVhZGVyW1dFQlNPQ0tF
VF9NQVhfSEVBREVSX1NJWkVdOworICAgIHVpbnQ4X3Qgd3JpdGVfaGVhZGVyX3Bvcywgd3JpdGVf
aGVhZGVyX2xlbjsKIAogICAgIHZvaWQgKnJhd19zdHJlYW07CiAgICAgd2Vic29ja2V0X3JlYWRf
Y2JfdCByYXdfcmVhZDsKQEAgLTM5MSwyMiArMzkzLDU5IEBAIHN0YXRpYyB2b2lkIGNvbnN0cmFp
bl9pb3Yoc3RydWN0IGlvdmVjICppb3YsIGludCBpb3ZjbnQsCiAgICAgKmlvdl9vdXQgPSBpb3Y7
CiB9CiAKK3N0YXRpYyBpbnQgc2VuZF9kYXRhX2hlYWRlcl9sZWZ0KFJlZHNXZWJTb2NrZXQgKndz
KQoreworICAgIC8qIHNlbmQgdGhlIHBlbmRpbmcgaGVhZGVyICovCisgICAgLyogdGhpcyBjYW4g
YmUgdGVzdGVkIGNhcHBpbmcgdGhlIGxlbmd0aCB3aXRoIE1JTiB3aXRoIGEgc21hbGwgc2l6ZSBs
aWtlIDMgKi8KKyAgICBpbnQgcmMgPSB3cy0+cmF3X3dyaXRlKHdzLT5yYXdfc3RyZWFtLCB3cy0+
d3JpdGVfaGVhZGVyICsgd3MtPndyaXRlX2hlYWRlcl9wb3MsCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICB3cy0+d3JpdGVfaGVhZGVyX2xlbiAtIHdzLT53cml0ZV9oZWFkZXJfcG9zKTsKKyAg
ICBpZiAocmMgPD0gMCkgeworICAgICAgICByZXR1cm4gcmM7CisgICAgfQorICAgIHdzLT53cml0
ZV9oZWFkZXJfcG9zICs9IHJjOworCisgICAgLyogaWYgaGVhZGVyIHdhcyBzZW50IG5vdyB3ZSBj
YW4gc2VuZCBkYXRhICovCisgICAgaWYgKHdzLT53cml0ZV9oZWFkZXJfcG9zID49IHdzLT53cml0
ZV9oZWFkZXJfbGVuKSB7CisgICAgICAgIGludCB1c2VkID0gMTsKKyAgICAgICAgd3MtPndyaXRl
X3JlbWFpbmRlciA9IGV4dHJhY3RfbGVuZ3RoKHdzLT53cml0ZV9oZWFkZXIgKyB1c2VkLCAmdXNl
ZCk7CisgICAgICAgIHJldHVybiB3cy0+d3JpdGVfaGVhZGVyX2xlbjsKKyAgICB9CisKKyAgICAv
KiBvdGhlcndpc2UgdHJ5IHRvIHNlbmQgdGhlIHJlc3QgbGF0ZXIgKi8KKyAgICBlcnJubyA9IEVB
R0FJTjsKKyAgICByZXR1cm4gLTE7Cit9CisKK3N0YXRpYyBpbnQgc2VuZF9kYXRhX2hlYWRlcihS
ZWRzV2ViU29ja2V0ICp3cywgdWludDY0X3QgbGVuKQoreworICAgIC8qIGlmIHdlIGRvbid0IGhh
dmUgYSBwZW5kaW5nIGhlYWRlciBmaWxsIGl0ICovCisgICAgaWYgKHdzLT53cml0ZV9oZWFkZXJf
cG9zID49IHdzLT53cml0ZV9oZWFkZXJfbGVuKSB7CisgICAgICAgIHdzLT53cml0ZV9oZWFkZXJf
cG9zID0gMDsKKyAgICAgICAgd3MtPndyaXRlX2hlYWRlcl9sZW4gPSBmaWxsX2hlYWRlcih3cy0+
d3JpdGVfaGVhZGVyLCBsZW4pOworICAgIH0KKworICAgIHJldHVybiBzZW5kX2RhdGFfaGVhZGVy
X2xlZnQod3MpOworfQogCiAvKiBXcml0ZSBhIFdlYlNvY2tldCBmcmFtZSB3aXRoIHRoZSBlbmNs
b3NlZCBkYXRhIG91dC4gKi8KIGludCB3ZWJzb2NrZXRfd3JpdGV2KFJlZHNXZWJTb2NrZXQgKndz
LCBjb25zdCBzdHJ1Y3QgaW92ZWMgKmlvdiwgaW50IGlvdmNudCkKIHsKLSAgICB1aW50OF90IGhl
YWRlcltXRUJTT0NLRVRfTUFYX0hFQURFUl9TSVpFXTsKICAgICB1aW50NjRfdCBsZW47Ci0gICAg
aW50IHJjID0gLTE7CisgICAgaW50IHJjOwogICAgIHN0cnVjdCBpb3ZlYyAqaW92X291dDsKICAg
ICBpbnQgaW92X291dF9jbnQ7CiAgICAgaW50IGk7Ci0gICAgaW50IGhlYWRlcl9sZW47CiAKICAg
ICBpZiAod3MtPmNsb3NlZCkgewogICAgICAgICBlcnJubyA9IEVQSVBFOwogICAgICAgICByZXR1
cm4gLTE7CiAgICAgfQorICAgIGlmICh3cy0+d3JpdGVfaGVhZGVyX3BvcyA8IHdzLT53cml0ZV9o
ZWFkZXJfbGVuKSB7CisgICAgICAgIHJjID0gc2VuZF9kYXRhX2hlYWRlcl9sZWZ0KHdzKTsKKyAg
ICAgICAgaWYgKHJjIDw9IDApIHsKKyAgICAgICAgICAgIHJldHVybiByYzsKKyAgICAgICAgfQor
ICAgIH0KICAgICBpZiAod3MtPndyaXRlX3JlbWFpbmRlciA+IDApIHsKICAgICAgICAgY29uc3Ry
YWluX2lvdigoc3RydWN0IGlvdmVjICopIGlvdiwgaW92Y250LCAmaW92X291dCwgJmlvdl9vdXRf
Y250LCB3cy0+d3JpdGVfcmVtYWluZGVyKTsKICAgICAgICAgcmMgPSB3cy0+cmF3X3dyaXRldih3
cy0+cmF3X3N0cmVhbSwgaW92X291dCwgaW92X291dF9jbnQpOwpAQCAtNDI4LDIzICs0NjcsMjUg
QEAgaW50IHdlYnNvY2tldF93cml0ZXYoUmVkc1dlYlNvY2tldCAqd3MsIGNvbnN0IHN0cnVjdCBp
b3ZlYyAqaW92LCBpbnQgaW92Y250KQogICAgICAgICBpb3Zfb3V0W2kgKyAxXSA9IGlvdltpXTsK
ICAgICB9CiAKLSAgICBtZW1zZXQoaGVhZGVyLCAwLCBzaXplb2YoaGVhZGVyKSk7Ci0gICAgaGVh
ZGVyX2xlbiA9IGZpbGxfaGVhZGVyKGhlYWRlciwgbGVuKTsKLSAgICBpb3Zfb3V0WzBdLmlvdl9s
ZW4gPSBoZWFkZXJfbGVuOwotICAgIGlvdl9vdXRbMF0uaW92X2Jhc2UgPSBoZWFkZXI7CisgICAg
d3MtPndyaXRlX2hlYWRlcl9wb3MgPSAwOworICAgIHdzLT53cml0ZV9oZWFkZXJfbGVuID0gZmls
bF9oZWFkZXIod3MtPndyaXRlX2hlYWRlciwgbGVuKTsKKyAgICBpb3Zfb3V0WzBdLmlvdl9sZW4g
PSB3cy0+d3JpdGVfaGVhZGVyX2xlbjsKKyAgICBpb3Zfb3V0WzBdLmlvdl9iYXNlID0gd3MtPndy
aXRlX2hlYWRlcjsKICAgICByYyA9IHdzLT5yYXdfd3JpdGV2KHdzLT5yYXdfc3RyZWFtLCBpb3Zf
b3V0LCBpb3Zfb3V0X2NudCk7CiAgICAgZ19mcmVlKGlvdl9vdXQpOwogICAgIGlmIChyYyA8PSAw
KSB7CisgICAgICAgIHdzLT53cml0ZV9oZWFkZXJfbGVuID0gMDsKICAgICAgICAgcmV0dXJuIHJj
OwogICAgIH0KLSAgICByYyAtPSBoZWFkZXJfbGVuOwogCi0gICAgLyogVE9ETyB0aGlzIGluIHRo
ZW9yeSBjYW4gaGFwcGVuIGlmIHdlIGNhbid0IHdyaXRlIHRoZSBoZWFkZXIgKi8KLSAgICBpZiAo
U1BJQ0VfVU5MSUtFTFkocmMgPCAwKSkgewotICAgICAgICB3cy0+Y2xvc2VkID0gdHJ1ZTsKLSAg
ICAgICAgZXJybm8gPSBFUElQRTsKKyAgICAvKiB0aGlzIGNhbiBoYXBwZW4gaWYgd2UgY2FuJ3Qg
d3JpdGUgdGhlIGhlYWRlciAqLworICAgIGlmIChTUElDRV9VTkxJS0VMWShyYyA8IHdzLT53cml0
ZV9oZWFkZXJfbGVuKSkgeworICAgICAgICB3cy0+d3JpdGVfaGVhZGVyX3BvcyA9IHdzLT53cml0
ZV9oZWFkZXJfbGVuIC0gcmM7CisgICAgICAgIGVycm5vID0gRUFHQUlOOwogICAgICAgICByZXR1
cm4gLTE7CiAgICAgfQorICAgIHdzLT53cml0ZV9oZWFkZXJfcG9zID0gd3MtPndyaXRlX2hlYWRl
cl9sZW47CisgICAgcmMgLT0gd3MtPndyaXRlX2hlYWRlcl9sZW47CiAKICAgICAvKiBLZXkgcG9p
bnQ6ICBpZiB3ZSBkaWQgbm90IHdyaXRlIG91dCBhbGwgdGhlIGRhdGEsIHJlbWVtYmVyIGhvdwog
ICAgICAgIG11Y2ggbW9yZSBkYXRhIHRoZSBjbGllbnQgaXMgZXhwZWN0aW5nLCBhbmQgd3JpdGUg
dGhhdCBkYXRhIHdpdGhvdXQKQEAgLTQ1Niw5ICs0OTcsNyBAQCBpbnQgd2Vic29ja2V0X3dyaXRl
dihSZWRzV2ViU29ja2V0ICp3cywgY29uc3Qgc3RydWN0IGlvdmVjICppb3YsIGludCBpb3ZjbnQp
CiAKIGludCB3ZWJzb2NrZXRfd3JpdGUoUmVkc1dlYlNvY2tldCAqd3MsIGNvbnN0IHZvaWQgKmJ1
Ziwgc2l6ZV90IGxlbikKIHsKLSAgICB1aW50OF90IGhlYWRlcltXRUJTT0NLRVRfTUFYX0hFQURF
Ul9TSVpFXTsKICAgICBpbnQgcmM7Ci0gICAgaW50IGhlYWRlcl9sZW47CiAKICAgICBpZiAod3Mt
PmNsb3NlZCkgewogICAgICAgICBlcnJubyA9IEVQSVBFOwpAQCAtNDY2LDE4ICs1MDUsMTEgQEAg
aW50IHdlYnNvY2tldF93cml0ZShSZWRzV2ViU29ja2V0ICp3cywgY29uc3Qgdm9pZCAqYnVmLCBz
aXplX3QgbGVuKQogICAgIH0KIAogICAgIGlmICh3cy0+d3JpdGVfcmVtYWluZGVyID09IDApIHsK
LSAgICAgICAgaGVhZGVyX2xlbiA9IGZpbGxfaGVhZGVyKGhlYWRlciwgbGVuKTsKLSAgICAgICAg
cmMgPSB3cy0+cmF3X3dyaXRlKHdzLT5yYXdfc3RyZWFtLCBoZWFkZXIsIGhlYWRlcl9sZW4pOwor
ICAgICAgICByYyA9IHNlbmRfZGF0YV9oZWFkZXIod3MsIGxlbik7CiAgICAgICAgIGlmIChyYyA8
PSAwKSB7CiAgICAgICAgICAgICByZXR1cm4gcmM7CiAgICAgICAgIH0KLSAgICAgICAgaWYgKHJj
ICE9IGhlYWRlcl9sZW4pIHsKLSAgICAgICAgICAgIC8qIFRPRE8gLSBJbiB0aGVvcnksIHdlIGNh
biBoYW5kbGUgdGhpcyBjYXNlLiAgSW4gcHJhY3RpY2UsCi0gICAgICAgICAgICAgICAgICAgICAg
aXQgZG9lcyBub3Qgb2NjdXIsIGFuZCBkb2VzIG5vdCBzZWVtIHRvIGJlIHdvcnRoCi0gICAgICAg
ICAgICAgICAgICAgICAgdGhlIGNvZGUgY29tcGxleGl0eSAqLwotICAgICAgICAgICAgZXJybm8g
PSBFUElQRTsKLSAgICAgICAgICAgIHJldHVybiAtMTsKLSAgICAgICAgfQorICAgICAgICBsZW4g
PSB3cy0+d3JpdGVfcmVtYWluZGVyOwogICAgIH0gZWxzZSB7CiAgICAgICAgIGxlbiA9IE1JTih3
cy0+d3JpdGVfcmVtYWluZGVyLCBsZW4pOwogICAgIH0KLS0gCjIuMjAuMQoKX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KU3BpY2UtZGV2ZWwgbWFpbGluZyBs
aXN0ClNwaWNlLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVk
ZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL3NwaWNlLWRldmVs
