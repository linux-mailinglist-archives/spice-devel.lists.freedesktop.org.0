Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id D82819E408
	for <lists+spice-devel@lfdr.de>; Tue, 27 Aug 2019 11:24:03 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 64B968991C;
	Tue, 27 Aug 2019 09:24:02 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 6CC998991C
 for <spice-devel@lists.freedesktop.org>; Tue, 27 Aug 2019 09:24:00 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx04.intmail.prod.int.phx2.redhat.com
 [10.5.11.14])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 1A5733083363
 for <spice-devel@lists.freedesktop.org>; Tue, 27 Aug 2019 09:24:00 +0000 (UTC)
Received: from fziglio.remote.csb (ovpn-204-114.brq.redhat.com [10.40.204.114])
 by smtp.corp.redhat.com (Postfix) with ESMTP id 652DB5D9CC;
 Tue, 27 Aug 2019 09:23:58 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Tue, 27 Aug 2019 10:22:41 +0100
Message-Id: <20190827092246.10276-25-fziglio@redhat.com>
In-Reply-To: <20190827092246.10276-1-fziglio@redhat.com>
References: <20190827092246.10276-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.14
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.44]); Tue, 27 Aug 2019 09:24:00 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-gtk v4 24/29] usb-backend: Rewrite USB
 emulation support
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

TWFrZSBpbml0aWFsaXNhdGlvbiBlYXNpZXIuCkFsd2F5cyBpbml0aWFsaXNlIHBhcnNlci4KSW5p
dGlhbGlzZSBib3RoIHBhcnNlciBhbmQgaG9zdCBkdXJpbmcgc3BpY2VfdXNiX2JhY2tlbmRfY2hh
bm5lbF9uZXcuClN1cHBvcnQgbm90IGhhdmluZyBsaWJ1c2IgY29udGV4dCAobm8gcGh5c2ljYWwg
ZGV2aWNlcykuCkF2b2lkcyB0b28gbXVjaCBzdGF0ZSB2YXJpYWJsZXMuCnBhcnNlciBpcyBhbHdh
eXMgaW5pdGlhbGlzZWQgYWZ0ZXIgY3JlYXRpb24gbWFraW5nIHN1cmUgdGhlIHN0YXRlCmlzIGNv
bnNpc3RlbnQuClVzZSBhIHNpbmdsZSBzdGF0ZSB2YXJpYWJsZSwgZGF0YSBmbG93cyBpbnRvL2Zy
b20gYSBzaW5nbGUgcGFyc2VyLgoKU2lnbmVkLW9mZi1ieTogRnJlZGlhbm8gWmlnbGlvIDxmemln
bGlvQHJlZGhhdC5jb20+Ci0tLQogc3JjL3VzYi1iYWNrZW5kLmMgfCAyMzYgKysrKysrKysrKysr
KysrKysrKysrKystLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogMSBmaWxlIGNoYW5nZWQsIDExNiBp
bnNlcnRpb25zKCspLCAxMjAgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvc3JjL3VzYi1iYWNr
ZW5kLmMgYi9zcmMvdXNiLWJhY2tlbmQuYwppbmRleCAzNmE3M2E4OS4uZDYxNGU2OTMgMTAwNjQ0
Ci0tLSBhL3NyYy91c2ItYmFja2VuZC5jCisrKyBiL3NyYy91c2ItYmFja2VuZC5jCkBAIC03OCwy
MSArNzgsMjEgQEAgc3RydWN0IF9TcGljZVVzYkJhY2tlbmQKICAgICB1aW50MzJfdCBvd25fZGV2
aWNlc19tYXNrOwogfTsKIAordHlwZWRlZiBlbnVtIHsKKyAgICBVU0JfQ0hBTk5FTF9TVEFURV9J
TklUSUFMSVpJTkcsCisgICAgVVNCX0NIQU5ORUxfU1RBVEVfSE9TVCwKKyAgICBVU0JfQ0hBTk5F
TF9TVEFURV9QQVJTRVIsCit9IFNwaWNlVXNiQmFja2VuZENoYW5uZWxTdGF0ZTsKKwogc3RydWN0
IF9TcGljZVVzYkJhY2tlbmRDaGFubmVsCiB7CiAgICAgc3RydWN0IHVzYnJlZGlyaG9zdCAqdXNi
cmVkaXJob3N0OwotICAgIHN0cnVjdCB1c2JyZWRpcmhvc3QgKmhpZGRlbl9ob3N0OwogICAgIHN0
cnVjdCB1c2JyZWRpcnBhcnNlciAqcGFyc2VyOwotICAgIHN0cnVjdCB1c2JyZWRpcnBhcnNlciAq
aGlkZGVuX3BhcnNlcjsKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsU3RhdGUgc3RhdGU7CiAg
ICAgdWludDhfdCAqcmVhZF9idWY7CiAgICAgaW50IHJlYWRfYnVmX3NpemU7CiAgICAgc3RydWN0
IHVzYnJlZGlyZmlsdGVyX3J1bGUgKnJ1bGVzOwogICAgIGludCBydWxlc19jb3VudDsKLSAgICB1
aW50MzJfdCBob3N0X2NhcHM7Ci0gICAgdWludDMyX3QgcGFyc2VyX2luaXRfZG9uZSAgOiAxOwot
ICAgIHVpbnQzMl90IHBhcnNlcl93aXRoX2hlbGxvIDogMTsKLSAgICB1aW50MzJfdCBoZWxsb19k
b25lX3BhcnNlciA6IDE7Ci0gICAgdWludDMyX3QgaGVsbG9fc2VudCAgICAgICAgOiAxOwogICAg
IHVpbnQzMl90IHJlamVjdGVkICAgICAgICAgIDogMTsKICAgICB1aW50MzJfdCB3YWl0X2Rpc2Nv
bm5lY3RfYWNrIDogMTsKICAgICBTcGljZVVzYkJhY2tlbmREZXZpY2UgKmF0dGFjaGVkOwpAQCAt
NDA1LDE1ICs0MDUsMTYgQEAgZnJvbSBib3RoIHRoZSBtYWluIHRocmVhZCBhcyB3ZWxsIGFzIGZy
b20gdGhlIHVzYiBldmVudCBoYW5kbGluZyB0aHJlYWQgKi8KIHN0YXRpYyB2b2lkIHVzYnJlZGly
X3dyaXRlX2ZsdXNoX2NhbGxiYWNrKHZvaWQgKnVzZXJfZGF0YSkKIHsKICAgICBTcGljZVVzYkJh
Y2tlbmRDaGFubmVsICpjaCA9IHVzZXJfZGF0YTsKKyAgICBpZiAoY2gtPnBhcnNlciA9PSBOVUxM
KSB7CisgICAgICAgIHJldHVybjsKKyAgICB9CiAgICAgaWYgKGlzX2NoYW5uZWxfcmVhZHkoY2gt
PnVzZXJfZGF0YSkpIHsKLSAgICAgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKKyAgICAgICAg
aWYgKGNoLT5zdGF0ZSA9PSBVU0JfQ0hBTk5FTF9TVEFURV9IT1NUKSB7CiAgICAgICAgICAgICBT
UElDRV9ERUJVRygiJXMgY2ggJXAgLT4gdXNicmVkaXJob3N0IiwgX19GVU5DVElPTl9fLCBjaCk7
CiAgICAgICAgICAgICB1c2JyZWRpcmhvc3Rfd3JpdGVfZ3Vlc3RfZGF0YShjaC0+dXNicmVkaXJo
b3N0KTsKLSAgICAgICAgfSBlbHNlIGlmIChjaC0+cGFyc2VyKSB7CisgICAgICAgIH0gZWxzZSB7
CiAgICAgICAgICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAgLT4gcGFyc2VyIiwgX19GVU5DVElP
Tl9fLCBjaCk7CiAgICAgICAgICAgICB1c2JyZWRpcnBhcnNlcl9kb193cml0ZShjaC0+cGFyc2Vy
KTsKLSAgICAgICAgfSBlbHNlIHsKLSAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAo
Tk9UIEFDVElWRSkiLCBfX0ZVTkNUSU9OX18sIGNoKTsKICAgICAgICAgfQogICAgIH0gZWxzZSB7
CiAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAobm90IHJlYWR5KSIsIF9fRlVOQ1RJT05f
XywgY2gpOwpAQCAtNjczLDIxICs2NzQsNDIgQEAgc3RhdGljIHZvaWQgdXNicmVkaXJfbG9nKHZv
aWQgKnVzZXJfZGF0YSwgaW50IGxldmVsLCBjb25zdCBjaGFyICptc2cpCiAgICAgfQogfQogCitz
dGF0aWMgc3RydWN0IHVzYnJlZGlycGFyc2VyICpjcmVhdGVfcGFyc2VyKFNwaWNlVXNiQmFja2Vu
ZENoYW5uZWwgKmNoKTsKKwogc3RhdGljIGludCB1c2JyZWRpcl93cml0ZV9jYWxsYmFjayh2b2lk
ICp1c2VyX2RhdGEsIHVpbnQ4X3QgKmRhdGEsIGludCBjb3VudCkKIHsKICAgICBTcGljZVVzYkJh
Y2tlbmRDaGFubmVsICpjaCA9IHVzZXJfZGF0YTsKICAgICBpbnQgcmVzOwogICAgIFNQSUNFX0RF
QlVHKCIlcyBjaCAlcCwgJWQgYnl0ZXMiLCBfX0ZVTkNUSU9OX18sIGNoLCBjb3VudCk7Ci0gICAg
aWYgKCFjaC0+aGVsbG9fc2VudCkgewotICAgICAgICAvKiBoZWxsbyBpcyBzaG9ydCBoZWFkZXIg
KDEyKSArIGhlbGxvIHN0cnVjdCAoNjQpICsgY2FwYWJpbGl0aWVzICg0KSAqLwotICAgICAgICBp
bnQgaGVsbG9fc2l6ZSA9IHNpemVvZihzdHJ1Y3QgdXNiX3JlZGlyX2hlYWRlcikgKyBzaXplb2Yo
c3RydWN0IHVzYl9yZWRpcl9oZWxsb19oZWFkZXIpOwotICAgICAgICBjaC0+aGVsbG9fc2VudCA9
IDE7Ci0gICAgICAgIGlmIChjb3VudCA9PSBoZWxsb19zaXplKSB7Ci0gICAgICAgICAgICBtZW1j
cHkoJmNoLT5ob3N0X2NhcHMsIGRhdGEgKyBoZWxsb19zaXplIC0gc2l6ZW9mKGNoLT5ob3N0X2Nh
cHMpLAotICAgICAgICAgICAgICAgICAgIHNpemVvZihjaC0+aG9zdF9jYXBzKSk7Ci0gICAgICAg
ICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAsIHNlbmRpbmcgZmlyc3QgaGVsbG8sIGNhcHMgJTA4
WCIsCi0gICAgICAgICAgICAgICAgICAgICAgICBfX0ZVTkNUSU9OX18sIGNoLCBjaC0+aG9zdF9j
YXBzKTsKKworICAgIC8vIGhhbmRsZSBmaXJzdCBwYWNrZXQgKEhFTExPKSBjcmVhdGluZyBwYXJz
ZXIgZnJvbSBjYXBhYmlsaXRpZXMKKyAgICBpZiAoU1BJQ0VfVU5MSUtFTFkoY2gtPnBhcnNlciA9
PSBOVUxMKSkgeworICAgICAgICAvLyB3ZSBhcmUgc3RpbGwgaW5pdGlhbGl6aW5nIHRoZSBob3N0
CisgICAgICAgIGlmIChjaC0+dXNicmVkaXJob3N0ID09IE5VTEwpIHsKKyAgICAgICAgICAgIHJl
dHVybiAwOwogICAgICAgICB9CisKKyAgICAgICAgY2gtPnBhcnNlciA9IGNyZWF0ZV9wYXJzZXIo
Y2gpOworICAgICAgICBpZiAoIWNoLT5wYXJzZXIpIHsKKyAgICAgICAgICAgIHJldHVybiAwOwor
ICAgICAgICB9CisKKyAgICAgICAgLyogaGVsbG8gaXMgc2hvcnQgaGVhZGVyICgxMikgKyBoZWxs
byBzdHJ1Y3QgKDY0KSAqLworICAgICAgICBjb25zdCBpbnQgaGVsbG9fc2l6ZSA9IDEyICsgc2l6
ZW9mKHN0cnVjdCB1c2JfcmVkaXJfaGVsbG9faGVhZGVyKTsKKyAgICAgICAgZ19hc3NlcnQoY291
bnQgPj0gaGVsbG9fc2l6ZSArIDQpOworICAgICAgICBnX2Fzc2VydChTUElDRV9BTElHTkVEX0NB
U1Qoc3RydWN0IHVzYl9yZWRpcl9oZWFkZXIgKiwgZGF0YSktPnR5cGUgPT0gdXNiX3JlZGlyX2hl
bGxvKTsKKworICAgICAgICBjb25zdCB1aW50MzJfdCBmbGFncyA9CisgICAgICAgICAgICB1c2Jy
ZWRpcnBhcnNlcl9mbF93cml0ZV9jYl9vd25zX2J1ZmZlciB8IHVzYnJlZGlycGFyc2VyX2ZsX3Vz
Yl9ob3N0IHwKKyAgICAgICAgICAgIHVzYnJlZGlycGFyc2VyX2ZsX25vX2hlbGxvOworCisgICAg
ICAgIHVzYnJlZGlycGFyc2VyX2luaXQoY2gtPnBhcnNlciwKKyAgICAgICAgICAgICAgICAgICAg
ICAgICAgICBQQUNLQUdFX1NUUklORywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICBTUElD
RV9BTElHTkVEX0NBU1QodWludDMyX3QgKiwgZGF0YSArIGhlbGxvX3NpemUpLAorICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIChjb3VudCAtIGhlbGxvX3NpemUpIC8gc2l6ZW9mKHVpbnQzMl90
KSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbGFncyk7CisKKyAgICAgICAgcmV0dXJu
IDA7CiAgICAgfQogICAgIHJlcyA9IHNwaWNlX3VzYnJlZGlyX3dyaXRlX2NhbGxiYWNrKGNoLT51
c2VyX2RhdGEsIGRhdGEsIGNvdW50KTsKICAgICByZXR1cm4gcmVzOwpAQCAtNzA3LDMxICs3Mjks
MzMgQEAgaW50IHNwaWNlX3VzYl9iYWNrZW5kX3JlYWRfZ3Vlc3RfZGF0YShTcGljZVVzYkJhY2tl
bmRDaGFubmVsICpjaCwgdWludDhfdCAqZGF0YSwKIAogICAgIGNoLT5yZWFkX2J1ZiA9IGRhdGE7
CiAgICAgY2gtPnJlYWRfYnVmX3NpemUgPSBjb3VudDsKLSAgICBpZiAoY2gtPnVzYnJlZGlyaG9z
dCkgewotICAgICAgICByZXMgPSB1c2JyZWRpcmhvc3RfcmVhZF9ndWVzdF9kYXRhKGNoLT51c2Jy
ZWRpcmhvc3QpOwotICAgICAgICBpZiAoIWNoLT5oZWxsb19kb25lX3BhcnNlcikgewotICAgICAg
ICAgICAgaW50IHJlc19wYXJzZXI7CisgICAgaWYgKFNQSUNFX1VOTElLRUxZKGNoLT5zdGF0ZSA9
PSBVU0JfQ0hBTk5FTF9TVEFURV9JTklUSUFMSVpJTkcpKSB7CisgICAgICAgIGlmIChjaC0+dXNi
cmVkaXJob3N0ICE9IE5VTEwpIHsKKyAgICAgICAgICAgIHJlcyA9IHVzYnJlZGlyaG9zdF9yZWFk
X2d1ZXN0X2RhdGEoY2gtPnVzYnJlZGlyaG9zdCk7CisgICAgICAgICAgICBpZiAocmVzICE9IDAp
IHsKKyAgICAgICAgICAgICAgICByZXR1cm4gcmVzOworICAgICAgICAgICAgfQorICAgICAgICAg
ICAgY2gtPnN0YXRlID0gVVNCX0NIQU5ORUxfU1RBVEVfSE9TVDsKKwogICAgICAgICAgICAgLyog
dXNicmVkaXJob3N0IHNob3VsZCBjb25zdW1lIGhlbGxvIHJlc3BvbnNlICovCiAgICAgICAgICAg
ICBnX3JldHVybl92YWxfaWZfZmFpbChjaC0+cmVhZF9idWYgPT0gTlVMTCwgVVNCX1JFRElSX0VS
Uk9SX1JFQURfUEFSU0UpOworICAgICAgICB9IGVsc2UgeworICAgICAgICAgICAgY2gtPnN0YXRl
ID0gVVNCX0NIQU5ORUxfU1RBVEVfUEFSU0VSOworICAgICAgICB9CiAKLSAgICAgICAgICAgIGNo
LT5yZWFkX2J1ZiA9IGRhdGE7Ci0gICAgICAgICAgICBjaC0+cmVhZF9idWZfc2l6ZSA9IGNvdW50
OwotICAgICAgICAgICAgY2gtPmhlbGxvX2RvbmVfcGFyc2VyID0gMTsKLSAgICAgICAgICAgIGlm
IChjaC0+YXR0YWNoZWQgJiYgY2gtPmF0dGFjaGVkLT5lZGV2KSB7Ci0gICAgICAgICAgICAgICAg
LyogY2FzZSBvZiBDRCBzaGFyaW5nIG9uIGNvbm5lY3QgKi8KLSAgICAgICAgICAgICAgICBjaC0+
dXNicmVkaXJob3N0ID0gTlVMTDsKLSAgICAgICAgICAgICAgICBjaC0+cGFyc2VyID0gY2gtPmhp
ZGRlbl9wYXJzZXI7Ci0gICAgICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBzd2l0Y2ggJXAg
dG8gcGFyc2VyIiwgX19GVU5DVElPTl9fLCBjaCk7Ci0gICAgICAgICAgICB9Ci0gICAgICAgICAg
ICByZXNfcGFyc2VyID0gdXNicmVkaXJwYXJzZXJfZG9fcmVhZChjaC0+aGlkZGVuX3BhcnNlcik7
Ci0gICAgICAgICAgICBpZiAocmVzID49IDApIHsKLSAgICAgICAgICAgICAgICByZXMgPSByZXNf
cGFyc2VyOwotICAgICAgICAgICAgfQorICAgICAgICBjaC0+cmVhZF9idWYgPSBkYXRhOworICAg
ICAgICBjaC0+cmVhZF9idWZfc2l6ZSA9IGNvdW50OworICAgICAgICBpZiAoY2gtPmF0dGFjaGVk
ICYmIGNoLT5hdHRhY2hlZC0+ZWRldikgeworICAgICAgICAgICAgLyogY2FzZSBvZiBDRCBzaGFy
aW5nIG9uIGNvbm5lY3QgKi8KKyAgICAgICAgICAgIGNoLT5zdGF0ZSA9IFVTQl9DSEFOTkVMX1NU
QVRFX1BBUlNFUjsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlczogc3dpdGNoICVwIHRvIHBh
cnNlciIsIF9fRlVOQ1RJT05fXywgY2gpOwogICAgICAgICB9Ci0gICAgfSBlbHNlIGlmIChjaC0+
cGFyc2VyKSB7Ci0gICAgICAgIHJlcyA9IHVzYnJlZGlycGFyc2VyX2RvX3JlYWQoY2gtPnBhcnNl
cik7CisgICAgICAgIHJldHVybiB1c2JyZWRpcnBhcnNlcl9kb19yZWFkKGNoLT5wYXJzZXIpOwor
ICAgIH0KKyAgICBpZiAoY2gtPnN0YXRlID09IFVTQl9DSEFOTkVMX1NUQVRFX0hPU1QpIHsKKyAg
ICAgICAgcmVzID0gdXNicmVkaXJob3N0X3JlYWRfZ3Vlc3RfZGF0YShjaC0+dXNicmVkaXJob3N0
KTsKICAgICB9IGVsc2UgewotICAgICAgICByZXMgPSBVU0JfUkVESVJfRVJST1JfSU87CisgICAg
ICAgIHJlcyA9IHVzYnJlZGlycGFyc2VyX2RvX3JlYWQoY2gtPnBhcnNlcik7CiAgICAgfQogICAg
IHN3aXRjaCAocmVzKQogICAgIHsKQEAgLTc4MywxNCArODA3LDEyIEBAIEdFcnJvciAqc3BpY2Vf
dXNiX2JhY2tlbmRfZ2V0X2Vycm9yX2RldGFpbHMoaW50IGVycm9yX2NvZGUsIGdjaGFyICpkZXNj
KQogCiB2b2lkIHNwaWNlX3VzYl9iYWNrZW5kX3JldHVybl93cml0ZV9kYXRhKFNwaWNlVXNiQmFj
a2VuZENoYW5uZWwgKmNoLCB2b2lkICpkYXRhKQogewotICAgIGlmIChjaC0+dXNicmVkaXJob3N0
KSB7CisgICAgaWYgKGNoLT5zdGF0ZSA9PSBVU0JfQ0hBTk5FTF9TVEFURV9IT1NUKSB7CiAgICAg
ICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAtPiB1c2JyZWRpcmhvc3QiLCBfX0ZVTkNUSU9OX18s
IGNoKTsKICAgICAgICAgdXNicmVkaXJob3N0X2ZyZWVfd3JpdGVfYnVmZmVyKGNoLT51c2JyZWRp
cmhvc3QsIGRhdGEpOwotICAgIH0gZWxzZSBpZiAoY2gtPnBhcnNlcikgeworICAgIH0gZWxzZSB7
CiAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAtPiBwYXJzZXIiLCBfX0ZVTkNUSU9OX18s
IGNoKTsKICAgICAgICAgdXNicmVkaXJwYXJzZXJfZnJlZV93cml0ZV9idWZmZXIoY2gtPnBhcnNl
ciwgZGF0YSk7Ci0gICAgfSBlbHNlIHsKLSAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIC0g
Tk9CT0RZIFRPIENBTEwiLCBfX0ZVTkNUSU9OX18sIGNoKTsKICAgICB9CiB9CiAKQEAgLTEwMDUs
MTAgKzEwMjcsMTAgQEAgc3RhdGljIHZvaWQgdXNicmVkaXJfZGV2aWNlX2Rpc2Nvbm5lY3RfYWNr
KHZvaWQgKnByaXYpCiB7CiAgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2Owog
ICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCIsIF9fRlVOQ1RJT05fXywgY2gpOwotICAgIGlmIChj
aC0+cGFyc2VyICYmIGNoLT53YWl0X2Rpc2Nvbm5lY3RfYWNrKSB7Ci0gICAgICAgIGNoLT5wYXJz
ZXIgPSBOVUxMOworICAgIGlmIChjaC0+c3RhdGUgPT0gVVNCX0NIQU5ORUxfU1RBVEVfUEFSU0VS
ICYmIGNoLT51c2JyZWRpcmhvc3QgIT0gTlVMTCAmJgorICAgICAgICBjaC0+d2FpdF9kaXNjb25u
ZWN0X2FjaykgeworICAgICAgICBjaC0+c3RhdGUgPSBVU0JfQ0hBTk5FTF9TVEFURV9IT1NUOwog
ICAgICAgICBTUElDRV9ERUJVRygiJXMgc3dpdGNoIHRvIHVzYnJlZGlyaG9zdCIsIF9fRlVOQ1RJ
T05fXyk7Ci0gICAgICAgIGNoLT51c2JyZWRpcmhvc3QgPSBjaC0+aGlkZGVuX2hvc3Q7CiAgICAg
fQogICAgIGNoLT53YWl0X2Rpc2Nvbm5lY3RfYWNrID0gMDsKIH0KQEAgLTEwMjcsOSArMTA0OSw2
IEBAIHVzYnJlZGlyX2hlbGxvKHZvaWQgKnByaXYsIHN0cnVjdCB1c2JfcmVkaXJfaGVsbG9faGVh
ZGVyICpoZWxsbykKICAgICBTUElDRV9ERUJVRygiJXMgJXAgJXNhdHRhY2hlZCAlcyIsIF9fRlVO
Q1RJT05fXywgY2gsCiAgICAgICAgIGVkZXYgPyAiIiA6ICJub3QgIiwgIGhlbGxvID8gIiIgOiAi
KGludGVybmFsKSIpOwogCi0gICAgaWYgKGhlbGxvKSB7Ci0gICAgICAgIGNoLT5oZWxsb19kb25l
X3BhcnNlciA9IDE7Ci0gICAgfQogICAgIGlmICghZWRldikgewogICAgICAgICByZXR1cm47CiAg
ICAgfQpAQCAtMTA3OSw1MyArMTA5OCwyNCBAQCB1c2JyZWRpcl9oZWxsbyh2b2lkICpwcml2LCBz
dHJ1Y3QgdXNiX3JlZGlyX2hlbGxvX2hlYWRlciAqaGVsbG8pCiAgICAgdXNicmVkaXJfd3JpdGVf
Zmx1c2hfY2FsbGJhY2soY2gpOwogfQogCi1zdGF0aWMgdm9pZCBpbml0aWFsaXplX3BhcnNlcihT
cGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwgZ2Jvb2xlYW4gZG9faGVsbG8pCitzdGF0aWMgdm9p
ZCBpbml0aWFsaXplX3BhcnNlcihTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCkKIHsKICAgICB1
aW50MzJfdCBmbGFncywgY2Fwc1tVU0JfUkVESVJfQ0FQU19TSVpFXSA9IHsgMCB9OwogCi0gICAg
Z19yZXR1cm5faWZfZmFpbChjaC0+aGlkZGVuX3BhcnNlciAhPSBOVUxMKTsKLSAgICBpZiAoY2gt
PnBhcnNlcl9pbml0X2RvbmUpIHsKLSAgICAgICAgaWYgKGNoLT5wYXJzZXJfd2l0aF9oZWxsbyAh
PSBkb19oZWxsbykgewotICAgICAgICAgICAgZ19yZXR1cm5faWZfcmVhY2hlZCgpOwotICAgICAg
ICB9Ci0gICAgICAgIHJldHVybjsKLSAgICB9CisgICAgZ19hc3NlcnQoY2gtPnVzYnJlZGlyaG9z
dCA9PSBOVUxMKTsKIAotICAgIGNoLT5wYXJzZXJfaW5pdF9kb25lID0gMTsKLSAgICBjaC0+cGFy
c2VyX3dpdGhfaGVsbG8gPSBkb19oZWxsbzsKICAgICBmbGFncyA9IHVzYnJlZGlycGFyc2VyX2Zs
X3dyaXRlX2NiX293bnNfYnVmZmVyIHwgdXNicmVkaXJwYXJzZXJfZmxfdXNiX2hvc3Q7CiAKLSAg
ICBpZiAoZG9faGVsbG8pIHsKLSAgICAgICAgY2gtPmhlbGxvX3NlbnQgPSAxOwotICAgICAgICBj
aC0+aG9zdF9jYXBzIHw9IDEgPDwgdXNiX3JlZGlyX2NhcF9jb25uZWN0X2RldmljZV92ZXJzaW9u
OwotICAgICAgICBjaC0+aG9zdF9jYXBzIHw9IDEgPDwgdXNiX3JlZGlyX2NhcF9kZXZpY2VfZGlz
Y29ubmVjdF9hY2s7Ci0gICAgICAgIGNoLT5ob3N0X2NhcHMgfD0gMSA8PCB1c2JfcmVkaXJfY2Fw
X2VwX2luZm9fbWF4X3BhY2tldF9zaXplOwotICAgICAgICBjaC0+aG9zdF9jYXBzIHw9IDEgPDwg
dXNiX3JlZGlyX2NhcF82NGJpdHNfaWRzOwotICAgICAgICBjaC0+aG9zdF9jYXBzIHw9IDEgPDwg
dXNiX3JlZGlyX2NhcF8zMmJpdHNfYnVsa19sZW5ndGg7Ci0gICAgfSBlbHNlIHsKLSAgICAgICAg
ZmxhZ3MgfD0gdXNicmVkaXJwYXJzZXJfZmxfbm9faGVsbG87Ci0gICAgfQotCi0gICAgaWYgKGNo
LT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJfY2FwX2Nvbm5lY3RfZGV2aWNlX3ZlcnNpb24p
KSB7Ci0gICAgICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJf
Y2FwX2Nvbm5lY3RfZGV2aWNlX3ZlcnNpb24pOwotICAgIH0KKyAgICB1c2JyZWRpcnBhcnNlcl9j
YXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF9jb25uZWN0X2RldmljZV92ZXJzaW9uKTsK
ICAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF9maWx0
ZXIpOwotICAgIGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF9kZXZpY2Vf
ZGlzY29ubmVjdF9hY2spKSB7Ci0gICAgICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChj
YXBzLCB1c2JfcmVkaXJfY2FwX2RldmljZV9kaXNjb25uZWN0X2Fjayk7Ci0gICAgfQotICAgIGlm
IChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF9lcF9pbmZvX21heF9wYWNrZXRf
c2l6ZSkpIHsKLSAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9y
ZWRpcl9jYXBfZXBfaW5mb19tYXhfcGFja2V0X3NpemUpOwotICAgIH0KLSAgICBpZiAoY2gtPmhv
c3RfY2FwcyAmICgxIDw8IHVzYl9yZWRpcl9jYXBfNjRiaXRzX2lkcykpIHsKLSAgICAgICAgdXNi
cmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfNjRiaXRzX2lkcyk7
Ci0gICAgfQotICAgIGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF8zMmJp
dHNfYnVsa19sZW5ndGgpKSB7Ci0gICAgICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChj
YXBzLCB1c2JfcmVkaXJfY2FwXzMyYml0c19idWxrX2xlbmd0aCk7Ci0gICAgfQotICAgIGlmIChj
aC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF9idWxrX3N0cmVhbXMpKSB7Ci0gICAg
ICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJfY2FwX2J1bGtf
c3RyZWFtcyk7Ci0gICAgfQotICAgIHVzYnJlZGlycGFyc2VyX2luaXQoY2gtPmhpZGRlbl9wYXJz
ZXIsIFBBQ0tBR0VfU1RSSU5HLCBjYXBzLCBVU0JfUkVESVJfQ0FQU19TSVpFLCBmbGFncyk7Cisg
ICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfZGV2aWNl
X2Rpc2Nvbm5lY3RfYWNrKTsKKyAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2Fwcywg
dXNiX3JlZGlyX2NhcF9lcF9pbmZvX21heF9wYWNrZXRfc2l6ZSk7CisgICAgdXNicmVkaXJwYXJz
ZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfNjRiaXRzX2lkcyk7CisgICAgdXNi
cmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfMzJiaXRzX2J1bGtf
bGVuZ3RoKTsKKyAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGly
X2NhcF9idWxrX3JlY2VpdmluZyk7CisgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNh
cHMsIHVzYl9yZWRpcl9jYXBfYnVsa19zdHJlYW1zKTsKKworICAgIHVzYnJlZGlycGFyc2VyX2lu
aXQoY2gtPnBhcnNlciwgUEFDS0FHRV9TVFJJTkcsIGNhcHMsIFVTQl9SRURJUl9DQVBTX1NJWkUs
IGZsYWdzKTsKIH0KIAogLyoKQEAgLTExODAsNyArMTE3MCw3IEBAIHN0YXRpYyBnYm9vbGVhbiBh
dHRhY2hfZWRldihTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwKICAgICAgICAgICAgXygiRmFp
bGVkIHRvIHJlZGlyZWN0IGRldmljZSAlZCIpLCAxKTsKICAgICAgICAgcmV0dXJuIEZBTFNFOwog
ICAgIH0KLSAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCAmJiAhY2gtPmhlbGxvX2RvbmVfcGFyc2Vy
KSB7CisgICAgaWYgKGNoLT5zdGF0ZSA9PSBVU0JfQ0hBTk5FTF9TVEFURV9JTklUSUFMSVpJTkcp
IHsKICAgICAgICAgLyoKICAgICAgICAgICAgIHdlIGNhbid0IGluaXRpYWxpemUgcGFyc2VyIHVu
dGlsIHdlIHNlZSBoZWxsbyBmcm9tIHVzYnJlZGlyCiAgICAgICAgICAgICBhbmQgdGhlIHBhcnNl
ciBjYW4ndCB3b3JrIHVudGlsIGl0IHNlZXMgdGhlIGhlbGxvIHJlc3BvbnNlLgpAQCAtMTE5MCwx
NSArMTE4MCwxMyBAQCBzdGF0aWMgZ2Jvb2xlYW4gYXR0YWNoX2VkZXYoU3BpY2VVc2JCYWNrZW5k
Q2hhbm5lbCAqY2gsCiAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyB3YWl0aW5nIHVudGlsIHRoZSBj
aGFubmVsIGlzIHJlYWR5IiwgX19GVU5DVElPTl9fKTsKIAogICAgIH0gZWxzZSB7Ci0gICAgICAg
IGluaXRpYWxpemVfcGFyc2VyKGNoLCBjaC0+aGlkZGVuX2hvc3QgPT0gTlVMTCk7Ci0gICAgICAg
IGNoLT51c2JyZWRpcmhvc3QgPSBOVUxMOwotICAgICAgICBjaC0+cGFyc2VyID0gY2gtPmhpZGRl
bl9wYXJzZXI7CisgICAgICAgIGNoLT5zdGF0ZSA9IFVTQl9DSEFOTkVMX1NUQVRFX1BBUlNFUjsK
ICAgICB9CiAgICAgY2gtPndhaXRfZGlzY29ubmVjdF9hY2sgPSAwOwogICAgIGNoLT5hdHRhY2hl
ZCA9IGRldjsKICAgICBkZXYtPmF0dGFjaGVkX3RvID0gY2g7Ci0gICAgZGV2aWNlX29wcyhkZXYt
PmVkZXYpLT5hdHRhY2goZGV2LT5lZGV2LCBjaC0+aGlkZGVuX3BhcnNlcik7Ci0gICAgaWYgKGNo
LT5oZWxsb19kb25lX3BhcnNlcikgeworICAgIGRldmljZV9vcHMoZGV2LT5lZGV2KS0+YXR0YWNo
KGRldi0+ZWRldiwgY2gtPnBhcnNlcik7CisgICAgaWYgKGNoLT5zdGF0ZSA9PSBVU0JfQ0hBTk5F
TF9TVEFURV9QQVJTRVIpIHsKICAgICAgICAgLyogc2VuZCBkZXZpY2UgaW5mbyAqLwogICAgICAg
ICB1c2JyZWRpcl9oZWxsbyhjaCwgTlVMTCk7CiAgICAgfQpAQCAtMTIxOCw5ICsxMjA2LDE1IEBA
IGdib29sZWFuIHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfYXR0YWNoKFNwaWNlVXNiQmFja2Vu
ZENoYW5uZWwgKmNoLAogICAgICAgICByZXR1cm4gYXR0YWNoX2VkZXYoY2gsIGRldiwgZXJyb3Ip
OwogICAgIH0KIAorICAgIC8vIG5vIHBoeXNpY2FsIGRldmljZSBlbmFibGVkCisgICAgaWYgKGNo
LT51c2JyZWRpcmhvc3QgPT0gTlVMTCkgeworICAgICAgICByZXR1cm4gRkFMU0U7CisgICAgfQor
CiAgICAgbGlidXNiX2RldmljZV9oYW5kbGUgKmhhbmRsZSA9IE5VTEw7Ci0gICAgY2gtPnVzYnJl
ZGlyaG9zdCA9IGNoLT5oaWRkZW5faG9zdDsKLSAgICBjaC0+cGFyc2VyID0gTlVMTDsKKyAgICBp
ZiAoY2gtPnN0YXRlICE9IFVTQl9DSEFOTkVMX1NUQVRFX0lOSVRJQUxJWklORykgeworICAgICAg
ICBjaC0+c3RhdGUgPSBVU0JfQ0hBTk5FTF9TVEFURV9IT1NUOworICAgIH0KIAogICAgIC8qCiAg
ICAgICAgVW5kZXIgV2luZG93cyB3ZSBuZWVkIHRvIGF2b2lkIHVwZGF0aW5nCkBAIC0xMjYxLDEw
ICsxMjU1LDEwIEBAIHZvaWQgc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9kZXRhY2goU3BpY2VV
c2JCYWNrZW5kQ2hhbm5lbCAqY2gpCiAgICAgICAgIFNQSUNFX0RFQlVHKCIlczogbm90aGluZyB0
byBkZXRhY2giLCBfX0ZVTkNUSU9OX18pOwogICAgICAgICByZXR1cm47CiAgICAgfQotICAgIGlm
IChjaC0+dXNicmVkaXJob3N0KSB7CisgICAgaWYgKGNoLT5zdGF0ZSA9PSBVU0JfQ0hBTk5FTF9T
VEFURV9IT1NUKSB7CiAgICAgICAgIC8qIGl0IHdpbGwgY2FsbCBsaWJ1c2JfY2xvc2UgaW50ZXJu
YWxseSAqLwogICAgICAgICB1c2JyZWRpcmhvc3Rfc2V0X2RldmljZShjaC0+dXNicmVkaXJob3N0
LCBOVUxMKTsKLSAgICB9IGVsc2UgaWYgKGNoLT5wYXJzZXIpIHsKKyAgICB9IGVsc2UgewogICAg
ICAgICBpZiAoZWRldikgewogICAgICAgICAgICAgZGV2aWNlX29wcyhlZGV2KS0+ZGV0YWNoKGVk
ZXYpOwogICAgICAgICB9CkBAIC0xMjcyLDkgKzEyNjYsOCBAQCB2b2lkIHNwaWNlX3VzYl9iYWNr
ZW5kX2NoYW5uZWxfZGV0YWNoKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoKQogICAgICAgICB1
c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFjayhjaCk7CiAgICAgICAgIGNoLT53YWl0X2Rpc2Nv
bm5lY3RfYWNrID0KICAgICAgICAgICAgIHVzYnJlZGlycGFyc2VyX3BlZXJfaGFzX2NhcChjaC0+
cGFyc2VyLCB1c2JfcmVkaXJfY2FwX2RldmljZV9kaXNjb25uZWN0X2Fjayk7Ci0gICAgICAgIGlm
ICghY2gtPndhaXRfZGlzY29ubmVjdF9hY2spIHsKLSAgICAgICAgICAgIGNoLT51c2JyZWRpcmhv
c3QgPSBjaC0+aGlkZGVuX2hvc3Q7Ci0gICAgICAgICAgICBjaC0+cGFyc2VyID0gTlVMTDsKKyAg
ICAgICAgaWYgKCFjaC0+d2FpdF9kaXNjb25uZWN0X2FjayAmJiBjaC0+dXNicmVkaXJob3N0ICE9
IE5VTEwpIHsKKyAgICAgICAgICAgIGNoLT5zdGF0ZSA9IFVTQl9DSEFOTkVMX1NUQVRFX0hPU1Q7
CiAgICAgICAgIH0KICAgICB9CiAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwLCBkZXRhY2ggZG9u
ZSIsIF9fRlVOQ1RJT05fXywgY2gpOwpAQCAtMTMxMSwxNiArMTMwNCwyMiBAQCBTcGljZVVzYkJh
Y2tlbmRDaGFubmVsICpzcGljZV91c2JfYmFja2VuZF9jaGFubmVsX25ldyhTcGljZVVzYkJhY2tl
bmQgKmJlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzYnJlZGly
cGFyc2VyX3dhcm5pbmcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzYnJl
ZGlyaG9zdF9mbF93cml0ZV9jYl9vd25zX2J1ZmZlcik7CiAgICAgICAgIGdfd2Fybl9pZl9mYWls
KGNoLT51c2JyZWRpcmhvc3QgIT0gTlVMTCk7CisgICAgICAgIGlmIChjaC0+dXNicmVkaXJob3N0
ICE9IE5VTEwpIHsKKyAgICAgICAgICAgIHVzYnJlZGlyaG9zdF9zZXRfYnVmZmVyZWRfb3V0cHV0
X3NpemVfY2IoY2gtPnVzYnJlZGlyaG9zdCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgdXNicmVkaXJfYnVmZmVyZWRfb3V0cHV0X3NpemVfY2Fs
bGJhY2spOworICAgICAgICAgICAgLy8gZm9yY2UgZmx1c2ggb2YgSEVMTE8gcGFja2V0IGFuZCBj
cmVhdGlvbiBvZiBwYXJzZXIKKyAgICAgICAgICAgIHVzYnJlZGlyaG9zdF93cml0ZV9ndWVzdF9k
YXRhKGNoLT51c2JyZWRpcmhvc3QpOworICAgICAgICB9CisgICAgfSBlbHNlIHsKKyAgICAgICAg
Ly8gbm8gcGh5c2ljYWwgZGV2aWNlIHN1cHBvcnQsIG9ubHkgZW11bGF0ZWQsIGNyZWF0ZSB0aGUK
KyAgICAgICAgLy8gcGFyc2VyCisgICAgICAgIGNoLT5wYXJzZXIgPSBjcmVhdGVfcGFyc2VyKGNo
KTsKKyAgICAgICAgaWYgKGNoLT5wYXJzZXIgIT0gTlVMTCkgeworICAgICAgICAgICAgaW5pdGlh
bGl6ZV9wYXJzZXIoY2gpOworICAgICAgICB9CiAgICAgfQogCi0gICAgaWYgKGNoLT51c2JyZWRp
cmhvc3QpIHsKLSAgICAgICAgY2gtPmhpZGRlbl9wYXJzZXIgPSBjcmVhdGVfcGFyc2VyKGNoKTsK
LSAgICAgICAgY2gtPmhpZGRlbl9ob3N0ID0gY2gtPnVzYnJlZGlyaG9zdDsKLSAgICAgICAgdXNi
cmVkaXJob3N0X3NldF9idWZmZXJlZF9vdXRwdXRfc2l6ZV9jYihjaC0+dXNicmVkaXJob3N0LAot
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzYnJlZGly
X2J1ZmZlcmVkX291dHB1dF9zaXplX2NhbGxiYWNrKTsKLSAgICB9Ci0KLSAgICBpZiAoIWNoLT5o
aWRkZW5fcGFyc2VyKSB7CisgICAgaWYgKCFjaC0+cGFyc2VyKSB7CiAgICAgICAgIHNwaWNlX3Vz
Yl9iYWNrZW5kX2NoYW5uZWxfZGVsZXRlKGNoKTsKICAgICAgICAgY2ggPSBOVUxMOwogICAgIH0K
QEAgLTEzMzIsMTIgKzEzMzEsOSBAQCBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpzcGljZV91c2Jf
YmFja2VuZF9jaGFubmVsX25ldyhTcGljZVVzYkJhY2tlbmQgKmJlLAogdm9pZCBzcGljZV91c2Jf
YmFja2VuZF9jaGFubmVsX2ZsdXNoX3dyaXRlcyhTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCkK
IHsKICAgICBTUElDRV9ERUJVRygiJXMgJXAgaXMgdXAiLCBfX0ZVTkNUSU9OX18sIGNoKTsKLSAg
ICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgeworICAgIGlmIChjaC0+c3RhdGUgIT0gVVNCX0NIQU5O
RUxfU1RBVEVfUEFSU0VSICYmIGNoLT51c2JyZWRpcmhvc3QgIT0gTlVMTCkgewogICAgICAgICB1
c2JyZWRpcmhvc3Rfd3JpdGVfZ3Vlc3RfZGF0YShjaC0+dXNicmVkaXJob3N0KTsKLSAgICAgICAg
aW5pdGlhbGl6ZV9wYXJzZXIoY2gsIEZBTFNFKTsKICAgICB9IGVsc2UgewotICAgICAgICBpbml0
aWFsaXplX3BhcnNlcihjaCwgVFJVRSk7Ci0gICAgICAgIGNoLT5wYXJzZXIgPSBjaC0+aGlkZGVu
X3BhcnNlcjsKICAgICAgICAgdXNicmVkaXJwYXJzZXJfZG9fd3JpdGUoY2gtPnBhcnNlcik7CiAg
ICAgfQogfQpAQCAtMTM0OCwxMSArMTM0NCwxMSBAQCB2b2lkIHNwaWNlX3VzYl9iYWNrZW5kX2No
YW5uZWxfZGVsZXRlKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoKQogICAgIGlmICghY2gpIHsK
ICAgICAgICAgcmV0dXJuOwogICAgIH0KLSAgICBpZiAoY2gtPmhpZGRlbl9ob3N0KSB7Ci0gICAg
ICAgIHVzYnJlZGlyaG9zdF9jbG9zZShjaC0+aGlkZGVuX2hvc3QpOworICAgIGlmIChjaC0+dXNi
cmVkaXJob3N0KSB7CisgICAgICAgIHVzYnJlZGlyaG9zdF9jbG9zZShjaC0+dXNicmVkaXJob3N0
KTsKICAgICB9Ci0gICAgaWYgKGNoLT5oaWRkZW5fcGFyc2VyKSB7Ci0gICAgICAgIHVzYnJlZGly
cGFyc2VyX2Rlc3Ryb3koY2gtPmhpZGRlbl9wYXJzZXIpOworICAgIGlmIChjaC0+cGFyc2VyKSB7
CisgICAgICAgIHVzYnJlZGlycGFyc2VyX2Rlc3Ryb3koY2gtPnBhcnNlcik7CiAgICAgfQogCiAg
ICAgaWYgKGNoLT5ydWxlcykgewpAQCAtMTM3Miw3ICsxMzY4LDcgQEAgc3BpY2VfdXNiX2JhY2tl
bmRfY2hhbm5lbF9nZXRfZ3Vlc3RfZmlsdGVyKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLAog
ICAgIGludCBpOwogICAgICpyID0gTlVMTDsKICAgICAqY291bnQgPSAwOwotICAgIGlmIChjaC0+
dXNicmVkaXJob3N0KSB7CisgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QgIT0gTlVMTCkgewogICAg
ICAgICB1c2JyZWRpcmhvc3RfZ2V0X2d1ZXN0X2ZpbHRlcihjaC0+dXNicmVkaXJob3N0LCByLCBj
b3VudCk7CiAgICAgfQogICAgIGlmICgqciA9PSBOVUxMKSB7Ci0tIAoyLjIwLjEKCl9fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClNwaWNlLWRldmVsIG1haWxp
bmcgbGlzdApTcGljZS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5m
cmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9zcGljZS1kZXZlbA==
