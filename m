Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 3100B87CB9
	for <lists+spice-devel@lfdr.de>; Fri,  9 Aug 2019 16:28:34 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id B81476EE32;
	Fri,  9 Aug 2019 14:28:32 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 9596C6EE36
 for <spice-devel@lists.freedesktop.org>; Fri,  9 Aug 2019 14:28:31 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx07.intmail.prod.int.phx2.redhat.com
 [10.5.11.22])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 3F64D5946B
 for <spice-devel@lists.freedesktop.org>; Fri,  9 Aug 2019 14:28:31 +0000 (UTC)
Received: from fziglio.remote.csb (ovpn-204-160.brq.redhat.com [10.40.204.160])
 by smtp.corp.redhat.com (Postfix) with ESMTP id 8CDAC1000182;
 Fri,  9 Aug 2019 14:28:29 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Fri,  9 Aug 2019 15:26:46 +0100
Message-Id: <20190809142651.2967-29-fziglio@redhat.com>
In-Reply-To: <20190809142651.2967-1-fziglio@redhat.com>
References: <20190809142651.2967-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.84 on 10.5.11.22
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.39]); Fri, 09 Aug 2019 14:28:31 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-gtk v2 28/33] fixup! usb-redir: add
 implementation of emulated CD device
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

QXZvaWQgZmlsZV9vYmplY3QsIGl0J3Mgbm90IG5lY2Vzc2FyeSB0byBrZWVwIGl0LgotLS0KIHNy
Yy91c2ItZGV2aWNlLWNkLmMgfCAxMTYgKysrKysrKysrKysrKysrKysrKysrLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCA1NSBpbnNlcnRpb25zKCspLCA2MSBkZWxldGlv
bnMoLSkKCmRpZmYgLS1naXQgYS9zcmMvdXNiLWRldmljZS1jZC5jIGIvc3JjL3VzYi1kZXZpY2Ut
Y2QuYwppbmRleCAwM2I4ZjVlZS4uYzMzYmIyOTAgMTAwNjQ0Ci0tLSBhL3NyYy91c2ItZGV2aWNl
LWNkLmMKKysrIGIvc3JjL3VzYi1kZXZpY2UtY2QuYwpAQCAtNDgsNyArNDgsNiBAQAogCiB0eXBl
ZGVmIHN0cnVjdCBTcGljZUNkTFUgewogICAgIGNoYXIgKmZpbGVuYW1lOwotICAgIEdGaWxlICpm
aWxlX29iamVjdDsKICAgICBHRmlsZUlucHV0U3RyZWFtICpzdHJlYW07CiAgICAgdWludDY0X3Qg
c2l6ZTsKICAgICB1aW50MzJfdCBibG9ja1NpemU7CkBAIC05NSw3ICs5NCw2IEBAIHR5cGVkZWYg
c3RydWN0IFNwaWNlVXNiRW11bGF0ZWREZXZpY2UgVXNiQ2Q7CiAKIHN0YXRpYyBpbnQgY2RfZGV2
aWNlX29wZW5fc3RyZWFtKFNwaWNlQ2RMVSAqdW5pdCwgY29uc3QgY2hhciAqZmlsZW5hbWUpCiB7
Ci0gICAgaW50IGVycm9yID0gMDsKICAgICB1bml0LT5kZXZpY2UgPSAwOwogCiAgICAgaWYgKCF1
bml0LT5maWxlbmFtZSAmJiAhZmlsZW5hbWUpIHsKQEAgLTExMSwzMyArMTA5LDMyIEBAIHN0YXRp
YyBpbnQgY2RfZGV2aWNlX29wZW5fc3RyZWFtKFNwaWNlQ2RMVSAqdW5pdCwgY29uc3QgY2hhciAq
ZmlsZW5hbWUpCiAgICAgfQogCiAgICAgaW50IGZkID0gb3Blbih1bml0LT5maWxlbmFtZSwgT19S
RE9OTFkgfCBPX05PTkJMT0NLKTsKLSAgICBpZiAoZmQgPiAwKSB7Ci0gICAgICAgIHN0cnVjdCBz
dGF0IGZpbGVfc3RhdCA9IHsgMCB9OwotICAgICAgICBpZiAoZnN0YXQoZmQsICZmaWxlX3N0YXQp
IHx8IGZpbGVfc3RhdC5zdF9zaXplID09IDApIHsKLSAgICAgICAgICAgIGZpbGVfc3RhdC5zdF9z
aXplID0gMDsKLSAgICAgICAgICAgIHVuaXQtPmRldmljZSA9IDE7Ci0gICAgICAgICAgICBpZiAo
IWlvY3RsKGZkLCBCTEtHRVRTSVpFNjQsICZmaWxlX3N0YXQuc3Rfc2l6ZSkgJiYKLSAgICAgICAg
ICAgICAgICAhaW9jdGwoZmQsIEJMS1NTWkdFVCwgJnVuaXQtPmJsb2NrU2l6ZSkpIHsKLSAgICAg
ICAgICAgIH0KLSAgICAgICAgfQotICAgICAgICB1bml0LT5zaXplID0gZmlsZV9zdGF0LnN0X3Np
emU7Ci0gICAgICAgIGNsb3NlKGZkKTsKLSAgICAgICAgaWYgKHVuaXQtPnNpemUpIHsKLSAgICAg
ICAgICAgIHVuaXQtPmZpbGVfb2JqZWN0ID0gZ19maWxlX25ld19mb3JfcGF0aCh1bml0LT5maWxl
bmFtZSk7Ci0gICAgICAgICAgICB1bml0LT5zdHJlYW0gPSBnX2ZpbGVfcmVhZCh1bml0LT5maWxl
X29iamVjdCwgTlVMTCwgTlVMTCk7Ci0gICAgICAgIH0KLSAgICAgICAgaWYgKCF1bml0LT5zdHJl
YW0pIHsKLSAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlczogY2FuJ3Qgb3BlbiBzdHJlYW0gb24g
JXMiLCBfX0ZVTkNUSU9OX18sIHVuaXQtPmZpbGVuYW1lKTsKLSAgICAgICAgICAgIGdfY2xlYXJf
b2JqZWN0KCZ1bml0LT5maWxlX29iamVjdCk7Ci0gICAgICAgICAgICBlcnJvciA9IC0xOworICAg
IGlmIChmZCA8IDApIHsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBjYW4ndCBvcGVuIGZpbGUg
JXMiLCBfX0ZVTkNUSU9OX18sIHVuaXQtPmZpbGVuYW1lKTsKKyAgICAgICAgcmV0dXJuIC0xOwor
ICAgIH0KKworICAgIHN0cnVjdCBzdGF0IGZpbGVfc3RhdCA9IHsgMCB9OworICAgIGlmIChmc3Rh
dChmZCwgJmZpbGVfc3RhdCkgfHwgZmlsZV9zdGF0LnN0X3NpemUgPT0gMCkgeworICAgICAgICBm
aWxlX3N0YXQuc3Rfc2l6ZSA9IDA7CisgICAgICAgIHVuaXQtPmRldmljZSA9IDE7CisgICAgICAg
IGlmICghaW9jdGwoZmQsIEJMS0dFVFNJWkU2NCwgJmZpbGVfc3RhdC5zdF9zaXplKSAmJgorICAg
ICAgICAgICAgIWlvY3RsKGZkLCBCTEtTU1pHRVQsICZ1bml0LT5ibG9ja1NpemUpKSB7CiAgICAg
ICAgIH0KICAgICB9Ci0gICAgZWxzZSB7Ci0gICAgICAgIFNQSUNFX0RFQlVHKCIlczogY2FuJ3Qg
b3BlbiBmaWxlICVzIiwgX19GVU5DVElPTl9fLCB1bml0LT5maWxlbmFtZSk7Ci0gICAgICAgIGVy
cm9yID0gLTE7CisgICAgdW5pdC0+c2l6ZSA9IGZpbGVfc3RhdC5zdF9zaXplOworICAgIGNsb3Nl
KGZkKTsKKyAgICBpZiAodW5pdC0+c2l6ZSkgeworICAgICAgICBHRmlsZSAqZmlsZV9vYmplY3Qg
PSBnX2ZpbGVfbmV3X2Zvcl9wYXRoKHVuaXQtPmZpbGVuYW1lKTsKKyAgICAgICAgdW5pdC0+c3Ry
ZWFtID0gZ19maWxlX3JlYWQoZmlsZV9vYmplY3QsIE5VTEwsIE5VTEwpOworICAgICAgICBnX2Ns
ZWFyX29iamVjdCgmZmlsZV9vYmplY3QpOworICAgIH0KKyAgICBpZiAoIXVuaXQtPnN0cmVhbSkg
eworICAgICAgICBTUElDRV9ERUJVRygiJXM6IGNhbid0IG9wZW4gc3RyZWFtIG9uICVzIiwgX19G
VU5DVElPTl9fLCB1bml0LT5maWxlbmFtZSk7CisgICAgICAgIHJldHVybiAtMTsKICAgICB9CiAK
LSAgICByZXR1cm4gZXJyb3I7CisgICAgcmV0dXJuIDA7CiB9CiAKIHN0YXRpYyBpbnQgY2RfZGV2
aWNlX2xvYWQoU3BpY2VDZExVICp1bml0LCBnYm9vbGVhbiBsb2FkKQpAQCAtMjM1LDcgKzIzMiw2
IEBAIHN0YXRpYyBnYm9vbGVhbiBjaGVja19kZXZpY2UoSEFORExFIGgpCiAKIHN0YXRpYyBpbnQg
Y2RfZGV2aWNlX29wZW5fc3RyZWFtKFNwaWNlQ2RMVSAqdW5pdCwgY29uc3QgY2hhciAqZmlsZW5h
bWUpCiB7Ci0gICAgaW50IGVycm9yID0gMDsKICAgICBIQU5ETEUgaDsKICAgICB1bml0LT5kZXZp
Y2UgPSAwOwogICAgIGlmICghdW5pdC0+ZmlsZW5hbWUgJiYgIWZpbGVuYW1lKSB7CkBAIC0yNTQs
NDIgKzI1MCw0MSBAQCBzdGF0aWMgaW50IGNkX2RldmljZV9vcGVuX3N0cmVhbShTcGljZUNkTFUg
KnVuaXQsIGNvbnN0IGNoYXIgKmZpbGVuYW1lKQogICAgICAgICB1bml0LT5maWxlbmFtZSA9IGdf
c3RyZHVwKGZpbGVuYW1lKTsKICAgICB9CiAgICAgaCA9IG9wZW5fZmlsZSh1bml0LT5maWxlbmFt
ZSk7Ci0gICAgaWYgKGgpIHsKLSAgICAgICAgTEFSR0VfSU5URUdFUiBzaXplID0geyAwIH07Ci0g
ICAgICAgIGlmICghR2V0RmlsZVNpemVFeChoLCAmc2l6ZSkpIHsKLSAgICAgICAgICAgIHVpbnQ2
NF90IGJ1ZmZlclsyNTZdOwotICAgICAgICAgICAgdWludDMyX3QgcmVzOwotICAgICAgICAgICAg
dW5pdC0+ZGV2aWNlID0gY2hlY2tfZGV2aWNlKGgpOwotICAgICAgICAgICAgU1BJQ0VfREVCVUco
IiVzOiBDRCBkZXZpY2UgJXNyZWNvZ25pemVkIG9uICVzIiwKLSAgICAgICAgICAgICAgICBfX0ZV
TkNUSU9OX18sIHVuaXQtPmRldmljZSA/ICIiIDogIk5PVCAiLCB1bml0LT5maWxlbmFtZSk7Ci0g
ICAgICAgICAgICByZXMgPSBpb2N0bF9vdXQoaCwgSU9DVExfRElTS19HRVRfRFJJVkVfR0VPTUVU
UllfRVgsCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyLCBzaXplb2YoYnVmZmVy
KSk7Ci0gICAgICAgICAgICBpZiAoIXJlcykKLSAgICAgICAgICAgIHsKLSAgICAgICAgICAgICAg
ICBESVNLX0dFT01FVFJZX0VYICpwZyA9IChESVNLX0dFT01FVFJZX0VYICopYnVmZmVyOwotICAg
ICAgICAgICAgICAgIHVuaXQtPmJsb2NrU2l6ZSA9IHBnLT5HZW9tZXRyeS5CeXRlc1BlclNlY3Rv
cjsKLSAgICAgICAgICAgICAgICBzaXplID0gcGctPkRpc2tTaXplOwotICAgICAgICAgICAgfSBl
bHNlIHsKLSAgICAgICAgICAgICAgICBTUElDRV9ERUJVRygiJXM6IGNhbid0IG9idGFpbiBzaXpl
IG9mICVzIChlcnJvciAldSkiLAotICAgICAgICAgICAgICAgICAgICBfX0ZVTkNUSU9OX18sIHVu
aXQtPmZpbGVuYW1lLCByZXMpOwotICAgICAgICAgICAgfQotICAgICAgICB9Ci0gICAgICAgIHVu
aXQtPnNpemUgPSBzaXplLlF1YWRQYXJ0OwotICAgICAgICBDbG9zZUhhbmRsZShoKTsKLSAgICAg
ICAgaWYgKHVuaXQtPnNpemUpIHsKLSAgICAgICAgICAgIHVuaXQtPmZpbGVfb2JqZWN0ID0gZ19m
aWxlX25ld19mb3JfcGF0aCh1bml0LT5maWxlbmFtZSk7Ci0gICAgICAgICAgICB1bml0LT5zdHJl
YW0gPSBnX2ZpbGVfcmVhZCh1bml0LT5maWxlX29iamVjdCwgTlVMTCwgTlVMTCk7Ci0gICAgICAg
IH0KLSAgICAgICAgaWYgKCF1bml0LT5zdHJlYW0pIHsKLSAgICAgICAgICAgIFNQSUNFX0RFQlVH
KCIlczogY2FuJ3Qgb3BlbiBzdHJlYW0gb24gJXMiLCBfX0ZVTkNUSU9OX18sIHVuaXQtPmZpbGVu
YW1lKTsKLSAgICAgICAgICAgIGdfY2xlYXJfb2JqZWN0KCZ1bml0LT5maWxlX29iamVjdCk7Ci0g
ICAgICAgICAgICBlcnJvciA9IC0xOwotICAgICAgICB9Ci0gICAgfSBlbHNlIHsKKyAgICBpZiAo
IWgpIHsKICAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBjYW4ndCBvcGVuIGZpbGUgJXMiLCBfX0ZV
TkNUSU9OX18sIHVuaXQtPmZpbGVuYW1lKTsKLSAgICAgICAgZXJyb3IgPSAtMTsKKyAgICAgICAg
cmV0dXJuIC0xOwogICAgIH0KLSAgICByZXR1cm4gZXJyb3I7CisKKyAgICBMQVJHRV9JTlRFR0VS
IHNpemUgPSB7IDAgfTsKKyAgICBpZiAoIUdldEZpbGVTaXplRXgoaCwgJnNpemUpKSB7CisgICAg
ICAgIHVpbnQ2NF90IGJ1ZmZlclsyNTZdOworICAgICAgICB1aW50MzJfdCByZXM7CisgICAgICAg
IHVuaXQtPmRldmljZSA9IGNoZWNrX2RldmljZShoKTsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVz
OiBDRCBkZXZpY2UgJXNyZWNvZ25pemVkIG9uICVzIiwKKyAgICAgICAgICAgIF9fRlVOQ1RJT05f
XywgdW5pdC0+ZGV2aWNlID8gIiIgOiAiTk9UICIsIHVuaXQtPmZpbGVuYW1lKTsKKyAgICAgICAg
cmVzID0gaW9jdGxfb3V0KGgsIElPQ1RMX0RJU0tfR0VUX0RSSVZFX0dFT01FVFJZX0VYLAorICAg
ICAgICAgICAgICAgICAgICAgICAgYnVmZmVyLCBzaXplb2YoYnVmZmVyKSk7CisgICAgICAgIGlm
ICghcmVzKSB7CisgICAgICAgICAgICBESVNLX0dFT01FVFJZX0VYICpwZyA9IChESVNLX0dFT01F
VFJZX0VYICopYnVmZmVyOworICAgICAgICAgICAgdW5pdC0+YmxvY2tTaXplID0gcGctPkdlb21l
dHJ5LkJ5dGVzUGVyU2VjdG9yOworICAgICAgICAgICAgc2l6ZSA9IHBnLT5EaXNrU2l6ZTsKKyAg
ICAgICAgfSBlbHNlIHsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlczogY2FuJ3Qgb2J0YWlu
IHNpemUgb2YgJXMgKGVycm9yICV1KSIsCisgICAgICAgICAgICAgICAgX19GVU5DVElPTl9fLCB1
bml0LT5maWxlbmFtZSwgcmVzKTsKKyAgICAgICAgfQorICAgIH0KKyAgICB1bml0LT5zaXplID0g
c2l6ZS5RdWFkUGFydDsKKyAgICBDbG9zZUhhbmRsZShoKTsKKyAgICBpZiAodW5pdC0+c2l6ZSkg
eworICAgICAgICBHRmlsZSAqZmlsZV9vYmplY3QgPSBnX2ZpbGVfbmV3X2Zvcl9wYXRoKHVuaXQt
PmZpbGVuYW1lKTsKKyAgICAgICAgdW5pdC0+c3RyZWFtID0gZ19maWxlX3JlYWQoZmlsZV9vYmpl
Y3QsIE5VTEwsIE5VTEwpOworICAgICAgICBnX2NsZWFyX29iamVjdCgmZmlsZV9vYmplY3QpOwor
ICAgIH0KKyAgICBpZiAoIXVuaXQtPnN0cmVhbSkgeworICAgICAgICBTUElDRV9ERUJVRygiJXM6
IGNhbid0IG9wZW4gc3RyZWFtIG9uICVzIiwgX19GVU5DVElPTl9fLCB1bml0LT5maWxlbmFtZSk7
CisgICAgICAgIHJldHVybiAtMTsKKyAgICB9CisgICAgcmV0dXJuIDA7CiB9CiAKIHN0YXRpYyBp
bnQgY2RfZGV2aWNlX2xvYWQoU3BpY2VDZExVICp1bml0LCBnYm9vbGVhbiBsb2FkKQpAQCAtMzQ5
LDcgKzM0NCw2IEBAIHN0YXRpYyBnYm9vbGVhbiBvcGVuX3N0cmVhbShTcGljZUNkTFUgKnVuaXQs
IGNvbnN0IGNoYXIgKmZpbGVuYW1lKQogc3RhdGljIHZvaWQgY2xvc2Vfc3RyZWFtKFNwaWNlQ2RM
VSAqdW5pdCkKIHsKICAgICBnX2NsZWFyX29iamVjdCgmdW5pdC0+c3RyZWFtKTsKLSAgICBnX2Ns
ZWFyX29iamVjdCgmdW5pdC0+ZmlsZV9vYmplY3QpOwogfQogCiBzdGF0aWMgZ2Jvb2xlYW4gbG9h
ZF9sdW4oVXNiQ2QgKmQsIGludCB1bml0LCBnYm9vbGVhbiBsb2FkKQotLSAKMi4yMC4xCgpfX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpTcGljZS1kZXZlbCBt
YWlsaW5nIGxpc3QKU3BpY2UtZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlz
dHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vc3BpY2UtZGV2ZWw=
