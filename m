Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id A17CE66056
	for <lists+spice-devel@lfdr.de>; Thu, 11 Jul 2019 22:03:23 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 86CC76E285;
	Thu, 11 Jul 2019 20:03:21 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mail.codeweavers.com (mail.codeweavers.com [50.203.203.244])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 116286E285
 for <spice-devel@lists.freedesktop.org>; Thu, 11 Jul 2019 20:03:20 +0000 (UTC)
Received: from cpe-107-184-2-226.socal.res.rr.com ([107.184.2.226]
 helo=brendan-dell.bslabs.net)
 by mail.codeweavers.com with esmtpsa (TLS1.2:ECDHE_RSA_AES_128_GCM_SHA256:128)
 (Exim 4.89) (envelope-from <bshanks@codeweavers.com>)
 id 1hlfI6-0003YV-08; Thu, 11 Jul 2019 15:03:43 -0500
From: Brendan Shanks <bshanks@codeweavers.com>
To: spice-devel@lists.freedesktop.org
Date: Thu, 11 Jul 2019 13:03:05 -0700
Message-Id: <20190711200305.4616-1-bshanks@codeweavers.com>
X-Mailer: git-send-email 2.17.1
X-Spam-Score: -106.0
X-Spam-Report: Spam detection software,
 running on the system "mail.codeweavers.com", 
 has NOT identified this incoming email as spam.  The original
 message has been attached to this so you can view it or label
 similar future email.  If you have any questions, see
 the administrator of that system for details.
 Content preview: Add a cache to allow the reuse of SHM segments. Shared memory
 segments are added to the cache instead of being deallocated, and the cache
 is searched instead of/before allocating a new segment. Both the SHM segments
 and their attachment with the X server are cached. 
 Content analysis details:   (-106.0 points, 5.0 required)
 pts rule name              description
 ---- ---------------------- --------------------------------------------------
 -100 USER_IN_WHITELIST      From: address is in the user's white-list
 -6.0 ALL_TRUSTED            Passed through trusted hosts only via SMTP
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt;
 c=relaxed/relaxed; 
 d=codeweavers.com; s=6377696661; h=Message-Id:Date:Subject:Cc:To:From:Sender:
 Reply-To:MIME-Version:Content-Type:Content-Transfer-Encoding:Content-ID:
 Content-Description:Resent-Date:Resent-From:Resent-Sender:Resent-To:Resent-Cc
 :Resent-Message-ID:In-Reply-To:References:List-Id:List-Help:List-Unsubscribe:
 List-Subscribe:List-Post:List-Owner:List-Archive;
 bh=5jRO1Djg++fTwDnlB/lV2TxumGpNzoqq3fEOaml+c9I=; b=riqjKZUSX6rrtbfOfuUF3B7Gxu
 q2n02soXEvnMKaWOT1QA7RNcUY2LE+t+qfgAOBeJ0vx1d7vYa7DFgWT353RY+tzWTijrWdugEcKCL
 lf1HPXHcco5nlcPPi7KHs9MuZAz1TIPj+nqRHX5hvP6dzDyetmfetJcPkNu8pnt+mwXM=;
Subject: [Spice-devel] [PATCH x11spice] Add cache for SHM segments
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

QWRkIGEgY2FjaGUgdG8gYWxsb3cgdGhlIHJldXNlIG9mIFNITSBzZWdtZW50cy4KU2hhcmVkIG1l
bW9yeSBzZWdtZW50cyBhcmUgYWRkZWQgdG8gdGhlIGNhY2hlIGluc3RlYWQgb2YgYmVpbmcKZGVh
bGxvY2F0ZWQsIGFuZCB0aGUgY2FjaGUgaXMgc2VhcmNoZWQgaW5zdGVhZCBvZi9iZWZvcmUgYWxs
b2NhdGluZyBhCm5ldyBzZWdtZW50LgoKQm90aCB0aGUgU0hNIHNlZ21lbnRzIGFuZCB0aGVpciBh
dHRhY2htZW50IHdpdGggdGhlIFggc2VydmVyIGFyZSBjYWNoZWQuCgpUaGUgY2FjaGUgY3VycmVu
dGx5IGhhcyBhIGZpeGVkIG51bWJlciBvZiAxMCBlbnRyaWVzLCB0aGlzIHByb3ZpZGVkIGEKZ29v
ZCBjYWNoZSBoaXQgcmF0ZSB3aGlsZSBrZWVwaW5nIG1lbW9yeSB1c2FnZSB1bmRlciBjb250cm9s
LgpJbiBteSB0ZXN0aW5nLCBvdmVyIDkwJSBvZiByZXF1ZXN0cyBmb3IgU0hNIHNlZ21lbnRzIHdl
cmUgYmVpbmcKc2F0aXNmaWVkIGZyb20gdGhlIGNhY2hlLgoKU2lnbmVkLW9mZi1ieTogQnJlbmRh
biBTaGFua3MgPGJzaGFua3NAY29kZXdlYXZlcnMuY29tPgotLS0KIHNyYy9kaXNwbGF5LmMgfCAx
NzIgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKy0tLS0tLS0KIHNy
Yy9kaXNwbGF5LmggfCAgMTIgKysrKwogMiBmaWxlcyBjaGFuZ2VkLCAxNjIgaW5zZXJ0aW9ucygr
KSwgMjIgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvc3JjL2Rpc3BsYXkuYyBiL3NyYy9kaXNw
bGF5LmMKaW5kZXggMDFlMGU4NS4uMzQ2ZDMxMCAxMDA2NDQKLS0tIGEvc3JjL2Rpc3BsYXkuYwor
KysgYi9zcmMvZGlzcGxheS5jCkBAIC0yMTMsMTEgKzIxMywxMjUgQEAgc3RhdGljIGludCByZWdp
c3Rlcl9mb3JfZXZlbnRzKGRpc3BsYXlfdCAqZCkKICAgICByZXR1cm4gMDsKIH0KIAorc3RhdGlj
IHZvaWQgc2htX2NhY2hlX2VudHJ5X2Rlc3Ryb3koZGlzcGxheV90ICpkLCBzaG1fY2FjaGVfZW50
cnlfdCAqZW50cnkpCit7CisgICAgaWYgKGVudHJ5LT5zaG1pZCA9PSAtMSkKKyAgICAgICAgcmV0
dXJuOworCisgICAgeGNiX3NobV9kZXRhY2goZC0+YywgZW50cnktPnNobXNlZyk7CisgICAgc2ht
ZHQoZW50cnktPnNobWFkZHIpOworICAgIHNobWN0bChlbnRyeS0+c2htaWQsIElQQ19STUlELCBO
VUxMKTsKKyAgICBlbnRyeS0+c2htaWQgPSAtMTsKK30KKworc3RhdGljIGludCBzaG1fY2FjaGVf
Z2V0KGRpc3BsYXlfdCAqZCwgaW50IHNpemUsIHNobV9pbWFnZV90ICpzaG1pKQoreworICAgIGlu
dCBpOworCisgICAgZ19tdXRleF9sb2NrKCZkLT5zaG1fY2FjaGVfbXV0ZXgpOworCisgICAgLyog
Rmlyc3QgY2hlY2sgZm9yIGEgY2FjaGUgZW50cnkgb2YgdGhlIGV4YWN0IHNpemUgYmVpbmcgcmVx
dWVzdGVkICovCisgICAgZm9yIChpID0gMDsgaSA8IHNpemVvZihkLT5zaG1fY2FjaGUpIC8gc2l6
ZW9mKGQtPnNobV9jYWNoZVswXSk7IGkrKykgeworICAgICAgICBzaG1fY2FjaGVfZW50cnlfdCAq
ZW50cnkgPSAmZC0+c2htX2NhY2hlW2ldOworCisgICAgICAgIGlmIChlbnRyeS0+c2htaWQgPT0g
LTEgfHwgc2l6ZSAhPSBlbnRyeS0+c2l6ZSkKKyAgICAgICAgICAgIGNvbnRpbnVlOworCisgICAg
ICAgIHNobWktPnNobWlkID0gZW50cnktPnNobWlkOworICAgICAgICBzaG1pLT5zaG1zZWcgPSBl
bnRyeS0+c2htc2VnOworICAgICAgICBzaG1pLT5zaG1hZGRyID0gZW50cnktPnNobWFkZHI7Cisg
ICAgICAgIHNobWktPnNobXNpemUgPSBlbnRyeS0+c2l6ZTsKKyAgICAgICAgZW50cnktPnNobWlk
ID0gLTE7CisKKyAgICAgICAgZ19tdXRleF91bmxvY2soJmQtPnNobV9jYWNoZV9tdXRleCk7Cisg
ICAgICAgIHJldHVybiAxOworICAgIH0KKworICAgIC8qIEFuIGV4YWN0LXNpemUgZW50cnkgd2Fz
bid0IGZvdW5kLCBsb29rIGZvciB0aGUgZmlyc3QgZW50cnkgdGhhdCdzIGJpZyBlbm91Z2ggKi8K
KyAgICBmb3IgKGkgPSAwOyBpIDwgc2l6ZW9mKGQtPnNobV9jYWNoZSkgLyBzaXplb2YoZC0+c2ht
X2NhY2hlWzBdKTsgaSsrKSB7CisgICAgICAgIHNobV9jYWNoZV9lbnRyeV90ICplbnRyeSA9ICZk
LT5zaG1fY2FjaGVbaV07CisKKyAgICAgICAgaWYgKGVudHJ5LT5zaG1pZCA9PSAtMSB8fCBzaXpl
ID4gZW50cnktPnNpemUpCisgICAgICAgICAgICBjb250aW51ZTsKKworICAgICAgICBzaG1pLT5z
aG1pZCA9IGVudHJ5LT5zaG1pZDsKKyAgICAgICAgc2htaS0+c2htc2VnID0gZW50cnktPnNobXNl
ZzsKKyAgICAgICAgc2htaS0+c2htYWRkciA9IGVudHJ5LT5zaG1hZGRyOworICAgICAgICBzaG1p
LT5zaG1zaXplID0gZW50cnktPnNpemU7CisgICAgICAgIGVudHJ5LT5zaG1pZCA9IC0xOworCisg
ICAgICAgIGdfbXV0ZXhfdW5sb2NrKCZkLT5zaG1fY2FjaGVfbXV0ZXgpOworICAgICAgICByZXR1
cm4gMTsKKyAgICB9CisKKyAgICAvKiBObyB1c2FibGUgZW50cnkgZm91bmQgaW4gdGhlIGNhY2hl
ICovCisgICAgZ19tdXRleF91bmxvY2soJmQtPnNobV9jYWNoZV9tdXRleCk7CisgICAgcmV0dXJu
IDA7Cit9CisKK3N0YXRpYyBpbnQgc2htX2NhY2hlX2FkZChkaXNwbGF5X3QgKmQsIHNobV9pbWFn
ZV90ICpzaG1pKQoreworICAgIGludCBpOworCisgICAgZ19tdXRleF9sb2NrKCZkLT5zaG1fY2Fj
aGVfbXV0ZXgpOworCisgICAgLyogU2VhcmNoIGNhY2hlIGFuZCB1c2UgdGhlIGZpcnN0IGVtcHR5
IGVudHJ5ICovCisgICAgZm9yIChpID0gMDsgaSA8IHNpemVvZihkLT5zaG1fY2FjaGUpIC8gc2l6
ZW9mKGQtPnNobV9jYWNoZVswXSk7IGkrKykgeworICAgICAgICBzaG1fY2FjaGVfZW50cnlfdCAq
ZW50cnkgPSAmZC0+c2htX2NhY2hlW2ldOworCisgICAgICAgIGlmIChlbnRyeS0+c2htaWQgIT0g
LTEpCisgICAgICAgICAgICBjb250aW51ZTsKKworICAgICAgICBlbnRyeS0+c2htaWQgPSBzaG1p
LT5zaG1pZDsKKyAgICAgICAgZW50cnktPnNobXNlZyA9IHNobWktPnNobXNlZzsKKyAgICAgICAg
ZW50cnktPnNobWFkZHIgPSBzaG1pLT5zaG1hZGRyOworICAgICAgICBlbnRyeS0+c2l6ZSA9IHNo
bWktPnNobXNpemU7CisKKyAgICAgICAgZ19tdXRleF91bmxvY2soJmQtPnNobV9jYWNoZV9tdXRl
eCk7CisgICAgICAgIHJldHVybiAxOworICAgIH0KKworICAgIC8qIENhY2hlIGlzIGZ1bGwuIFNl
YXJjaCBhZ2FpbiwgYnV0IHRoaXMgdGltZSBldmljdCB0aGUgZmlyc3QgZW50cnkgc21hbGxlciB0
aGFuIHRoZSBvbmUgYmVpbmcgYWRkZWQgKi8KKyAgICAvKiBUT0RPOiBhIHBvc3NpYmxlIG9wdGlt
aXphdGlvbjogcmVtb3ZlIHRoZSBzbWFsbGVzdCBlbnRyeSBpbiB0aGUgY2FjaGUsIHJhdGhlciB0
aGFuIGp1c3QgdGhlIGZpcnN0IHNtYWxsZXIgb25lICovCisgICAgZm9yIChpID0gMDsgaSA8IHNp
emVvZihkLT5zaG1fY2FjaGUpIC8gc2l6ZW9mKGQtPnNobV9jYWNoZVswXSk7IGkrKykgeworICAg
ICAgICBzaG1fY2FjaGVfZW50cnlfdCAqZW50cnkgPSAmZC0+c2htX2NhY2hlW2ldOworCisgICAg
ICAgIGlmIChlbnRyeS0+c2htaWQgIT0gLTEgJiYgZW50cnktPnNpemUgPCBzaG1pLT5zaG1zaXpl
KSB7CisgICAgICAgICAgICBzaG1fY2FjaGVfZW50cnlfZGVzdHJveShkLCBlbnRyeSk7CisKKyAg
ICAgICAgICAgIGVudHJ5LT5zaG1pZCA9IHNobWktPnNobWlkOworICAgICAgICAgICAgZW50cnkt
PnNobXNlZyA9IHNobWktPnNobXNlZzsKKyAgICAgICAgICAgIGVudHJ5LT5zaG1hZGRyID0gc2ht
aS0+c2htYWRkcjsKKyAgICAgICAgICAgIGVudHJ5LT5zaXplID0gc2htaS0+c2htc2l6ZTsKKwor
ICAgICAgICAgICAgZ19tdXRleF91bmxvY2soJmQtPnNobV9jYWNoZV9tdXRleCk7CisgICAgICAg
ICAgICByZXR1cm4gMTsKKyAgICAgICAgfQorICAgIH0KKworICAgIC8qIENhY2hlIGlzIGZ1bGws
IGFuZCBjb250YWluZWQgbm8gZW50cmllcyBzbWFsbGVyIHRoYW4gdGhlIG9uZSBiZWluZyBhZGRl
ZCAqLworICAgIGdfbXV0ZXhfdW5sb2NrKCZkLT5zaG1fY2FjaGVfbXV0ZXgpOworICAgIHJldHVy
biAwOworfQorCitzdGF0aWMgdm9pZCBzaG1fY2FjaGVfZGVzdHJveShkaXNwbGF5X3QgKmQpCit7
CisgICAgaW50IGk7CisKKyAgICBnX211dGV4X2xvY2soJmQtPnNobV9jYWNoZV9tdXRleCk7Cisg
ICAgZm9yIChpID0gMDsgaSA8IHNpemVvZihkLT5zaG1fY2FjaGUpIC8gc2l6ZW9mKGQtPnNobV9j
YWNoZVswXSk7IGkrKykgeworICAgICAgICBzaG1fY2FjaGVfZW50cnlfdCAqZW50cnkgPSAmZC0+
c2htX2NhY2hlW2ldOworCisgICAgICAgIHNobV9jYWNoZV9lbnRyeV9kZXN0cm95KGQsIGVudHJ5
KTsKKyAgICB9CisgICAgZ19tdXRleF91bmxvY2soJmQtPnNobV9jYWNoZV9tdXRleCk7Cit9CiAK
IGludCBkaXNwbGF5X29wZW4oZGlzcGxheV90ICpkLCBzZXNzaW9uX3QgKnNlc3Npb24pCiB7CiAg
ICAgaW50IHNjcjsKICAgICBpbnQgcmM7CisgICAgaW50IGk7CiAgICAgeGNiX2RhbWFnZV9xdWVy
eV92ZXJzaW9uX2Nvb2tpZV90IGRjb29raWU7CiAgICAgeGNiX2RhbWFnZV9xdWVyeV92ZXJzaW9u
X3JlcGx5X3QgKmRhbWFnZV92ZXJzaW9uOwogICAgIHhjYl94a2JfdXNlX2V4dGVuc2lvbl9jb29r
aWVfdCB1c2VfY29va2llOwpAQCAtMzE0LDYgKzQyOCwxMSBAQCBpbnQgZGlzcGxheV9vcGVuKGRp
c3BsYXlfdCAqZCwgc2Vzc2lvbl90ICpzZXNzaW9uKQogICAgIGlmIChyYykKICAgICAgICAgcmV0
dXJuIHJjOwogCisgICAgZ19tdXRleF9pbml0KCZkLT5zaG1fY2FjaGVfbXV0ZXgpOworICAgIGZv
ciAoaSA9IDA7IGkgPCBzaXplb2YoZC0+c2htX2NhY2hlKSAvIHNpemVvZihkLT5zaG1fY2FjaGVb
MF0pOyBpKyspIHsKKyAgICAgICAgZC0+c2htX2NhY2hlW2ldLnNobWlkID0gLTE7CisgICAgfQor
CiAgICAgcmMgPSBkaXNwbGF5X2NyZWF0ZV9zY3JlZW5faW1hZ2VzKGQpOwogCiAgICAgZ19tZXNz
YWdlKCJEaXNwbGF5ICVzIG9wZW5lZCIsIHNlc3Npb24tPm9wdGlvbnMuZGlzcGxheSA/IHNlc3Np
b24tPm9wdGlvbnMuZGlzcGxheSA6ICIiKTsKQEAgLTM0OSwyNSArNDY4LDI5IEBAIHNobV9pbWFn
ZV90ICpjcmVhdGVfc2htX2ltYWdlKGRpc3BsYXlfdCAqZCwgaW50IHcsIGludCBoKQogICAgIHNo
bWktPmJ5dGVzX3Blcl9saW5lID0gKGJpdHNfcGVyX3BpeGVsKGQpIC8gOCkgKiBzaG1pLT53Owog
ICAgIGltZ3NpemUgPSBzaG1pLT5ieXRlc19wZXJfbGluZSAqIHNobWktPmg7CiAKLSAgICBzaG1p
LT5zaG1pZCA9IHNobWdldChJUENfUFJJVkFURSwgaW1nc2l6ZSwgSVBDX0NSRUFUIHwgMDcwMCk7
Ci0gICAgaWYgKHNobWktPnNobWlkICE9IC0xKQotICAgICAgICBzaG1pLT5zaG1hZGRyID0gc2ht
YXQoc2htaS0+c2htaWQsIDAsIDApOwotICAgIGlmIChzaG1pLT5zaG1pZCA9PSAtMSB8fCBzaG1p
LT5zaG1hZGRyID09ICh2b2lkICopIC0xKSB7Ci0gICAgICAgIGdfd2FybmluZygiQ2Fubm90IGdl
dCBzaGFyZWQgbWVtb3J5IG9mIHNpemUgJWQ7IGVycm5vICVkIiwgaW1nc2l6ZSwgZXJybm8pOwot
ICAgICAgICBmcmVlKHNobWkpOwotICAgICAgICByZXR1cm4gTlVMTDsKLSAgICB9Ci0gICAgLyog
V2UgdGVsbCBzaG1jdGwgdG8gZGV0YWNoIG5vdzsgdGhhdCBwcmV2ZW50cyB1cyBmcm9tIGhvbGRp
bmcgdGhpcwotICAgICAgIHNoYXJlZCBtZW1vcnkgc2VnbWVudCBmb3JldmVyIGluIGNhc2Ugb2Yg
YWJub3JtYWwgcHJvY2VzcyBleGl0LiAqLwotICAgIHNobWN0bChzaG1pLT5zaG1pZCwgSVBDX1JN
SUQsIE5VTEwpOwotCi0gICAgc2htaS0+c2htc2VnID0geGNiX2dlbmVyYXRlX2lkKGQtPmMpOwot
ICAgIGNvb2tpZSA9IHhjYl9zaG1fYXR0YWNoX2NoZWNrZWQoZC0+Yywgc2htaS0+c2htc2VnLCBz
aG1pLT5zaG1pZCwgMCk7Ci0gICAgZXJyb3IgPSB4Y2JfcmVxdWVzdF9jaGVjayhkLT5jLCBjb29r
aWUpOwotICAgIGlmIChlcnJvcikgewotICAgICAgICBnX3dhcm5pbmcoIkNvdWxkIG5vdCBhdHRh
Y2g7IHR5cGUgJWQ7IGNvZGUgJWQ7IG1ham9yICVkOyBtaW5vciAlZFxuIiwKLSAgICAgICAgICAg
ICAgICBlcnJvci0+cmVzcG9uc2VfdHlwZSwgZXJyb3ItPmVycm9yX2NvZGUsIGVycm9yLT5tYWpv
cl9jb2RlLCBlcnJvci0+bWlub3JfY29kZSk7Ci0gICAgICAgIHJldHVybiBOVUxMOworICAgIGlm
ICghc2htX2NhY2hlX2dldChkLCBpbWdzaXplLCBzaG1pKSkgeworICAgICAgICAvKiBObyB1c2Fi
bGUgc2hhcmVkIG1lbW9yeSBzZWdtZW50IGZvdW5kIGluIGNhY2hlLCBhbGxvY2F0ZSBhIG5ldyBv
bmUgKi8KKyAgICAgICAgc2htaS0+c2htaWQgPSBzaG1nZXQoSVBDX1BSSVZBVEUsIGltZ3NpemUs
IElQQ19DUkVBVCB8IDA3MDApOworICAgICAgICBpZiAoc2htaS0+c2htaWQgIT0gLTEpCisgICAg
ICAgICAgICBzaG1pLT5zaG1hZGRyID0gc2htYXQoc2htaS0+c2htaWQsIDAsIDApOworICAgICAg
ICBpZiAoc2htaS0+c2htaWQgPT0gLTEgfHwgc2htaS0+c2htYWRkciA9PSAodm9pZCAqKSAtMSkg
eworICAgICAgICAgICAgZ193YXJuaW5nKCJDYW5ub3QgZ2V0IHNoYXJlZCBtZW1vcnkgb2Ygc2l6
ZSAlZDsgZXJybm8gJWQiLCBpbWdzaXplLCBlcnJubyk7CisgICAgICAgICAgICBmcmVlKHNobWkp
OworICAgICAgICAgICAgcmV0dXJuIE5VTEw7CisgICAgICAgIH0KKyAgICAgICAgLyogV2UgdGVs
bCBzaG1jdGwgdG8gZGV0YWNoIG5vdzsgdGhhdCBwcmV2ZW50cyB1cyBmcm9tIGhvbGRpbmcgdGhp
cworICAgICAgICAgICBzaGFyZWQgbWVtb3J5IHNlZ21lbnQgZm9yZXZlciBpbiBjYXNlIG9mIGFi
bm9ybWFsIHByb2Nlc3MgZXhpdC4gKi8KKyAgICAgICAgc2htY3RsKHNobWktPnNobWlkLCBJUENf
Uk1JRCwgTlVMTCk7CisgICAgICAgIHNobWktPnNobXNpemUgPSBpbWdzaXplOworCisgICAgICAg
IHNobWktPnNobXNlZyA9IHhjYl9nZW5lcmF0ZV9pZChkLT5jKTsKKyAgICAgICAgY29va2llID0g
eGNiX3NobV9hdHRhY2hfY2hlY2tlZChkLT5jLCBzaG1pLT5zaG1zZWcsIHNobWktPnNobWlkLCAw
KTsKKyAgICAgICAgZXJyb3IgPSB4Y2JfcmVxdWVzdF9jaGVjayhkLT5jLCBjb29raWUpOworICAg
ICAgICBpZiAoZXJyb3IpIHsKKyAgICAgICAgICAgIGdfd2FybmluZygiQ291bGQgbm90IGF0dGFj
aDsgdHlwZSAlZDsgY29kZSAlZDsgbWFqb3IgJWQ7IG1pbm9yICVkXG4iLAorICAgICAgICAgICAg
ICAgICAgICBlcnJvci0+cmVzcG9uc2VfdHlwZSwgZXJyb3ItPmVycm9yX2NvZGUsIGVycm9yLT5t
YWpvcl9jb2RlLCBlcnJvci0+bWlub3JfY29kZSk7CisgICAgICAgICAgICByZXR1cm4gTlVMTDsK
KyAgICAgICAgfQogICAgIH0KIAogICAgIHJldHVybiBzaG1pOwpAQCAtNDUxLDkgKzU3NCwxMiBA
QCB2b2lkIGRpc3BsYXlfY29weV9pbWFnZV9pbnRvX2Z1bGxzY3JlZW4oZGlzcGxheV90ICpkLCBz
aG1faW1hZ2VfdCAqc2htaSwgaW50IHgsCiAKIHZvaWQgZGVzdHJveV9zaG1faW1hZ2UoZGlzcGxh
eV90ICpkLCBzaG1faW1hZ2VfdCAqc2htaSkKIHsKLSAgICB4Y2Jfc2htX2RldGFjaChkLT5jLCBz
aG1pLT5zaG1zZWcpOwotICAgIHNobWR0KHNobWktPnNobWFkZHIpOwotICAgIHNobWN0bChzaG1p
LT5zaG1pZCwgSVBDX1JNSUQsIE5VTEwpOworICAgIGlmICghc2htX2NhY2hlX2FkZChkLCBzaG1p
KSkgeworICAgICAgICAvKiBDb3VsZCBub3QgYWRkIHRvIGNhY2hlLCBkZXN0cm95IHRoaXMgc2Vn
bWVudCAqLworICAgICAgICB4Y2Jfc2htX2RldGFjaChkLT5jLCBzaG1pLT5zaG1zZWcpOworICAg
ICAgICBzaG1kdChzaG1pLT5zaG1hZGRyKTsKKyAgICAgICAgc2htY3RsKHNobWktPnNobWlkLCBJ
UENfUk1JRCwgTlVMTCk7CisgICAgfQogICAgIGlmIChzaG1pLT5kcmF3YWJsZV9wdHIpCiAgICAg
ICAgIGZyZWUoc2htaS0+ZHJhd2FibGVfcHRyKTsKICAgICBmcmVlKHNobWkpOwpAQCAtNTAzLDYg
KzYyOSw4IEBAIHZvaWQgZGlzcGxheV9zdG9wX2V2ZW50X3RocmVhZChkaXNwbGF5X3QgKmQpCiAK
IHZvaWQgZGlzcGxheV9jbG9zZShkaXNwbGF5X3QgKmQpCiB7CisgICAgc2htX2NhY2hlX2Rlc3Ry
b3koZCk7CisgICAgZ19tdXRleF9jbGVhcigmZC0+c2htX2NhY2hlX211dGV4KTsKICAgICB4Y2Jf
ZGFtYWdlX2Rlc3Ryb3koZC0+YywgZC0+ZGFtYWdlKTsKICAgICBkaXNwbGF5X2Rlc3Ryb3lfc2Ny
ZWVuX2ltYWdlcyhkKTsKICAgICB4Y2JfZGlzY29ubmVjdChkLT5jKTsKZGlmZiAtLWdpdCBhL3Ny
Yy9kaXNwbGF5LmggYi9zcmMvZGlzcGxheS5oCmluZGV4IGRjNDI1NGIuLjE3NTUxMmUgMTAwNjQ0
Ci0tLSBhL3NyYy9kaXNwbGF5LmgKKysrIGIvc3JjL2Rpc3BsYXkuaApAQCAtMjEsNiArMjEsNyBA
QAogI2lmbmRlZiBESVNQTEFZX0hfCiAjZGVmaW5lIERJU1BMQVlfSF8KIAorI2luY2x1ZGUgPGds
aWIuaD4KICNpbmNsdWRlIDx4Y2IveGNiLmg+CiAjaW5jbHVkZSA8eGNiL2RhbWFnZS5oPgogI2lu
Y2x1ZGUgPHhjYi9zaG0uaD4KQEAgLTM5LDggKzQwLDE2IEBAIHR5cGVkZWYgc3RydWN0IHsKICAg
ICB4Y2Jfc2htX3NlZ190IHNobXNlZzsKICAgICB2b2lkICpzaG1hZGRyOwogICAgIHZvaWQgKmRy
YXdhYmxlX3B0cjsKKyAgICBpbnQgc2htc2l6ZTsKIH0gc2htX2ltYWdlX3Q7CiAKK3R5cGVkZWYg
c3RydWN0IHsKKyAgICBpbnQgc2htaWQ7CisgICAgaW50IHNpemU7CisgICAgeGNiX3NobV9zZWdf
dCBzaG1zZWc7CisgICAgdm9pZCAqc2htYWRkcjsKK30gc2htX2NhY2hlX2VudHJ5X3Q7CisKIHR5
cGVkZWYgc3RydWN0IHsKICAgICB4Y2JfY29ubmVjdGlvbl90ICpjOwogICAgIHhjYl93aW5kb3df
dCByb290OwpAQCAtNTgsNiArNjcsOSBAQCB0eXBlZGVmIHN0cnVjdCB7CiAgICAgc2htX2ltYWdl
X3QgKmZ1bGxzY3JlZW47CiAgICAgc2htX2ltYWdlX3QgKnNjYW5saW5lOwogCisgICAgc2htX2Nh
Y2hlX2VudHJ5X3Qgc2htX2NhY2hlWzEwXTsKKyAgICBHTXV0ZXggc2htX2NhY2hlX211dGV4Owor
CiAgICAgcHRocmVhZF90IGV2ZW50X3RocmVhZDsKICAgICBzdHJ1Y3Qgc2Vzc2lvbl9zdHJ1Y3Qg
KnNlc3Npb247CiB9IGRpc3BsYXlfdDsKLS0gCjIuMTcuMQoKX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX18KU3BpY2UtZGV2ZWwgbWFpbGluZyBsaXN0ClNwaWNl
LWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9y
Zy9tYWlsbWFuL2xpc3RpbmZvL3NwaWNlLWRldmVs
