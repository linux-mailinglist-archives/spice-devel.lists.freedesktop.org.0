Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 7C5E1D5EAF
	for <lists+spice-devel@lfdr.de>; Mon, 14 Oct 2019 11:22:31 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id CFFB86E1ED;
	Mon, 14 Oct 2019 09:22:29 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id D24916E1ED
 for <spice-devel@lists.freedesktop.org>; Mon, 14 Oct 2019 09:22:27 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx03.intmail.prod.int.phx2.redhat.com
 [10.5.11.13])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 7D16B308620E
 for <spice-devel@lists.freedesktop.org>; Mon, 14 Oct 2019 09:22:27 +0000 (UTC)
Received: from fziglio.remote.csb (unknown [10.33.32.20])
 by smtp.corp.redhat.com (Postfix) with ESMTP id 51E4D60619;
 Mon, 14 Oct 2019 09:22:26 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Mon, 14 Oct 2019 10:22:13 +0100
Message-Id: <20191014092217.24405-4-fziglio@redhat.com>
In-Reply-To: <20191014092217.24405-1-fziglio@redhat.com>
References: <20191014092217.24405-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.13
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.42]); Mon, 14 Oct 2019 09:22:27 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-server v2 3/7] red-client: Avoid stale
 channel client after disconnection
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: cfergeau@redhat.com
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

RGlzY29ubmVjdGluZyBhIHNpbmdsZSBjaGFubmVsIGZyb20gdGhlIGNsaWVudCBjYXVzZWQgdGhl
IHNlcnZlciB0bwprZWVwIGEgc3RhbGUgY2hhbm5lbCBjbGllbnQgKFJlZENoYW5uZWxDbGllbnQg
b2JqZWN0KSB0aWxsIHRoZSBjbGllbnQKKFJlZENsaWVudCBvYmplY3QpIGVudGlyZWx5IGRpc2Nv
bm5lY3RlZCwgdGhhdCBpcyB0aGUgY2hhbm5lbCBjbGllbnQKaXMgZGlzY29ubmVjdGVkIGJ1dCBz
dGlsbCBpbiB0aGUgbGlzdCBwcmV2ZW50aW5nIG5ldyBjb25uZWN0aW9ucy4KQ2FsbGluZyByZWRf
Y2xpZW50X3JlbW92ZV9jaGFubmVsIGZyb20gcmVkX2NoYW5uZWxfY2xpZW50X2Rpc2Nvbm5lY3QK
Zml4ZXMgdGhpcyBsYXN0IGlzc3VlLgpBbiBpc3N1ZSB3YXMgdGhhdCB3YXMgbm90IGNsZWFyIGhv
dyB0aGUgb3duZXJzaGlwIHdlcmUgbWFuYWdlZC4gV2hlbgpyZWRfY2xpZW50X2Rlc3Ryb3kgd2Fz
IGNhbGxlZCByZWRfY2hhbm5lbF9jbGllbnRfZGVzdHJveSB3YXMgY2FsbGVkCndoaWNoIGZyZWVk
IHRoZSBSZWRDaGFubmVsQ2xpZW50IG9iamVjdCBzbyB0aGlzIHNob3VsZCBpbXBseQpvd25lcnNo
aXAuCkhvd2V2ZXIgc2FtZSByZWRfY2hhbm5lbF9jbGllbnRfZGVzdHJveSBjYWxsIHdhcyBhdHRl
bXB0ZWQgYnkKUmVkQ2hhbm5lbCB1c2luZyBpdHMgbGlzdCAocmVkX2NoYW5uZWxfZGVzdHJveSku
IEJhc2ljYWxseSB0aGUgdHdvCnBvaW50ZXJzICh0aGUgb25lIGZyb20gdGhlIGNoYW5uZWwgYW5k
IHRoZSBvbmUgZnJvbSB0aGUgY2xpZW50KSB3ZXJlCmNvbnNpZGVyZWQgYXMgb25lIG93bmVyc2hp
cC4gVG8gYXZvaWQgdGhlIGNvbmZ1c2lvbiBub3cgdGhlIGNsaWVudApsaXN0IGFsd2F5cyBkZWNy
ZW1lbnQgdGhlIGNvdW50ZXIuCgpTaWduZWQtb2ZmLWJ5OiBGcmVkaWFubyBaaWdsaW8gPGZ6aWds
aW9AcmVkaGF0LmNvbT4KLS0tCiBzZXJ2ZXIvZGNjLmMgICAgICAgICAgICAgICAgfCAgMiArKwog
c2VydmVyL3JlZC1jaGFubmVsLWNsaWVudC5jIHwgMTMgKysrKysrKysrKystLQogc2VydmVyL3Jl
ZC1jbGllbnQuYyAgICAgICAgIHwgIDkgKysrKysrKystCiAzIGZpbGVzIGNoYW5nZWQsIDIxIGlu
c2VydGlvbnMoKyksIDMgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvc2VydmVyL2RjYy5jIGIv
c2VydmVyL2RjYy5jCmluZGV4IDUzOGYxZjUxYS4uYmE5ODMzMWRmIDEwMDY0NAotLS0gYS9zZXJ2
ZXIvZGNjLmMKKysrIGIvc2VydmVyL2RjYy5jCkBAIC01NzUsNiArNTc1LDcgQEAgdm9pZCBkY2Nf
c3RhcnQoRGlzcGxheUNoYW5uZWxDbGllbnQgKmRjYykKICAgICBpZiAoIWRpc3BsYXlfY2hhbm5l
bF9jbGllbnRfd2FpdF9mb3JfaW5pdChkY2MpKQogICAgICAgICByZXR1cm47CiAKKyAgICBnX29i
amVjdF9yZWYoZGNjKTsKICAgICByZWRfY2hhbm5lbF9jbGllbnRfYWNrX3plcm9fbWVzc2FnZXNf
d2luZG93KHJjYyk7CiAgICAgaWYgKGRpc3BsYXktPnByaXYtPnN1cmZhY2VzWzBdLmNvbnRleHQu
Y2FudmFzKSB7CiAgICAgICAgIGRpc3BsYXlfY2hhbm5lbF9jdXJyZW50X2ZsdXNoKGRpc3BsYXks
IDApOwpAQCAtNTkxLDYgKzU5Miw3IEBAIHZvaWQgZGNjX3N0YXJ0KERpc3BsYXlDaGFubmVsQ2xp
ZW50ICpkY2MpCiAgICAgICAgIHJlZF9jaGFubmVsX2NsaWVudF9waXBlX2FkZChyY2MsIGRjY19n
bF9zY2Fub3V0X2l0ZW1fbmV3KHJjYywgTlVMTCwgMCkpOwogICAgICAgICBkY2NfcHVzaF9tb25p
dG9yc19jb25maWcoZGNjKTsKICAgICB9CisgICAgZ19vYmplY3RfdW5yZWYoZGNjKTsKIH0KIAog
c3RhdGljIHZvaWQgZGNjX2Rlc3Ryb3lfc3RyZWFtX2FnZW50cyhEaXNwbGF5Q2hhbm5lbENsaWVu
dCAqZGNjKQpkaWZmIC0tZ2l0IGEvc2VydmVyL3JlZC1jaGFubmVsLWNsaWVudC5jIGIvc2VydmVy
L3JlZC1jaGFubmVsLWNsaWVudC5jCmluZGV4IGMzYWQ2ODE4My4uYTRhNTdjZTMyIDEwMDY0NAot
LS0gYS9zZXJ2ZXIvcmVkLWNoYW5uZWwtY2xpZW50LmMKKysrIGIvc2VydmVyL3JlZC1jaGFubmVs
LWNsaWVudC5jCkBAIC02ODYsNiArNjg2LDggQEAgc3RhdGljIHZvaWQgcmVkX2NoYW5uZWxfY2xp
ZW50X3BpbmdfdGltZXIodm9pZCAqb3BhcXVlKQogewogICAgIFJlZENoYW5uZWxDbGllbnQgKnJj
YyA9IG9wYXF1ZTsKIAorICAgIGdfb2JqZWN0X3JlZihyY2MpOworCiAgICAgc3BpY2VfYXNzZXJ0
KHJjYy0+cHJpdi0+bGF0ZW5jeV9tb25pdG9yLnN0YXRlID09IFBJTkdfU1RBVEVfVElNRVIpOwog
ICAgIHJlZF9jaGFubmVsX2NsaWVudF9jYW5jZWxfcGluZ190aW1lcihyY2MpOwogCkBAIC03MDAs
MTEgKzcwMiwxMyBAQCBzdGF0aWMgdm9pZCByZWRfY2hhbm5lbF9jbGllbnRfcGluZ190aW1lcih2
b2lkICpvcGFxdWUpCiAgICAgaWYgKHNvX3Vuc2VudF9zaXplID4gMCkgewogICAgICAgICAvKiB0
Y3Agc25kIGJ1ZmZlciBpcyBzdGlsbCBvY2N1cGllZC4gcmVzY2hlZHVsaW5nIHBpbmcgKi8KICAg
ICAgICAgcmVkX2NoYW5uZWxfY2xpZW50X3N0YXJ0X3BpbmdfdGltZXIocmNjLCBQSU5HX1RFU1Rf
SURMRV9ORVRfVElNRU9VVF9NUyk7CisgICAgICAgIGdfb2JqZWN0X3VucmVmKHJjYyk7CiAgICAg
ICAgIHJldHVybjsKICAgICB9CiAjZW5kaWYgLyogaWZkZWYgSEFWRV9MSU5VWF9TT0NLSU9TX0gg
Ki8KICAgICAvKiBNb3JlIHBvcnRhYmxlIGFsdGVybmF0aXZlIGNvZGUgcGF0aCAobGVzcyBhY2N1
cmF0ZSBidXQgYXZvaWRzIGJvZ3VzIGlvY3RscykqLwogICAgIHJlZF9jaGFubmVsX2NsaWVudF9w
dXNoX3BpbmcocmNjKTsKKyAgICBnX29iamVjdF91bnJlZihyY2MpOwogfQogCiBzdGF0aWMgaW5s
aW5lIGludCByZWRfY2hhbm5lbF9jbGllbnRfd2FpdGluZ19mb3JfYWNrKFJlZENoYW5uZWxDbGll
bnQgKnJjYykKQEAgLTczNiw2ICs3NDAsOCBAQCBzdGF0aWMgdm9pZCByZWRfY2hhbm5lbF9jbGll
bnRfY29ubmVjdGl2aXR5X3RpbWVyKHZvaWQgKm9wYXF1ZSkKICAgICBSZWRDaGFubmVsQ2xpZW50
Q29ubmVjdGl2aXR5TW9uaXRvciAqbW9uaXRvciA9ICZyY2MtPnByaXYtPmNvbm5lY3Rpdml0eV9t
b25pdG9yOwogICAgIGludCBpc19hbGl2ZSA9IFRSVUU7CiAKKyAgICBnX29iamVjdF9yZWYocmNj
KTsKKwogICAgIGlmIChtb25pdG9yLT5zdGF0ZSA9PSBDT05ORUNUSVZJVFlfU1RBVEVfQkxPQ0tF
RCkgewogICAgICAgICBpZiAoIW1vbml0b3ItPnJlY2VpdmVkX2J5dGVzICYmICFtb25pdG9yLT5z
ZW50X2J5dGVzKSB7CiAgICAgICAgICAgICBpZiAoIXJlZF9jaGFubmVsX2NsaWVudF9pc19ibG9j
a2VkKHJjYykgJiYgIXJlZF9jaGFubmVsX2NsaWVudF93YWl0aW5nX2Zvcl9hY2socmNjKSkgewpA
QCAtNzc2LDYgKzc4Miw3IEBAIHN0YXRpYyB2b2lkIHJlZF9jaGFubmVsX2NsaWVudF9jb25uZWN0
aXZpdHlfdGltZXIodm9pZCAqb3BhcXVlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJj
YywgbW9uaXRvci0+dGltZW91dCk7CiAgICAgICAgIHJlZF9jaGFubmVsX2NsaWVudF9kaXNjb25u
ZWN0KHJjYyk7CiAgICAgfQorICAgIGdfb2JqZWN0X3VucmVmKHJjYyk7CiB9CiAKIHZvaWQgcmVk
X2NoYW5uZWxfY2xpZW50X3N0YXJ0X2Nvbm5lY3Rpdml0eV9tb25pdG9yaW5nKFJlZENoYW5uZWxD
bGllbnQgKnJjYywgdWludDMyX3QgdGltZW91dF9tcykKQEAgLTEwMzksOCArMTA0Niw2IEBAIHZv
aWQgcmVkX2NoYW5uZWxfY2xpZW50X2Rlc3Ryb3koUmVkQ2hhbm5lbENsaWVudCAqcmNjKQogewog
ICAgIHJjYy0+cHJpdi0+ZGVzdHJveWluZyA9IFRSVUU7CiAgICAgcmVkX2NoYW5uZWxfY2xpZW50
X2Rpc2Nvbm5lY3QocmNjKTsKLSAgICByZWRfY2xpZW50X3JlbW92ZV9jaGFubmVsKHJjYyk7Ci0g
ICAgZ19vYmplY3RfdW5yZWYocmNjKTsKIH0KIAogdm9pZCByZWRfY2hhbm5lbF9jbGllbnRfc2h1
dGRvd24oUmVkQ2hhbm5lbENsaWVudCAqcmNjKQpAQCAtMTc1Myw2ICsxNzU4LDEwIEBAIHZvaWQg
cmVkX2NoYW5uZWxfY2xpZW50X2Rpc2Nvbm5lY3QoUmVkQ2hhbm5lbENsaWVudCAqcmNjKQogICAg
IH0KICAgICByZWRfY2hhbm5lbF9yZW1vdmVfY2xpZW50KGNoYW5uZWwsIHJjYyk7CiAgICAgcmVk
X2NoYW5uZWxfY2xpZW50X29uX2Rpc2Nvbm5lY3QocmNjKTsKKyAgICAvLyByZW1vdmUgY2xpZW50
IGZyb20gUmVkQ2xpZW50CisgICAgLy8gTk9URSB0aGlzIG1heSB0cmlnZ2VyIHRoZSBmcmVlIG9m
IHRoZSBvYmplY3QsIGlmIHdlIGFyZSBpbiBhIHdhdGNoL3RpbWVyCisgICAgLy8gd2Ugc2hvdWxk
IG1ha2Ugc3VyZSB3ZSBrZWVwIGEgcmVmZXJlbmNlCisgICAgcmVkX2NsaWVudF9yZW1vdmVfY2hh
bm5lbChyY2MpOwogfQogCiBnYm9vbGVhbiByZWRfY2hhbm5lbF9jbGllbnRfaXNfYmxvY2tlZChS
ZWRDaGFubmVsQ2xpZW50ICpyY2MpCmRpZmYgLS1naXQgYS9zZXJ2ZXIvcmVkLWNsaWVudC5jIGIv
c2VydmVyL3JlZC1jbGllbnQuYwppbmRleCAwMTlkYTVhMmIuLmQ3M2QwZjhkMCAxMDA2NDQKLS0t
IGEvc2VydmVyL3JlZC1jbGllbnQuYworKysgYi9zZXJ2ZXIvcmVkLWNsaWVudC5jCkBAIC0yMzQs
NiArMjM0LDcgQEAgdm9pZCByZWRfY2xpZW50X2Rlc3Ryb3koUmVkQ2xpZW50ICpjbGllbnQpCiAg
ICAgICAgIHNwaWNlX2Fzc2VydChyZWRfY2hhbm5lbF9jbGllbnRfbm9faXRlbV9iZWluZ19zZW50
KHJjYykpOwogCiAgICAgICAgIHJlZF9jaGFubmVsX2NsaWVudF9kZXN0cm95KHJjYyk7CisgICAg
ICAgIGdfb2JqZWN0X3VucmVmKHJjYyk7CiAgICAgICAgIHB0aHJlYWRfbXV0ZXhfbG9jaygmY2xp
ZW50LT5sb2NrKTsKICAgICB9CiAgICAgcHRocmVhZF9tdXRleF91bmxvY2soJmNsaWVudC0+bG9j
ayk7CkBAIC0zNDcsOCArMzQ4LDE0IEBAIHZvaWQgcmVkX2NsaWVudF9yZW1vdmVfY2hhbm5lbChS
ZWRDaGFubmVsQ2xpZW50ICpyY2MpCiB7CiAgICAgUmVkQ2xpZW50ICpjbGllbnQgPSByZWRfY2hh
bm5lbF9jbGllbnRfZ2V0X2NsaWVudChyY2MpOwogICAgIHB0aHJlYWRfbXV0ZXhfbG9jaygmY2xp
ZW50LT5sb2NrKTsKLSAgICBjbGllbnQtPmNoYW5uZWxzID0gZ19saXN0X3JlbW92ZShjbGllbnQt
PmNoYW5uZWxzLCByY2MpOworICAgIEdMaXN0ICpsaW5rID0gZ19saXN0X2ZpbmQoY2xpZW50LT5j
aGFubmVscywgcmNjKTsKKyAgICBpZiAobGluaykgeworICAgICAgICBjbGllbnQtPmNoYW5uZWxz
ID0gZ19saXN0X2RlbGV0ZV9saW5rKGNsaWVudC0+Y2hhbm5lbHMsIGxpbmspOworICAgIH0KICAg
ICBwdGhyZWFkX211dGV4X3VubG9jaygmY2xpZW50LT5sb2NrKTsKKyAgICBpZiAobGluaykgewor
ICAgICAgICBnX29iamVjdF91bnJlZihyY2MpOworICAgIH0KIH0KIAogLyogcmV0dXJucyBUUlVF
IElmIGFsbCBjaGFubmVscyBhcmUgZmluaXNoZWQgbWlncmF0aW5nLCBGQUxTRSBvdGhlcndpc2Ug
Ki8KLS0gCjIuMjEuMAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX18KU3BpY2UtZGV2ZWwgbWFpbGluZyBsaXN0ClNwaWNlLWRldmVsQGxpc3RzLmZyZWVkZXNr
dG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL3Nw
aWNlLWRldmVs
