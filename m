Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 6142489AA2
	for <lists+spice-devel@lfdr.de>; Mon, 12 Aug 2019 11:57:53 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id E797489DFE;
	Mon, 12 Aug 2019 09:57:51 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mail-wr1-x441.google.com (mail-wr1-x441.google.com
 [IPv6:2a00:1450:4864:20::441])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 19C0A6E4CA
 for <spice-devel@lists.freedesktop.org>; Mon, 12 Aug 2019 09:57:50 +0000 (UTC)
Received: by mail-wr1-x441.google.com with SMTP id k2so18176297wrq.2
 for <spice-devel@lists.freedesktop.org>; Mon, 12 Aug 2019 02:57:50 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references;
 bh=sfKYN/Azfvd+EIZJT2whn1/5n5UkPFRbx10oy2ROwKQ=;
 b=fuVB2SJljBfB9wDUkauwnCmDtLk42oGJXbqW/J0L0ybq/jxPn9cY41U5Atw0iw1Ue2
 5LoD0GTnPppk2axMel+jlG2kVfwcbLr8kwN5gfqFvgaoDsjGJHsC3NJLeDWe/Pi+uwT1
 zUN9hiRxuqp20M6FE0XTO0h7J3y3LXRyYdUImHysWQP7nPVMTtf1dyoV8X2cNEhfnhUb
 O0JJgKStQtpvnE06lty62hjiWOZKrNAm+uip5AZ7Gb8jaZUmDJ0clW5O83MhPVGsNmWA
 SGPLHQ5RSuHWkf8zatk7e/ansX8/HYhDaKD6T6uOcjec7jGaXVXFflE8K95WigXXzEqG
 Nakg==
X-Gm-Message-State: APjAAAWD8r6nzlb6pWUja56UNZXwhBSBoIxp1TjwmChKk0PY9UZ/71p9
 rcOKeGZznEbHRnR8KoLRPm/NG7etb08=
X-Google-Smtp-Source: APXvYqyqY95YlfWGIYcYBbgifF/eVd4KO5mU7/SKu3I8Bcf1XNWiMglHS04F5qoWcbL/AZPMPwlr7w==
X-Received: by 2002:adf:c508:: with SMTP id q8mr12412823wrf.287.1565603868046; 
 Mon, 12 Aug 2019 02:57:48 -0700 (PDT)
Received: from f2.redhat.com (bzq-79-182-115-245.red.bezeqint.net.
 [79.182.115.245])
 by smtp.gmail.com with ESMTPSA id g14sm11930659wrb.38.2019.08.12.02.57.46
 (version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
 Mon, 12 Aug 2019 02:57:47 -0700 (PDT)
From: Yuri Benditovich <yuri.benditovich@daynix.com>
To: spice-devel@lists.freedesktop.org
Date: Mon, 12 Aug 2019 12:57:25 +0300
Message-Id: <20190812095729.32692-6-yuri.benditovich@daynix.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190812095729.32692-1-yuri.benditovich@daynix.com>
References: <20190812095729.32692-1-yuri.benditovich@daynix.com>
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=daynix-com.20150623.gappssmtp.com; s=20150623;
 h=from:to:cc:subject:date:message-id:in-reply-to:references;
 bh=sfKYN/Azfvd+EIZJT2whn1/5n5UkPFRbx10oy2ROwKQ=;
 b=XEDnbEPFNCUig0ZB4cr/l5rAOSmrUXcARTWW2Fzua5XdhjCaYQpcVxsx6tfR6LmSLb
 sEIE250awJRiftwTbMPqXnt/9jY7sk5C1SNKdmcwLGo1HsunH8KYdaUS4Z+I76QBX+6G
 mLZEcFMZmzm8xebHjFlpVIDXWRZKP8lnxOcOoi+lRKmNjT6s2TwxTn0kxvwhJYXbeG2m
 +nq4cewrmLcQjZkWS7m3wAUkOZumMpnCMsAP/iRH/bl2qhMI93p9NnmEZASuLqrmDd33
 zraW//VkU7cKr2tRr//qyi51WxZPVdfAEqZwvhx27CVDMzHzway+VShmlIjDyIuUfEsP
 S4yQ==
Subject: [Spice-devel] [spice-gtk v3 5/9] usb-redir: extend USB backend to
 support emulated devices
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: yan@daynix.com
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

UmVkaXJlY3Rpb24gb2YgZW11bGF0ZWQgZGV2aWNlcyByZXF1aXJlcyBzcGVjaWFsIGFwcHJvYWNo
LAphcyB1c2JyZWRpcmhvc3QgY2FuJ3QgYmUgdXNlZCBmb3IgdGhhdCAoaXQgd29ya3Mgb25seSB3
aXRoCmxpYnVzYiBkZXZpY2VzKS4gRm9yIGVtdWxhdGVkIGRldmljZXMgd2UgY3JlYXRlIGluc3Rh
bmNlIG9mCnVzYnJlZGlycGFyc2VyIHRoYXQgaW1wbGVtZW50cyBVU0IgcmVkaXJlY3Rpb24gcHJv
dG9jb2wuCkluIG9yZGVyIHRvIHdvcmsgd2l0aCB0aGUgc2FtZSBzZXQgb2YgcHJvdG9jb2wgY2Fw
YWJpbGl0aWVzCnRoYXQgdXNicmVkaXJob3N0IHNldHMgdXAgd2l0aCByZW1vdGUgc2lkZSwgdGhl
IHBhcnNlciBzaGFsbDoKLSBub3Qgc2VuZCBpdHMgb3duICdoZWxsbycgdG8gdGhlIHNlcnZlcgot
IGluaXRpYWxpemUgdGhlIHNhbWUgY2FwYWJpbGl0aWVzIHRoYXQgdXNicmVkaXJob3N0Ci0gcmVj
ZWl2ZSB0aGUgc2FtZSAnaGVsbG8nIHJlc3BvbnNlCkZvciB0aGF0IHdlIGFuYWx5emUgJ2hlbGxv
JyBzZW50IGJ5IFVTQiByZWRpciBwYXJzZXIgYW5kCmV4dHJhY3Qgc2V0IG9mIGNhcGFiaWxpdGll
cyBmcm9tIGl0IGFuZCB1cG9uIHJlY2VpdmUgb2YKJ2hlbGxvJyByZXNwb25zZSB3ZSBwcm92aWRl
IGl0IGFsc28gdG8gdGhlIHBhcnNlci4KV2hlbiBsaWJ1c2IgZGV2aWNlIGlzIHJlZGlyZWN0ZWQg
dmlhIGEgY2hhbm5lbCwgaW5zdGFuY2Ugb2YKdXNicmVkaXJob3N0IHNlcnZlcyBpdC4KV2hlbiBl
bXVsYXRlZCBkZXZpY2UgaXMgcmVkaXJlY3RlZCB2aWEgYSBjaGFubmVsLCBpbnN0YW5jZQpvZiB1
c2JyZWRpcnBhcnNlciBkb2VzIHRoZSBqb2IuCgpTaWduZWQtb2ZmLWJ5OiBZdXJpIEJlbmRpdG92
aWNoIDx5dXJpLmJlbmRpdG92aWNoQGRheW5peC5jb20+Ci0tLQogc3JjL3VzYi1iYWNrZW5kLmMg
fCA2MTYgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKy0tLQogMSBm
aWxlIGNoYW5nZWQsIDU4MCBpbnNlcnRpb25zKCspLCAzNiBkZWxldGlvbnMoLSkKCmRpZmYgLS1n
aXQgYS9zcmMvdXNiLWJhY2tlbmQuYyBiL3NyYy91c2ItYmFja2VuZC5jCmluZGV4IGFhMTFjNzku
LjlhZWU2YzcgMTAwNjQ0Ci0tLSBhL3NyYy91c2ItYmFja2VuZC5jCisrKyBiL3NyYy91c2ItYmFj
a2VuZC5jCkBAIC01NSw2ICs1NSw3IEBAIHN0cnVjdCBfU3BpY2VVc2JCYWNrZW5kRGV2aWNlCiAg
ICAgZ2ludCByZWZfY291bnQ7CiAgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqYXR0YWNoZWRf
dG87CiAgICAgVXNiRGV2aWNlSW5mb3JtYXRpb24gZGV2aWNlX2luZm87CisgICAgZ2Jvb2xlYW4g
ZWRldl9jb25maWd1cmVkOwogfTsKIAogc3RydWN0IF9TcGljZVVzYkJhY2tlbmQKQEAgLTgwLDEw
ICs4MSwyMCBAQCBzdHJ1Y3QgX1NwaWNlVXNiQmFja2VuZAogc3RydWN0IF9TcGljZVVzYkJhY2tl
bmRDaGFubmVsCiB7CiAgICAgc3RydWN0IHVzYnJlZGlyaG9zdCAqdXNicmVkaXJob3N0OworICAg
IHN0cnVjdCB1c2JyZWRpcmhvc3QgKmhpZGRlbl9ob3N0OworICAgIHN0cnVjdCB1c2JyZWRpcnBh
cnNlciAqcGFyc2VyOworICAgIHN0cnVjdCB1c2JyZWRpcnBhcnNlciAqaGlkZGVuX3BhcnNlcjsK
ICAgICB1aW50OF90ICpyZWFkX2J1ZjsKICAgICBpbnQgcmVhZF9idWZfc2l6ZTsKICAgICBzdHJ1
Y3QgdXNicmVkaXJmaWx0ZXJfcnVsZSAqcnVsZXM7CiAgICAgaW50IHJ1bGVzX2NvdW50OworICAg
IHVpbnQzMl90IGhvc3RfY2FwczsKKyAgICB1aW50MzJfdCBwYXJzZXJfaW5pdF9kb25lICA6IDE7
CisgICAgdWludDMyX3QgcGFyc2VyX3dpdGhfaGVsbG8gOiAxOworICAgIHVpbnQzMl90IGhlbGxv
X2RvbmVfcGFyc2VyIDogMTsKKyAgICB1aW50MzJfdCBoZWxsb19zZW50ICAgICAgICA6IDE7Cisg
ICAgdWludDMyX3QgcmVqZWN0ZWQgICAgICAgICAgOiAxOworICAgIHVpbnQzMl90IHdhaXRfZGlz
Y19hY2sgICAgIDogMTsKICAgICBTcGljZVVzYkJhY2tlbmREZXZpY2UgKmF0dGFjaGVkOwogICAg
IFNwaWNlVXNicmVkaXJDaGFubmVsICAqdXNlcl9kYXRhOwogICAgIFNwaWNlVXNiQmFja2VuZCAq
YmFja2VuZDsKQEAgLTM1NSw3ICszNjYsMTEgQEAgZ2Jvb2xlYW4gc3BpY2VfdXNiX2JhY2tlbmRf
ZGV2aWNlX2lzb2NoKFNwaWNlVXNiQmFja2VuZERldmljZSAqZGV2KQogICAgIGdpbnQgaSwgaiwg
azsKICAgICBpbnQgcmM7CiAKLSAgICBnX3JldHVybl92YWxfaWZfZmFpbChsaWJkZXYgIT0gTlVM
TCwgMCk7CisgICAgZ19yZXR1cm5fdmFsX2lmX2ZhaWwobGliZGV2ICE9IE5VTEwgfHwgZGV2LT5l
ZGV2ICE9IE5VTEwsIDApOworICAgIGlmIChkZXYtPmVkZXYpIHsKKyAgICAgICAgLyogY3VycmVu
dGx5IHdlIGRvIG5vdCBlbXVsYXRlIGlzb2NoIGRldmljZXMgKi8KKyAgICAgICAgcmV0dXJuIEZB
TFNFOworICAgIH0KIAogICAgIHJjID0gbGlidXNiX2dldF9hY3RpdmVfY29uZmlnX2Rlc2NyaXB0
b3IobGliZGV2LCAmY29uZl9kZXNjKTsKICAgICBpZiAocmMpIHsKQEAgLTM5MCwxMyArNDA1LDE2
IEBAIGZyb20gYm90aCB0aGUgbWFpbiB0aHJlYWQgYXMgd2VsbCBhcyBmcm9tIHRoZSB1c2IgZXZl
bnQgaGFuZGxpbmcgdGhyZWFkICovCiBzdGF0aWMgdm9pZCB1c2JyZWRpcl93cml0ZV9mbHVzaF9j
YWxsYmFjayh2b2lkICp1c2VyX2RhdGEpCiB7CiAgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAq
Y2ggPSB1c2VyX2RhdGE7Ci0gICAgaWYgKCFjaC0+dXNicmVkaXJob3N0KSB7Ci0gICAgICAgIC8q
IGp1c3QgdG8gYmUgb24gdGhlIHNhZmUgc2lkZSAqLwotICAgICAgICByZXR1cm47Ci0gICAgfQog
ICAgIGlmIChpc19jaGFubmVsX3JlYWR5KGNoLT51c2VyX2RhdGEpKSB7Ci0gICAgICAgIFNQSUNF
X0RFQlVHKCIlcyBjaCAlcCAtPiB1c2JyZWRpcmhvc3QiLCBfX0ZVTkNUSU9OX18sIGNoKTsKLSAg
ICAgICAgdXNicmVkaXJob3N0X3dyaXRlX2d1ZXN0X2RhdGEoY2gtPnVzYnJlZGlyaG9zdCk7Cisg
ICAgICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7CisgICAgICAgICAgICBTUElDRV9ERUJVRygi
JXMgY2ggJXAgLT4gdXNicmVkaXJob3N0IiwgX19GVU5DVElPTl9fLCBjaCk7CisgICAgICAgICAg
ICB1c2JyZWRpcmhvc3Rfd3JpdGVfZ3Vlc3RfZGF0YShjaC0+dXNicmVkaXJob3N0KTsKKyAgICAg
ICAgfSBlbHNlIGlmIChjaC0+cGFyc2VyKSB7CisgICAgICAgICAgICBTUElDRV9ERUJVRygiJXMg
Y2ggJXAgLT4gcGFyc2VyIiwgX19GVU5DVElPTl9fLCBjaCk7CisgICAgICAgICAgICB1c2JyZWRp
cnBhcnNlcl9kb193cml0ZShjaC0+cGFyc2VyKTsKKyAgICAgICAgfSBlbHNlIHsKKyAgICAgICAg
ICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAoTk9UIEFDVElWRSkiLCBfX0ZVTkNUSU9OX18sIGNo
KTsKKyAgICAgICAgfQogICAgIH0gZWxzZSB7CiAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAl
cCAobm90IHJlYWR5KSIsIF9fRlVOQ1RJT05fXywgY2gpOwogICAgIH0KQEAgLTU1MSwxMyArNTY5
LDUyIEBAIHZvaWQgc3BpY2VfdXNiX2JhY2tlbmRfZGV2aWNlX3VucmVmKFNwaWNlVXNiQmFja2Vu
ZERldmljZSAqZGV2KQogICAgIH0KIH0KIAotaW50IHNwaWNlX3VzYl9iYWNrZW5kX2RldmljZV9j
aGVja19maWx0ZXIoCi0gICAgU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkZXYsCi0gICAgY29uc3Qg
c3RydWN0IHVzYnJlZGlyZmlsdGVyX3J1bGUgKnJ1bGVzLAotICAgIGludCBjb3VudCkKK3N0YXRp
YyBpbnQgY2hlY2tfZWRldl9kZXZpY2VfZmlsdGVyKFNwaWNlVXNiQmFja2VuZERldmljZSAqZGV2
LAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RydWN0IHVzYnJl
ZGlyZmlsdGVyX3J1bGUgKnJ1bGVzLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgaW50IGNvdW50KQogewotICAgIHJldHVybiB1c2JyZWRpcmhvc3RfY2hlY2tfZGV2aWNlX2Zp
bHRlcigKLSAgICAgICAgcnVsZXMsIGNvdW50LCBkZXYtPmxpYnVzYl9kZXZpY2UsIDApOworICAg
IFNwaWNlVXNiRW11bGF0ZWREZXZpY2UgKmVkZXYgPSBkZXYtPmVkZXY7CisgICAgdWludDhfdCBj
bHNbMzJdLCBzdWJjbHNbMzJdLCBwcm90b1szMl0sICpjZmcsIGlmbnVtID0gMDsKKyAgICB1aW50
MTZfdCBzaXplLCBvZmZzZXQgPSAwOworICAgIGlmICghZWRldikgeworICAgICAgICByZXR1cm4g
MTsKKyAgICB9CisgICAgaWYgKCFkZXZpY2Vfb3BzKGVkZXYpLT5nZXRfZGVzY3JpcHRvcihlZGV2
LCBMSUJVU0JfRFRfQ09ORklHLCAwLCAodm9pZCAqKikmY2ZnLCAmc2l6ZSkpIHsKKyAgICAgICAg
cmV0dXJuIDE7CisgICAgfQorICAgIHdoaWxlICgob2Zmc2V0ICsgMSkgPCBzaXplKSB7CisgICAg
ICAgIHVpbnQ4X3QgbGVuICA9IGNmZ1tvZmZzZXRdOworICAgICAgICB1aW50OF90IHR5cGUgPSBj
Zmdbb2Zmc2V0ICsgMV07CisgICAgICAgIGlmICgob2Zmc2V0ICsgbGVuKSA+IHNpemUpIHsKKyAg
ICAgICAgICAgIGJyZWFrOworICAgICAgICB9CisgICAgICAgIGlmICh0eXBlID09IExJQlVTQl9E
VF9JTlRFUkZBQ0UpIHsKKyAgICAgICAgICAgIGNsc1tpZm51bV0gPSBjZmdbb2Zmc2V0ICsgNV07
CisgICAgICAgICAgICBzdWJjbHNbaWZudW1dID0gY2ZnW29mZnNldCArIDZdOworICAgICAgICAg
ICAgcHJvdG9baWZudW1dID0gY2ZnW29mZnNldCArIDddOworICAgICAgICAgICAgaWZudW0rKzsK
KyAgICAgICAgfQorICAgICAgICBvZmZzZXQgKz0gbGVuOworICAgIH0KKworICAgIHJldHVybiB1
c2JyZWRpcmZpbHRlcl9jaGVjayhydWxlcywgY291bnQsCisgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIGRldi0+ZGV2aWNlX2luZm8uY2xhc3MsCisgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIGRldi0+ZGV2aWNlX2luZm8uc3ViY2xhc3MsCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIGRldi0+ZGV2aWNlX2luZm8ucHJvdG9jb2wsCisgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIGNscywgc3ViY2xzLCBwcm90bywgaWZudW0sCisgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIGRldi0+ZGV2aWNlX2luZm8udmlkLAorICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICBkZXYtPmRldmljZV9pbmZvLnBpZCwKKyAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgZGV2LT5kZXZpY2VfaW5mby5iY2RVU0IsIDApOworfQorCitpbnQgc3Bp
Y2VfdXNiX2JhY2tlbmRfZGV2aWNlX2NoZWNrX2ZpbHRlcihTcGljZVVzYkJhY2tlbmREZXZpY2Ug
KmRldiwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0
cnVjdCB1c2JyZWRpcmZpbHRlcl9ydWxlICpydWxlcywgaW50IGNvdW50KQoreworICAgIGlmIChk
ZXYtPmxpYnVzYl9kZXZpY2UpIHsKKyAgICAgICAgcmV0dXJuIHVzYnJlZGlyaG9zdF9jaGVja19k
ZXZpY2VfZmlsdGVyKHJ1bGVzLCBjb3VudCwgZGV2LT5saWJ1c2JfZGV2aWNlLCAwKTsKKyAgICB9
IGVsc2UgeworICAgICAgICByZXR1cm4gY2hlY2tfZWRldl9kZXZpY2VfZmlsdGVyKGRldiwgcnVs
ZXMsIGNvdW50KTsKKyAgICB9CiB9CiAKIHN0YXRpYyBpbnQgdXNicmVkaXJfcmVhZF9jYWxsYmFj
ayh2b2lkICp1c2VyX2RhdGEsIHVpbnQ4X3QgKmRhdGEsIGludCBjb3VudCkKQEAgLTYyMSw2ICs2
NzgsMTcgQEAgc3RhdGljIGludCB1c2JyZWRpcl93cml0ZV9jYWxsYmFjayh2b2lkICp1c2VyX2Rh
dGEsIHVpbnQ4X3QgKmRhdGEsIGludCBjb3VudCkKICAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVs
ICpjaCA9IHVzZXJfZGF0YTsKICAgICBpbnQgcmVzOwogICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAl
cCwgJWQgYnl0ZXMiLCBfX0ZVTkNUSU9OX18sIGNoLCBjb3VudCk7CisgICAgaWYgKCFjaC0+aGVs
bG9fc2VudCkgeworICAgICAgICAvKiBoZWxsbyBpcyBzaG9ydCBoZWFkZXIgKDEyKSArIGhlbGxv
IHN0cnVjdCAoNjQpICsgY2FwYWJpbGl0aWVzICg0KSAqLworICAgICAgICBpbnQgaGVsbG9fc2l6
ZSA9IHNpemVvZihzdHJ1Y3QgdXNiX3JlZGlyX2hlYWRlcikgKyBzaXplb2Yoc3RydWN0IHVzYl9y
ZWRpcl9oZWxsb19oZWFkZXIpOworICAgICAgICBjaC0+aGVsbG9fc2VudCA9IDE7CisgICAgICAg
IGlmIChjb3VudCA9PSBoZWxsb19zaXplKSB7CisgICAgICAgICAgICBtZW1jcHkoJmNoLT5ob3N0
X2NhcHMsIGRhdGEgKyBoZWxsb19zaXplIC0gc2l6ZW9mKGNoLT5ob3N0X2NhcHMpLAorICAgICAg
ICAgICAgICAgICAgIHNpemVvZihjaC0+aG9zdF9jYXBzKSk7CisgICAgICAgICAgICBTUElDRV9E
RUJVRygiJXMgY2ggJXAsIHNlbmRpbmcgZmlyc3QgaGVsbG8sIGNhcHMgJTA4WCIsCisgICAgICAg
ICAgICAgICAgICAgICAgICBfX0ZVTkNUSU9OX18sIGNoLCBjaC0+aG9zdF9jYXBzKTsKKyAgICAg
ICAgfQorICAgIH0KICAgICByZXMgPSBzcGljZV91c2JyZWRpcl93cml0ZV9jYWxsYmFjayhjaC0+
dXNlcl9kYXRhLCBkYXRhLCBjb3VudCk7CiAgICAgcmV0dXJuIHJlczsKIH0KQEAgLTY0MSw2ICs3
MDksMjcgQEAgaW50IHNwaWNlX3VzYl9iYWNrZW5kX3JlYWRfZ3Vlc3RfZGF0YShTcGljZVVzYkJh
Y2tlbmRDaGFubmVsICpjaCwgdWludDhfdCAqZGF0YSwKICAgICBjaC0+cmVhZF9idWZfc2l6ZSA9
IGNvdW50OwogICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7CiAgICAgICAgIHJlcyA9IHVzYnJl
ZGlyaG9zdF9yZWFkX2d1ZXN0X2RhdGEoY2gtPnVzYnJlZGlyaG9zdCk7CisgICAgICAgIGlmICgh
Y2gtPmhlbGxvX2RvbmVfcGFyc2VyKSB7CisgICAgICAgICAgICBpbnQgcmVzX3BhcnNlcjsKKyAg
ICAgICAgICAgIC8qIHVzYnJlZGlyaG9zdCBzaG91bGQgY29uc3VtZSBoZWxsbyByZXNwb25zZSAq
LworICAgICAgICAgICAgZ19yZXR1cm5fdmFsX2lmX2ZhaWwoY2gtPnJlYWRfYnVmID09IE5VTEws
IFVTQl9SRURJUl9FUlJPUl9SRUFEX1BBUlNFKTsKKworICAgICAgICAgICAgY2gtPnJlYWRfYnVm
ID0gZGF0YTsKKyAgICAgICAgICAgIGNoLT5yZWFkX2J1Zl9zaXplID0gY291bnQ7CisgICAgICAg
ICAgICBjaC0+aGVsbG9fZG9uZV9wYXJzZXIgPSAxOworICAgICAgICAgICAgaWYgKGNoLT5hdHRh
Y2hlZCAmJiBjaC0+YXR0YWNoZWQtPmVkZXYpIHsKKyAgICAgICAgICAgICAgICAvKiBjYXNlIG9m
IENEIHNoYXJpbmcgb24gY29ubmVjdCAqLworICAgICAgICAgICAgICAgIGNoLT51c2JyZWRpcmhv
c3QgPSBOVUxMOworICAgICAgICAgICAgICAgIGNoLT5wYXJzZXIgPSBjaC0+aGlkZGVuX3BhcnNl
cjsKKyAgICAgICAgICAgICAgICBTUElDRV9ERUJVRygiJXM6IHN3aXRjaCAlcCB0byBwYXJzZXIi
LCBfX0ZVTkNUSU9OX18sIGNoKTsKKyAgICAgICAgICAgIH0KKyAgICAgICAgICAgIHJlc19wYXJz
ZXIgPSB1c2JyZWRpcnBhcnNlcl9kb19yZWFkKGNoLT5oaWRkZW5fcGFyc2VyKTsKKyAgICAgICAg
ICAgIGlmIChyZXMgPj0gMCkgeworICAgICAgICAgICAgICAgIHJlcyA9IHJlc19wYXJzZXI7Cisg
ICAgICAgICAgICB9CisgICAgICAgIH0KKyAgICB9IGVsc2UgaWYgKGNoLT5wYXJzZXIpIHsKKyAg
ICAgICAgcmVzID0gdXNicmVkaXJwYXJzZXJfZG9fcmVhZChjaC0+cGFyc2VyKTsKICAgICB9IGVs
c2UgewogICAgICAgICByZXMgPSBVU0JfUkVESVJfRVJST1JfSU87CiAgICAgfQpAQCAtNjYxLDYg
Kzc1MCwxMSBAQCBpbnQgc3BpY2VfdXNiX2JhY2tlbmRfcmVhZF9ndWVzdF9kYXRhKFNwaWNlVXNi
QmFja2VuZENoYW5uZWwgKmNoLCB1aW50OF90ICpkYXRhLAogICAgIH0KICAgICBTUElDRV9ERUJV
RygiJXMgY2ggJXAsICVkIGJ5dGVzLCByZXMgJWQiLCBfX0ZVTkNUSU9OX18sIGNoLCBjb3VudCwg
cmVzKTsKIAorICAgIGlmIChjaC0+cmVqZWN0ZWQpIHsKKyAgICAgICAgY2gtPnJlamVjdGVkID0g
MDsKKyAgICAgICAgcmVzID0gVVNCX1JFRElSX0VSUk9SX0RFVl9SRUpFQ1RFRDsKKyAgICB9CisK
ICAgICByZXR1cm4gcmVzOwogfQogCkBAIC02OTAsMTMgKzc4NCw0MjYgQEAgR0Vycm9yICpzcGlj
ZV91c2JfYmFja2VuZF9nZXRfZXJyb3JfZGV0YWlscyhpbnQgZXJyb3JfY29kZSwgZ2NoYXIgKmRl
c2MpCiB2b2lkIHNwaWNlX3VzYl9iYWNrZW5kX3JldHVybl93cml0ZV9kYXRhKFNwaWNlVXNiQmFj
a2VuZENoYW5uZWwgKmNoLCB2b2lkICpkYXRhKQogewogICAgIGlmIChjaC0+dXNicmVkaXJob3N0
KSB7Ci0gICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCIsIF9fRlVOQ1RJT05fXywgY2gpOwor
ICAgICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAgLT4gdXNicmVkaXJob3N0IiwgX19GVU5DVElP
Tl9fLCBjaCk7CiAgICAgICAgIHVzYnJlZGlyaG9zdF9mcmVlX3dyaXRlX2J1ZmZlcihjaC0+dXNi
cmVkaXJob3N0LCBkYXRhKTsKKyAgICB9IGVsc2UgaWYgKGNoLT5wYXJzZXIpIHsKKyAgICAgICAg
U1BJQ0VfREVCVUcoIiVzIGNoICVwIC0+IHBhcnNlciIsIF9fRlVOQ1RJT05fXywgY2gpOworICAg
ICAgICB1c2JyZWRpcnBhcnNlcl9mcmVlX3dyaXRlX2J1ZmZlcihjaC0+cGFyc2VyLCBkYXRhKTsK
ICAgICB9IGVsc2UgewogICAgICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAgLSBOT0JPRFkgVE8g
Q0FMTCIsIF9fRlVOQ1RJT05fXywgY2gpOwogICAgIH0KIH0KIAorc3RhdGljIHZvaWQgdXNicmVk
aXJfY29udHJvbF9wYWNrZXQodm9pZCAqcHJpdiwKKyAgICB1aW50NjRfdCBpZCwgc3RydWN0IHVz
Yl9yZWRpcl9jb250cm9sX3BhY2tldF9oZWFkZXIgKmgsCisgICAgdWludDhfdCAqZGF0YSwgaW50
IGRhdGFfbGVuKQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAg
ICBTcGljZVVzYkJhY2tlbmREZXZpY2UgKmQgPSBjaC0+YXR0YWNoZWQ7CisgICAgU3BpY2VVc2JF
bXVsYXRlZERldmljZSAqZWRldiA9IGQgPyBkLT5lZGV2IDogTlVMTDsKKyAgICBzdHJ1Y3QgdXNi
X3JlZGlyX2NvbnRyb2xfcGFja2V0X2hlYWRlciByZXNwb25zZSA9ICpoOworICAgIHVpbnQ4X3Qg
cmVxdHlwZSA9IGgtPnJlcXVlc3R0eXBlICYgMHg3ZjsKKyAgICBnYm9vbGVhbiBkb25lID0gRkFM
U0U7CisgICAgdm9pZCAqb3V0X2J1ZmZlciA9IE5VTEw7CisKKyAgICByZXNwb25zZS5zdGF0dXMg
PSB1c2JfcmVkaXJfc3RhbGw7CisgICAgU1BJQ0VfREVCVUcoIiVzICVwOiBUUlZJTCAlMDJYICUw
MlggJTA0WCAlMDRYICUwNFgiLAorICAgICAgICAgICAgICAgIF9fRlVOQ1RJT05fXywKKyAgICAg
ICAgICAgICAgICBjaCwgaC0+cmVxdWVzdHR5cGUsIGgtPnJlcXVlc3QsCisgICAgICAgICAgICAg
ICAgaC0+dmFsdWUsIGgtPmluZGV4LCBoLT5sZW5ndGgpOworCisgICAgaWYgKCFlZGV2KSB7Cisg
ICAgICAgIFNQSUNFX0RFQlVHKCIlczogZGV2aWNlIG5vdCBhdHRhY2hlZCIsIF9fRlVOQ1RJT05f
Xyk7CisgICAgICAgIHJlc3BvbnNlLnN0YXR1cyA9IHVzYl9yZWRpcl9pb2Vycm9yOworICAgICAg
ICBkb25lID0gVFJVRTsKKyAgICB9IGVsc2UgaWYgKHJlcXR5cGUgPT0gKExJQlVTQl9SRVFVRVNU
X1RZUEVfU1RBTkRBUkQgfCBMSUJVU0JfUkVDSVBJRU5UX0RFVklDRSkgJiYKKyAgICAgICAgICAg
ICAgIGgtPnJlcXVlc3QgPT0gTElCVVNCX1JFUVVFU1RfR0VUX0RFU0NSSVBUT1IpIHsKKyAgICAg
ICAgdWludDE2X3Qgc2l6ZTsKKyAgICAgICAgZG9uZSA9IGRldmljZV9vcHMoZWRldiktPmdldF9k
ZXNjcmlwdG9yKGVkZXYsIGgtPnZhbHVlID4+IDgsIGgtPnZhbHVlICYgMHhmZiwKKyAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICZvdXRfYnVmZmVyLCAmc2l6
ZSk7CisgICAgICAgIHJlc3BvbnNlLmxlbmd0aCA9IHNpemU7CisgICAgICAgIGlmIChkb25lKSB7
CisgICAgICAgICAgICByZXNwb25zZS5zdGF0dXMgPSAwOworICAgICAgICB9CisgICAgICAgIGRv
bmUgPSBUUlVFOworICAgIH0KKworICAgIGlmICghZG9uZSkgeworICAgICAgICBkZXZpY2Vfb3Bz
KGVkZXYpLT5jb250cm9sX3JlcXVlc3QoZWRldiwgZGF0YSwgZGF0YV9sZW4sICZyZXNwb25zZSwg
Jm91dF9idWZmZXIpOworICAgICAgICBkb25lID0gVFJVRTsKKyAgICB9CisKKyAgICBpZiAocmVz
cG9uc2Uuc3RhdHVzKSB7CisgICAgICAgIHJlc3BvbnNlLmxlbmd0aCA9IDA7CisgICAgfSBlbHNl
IGlmIChyZXNwb25zZS5sZW5ndGggPiBoLT5sZW5ndGgpIHsKKyAgICAgICAgcmVzcG9uc2UubGVu
Z3RoID0gaC0+bGVuZ3RoOworICAgIH0KKworICAgIFNQSUNFX0RFQlVHKCIlcyByZXNwb25kaW5n
IHdpdGggcGF5bG9hZCBvZiAlMDJYLCBzdGF0dXMgJVgiLAorICAgICAgICAgICAgICAgIF9fRlVO
Q1RJT05fXywgcmVzcG9uc2UubGVuZ3RoLCByZXNwb25zZS5zdGF0dXMpOworICAgIHVzYnJlZGly
cGFyc2VyX3NlbmRfY29udHJvbF9wYWNrZXQoY2gtPnBhcnNlciwgaWQsICZyZXNwb25zZSwKKyAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmxlbmd0aCA/IG91
dF9idWZmZXIgOiBOVUxMLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
cmVzcG9uc2UubGVuZ3RoKTsKKworICAgIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrKGNo
KTsKKyAgICB1c2JyZWRpcnBhcnNlcl9mcmVlX3BhY2tldF9kYXRhKGNoLT5wYXJzZXIsIGRhdGEp
OworfQorCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9idWxrX3BhY2tldCh2b2lkICpwcml2LAorICAg
IHVpbnQ2NF90IGlkLCBzdHJ1Y3QgdXNiX3JlZGlyX2J1bGtfcGFja2V0X2hlYWRlciAqaCwKKyAg
ICB1aW50OF90ICpkYXRhLCBpbnQgZGF0YV9sZW4pCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hh
bm5lbCAqY2ggPSBwcml2OworICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqZCA9IGNoLT5hdHRh
Y2hlZDsKKyAgICBTcGljZVVzYkVtdWxhdGVkRGV2aWNlICplZGV2ID0gZCA/IGQtPmVkZXYgOiBO
VUxMOworICAgIHN0cnVjdCB1c2JfcmVkaXJfYnVsa19wYWNrZXRfaGVhZGVyIGhvdXQgPSAqaDsK
KyAgICB1aW50MzJfdCBsZW4gPSAoaC0+bGVuZ3RoX2hpZ2ggPDwgMTYpIHwgaC0+bGVuZ3RoOwor
ICAgIFNQSUNFX0RFQlVHKCIlcyAlcDogZXAgJVgsIGxlbiAldSwgaWQgJSIgR19HVUlOVDY0X0ZP
Uk1BVCwgX19GVU5DVElPTl9fLAorICAgICAgICAgICAgICAgIGNoLCBoLT5lbmRwb2ludCwgbGVu
LCBpZCk7CisKKyAgICBpZiAoIWVkZXYpIHsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBkZXZp
Y2Ugbm90IGF0dGFjaGVkIiwgX19GVU5DVElPTl9fKTsKKyAgICAgICAgaG91dC5zdGF0dXMgPSB1
c2JfcmVkaXJfaW9lcnJvcjsKKyAgICAgICAgaG91dC5sZW5ndGggPSBob3V0Lmxlbmd0aF9oaWdo
ID0gMDsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiByZXNwb25kaW5nIHdpdGggWkxQIHN0YXR1
cyAlZCIsIF9fRlVOQ1RJT05fXywgaG91dC5zdGF0dXMpOworICAgIH0gZWxzZSBpZiAoaC0+ZW5k
cG9pbnQgJiBMSUJVU0JfRU5EUE9JTlRfSU4pIHsKKyAgICAgICAgaWYgKGRldmljZV9vcHMoZWRl
diktPmJ1bGtfaW5fcmVxdWVzdChlZGV2LCBpZCwgJmhvdXQpKSB7CisgICAgICAgICAgICB1c2Jy
ZWRpcnBhcnNlcl9mcmVlX3BhY2tldF9kYXRhKGNoLT5wYXJzZXIsIGRhdGEpOworICAgICAgICAg
ICAgLyogY29tcGxldGlvbiBpcyBhc3luY2hyb25vdXMgKi8KKyAgICAgICAgICAgIHJldHVybjsK
KyAgICAgICAgfQorICAgIH0gZWxzZSB7CisgICAgICAgIGhvdXQuc3RhdHVzID0gdXNiX3JlZGly
X3N0YWxsOworICAgICAgICBkZXZpY2Vfb3BzKGVkZXYpLT5idWxrX291dF9yZXF1ZXN0KGVkZXYs
IGgtPmVuZHBvaW50LCBkYXRhLCBkYXRhX2xlbiwgJmhvdXQuc3RhdHVzKTsKKyAgICAgICAgU1BJ
Q0VfREVCVUcoIiVzOiByZXNwb25kaW5nIHN0YXR1cyAlZCIsIF9fRlVOQ1RJT05fXywgaG91dC5z
dGF0dXMpOworICAgIH0KKworICAgIHVzYnJlZGlycGFyc2VyX3NlbmRfYnVsa19wYWNrZXQoY2gt
PnBhcnNlciwgaWQsICZob3V0LCBOVUxMLCAwKTsKKyAgICB1c2JyZWRpcnBhcnNlcl9mcmVlX3Bh
Y2tldF9kYXRhKGNoLT5wYXJzZXIsIGRhdGEpOworICAgIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2Nh
bGxiYWNrKGNoKTsKK30KKworc3RhdGljIHZvaWQgdXNicmVkaXJfZGV2aWNlX3Jlc2V0KHZvaWQg
KnByaXYpCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIFNw
aWNlVXNiQmFja2VuZERldmljZSAqZCA9IGNoLT5hdHRhY2hlZDsKKyAgICBTcGljZVVzYkVtdWxh
dGVkRGV2aWNlICplZGV2ID0gZCA/IGQtPmVkZXYgOiBOVUxMOworICAgIFNQSUNFX0RFQlVHKCIl
cyBjaCAlcCIsIF9fRlVOQ1RJT05fXywgY2gpOworICAgIGlmIChlZGV2KSB7CisgICAgICAgIGRl
dmljZV9vcHMoZWRldiktPnJlc2V0KGVkZXYpOworICAgIH0KK30KKworc3RhdGljIHZvaWQgdXNi
cmVkaXJfaW50ZXJmYWNlX2luZm8odm9pZCAqcHJpdiwKKyAgICBzdHJ1Y3QgdXNiX3JlZGlyX2lu
dGVyZmFjZV9pbmZvX2hlYWRlciAqaW50ZXJmYWNlX2luZm8pCit7CisgICAgU3BpY2VVc2JCYWNr
ZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIFNQSUNFX0RFQlVHKCIlcyBub3QgaW1wbGVtZW50
ZWQgJXAiLCBfX0ZVTkNUSU9OX18sIGNoKTsKK30KKworc3RhdGljIHZvaWQgdXNicmVkaXJfaW50
ZXJmYWNlX2VwX2luZm8odm9pZCAqcHJpdiwKKyAgICBzdHJ1Y3QgdXNiX3JlZGlyX2VwX2luZm9f
aGVhZGVyICplcF9pbmZvKQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJp
djsKKyAgICBTUElDRV9ERUJVRygiJXMgbm90IGltcGxlbWVudGVkICVwIiwgX19GVU5DVElPTl9f
LCBjaCk7Cit9CisKK3N0YXRpYyB2b2lkIHVzYnJlZGlyX3NldF9jb25maWd1cmF0aW9uKHZvaWQg
KnByaXYsCisgICAgdWludDY0X3QgaWQsIHN0cnVjdCB1c2JfcmVkaXJfc2V0X2NvbmZpZ3VyYXRp
b25faGVhZGVyICpzZXRfY29uZmlndXJhdGlvbikKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFu
bmVsICpjaCA9IHByaXY7CisgICAgc3RydWN0IHVzYl9yZWRpcl9jb25maWd1cmF0aW9uX3N0YXR1
c19oZWFkZXIgaDsKKyAgICBoLnN0YXR1cyA9IDA7CisgICAgaC5jb25maWd1cmF0aW9uID0gc2V0
X2NvbmZpZ3VyYXRpb24tPmNvbmZpZ3VyYXRpb247CisgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVw
LCBjZmcgJWQiLCBfX0ZVTkNUSU9OX18sIGNoLCBoLmNvbmZpZ3VyYXRpb24pOworICAgIGlmIChj
aC0+YXR0YWNoZWQpIHsKKyAgICAgICAgY2gtPmF0dGFjaGVkLT5lZGV2X2NvbmZpZ3VyZWQgPSBo
LmNvbmZpZ3VyYXRpb24gIT0gMDsKKyAgICB9CisgICAgdXNicmVkaXJwYXJzZXJfc2VuZF9jb25m
aWd1cmF0aW9uX3N0YXR1cyhjaC0+cGFyc2VyLCBpZCwgJmgpOworICAgIHVzYnJlZGlyX3dyaXRl
X2ZsdXNoX2NhbGxiYWNrKGNoKTsKK30KKworc3RhdGljIHZvaWQgdXNicmVkaXJfZ2V0X2NvbmZp
Z3VyYXRpb24odm9pZCAqcHJpdiwgdWludDY0X3QgaWQpCit7CisgICAgU3BpY2VVc2JCYWNrZW5k
Q2hhbm5lbCAqY2ggPSBwcml2OworICAgIHN0cnVjdCB1c2JfcmVkaXJfY29uZmlndXJhdGlvbl9z
dGF0dXNfaGVhZGVyIGg7CisgICAgaC5zdGF0dXMgPSAwOworICAgIGguY29uZmlndXJhdGlvbiA9
IGNoLT5hdHRhY2hlZCAmJiBjaC0+YXR0YWNoZWQtPmVkZXZfY29uZmlndXJlZDsKKyAgICBTUElD
RV9ERUJVRygiJXMgY2ggJXAsIGNmZyAlZCIsIF9fRlVOQ1RJT05fXywgY2gsIGguY29uZmlndXJh
dGlvbik7CisgICAgdXNicmVkaXJwYXJzZXJfc2VuZF9jb25maWd1cmF0aW9uX3N0YXR1cyhjaC0+
cGFyc2VyLCBpZCwgJmgpOworICAgIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsK
K30KKworc3RhdGljIHZvaWQgdXNicmVkaXJfc2V0X2FsdF9zZXR0aW5nKHZvaWQgKnByaXYsCisg
ICAgdWludDY0X3QgaWQsIHN0cnVjdCB1c2JfcmVkaXJfc2V0X2FsdF9zZXR0aW5nX2hlYWRlciAq
cykKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgc3RydWN0
IHVzYl9yZWRpcl9hbHRfc2V0dGluZ19zdGF0dXNfaGVhZGVyIHNoOworICAgIHNoLnN0YXR1cyA9
ICghcy0+aW50ZXJmYWNlICYmICFzLT5hbHQpID8gMCA6IHVzYl9yZWRpcl9zdGFsbDsKKyAgICBz
aC5pbnRlcmZhY2UgPSBzLT5pbnRlcmZhY2U7CisgICAgc2guYWx0ID0gcy0+YWx0OworICAgIFNQ
SUNFX0RFQlVHKCIlcyBjaCAlcCwgJWQ6JWQiLCBfX0ZVTkNUSU9OX18sIGNoLCBzLT5pbnRlcmZh
Y2UsIHMtPmFsdCk7CisgICAgdXNicmVkaXJwYXJzZXJfc2VuZF9hbHRfc2V0dGluZ19zdGF0dXMo
Y2gtPnBhcnNlciwgaWQsICZzaCk7CisgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2so
Y2gpOworfQorCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9nZXRfYWx0X3NldHRpbmcodm9pZCAqcHJp
diwKKyAgICB1aW50NjRfdCBpZCwgc3RydWN0IHVzYl9yZWRpcl9nZXRfYWx0X3NldHRpbmdfaGVh
ZGVyICpzKQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBz
dHJ1Y3QgdXNiX3JlZGlyX2FsdF9zZXR0aW5nX3N0YXR1c19oZWFkZXIgc2g7CisgICAgc2guc3Rh
dHVzID0gKHMtPmludGVyZmFjZSA9PSAwKSA/IDAgOiB1c2JfcmVkaXJfc3RhbGw7CisgICAgc2gu
aW50ZXJmYWNlID0gcy0+aW50ZXJmYWNlOworICAgIHNoLmFsdCA9IDA7CisgICAgU1BJQ0VfREVC
VUcoIiVzIGNoICVwLCBpZiAlZCIsIF9fRlVOQ1RJT05fXywgY2gsIHMtPmludGVyZmFjZSk7Cisg
ICAgdXNicmVkaXJwYXJzZXJfc2VuZF9hbHRfc2V0dGluZ19zdGF0dXMoY2gtPnBhcnNlciwgaWQs
ICZzaCk7CisgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2soY2gpOworfQorCitzdGF0
aWMgdm9pZCB1c2JyZWRpcl9jYW5jZWxfZGF0YSh2b2lkICpwcml2LCB1aW50NjRfdCBpZCkKK3sK
KyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU3BpY2VVc2JCYWNr
ZW5kRGV2aWNlICpkID0gY2gtPmF0dGFjaGVkOworICAgIFNwaWNlVXNiRW11bGF0ZWREZXZpY2Ug
KmVkZXYgPSBkID8gZC0+ZWRldiA6IE5VTEw7CisgICAgaWYgKCFlZGV2KSB7CisgICAgICAgIFNQ
SUNFX0RFQlVHKCIlczogZGV2aWNlIG5vdCBhdHRhY2hlZCIsIF9fRlVOQ1RJT05fXyk7CisgICAg
ICAgIHJldHVybjsKKyAgICB9CisgICAgZGV2aWNlX29wcyhlZGV2KS0+Y2FuY2VsX3JlcXVlc3Qo
ZWRldiwgaWQpOworfQorCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9maWx0ZXJfcmVqZWN0KHZvaWQg
KnByaXYpCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIFNQ
SUNFX0RFQlVHKCIlcyAlcCIsIF9fRlVOQ1RJT05fXywgY2gpOworICAgIGNoLT5yZWplY3RlZCA9
IDE7Cit9CisKKy8qIE5vdGUgdGhhdCB0aGUgb3duZXJzaGlwIG9mIHRoZSBydWxlcyBhcnJheSBp
cyBwYXNzZWQgb24gdG8gdGhlIGNhbGxiYWNrLiAqLworc3RhdGljIHZvaWQgdXNicmVkaXJfZmls
dGVyX2ZpbHRlcih2b2lkICpwcml2LAorICAgIHN0cnVjdCB1c2JyZWRpcmZpbHRlcl9ydWxlICpy
LCBpbnQgY291bnQpCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2Owor
ICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAlZCBmaWx0ZXJzIiwgX19GVU5DVElPTl9fLCBjaCwg
Y291bnQpOworCisgICAgZnJlZShjaC0+cnVsZXMpOworCisgICAgY2gtPnJ1bGVzID0gcjsKKyAg
ICBjaC0+cnVsZXNfY291bnQgPSBjb3VudDsKKyAgICBpZiAoY291bnQpIHsKKyAgICAgICAgaW50
IGk7CisgICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CisgICAgICAgICAgICBT
UElDRV9ERUJVRygiJXMgY2xhc3MgJWQsICVYOiVYIiwKKyAgICAgICAgICAgICAgICByW2ldLmFs
bG93ID8gImFsbG93ZWQiIDogImRlbmllZCIsIHJbaV0uZGV2aWNlX2NsYXNzLAorICAgICAgICAg
ICAgICAgICh1aW50MzJfdClyW2ldLnZlbmRvcl9pZCwgKHVpbnQzMl90KXJbaV0ucHJvZHVjdF9p
ZCk7CisgICAgICAgIH0KKyAgICB9Cit9CisKK3N0YXRpYyB2b2lkIHVzYnJlZGlyX2RldmljZV9k
aXNjb25uZWN0X2Fjayh2b2lkICpwcml2KQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwg
KmNoID0gcHJpdjsKKyAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAiLCBfX0ZVTkNUSU9OX18sIGNo
KTsKKyAgICBpZiAoY2gtPnBhcnNlciAmJiBjaC0+d2FpdF9kaXNjX2FjaykgeworICAgICAgICBj
aC0+cGFyc2VyID0gTlVMTDsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzIHN3aXRjaCB0byB1c2Jy
ZWRpcmhvc3QiLCBfX0ZVTkNUSU9OX18pOworICAgICAgICBjaC0+dXNicmVkaXJob3N0ID0gY2gt
PmhpZGRlbl9ob3N0OworICAgIH0KKyAgICBjaC0+d2FpdF9kaXNjX2FjayA9IDA7Cit9CisKK3N0
YXRpYyB2b2lkIHVzYnJlZGlyX2hlbGxvKHZvaWQgKnByaXYsCisgICAgc3RydWN0IHVzYl9yZWRp
cl9oZWxsb19oZWFkZXIgKmhlbGxvKQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNo
ID0gcHJpdjsKKyAgICBTcGljZVVzYkJhY2tlbmREZXZpY2UgKmQgPSBjaC0+YXR0YWNoZWQ7Cisg
ICAgU3BpY2VVc2JFbXVsYXRlZERldmljZSAqZWRldiA9IGQgPyBkLT5lZGV2IDogTlVMTDsKKyAg
ICBzdHJ1Y3QgdXNiX3JlZGlyX2RldmljZV9jb25uZWN0X2hlYWRlciBkZXZpY2VfY29ubmVjdDsK
KyAgICBzdHJ1Y3QgdXNiX3JlZGlyX2VwX2luZm9faGVhZGVyIGVwX2luZm8gPSB7IDAgfTsKKyAg
ICBzdHJ1Y3QgdXNiX3JlZGlyX2ludGVyZmFjZV9pbmZvX2hlYWRlciBpbnRlcmZhY2VfaW5mbyA9
IHsgMCB9OworICAgIHVpbnQ4X3QgKmNmZzsKKyAgICB1aW50MTZfdCBzaXplLCBvZmZzZXQgPSAw
OworICAgIFNQSUNFX0RFQlVHKCIlcyAlcCAlc2F0dGFjaGVkICVzIiwgX19GVU5DVElPTl9fLCBj
aCwKKyAgICAgICAgZWRldiA/ICIiIDogIm5vdCAiLCAgaGVsbG8gPyAiIiA6ICIoaW50ZXJuYWwp
Iik7CisKKyAgICBpZiAoaGVsbG8pIHsKKyAgICAgICAgY2gtPmhlbGxvX2RvbmVfcGFyc2VyID0g
MTsKKyAgICB9CisgICAgaWYgKCFlZGV2KSB7CisgICAgICAgIHJldHVybjsKKyAgICB9CisgICAg
aWYgKCFkZXZpY2Vfb3BzKGVkZXYpLT5nZXRfZGVzY3JpcHRvcihlZGV2LCBMSUJVU0JfRFRfQ09O
RklHLCAwLCAodm9pZCAqKikmY2ZnLCAmc2l6ZSkpIHsKKyAgICAgICAgcmV0dXJuOworICAgIH0K
KyAgICB3aGlsZSAoKG9mZnNldCArIDEpIDwgc2l6ZSkgeworICAgICAgICB1aW50OF90IGxlbiAg
PSBjZmdbb2Zmc2V0XTsKKyAgICAgICAgdWludDhfdCB0eXBlID0gY2ZnW29mZnNldCArIDFdOwor
ICAgICAgICBpZiAoKG9mZnNldCArIGxlbikgPiBzaXplKSB7CisgICAgICAgICAgICBicmVhazsK
KyAgICAgICAgfQorICAgICAgICBpZiAodHlwZSA9PSBMSUJVU0JfRFRfSU5URVJGQUNFKSB7Cisg
ICAgICAgICAgICB1aW50MzJfdCBpID0gaW50ZXJmYWNlX2luZm8uaW50ZXJmYWNlX2NvdW50Owor
ICAgICAgICAgICAgdWludDhfdCBjbGFzcywgc3ViY2xhc3MsIHByb3RvY29sOworICAgICAgICAg
ICAgY2xhc3MgPSBjZmdbb2Zmc2V0ICsgNV07CisgICAgICAgICAgICBzdWJjbGFzcyA9IGNmZ1tv
ZmZzZXQgKyA2XTsKKyAgICAgICAgICAgIHByb3RvY29sID0gY2ZnW29mZnNldCArIDddOworICAg
ICAgICAgICAgaW50ZXJmYWNlX2luZm8uaW50ZXJmYWNlX2NsYXNzW2ldID0gY2xhc3M7CisgICAg
ICAgICAgICBpbnRlcmZhY2VfaW5mby5pbnRlcmZhY2Vfc3ViY2xhc3NbaV0gPSBzdWJjbGFzczsK
KyAgICAgICAgICAgIGludGVyZmFjZV9pbmZvLmludGVyZmFjZV9wcm90b2NvbFtpXSA9IHByb3Rv
Y29sOworICAgICAgICAgICAgaW50ZXJmYWNlX2luZm8uaW50ZXJmYWNlX2NvdW50Kys7CisgICAg
ICAgICAgICBTUElDRV9ERUJVRygiJXMgSUYlZDogJWQvJWQvJWQiLCBfX0ZVTkNUSU9OX18sIGks
IGNsYXNzLCBzdWJjbGFzcywgcHJvdG9jb2wpOworICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT0g
TElCVVNCX0RUX0VORFBPSU5UKSB7CisgICAgICAgICAgICB1aW50OF90IGFkZHJlc3MgPSBjZmdb
b2Zmc2V0ICsgMl07CisgICAgICAgICAgICB1aW50MTZfdCBtYXhfcGFja2V0X3NpemUgPSAweDEw
MCAqIGNmZ1tvZmZzZXQgKyA1XSArIGNmZ1tvZmZzZXQgKyA0XTsKKyAgICAgICAgICAgIHVpbnQ4
X3QgaW5kZXggPSBhZGRyZXNzICYgMHhmOworICAgICAgICAgICAgaWYgKGFkZHJlc3MgJiAweDgw
KSBpbmRleCArPSAweDEwOworICAgICAgICAgICAgZXBfaW5mby50eXBlW2luZGV4XSA9IGNmZ1tv
ZmZzZXQgKyAzXSAmIDB4MzsKKyAgICAgICAgICAgIGVwX2luZm8ubWF4X3BhY2tldF9zaXplW2lu
ZGV4XSA9IG1heF9wYWNrZXRfc2l6ZTsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBFUFsl
MDJYXTogJWQvJWQiLCBfX0ZVTkNUSU9OX18sIGluZGV4LCBlcF9pbmZvLnR5cGVbaW5kZXhdLCBt
YXhfcGFja2V0X3NpemUpOworICAgICAgICB9CisgICAgICAgIG9mZnNldCArPSBsZW47CisgICAg
fQorCisgICAgdXNicmVkaXJwYXJzZXJfc2VuZF9pbnRlcmZhY2VfaW5mbyhjaC0+cGFyc2VyLCAm
aW50ZXJmYWNlX2luZm8pOworICAgIHVzYnJlZGlycGFyc2VyX3NlbmRfZXBfaW5mbyhjaC0+cGFy
c2VyLCAmZXBfaW5mbyk7CisKKyAgICBkZXZpY2VfY29ubmVjdC5kZXZpY2VfY2xhc3MgPSAwOyAv
L2QtPmRldmljZV9pbmZvLmNsYXNzOworICAgIGRldmljZV9jb25uZWN0LmRldmljZV9zdWJjbGFz
cyA9IDA7IC8vZC0+ZGV2aWNlX2luZm8uc3ViY2xhc3M7CisgICAgZGV2aWNlX2Nvbm5lY3QuZGV2
aWNlX3Byb3RvY29sID0gMDsgLy9kLT5kZXZpY2VfaW5mby5wcm90b2NvbDs7CisgICAgZGV2aWNl
X2Nvbm5lY3QudmVuZG9yX2lkID0gZC0+ZGV2aWNlX2luZm8udmlkOworICAgIGRldmljZV9jb25u
ZWN0LnByb2R1Y3RfaWQgPSBkLT5kZXZpY2VfaW5mby5waWQ7CisgICAgZGV2aWNlX2Nvbm5lY3Qu
ZGV2aWNlX3ZlcnNpb25fYmNkID0gZC0+ZGV2aWNlX2luZm8uYmNkVVNCOworICAgIGRldmljZV9j
b25uZWN0LnNwZWVkID0gdXNiX3JlZGlyX3NwZWVkX2hpZ2g7CisgICAgdXNicmVkaXJwYXJzZXJf
c2VuZF9kZXZpY2VfY29ubmVjdChjaC0+cGFyc2VyLCAmZGV2aWNlX2Nvbm5lY3QpOworICAgIHVz
YnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsKK30KKworc3RhdGljIHZvaWQgaW5pdGlh
bGl6ZV9wYXJzZXIoU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsIGdib29sZWFuIGRvX2hlbGxv
KQoreworICAgIHVpbnQzMl90IGZsYWdzLCBjYXBzW1VTQl9SRURJUl9DQVBTX1NJWkVdID0geyAw
IH07CisKKyAgICBnX3JldHVybl9pZl9mYWlsKGNoLT5oaWRkZW5fcGFyc2VyICE9IE5VTEwpOwor
ICAgIGlmIChjaC0+cGFyc2VyX2luaXRfZG9uZSkgeworICAgICAgICBpZiAoY2gtPnBhcnNlcl93
aXRoX2hlbGxvICE9IGRvX2hlbGxvKSB7CisgICAgICAgICAgICBnX3JldHVybl9pZl9yZWFjaGVk
KCk7CisgICAgICAgIH0KKyAgICAgICAgcmV0dXJuOworICAgIH0KKworICAgIGNoLT5wYXJzZXJf
aW5pdF9kb25lID0gMTsKKyAgICBjaC0+cGFyc2VyX3dpdGhfaGVsbG8gPSBkb19oZWxsbzsKKyAg
ICBmbGFncyA9IHVzYnJlZGlycGFyc2VyX2ZsX3dyaXRlX2NiX293bnNfYnVmZmVyIHwgdXNicmVk
aXJwYXJzZXJfZmxfdXNiX2hvc3Q7CisKKyAgICBpZiAoZG9faGVsbG8pIHsKKyAgICAgICAgY2gt
PmhlbGxvX3NlbnQgPSAxOworICAgICAgICBjaC0+aG9zdF9jYXBzIHw9IDEgPDwgdXNiX3JlZGly
X2NhcF9jb25uZWN0X2RldmljZV92ZXJzaW9uOworICAgICAgICBjaC0+aG9zdF9jYXBzIHw9IDEg
PDwgdXNiX3JlZGlyX2NhcF9kZXZpY2VfZGlzY29ubmVjdF9hY2s7CisgICAgICAgIGNoLT5ob3N0
X2NhcHMgfD0gMSA8PCB1c2JfcmVkaXJfY2FwX2VwX2luZm9fbWF4X3BhY2tldF9zaXplOworICAg
ICAgICBjaC0+aG9zdF9jYXBzIHw9IDEgPDwgdXNiX3JlZGlyX2NhcF82NGJpdHNfaWRzOworICAg
ICAgICBjaC0+aG9zdF9jYXBzIHw9IDEgPDwgdXNiX3JlZGlyX2NhcF8zMmJpdHNfYnVsa19sZW5n
dGg7CisgICAgfSBlbHNlIHsKKyAgICAgICAgZmxhZ3MgfD0gdXNicmVkaXJwYXJzZXJfZmxfbm9f
aGVsbG87CisgICAgfQorCisgICAgaWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJf
Y2FwX2Nvbm5lY3RfZGV2aWNlX3ZlcnNpb24pKSB7CisgICAgICAgIHVzYnJlZGlycGFyc2VyX2Nh
cHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJfY2FwX2Nvbm5lY3RfZGV2aWNlX3ZlcnNpb24pOwor
ICAgIH0KKyAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2Nh
cF9maWx0ZXIpOworICAgIGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF9k
ZXZpY2VfZGlzY29ubmVjdF9hY2spKSB7CisgICAgICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0
X2NhcChjYXBzLCB1c2JfcmVkaXJfY2FwX2RldmljZV9kaXNjb25uZWN0X2Fjayk7CisgICAgfQor
ICAgIGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF9lcF9pbmZvX21heF9w
YWNrZXRfc2l6ZSkpIHsKKyAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMs
IHVzYl9yZWRpcl9jYXBfZXBfaW5mb19tYXhfcGFja2V0X3NpemUpOworICAgIH0KKyAgICBpZiAo
Y2gtPmhvc3RfY2FwcyAmICgxIDw8IHVzYl9yZWRpcl9jYXBfNjRiaXRzX2lkcykpIHsKKyAgICAg
ICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfNjRiaXRz
X2lkcyk7CisgICAgfQorICAgIGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2Nh
cF8zMmJpdHNfYnVsa19sZW5ndGgpKSB7CisgICAgICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0
X2NhcChjYXBzLCB1c2JfcmVkaXJfY2FwXzMyYml0c19idWxrX2xlbmd0aCk7CisgICAgfQorICAg
IGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF9idWxrX3N0cmVhbXMpKSB7
CisgICAgICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJfY2Fw
X2J1bGtfc3RyZWFtcyk7CisgICAgfQorICAgIHVzYnJlZGlycGFyc2VyX2luaXQoY2gtPmhpZGRl
bl9wYXJzZXIsIFBBQ0tBR0VfU1RSSU5HLCBjYXBzLCBVU0JfUkVESVJfQ0FQU19TSVpFLCBmbGFn
cyk7Cit9CisKKy8qCisgICAgV2UgY2FuIGluaXRpYWxpemUgdGhlIHVzYnJlZGlycGFyc2VyIHdp
dGggSEVMTE8gZW5hYmxlZCBvbmx5IGluIGNhc2UKKyAgICB0aGUgbGlidXNiIGlzIG5vdCBhY3Rp
dmUgYW5kIHRoZSB1c2JyZWRpcmhvc3QgZG9lcyBub3QgZnVuY3Rpb24uCisgICAgVGhlbiB0aGUg
cGFyc2VyIHNlbmRzIHNlc3Npb24gSEVMTE8gYW5kIHJlY2VpdmVzIHNlcnZlcidzIHJlc3BvbnNl
LgorICAgIE90aGVyd2lzZSAodXNicmVkaXJwYXJzZXIgaW5pdGlhbGl6ZWQgd2l0aCBIRUxMTyBk
aXNhYmxlZCk6CisgICAgLSB0aGUgdXNicmVkaXJob3N0IHNlbmRzIHNlc3Npb24gSEVMTE8KKyAg
ICAtIHdlIGxvb2sgaW50byBpdCB0byBrbm93IHNldCBvZiBjYXBhYmlsaXRpZXMgd2Ugc2hhbGwg
aW5pdGlhbGl6ZQorICAgICAgdGhlIHBhcnNlciB3aXRoCisgICAgLSB3aGVuIHdlIHJlY2VpdmUg
c2VydmVyJ3MgcmVzcG9uc2UgdG8gSEVMTE8gd2UgcHJvdmlkZSBpdCBhbHNvIHRvCisgICAgICBw
YXJzZXIgdG8gbGV0IGl0IHN5bmNocm9uaXplIHdpdGggc2VydmVyJ3MgY2FwYWJpbGl0aWVzCisq
Lworc3RhdGljIHN0cnVjdCB1c2JyZWRpcnBhcnNlciAqY3JlYXRlX3BhcnNlcihTcGljZVVzYkJh
Y2tlbmRDaGFubmVsICpjaCkKK3sKKyAgICBzdHJ1Y3QgdXNicmVkaXJwYXJzZXIgKnBhcnNlciA9
IHVzYnJlZGlycGFyc2VyX2NyZWF0ZSgpOworCisgICAgZ19yZXR1cm5fdmFsX2lmX2ZhaWwocGFy
c2VyICE9IE5VTEwsIE5VTEwpOworCisgICAgcGFyc2VyLT5wcml2ID0gY2g7CisgICAgcGFyc2Vy
LT5sb2dfZnVuYyA9IHVzYnJlZGlyX2xvZzsKKyAgICBwYXJzZXItPnJlYWRfZnVuYyA9IHVzYnJl
ZGlyX3JlYWRfY2FsbGJhY2s7CisgICAgcGFyc2VyLT53cml0ZV9mdW5jID0gdXNicmVkaXJfd3Jp
dGVfY2FsbGJhY2s7CisgICAgcGFyc2VyLT5yZXNldF9mdW5jID0gdXNicmVkaXJfZGV2aWNlX3Jl
c2V0OworICAgIHBhcnNlci0+c2V0X2NvbmZpZ3VyYXRpb25fZnVuYyA9IHVzYnJlZGlyX3NldF9j
b25maWd1cmF0aW9uOworICAgIHBhcnNlci0+Z2V0X2NvbmZpZ3VyYXRpb25fZnVuYyA9IHVzYnJl
ZGlyX2dldF9jb25maWd1cmF0aW9uOworICAgIHBhcnNlci0+c2V0X2FsdF9zZXR0aW5nX2Z1bmMg
PSB1c2JyZWRpcl9zZXRfYWx0X3NldHRpbmc7CisgICAgcGFyc2VyLT5nZXRfYWx0X3NldHRpbmdf
ZnVuYyA9IHVzYnJlZGlyX2dldF9hbHRfc2V0dGluZzsKKyAgICBwYXJzZXItPmNhbmNlbF9kYXRh
X3BhY2tldF9mdW5jID0gdXNicmVkaXJfY2FuY2VsX2RhdGE7CisgICAgcGFyc2VyLT5jb250cm9s
X3BhY2tldF9mdW5jID0gdXNicmVkaXJfY29udHJvbF9wYWNrZXQ7CisgICAgcGFyc2VyLT5idWxr
X3BhY2tldF9mdW5jID0gdXNicmVkaXJfYnVsa19wYWNrZXQ7CisgICAgcGFyc2VyLT5hbGxvY19s
b2NrX2Z1bmMgPSB1c2JyZWRpcl9hbGxvY19sb2NrOworICAgIHBhcnNlci0+bG9ja19mdW5jID0g
dXNicmVkaXJfbG9ja19sb2NrOworICAgIHBhcnNlci0+dW5sb2NrX2Z1bmMgPSB1c2JyZWRpcl91
bmxvY2tfbG9jazsKKyAgICBwYXJzZXItPmZyZWVfbG9ja19mdW5jID0gdXNicmVkaXJfZnJlZV9s
b2NrOworICAgIHBhcnNlci0+aGVsbG9fZnVuYyA9IHVzYnJlZGlyX2hlbGxvOworICAgIHBhcnNl
ci0+ZmlsdGVyX3JlamVjdF9mdW5jID0gdXNicmVkaXJfZmlsdGVyX3JlamVjdDsKKyAgICBwYXJz
ZXItPmRldmljZV9kaXNjb25uZWN0X2Fja19mdW5jID0gdXNicmVkaXJfZGV2aWNlX2Rpc2Nvbm5l
Y3RfYWNrOworICAgIHBhcnNlci0+aW50ZXJmYWNlX2luZm9fZnVuYyA9IHVzYnJlZGlyX2ludGVy
ZmFjZV9pbmZvOworICAgIHBhcnNlci0+ZXBfaW5mb19mdW5jID0gdXNicmVkaXJfaW50ZXJmYWNl
X2VwX2luZm87CisgICAgcGFyc2VyLT5maWx0ZXJfZmlsdGVyX2Z1bmMgPSB1c2JyZWRpcl9maWx0
ZXJfZmlsdGVyOworCisgICAgcmV0dXJuIHBhcnNlcjsKK30KKworc3RhdGljIGdib29sZWFuIGF0
dGFjaF9lZGV2KFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLAorICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqZGV2LAorICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIEdFcnJvciAqKmVycm9yKQoreworICAgIGlmICghZGV2LT5lZGV2KSB7CisgICAg
ICAgIGdfc2V0X2Vycm9yKGVycm9yLCBTUElDRV9DTElFTlRfRVJST1IsIFNQSUNFX0NMSUVOVF9F
UlJPUl9GQUlMRUQsCisgICAgICAgICAgIF8oIkZhaWxlZCB0byByZWRpcmVjdCBkZXZpY2UgJWQi
KSwgMSk7CisgICAgICAgIHJldHVybiBGQUxTRTsKKyAgICB9CisgICAgaWYgKGNoLT51c2JyZWRp
cmhvc3QgJiYgIWNoLT5oZWxsb19kb25lX3BhcnNlcikgeworICAgICAgICAvKgorICAgICAgICAg
ICAgd2UgY2FuJ3QgaW5pdGlhbGl6ZSBwYXJzZXIgdW50aWwgd2Ugc2VlIGhlbGxvIGZyb20gdXNi
cmVkaXIKKyAgICAgICAgICAgIGFuZCB0aGUgcGFyc2VyIGNhbid0IHdvcmsgdW50aWwgaXQgc2Vl
cyB0aGUgaGVsbG8gcmVzcG9uc2UuCisgICAgICAgICAgICB0aGlzIGlzIGNhc2Ugb2YgYXV0b2Nv
bm5lY3Qgd2hlbiBlbXVsYXRlZCBkZXZpY2UgaXMgYXR0YWNoZWQKKyAgICAgICAgICAgIGJlZm9y
ZSB0aGUgY2hhbm5lbCBpcyB1cAorICAgICAgICAqLworICAgICAgICBTUElDRV9ERUJVRygiJXMg
d2FpdGluZyB1bnRpbCB0aGUgY2hhbm5lbCBpcyByZWFkeSIsIF9fRlVOQ1RJT05fXyk7CisKKyAg
ICB9IGVsc2UgeworICAgICAgICBpbml0aWFsaXplX3BhcnNlcihjaCwgY2gtPmhpZGRlbl9ob3N0
ID09IE5VTEwpOworICAgICAgICBjaC0+dXNicmVkaXJob3N0ID0gTlVMTDsKKyAgICAgICAgY2gt
PnBhcnNlciA9IGNoLT5oaWRkZW5fcGFyc2VyOworICAgIH0KKyAgICBjaC0+d2FpdF9kaXNjX2Fj
ayA9IDA7CisgICAgY2gtPmF0dGFjaGVkID0gZGV2OworICAgIGRldi0+YXR0YWNoZWRfdG8gPSBj
aDsKKyAgICBkZXZpY2Vfb3BzKGRldi0+ZWRldiktPmF0dGFjaChkZXYtPmVkZXYsIGNoLT5oaWRk
ZW5fcGFyc2VyKTsKKyAgICBpZiAoY2gtPmhlbGxvX2RvbmVfcGFyc2VyKSB7CisgICAgICAgIC8q
IHNlbmQgZGV2aWNlIGluZm8gKi8KKyAgICAgICAgdXNicmVkaXJfaGVsbG8oY2gsIE5VTEwpOwor
ICAgIH0KKyAgICByZXR1cm4gVFJVRTsKK30KKwogZ2Jvb2xlYW4gc3BpY2VfdXNiX2JhY2tlbmRf
Y2hhbm5lbF9hdHRhY2goU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsCiAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTcGljZVVzYkJhY2tlbmREZXZpY2UgKmRldiwK
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEdFcnJvciAqKmVycm9y
KQpAQCAtNzA2LDcgKzEyMTMsMTMgQEAgZ2Jvb2xlYW4gc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5l
bF9hdHRhY2goU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsCiAKICAgICBnX3JldHVybl92YWxf
aWZfZmFpbChkZXYgIT0gTlVMTCwgRkFMU0UpOwogCisgICAgaWYgKCFkZXYtPmxpYnVzYl9kZXZp
Y2UpIHsKKyAgICAgICAgcmV0dXJuIGF0dGFjaF9lZGV2KGNoLCBkZXYsIGVycm9yKTsKKyAgICB9
CisKICAgICBsaWJ1c2JfZGV2aWNlX2hhbmRsZSAqaGFuZGxlID0gTlVMTDsKKyAgICBjaC0+dXNi
cmVkaXJob3N0ID0gY2gtPmhpZGRlbl9ob3N0OworICAgIGNoLT5wYXJzZXIgPSBOVUxMOwogCiAg
ICAgLyoKICAgICAgICBVbmRlciBXaW5kb3dzIHdlIG5lZWQgdG8gYXZvaWQgdXBkYXRpbmcKQEAg
LTc0MCwxOCArMTI1MywzMyBAQCBnYm9vbGVhbiBzcGljZV91c2JfYmFja2VuZF9jaGFubmVsX2F0
dGFjaChTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwKIAogdm9pZCBzcGljZV91c2JfYmFja2Vu
ZF9jaGFubmVsX2RldGFjaChTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCkKIHsKKyAgICBTcGlj
ZVVzYkJhY2tlbmREZXZpY2UgKmQgPSBjaC0+YXR0YWNoZWQ7CisgICAgU3BpY2VVc2JFbXVsYXRl
ZERldmljZSAqZWRldiA9IGQgPyBkLT5lZGV2IDogTlVMTDsKICAgICBTUElDRV9ERUJVRygiJXMg
Pj4gY2ggJXAsIHdhcyBhdHRhY2hlZCAlcCIsIF9fRlVOQ1RJT05fXywgY2gsIGNoLT5hdHRhY2hl
ZCk7Ci0gICAgaWYgKCFjaC0+YXR0YWNoZWQpIHsKKyAgICBpZiAoIWQpIHsKICAgICAgICAgU1BJ
Q0VfREVCVUcoIiVzOiBub3RoaW5nIHRvIGRldGFjaCIsIF9fRlVOQ1RJT05fXyk7CiAgICAgICAg
IHJldHVybjsKICAgICB9CiAgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKICAgICAgICAgLyog
aXQgd2lsbCBjYWxsIGxpYnVzYl9jbG9zZSBpbnRlcm5hbGx5ICovCiAgICAgICAgIHVzYnJlZGly
aG9zdF9zZXRfZGV2aWNlKGNoLT51c2JyZWRpcmhvc3QsIE5VTEwpOworICAgIH0gZWxzZSBpZiAo
Y2gtPnBhcnNlcikgeworICAgICAgICBpZiAoZWRldikgeworICAgICAgICAgICAgZGV2aWNlX29w
cyhlZGV2KS0+ZGV0YWNoKGVkZXYpOworICAgICAgICB9CisgICAgICAgIHVzYnJlZGlycGFyc2Vy
X3NlbmRfZGV2aWNlX2Rpc2Nvbm5lY3QoY2gtPnBhcnNlcik7CisgICAgICAgIHVzYnJlZGlyX3dy
aXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsKKyAgICAgICAgY2gtPndhaXRfZGlzY19hY2sgPSB1c2Jy
ZWRpcnBhcnNlcl9wZWVyX2hhc19jYXAoY2gtPnBhcnNlciwKKyAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNiX3JlZGlyX2NhcF9kZXZpY2Vf
ZGlzY29ubmVjdF9hY2spOworICAgICAgICBpZiAoIWNoLT53YWl0X2Rpc2NfYWNrKSB7CisgICAg
ICAgICAgICBjaC0+dXNicmVkaXJob3N0ID0gY2gtPmhpZGRlbl9ob3N0OworICAgICAgICAgICAg
Y2gtPnBhcnNlciA9IE5VTEw7CisgICAgICAgIH0KICAgICB9CiAgICAgU1BJQ0VfREVCVUcoIiVz
IGNoICVwLCBkZXRhY2ggZG9uZSIsIF9fRlVOQ1RJT05fXywgY2gpOwogICAgIGNoLT5hdHRhY2hl
ZC0+YXR0YWNoZWRfdG8gPSBOVUxMOwogICAgIGNoLT5hdHRhY2hlZCA9IE5VTEw7CisgICAgY2gt
PnJlamVjdGVkID0gMDsKIH0KIAogU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqc3BpY2VfdXNiX2Jh
Y2tlbmRfY2hhbm5lbF9uZXcoU3BpY2VVc2JCYWNrZW5kICpiZSwKQEAgLTc2NiwyNiArMTI5NCwz
MyBAQCBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpzcGljZV91c2JfYmFja2VuZF9jaGFubmVsX25l
dyhTcGljZVVzYkJhY2tlbmQgKmJlLAogICAgIGNoLT51c2VyX2RhdGEgPSBTUElDRV9VU0JSRURJ
Ul9DSEFOTkVMKHVzZXJfZGF0YSk7CiAgICAgaWYgKGJlLT5saWJ1c2JfY29udGV4dCkgewogICAg
ICAgICBjaC0+YmFja2VuZCA9IGJlOwotICAgICAgICBjaC0+dXNicmVkaXJob3N0ID0gdXNicmVk
aXJob3N0X29wZW5fZnVsbCgKLSAgICAgICAgICAgIGJlLT5saWJ1c2JfY29udGV4dCwKLSAgICAg
ICAgICAgIE5VTEwsCi0gICAgICAgICAgICB1c2JyZWRpcl9sb2csCi0gICAgICAgICAgICB1c2Jy
ZWRpcl9yZWFkX2NhbGxiYWNrLAotICAgICAgICAgICAgdXNicmVkaXJfd3JpdGVfY2FsbGJhY2ss
Ci0gICAgICAgICAgICB1c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFjaywKLSAgICAgICAgICAg
IHVzYnJlZGlyX2FsbG9jX2xvY2ssCi0gICAgICAgICAgICB1c2JyZWRpcl9sb2NrX2xvY2ssCi0g
ICAgICAgICAgICB1c2JyZWRpcl91bmxvY2tfbG9jaywKLSAgICAgICAgICAgIHVzYnJlZGlyX2Zy
ZWVfbG9jaywKLSAgICAgICAgICAgIGNoLCBQQUNLQUdFX1NUUklORywKLSAgICAgICAgICAgIHNw
aWNlX3V0aWxfZ2V0X2RlYnVnKCkgPyB1c2JyZWRpcnBhcnNlcl9kZWJ1ZyA6IHVzYnJlZGlycGFy
c2VyX3dhcm5pbmcsCi0gICAgICAgICAgICB1c2JyZWRpcmhvc3RfZmxfd3JpdGVfY2Jfb3duc19i
dWZmZXIpOworICAgICAgICBjaC0+dXNicmVkaXJob3N0ID0KKyAgICAgICAgICAgIHVzYnJlZGly
aG9zdF9vcGVuX2Z1bGwoYmUtPmxpYnVzYl9jb250ZXh0LAorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICBOVUxMLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1
c2JyZWRpcl9sb2csCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzYnJlZGly
X3JlYWRfY2FsbGJhY2ssCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzYnJl
ZGlyX3dyaXRlX2NhbGxiYWNrLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1
c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFjaywKKyAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgdXNicmVkaXJfYWxsb2NfbG9jaywKKyAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgdXNicmVkaXJfbG9ja19sb2NrLAorICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICB1c2JyZWRpcl91bmxvY2tfbG9jaywKKyAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgdXNicmVkaXJfZnJlZV9sb2NrLAorICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICBjaCwgUEFDS0FHRV9TVFJJTkcsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIHNwaWNlX3V0aWxfZ2V0X2RlYnVnKCkgPyB1c2JyZWRpcnBhcnNlcl9kZWJ1ZyA6Cisg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNicmVkaXJwYXJzZXJfd2Fy
bmluZywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNicmVkaXJob3N0X2Zs
X3dyaXRlX2NiX293bnNfYnVmZmVyKTsKICAgICAgICAgZ193YXJuX2lmX2ZhaWwoY2gtPnVzYnJl
ZGlyaG9zdCAhPSBOVUxMKTsKICAgICB9CisKICAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgewot
ICAgICAgICB1c2JyZWRpcmhvc3Rfc2V0X2J1ZmZlcmVkX291dHB1dF9zaXplX2NiKGNoLT51c2Jy
ZWRpcmhvc3QsIHVzYnJlZGlyX2J1ZmZlcmVkX291dHB1dF9zaXplX2NhbGxiYWNrKTsKLSAgICB9
IGVsc2UgewotICAgICAgICBnX2ZyZWUoY2gpOworICAgICAgICBjaC0+aGlkZGVuX3BhcnNlciA9
IGNyZWF0ZV9wYXJzZXIoY2gpOworICAgICAgICBjaC0+aGlkZGVuX2hvc3QgPSBjaC0+dXNicmVk
aXJob3N0OworICAgICAgICB1c2JyZWRpcmhvc3Rfc2V0X2J1ZmZlcmVkX291dHB1dF9zaXplX2Ni
KGNoLT51c2JyZWRpcmhvc3QsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgdXNicmVkaXJfYnVmZmVyZWRfb3V0cHV0X3NpemVfY2FsbGJhY2spOworICAg
IH0KKworICAgIGlmICghY2gtPmhpZGRlbl9wYXJzZXIpIHsKKyAgICAgICAgc3BpY2VfdXNiX2Jh
Y2tlbmRfY2hhbm5lbF9kZWxldGUoY2gpOwogICAgICAgICBjaCA9IE5VTEw7CiAgICAgfQogCkBA
IC03OTUsOSArMTMzMCwxNCBAQCBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpzcGljZV91c2JfYmFj
a2VuZF9jaGFubmVsX25ldyhTcGljZVVzYkJhY2tlbmQgKmJlLAogCiB2b2lkIHNwaWNlX3VzYl9i
YWNrZW5kX2NoYW5uZWxfZmx1c2hfd3JpdGVzKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoKQog
ewotICAgIFNQSUNFX0RFQlVHKCIlcyAlcCwgaG9zdCAlcCIsIF9fRlVOQ1RJT05fXywgY2gsIGNo
LT51c2JyZWRpcmhvc3QpOworICAgIFNQSUNFX0RFQlVHKCIlcyAlcCBpcyB1cCIsIF9fRlVOQ1RJ
T05fXywgY2gpOwogICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7CiAgICAgICAgIHVzYnJlZGly
aG9zdF93cml0ZV9ndWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3QpOworICAgICAgICBpbml0aWFs
aXplX3BhcnNlcihjaCwgRkFMU0UpOworICAgIH0gZWxzZSB7CisgICAgICAgIGluaXRpYWxpemVf
cGFyc2VyKGNoLCBUUlVFKTsKKyAgICAgICAgY2gtPnBhcnNlciA9IGNoLT5oaWRkZW5fcGFyc2Vy
OworICAgICAgICB1c2JyZWRpcnBhcnNlcl9kb193cml0ZShjaC0+cGFyc2VyKTsKICAgICB9CiB9
CiAKQEAgLTgwNywxMiArMTM0NywxNiBAQCB2b2lkIHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxf
ZGVsZXRlKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoKQogICAgIGlmICghY2gpIHsKICAgICAg
ICAgcmV0dXJuOwogICAgIH0KLSAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgewotICAgICAgICB1
c2JyZWRpcmhvc3RfY2xvc2UoY2gtPnVzYnJlZGlyaG9zdCk7CisgICAgaWYgKGNoLT5oaWRkZW5f
aG9zdCkgeworICAgICAgICB1c2JyZWRpcmhvc3RfY2xvc2UoY2gtPmhpZGRlbl9ob3N0KTsKKyAg
ICB9CisgICAgaWYgKGNoLT5oaWRkZW5fcGFyc2VyKSB7CisgICAgICAgIHVzYnJlZGlycGFyc2Vy
X2Rlc3Ryb3koY2gtPmhpZGRlbl9wYXJzZXIpOwogICAgIH0KIAogICAgIGlmIChjaC0+cnVsZXMp
IHsKLSAgICAgICAgZ19mcmVlKGNoLT5ydWxlcyk7CisgICAgICAgIC8qIHJ1bGVzIHdlcmUgYWxs
b2NhdGVkIGJ5IHVzYnJlZGlycGFyc2VyICovCisgICAgICAgIGZyZWUoY2gtPnJ1bGVzKTsKICAg
ICB9CiAKICAgICBnX2ZyZWUoY2gpOwotLSAKMi4xNy4xCgpfX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fXwpTcGljZS1kZXZlbCBtYWlsaW5nIGxpc3QKU3BpY2Ut
ZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3Jn
L21haWxtYW4vbGlzdGluZm8vc3BpY2UtZGV2ZWw=
