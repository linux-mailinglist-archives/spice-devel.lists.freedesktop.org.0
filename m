Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id EE7F887CB5
	for <lists+spice-devel@lfdr.de>; Fri,  9 Aug 2019 16:28:21 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 630F46EE35;
	Fri,  9 Aug 2019 14:28:20 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id CCB9F6EE34
 for <spice-devel@lists.freedesktop.org>; Fri,  9 Aug 2019 14:28:18 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx07.intmail.prod.int.phx2.redhat.com
 [10.5.11.22])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 736FA30A5411;
 Fri,  9 Aug 2019 14:28:18 +0000 (UTC)
Received: from fziglio.remote.csb (ovpn-204-160.brq.redhat.com [10.40.204.160])
 by smtp.corp.redhat.com (Postfix) with ESMTP id 7265B1001284;
 Fri,  9 Aug 2019 14:28:16 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Fri,  9 Aug 2019 15:26:42 +0100
Message-Id: <20190809142651.2967-25-fziglio@redhat.com>
In-Reply-To: <20190809142651.2967-1-fziglio@redhat.com>
References: <20190809142651.2967-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.84 on 10.5.11.22
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.42]); Fri, 09 Aug 2019 14:28:18 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-gtk v2 24/33] usb-redir: add
 implementation of emulated CD device
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

RnJvbTogWXVyaSBCZW5kaXRvdmljaCA8eXVyaS5iZW5kaXRvdmljaEBkYXluaXguY29tPgoKVGhp
cyBtb2R1bGUgY29udGFpbnMgaW1wbGVtZW50YXRpb24gb2YgZW11bGF0ZWQgZGV2aWNlCmludGVy
ZmFjZSBmb3Igc2hhcmVkIENELgoKU2lnbmVkLW9mZi1ieTogWXVyaSBCZW5kaXRvdmljaCA8eXVy
aS5iZW5kaXRvdmljaEBkYXluaXguY29tPgotLS0KIHNyYy91c2ItZGV2aWNlLWNkLmMgfCA3OTAg
KysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysKIHNyYy91c2ItZGV2
aWNlLWNkLmggfCAgMzcgKysrCiAyIGZpbGVzIGNoYW5nZWQsIDgyNyBpbnNlcnRpb25zKCspCiBj
cmVhdGUgbW9kZSAxMDA2NDQgc3JjL3VzYi1kZXZpY2UtY2QuYwogY3JlYXRlIG1vZGUgMTAwNjQ0
IHNyYy91c2ItZGV2aWNlLWNkLmgKCmRpZmYgLS1naXQgYS9zcmMvdXNiLWRldmljZS1jZC5jIGIv
c3JjL3VzYi1kZXZpY2UtY2QuYwpuZXcgZmlsZSBtb2RlIDEwMDY0NAppbmRleCAwMDAwMDAwMC4u
YjUxOTNkMWUKLS0tIC9kZXYvbnVsbAorKysgYi9zcmMvdXNiLWRldmljZS1jZC5jCkBAIC0wLDAg
KzEsNzkwIEBACisvKiAtKi0gTW9kZTogQzsgYy1iYXNpYy1vZmZzZXQ6IDQ7IGluZGVudC10YWJz
LW1vZGU6IG5pbCAtKi0gKi8KKy8qCisgICAgQ29weXJpZ2h0IChDKSAyMDE5IFJlZCBIYXQsIElu
Yy4KKworICAgIFJlZCBIYXQgQXV0aG9yczoKKyAgICBZdXJpIEJlbmRpdG92aWNoPHliZW5kaXRv
QHJlZGhhdC5jb20+CisKKyAgICBUaGlzIGxpYnJhcnkgaXMgZnJlZSBzb2Z0d2FyZTsgeW91IGNh
biByZWRpc3RyaWJ1dGUgaXQgYW5kL29yCisgICAgbW9kaWZ5IGl0IHVuZGVyIHRoZSB0ZXJtcyBv
ZiB0aGUgR05VIExlc3NlciBHZW5lcmFsIFB1YmxpYworICAgIExpY2Vuc2UgYXMgcHVibGlzaGVk
IGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlcgorICAgIHZlcnNpb24gMi4x
IG9mIHRoZSBMaWNlbnNlLCBvciAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgor
CisgICAgVGhpcyBsaWJyYXJ5IGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2ls
bCBiZSB1c2VmdWwsCisgICAgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4g
dGhlIGltcGxpZWQgd2FycmFudHkgb2YKKyAgICBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBG
T1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlIEdOVQorICAgIExlc3NlciBHZW5lcmFs
IFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCisKKyAgICBZb3Ugc2hvdWxkIGhhdmUg
cmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgTGVzc2VyIEdlbmVyYWwgUHVibGljCisgICAgTGlj
ZW5zZSBhbG9uZyB3aXRoIHRoaXMgbGlicmFyeTsgaWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251
Lm9yZy9saWNlbnNlcy8+LgorKi8KKworI2luY2x1ZGUgImNvbmZpZy5oIgorCisjaWZkZWYgVVNF
X1VTQlJFRElSCisKKyNpbmNsdWRlIDxnbGliLW9iamVjdC5oPgorI2luY2x1ZGUgPGludHR5cGVz
Lmg+CisjaW5jbHVkZSA8Z2lvL2dpby5oPgorI2luY2x1ZGUgPGdsaWIvZ2kxOG4tbGliLmg+Cisj
aW5jbHVkZSA8ZXJybm8uaD4KKyNpbmNsdWRlIDxsaWJ1c2IuaD4KKyNpbmNsdWRlIDxmY250bC5o
PgorCisjaWZkZWYgR19PU19XSU4zMgorI2luY2x1ZGUgPHdpbmRvd3MuaD4KKyNpbmNsdWRlIDxu
dGRkY2RybS5oPgorI2luY2x1ZGUgPG50ZGRtbWMuaD4KKyNlbHNlCisjaW5jbHVkZSA8c3lzL3N0
YXQuaD4KKyNpbmNsdWRlIDxzeXMvaW9jdGwuaD4KKyNpbmNsdWRlIDxsaW51eC9mcy5oPgorI2lu
Y2x1ZGUgPGxpbnV4L2Nkcm9tLmg+CisjZW5kaWYKKworI2luY2x1ZGUgInVzYi1lbXVsYXRpb24u
aCIKKyNpbmNsdWRlICJ1c2ItZGV2aWNlLWNkLmgiCisjaW5jbHVkZSAiY2QtdXNiLWJ1bGstbXNk
LmgiCisKK3R5cGVkZWYgc3RydWN0IFNwaWNlQ2RMVSB7CisgICAgY2hhciAqZmlsZW5hbWU7Cisg
ICAgR0ZpbGUgKmZpbGVfb2JqZWN0OworICAgIEdGaWxlSW5wdXRTdHJlYW0gKnN0cmVhbTsKKyAg
ICB1aW50NjRfdCBzaXplOworICAgIHVpbnQzMl90IGJsb2NrU2l6ZTsKKyAgICB1aW50MzJfdCBs
b2FkZWQgOiAxOworICAgIHVpbnQzMl90IGRldmljZSA6IDE7Cit9IFNwaWNlQ2RMVTsKKworI2Rl
ZmluZSBNQVhfTFVOX1BFUl9ERVZJQ0UgICAgICAgICAgICAgIDEKKyNkZWZpbmUgVVNCMl9CQ0Qg
ICAgICAgICAgICAgICAgICAgICAgICAweDIwMAorI2RlZmluZSBDRF9ERVZfVklEICAgICAgICAg
ICAgICAgICAgICAgIDB4MmIyMworI2RlZmluZSBDRF9ERVZfUElEICAgICAgICAgICAgICAgICAg
ICAgIDB4Q0RDRAorI2RlZmluZSBDRF9ERVZfQ0xBU1MgICAgICAgICAgICAgICAgICAgIDgKKyNk
ZWZpbmUgQ0RfREVWX1NVQkNMQVNTICAgICAgICAgICAgICAgICA2CisjZGVmaW5lIENEX0RFVl9Q
Uk9UT0NPTCAgICAgICAgICAgICAgICAgMHg1MAorI2RlZmluZSBDRF9ERVZfQkxPQ0tfU0laRSAg
ICAgICAgICAgICAgIDB4MjAwCisjZGVmaW5lIERWRF9ERVZfQkxPQ0tfU0laRSAgICAgICAgICAg
ICAgMHg4MDAKKyNkZWZpbmUgTUFYX0JVTEtfSU5fUkVRVUVTVFMgICAgICAgICAgICA2NAorCitz
dHJ1Y3QgQnVmZmVyZWRCdWxrUmVhZCB7CisgICAgc3RydWN0IHVzYl9yZWRpcl9idWxrX3BhY2tl
dF9oZWFkZXIgaG91dDsKKyAgICB1aW50NjRfdCBpZDsKK307CisKK3N0cnVjdCBTcGljZVVzYkVt
dWxhdGVkRGV2aWNlIHsKKyAgICBVc2JEZXZpY2VPcHMgZGV2X29wczsKKyAgICBTcGljZVVzYkJh
Y2tlbmQgKmJhY2tlbmQ7CisgICAgU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpwYXJlbnQ7CisgICAg
c3RydWN0IHVzYnJlZGlycGFyc2VyICpwYXJzZXI7CisgICAgVXNiQ2RCdWxrTXNkRGV2aWNlKiBt
c2M7CisgICAgU3BpY2VDZExVIHVuaXRzW01BWF9MVU5fUEVSX0RFVklDRV07CisgICAgZ2Jvb2xl
YW4gbG9ja2VkOworICAgIGdib29sZWFuIGRlbGV0ZV9vbl9lamVjdDsKKyAgICBnYm9vbGVhbiBk
ZWxldGluZzsKKyAgICB1aW50MzJfdCBudW1fcmVhZHM7CisgICAgc3RydWN0IEJ1ZmZlcmVkQnVs
a1JlYWQgcmVhZF9idWxrW01BWF9CVUxLX0lOX1JFUVVFU1RTXTsKKyAgICAvKiBhY2NvcmRpbmcg
dG8gVVNCIE1TQyBzcGVjICovCisgICAgdWludDE2X3Qgc2VyaWFsWzEyXTsKKyAgICB1aW50OF90
ICBtYXhfbHVuX2luZGV4OworfTsKKwordHlwZWRlZiBzdHJ1Y3QgU3BpY2VVc2JFbXVsYXRlZERl
dmljZSBVc2JDZDsKKworI2lmbmRlZiBHX09TX1dJTjMyCisKK3N0YXRpYyBpbnQgY2RfZGV2aWNl
X29wZW5fc3RyZWFtKFNwaWNlQ2RMVSAqdW5pdCwgY29uc3QgY2hhciAqZmlsZW5hbWUpCit7Cisg
ICAgaW50IGVycm9yID0gMDsKKyAgICB1bml0LT5kZXZpY2UgPSAwOworCisgICAgaWYgKCF1bml0
LT5maWxlbmFtZSAmJiAhZmlsZW5hbWUpIHsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBmaWxl
IG5hbWUgbm90IHByb3ZpZGVkIiwgX19GVU5DVElPTl9fKTsKKyAgICAgICAgcmV0dXJuIC0xOwor
ICAgIH0KKyAgICBpZiAodW5pdC0+ZmlsZW5hbWUgJiYgZmlsZW5hbWUpIHsKKyAgICAgICAgZ19m
cmVlKHVuaXQtPmZpbGVuYW1lKTsKKyAgICAgICAgdW5pdC0+ZmlsZW5hbWUgPSBOVUxMOworICAg
IH0KKyAgICBpZiAoZmlsZW5hbWUpIHsKKyAgICAgICAgdW5pdC0+ZmlsZW5hbWUgPSBnX3N0cmR1
cChmaWxlbmFtZSk7CisgICAgfQorCisgICAgaW50IGZkID0gb3Blbih1bml0LT5maWxlbmFtZSwg
T19SRE9OTFkgfCBPX05PTkJMT0NLKTsKKyAgICBpZiAoZmQgPiAwKSB7CisgICAgICAgIHN0cnVj
dCBzdGF0IGZpbGVfc3RhdCA9IHsgMCB9OworICAgICAgICBpZiAoZnN0YXQoZmQsICZmaWxlX3N0
YXQpIHx8IGZpbGVfc3RhdC5zdF9zaXplID09IDApIHsKKyAgICAgICAgICAgIGZpbGVfc3RhdC5z
dF9zaXplID0gMDsKKyAgICAgICAgICAgIHVuaXQtPmRldmljZSA9IDE7CisgICAgICAgICAgICBp
ZiAoIWlvY3RsKGZkLCBCTEtHRVRTSVpFNjQsICZmaWxlX3N0YXQuc3Rfc2l6ZSkgJiYKKyAgICAg
ICAgICAgICAgICAhaW9jdGwoZmQsIEJMS1NTWkdFVCwgJnVuaXQtPmJsb2NrU2l6ZSkpIHsKKyAg
ICAgICAgICAgIH0KKyAgICAgICAgfQorICAgICAgICB1bml0LT5zaXplID0gZmlsZV9zdGF0LnN0
X3NpemU7CisgICAgICAgIGNsb3NlKGZkKTsKKyAgICAgICAgaWYgKHVuaXQtPnNpemUpIHsKKyAg
ICAgICAgICAgIHVuaXQtPmZpbGVfb2JqZWN0ID0gZ19maWxlX25ld19mb3JfcGF0aCh1bml0LT5m
aWxlbmFtZSk7CisgICAgICAgICAgICB1bml0LT5zdHJlYW0gPSBnX2ZpbGVfcmVhZCh1bml0LT5m
aWxlX29iamVjdCwgTlVMTCwgTlVMTCk7CisgICAgICAgIH0KKyAgICAgICAgaWYgKCF1bml0LT5z
dHJlYW0pIHsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlczogY2FuJ3Qgb3BlbiBzdHJlYW0g
b24gJXMiLCBfX0ZVTkNUSU9OX18sIHVuaXQtPmZpbGVuYW1lKTsKKyAgICAgICAgICAgIGdfY2xl
YXJfb2JqZWN0KCZ1bml0LT5maWxlX29iamVjdCk7CisgICAgICAgICAgICBlcnJvciA9IC0xOwor
ICAgICAgICB9CisgICAgfQorICAgIGVsc2UgeworICAgICAgICBTUElDRV9ERUJVRygiJXM6IGNh
bid0IG9wZW4gZmlsZSAlcyIsIF9fRlVOQ1RJT05fXywgdW5pdC0+ZmlsZW5hbWUpOworICAgICAg
ICBlcnJvciA9IC0xOworICAgIH0KKworICAgIHJldHVybiBlcnJvcjsKK30KKworc3RhdGljIGlu
dCBjZF9kZXZpY2VfbG9hZChTcGljZUNkTFUgKnVuaXQsIGdib29sZWFuIGxvYWQpCit7CisgICAg
aW50IGVycm9yOworICAgIGlmICghdW5pdC0+ZGV2aWNlIHx8ICF1bml0LT5maWxlbmFtZSkgewor
ICAgICAgICByZXR1cm4gLTE7CisgICAgfQorICAgIGludCBmZCA9IG9wZW4odW5pdC0+ZmlsZW5h
bWUsIE9fUkRPTkxZIHwgT19OT05CTE9DSyk7CisgICAgaWYgKGZkIDwgMCkgeworICAgICAgICBy
ZXR1cm4gLTE7CisgICAgfQorICAgIGlmIChsb2FkKSB7CisgICAgICAgIGVycm9yID0gaW9jdGwo
ZmQsIENEUk9NQ0xPU0VUUkFZLCAwKTsKKyAgICB9IGVsc2UgeworICAgICAgICBlcnJvciA9IGlv
Y3RsKGZkLCBDRFJPTV9MT0NLRE9PUiwgMCk7CisgICAgICAgIGVycm9yID0gaW9jdGwoZmQsIENE
Uk9NRUpFQ1QsIDApOworICAgIH0KKyAgICBpZiAoZXJyb3IpIHsKKyAgICAgICAgLy8gbm90ZSB0
aGF0IGVqZWN0aW5nIG1pZ2h0IGJlIGF2YWlsYWJsZSBvbmx5IGZvciByb290CisgICAgICAgIC8v
IGxvYWRpbmcgbWlnaHQgYmUgYXZhaWxhYmxlIGFsc28gZm9yIHJlZ3VsYXIgdXNlcgorICAgICAg
ICBTUElDRV9ERUJVRygiJXM6IGNhbid0ICVzbG9hZCAlcywgcmVzICVkLCBlcnJubyAlZCIsCisg
ICAgICAgICAgICBfX0ZVTkNUSU9OX18sIGxvYWQgPyAiIiA6ICJ1biIsIHVuaXQtPmZpbGVuYW1l
LCBlcnJvciwgZXJybm8pOworICAgIH0KKyAgICBjbG9zZShmZCk7CisgICAgcmV0dXJuIGVycm9y
OworfQorCitzdGF0aWMgaW50IGNkX2RldmljZV9jaGVjayhTcGljZUNkTFUgKnVuaXQpCit7Cisg
ICAgaW50IGVycm9yOworICAgIGlmICghdW5pdC0+ZGV2aWNlIHx8ICF1bml0LT5maWxlbmFtZSkg
eworICAgICAgICByZXR1cm4gLTE7CisgICAgfQorICAgIGludCBmZCA9IG9wZW4odW5pdC0+Zmls
ZW5hbWUsIE9fUkRPTkxZIHwgT19OT05CTE9DSyk7CisgICAgaWYgKGZkIDwgMCkgeworICAgICAg
ICByZXR1cm4gLTE7CisgICAgfQorICAgIGVycm9yID0gaW9jdGwoZmQsIENEUk9NX0RSSVZFX1NU
QVRVUywgMCk7CisgICAgZXJyb3IgPSAoZXJyb3IgPT0gQ0RTX0RJU0NfT0spID8gMCA6IC0xOwor
ICAgIGlmICghZXJyb3IpIHsKKyAgICAgICAgZXJyb3IgPSBpb2N0bChmZCwgQ0RST01fRElTQ19T
VEFUVVMsIDApOworICAgICAgICBlcnJvciA9IChlcnJvciA9PSBDRFNfREFUQV8xKSA/IDAgOiAt
MTsKKyAgICB9CisgICAgY2xvc2UoZmQpOworICAgIHJldHVybiBlcnJvcjsKK30KKworI2Vsc2UK
Kworc3RhdGljIGdib29sZWFuIGlzX2RldmljZV9uYW1lKGNvbnN0IGNoYXIgKmZpbGVuYW1lKQor
eworICAgIHJldHVybiBnX2FzY2lpX2lzYWxwaGEoZmlsZW5hbWVbMF0pICYmIGZpbGVuYW1lWzFd
ID09ICc6JyAmJgorICAgICAgICBmaWxlbmFtZVsyXSA9PSAwOworfQorCitzdGF0aWMgSEFORExF
IG9wZW5fZmlsZShjb25zdCBjaGFyICpmaWxlbmFtZSkKK3sKKyAgICBIQU5ETEUgaCA9IENyZWF0
ZUZpbGVBKGZpbGVuYW1lLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgR0VORVJJQ19SRUFE
LAorICAgICAgICAgICAgICAgICAgICAgICAgICAgRklMRV9TSEFSRV9SRUFELAorICAgICAgICAg
ICAgICAgICAgICAgICAgICAgTlVMTCwgT1BFTl9FWElTVElORywKKyAgICAgICAgICAgICAgICAg
ICAgICAgICAgIDAsCisgICAgICAgICAgICAgICAgICAgICAgICAgICBOVUxMKTsKKyAgICBpZiAo
aCA9PSBJTlZBTElEX0hBTkRMRV9WQUxVRSkgeworICAgICAgICBoID0gTlVMTDsKKyAgICB9Cisg
ICAgcmV0dXJuIGg7Cit9CisKK3N0YXRpYyB1aW50MzJfdCBpb2N0bF9vdXQoSEFORExFIGgsIHVp
bnQzMl90IGNvZGUsIHZvaWQgKm91dF9idWZmZXIsIHVpbnQzMl90IG91dF9zaXplKQoreworICAg
IHVpbnQzMl90IGVycm9yOworICAgIERXT1JEIHJldDsKKyAgICBCT09MIGIgPSBEZXZpY2VJb0Nv
bnRyb2woaCwgY29kZSwgTlVMTCwgMCwgb3V0X2J1ZmZlciwgb3V0X3NpemUsICZyZXQsIE5VTEwp
OworICAgIGVycm9yID0gYiA/IDAgOiBHZXRMYXN0RXJyb3IoKTsKKyAgICByZXR1cm4gZXJyb3I7
Cit9CisKK3N0YXRpYyB1aW50MzJfdCBpb2N0bF9ub25lKEhBTkRMRSBoLCB1aW50MzJfdCBjb2Rl
KQoreworICAgIHJldHVybiBpb2N0bF9vdXQoaCwgY29kZSwgTlVMTCwgMCk7Cit9CisKK3N0YXRp
YyBnYm9vbGVhbiBjaGVja19kZXZpY2UoSEFORExFIGgpCit7CisgICAgR0VUX0NPTkZJR1VSQVRJ
T05fSU9DVExfSU5QVVQgY2ZnSW4gPQorICAgICAgICB7IEZlYXR1cmVDZFJlYWQsIFNDU0lfR0VU
X0NPTkZJR1VSQVRJT05fUkVRVUVTVF9UWVBFX0FMTCwge30gfTsKKyAgICBEV09SRCByZXQ7Cisg
ICAgR0VUX0NPTkZJR1VSQVRJT05fSEVBREVSIGNmZ091dDsKKyAgICByZXR1cm4gRGV2aWNlSW9D
b250cm9sKGgsIElPQ1RMX0NEUk9NX0dFVF9DT05GSUdVUkFUSU9OLAorICAgICAgICAgICAgICAg
ICAgICAgICAgICAgJmNmZ0luLCBzaXplb2YoY2ZnSW4pLCAmY2ZnT3V0LCBzaXplb2YoY2ZnT3V0
KSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICZyZXQsIE5VTEwpOworfQorCitzdGF0aWMg
aW50IGNkX2RldmljZV9vcGVuX3N0cmVhbShTcGljZUNkTFUgKnVuaXQsIGNvbnN0IGNoYXIgKmZp
bGVuYW1lKQoreworICAgIGludCBlcnJvciA9IDA7CisgICAgSEFORExFIGg7CisgICAgdW5pdC0+
ZGV2aWNlID0gMDsKKyAgICBpZiAoIXVuaXQtPmZpbGVuYW1lICYmICFmaWxlbmFtZSkgeworICAg
ICAgICBTUElDRV9ERUJVRygiJXM6IHVubmFtZWQgZmlsZSIsIF9fRlVOQ1RJT05fXyk7CisgICAg
ICAgIHJldHVybiAtMTsKKyAgICB9CisgICAgaWYgKHVuaXQtPmZpbGVuYW1lICYmIGZpbGVuYW1l
KSB7CisgICAgICAgIGdfZnJlZSh1bml0LT5maWxlbmFtZSk7CisgICAgICAgIHVuaXQtPmZpbGVu
YW1lID0gTlVMTDsKKyAgICB9CisgICAgaWYgKCFmaWxlbmFtZSkgeworICAgICAgICAvLyByZW9w
ZW5pbmcgdGhlIHN0cmVhbSBvbiBleGlzdGluZyBmaWxlIG5hbWUKKyAgICB9IGVsc2UgaWYgKGlz
X2RldmljZV9uYW1lKGZpbGVuYW1lKSkgeworICAgICAgICB1bml0LT5maWxlbmFtZSA9IGdfc3Ry
ZHVwX3ByaW50ZigiXFxcXC5cXCVzIiwgZmlsZW5hbWUpOworICAgIH0gZWxzZSB7CisgICAgICAg
IHVuaXQtPmZpbGVuYW1lID0gZ19zdHJkdXAoZmlsZW5hbWUpOworICAgIH0KKyAgICBoID0gb3Bl
bl9maWxlKHVuaXQtPmZpbGVuYW1lKTsKKyAgICBpZiAoaCkgeworICAgICAgICBMQVJHRV9JTlRF
R0VSIHNpemUgPSB7IDAgfTsKKyAgICAgICAgaWYgKCFHZXRGaWxlU2l6ZUV4KGgsICZzaXplKSkg
eworICAgICAgICAgICAgdWludDY0X3QgYnVmZmVyWzI1Nl07CisgICAgICAgICAgICB1aW50MzJf
dCByZXM7CisgICAgICAgICAgICB1bml0LT5kZXZpY2UgPSBjaGVja19kZXZpY2UoaCk7CisgICAg
ICAgICAgICBTUElDRV9ERUJVRygiJXM6IENEIGRldmljZSAlc3JlY29nbml6ZWQgb24gJXMiLAor
ICAgICAgICAgICAgICAgIF9fRlVOQ1RJT05fXywgdW5pdC0+ZGV2aWNlID8gIiIgOiAiTk9UICIs
IHVuaXQtPmZpbGVuYW1lKTsKKyAgICAgICAgICAgIHJlcyA9IGlvY3RsX291dChoLCBJT0NUTF9E
SVNLX0dFVF9EUklWRV9HRU9NRVRSWV9FWCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICBi
dWZmZXIsIHNpemVvZihidWZmZXIpKTsKKyAgICAgICAgICAgIGlmICghcmVzKQorICAgICAgICAg
ICAgeworICAgICAgICAgICAgICAgIERJU0tfR0VPTUVUUllfRVggKnBnID0gKERJU0tfR0VPTUVU
UllfRVggKilidWZmZXI7CisgICAgICAgICAgICAgICAgdW5pdC0+YmxvY2tTaXplID0gcGctPkdl
b21ldHJ5LkJ5dGVzUGVyU2VjdG9yOworICAgICAgICAgICAgICAgIHNpemUgPSBwZy0+RGlza1Np
emU7CisgICAgICAgICAgICB9IGVsc2UgeworICAgICAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIl
czogY2FuJ3Qgb2J0YWluIHNpemUgb2YgJXMgKGVycm9yICV1KSIsCisgICAgICAgICAgICAgICAg
ICAgIF9fRlVOQ1RJT05fXywgdW5pdC0+ZmlsZW5hbWUsIHJlcyk7CisgICAgICAgICAgICB9Cisg
ICAgICAgIH0KKyAgICAgICAgdW5pdC0+c2l6ZSA9IHNpemUuUXVhZFBhcnQ7CisgICAgICAgIENs
b3NlSGFuZGxlKGgpOworICAgICAgICBpZiAodW5pdC0+c2l6ZSkgeworICAgICAgICAgICAgdW5p
dC0+ZmlsZV9vYmplY3QgPSBnX2ZpbGVfbmV3X2Zvcl9wYXRoKHVuaXQtPmZpbGVuYW1lKTsKKyAg
ICAgICAgICAgIHVuaXQtPnN0cmVhbSA9IGdfZmlsZV9yZWFkKHVuaXQtPmZpbGVfb2JqZWN0LCBO
VUxMLCBOVUxMKTsKKyAgICAgICAgfQorICAgICAgICBpZiAoIXVuaXQtPnN0cmVhbSkgeworICAg
ICAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBjYW4ndCBvcGVuIHN0cmVhbSBvbiAlcyIsIF9fRlVO
Q1RJT05fXywgdW5pdC0+ZmlsZW5hbWUpOworICAgICAgICAgICAgZ19jbGVhcl9vYmplY3QoJnVu
aXQtPmZpbGVfb2JqZWN0KTsKKyAgICAgICAgICAgIGVycm9yID0gLTE7CisgICAgICAgIH0KKyAg
ICB9IGVsc2UgeworICAgICAgICBTUElDRV9ERUJVRygiJXM6IGNhbid0IG9wZW4gZmlsZSAlcyIs
IF9fRlVOQ1RJT05fXywgdW5pdC0+ZmlsZW5hbWUpOworICAgICAgICBlcnJvciA9IC0xOworICAg
IH0KKyAgICByZXR1cm4gZXJyb3I7Cit9CisKK3N0YXRpYyBpbnQgY2RfZGV2aWNlX2xvYWQoU3Bp
Y2VDZExVICp1bml0LCBnYm9vbGVhbiBsb2FkKQoreworICAgIGludCBlcnJvciA9IDA7CisgICAg
SEFORExFIGg7CisgICAgaWYgKCF1bml0LT5kZXZpY2UgfHwgIXVuaXQtPmZpbGVuYW1lKSB7Cisg
ICAgICAgIHJldHVybiAtMTsKKyAgICB9CisgICAgaCA9IG9wZW5fZmlsZSh1bml0LT5maWxlbmFt
ZSk7CisgICAgaWYgKGgpIHsKKyAgICAgICAgdWludDMyX3QgcmVzID0gaW9jdGxfbm9uZShoLCBs
b2FkID8gSU9DVExfU1RPUkFHRV9MT0FEX01FRElBIDogSU9DVExfU1RPUkFHRV9FSkVDVF9NRURJ
QSk7CisgICAgICAgIGlmIChyZXMpIHsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlczogY2Fu
J3QgJXNsb2FkICVzLCB3aW4gZXJyb3IgJXUiLAorICAgICAgICAgICAgICAgICAgICAgICAgX19G
VU5DVElPTl9fLCBsb2FkID8gIiIgOiAidW4iLCB1bml0LT5maWxlbmFtZSwgcmVzKTsKKyAgICAg
ICAgICAgIGVycm9yID0gLTE7CisgICAgICAgIH0gZWxzZSB7CisgICAgICAgICAgICBTUElDRV9E
RUJVRygiJXM6IGRldmljZSAlcyBbJXNdIiwKKyAgICAgICAgICAgICAgICAgICAgICAgIF9fRlVO
Q1RJT05fXywgbG9hZCA/ICJsb2FkZWQiIDogImVqZWN0ZWQiLCB1bml0LT5maWxlbmFtZSk7Cisg
ICAgICAgIH0KKyAgICAgICAgQ2xvc2VIYW5kbGUoaCk7CisgICAgfQorICAgIHJldHVybiBlcnJv
cjsKK30KKworc3RhdGljIGludCBjZF9kZXZpY2VfY2hlY2soU3BpY2VDZExVICp1bml0KQorewor
ICAgIGludCBlcnJvciA9IDA7CisgICAgQ0RST01fRElTS19EQVRBIGRhdGE7CisgICAgSEFORExF
IGg7CisgICAgaWYgKCF1bml0LT5kZXZpY2UgfHwgIXVuaXQtPmZpbGVuYW1lKSB7CisgICAgICAg
IHJldHVybiAtMTsKKyAgICB9CisgICAgaCA9IG9wZW5fZmlsZSh1bml0LT5maWxlbmFtZSk7Cisg
ICAgaWYgKGgpIHsKKyAgICAgICAgdWludDMyX3QgcmVzID0gaW9jdGxfbm9uZShoLCBJT0NUTF9T
VE9SQUdFX0NIRUNLX1ZFUklGWSk7CisgICAgICAgIGlmICghcmVzKSB7CisgICAgICAgICAgICBy
ZXMgPSBpb2N0bF9vdXQoaCwgSU9DVExfQ0RST01fRElTS19UWVBFLCAmZGF0YSwgc2l6ZW9mKGRh
dGEpKTsKKyAgICAgICAgfQorICAgICAgICBpZiAocmVzICE9IDAgfHwgZGF0YS5EaXNrRGF0YSAh
PSBDRFJPTV9ESVNLX0RBVEFfVFJBQ0spIHsKKyAgICAgICAgICAgIGVycm9yID0gLTE7CisgICAg
ICAgIH0KKyAgICAgICAgQ2xvc2VIYW5kbGUoaCk7CisgICAgfQorICAgIHJldHVybiBlcnJvcjsK
K30KKworI2VuZGlmCisKK3N0YXRpYyBnYm9vbGVhbiBvcGVuX3N0cmVhbShTcGljZUNkTFUgKnVu
aXQsIGNvbnN0IGNoYXIgKmZpbGVuYW1lKQoreworICAgIGdib29sZWFuIGIgPSBGQUxTRTsKKyAg
ICBiID0gY2RfZGV2aWNlX29wZW5fc3RyZWFtKHVuaXQsIGZpbGVuYW1lKSA9PSAwOworICAgIHJl
dHVybiBiOworfQorCitzdGF0aWMgdm9pZCBjbG9zZV9zdHJlYW0oU3BpY2VDZExVICp1bml0KQor
eworICAgIGdfY2xlYXJfb2JqZWN0KCZ1bml0LT5zdHJlYW0pOworICAgIGdfY2xlYXJfb2JqZWN0
KCZ1bml0LT5maWxlX29iamVjdCk7Cit9CisKK3N0YXRpYyBnYm9vbGVhbiBsb2FkX2x1bihVc2JD
ZCAqZCwgaW50IHVuaXQsIGdib29sZWFuIGxvYWQpCit7CisgICAgZ2Jvb2xlYW4gYiA9IFRSVUU7
CisgICAgaWYgKGxvYWQgJiYgZC0+dW5pdHNbdW5pdF0uZGV2aWNlKSB7CisgICAgICAgIC8vIHRo
ZXJlIGlzIG9uZSBwb3NzaWJsZSBwcm9ibGVtIGluIGNhc2Ugb3VyIGJhY2tlbmQgaXMgdGhlCisg
ICAgICAgIC8vIGxvY2FsIENEIGRldmljZSBhbmQgaXQgaXMgZWplY3RlZAorICAgICAgICBjZF9k
ZXZpY2VfbG9hZCgmZC0+dW5pdHNbdW5pdF0sIFRSVUUpOworICAgICAgICBjbG9zZV9zdHJlYW0o
JmQtPnVuaXRzW3VuaXRdKTsKKyAgICAgICAgaWYgKGNkX2RldmljZV9jaGVjaygmZC0+dW5pdHNb
dW5pdF0pIHx8ICFvcGVuX3N0cmVhbSgmZC0+dW5pdHNbdW5pdF0sIE5VTEwpKSB7CisgICAgICAg
ICAgICByZXR1cm4gRkFMU0U7CisgICAgICAgIH0KKyAgICB9CisKKyAgICBpZiAobG9hZCkgewor
ICAgICAgICBDZFNjc2lNZWRpYVBhcmFtZXRlcnMgbWVkaWFfcGFyYW1zID0geyAwIH07CisKKyAg
ICAgICAgbWVkaWFfcGFyYW1zLnN0cmVhbSA9IGQtPnVuaXRzW3VuaXRdLnN0cmVhbTsKKyAgICAg
ICAgbWVkaWFfcGFyYW1zLnNpemUgPSBkLT51bml0c1t1bml0XS5zaXplOworICAgICAgICBtZWRp
YV9wYXJhbXMuYmxvY2tfc2l6ZSA9IGQtPnVuaXRzW3VuaXRdLmJsb2NrU2l6ZTsKKyAgICAgICAg
aWYgKG1lZGlhX3BhcmFtcy5ibG9ja19zaXplID09IENEX0RFVl9CTE9DS19TSVpFICYmCisgICAg
ICAgICAgICBtZWRpYV9wYXJhbXMuc2l6ZSAlIERWRF9ERVZfQkxPQ0tfU0laRSA9PSAwKSB7Cisg
ICAgICAgICAgICBtZWRpYV9wYXJhbXMuYmxvY2tfc2l6ZSA9IERWRF9ERVZfQkxPQ0tfU0laRTsK
KyAgICAgICAgfQorICAgICAgICBTUElDRV9ERUJVRygiJXM6IGxvYWRpbmcgJXMsIHNpemUgJSIg
R19HVUlOVDY0X0ZPUk1BVCAiLCBibG9jayAldSIsCisgICAgICAgICAgICAgICAgICAgIF9fRlVO
Q1RJT05fXywgZC0+dW5pdHNbdW5pdF0uZmlsZW5hbWUsIG1lZGlhX3BhcmFtcy5zaXplLCBtZWRp
YV9wYXJhbXMuYmxvY2tfc2l6ZSk7CisKKyAgICAgICAgYiA9ICFjZF91c2JfYnVsa19tc2RfbG9h
ZChkLT5tc2MsIHVuaXQsICZtZWRpYV9wYXJhbXMpOworCisgICAgICAgIGQtPnVuaXRzW3VuaXRd
LmxvYWRlZCA9ICEhYjsKKworICAgIH0gZWxzZSB7CisgICAgICAgIFNQSUNFX0RFQlVHKCIlczog
dW5sb2FkaW5nICVzIiwgX19GVU5DVElPTl9fLCBkLT51bml0c1t1bml0XS5maWxlbmFtZSk7Cisg
ICAgICAgIGNkX3VzYl9idWxrX21zZF91bmxvYWQoZC0+bXNjLCB1bml0KTsKKyAgICAgICAgZC0+
dW5pdHNbdW5pdF0ubG9hZGVkID0gRkFMU0U7CisgICAgfQorICAgIHJldHVybiBiOworfQorCitz
dGF0aWMgdm9pZCB1c2JfY2RfdW5yZWFsaXplKFVzYkNkICpkKQoreworICAgIHVpbnQzMl90IHVu
aXQgPSAwOworICAgIGNkX3VzYl9idWxrX21zZF91bnJlYWxpemUoZC0+bXNjLCB1bml0KTsKKyAg
ICBnX2NsZWFyX3BvaW50ZXIoJmQtPnVuaXRzW3VuaXRdLmZpbGVuYW1lLCBnX2ZyZWUpOworICAg
IGNsb3NlX3N0cmVhbSgmZC0+dW5pdHNbdW5pdF0pOworICAgIGdfY2xlYXJfcG9pbnRlcigmZC0+
bXNjLCBjZF91c2JfYnVsa19tc2RfZnJlZSk7CisgICAgZ19mcmVlKGQpOworfQorCitzdGF0aWMg
Z2Jvb2xlYW4gdXNiX2NkX2dldF9kZXNjcmlwdG9yKFVzYkNkICpkLCB1aW50OF90IHR5cGUsIHVp
bnQ4X3QgaW5kZXgsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZvaWQg
KipidWZmZXIsIHVpbnQxNl90ICpzaXplKQoreworICAgIHN0YXRpYyBzdHJ1Y3QgbGlidXNiX2Rl
dmljZV9kZXNjcmlwdG9yIGRlc2MgPSB7CisgICAgICAgIC5iTGVuZ3RoID0gMTgsCisgICAgICAg
IC5iRGVzY3JpcHRvclR5cGUgPSBMSUJVU0JfRFRfREVWSUNFLAorICAgICAgICAuYmNkVVNCID0g
VVNCMl9CQ0QsCisgICAgICAgIC5iRGV2aWNlQ2xhc3MgPSAwLAorICAgICAgICAuYkRldmljZVN1
YkNsYXNzID0gMCwKKyAgICAgICAgLmJEZXZpY2VQcm90b2NvbCA9IDAsCisgICAgICAgIC5iTWF4
UGFja2V0U2l6ZTAgPSA2NCwKKyAgICAgICAgLmlkVmVuZG9yID0gQ0RfREVWX1ZJRCwKKyAgICAg
ICAgLmlkUHJvZHVjdCA9IENEX0RFVl9QSUQsCisgICAgICAgIC5iY2REZXZpY2UgPSAweDEwMCwK
KyAgICAgICAgLmlNYW51ZmFjdHVyZXIgPSAxLAorICAgICAgICAuaVByb2R1Y3QgPSAyLAorICAg
ICAgICAuaVNlcmlhbE51bWJlciA9IDMsCisgICAgICAgIC5iTnVtQ29uZmlndXJhdGlvbnMgPSAx
CisgICAgfTsKKyAgICBzdGF0aWMgdWludDhfdCBjZmdbXSA9CisgICAgeworICAgICAgICA5LCAv
L2xlbiBvZiBjZmcgZGVzYworICAgICAgICBMSUJVU0JfRFRfQ09ORklHLCAvLyBkZXNjIHR5cGUK
KyAgICAgICAgMHgyMCwgLy8gd2xlbgorICAgICAgICAwLAorICAgICAgICAxLCAvLyBudW0gaWYK
KyAgICAgICAgMSwgLy8gY2ZnIHZhbAorICAgICAgICAwLCAvLyBjZmcgbmFtZQorICAgICAgICAw
eDgwLCAvLyBidXMgcG93ZXJlZAorICAgICAgICAweDMyLCAvLyAxMDAgbWEKKyAgICAgICAgOSwg
Ly8gbGVuIG9mIElGIGRlc2MKKyAgICAgICAgTElCVVNCX0RUX0lOVEVSRkFDRSwKKyAgICAgICAg
MCwgLy8gbnVtIGlmCisgICAgICAgIDAsIC8vIGFsdCBzZXR0aW5nCisgICAgICAgIDIsIC8vIG51
bSBvZiBlbmRwb2ludHMKKyAgICAgICAgQ0RfREVWX0NMQVNTLAorICAgICAgICBDRF9ERVZfU1VC
Q0xBU1MsCisgICAgICAgIENEX0RFVl9QUk9UT0NPTCwKKyAgICAgICAgMCwgLy8gaWYgbmFtZQor
ICAgICAgICA3LAorICAgICAgICBMSUJVU0JfRFRfRU5EUE9JTlQsCisgICAgICAgIDB4ODEsIC8v
LT5EaXJlY3Rpb24gOiBJTiAtIEVuZHBvaW50SUQgOiAxCisgICAgICAgIDB4MDIsIC8vLT5CdWxr
IFRyYW5zZmVyIFR5cGUKKyAgICAgICAgMCwgICAgLy93TWF4UGFja2V0U2l6ZSA6IDB4MDIwMCA9
IDB4MjAwIG1heCBieXRlcworICAgICAgICAyLAorICAgICAgICAwLCAgICAvL2JJbnRlcnZhbAor
ICAgICAgICA3LAorICAgICAgICBMSUJVU0JfRFRfRU5EUE9JTlQsCisgICAgICAgIDB4MDIsIC8v
LT5EaXJlY3Rpb24gOiBPVVQgLSBFbmRwb2ludElEIDogMgorICAgICAgICAweDAyLCAvLy0+QnVs
ayBUcmFuc2ZlciBUeXBlCisgICAgICAgIDAsICAgIC8vd01heFBhY2tldFNpemUgOiAweDAyMDAg
PSAweDIwMCBtYXggYnl0ZXMKKyAgICAgICAgMiwKKyAgICAgICAgMCwgICAgLy9iSW50ZXJ2YWwK
KyAgICB9OworICAgIHN0YXRpYyB1aW50MTZfdCBzMFsyXSA9IHsgMHgzMDQsIDB4NDA5IH07Cisg
ICAgc3RhdGljIHVpbnQxNl90IHMxWzhdID0geyAweDMxMCwgJ1InLCAnZScsICdkJywgJyAnLCAn
SCcsICdhJywgJ3QnIH07CisgICAgc3RhdGljIHVpbnQxNl90IHMyWzldID0geyAweDMxMiwgJ1Mn
LCAncCcsICdpJywgJ2MnLCAnZScsICcgJywgJ0MnLCAnRCcgfTsKKworICAgIHZvaWQgKnAgPSBO
VUxMOworICAgIHVpbnQxNl90IGxlbiA9IDA7CisKKyAgICBzd2l0Y2ggKHR5cGUpCisgICAgewor
ICAgICAgICBjYXNlIExJQlVTQl9EVF9ERVZJQ0U6CisgICAgICAgICAgICBwID0gJmRlc2M7Cisg
ICAgICAgICAgICBsZW4gPSBzaXplb2YoZGVzYyk7CisgICAgICAgICAgICBicmVhazsKKyAgICAg
ICAgY2FzZSBMSUJVU0JfRFRfQ09ORklHOgorICAgICAgICAgICAgcCA9IGNmZzsKKyAgICAgICAg
ICAgIGxlbiA9IHNpemVvZihjZmcpOworICAgICAgICAgICAgYnJlYWs7CisgICAgICAgIGNhc2Ug
TElCVVNCX0RUX1NUUklORzoKKyAgICAgICAgICAgIGlmIChpbmRleCA9PSAwKSB7CisgICAgICAg
ICAgICAgICAgcCA9IHMwOyBsZW4gPSBzaXplb2YoczApOworICAgICAgICAgICAgfSBlbHNlIGlm
IChpbmRleCA9PSAxKSB7CisgICAgICAgICAgICAgICAgcCA9IHMxOyBsZW4gPSBzaXplb2YoczEp
OworICAgICAgICAgICAgfSBlbHNlIGlmIChpbmRleCA9PSAyKSB7CisgICAgICAgICAgICAgICAg
cCA9IHMyOyBsZW4gPSBzaXplb2YoczIpOworICAgICAgICAgICAgfSBlbHNlIGlmIChpbmRleCA9
PSAzKSB7CisgICAgICAgICAgICAgICAgcCA9IGQtPnNlcmlhbDsgbGVuID0gc2l6ZW9mKGQtPnNl
cmlhbCk7CisgICAgICAgICAgICB9CisgICAgICAgICAgICBicmVhazsKKyAgICB9CisKKyAgICBp
ZiAocCkgeworICAgICAgICAqYnVmZmVyID0gcDsKKyAgICAgICAgKnNpemUgPSBsZW47CisgICAg
fQorCisgICAgcmV0dXJuIHAgIT0gTlVMTDsKK30KKworc3RhdGljIHZvaWQgdXNiX2NkX2F0dGFj
aChVc2JDZCAqZGV2aWNlLCBzdHJ1Y3QgdXNicmVkaXJwYXJzZXIgKnBhcnNlcikKK3sKKyAgICBk
ZXZpY2UtPnBhcnNlciA9IHBhcnNlcjsKK30KKworc3RhdGljIHZvaWQgdXNiX2NkX2RldGFjaChV
c2JDZCAqZGV2aWNlKQoreworICAgIGRldmljZS0+cGFyc2VyID0gTlVMTDsKK30KKworc3RhdGlj
IHZvaWQgdXNiX2NkX3Jlc2V0KFVzYkNkICpkZXZpY2UpCit7CisgICAgY2RfdXNiX2J1bGtfbXNk
X3Jlc2V0KGRldmljZS0+bXNjKTsKK30KKworc3RhdGljIHZvaWQgdXNiX2NkX2NvbnRyb2xfcmVx
dWVzdChVc2JDZCAqZGV2aWNlLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1
aW50OF90ICpkYXRhLCBpbnQgZGF0YV9sZW4sCisgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIHN0cnVjdCB1c2JfcmVkaXJfY29udHJvbF9wYWNrZXRfaGVhZGVyICpoLAorICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2lkICoqYnVmZmVyKQoreworICAgIHVpbnQ4
X3QgcmVxdHlwZSA9IGgtPnJlcXVlc3R0eXBlICYgMHg3ZjsKKyAgICBpZiAoIWRldmljZS0+bXNj
KSB7CisgICAgICAgIHJldHVybjsKKyAgICB9CisgICAgaWYgKHJlcXR5cGUgPT0gKExJQlVTQl9S
RVFVRVNUX1RZUEVfU1RBTkRBUkQgfCBMSUJVU0JfUkVDSVBJRU5UX0VORFBPSU5UKSkgeworICAg
ICAgICAvLyBtaWdodCBiZSBjbGVhciBzdGFsbCByZXF1ZXN0CisgICAgICAgIGgtPmxlbmd0aCA9
IDA7CisgICAgICAgIGgtPnN0YXR1cyA9IHVzYl9yZWRpcl9zdWNjZXNzOzsKKyAgICAgICAgcmV0
dXJuOworICAgIH0KKworICAgIGlmIChyZXF0eXBlID09IChMSUJVU0JfUkVRVUVTVF9UWVBFX0NM
QVNTIHwgTElCVVNCX1JFQ0lQSUVOVF9JTlRFUkZBQ0UpKSB7CisgICAgICAgIHN3aXRjaCAoaC0+
cmVxdWVzdCkgeworICAgICAgICAgICAgY2FzZSAweEZGOgorICAgICAgICAgICAgICAgIC8vIG1h
c3Mtc3RvcmFnZSBjbGFzcyByZXF1ZXN0ICdyZXNldCcKKyAgICAgICAgICAgICAgICB1c2JfY2Rf
cmVzZXQoZGV2aWNlKTsKKyAgICAgICAgICAgICAgICBoLT5sZW5ndGggPSAwOworICAgICAgICAg
ICAgICAgIGgtPnN0YXR1cyA9IHVzYl9yZWRpcl9zdWNjZXNzOworICAgICAgICAgICAgICAgIGJy
ZWFrOworICAgICAgICAgICAgY2FzZSAweEZFOgorICAgICAgICAgICAgICAgIC8vIG1hc3Mtc3Rv
cmFnZSBjbGFzcyByZXF1ZXN0ICdnZXQgbWF4IGx1bicKKyAgICAgICAgICAgICAgICAvLyByZXR1
cm5pbmcgb25lIGJ5dGUKKyAgICAgICAgICAgICAgICBpZiAoaC0+bGVuZ3RoKSB7CisgICAgICAg
ICAgICAgICAgICAgIGgtPmxlbmd0aCA9IDE7CisgICAgICAgICAgICAgICAgICAgIGgtPnN0YXR1
cyA9IHVzYl9yZWRpcl9zdWNjZXNzOzsKKyAgICAgICAgICAgICAgICAgICAgKmJ1ZmZlciA9ICZk
ZXZpY2UtPm1heF9sdW5faW5kZXg7CisgICAgICAgICAgICAgICAgfQorICAgICAgICAgICAgICAg
IGJyZWFrOworICAgICAgICB9CisgICAgfQorfQorCitzdGF0aWMgdm9pZCB1c2JfY2RfYnVsa19v
dXRfcmVxdWVzdChVc2JDZCAqZGV2aWNlLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgdWludDhfdCBlcCwgdWludDhfdCAqZGF0YSwgaW50IGRhdGFfbGVuLAorICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludDhfdCAqc3RhdHVzKQoreworICAgIGlmICgh
Y2RfdXNiX2J1bGtfbXNkX3dyaXRlKGRldmljZS0+bXNjLCBkYXRhLCBkYXRhX2xlbikpIHsKKyAg
ICAgICAgKnN0YXR1cyA9IHVzYl9yZWRpcl9zdWNjZXNzOworICAgIH0KK30KKwordm9pZCBjZF91
c2JfYnVsa19tc2RfcmVhZF9jb21wbGV0ZSh2b2lkICp1c2VyX2RhdGEsCisgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIHVpbnQ4X3QgKmRhdGEsIHVpbnQzMl90IGxlbmd0aCwgQ2RV
c2JCdWxrU3RhdHVzIHN0YXR1cykKK3sKKyAgICBVc2JDZCAqZCA9IChVc2JDZCAqKXVzZXJfZGF0
YTsKKworICAgIGlmIChkLT5kZWxldGluZykgeworICAgICAgICBkLT5kZWxldGluZyA9IEZBTFNF
OworICAgICAgICBzcGljZV91c2JfYmFja2VuZF9kZXZpY2VfZWplY3QoZC0+YmFja2VuZCwgZC0+
cGFyZW50KTsKKyAgICB9CisKKyAgICBpZiAoZC0+cGFyc2VyKSB7CisgICAgICAgIGludCBucmVh
ZDsKKyAgICAgICAgdWludDMyX3Qgb2Zmc2V0ID0gMDsKKworICAgICAgICBmb3IgKG5yZWFkID0g
MDsgbnJlYWQgPCBkLT5udW1fcmVhZHM7IG5yZWFkKyspIHsKKyAgICAgICAgICAgIHVpbnQzMl90
IG1heF9sZW47CisgICAgICAgICAgICBtYXhfbGVuID0gKGQtPnJlYWRfYnVsa1tucmVhZF0uaG91
dC5sZW5ndGhfaGlnaCA8PCAxNikgfAorICAgICAgICAgICAgICAgICAgICAgICAgZC0+cmVhZF9i
dWxrW25yZWFkXS5ob3V0Lmxlbmd0aDsKKyAgICAgICAgICAgIGlmIChtYXhfbGVuID4gbGVuZ3Ro
KSB7CisgICAgICAgICAgICAgICAgbWF4X2xlbiA9IGxlbmd0aDsKKyAgICAgICAgICAgICAgICBk
LT5yZWFkX2J1bGtbbnJlYWRdLmhvdXQubGVuZ3RoID0gbGVuZ3RoOworICAgICAgICAgICAgICAg
IGQtPnJlYWRfYnVsa1tucmVhZF0uaG91dC5sZW5ndGhfaGlnaCA9IGxlbmd0aCA+PiAxNjsKKyAg
ICAgICAgICAgIH0KKworICAgICAgICAgICAgc3dpdGNoIChzdGF0dXMpIHsKKyAgICAgICAgICAg
IGNhc2UgQlVMS19TVEFUVVNfR09PRDoKKyAgICAgICAgICAgICAgICBkLT5yZWFkX2J1bGtbbnJl
YWRdLmhvdXQuc3RhdHVzID0gdXNiX3JlZGlyX3N1Y2Nlc3M7CisgICAgICAgICAgICAgICAgYnJl
YWs7CisgICAgICAgICAgICBjYXNlIEJVTEtfU1RBVFVTX0NBTkNFTEVEOgorICAgICAgICAgICAg
ICAgIGQtPnJlYWRfYnVsa1tucmVhZF0uaG91dC5zdGF0dXMgPSB1c2JfcmVkaXJfY2FuY2VsbGVk
OworICAgICAgICAgICAgICAgIGJyZWFrOworICAgICAgICAgICAgY2FzZSBCVUxLX1NUQVRVU19F
UlJPUjoKKyAgICAgICAgICAgICAgICBkLT5yZWFkX2J1bGtbbnJlYWRdLmhvdXQuc3RhdHVzID0g
dXNiX3JlZGlyX2lvZXJyb3I7CisgICAgICAgICAgICAgICAgYnJlYWs7CisgICAgICAgICAgICBj
YXNlIEJVTEtfU1RBVFVTX1NUQUxMOgorICAgICAgICAgICAgZGVmYXVsdDoKKyAgICAgICAgICAg
ICAgICBkLT5yZWFkX2J1bGtbbnJlYWRdLmhvdXQuc3RhdHVzID0gdXNiX3JlZGlyX3N0YWxsOwor
ICAgICAgICAgICAgICAgIGJyZWFrOworICAgICAgICAgICAgfQorCisgICAgICAgICAgICBTUElD
RV9ERUJVRygiJXM6IHJlc3BvbmRpbmcgJSIgR19HVUlOVDY0X0ZPUk1BVCAiIHdpdGggbGVuICV1
IG91dCBvZiAldSwgc3RhdHVzICVkIiwKKyAgICAgICAgICAgICAgICAgICAgICAgIF9fRlVOQ1RJ
T05fXywgZC0+cmVhZF9idWxrW25yZWFkXS5pZCwgbWF4X2xlbiwKKyAgICAgICAgICAgICAgICAg
ICAgICAgIGxlbmd0aCwgZC0+cmVhZF9idWxrW25yZWFkXS5ob3V0LnN0YXR1cyk7CisgICAgICAg
ICAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2J1bGtfcGFja2V0KGQtPnBhcnNlciwgZC0+cmVhZF9i
dWxrW25yZWFkXS5pZCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgJmQtPnJlYWRfYnVsa1tucmVhZF0uaG91dCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgbWF4X2xlbiA/IChkYXRhICsgb2Zmc2V0KSA6IE5VTEwsCisgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heF9sZW4pOworICAgICAg
ICAgICAgb2Zmc2V0ICs9IG1heF9sZW47CisgICAgICAgICAgICBsZW5ndGggLT0gbWF4X2xlbjsK
KyAgICAgICAgfQorICAgICAgICBkLT5udW1fcmVhZHMgPSAwOworICAgICAgICB1c2JyZWRpcnBh
cnNlcl9kb193cml0ZShkLT5wYXJzZXIpOworCisgICAgICAgIGlmIChsZW5ndGgpIHsKKyAgICAg
ICAgICAgIFNQSUNFX0RFQlVHKCIlczogRVJST1I6ICV1IGJ5dGVzIHdlcmUgbm90IHJlcG9ydGVk
ISIsIF9fRlVOQ1RJT05fXywgbGVuZ3RoKTsKKyAgICAgICAgfQorCisgICAgfSBlbHNlIHsKKyAg
ICAgICAgU1BJQ0VfREVCVUcoIiVzOiBicm9rZW4gZGV2aWNlPC0+Y2hhbm5lbCByZWxhdGlvbnNo
aXAhIiwgX19GVU5DVElPTl9fKTsKKyAgICB9Cit9CisKKy8qIGRldmljZSByZXNldCBjb21wbGV0
aW9uIGNhbGxiYWNrICovCit2b2lkIGNkX3VzYl9idWxrX21zZF9yZXNldF9jb21wbGV0ZSh2b2lk
ICp1c2VyX2RhdGEsIGludCBzdGF0dXMpCit7CisgICAgLy8gVXNiQ2QgKmQgPSAoVXNiQ2QgKil1
c2VyX2RhdGE7Cit9CisKK3N0YXRpYyBnYm9vbGVhbiB1c2JfY2RfYnVsa19pbl9yZXF1ZXN0KFVz
YkNkICpkLCB1aW50NjRfdCBpZCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIHN0cnVjdCB1c2JfcmVkaXJfYnVsa19wYWNrZXRfaGVhZGVyICpoKQoreworICAgIGludCBy
ZXM7CisgICAgdWludDMyX3QgbGVuID0gKGgtPmxlbmd0aF9oaWdoIDw8IDE2KSB8IGgtPmxlbmd0
aDsKKyAgICBpZiAoZC0+bnVtX3JlYWRzID49IE1BWF9CVUxLX0lOX1JFUVVFU1RTKSB7CisgICAg
ICAgIGgtPmxlbmd0aCA9IGgtPmxlbmd0aF9oaWdoID0gMDsKKyAgICAgICAgU1BJQ0VfREVCVUco
IiVzOiB0b28gbWFueSBwZW5kaW5nIHJlYWRzIiwgX19GVU5DVElPTl9fKTsKKyAgICAgICAgaC0+
c3RhdHVzID0gdXNiX3JlZGlyX2JhYmJsZTsKKyAgICAgICAgcmV0dXJuIEZBTFNFOworICAgIH0K
KworICAgIGlmIChkLT5udW1fcmVhZHMpIHsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBhbHJl
YWR5IGhhcyAldSBwZW5kaW5nIHJlYWRzIiwgX19GVU5DVElPTl9fLCBkLT5udW1fcmVhZHMpOwor
ICAgIH0KKworICAgIGQtPnJlYWRfYnVsa1tkLT5udW1fcmVhZHNdLmhvdXQgPSAqaDsKKyAgICBk
LT5yZWFkX2J1bGtbZC0+bnVtX3JlYWRzXS5pZCA9IGlkOworICAgIGQtPm51bV9yZWFkcysrOwor
ICAgIHJlcyA9IGNkX3VzYl9idWxrX21zZF9yZWFkKGQtPm1zYywgbGVuKTsKKyAgICBpZiAoIXJl
cykgeworICAgICAgICByZXR1cm4gVFJVRTsKKyAgICB9CisKKyAgICBTUElDRV9ERUJVRygiJXM6
IGVycm9yIG9uIGJ1bGsgcmVhZCIsIF9fRlVOQ1RJT05fXyk7CisgICAgZC0+bnVtX3JlYWRzLS07
CisgICAgaC0+bGVuZ3RoID0gaC0+bGVuZ3RoX2hpZ2ggPSAwOworICAgIGgtPnN0YXR1cyA9IHVz
Yl9yZWRpcl9pb2Vycm9yOworCisgICAgcmV0dXJuIEZBTFNFOworfQorCitzdGF0aWMgdm9pZCB1
c2JfY2RfY2FuY2VsX3JlcXVlc3QoVXNiQ2QgKmQsIHVpbnQ2NF90IGlkKQoreworICAgIHVpbnQz
Ml90IG5yZWFkOworCisgICAgZm9yIChucmVhZCA9IDA7IG5yZWFkIDwgZC0+bnVtX3JlYWRzOyBu
cmVhZCsrKSB7CisgICAgICAgIGlmIChkLT5yZWFkX2J1bGtbbnJlYWRdLmlkID09IGlkKSB7Cisg
ICAgICAgICAgICBpZiAoY2RfdXNiX2J1bGtfbXNkX2NhbmNlbF9yZWFkKGQtPm1zYykpIHsKKyAg
ICAgICAgICAgICAgICBjZF91c2JfYnVsa19tc2RfcmVhZF9jb21wbGV0ZShkLCBOVUxMLCAwLCBC
VUxLX1NUQVRVU19DQU5DRUxFRCk7CisgICAgICAgICAgICB9CisgICAgICAgICAgICByZXR1cm47
CisgICAgICAgIH0KKyAgICB9CisgICAgU1BJQ0VfREVCVUcoIiVzOiBFUlJPUjogbm8gc3VjaCBp
ZCB0byBjYW5jZWwhIiwgX19GVU5DVElPTl9fKTsKK30KKworLy8gY2FsbGVkIHdoZW4gYSBjaGFu
Z2UgaGFwcGVucyBvbiBTQ1NJIGxheWVyCit2b2lkIGNkX3VzYl9idWxrX21zZF9sdW5fY2hhbmdl
ZCh2b2lkICp1c2VyX2RhdGEsIHVpbnQzMl90IGx1bikKK3sKKyAgICBVc2JDZCAqZCA9IChVc2JD
ZCAqKXVzZXJfZGF0YTsKKyAgICBDZFNjc2lEZXZpY2VJbmZvIGNkX2luZm87CisKKyAgICBpZiAo
IWNkX3VzYl9idWxrX21zZF9nZXRfaW5mbyhkLT5tc2MsIGx1biwgJmNkX2luZm8pKSB7CisgICAg
ICAgIC8vIGxvYWQgb3IgdW5sb2FkIGNvbW1hbmQgcmVjZWl2ZWQgZnJvbSBTQ1NJCisgICAgICAg
IGlmIChkLT51bml0c1tsdW5dLmxvYWRlZCAhPSBjZF9pbmZvLmxvYWRlZCkgeworICAgICAgICAg
ICAgaWYgKCFsb2FkX2x1bihkLCBsdW4sIGNkX2luZm8ubG9hZGVkKSkgeworICAgICAgICAgICAg
ICAgIFNQSUNFX0RFQlVHKCIlczogbG9hZCBmYWlsZWQsIHVubG9hZGluZyB1bml0IiwgX19GVU5D
VElPTl9fKTsKKyAgICAgICAgICAgICAgICBjZF91c2JfYnVsa19tc2RfdW5sb2FkKGQtPm1zYywg
bHVuKTsKKyAgICAgICAgICAgIH0KKyAgICAgICAgfQorICAgIH0KKworICAgIGlmIChkLT5kZWxl
dGVfb25fZWplY3QpIHsKKyAgICAgICAgZC0+ZGVsZXRlX29uX2VqZWN0ID0gRkFMU0U7CisgICAg
ICAgIGQtPmRlbGV0aW5nID0gVFJVRTsKKyAgICB9IGVsc2UgeworICAgICAgICBzcGljZV91c2Jf
YmFja2VuZF9kZXZpY2VfcmVwb3J0X2NoYW5nZShkLT5iYWNrZW5kLCBkLT5wYXJlbnQpOworICAg
IH0KK30KKworc3RhdGljIGdjaGFyICp1c2JfY2RfZ2V0X3Byb2R1Y3RfZGVzY3JpcHRpb24oVXNi
Q2QgKmRldmljZSkKK3sKKyAgICBnY2hhciAqYmFzZV9uYW1lID0gZ19wYXRoX2dldF9iYXNlbmFt
ZShkZXZpY2UtPnVuaXRzWzBdLmZpbGVuYW1lKTsKKyAgICBnY2hhciAqcmVzID0gZ19zdHJkdXBf
cHJpbnRmKCJTUElDRSBDRCAoJXMpIiwgYmFzZV9uYW1lKTsKKyAgICBnX2ZyZWUoYmFzZV9uYW1l
KTsKKyAgICByZXR1cm4gcmVzOworfQorCitzdGF0aWMgY29uc3QgVXNiRGV2aWNlT3BzIGRldm9w
cyA9Cit7CisgICAgLmdldF9kZXNjcmlwdG9yID0gdXNiX2NkX2dldF9kZXNjcmlwdG9yLAorICAg
IC5nZXRfcHJvZHVjdF9kZXNjcmlwdGlvbiA9IHVzYl9jZF9nZXRfcHJvZHVjdF9kZXNjcmlwdGlv
biwKKyAgICAuYXR0YWNoID0gdXNiX2NkX2F0dGFjaCwKKyAgICAucmVzZXQgPSB1c2JfY2RfcmVz
ZXQsCisgICAgLmRldGFjaCA9IHVzYl9jZF9kZXRhY2gsCisgICAgLmNvbnRyb2xfcmVxdWVzdCA9
IHVzYl9jZF9jb250cm9sX3JlcXVlc3QsCisgICAgLmJ1bGtfb3V0X3JlcXVlc3QgPSB1c2JfY2Rf
YnVsa19vdXRfcmVxdWVzdCwKKyAgICAuYnVsa19pbl9yZXF1ZXN0ID0gdXNiX2NkX2J1bGtfaW5f
cmVxdWVzdCwKKyAgICAuY2FuY2VsX3JlcXVlc3QgPSB1c2JfY2RfY2FuY2VsX3JlcXVlc3QsCisg
ICAgLnVucmVhbGl6ZSA9IHVzYl9jZF91bnJlYWxpemUsCit9OworCitzdGF0aWMgVXNiQ2QqIHVz
Yl9jZF9jcmVhdGUoU3BpY2VVc2JCYWNrZW5kICpiZSwKKyAgICAgICAgICAgICAgICAgICAgICAg
ICAgICBTcGljZVVzYkJhY2tlbmREZXZpY2UgKnBhcmVudCwKKyAgICAgICAgICAgICAgICAgICAg
ICAgICAgICB2b2lkICpvcGFxdWVfcGFyYW0sCisgICAgICAgICAgICAgICAgICAgICAgICAgICAg
R0Vycm9yICoqZXJyKQoreworICAgIENkRW11bGF0aW9uUGFyYW1zICpwYXJhbSA9IG9wYXF1ZV9w
YXJhbTsKKyAgICBpbnQgZXJyb3IgPSAwLCBpOworICAgIHVpbnQzMl90IHVuaXQgPSAwOworICAg
IFVzYkNkICpkID0gZ19uZXcwKFVzYkNkLCAxKTsKKyAgICBDZFNjc2lEZXZpY2VQYXJhbWV0ZXJz
IGRldl9wYXJhbXMgPSB7IDAgfTsKKyAgICB1aW50MTZfdCBhZGRyZXNzID0gc3BpY2VfdXNiX2Jh
Y2tlbmRfZGV2aWNlX2dldF9pbmZvKHBhcmVudCktPmFkZHJlc3M7CisKKyAgICBkLT5kZXZfb3Bz
ID0gZGV2b3BzOworICAgIGQtPmJhY2tlbmQgPSBiZTsKKyAgICBkLT5wYXJlbnQgID0gcGFyZW50
OworICAgIGQtPmRlbGV0ZV9vbl9lamVjdCA9ICEhcGFyYW0tPmRlbGV0ZV9vbl9lamVjdDsKKyAg
ICBkLT5sb2NrZWQgPSAhZC0+ZGVsZXRlX29uX2VqZWN0OworICAgIGQtPnNlcmlhbFswXSA9IDB4
MDMwMCArIHNpemVvZihkLT5zZXJpYWwpOworICAgIGQtPnNlcmlhbFsxXSA9ICcwJyArIGFkZHJl
c3MgLyAxMDsKKyAgICBkLT5zZXJpYWxbMl0gPSAnMCcgKyBhZGRyZXNzICUgMTA7CisgICAgZm9y
IChpID0gMzsgaSA8IEdfTl9FTEVNRU5UUyhkLT5zZXJpYWwpOyArK2kpIHsKKyAgICAgICAgZC0+
c2VyaWFsW2ldID0gJzAnOworICAgIH0KKyAgICBkLT5tYXhfbHVuX2luZGV4ID0gTUFYX0xVTl9Q
RVJfREVWSUNFIC0gMTsKKworICAgIGRldl9wYXJhbXMudmVuZG9yID0gIlJlZCBIYXQiOworICAg
IGRldl9wYXJhbXMucHJvZHVjdCA9ICJTUElDRSBDRCI7CisgICAgZGV2X3BhcmFtcy52ZXJzaW9u
ID0gIjAiOworCisgICAgZC0+bXNjID0gY2RfdXNiX2J1bGtfbXNkX2FsbG9jKGQsIE1BWF9MVU5f
UEVSX0RFVklDRSk7CisgICAgaWYgKCFkLT5tc2MpIHsKKyAgICAgICAgZ19jbGVhcl9wb2ludGVy
KCZkLCBnX2ZyZWUpOworICAgICAgICBnX3NldF9lcnJvcihlcnIsIFNQSUNFX0NMSUVOVF9FUlJP
UiwgU1BJQ0VfQ0xJRU5UX0VSUk9SX0ZBSUxFRCwKKyAgICAgICAgICAgICAgICAgICAgXygiY2Fu
J3QgYWxsb2NhdGUgZGV2aWNlIikpOworICAgICAgICByZXR1cm4gTlVMTDsKKyAgICB9CisgICAg
ZC0+dW5pdHNbdW5pdF0uYmxvY2tTaXplID0gQ0RfREVWX0JMT0NLX1NJWkU7CisgICAgaWYgKCFj
ZF91c2JfYnVsa19tc2RfcmVhbGl6ZShkLT5tc2MsIHVuaXQsICZkZXZfcGFyYW1zKSkgeworICAg
ICAgICBpZiAob3Blbl9zdHJlYW0oJmQtPnVuaXRzW3VuaXRdLCBwYXJhbS0+ZmlsZW5hbWUpICYm
CisgICAgICAgICAgICBsb2FkX2x1bihkLCB1bml0LCBUUlVFKSkgeworICAgICAgICAgICAgaWYg
KGQtPmxvY2tlZCkgeworICAgICAgICAgICAgICAgIGNkX3VzYl9idWxrX21zZF9sb2NrKGQtPm1z
YywgdW5pdCwgVFJVRSk7CisgICAgICAgICAgICB9CisgICAgICAgIH0gZWxzZSB7CisgICAgICAg
ICAgICBjbG9zZV9zdHJlYW0oJmQtPnVuaXRzW3VuaXRdKTsKKyAgICAgICAgICAgIGNkX3VzYl9i
dWxrX21zZF91bnJlYWxpemUoZC0+bXNjLCB1bml0KTsKKyAgICAgICAgICAgIGdfc2V0X2Vycm9y
KGVyciwgU1BJQ0VfQ0xJRU5UX0VSUk9SLCBTUElDRV9DTElFTlRfRVJST1JfRkFJTEVELAorICAg
ICAgICAgICAgICAgICAgICAgICAgXygiY2FuJ3QgY3JlYXRlIGRldmljZSB3aXRoICVzIiksCisg
ICAgICAgICAgICAgICAgICAgICAgICBwYXJhbS0+ZmlsZW5hbWUpOworICAgICAgICAgICAgZXJy
b3IgPSAxOworICAgICAgICB9CisgICAgfSBlbHNlIHsKKyAgICAgICAgZ19zZXRfZXJyb3IoZXJy
LCBTUElDRV9DTElFTlRfRVJST1IsIFNQSUNFX0NMSUVOVF9FUlJPUl9GQUlMRUQsCisgICAgICAg
ICAgICAgICAgICAgIF8oImNhbid0IGFsbG9jYXRlIGRldmljZSIpKTsKKyAgICAgICAgZXJyb3Ig
PSAxOworICAgIH0KKyAgICBpZiAoZXJyb3IpIHsKKyAgICAgICAgZ19jbGVhcl9wb2ludGVyKCZk
LT5tc2MsIGNkX3VzYl9idWxrX21zZF9mcmVlKTsKKyAgICAgICAgZ19jbGVhcl9wb2ludGVyKCZk
LCBnX2ZyZWUpOworICAgICAgICByZXR1cm4gTlVMTDsKKyAgICB9CisKKyAgICByZXR1cm4gZDsK
K30KKworU3BpY2VVc2JCYWNrZW5kRGV2aWNlKgorY3JlYXRlX2VtdWxhdGVkX2NkKFNwaWNlVXNi
QmFja2VuZCAqYmUsCisgICAgICAgICAgICAgICAgICAgQ2RFbXVsYXRpb25QYXJhbXMgKnBhcmFt
LAorICAgICAgICAgICAgICAgICAgIEdFcnJvciAqKmVycikKK3sKKyAgICByZXR1cm4gc3BpY2Vf
dXNiX2JhY2tlbmRfY3JlYXRlX2VtdWxhdGVkX2RldmljZShiZSwgdXNiX2NkX2NyZWF0ZSwgcGFy
YW0sIGVycik7Cit9CisKKyNlbmRpZiAvKiBVU0VfVVNCUkVESVIgKi8KZGlmZiAtLWdpdCBhL3Ny
Yy91c2ItZGV2aWNlLWNkLmggYi9zcmMvdXNiLWRldmljZS1jZC5oCm5ldyBmaWxlIG1vZGUgMTAw
NjQ0CmluZGV4IDAwMDAwMDAwLi5lYjA4MmI3OAotLS0gL2Rldi9udWxsCisrKyBiL3NyYy91c2It
ZGV2aWNlLWNkLmgKQEAgLTAsMCArMSwzNyBAQAorLyogLSotIE1vZGU6IEM7IGMtYmFzaWMtb2Zm
c2V0OiA0OyBpbmRlbnQtdGFicy1tb2RlOiBuaWwgLSotICovCisvKgorICAgIENvcHlyaWdodCAo
QykgMjAxOSBSZWQgSGF0LCBJbmMuCisKKyAgICBSZWQgSGF0IEF1dGhvcnM6CisgICAgWXVyaSBC
ZW5kaXRvdmljaDx5YmVuZGl0b0ByZWRoYXQuY29tPgorCisgICAgVGhpcyBsaWJyYXJ5IGlzIGZy
ZWUgc29mdHdhcmU7IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vcgorICAgIG1vZGlmeSBp
dCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBMZXNzZXIgR2VuZXJhbCBQdWJsaWMKKyAgICBM
aWNlbnNlIGFzIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRo
ZXIKKyAgICB2ZXJzaW9uIDIuMSBvZiB0aGUgTGljZW5zZSwgb3IgKGF0IHlvdXIgb3B0aW9uKSBh
bnkgbGF0ZXIgdmVyc2lvbi4KKworICAgIFRoaXMgbGlicmFyeSBpcyBkaXN0cmlidXRlZCBpbiB0
aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLAorICAgIGJ1dCBXSVRIT1VUIEFOWSBXQVJS
QU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCisgICAgTUVSQ0hBTlRB
QklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZSBHTlUK
KyAgICBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgorCisg
ICAgWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIExlc3NlciBHZW5l
cmFsIFB1YmxpYworICAgIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIGxpYnJhcnk7IGlmIG5vdCwg
c2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi4KKyovCisKKyNpZm5kZWYgU1BJQ0Vf
R1RLX1VTQl9ERVZJQ0VfQ0RfSF8KKyNkZWZpbmUgU1BJQ0VfR1RLX1VTQl9ERVZJQ0VfQ0RfSF8K
KworI2luY2x1ZGUgInVzYi1iYWNrZW5kLmgiCisKK3R5cGVkZWYgc3RydWN0IENkRW11bGF0aW9u
UGFyYW1zIHsKKyAgICBjb25zdCBjaGFyICpmaWxlbmFtZTsKKyAgICB1aW50MzJfdCBkZWxldGVf
b25fZWplY3QgOiAxOworfSBDZEVtdWxhdGlvblBhcmFtczsKKworU3BpY2VVc2JCYWNrZW5kRGV2
aWNlKgorY3JlYXRlX2VtdWxhdGVkX2NkKFNwaWNlVXNiQmFja2VuZCAqYmUsCisgICAgICAgICAg
ICAgICAgICAgQ2RFbXVsYXRpb25QYXJhbXMgKnBhcmFtLAorICAgICAgICAgICAgICAgICAgIEdF
cnJvciAqKmVycik7CisKKyNlbmRpZiAvLyBTUElDRV9HVEtfVVNCX0RFVklDRV9DRF9IXwotLSAK
Mi4yMC4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpT
cGljZS1kZXZlbCBtYWlsaW5nIGxpc3QKU3BpY2UtZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3Jn
Cmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vc3BpY2UtZGV2
ZWw=
