Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 90AF572CAC
	for <lists+spice-devel@lfdr.de>; Wed, 24 Jul 2019 12:54:11 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id D7CDC6E513;
	Wed, 24 Jul 2019 10:54:09 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mail-wr1-x443.google.com (mail-wr1-x443.google.com
 [IPv6:2a00:1450:4864:20::443])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 723E56E50B
 for <spice-devel@lists.freedesktop.org>; Wed, 24 Jul 2019 10:54:06 +0000 (UTC)
Received: by mail-wr1-x443.google.com with SMTP id 31so46507627wrm.1
 for <spice-devel@lists.freedesktop.org>; Wed, 24 Jul 2019 03:54:06 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references;
 bh=mF/bICIExAgEedpLN3HlmSkz+uL0V8Ks2RmeCRUWGrY=;
 b=hNQpv5lDlIhQFOQUrvrNLiJhR0qmwDEWyRoXBuJs6RSB8OW/npixNzA41fGR/OJYH1
 6joYuYKSXNHeGIk/YV1wBPjxjzie+InP8XJ2g7qo0/0pl4HnfIG9RdcTckItz6mv11sA
 mFvG++YOccy0sjW/rmT/HPPMAPC19c1z5/DR5lW2TK/Fuv1ejFSy4qfJCVzTLSxB5jV4
 M3voSFRYVurNeeQVCwjbaC411JWq71QHOvIX/3xvgUF3fgHr8cDBFQkhdPjeQQkSioBb
 X+xki6+XwFCbYUN0RYRGA+byuDFu2kmBQ5KBHRYWEB3ZO2OV/P6jcCKnyKPOieDKxNXt
 OP1Q==
X-Gm-Message-State: APjAAAX01dDbBIuRyUvDhqZOr0Et1O2M6DxbStuZ1CNiNhCQgxuULm6q
 3Hs09DcGpjT6r4lR5dYEMwWQ+oUn
X-Google-Smtp-Source: APXvYqyl3eAyRjsSSIqR9yFrFIfpqXadiofC+3Xa/Q48N6ZF+NaUwgkZfyEw78ZzH02Ng/A7gzFNPA==
X-Received: by 2002:adf:e691:: with SMTP id r17mr52734190wrm.67.1563965644506; 
 Wed, 24 Jul 2019 03:54:04 -0700 (PDT)
Received: from f2.redhat.com (bzq-79-182-115-245.red.bezeqint.net.
 [79.182.115.245])
 by smtp.gmail.com with ESMTPSA id r12sm53542137wrt.95.2019.07.24.03.54.03
 (version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
 Wed, 24 Jul 2019 03:54:04 -0700 (PDT)
From: Yuri Benditovich <yuri.benditovich@daynix.com>
To: spice-devel@lists.freedesktop.org
Date: Wed, 24 Jul 2019 13:53:48 +0300
Message-Id: <20190724105351.13753-7-yuri.benditovich@daynix.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190724105351.13753-1-yuri.benditovich@daynix.com>
References: <20190724105351.13753-1-yuri.benditovich@daynix.com>
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=daynix-com.20150623.gappssmtp.com; s=20150623;
 h=from:to:cc:subject:date:message-id:in-reply-to:references;
 bh=mF/bICIExAgEedpLN3HlmSkz+uL0V8Ks2RmeCRUWGrY=;
 b=gaavxu3cR67TrgaMJHp7XRVRB9FqK+IRRV4ZRpmmbT8AESLxKhoY1ZBcw/hxgHWb+M
 lyjIst/Euazx4+ijIsPxky2b3laMLo0rEemOx904EITNpWSntrqMWHfqQjnyCM/M0Lvd
 ZeFPw1vMYhL0j9tAcZ7HaYWMFRj0vz565wvGD9ZYVzJoB+idEzrM/1WcKoYkImUQ7/8p
 AZo2bUbNRLCDhsQdpBZgol1qR3I/qOEQkA7rbUsAg/jAiSMexQWuIMxlWqH14afmdKAS
 da8zkPdNjZqtLn0iJz6wNvmRY6BfiQiUTbCXNLFwBcl802sJbj5ZCkyENUYmumTCMab5
 omTw==
Subject: [Spice-devel] [spice-gtk 6/9] usb-redir: extend USB backend to
 support emulated devices
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: yan@daynix.com
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

UmVkaXJlY3Rpb24gb2YgZW11bGF0ZWQgZGV2aWNlcyByZXF1aXJlcyBzcGVjaWFsIGFwcHJvYWNo
LAphcyB1c2JyZWRpcmhvc3QgY2FuJ3QgYmUgdXNlZCBmb3IgdGhhdCAoaXQgd29ya3Mgb25seSB3
aXRoCmxpYnVzYiBkZXZpY2VzKS4gRm9yIGVtdWxhdGVkIGRldmljZXMgd2UgY3JlYXRlIGluc3Rh
bmNlIG9mCnVzYnJlZGlycGFyc2VyIHRoYXQgaW1wbGVtZW50cyBVU0IgcmVkaXJlY3Rpb24gcHJv
dG9jb2wuCkluIG9yZGVyIHRvIHdvcmsgd2l0aCB0aGUgc2FtZSBzZXQgb2YgcHJvdG9jb2wgY2Fw
YWJpbGl0aWVzCnRoYXQgdXNicmVkaXJob3N0IHNldHMgdXAgd2l0aCByZW1vdGUgc2lkZSwgdGhl
IHBhcnNlciBzaGFsbDoKLSBub3Qgc2VuZCBpdHMgb3duICdoZWxsbycgdG8gdGhlIHNlcnZlcgot
IGluaXRpYWxpemUgdGhlIHNhbWUgY2FwYWJpbGl0aWVzIHRoYXQgdXNicmVkaXJob3N0Ci0gcmVj
ZWl2ZSB0aGUgc2FtZSAnaGVsbG8nIHJlc3BvbnNlCkZvciB0aGF0IHdlIGFuYWx5emUgJ2hlbGxv
JyBzZW50IGJ5IFVTQiByZWRpciBwYXJzZXIgYW5kCmV4dHJhY3Qgc2V0IG9mIGNhcGFiaWxpdGll
cyBmcm9tIGl0IGFuZCB1cG9uIHJlY2VpdmUgb2YKJ2hlbGxvJyByZXNwb25zZSB3ZSBwcm92aWRl
IGl0IGFsc28gdG8gdGhlIHBhcnNlci4KV2hlbiBsaWJ1c2IgZGV2aWNlIGlzIHJlZGlyZWN0ZWQg
dmlhIGEgY2hhbm5lbCwgaW5zdGFuY2Ugb2YKdXNicmVkaXJob3N0IHNlcnZlcyBpdC4KV2hlbiBl
bXVsYXRlZCBkZXZpY2UgaXMgcmVkaXJlY3RlZCB2aWEgYSBjaGFubmVsLCBpbnN0YW5jZQpvZiB1
c2JyZWRpcnBhcnNlciBkb2VzIHRoZSBqb2IuCgpTaWduZWQtb2ZmLWJ5OiBZdXJpIEJlbmRpdG92
aWNoIDx5dXJpLmJlbmRpdG92aWNoQGRheW5peC5jb20+Ci0tLQogc3JjL3VzYi1iYWNrZW5kLmMg
fCA1ODMgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKystLQogMSBm
aWxlIGNoYW5nZWQsIDU2NiBpbnNlcnRpb25zKCspLCAxNyBkZWxldGlvbnMoLSkKCmRpZmYgLS1n
aXQgYS9zcmMvdXNiLWJhY2tlbmQuYyBiL3NyYy91c2ItYmFja2VuZC5jCmluZGV4IGMxNzkxODgu
LjAyMzY5ZDIgMTAwNjQ0Ci0tLSBhL3NyYy91c2ItYmFja2VuZC5jCisrKyBiL3NyYy91c2ItYmFj
a2VuZC5jCkBAIC01Miw2ICs1Miw3IEBAIHN0cnVjdCBfU3BpY2VVc2JCYWNrZW5kRGV2aWNlCiAg
ICAgZ2ludCByZWZfY291bnQ7CiAgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqYXR0YWNoZWRf
dG87CiAgICAgVXNiRGV2aWNlSW5mb3JtYXRpb24gZGV2aWNlX2luZm87CisgICAgZ2Jvb2xlYW4g
ZWRldl9jb25maWd1cmVkOwogfTsKIAogc3RydWN0IF9TcGljZVVzYkJhY2tlbmQKQEAgLTc2LDEw
ICs3NywyMCBAQCBzdHJ1Y3QgX1NwaWNlVXNiQmFja2VuZAogc3RydWN0IF9TcGljZVVzYkJhY2tl
bmRDaGFubmVsCiB7CiAgICAgc3RydWN0IHVzYnJlZGlyaG9zdCAqdXNicmVkaXJob3N0OworICAg
IHN0cnVjdCB1c2JyZWRpcmhvc3QgKmhpZGRlbl9ob3N0OworICAgIHN0cnVjdCB1c2JyZWRpcnBh
cnNlciAqcGFyc2VyOworICAgIHN0cnVjdCB1c2JyZWRpcnBhcnNlciAqaGlkZGVuX3BhcnNlcjsK
ICAgICB1aW50OF90ICpyZWFkX2J1ZjsKICAgICBpbnQgcmVhZF9idWZfc2l6ZTsKICAgICBzdHJ1
Y3QgdXNicmVkaXJmaWx0ZXJfcnVsZSAqcnVsZXM7CiAgICAgaW50IHJ1bGVzX2NvdW50OworICAg
IHVpbnQzMl90IGhvc3RfY2FwczsKKyAgICB1aW50MzJfdCBwYXJzZXJfaW5pdF9kb25lICA6IDE7
CisgICAgdWludDMyX3QgcGFyc2VyX3dpdGhfaGVsbG8gOiAxOworICAgIHVpbnQzMl90IGhlbGxv
X2RvbmVfcGFyc2VyIDogMTsKKyAgICB1aW50MzJfdCBoZWxsb19zZW50ICAgICAgICA6IDE7Cisg
ICAgdWludDMyX3QgcmVqZWN0ZWQgICAgICAgICAgOiAxOworICAgIHVpbnQzMl90IHdhaXRfZGlz
Y19hY2sgICAgIDogMTsKICAgICBTcGljZVVzYkJhY2tlbmREZXZpY2UgKmF0dGFjaGVkOwogICAg
IFNwaWNlVXNicmVkaXJDaGFubmVsICAqdXNlcl9kYXRhOwogICAgIFNwaWNlVXNiQmFja2VuZCAq
YmFja2VuZDsKQEAgLTM0Niw3ICszNTcsMTEgQEAgZ2Jvb2xlYW4gc3BpY2VfdXNiX2JhY2tlbmRf
ZGV2aWNlX2lzb2NoKFNwaWNlVXNiQmFja2VuZERldmljZSAqZGV2KQogICAgIGdpbnQgaSwgaiwg
azsKICAgICBpbnQgcmM7CiAKLSAgICBnX3JldHVybl92YWxfaWZfZmFpbChsaWJkZXYgIT0gTlVM
TCwgMCk7CisgICAgZ19yZXR1cm5fdmFsX2lmX2ZhaWwobGliZGV2ICE9IE5VTEwgfHwgZGV2LT5l
ZGV2ICE9IE5VTEwsIDApOworICAgIGlmIChkZXYtPmVkZXYpIHsKKyAgICAgICAgLyogY3VycmVu
dGx5IHdlIGRvIG5vdCBlbXVsYXRlIGlzb2NoIGRldmljZXMgKi8KKyAgICAgICAgcmV0dXJuIEZB
TFNFOworICAgIH0KIAogICAgIHJjID0gbGlidXNiX2dldF9hY3RpdmVfY29uZmlnX2Rlc2NyaXB0
b3IobGliZGV2LCAmY29uZl9kZXNjKTsKICAgICBpZiAocmMpIHsKQEAgLTM4MSwxMyArMzk2LDE2
IEBAIGZyb20gYm90aCB0aGUgbWFpbiB0aHJlYWQgYXMgd2VsbCBhcyBmcm9tIHRoZSB1c2IgZXZl
bnQgaGFuZGxpbmcgdGhyZWFkICovCiBzdGF0aWMgdm9pZCB1c2JyZWRpcl93cml0ZV9mbHVzaF9j
YWxsYmFjayh2b2lkICp1c2VyX2RhdGEpCiB7CiAgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAq
Y2ggPSB1c2VyX2RhdGE7Ci0gICAgaWYgKCFjaC0+dXNicmVkaXJob3N0KSB7Ci0gICAgICAgIC8q
IGp1c3QgdG8gYmUgb24gdGhlIHNhZmUgc2lkZSAqLwotICAgICAgICByZXR1cm47Ci0gICAgfQog
ICAgIGlmIChpc19jaGFubmVsX3JlYWR5KGNoLT51c2VyX2RhdGEpKSB7Ci0gICAgICAgIFNQSUNF
X0RFQlVHKCIlcyBjaCAlcCAtPiB1c2JyZWRpcmhvc3QiLCBfX0ZVTkNUSU9OX18sIGNoKTsKLSAg
ICAgICAgdXNicmVkaXJob3N0X3dyaXRlX2d1ZXN0X2RhdGEoY2gtPnVzYnJlZGlyaG9zdCk7Cisg
ICAgICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7CisgICAgICAgICAgICBTUElDRV9ERUJVRygi
JXMgY2ggJXAgLT4gdXNicmVkaXJob3N0IiwgX19GVU5DVElPTl9fLCBjaCk7CisgICAgICAgICAg
ICB1c2JyZWRpcmhvc3Rfd3JpdGVfZ3Vlc3RfZGF0YShjaC0+dXNicmVkaXJob3N0KTsKKyAgICAg
ICAgfSBlbHNlIGlmIChjaC0+cGFyc2VyKSB7CisgICAgICAgICAgICBTUElDRV9ERUJVRygiJXMg
Y2ggJXAgLT4gcGFyc2VyIiwgX19GVU5DVElPTl9fLCBjaCk7CisgICAgICAgICAgICB1c2JyZWRp
cnBhcnNlcl9kb193cml0ZShjaC0+cGFyc2VyKTsKKyAgICAgICAgfSBlbHNlIHsKKyAgICAgICAg
ICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAoTk9UIEFDVElWRSkiLCBfX0ZVTkNUSU9OX18sIGNo
KTsKKyAgICAgICAgfQogICAgIH0gZWxzZSB7CiAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAl
cCAobm90IHJlYWR5KSIsIF9fRlVOQ1RJT05fXywgY2gpOwogICAgIH0KQEAgLTU0MywxMyArNTYx
LDU3IEBAIHZvaWQgc3BpY2VfdXNiX2JhY2tlbmRfZGV2aWNlX3VucmVmKFNwaWNlVXNiQmFja2Vu
ZERldmljZSAqZGV2KQogICAgIH0KIH0KIAorc3RhdGljIGludCBjaGVja19lZGV2X2RldmljZV9m
aWx0ZXIoU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkZXYsCisgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICBjb25zdCBzdHJ1Y3QgdXNicmVkaXJmaWx0ZXJfcnVsZSAqcnVsZXMsCisg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnQgY291bnQpCit7CisgICAgU3Bp
Y2VVc2JFbXVsYXRlZERldmljZSAqZWRldiA9IGRldi0+ZWRldjsKKyAgICB1aW50OF90IGNsc1sz
Ml0sIHN1YmNsc1szMl0sIHByb3RvWzMyXSwgKmNmZywgaWZudW0gPSAwOworICAgIHVpbnQxNl90
IHNpemUsIG9mZnNldCA9IDA7CisgICAgaWYgKCFlZGV2KSB7CisgICAgICAgIHJldHVybiAxOwor
ICAgIH0KKyAgICBpZiAoIWRldmljZV9vcHMoZWRldiktPmdldF9kZXNjcmlwdG9yKAorICAgICAg
ICAgICAgZWRldiwgTElCVVNCX0RUX0NPTkZJRywgMCwgKHZvaWQgKiopJmNmZywgJnNpemUpKSB7
CisgICAgICAgIHJldHVybiAxOworICAgIH0KKyAgICB3aGlsZSAoKG9mZnNldCArIDEpIDwgc2l6
ZSkgeworICAgICAgICB1aW50OF90IGxlbiAgPSBjZmdbb2Zmc2V0XTsKKyAgICAgICAgdWludDhf
dCB0eXBlID0gY2ZnW29mZnNldCArIDFdOworICAgICAgICBpZiAoKG9mZnNldCArIGxlbikgPiBz
aXplKSB7CisgICAgICAgICAgICBicmVhazsKKyAgICAgICAgfQorICAgICAgICBpZiAodHlwZSA9
PSBMSUJVU0JfRFRfSU5URVJGQUNFKSB7CisgICAgICAgICAgICBjbHNbaWZudW1dID0gY2ZnW29m
ZnNldCArIDVdOworICAgICAgICAgICAgc3ViY2xzW2lmbnVtXSA9IGNmZ1tvZmZzZXQgKyA2XTsK
KyAgICAgICAgICAgIHByb3RvW2lmbnVtXSA9IGNmZ1tvZmZzZXQgKyA3XTsKKyAgICAgICAgICAg
IGlmbnVtKys7CisgICAgICAgIH0KKyAgICAgICAgb2Zmc2V0ICs9IGxlbjsKKyAgICB9CisKKyAg
ICByZXR1cm4gdXNicmVkaXJmaWx0ZXJfY2hlY2soCisgICAgICAgIHJ1bGVzLCBjb3VudCwKKyAg
ICAgICAgZGV2LT5kZXZpY2VfaW5mby5jbGFzcywKKyAgICAgICAgZGV2LT5kZXZpY2VfaW5mby5z
dWJjbGFzcywKKyAgICAgICAgZGV2LT5kZXZpY2VfaW5mby5wcm90b2NvbCwKKyAgICAgICAgY2xz
LCBzdWJjbHMsIHByb3RvLCBpZm51bSwKKyAgICAgICAgZGV2LT5kZXZpY2VfaW5mby52aWQsCisg
ICAgICAgIGRldi0+ZGV2aWNlX2luZm8ucGlkLAorICAgICAgICBkZXYtPmRldmljZV9pbmZvLmJj
ZFVTQiwgMCk7Cit9CisKIGludCBzcGljZV91c2JfYmFja2VuZF9kZXZpY2VfY2hlY2tfZmlsdGVy
KAogICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqZGV2LAogICAgIGNvbnN0IHN0cnVjdCB1c2Jy
ZWRpcmZpbHRlcl9ydWxlICpydWxlcywKICAgICBpbnQgY291bnQpCiB7Ci0gICAgcmV0dXJuIHVz
YnJlZGlyaG9zdF9jaGVja19kZXZpY2VfZmlsdGVyKAotICAgICAgICBydWxlcywgY291bnQsIGRl
di0+bGlidXNiX2RldmljZSwgMCk7CisgICAgaWYgKGRldi0+bGlidXNiX2RldmljZSkgeworICAg
ICAgICByZXR1cm4gdXNicmVkaXJob3N0X2NoZWNrX2RldmljZV9maWx0ZXIoCisgICAgICAgICAg
ICBydWxlcywgY291bnQsIGRldi0+bGlidXNiX2RldmljZSwgMCk7CisgICAgfSBlbHNlIHsKKyAg
ICAgICAgcmV0dXJuIGNoZWNrX2VkZXZfZGV2aWNlX2ZpbHRlcihkZXYsIHJ1bGVzLCBjb3VudCk7
CisgICAgfQogfQogCiBzdGF0aWMgaW50IHVzYnJlZGlyX3JlYWRfY2FsbGJhY2sodm9pZCAqdXNl
cl9kYXRhLCB1aW50OF90ICpkYXRhLCBpbnQgY291bnQpCkBAIC02MTMsNiArNjc1LDE3IEBAIHN0
YXRpYyBpbnQgdXNicmVkaXJfd3JpdGVfY2FsbGJhY2sodm9pZCAqdXNlcl9kYXRhLCB1aW50OF90
ICpkYXRhLCBpbnQgY291bnQpCiAgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSB1c2Vy
X2RhdGE7CiAgICAgaW50IHJlczsKICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAsICVkIGJ5dGVz
IiwgX19GVU5DVElPTl9fLCBjaCwgY291bnQpOworICAgIGlmICghY2gtPmhlbGxvX3NlbnQpIHsK
KyAgICAgICAgLyogaGVsbG8gaXMgc2hvcnQgaGVhZGVyICgxMikgKyBoZWxsbyBzdHJ1Y3QgKDY0
KSArIGNhcGFiaWxpdGllcyAoNCkgKi8KKyAgICAgICAgaW50IGhlbGxvX3NpemUgPSBzaXplb2Yo
c3RydWN0IHVzYl9yZWRpcl9oZWFkZXIpICsgc2l6ZW9mKHN0cnVjdCB1c2JfcmVkaXJfaGVsbG9f
aGVhZGVyKTsKKyAgICAgICAgY2gtPmhlbGxvX3NlbnQgPSAxOworICAgICAgICBpZiAoY291bnQg
PT0gaGVsbG9fc2l6ZSkgeworICAgICAgICAgICAgbWVtY3B5KCZjaC0+aG9zdF9jYXBzLCBkYXRh
ICsgaGVsbG9fc2l6ZSAtIHNpemVvZihjaC0+aG9zdF9jYXBzKSwKKyAgICAgICAgICAgICAgICAg
ICBzaXplb2YoY2gtPmhvc3RfY2FwcykpOworICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNo
ICVwLCBzZW5kaW5nIGZpcnN0IGhlbGxvLCBjYXBzICUwOFgiLAorICAgICAgICAgICAgICAgICAg
ICAgICAgX19GVU5DVElPTl9fLCBjaCwgY2gtPmhvc3RfY2Fwcyk7CisgICAgICAgIH0KKyAgICB9
CiAgICAgcmVzID0gc3BpY2VfdXNicmVkaXJfd3JpdGVfY2FsbGJhY2soY2gtPnVzZXJfZGF0YSwg
ZGF0YSwgY291bnQpOwogICAgIHJldHVybiByZXM7CiB9CkBAIC02MzMsNiArNzA2LDI3IEBAIGlu
dCBzcGljZV91c2JfYmFja2VuZF9yZWFkX2d1ZXN0X2RhdGEoU3BpY2VVc2JCYWNrZW5kQ2hhbm5l
bCAqY2gsIHVpbnQ4X3QgKmRhdGEsCiAgICAgY2gtPnJlYWRfYnVmX3NpemUgPSBjb3VudDsKICAg
ICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgewogICAgICAgICByZXMgPSB1c2JyZWRpcmhvc3RfcmVh
ZF9ndWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3QpOworICAgICAgICBpZiAoIWNoLT5oZWxsb19k
b25lX3BhcnNlcikgeworICAgICAgICAgICAgaW50IHJlc19wYXJzZXI7CisgICAgICAgICAgICAv
KiB1c2JyZWRpcmhvc3Qgc2hvdWxkIGNvbnN1bWUgaGVsbG8gcmVzcG9uc2UgKi8KKyAgICAgICAg
ICAgIGdfcmV0dXJuX3ZhbF9pZl9mYWlsKGNoLT5yZWFkX2J1ZiA9PSBOVUxMLCBVU0JfUkVESVJf
RVJST1JfUkVBRF9QQVJTRSk7CisKKyAgICAgICAgICAgIGNoLT5yZWFkX2J1ZiA9IGRhdGE7Cisg
ICAgICAgICAgICBjaC0+cmVhZF9idWZfc2l6ZSA9IGNvdW50OworICAgICAgICAgICAgY2gtPmhl
bGxvX2RvbmVfcGFyc2VyID0gMTsKKyAgICAgICAgICAgIGlmIChjaC0+YXR0YWNoZWQgJiYgY2gt
PmF0dGFjaGVkLT5lZGV2KSB7CisgICAgICAgICAgICAgICAgLyogY2FzZSBvZiBDRCBzaGFyaW5n
IG9uIGNvbm5lY3QgKi8KKyAgICAgICAgICAgICAgICBjaC0+dXNicmVkaXJob3N0ID0gTlVMTDsK
KyAgICAgICAgICAgICAgICBjaC0+cGFyc2VyID0gY2gtPmhpZGRlbl9wYXJzZXI7CisgICAgICAg
ICAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBzd2l0Y2ggJXAgdG8gcGFyc2VyIiwgX19GVU5DVElP
Tl9fLCBjaCk7CisgICAgICAgICAgICB9CisgICAgICAgICAgICByZXNfcGFyc2VyID0gdXNicmVk
aXJwYXJzZXJfZG9fcmVhZChjaC0+aGlkZGVuX3BhcnNlcik7CisgICAgICAgICAgICBpZiAocmVz
ID49IDApIHsKKyAgICAgICAgICAgICAgICByZXMgPSByZXNfcGFyc2VyOworICAgICAgICAgICAg
fQorICAgICAgICB9CisgICAgfSBlbHNlIGlmIChjaC0+cGFyc2VyKSB7CisgICAgICAgIHJlcyA9
IHVzYnJlZGlycGFyc2VyX2RvX3JlYWQoY2gtPnBhcnNlcik7CiAgICAgfSBlbHNlIHsKICAgICAg
ICAgcmVzID0gVVNCX1JFRElSX0VSUk9SX0lPOwogICAgIH0KQEAgLTY1Myw2ICs3NDcsMTEgQEAg
aW50IHNwaWNlX3VzYl9iYWNrZW5kX3JlYWRfZ3Vlc3RfZGF0YShTcGljZVVzYkJhY2tlbmRDaGFu
bmVsICpjaCwgdWludDhfdCAqZGF0YSwKICAgICB9CiAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVw
LCAlZCBieXRlcywgcmVzICVkIiwgX19GVU5DVElPTl9fLCBjaCwgY291bnQsIHJlcyk7CiAKKyAg
ICBpZiAoY2gtPnJlamVjdGVkKSB7CisgICAgICAgIGNoLT5yZWplY3RlZCA9IDA7CisgICAgICAg
IHJlcyA9IFVTQl9SRURJUl9FUlJPUl9ERVZfUkVKRUNURUQ7CisgICAgfQorCiAgICAgcmV0dXJu
IHJlczsKIH0KIApAQCAtNjgyLDEzICs3ODEsNDI4IEBAIEdFcnJvciAqc3BpY2VfdXNiX2JhY2tl
bmRfZ2V0X2Vycm9yX2RldGFpbHMoaW50IGVycm9yX2NvZGUsIGdjaGFyICpkZXNjKQogdm9pZCBz
cGljZV91c2JfYmFja2VuZF9yZXR1cm5fd3JpdGVfZGF0YShTcGljZVVzYkJhY2tlbmRDaGFubmVs
ICpjaCwgdm9pZCAqZGF0YSkKIHsKICAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgewotICAgICAg
ICBTUElDRV9ERUJVRygiJXMgY2ggJXAiLCBfX0ZVTkNUSU9OX18sIGNoKTsKKyAgICAgICAgU1BJ
Q0VfREVCVUcoIiVzIGNoICVwIC0+IHVzYnJlZGlyaG9zdCIsIF9fRlVOQ1RJT05fXywgY2gpOwog
ICAgICAgICB1c2JyZWRpcmhvc3RfZnJlZV93cml0ZV9idWZmZXIoY2gtPnVzYnJlZGlyaG9zdCwg
ZGF0YSk7CisgICAgfSBlbHNlIGlmIChjaC0+cGFyc2VyKSB7CisgICAgICAgIFNQSUNFX0RFQlVH
KCIlcyBjaCAlcCAtPiBwYXJzZXIiLCBfX0ZVTkNUSU9OX18sIGNoKTsKKyAgICAgICAgdXNicmVk
aXJwYXJzZXJfZnJlZV93cml0ZV9idWZmZXIoY2gtPnBhcnNlciwgZGF0YSk7CiAgICAgfSBlbHNl
IHsKICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIC0gTk9CT0RZIFRPIENBTEwiLCBfX0ZV
TkNUSU9OX18sIGNoKTsKICAgICB9CiB9CiAKK3N0YXRpYyB2b2lkIHVzYnJlZGlyX2NvbnRyb2xf
cGFja2V0KHZvaWQgKnByaXYsCisgICAgdWludDY0X3QgaWQsIHN0cnVjdCB1c2JfcmVkaXJfY29u
dHJvbF9wYWNrZXRfaGVhZGVyICpoLAorICAgIHVpbnQ4X3QgKmRhdGEsIGludCBkYXRhX2xlbikK
K3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU3BpY2VVc2JC
YWNrZW5kRGV2aWNlICpkID0gY2gtPmF0dGFjaGVkOworICAgIFNwaWNlVXNiRW11bGF0ZWREZXZp
Y2UgKmVkZXYgPSBkID8gZC0+ZWRldiA6IE5VTEw7CisgICAgc3RydWN0IHVzYl9yZWRpcl9jb250
cm9sX3BhY2tldF9oZWFkZXIgcmVzcG9uc2UgPSAqaDsKKyAgICB1aW50OF90IHJlcXR5cGUgPSBo
LT5yZXF1ZXN0dHlwZSAmIDB4N2Y7CisgICAgZ2Jvb2xlYW4gZG9uZSA9IEZBTFNFOworICAgIHZv
aWQgKm91dF9idWZmZXIgPSBOVUxMOworCisgICAgcmVzcG9uc2Uuc3RhdHVzID0gdXNiX3JlZGly
X3N0YWxsOworICAgIFNQSUNFX0RFQlVHKCIlcyAlcDogVFJWSUwgJTAyWCAlMDJYICUwNFggJTA0
WCAlMDRYIiwKKyAgICAgICAgICAgICAgICBfX0ZVTkNUSU9OX18sCisgICAgICAgICAgICAgICAg
Y2gsIGgtPnJlcXVlc3R0eXBlLCBoLT5yZXF1ZXN0LAorICAgICAgICAgICAgICAgIGgtPnZhbHVl
LCBoLT5pbmRleCwgaC0+bGVuZ3RoKTsKKworICAgIGlmICghZWRldikgeworICAgICAgICBTUElD
RV9ERUJVRygiJXM6IGRldmljZSBub3QgYXR0YWNoZWQiLCBfX0ZVTkNUSU9OX18pOworICAgICAg
ICByZXNwb25zZS5zdGF0dXMgPSB1c2JfcmVkaXJfaW9lcnJvcjsKKyAgICAgICAgZG9uZSA9IFRS
VUU7CisgICAgfSBlbHNlIGlmIChyZXF0eXBlID09IChMSUJVU0JfUkVRVUVTVF9UWVBFX1NUQU5E
QVJEIHwgTElCVVNCX1JFQ0lQSUVOVF9ERVZJQ0UpICYmCisgICAgICAgICAgICAgICBoLT5yZXF1
ZXN0ID09IExJQlVTQl9SRVFVRVNUX0dFVF9ERVNDUklQVE9SKSB7CisgICAgICAgIGRvbmUgPSBk
ZXZpY2Vfb3BzKGVkZXYpLT5nZXRfZGVzY3JpcHRvcigKKyAgICAgICAgICAgIGVkZXYsIGgtPnZh
bHVlID4+IDgsIGgtPnZhbHVlICYgMHhmZiwKKyAgICAgICAgICAgICZvdXRfYnVmZmVyLCAmcmVz
cG9uc2UubGVuZ3RoKTsKKyAgICAgICAgaWYgKGRvbmUpIHsKKyAgICAgICAgICAgIHJlc3BvbnNl
LnN0YXR1cyA9IDA7CisgICAgICAgIH0KKyAgICAgICAgZG9uZSA9IFRSVUU7CisgICAgfQorCisg
ICAgaWYgKCFkb25lKSB7CisgICAgICAgIGRldmljZV9vcHMoZWRldiktPmNvbnRyb2xfcmVxdWVz
dCgKKyAgICAgICAgICAgIGVkZXYsIGRhdGEsIGRhdGFfbGVuLCAmcmVzcG9uc2UsICZvdXRfYnVm
ZmVyKTsKKyAgICAgICAgZG9uZSA9IFRSVUU7CisgICAgfQorCisgICAgaWYgKHJlc3BvbnNlLnN0
YXR1cykgeworICAgICAgICByZXNwb25zZS5sZW5ndGggPSAwOworICAgIH0gZWxzZSBpZiAocmVz
cG9uc2UubGVuZ3RoID4gaC0+bGVuZ3RoKSB7CisgICAgICAgIHJlc3BvbnNlLmxlbmd0aCA9IGgt
Pmxlbmd0aDsKKyAgICB9CisKKyAgICBTUElDRV9ERUJVRygiJXMgcmVzcG9uZGluZyB3aXRoIHBh
eWxvYWQgb2YgJTAyWCwgc3RhdHVzICVYIiwKKyAgICAgICAgICAgICAgICBfX0ZVTkNUSU9OX18s
IHJlc3BvbnNlLmxlbmd0aCwgcmVzcG9uc2Uuc3RhdHVzKTsKKyAgICB1c2JyZWRpcnBhcnNlcl9z
ZW5kX2NvbnRyb2xfcGFja2V0KAorICAgICAgICBjaC0+cGFyc2VyLCBpZCwgJnJlc3BvbnNlLAor
ICAgICAgICByZXNwb25zZS5sZW5ndGggPyBvdXRfYnVmZmVyIDogTlVMTCwKKyAgICAgICAgcmVz
cG9uc2UubGVuZ3RoKTsKKworICAgIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsK
KyAgICB1c2JyZWRpcnBhcnNlcl9mcmVlX3BhY2tldF9kYXRhKGNoLT5wYXJzZXIsIGRhdGEpOwor
fQorCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9idWxrX3BhY2tldCh2b2lkICpwcml2LAorICAgIHVp
bnQ2NF90IGlkLCBzdHJ1Y3QgdXNiX3JlZGlyX2J1bGtfcGFja2V0X2hlYWRlciAqaCwKKyAgICB1
aW50OF90ICpkYXRhLCBpbnQgZGF0YV9sZW4pCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5l
bCAqY2ggPSBwcml2OworICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqZCA9IGNoLT5hdHRhY2hl
ZDsKKyAgICBTcGljZVVzYkVtdWxhdGVkRGV2aWNlICplZGV2ID0gZCA/IGQtPmVkZXYgOiBOVUxM
OworICAgIHN0cnVjdCB1c2JfcmVkaXJfYnVsa19wYWNrZXRfaGVhZGVyIGhvdXQgPSAqaDsKKyAg
ICB1aW50MzJfdCBsZW4gPSAoaC0+bGVuZ3RoX2hpZ2ggPDwgMTYpIHwgaC0+bGVuZ3RoOworICAg
IFNQSUNFX0RFQlVHKCIlcyAlcDogZXAgJVgsIGxlbiAldSwgaWQgJSIgUFJJdTY0LCBfX0ZVTkNU
SU9OX18sCisgICAgICAgICAgICAgICAgY2gsIGgtPmVuZHBvaW50LCBsZW4sIGlkKTsKKworICAg
IGlmICghZWRldikgeworICAgICAgICBTUElDRV9ERUJVRygiJXM6IGRldmljZSBub3QgYXR0YWNo
ZWQiLCBfX0ZVTkNUSU9OX18pOworICAgICAgICBob3V0LnN0YXR1cyA9IHVzYl9yZWRpcl9pb2Vy
cm9yOworICAgICAgICBob3V0Lmxlbmd0aCA9IGhvdXQubGVuZ3RoX2hpZ2ggPSAwOworICAgICAg
ICBTUElDRV9ERUJVRygiJXM6IHJlc3BvbmRpbmcgd2l0aCBaTFAgc3RhdHVzICVkIiwgX19GVU5D
VElPTl9fLCBob3V0LnN0YXR1cyk7CisgICAgfSBlbHNlIGlmIChoLT5lbmRwb2ludCAmIExJQlVT
Ql9FTkRQT0lOVF9JTikgeworICAgICAgICBpZiAoZGV2aWNlX29wcyhlZGV2KS0+YnVsa19pbl9y
ZXF1ZXN0KGVkZXYsIGlkLCAmaG91dCkpIHsKKyAgICAgICAgICAgIHVzYnJlZGlycGFyc2VyX2Zy
ZWVfcGFja2V0X2RhdGEoY2gtPnBhcnNlciwgZGF0YSk7CisgICAgICAgICAgICAvKiBjb21wbGV0
aW9uIGlzIGFzeW5jaHJvbm91cyAqLworICAgICAgICAgICAgcmV0dXJuOworICAgICAgICB9Cisg
ICAgfSBlbHNlIHsKKyAgICAgICAgaG91dC5zdGF0dXMgPSB1c2JfcmVkaXJfc3RhbGw7CisgICAg
ICAgIGRldmljZV9vcHMoZWRldiktPmJ1bGtfb3V0X3JlcXVlc3QoZWRldiwgaC0+ZW5kcG9pbnQs
IGRhdGEsIGRhdGFfbGVuLCAmaG91dC5zdGF0dXMpOworICAgICAgICBTUElDRV9ERUJVRygiJXM6
IHJlc3BvbmRpbmcgc3RhdHVzICVkIiwgX19GVU5DVElPTl9fLCBob3V0LnN0YXR1cyk7CisgICAg
fQorCisgICAgdXNicmVkaXJwYXJzZXJfc2VuZF9idWxrX3BhY2tldChjaC0+cGFyc2VyLCBpZCwg
JmhvdXQsIE5VTEwsIDApOworICAgIHVzYnJlZGlycGFyc2VyX2ZyZWVfcGFja2V0X2RhdGEoY2gt
PnBhcnNlciwgZGF0YSk7CisgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2soY2gpOwor
fQorCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9kZXZpY2VfcmVzZXQodm9pZCAqcHJpdikKK3sKKyAg
ICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU3BpY2VVc2JCYWNrZW5k
RGV2aWNlICpkID0gY2gtPmF0dGFjaGVkOworICAgIFNwaWNlVXNiRW11bGF0ZWREZXZpY2UgKmVk
ZXYgPSBkID8gZC0+ZWRldiA6IE5VTEw7CisgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIiwgX19G
VU5DVElPTl9fLCBjaCk7CisgICAgaWYgKGVkZXYpIHsKKyAgICAgICAgZGV2aWNlX29wcyhlZGV2
KS0+cmVzZXQoZWRldik7CisgICAgfQorfQorCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9pbnRlcmZh
Y2VfaW5mbyh2b2lkICpwcml2LAorICAgIHN0cnVjdCB1c2JfcmVkaXJfaW50ZXJmYWNlX2luZm9f
aGVhZGVyICppbnRlcmZhY2VfaW5mbykKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpj
aCA9IHByaXY7CisgICAgU1BJQ0VfREVCVUcoIiVzIG5vdCBpbXBsZW1lbnRlZCAlcCIsIF9fRlVO
Q1RJT05fXywgY2gpOworfQorCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9pbnRlcmZhY2VfZXBfaW5m
byh2b2lkICpwcml2LAorICAgIHN0cnVjdCB1c2JfcmVkaXJfZXBfaW5mb19oZWFkZXIgKmVwX2lu
Zm8pCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIFNQSUNF
X0RFQlVHKCIlcyBub3QgaW1wbGVtZW50ZWQgJXAiLCBfX0ZVTkNUSU9OX18sIGNoKTsKK30KKwor
c3RhdGljIHZvaWQgdXNicmVkaXJfc2V0X2NvbmZpZ3VyYXRpb24odm9pZCAqcHJpdiwKKyAgICB1
aW50NjRfdCBpZCwgc3RydWN0IHVzYl9yZWRpcl9zZXRfY29uZmlndXJhdGlvbl9oZWFkZXIgKnNl
dF9jb25maWd1cmF0aW9uKQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJp
djsKKyAgICBzdHJ1Y3QgdXNiX3JlZGlyX2NvbmZpZ3VyYXRpb25fc3RhdHVzX2hlYWRlciBoOwor
ICAgIGguc3RhdHVzID0gMDsKKyAgICBoLmNvbmZpZ3VyYXRpb24gPSBzZXRfY29uZmlndXJhdGlv
bi0+Y29uZmlndXJhdGlvbjsKKyAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAsIGNmZyAlZCIsIF9f
RlVOQ1RJT05fXywgY2gsIGguY29uZmlndXJhdGlvbik7CisgICAgaWYgKGNoLT5hdHRhY2hlZCkg
eworICAgICAgICBjaC0+YXR0YWNoZWQtPmVkZXZfY29uZmlndXJlZCA9IGguY29uZmlndXJhdGlv
biAhPSAwOworICAgIH0KKyAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2NvbmZpZ3VyYXRpb25fc3Rh
dHVzKGNoLT5wYXJzZXIsIGlkLCAmaCk7CisgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJh
Y2soY2gpOworfQorCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9nZXRfY29uZmlndXJhdGlvbih2b2lk
ICpwcml2LCB1aW50NjRfdCBpZCkKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9
IHByaXY7CisgICAgc3RydWN0IHVzYl9yZWRpcl9jb25maWd1cmF0aW9uX3N0YXR1c19oZWFkZXIg
aDsKKyAgICBoLnN0YXR1cyA9IDA7CisgICAgaC5jb25maWd1cmF0aW9uID0gY2gtPmF0dGFjaGVk
ICYmIGNoLT5hdHRhY2hlZC0+ZWRldl9jb25maWd1cmVkOworICAgIFNQSUNFX0RFQlVHKCIlcyBj
aCAlcCwgY2ZnICVkIiwgX19GVU5DVElPTl9fLCBjaCwgaC5jb25maWd1cmF0aW9uKTsKKyAgICB1
c2JyZWRpcnBhcnNlcl9zZW5kX2NvbmZpZ3VyYXRpb25fc3RhdHVzKGNoLT5wYXJzZXIsIGlkLCAm
aCk7CisgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2soY2gpOworfQorCitzdGF0aWMg
dm9pZCB1c2JyZWRpcl9zZXRfYWx0X3NldHRpbmcodm9pZCAqcHJpdiwKKyAgICB1aW50NjRfdCBp
ZCwgc3RydWN0IHVzYl9yZWRpcl9zZXRfYWx0X3NldHRpbmdfaGVhZGVyICpzKQoreworICAgIFNw
aWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBzdHJ1Y3QgdXNiX3JlZGlyX2Fs
dF9zZXR0aW5nX3N0YXR1c19oZWFkZXIgc2g7CisgICAgc2guc3RhdHVzID0gKCFzLT5pbnRlcmZh
Y2UgJiYgIXMtPmFsdCkgPyAwIDogdXNiX3JlZGlyX3N0YWxsOworICAgIHNoLmludGVyZmFjZSA9
IHMtPmludGVyZmFjZTsKKyAgICBzaC5hbHQgPSBzLT5hbHQ7CisgICAgU1BJQ0VfREVCVUcoIiVz
IGNoICVwLCAlZDolZCIsIF9fRlVOQ1RJT05fXywgY2gsIHMtPmludGVyZmFjZSwgcy0+YWx0KTsK
KyAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2FsdF9zZXR0aW5nX3N0YXR1cyhjaC0+cGFyc2VyLCBp
ZCwgJnNoKTsKKyAgICB1c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFjayhjaCk7Cit9CisKK3N0
YXRpYyB2b2lkIHVzYnJlZGlyX2dldF9hbHRfc2V0dGluZyh2b2lkICpwcml2LAorICAgIHVpbnQ2
NF90IGlkLCBzdHJ1Y3QgdXNiX3JlZGlyX2dldF9hbHRfc2V0dGluZ19oZWFkZXIgKnMpCit7Cisg
ICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIHN0cnVjdCB1c2JfcmVk
aXJfYWx0X3NldHRpbmdfc3RhdHVzX2hlYWRlciBzaDsKKyAgICBzaC5zdGF0dXMgPSAocy0+aW50
ZXJmYWNlID09IDApID8gMCA6IHVzYl9yZWRpcl9zdGFsbDsKKyAgICBzaC5pbnRlcmZhY2UgPSBz
LT5pbnRlcmZhY2U7CisgICAgc2guYWx0ID0gMDsKKyAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAs
IGlmICVkIiwgX19GVU5DVElPTl9fLCBjaCwgcy0+aW50ZXJmYWNlKTsKKyAgICB1c2JyZWRpcnBh
cnNlcl9zZW5kX2FsdF9zZXR0aW5nX3N0YXR1cyhjaC0+cGFyc2VyLCBpZCwgJnNoKTsKKyAgICB1
c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFjayhjaCk7Cit9CisKK3N0YXRpYyB2b2lkIHVzYnJl
ZGlyX2NhbmNlbF9kYXRhKHZvaWQgKnByaXYsIHVpbnQ2NF90IGlkKQoreworICAgIFNwaWNlVXNi
QmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBTcGljZVVzYkJhY2tlbmREZXZpY2UgKmQg
PSBjaC0+YXR0YWNoZWQ7CisgICAgU3BpY2VVc2JFbXVsYXRlZERldmljZSAqZWRldiA9IGQgPyBk
LT5lZGV2IDogTlVMTDsKKyAgICBpZiAoIWVkZXYpIHsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVz
OiBkZXZpY2Ugbm90IGF0dGFjaGVkIiwgX19GVU5DVElPTl9fKTsKKyAgICAgICAgcmV0dXJuOwor
ICAgIH0KKyAgICBkZXZpY2Vfb3BzKGVkZXYpLT5jYW5jZWxfcmVxdWVzdChlZGV2LCBpZCk7Cit9
CisKK3N0YXRpYyB2b2lkIHVzYnJlZGlyX2ZpbHRlcl9yZWplY3Qodm9pZCAqcHJpdikKK3sKKyAg
ICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU1BJQ0VfREVCVUcoIiVz
ICVwIiwgX19GVU5DVElPTl9fLCBjaCk7CisgICAgY2gtPnJlamVjdGVkID0gMTsKK30KKworLyog
Tm90ZSB0aGF0IHRoZSBvd25lcnNoaXAgb2YgdGhlIHJ1bGVzIGFycmF5IGlzIHBhc3NlZCBvbiB0
byB0aGUgY2FsbGJhY2suICovCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9maWx0ZXJfZmlsdGVyKHZv
aWQgKnByaXYsCisgICAgc3RydWN0IHVzYnJlZGlyZmlsdGVyX3J1bGUgKnIsIGludCBjb3VudCkK
K3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU1BJQ0VfREVC
VUcoIiVzIGNoICVwICVkIGZpbHRlcnMiLCBfX0ZVTkNUSU9OX18sIGNoLCBjb3VudCk7CisKKyAg
ICBmcmVlKGNoLT5ydWxlcyk7CisKKyAgICBjaC0+cnVsZXMgPSByOworICAgIGNoLT5ydWxlc19j
b3VudCA9IGNvdW50OworICAgIGlmIChjb3VudCkgeworICAgICAgICBpbnQgaTsKKyAgICAgICAg
Zm9yIChpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIl
cyBjbGFzcyAlZCwgJVg6JVgiLAorICAgICAgICAgICAgICAgIHJbaV0uYWxsb3cgPyAiYWxsb3dl
ZCIgOiAiZGVuaWVkIiwgcltpXS5kZXZpY2VfY2xhc3MsCisgICAgICAgICAgICAgICAgKHVpbnQz
Ml90KXJbaV0udmVuZG9yX2lkLCAodWludDMyX3QpcltpXS5wcm9kdWN0X2lkKTsKKyAgICAgICAg
fQorICAgIH0KK30KKworc3RhdGljIHZvaWQgdXNicmVkaXJfZGV2aWNlX2Rpc2Nvbm5lY3RfYWNr
KHZvaWQgKnByaXYpCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2Owor
ICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCIsIF9fRlVOQ1RJT05fXywgY2gpOworICAgIGlmIChj
aC0+cGFyc2VyICYmIGNoLT53YWl0X2Rpc2NfYWNrKSB7CisgICAgICAgIGNoLT5wYXJzZXIgPSBO
VUxMOworICAgICAgICBTUElDRV9ERUJVRygiJXMgc3dpdGNoIHRvIHVzYnJlZGlyaG9zdCIsIF9f
RlVOQ1RJT05fXyk7CisgICAgICAgIGNoLT51c2JyZWRpcmhvc3QgPSBjaC0+aGlkZGVuX2hvc3Q7
CisgICAgfQorICAgIGNoLT53YWl0X2Rpc2NfYWNrID0gMDsKK30KKworc3RhdGljIHZvaWQgdXNi
cmVkaXJfaGVsbG8odm9pZCAqcHJpdiwKKyAgICBzdHJ1Y3QgdXNiX3JlZGlyX2hlbGxvX2hlYWRl
ciAqaGVsbG8pCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAg
IFNwaWNlVXNiQmFja2VuZERldmljZSAqZCA9IGNoLT5hdHRhY2hlZDsKKyAgICBTcGljZVVzYkVt
dWxhdGVkRGV2aWNlICplZGV2ID0gZCA/IGQtPmVkZXYgOiBOVUxMOworICAgIHN0cnVjdCB1c2Jf
cmVkaXJfZGV2aWNlX2Nvbm5lY3RfaGVhZGVyIGRldmljZV9jb25uZWN0OworICAgIHN0cnVjdCB1
c2JfcmVkaXJfZXBfaW5mb19oZWFkZXIgZXBfaW5mbyA9IHsgMCB9OworICAgIHN0cnVjdCB1c2Jf
cmVkaXJfaW50ZXJmYWNlX2luZm9faGVhZGVyIGludGVyZmFjZV9pbmZvID0geyAwIH07CisgICAg
dWludDhfdCAqY2ZnOworICAgIHVpbnQxNl90IHNpemUsIG9mZnNldCA9IDA7CisgICAgU1BJQ0Vf
REVCVUcoIiVzICVwICVzYXR0YWNoZWQgJXMiLCBfX0ZVTkNUSU9OX18sIGNoLAorICAgICAgICBl
ZGV2ID8gIiIgOiAibm90ICIsICBoZWxsbyA/ICIiIDogIihpbnRlcm5hbCkiKTsKKworICAgIGlm
IChoZWxsbykgeworICAgICAgICBjaC0+aGVsbG9fZG9uZV9wYXJzZXIgPSAxOworICAgIH0KKyAg
ICBpZiAoIWVkZXYpIHsKKyAgICAgICAgcmV0dXJuOworICAgIH0KKyAgICBpZiAoIWRldmljZV9v
cHMoZWRldiktPmdldF9kZXNjcmlwdG9yKAorICAgICAgICAgICAgZWRldiwgTElCVVNCX0RUX0NP
TkZJRywgMCwgKHZvaWQgKiopJmNmZywgJnNpemUpKSB7CisgICAgICAgIHJldHVybjsKKyAgICB9
CisgICAgd2hpbGUgKChvZmZzZXQgKyAxKSA8IHNpemUpIHsKKyAgICAgICAgdWludDhfdCBsZW4g
ID0gY2ZnW29mZnNldF07CisgICAgICAgIHVpbnQ4X3QgdHlwZSA9IGNmZ1tvZmZzZXQgKyAxXTsK
KyAgICAgICAgaWYgKChvZmZzZXQgKyBsZW4pID4gc2l6ZSkgeworICAgICAgICAgICAgYnJlYWs7
CisgICAgICAgIH0KKyAgICAgICAgaWYgKHR5cGUgPT0gTElCVVNCX0RUX0lOVEVSRkFDRSkgewor
ICAgICAgICAgICAgdWludDMyX3QgaSA9IGludGVyZmFjZV9pbmZvLmludGVyZmFjZV9jb3VudDsK
KyAgICAgICAgICAgIHVpbnQ4X3QgY2xhc3MsIHN1YmNsYXNzLCBwcm90b2NvbDsKKyAgICAgICAg
ICAgIGNsYXNzID0gY2ZnW29mZnNldCArIDVdOworICAgICAgICAgICAgc3ViY2xhc3MgPSBjZmdb
b2Zmc2V0ICsgNl07CisgICAgICAgICAgICBwcm90b2NvbCA9IGNmZ1tvZmZzZXQgKyA3XTsKKyAg
ICAgICAgICAgIGludGVyZmFjZV9pbmZvLmludGVyZmFjZV9jbGFzc1tpXSA9IGNsYXNzOworICAg
ICAgICAgICAgaW50ZXJmYWNlX2luZm8uaW50ZXJmYWNlX3N1YmNsYXNzW2ldID0gc3ViY2xhc3M7
CisgICAgICAgICAgICBpbnRlcmZhY2VfaW5mby5pbnRlcmZhY2VfcHJvdG9jb2xbaV0gPSBwcm90
b2NvbDsKKyAgICAgICAgICAgIGludGVyZmFjZV9pbmZvLmludGVyZmFjZV9jb3VudCsrOworICAg
ICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIElGJWQ6ICVkLyVkLyVkIiwgX19GVU5DVElPTl9fLCBp
LCBjbGFzcywgc3ViY2xhc3MsIHByb3RvY29sKTsKKyAgICAgICAgfSBlbHNlIGlmICh0eXBlID09
IExJQlVTQl9EVF9FTkRQT0lOVCkgeworICAgICAgICAgICAgdWludDhfdCBhZGRyZXNzID0gY2Zn
W29mZnNldCArIDJdOworICAgICAgICAgICAgdWludDE2X3QgbWF4X3BhY2tldF9zaXplID0gMHgx
MDAgKiBjZmdbb2Zmc2V0ICsgNV0gKyBjZmdbb2Zmc2V0ICsgNF07CisgICAgICAgICAgICB1aW50
OF90IGluZGV4ID0gYWRkcmVzcyAmIDB4ZjsKKyAgICAgICAgICAgIGlmIChhZGRyZXNzICYgMHg4
MCkgaW5kZXggKz0gMHgxMDsKKyAgICAgICAgICAgIGVwX2luZm8udHlwZVtpbmRleF0gPSBjZmdb
b2Zmc2V0ICsgM10gJiAweDM7CisgICAgICAgICAgICBlcF9pbmZvLm1heF9wYWNrZXRfc2l6ZVtp
bmRleF0gPSBtYXhfcGFja2V0X3NpemU7CisgICAgICAgICAgICBTUElDRV9ERUJVRygiJXMgRVBb
JTAyWF06ICVkLyVkIiwgX19GVU5DVElPTl9fLCBpbmRleCwgZXBfaW5mby50eXBlW2luZGV4XSwg
bWF4X3BhY2tldF9zaXplKTsKKyAgICAgICAgfQorICAgICAgICBvZmZzZXQgKz0gbGVuOworICAg
IH0KKworICAgIHVzYnJlZGlycGFyc2VyX3NlbmRfaW50ZXJmYWNlX2luZm8oY2gtPnBhcnNlciwg
JmludGVyZmFjZV9pbmZvKTsKKyAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2VwX2luZm8oY2gtPnBh
cnNlciwgJmVwX2luZm8pOworCisgICAgZGV2aWNlX2Nvbm5lY3QuZGV2aWNlX2NsYXNzID0gMDsg
Ly9kLT5kZXZpY2VfaW5mby5jbGFzczsKKyAgICBkZXZpY2VfY29ubmVjdC5kZXZpY2Vfc3ViY2xh
c3MgPSAwOyAvL2QtPmRldmljZV9pbmZvLnN1YmNsYXNzOworICAgIGRldmljZV9jb25uZWN0LmRl
dmljZV9wcm90b2NvbCA9IDA7IC8vZC0+ZGV2aWNlX2luZm8ucHJvdG9jb2w7OworICAgIGRldmlj
ZV9jb25uZWN0LnZlbmRvcl9pZCA9IGQtPmRldmljZV9pbmZvLnZpZDsKKyAgICBkZXZpY2VfY29u
bmVjdC5wcm9kdWN0X2lkID0gZC0+ZGV2aWNlX2luZm8ucGlkOworICAgIGRldmljZV9jb25uZWN0
LmRldmljZV92ZXJzaW9uX2JjZCA9IGQtPmRldmljZV9pbmZvLmJjZFVTQjsKKyAgICBkZXZpY2Vf
Y29ubmVjdC5zcGVlZCA9IHVzYl9yZWRpcl9zcGVlZF9oaWdoOworICAgIHVzYnJlZGlycGFyc2Vy
X3NlbmRfZGV2aWNlX2Nvbm5lY3QoY2gtPnBhcnNlciwgJmRldmljZV9jb25uZWN0KTsKKyAgICB1
c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFjayhjaCk7Cit9CisKK3N0YXRpYyB2b2lkIGluaXRp
YWxpemVfcGFyc2VyKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLCBnYm9vbGVhbiBkb19oZWxs
bykKK3sKKyAgICB1aW50MzJfdCBmbGFncywgY2Fwc1tVU0JfUkVESVJfQ0FQU19TSVpFXSA9IHsg
MCB9OworCisgICAgZ19yZXR1cm5faWZfZmFpbChjaC0+aGlkZGVuX3BhcnNlciAhPSBOVUxMKTsK
KyAgICBpZiAoY2gtPnBhcnNlcl9pbml0X2RvbmUpIHsKKyAgICAgICAgaWYgKGNoLT5wYXJzZXJf
d2l0aF9oZWxsbyAhPSBkb19oZWxsbykgeworICAgICAgICAgICAgZ19yZXR1cm5faWZfcmVhY2hl
ZCgpOworICAgICAgICB9CisgICAgICAgIHJldHVybjsKKyAgICB9CisKKyAgICBjaC0+cGFyc2Vy
X2luaXRfZG9uZSA9IDE7CisgICAgY2gtPnBhcnNlcl93aXRoX2hlbGxvID0gZG9faGVsbG87Cisg
ICAgZmxhZ3MgPSB1c2JyZWRpcnBhcnNlcl9mbF93cml0ZV9jYl9vd25zX2J1ZmZlciB8IHVzYnJl
ZGlycGFyc2VyX2ZsX3VzYl9ob3N0OworCisgICAgaWYgKGRvX2hlbGxvKSB7CisgICAgICAgIGNo
LT5oZWxsb19zZW50ID0gMTsKKyAgICAgICAgY2gtPmhvc3RfY2FwcyB8PSAxIDw8IHVzYl9yZWRp
cl9jYXBfY29ubmVjdF9kZXZpY2VfdmVyc2lvbjsKKyAgICAgICAgY2gtPmhvc3RfY2FwcyB8PSAx
IDw8IHVzYl9yZWRpcl9jYXBfZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrOworICAgICAgICBjaC0+aG9z
dF9jYXBzIHw9IDEgPDwgdXNiX3JlZGlyX2NhcF9lcF9pbmZvX21heF9wYWNrZXRfc2l6ZTsKKyAg
ICAgICAgY2gtPmhvc3RfY2FwcyB8PSAxIDw8IHVzYl9yZWRpcl9jYXBfNjRiaXRzX2lkczsKKyAg
ICAgICAgY2gtPmhvc3RfY2FwcyB8PSAxIDw8IHVzYl9yZWRpcl9jYXBfMzJiaXRzX2J1bGtfbGVu
Z3RoOworICAgIH0gZWxzZSB7CisgICAgICAgIGZsYWdzIHw9IHVzYnJlZGlycGFyc2VyX2ZsX25v
X2hlbGxvOworICAgIH0KKworICAgIGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGly
X2NhcF9jb25uZWN0X2RldmljZV92ZXJzaW9uKSkgeworICAgICAgICB1c2JyZWRpcnBhcnNlcl9j
YXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF9jb25uZWN0X2RldmljZV92ZXJzaW9uKTsK
KyAgICB9CisgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9j
YXBfZmlsdGVyKTsKKyAgICBpZiAoY2gtPmhvc3RfY2FwcyAmICgxIDw8IHVzYl9yZWRpcl9jYXBf
ZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrKSkgeworICAgICAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3Nl
dF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF9kZXZpY2VfZGlzY29ubmVjdF9hY2spOworICAgIH0K
KyAgICBpZiAoY2gtPmhvc3RfY2FwcyAmICgxIDw8IHVzYl9yZWRpcl9jYXBfZXBfaW5mb19tYXhf
cGFja2V0X3NpemUpKSB7CisgICAgICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBz
LCB1c2JfcmVkaXJfY2FwX2VwX2luZm9fbWF4X3BhY2tldF9zaXplKTsKKyAgICB9CisgICAgaWYg
KGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJfY2FwXzY0Yml0c19pZHMpKSB7CisgICAg
ICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJfY2FwXzY0Yml0
c19pZHMpOworICAgIH0KKyAgICBpZiAoY2gtPmhvc3RfY2FwcyAmICgxIDw8IHVzYl9yZWRpcl9j
YXBfMzJiaXRzX2J1bGtfbGVuZ3RoKSkgeworICAgICAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3Nl
dF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF8zMmJpdHNfYnVsa19sZW5ndGgpOworICAgIH0KKyAg
ICBpZiAoY2gtPmhvc3RfY2FwcyAmICgxIDw8IHVzYl9yZWRpcl9jYXBfYnVsa19zdHJlYW1zKSkg
eworICAgICAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2Nh
cF9idWxrX3N0cmVhbXMpOworICAgIH0KKyAgICB1c2JyZWRpcnBhcnNlcl9pbml0KGNoLT5oaWRk
ZW5fcGFyc2VyLCBQQUNLQUdFX1NUUklORywgY2FwcywgVVNCX1JFRElSX0NBUFNfU0laRSwgZmxh
Z3MpOworfQorCisvKgorICAgIFdlIGNhbiBpbml0aWFsaXplIHRoZSB1c2JyZWRpcnBhcnNlciB3
aXRoIEhFTExPIGVuYWJsZWQgb25seSBpbiBjYXNlCisgICAgdGhlIGxpYnVzYiBpcyBub3QgYWN0
aXZlIGFuZCB0aGUgdXNicmVkaXJob3N0IGRvZXMgbm90IGZ1bmN0aW9uLgorICAgIFRoZW4gdGhl
IHBhcnNlciBzZW5kcyBzZXNzaW9uIEhFTExPIGFuZCByZWNlaXZlcyBzZXJ2ZXIncyByZXNwb25z
ZS4KKyAgICBPdGhlcndpc2UgKHVzYnJlZGlycGFyc2VyIGluaXRpYWxpemVkIHdpdGggSEVMTE8g
ZGlzYWJsZWQpOgorICAgIC0gdGhlIHVzYnJlZGlyaG9zdCBzZW5kcyBzZXNzaW9uIEhFTExPCisg
ICAgLSB3ZSBsb29rIGludG8gaXQgdG8ga25vdyBzZXQgb2YgY2FwYWJpbGl0aWVzIHdlIHNoYWxs
IGluaXRpYWxpemUKKyAgICAgIHRoZSBwYXJzZXIgd2l0aAorICAgIC0gd2hlbiB3ZSByZWNlaXZl
IHNlcnZlcidzIHJlc3BvbnNlIHRvIEhFTExPIHdlIHByb3ZpZGUgaXQgYWxzbyB0bworICAgICAg
cGFyc2VyIHRvIGxldCBpdCBzeW5jaHJvbml6ZSB3aXRoIHNlcnZlcidzIGNhcGFiaWxpdGllcwor
Ki8KK3N0YXRpYyBzdHJ1Y3QgdXNicmVkaXJwYXJzZXIgKmNyZWF0ZV9wYXJzZXIoU3BpY2VVc2JC
YWNrZW5kQ2hhbm5lbCAqY2gpCit7CisgICAgc3RydWN0IHVzYnJlZGlycGFyc2VyICpwYXJzZXIg
PSB1c2JyZWRpcnBhcnNlcl9jcmVhdGUoKTsKKworICAgIGdfcmV0dXJuX3ZhbF9pZl9mYWlsKHBh
cnNlciAhPSBOVUxMLCBOVUxMKTsKKworICAgIHBhcnNlci0+cHJpdiA9IGNoOworICAgIHBhcnNl
ci0+bG9nX2Z1bmMgPSB1c2JyZWRpcl9sb2c7CisgICAgcGFyc2VyLT5yZWFkX2Z1bmMgPSB1c2Jy
ZWRpcl9yZWFkX2NhbGxiYWNrOworICAgIHBhcnNlci0+d3JpdGVfZnVuYyA9IHVzYnJlZGlyX3dy
aXRlX2NhbGxiYWNrOworICAgIHBhcnNlci0+cmVzZXRfZnVuYyA9IHVzYnJlZGlyX2RldmljZV9y
ZXNldDsKKyAgICBwYXJzZXItPnNldF9jb25maWd1cmF0aW9uX2Z1bmMgPSB1c2JyZWRpcl9zZXRf
Y29uZmlndXJhdGlvbjsKKyAgICBwYXJzZXItPmdldF9jb25maWd1cmF0aW9uX2Z1bmMgPSB1c2Jy
ZWRpcl9nZXRfY29uZmlndXJhdGlvbjsKKyAgICBwYXJzZXItPnNldF9hbHRfc2V0dGluZ19mdW5j
ID0gdXNicmVkaXJfc2V0X2FsdF9zZXR0aW5nOworICAgIHBhcnNlci0+Z2V0X2FsdF9zZXR0aW5n
X2Z1bmMgPSB1c2JyZWRpcl9nZXRfYWx0X3NldHRpbmc7CisgICAgcGFyc2VyLT5jYW5jZWxfZGF0
YV9wYWNrZXRfZnVuYyA9IHVzYnJlZGlyX2NhbmNlbF9kYXRhOworICAgIHBhcnNlci0+Y29udHJv
bF9wYWNrZXRfZnVuYyA9IHVzYnJlZGlyX2NvbnRyb2xfcGFja2V0OworICAgIHBhcnNlci0+YnVs
a19wYWNrZXRfZnVuYyA9IHVzYnJlZGlyX2J1bGtfcGFja2V0OworICAgIHBhcnNlci0+YWxsb2Nf
bG9ja19mdW5jID0gdXNicmVkaXJfYWxsb2NfbG9jazsKKyAgICBwYXJzZXItPmxvY2tfZnVuYyA9
IHVzYnJlZGlyX2xvY2tfbG9jazsKKyAgICBwYXJzZXItPnVubG9ja19mdW5jID0gdXNicmVkaXJf
dW5sb2NrX2xvY2s7CisgICAgcGFyc2VyLT5mcmVlX2xvY2tfZnVuYyA9IHVzYnJlZGlyX2ZyZWVf
bG9jazsKKyAgICBwYXJzZXItPmhlbGxvX2Z1bmMgPSB1c2JyZWRpcl9oZWxsbzsKKyAgICBwYXJz
ZXItPmZpbHRlcl9yZWplY3RfZnVuYyA9IHVzYnJlZGlyX2ZpbHRlcl9yZWplY3Q7CisgICAgcGFy
c2VyLT5kZXZpY2VfZGlzY29ubmVjdF9hY2tfZnVuYyA9IHVzYnJlZGlyX2RldmljZV9kaXNjb25u
ZWN0X2FjazsKKyAgICBwYXJzZXItPmludGVyZmFjZV9pbmZvX2Z1bmMgPSB1c2JyZWRpcl9pbnRl
cmZhY2VfaW5mbzsKKyAgICBwYXJzZXItPmVwX2luZm9fZnVuYyA9IHVzYnJlZGlyX2ludGVyZmFj
ZV9lcF9pbmZvOworICAgIHBhcnNlci0+ZmlsdGVyX2ZpbHRlcl9mdW5jID0gdXNicmVkaXJfZmls
dGVyX2ZpbHRlcjsKKworICAgIHJldHVybiBwYXJzZXI7Cit9CisKK3N0YXRpYyBnYm9vbGVhbiBh
dHRhY2hfZWRldihTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwKKyAgICAgICAgICAgICAgICAg
ICAgICAgICAgICBTcGljZVVzYkJhY2tlbmREZXZpY2UgKmRldiwKKyAgICAgICAgICAgICAgICAg
ICAgICAgICAgICBHRXJyb3IgKiplcnJvcikKK3sKKyAgICBpZiAoIWRldi0+ZWRldikgeworICAg
ICAgICBnX3NldF9lcnJvcihlcnJvciwgU1BJQ0VfQ0xJRU5UX0VSUk9SLCBTUElDRV9DTElFTlRf
RVJST1JfRkFJTEVELAorICAgICAgICAgICBfKCJGYWlsZWQgdG8gcmVkaXJlY3QgZGV2aWNlICVk
IiksIDEpOworICAgICAgICByZXR1cm4gRkFMU0U7CisgICAgfQorICAgIGlmIChjaC0+dXNicmVk
aXJob3N0ICYmICFjaC0+aGVsbG9fZG9uZV9wYXJzZXIpIHsKKyAgICAgICAgLyoKKyAgICAgICAg
ICAgIHdlIGNhbid0IGluaXRpYWxpemUgcGFyc2VyIHVudGlsIHdlIHNlZSBoZWxsbyBmcm9tIHVz
YnJlZGlyCisgICAgICAgICAgICBhbmQgdGhlIHBhcnNlciBjYW4ndCB3b3JrIHVudGlsIGl0IHNl
ZXMgdGhlIGhlbGxvIHJlc3BvbnNlLgorICAgICAgICAgICAgdGhpcyBpcyBjYXNlIG9mIGF1dG9j
b25uZWN0IHdoZW4gZW11bGF0ZWQgZGV2aWNlIGlzIGF0dGFjaGVkCisgICAgICAgICAgICBiZWZv
cmUgdGhlIGNoYW5uZWwgaXMgdXAKKyAgICAgICAgKi8KKyAgICAgICAgU1BJQ0VfREVCVUcoIiVz
IHdhaXRpbmcgdW50aWwgdGhlIGNoYW5uZWwgaXMgcmVhZHkiLCBfX0ZVTkNUSU9OX18pOworCisg
ICAgfSBlbHNlIHsKKyAgICAgICAgaW5pdGlhbGl6ZV9wYXJzZXIoY2gsIGNoLT5oaWRkZW5faG9z
dCA9PSBOVUxMKTsKKyAgICAgICAgY2gtPnVzYnJlZGlyaG9zdCA9IE5VTEw7CisgICAgICAgIGNo
LT5wYXJzZXIgPSBjaC0+aGlkZGVuX3BhcnNlcjsKKyAgICB9CisgICAgY2gtPndhaXRfZGlzY19h
Y2sgPSAwOworICAgIGNoLT5hdHRhY2hlZCA9IGRldjsKKyAgICBkZXYtPmF0dGFjaGVkX3RvID0g
Y2g7CisgICAgZGV2aWNlX29wcyhkZXYtPmVkZXYpLT5hdHRhY2goZGV2LT5lZGV2LCBjaC0+aGlk
ZGVuX3BhcnNlcik7CisgICAgaWYgKGNoLT5oZWxsb19kb25lX3BhcnNlcikgeworICAgICAgICAv
KiBzZW5kIGRldmljZSBpbmZvICovCisgICAgICAgIHVzYnJlZGlyX2hlbGxvKGNoLCBOVUxMKTsK
KyAgICB9CisgICAgcmV0dXJuIFRSVUU7Cit9CisKIGdib29sZWFuIHNwaWNlX3VzYl9iYWNrZW5k
X2NoYW5uZWxfYXR0YWNoKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLAogICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkZXYs
CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBHRXJyb3IgKiplcnJv
cikKQEAgLTY5OCw3ICsxMjEyLDEzIEBAIGdib29sZWFuIHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5u
ZWxfYXR0YWNoKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLAogCiAgICAgZ19yZXR1cm5fdmFs
X2lmX2ZhaWwoZGV2ICE9IE5VTEwsIEZBTFNFKTsKIAorICAgIGlmICghZGV2LT5saWJ1c2JfZGV2
aWNlKSB7CisgICAgICAgIHJldHVybiBhdHRhY2hfZWRldihjaCwgZGV2LCBlcnJvcik7CisgICAg
fQorCiAgICAgbGlidXNiX2RldmljZV9oYW5kbGUgKmhhbmRsZSA9IE5VTEw7CisgICAgY2gtPnVz
YnJlZGlyaG9zdCA9IGNoLT5oaWRkZW5faG9zdDsKKyAgICBjaC0+cGFyc2VyID0gTlVMTDsKIAog
ICAgIC8qCiAgICAgICAgVW5kZXIgV2luZG93cyB3ZSBuZWVkIHRvIGF2b2lkIHVwZGF0aW5nCkBA
IC03MzIsMTggKzEyNTIsMzMgQEAgZ2Jvb2xlYW4gc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9h
dHRhY2goU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsCiAKIHZvaWQgc3BpY2VfdXNiX2JhY2tl
bmRfY2hhbm5lbF9kZXRhY2goU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gpCiB7CisgICAgU3Bp
Y2VVc2JCYWNrZW5kRGV2aWNlICpkID0gY2gtPmF0dGFjaGVkOworICAgIFNwaWNlVXNiRW11bGF0
ZWREZXZpY2UgKmVkZXYgPSBkID8gZC0+ZWRldiA6IE5VTEw7CiAgICAgU1BJQ0VfREVCVUcoIiVz
ID4+IGNoICVwLCB3YXMgYXR0YWNoZWQgJXAiLCBfX0ZVTkNUSU9OX18sIGNoLCBjaC0+YXR0YWNo
ZWQpOwotICAgIGlmICghY2gtPmF0dGFjaGVkKSB7CisgICAgaWYgKCFkKSB7CiAgICAgICAgIFNQ
SUNFX0RFQlVHKCIlczogbm90aGluZyB0byBkZXRhY2giLCBfX0ZVTkNUSU9OX18pOwogICAgICAg
ICByZXR1cm47CiAgICAgfQogICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7CiAgICAgICAgIC8q
IGl0IHdpbGwgY2FsbCBsaWJ1c2JfY2xvc2UgaW50ZXJuYWxseSAqLwogICAgICAgICB1c2JyZWRp
cmhvc3Rfc2V0X2RldmljZShjaC0+dXNicmVkaXJob3N0LCBOVUxMKTsKKyAgICB9IGVsc2UgaWYg
KGNoLT5wYXJzZXIpIHsKKyAgICAgICAgaWYgKGVkZXYpIHsKKyAgICAgICAgICAgIGRldmljZV9v
cHMoZWRldiktPmRldGFjaChlZGV2KTsKKyAgICAgICAgfQorICAgICAgICB1c2JyZWRpcnBhcnNl
cl9zZW5kX2RldmljZV9kaXNjb25uZWN0KGNoLT5wYXJzZXIpOworICAgICAgICB1c2JyZWRpcl93
cml0ZV9mbHVzaF9jYWxsYmFjayhjaCk7CisgICAgICAgIGNoLT53YWl0X2Rpc2NfYWNrID0gdXNi
cmVkaXJwYXJzZXJfcGVlcl9oYXNfY2FwKGNoLT5wYXJzZXIsCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzYl9yZWRpcl9jYXBfZGV2aWNl
X2Rpc2Nvbm5lY3RfYWNrKTsKKyAgICAgICAgaWYgKCFjaC0+d2FpdF9kaXNjX2FjaykgeworICAg
ICAgICAgICAgY2gtPnVzYnJlZGlyaG9zdCA9IGNoLT5oaWRkZW5faG9zdDsKKyAgICAgICAgICAg
IGNoLT5wYXJzZXIgPSBOVUxMOworICAgICAgICB9CiAgICAgfQogICAgIFNQSUNFX0RFQlVHKCIl
cyBjaCAlcCwgZGV0YWNoIGRvbmUiLCBfX0ZVTkNUSU9OX18sIGNoKTsKICAgICBjaC0+YXR0YWNo
ZWQtPmF0dGFjaGVkX3RvID0gTlVMTDsKICAgICBjaC0+YXR0YWNoZWQgPSBOVUxMOworICAgIGNo
LT5yZWplY3RlZCA9IDA7CiB9CiAKIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKnNwaWNlX3VzYl9i
YWNrZW5kX2NoYW5uZWxfbmV3KFNwaWNlVXNiQmFja2VuZCAqYmUsCkBAIC03NzQsMTAgKzEzMDks
MTUgQEAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9u
ZXcoU3BpY2VVc2JCYWNrZW5kICpiZSwKICAgICAgICAgICAgIHVzYnJlZGlyaG9zdF9mbF93cml0
ZV9jYl9vd25zX2J1ZmZlcik7CiAgICAgICAgIGdfd2Fybl9pZl9mYWlsKGNoLT51c2JyZWRpcmhv
c3QgIT0gTlVMTCk7CiAgICAgfQorCiAgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKKyAgICAg
ICAgY2gtPmhpZGRlbl9wYXJzZXIgPSBjcmVhdGVfcGFyc2VyKGNoKTsKKyAgICAgICAgY2gtPmhp
ZGRlbl9ob3N0ID0gY2gtPnVzYnJlZGlyaG9zdDsKICAgICAgICAgdXNicmVkaXJob3N0X3NldF9i
dWZmZXJlZF9vdXRwdXRfc2l6ZV9jYihjaC0+dXNicmVkaXJob3N0LCB1c2JyZWRpcl9idWZmZXJl
ZF9vdXRwdXRfc2l6ZV9jYWxsYmFjayk7Ci0gICAgfSBlbHNlIHsKLSAgICAgICAgZ19mcmVlKGNo
KTsKKyAgICB9CisKKyAgICBpZiAoIWNoLT5oaWRkZW5fcGFyc2VyKSB7CisgICAgICAgIHNwaWNl
X3VzYl9iYWNrZW5kX2NoYW5uZWxfZGVsZXRlKGNoKTsKICAgICAgICAgY2ggPSBOVUxMOwogICAg
IH0KIApAQCAtNzg3LDkgKzEzMjcsMTQgQEAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqc3BpY2Vf
dXNiX2JhY2tlbmRfY2hhbm5lbF9uZXcoU3BpY2VVc2JCYWNrZW5kICpiZSwKIAogdm9pZCBzcGlj
ZV91c2JfYmFja2VuZF9jaGFubmVsX2ZsdXNoX3dyaXRlcyhTcGljZVVzYkJhY2tlbmRDaGFubmVs
ICpjaCkKIHsKLSAgICBTUElDRV9ERUJVRygiJXMgJXAsIGhvc3QgJXAiLCBfX0ZVTkNUSU9OX18s
IGNoLCBjaC0+dXNicmVkaXJob3N0KTsKKyAgICBTUElDRV9ERUJVRygiJXMgJXAgaXMgdXAiLCBf
X0ZVTkNUSU9OX18sIGNoKTsKICAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgewogICAgICAgICB1
c2JyZWRpcmhvc3Rfd3JpdGVfZ3Vlc3RfZGF0YShjaC0+dXNicmVkaXJob3N0KTsKKyAgICAgICAg
aW5pdGlhbGl6ZV9wYXJzZXIoY2gsIEZBTFNFKTsKKyAgICB9IGVsc2UgeworICAgICAgICBpbml0
aWFsaXplX3BhcnNlcihjaCwgVFJVRSk7CisgICAgICAgIGNoLT5wYXJzZXIgPSBjaC0+aGlkZGVu
X3BhcnNlcjsKKyAgICAgICAgdXNicmVkaXJwYXJzZXJfZG9fd3JpdGUoY2gtPnBhcnNlcik7CiAg
ICAgfQogfQogCkBAIC03OTksMTIgKzEzNDQsMTYgQEAgdm9pZCBzcGljZV91c2JfYmFja2VuZF9j
aGFubmVsX2RlbGV0ZShTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCkKICAgICBpZiAoIWNoKSB7
CiAgICAgICAgIHJldHVybjsKICAgICB9Ci0gICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKLSAg
ICAgICAgdXNicmVkaXJob3N0X2Nsb3NlKGNoLT51c2JyZWRpcmhvc3QpOworICAgIGlmIChjaC0+
aGlkZGVuX2hvc3QpIHsKKyAgICAgICAgdXNicmVkaXJob3N0X2Nsb3NlKGNoLT5oaWRkZW5faG9z
dCk7CisgICAgfQorICAgIGlmIChjaC0+aGlkZGVuX3BhcnNlcikgeworICAgICAgICB1c2JyZWRp
cnBhcnNlcl9kZXN0cm95KGNoLT5oaWRkZW5fcGFyc2VyKTsKICAgICB9CiAKICAgICBpZiAoY2gt
PnJ1bGVzKSB7Ci0gICAgICAgIGdfZnJlZShjaC0+cnVsZXMpOworICAgICAgICAvKiBydWxlcyB3
ZXJlIGFsbG9jYXRlZCBieSB1c2JyZWRpcnBhcnNlciAqLworICAgICAgICBmcmVlKGNoLT5ydWxl
cyk7CiAgICAgfQogCiAgICAgZ19mcmVlKGNoKTsKLS0gCjIuMTcuMQoKX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KU3BpY2UtZGV2ZWwgbWFpbGluZyBsaXN0
ClNwaWNlLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNr
dG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL3NwaWNlLWRldmVs
