Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id A45269E5D0
	for <lists+spice-devel@lfdr.de>; Tue, 27 Aug 2019 12:40:37 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 2BA3889A14;
	Tue, 27 Aug 2019 10:40:36 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mail-wr1-x442.google.com (mail-wr1-x442.google.com
 [IPv6:2a00:1450:4864:20::442])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 71D7389A14
 for <spice-devel@lists.freedesktop.org>; Tue, 27 Aug 2019 10:40:34 +0000 (UTC)
Received: by mail-wr1-x442.google.com with SMTP id t16so18276821wra.6
 for <spice-devel@lists.freedesktop.org>; Tue, 27 Aug 2019 03:40:34 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:references:user-agent:to:subject
 :in-reply-to:date:message-id:mime-version;
 bh=Tpa2Oe9BJyznlL/1RK7nIgY8V8hxAS4VawUHEri3oQg=;
 b=roBvMpjar9leffzTWT/2bqqqGF8cd8Fz0ah1MuJEF6LYPKbMXTL4mWKq2wiD9uvQ8J
 MyA2uEDfuMmpn5i+ymaJIWy52yNvdy40EdNrZcjb22jO12x0AoJAqIIf5QlSCyaaysvl
 TlMIJpg2YCcr1N/DhpeohgvhBrEdew3Bi1itlW4JA7zLvhEP99Yjdz0YEw7EI2dwToTZ
 G8pMy6wKgwSoz8I0S3Pn9gbTHMcE36rcp7bLyP2cZfBXmkpkwhJt5f8I4HXXEoXyzzUc
 GVqOI29Wpu7/okEWYRC1KYn/yvAruzrpXsY8blnepC4YTSSyNV1MoKTDSWrJR7aCSbFw
 qWLA==
X-Gm-Message-State: APjAAAUlLbaOCFtJDiJ9D2M4kv+4oRJao6vxX4N5BKY1R0V8KpqMheLV
 17s7R0tJHkzGMwgtgyOorSxFhk1P
X-Google-Smtp-Source: APXvYqzI4aQGNwAnpA+Zm3uj0F374CLz855ISjsnNebJSip0g1qXduiJ2DNGlNFXcaT6lFPZYXX9rg==
X-Received: by 2002:adf:fcd1:: with SMTP id f17mr27406866wrs.252.1566902432513; 
 Tue, 27 Aug 2019 03:40:32 -0700 (PDT)
Received: from ptitpuce ([2a01:e35:8b6a:1220:95:eb51:474b:ae6b])
 by smtp.gmail.com with ESMTPSA id t19sm2570308wmi.29.2019.08.27.03.40.29
 for <spice-devel@lists.freedesktop.org>
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Tue, 27 Aug 2019 03:40:31 -0700 (PDT)
From: Christophe de Dinechin <christophe.de.dinechin@gmail.com>
X-Google-Original-From: Christophe de Dinechin <christophe@dinechin.org>
References: <20190827092246.10276-1-fziglio@redhat.com>
 <20190827092246.10276-25-fziglio@redhat.com>
User-agent: mu4e 1.3.2; emacs 26.2
To: spice-devel@lists.freedesktop.org
In-reply-to: <20190827092246.10276-25-fziglio@redhat.com>
Date: Tue, 27 Aug 2019 12:40:27 +0200
Message-ID: <m1tva2evs4.fsf@dinechin.org>
MIME-Version: 1.0
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=gmail.com; s=20161025;
 h=from:references:user-agent:to:subject:in-reply-to:date:message-id
 :mime-version;
 bh=Tpa2Oe9BJyznlL/1RK7nIgY8V8hxAS4VawUHEri3oQg=;
 b=EGlEAzKr4fK6BFaK/eu7LzBfHaJl/M2A79+BotrBgZQ+4JhIFUMNh33Ld8hIie2Kzy
 nwia8B6tEHW++bVs1GjZ7DqoB3u4P4Qffrym8Fy5BQ9N166+DLhEuF36C76KfEDMUI0j
 5jIVW3wJ7dVghBiElNQ50Tfj2HkNGbzYQjprO7pCDPPwDKvs0Ypxfthh/NAnLB2mcs8M
 mzmQbRpMwhxBeCwKcC2OpvFnnOngiQVxpYbCQAAYHspDQF191BQTSTpsJr8CvO3mTZ62
 uvhMUa3fWcQLBprMnl5EKO6myoLvczJ1Y8nL4XCqGKdhBYofAORztujNHR8ulqE7jrbb
 c4iw==
Subject: Re: [Spice-devel] [PATCH spice-gtk v4 24/29] usb-backend: Rewrite
 USB emulation support
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

CkZyZWRpYW5vIFppZ2xpbyB3cml0ZXM6Cgo+IE1ha2UgaW5pdGlhbGlzYXRpb24gZWFzaWVyLgo+
IEFsd2F5cyBpbml0aWFsaXNlIHBhcnNlci4KCk15IHNwZWxsY2hlY2tlciBzZWVtcyB0byBjaG9r
ZSBvbiAiaW5pdGlhbGlzZSIsIHN1Z2dlc3RzCiJpbml0aWFsaXplIiAobWF5YmUgYSBVSy9VUyBk
aWZmZXJlbmNlKS4KCj4gSW5pdGlhbGlzZSBib3RoIHBhcnNlciBhbmQgaG9zdCBkdXJpbmcgc3Bp
Y2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9uZXcuCj4gU3VwcG9ydCBub3QgaGF2aW5nIGxpYnVzYiBj
b250ZXh0IChubyBwaHlzaWNhbCBkZXZpY2VzKS4KPiBBdm9pZHMgdG9vIG11Y2ggc3RhdGUgdmFy
aWFibGVzLgoKIlJlZHVjZSBudW1iZXIgb2Ygc3RhdGUgdmFyaWFibGVzIj8KCkJhc2VkIG9uIHRo
ZSBjb2RlLCBJJ2QgZ28gYXMgZmFyIGFzIHN0YXRpbmcgIlNpbXBsaWZ5IHN0YXRlIG1hY2hpbmUg
bG9naWMiLgoKPiBwYXJzZXIgaXMgYWx3YXlzIGluaXRpYWxpc2VkIGFmdGVyIGNyZWF0aW9uIG1h
a2luZyBzdXJlIHRoZSBzdGF0ZQo+IGlzIGNvbnNpc3RlbnQuCgpUaGF0IHNlZW1zIHJlZHVuZGFu
dCB3aXRoICJBbHdheXMgaW5pdGlhbGl6ZSBwYXJzZXIiLgoKCj4gVXNlIGEgc2luZ2xlIHN0YXRl
IHZhcmlhYmxlLCBkYXRhIGZsb3dzIGludG8vZnJvbSBhIHNpbmdsZSBwYXJzZXIuCj4KPiBTaWdu
ZWQtb2ZmLWJ5OiBGcmVkaWFubyBaaWdsaW8gPGZ6aWdsaW9AcmVkaGF0LmNvbT4KPiAtLS0KPiAg
c3JjL3VzYi1iYWNrZW5kLmMgfCAyMzYgKysrKysrKysrKysrKysrKysrKysrKystLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLQo+ICAxIGZpbGUgY2hhbmdlZCwgMTE2IGluc2VydGlvbnMoKyksIDEyMCBk
ZWxldGlvbnMoLSkKPgo+IGRpZmYgLS1naXQgYS9zcmMvdXNiLWJhY2tlbmQuYyBiL3NyYy91c2It
YmFja2VuZC5jCj4gaW5kZXggMzZhNzNhODkuLmQ2MTRlNjkzIDEwMDY0NAo+IC0tLSBhL3NyYy91
c2ItYmFja2VuZC5jCj4gKysrIGIvc3JjL3VzYi1iYWNrZW5kLmMKPiBAQCAtNzgsMjEgKzc4LDIx
IEBAIHN0cnVjdCBfU3BpY2VVc2JCYWNrZW5kCj4gICAgICB1aW50MzJfdCBvd25fZGV2aWNlc19t
YXNrOwo+ICB9Owo+Cj4gK3R5cGVkZWYgZW51bSB7Cj4gKyAgICBVU0JfQ0hBTk5FTF9TVEFURV9J
TklUSUFMSVpJTkcsCgooWW91IHNlZW0gdG8gaGF2ZSB1c2VkICJpbml0aWFsaXplIiB3aXRoIGEg
InoiIGhlcmUpCgo+ICsgICAgVVNCX0NIQU5ORUxfU1RBVEVfSE9TVCwKPiArICAgIFVTQl9DSEFO
TkVMX1NUQVRFX1BBUlNFUiwKCkkgY2FuJ3Qgc2F5IHRoYXQgIlNUQVRFX0hPU1QiIGFuZCAiU1RB
VEVfUEFSU0VSIiBtYWtlIG11Y2ggc2Vuc2UgdG8gbWUuCk1heWJlIHNvbWV0aGluZyBsaWtlICJT
VEFURV9VU0JSRURJUkhPU1QiIGFuZCAiU1RBVEVfUEFSU0lORyIgb3IKIlNUQVRFX1BBUlNFUl9B
Q1RJVkUiPwoKPiArfSBTcGljZVVzYkJhY2tlbmRDaGFubmVsU3RhdGU7Cj4gKwo+ICBzdHJ1Y3Qg
X1NwaWNlVXNiQmFja2VuZENoYW5uZWwKPiAgewo+ICAgICAgc3RydWN0IHVzYnJlZGlyaG9zdCAq
dXNicmVkaXJob3N0Owo+IC0gICAgc3RydWN0IHVzYnJlZGlyaG9zdCAqaGlkZGVuX2hvc3Q7Cj4g
ICAgICBzdHJ1Y3QgdXNicmVkaXJwYXJzZXIgKnBhcnNlcjsKPiAtICAgIHN0cnVjdCB1c2JyZWRp
cnBhcnNlciAqaGlkZGVuX3BhcnNlcjsKPiArICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWxTdGF0
ZSBzdGF0ZTsKPiAgICAgIHVpbnQ4X3QgKnJlYWRfYnVmOwo+ICAgICAgaW50IHJlYWRfYnVmX3Np
emU7Cj4gICAgICBzdHJ1Y3QgdXNicmVkaXJmaWx0ZXJfcnVsZSAqcnVsZXM7Cj4gICAgICBpbnQg
cnVsZXNfY291bnQ7Cj4gLSAgICB1aW50MzJfdCBob3N0X2NhcHM7Cj4gLSAgICB1aW50MzJfdCBw
YXJzZXJfaW5pdF9kb25lICA6IDE7Cj4gLSAgICB1aW50MzJfdCBwYXJzZXJfd2l0aF9oZWxsbyA6
IDE7Cj4gLSAgICB1aW50MzJfdCBoZWxsb19kb25lX3BhcnNlciA6IDE7Cj4gLSAgICB1aW50MzJf
dCBoZWxsb19zZW50ICAgICAgICA6IDE7Cj4gICAgICB1aW50MzJfdCByZWplY3RlZCAgICAgICAg
ICA6IDE7Cj4gICAgICB1aW50MzJfdCB3YWl0X2Rpc2Nvbm5lY3RfYWNrIDogMTsKCk5pY2Ugc2lt
cGxpZmljYXRpb24hCgpXb3VsZCBpdCBtYWtlIHNlbnNlIHRvIHVzZSAiYm9vbCIgZm9yIGZsYWdz
PwoKPiAgICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqYXR0YWNoZWQ7Cj4gQEAgLTQwNSwxNSAr
NDA1LDE2IEBAIGZyb20gYm90aCB0aGUgbWFpbiB0aHJlYWQgYXMgd2VsbCBhcyBmcm9tIHRoZSB1
c2IgZXZlbnQgaGFuZGxpbmcgdGhyZWFkICovCj4gIHN0YXRpYyB2b2lkIHVzYnJlZGlyX3dyaXRl
X2ZsdXNoX2NhbGxiYWNrKHZvaWQgKnVzZXJfZGF0YSkKPiAgewo+ICAgICAgU3BpY2VVc2JCYWNr
ZW5kQ2hhbm5lbCAqY2ggPSB1c2VyX2RhdGE7Cj4gKyAgICBpZiAoY2gtPnBhcnNlciA9PSBOVUxM
KSB7Cj4gKyAgICAgICAgcmV0dXJuOwo+ICsgICAgfQo+ICAgICAgaWYgKGlzX2NoYW5uZWxfcmVh
ZHkoY2gtPnVzZXJfZGF0YSkpIHsKPiAtICAgICAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgewo+
ICsgICAgICAgIGlmIChjaC0+c3RhdGUgPT0gVVNCX0NIQU5ORUxfU1RBVEVfSE9TVCkgewo+ICAg
ICAgICAgICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAgLT4gdXNicmVkaXJob3N0IiwgX19GVU5D
VElPTl9fLCBjaCk7Cj4gICAgICAgICAgICAgIHVzYnJlZGlyaG9zdF93cml0ZV9ndWVzdF9kYXRh
KGNoLT51c2JyZWRpcmhvc3QpOwo+IC0gICAgICAgIH0gZWxzZSBpZiAoY2gtPnBhcnNlcikgewo+
ICsgICAgICAgIH0gZWxzZSB7Cj4gICAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAt
PiBwYXJzZXIiLCBfX0ZVTkNUSU9OX18sIGNoKTsKPiAgICAgICAgICAgICAgdXNicmVkaXJwYXJz
ZXJfZG9fd3JpdGUoY2gtPnBhcnNlcik7Cj4gLSAgICAgICAgfSBlbHNlIHsKPiAtICAgICAgICAg
ICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIChOT1QgQUNUSVZFKSIsIF9fRlVOQ1RJT05fXywgY2gp
Owo+ICAgICAgICAgIH0KPiAgICAgIH0gZWxzZSB7Cj4gICAgICAgICAgU1BJQ0VfREVCVUcoIiVz
IGNoICVwIChub3QgcmVhZHkpIiwgX19GVU5DVElPTl9fLCBjaCk7Cj4gQEAgLTY3MywyMSArNjc0
LDQyIEBAIHN0YXRpYyB2b2lkIHVzYnJlZGlyX2xvZyh2b2lkICp1c2VyX2RhdGEsIGludCBsZXZl
bCwgY29uc3QgY2hhciAqbXNnKQo+ICAgICAgfQo+ICB9Cj4KPiArc3RhdGljIHN0cnVjdCB1c2Jy
ZWRpcnBhcnNlciAqY3JlYXRlX3BhcnNlcihTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCk7Cj4g
Kwo+ICBzdGF0aWMgaW50IHVzYnJlZGlyX3dyaXRlX2NhbGxiYWNrKHZvaWQgKnVzZXJfZGF0YSwg
dWludDhfdCAqZGF0YSwgaW50IGNvdW50KQo+ICB7Cj4gICAgICBTcGljZVVzYkJhY2tlbmRDaGFu
bmVsICpjaCA9IHVzZXJfZGF0YTsKPiAgICAgIGludCByZXM7Cj4gICAgICBTUElDRV9ERUJVRygi
JXMgY2ggJXAsICVkIGJ5dGVzIiwgX19GVU5DVElPTl9fLCBjaCwgY291bnQpOwo+IC0gICAgaWYg
KCFjaC0+aGVsbG9fc2VudCkgewo+IC0gICAgICAgIC8qIGhlbGxvIGlzIHNob3J0IGhlYWRlciAo
MTIpICsgaGVsbG8gc3RydWN0ICg2NCkgKyBjYXBhYmlsaXRpZXMgKDQpICovCj4gLSAgICAgICAg
aW50IGhlbGxvX3NpemUgPSBzaXplb2Yoc3RydWN0IHVzYl9yZWRpcl9oZWFkZXIpICsgc2l6ZW9m
KHN0cnVjdCB1c2JfcmVkaXJfaGVsbG9faGVhZGVyKTsKPiAtICAgICAgICBjaC0+aGVsbG9fc2Vu
dCA9IDE7Cj4gLSAgICAgICAgaWYgKGNvdW50ID09IGhlbGxvX3NpemUpIHsKPiAtICAgICAgICAg
ICAgbWVtY3B5KCZjaC0+aG9zdF9jYXBzLCBkYXRhICsgaGVsbG9fc2l6ZSAtIHNpemVvZihjaC0+
aG9zdF9jYXBzKSwKPiAtICAgICAgICAgICAgICAgICAgIHNpemVvZihjaC0+aG9zdF9jYXBzKSk7
Cj4gLSAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCwgc2VuZGluZyBmaXJzdCBoZWxs
bywgY2FwcyAlMDhYIiwKPiAtICAgICAgICAgICAgICAgICAgICAgICAgX19GVU5DVElPTl9fLCBj
aCwgY2gtPmhvc3RfY2Fwcyk7Cj4gKwo+ICsgICAgLy8gaGFuZGxlIGZpcnN0IHBhY2tldCAoSEVM
TE8pIGNyZWF0aW5nIHBhcnNlciBmcm9tIGNhcGFiaWxpdGllcwo+ICsgICAgaWYgKFNQSUNFX1VO
TElLRUxZKGNoLT5wYXJzZXIgPT0gTlVMTCkpIHsKPiArICAgICAgICAvLyB3ZSBhcmUgc3RpbGwg
aW5pdGlhbGl6aW5nIHRoZSBob3N0Cj4gKyAgICAgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QgPT0g
TlVMTCkgewo+ICsgICAgICAgICAgICByZXR1cm4gMDsKPiAgICAgICAgICB9Cj4gKwo+ICsgICAg
ICAgIGNoLT5wYXJzZXIgPSBjcmVhdGVfcGFyc2VyKGNoKTsKPiArICAgICAgICBpZiAoIWNoLT5w
YXJzZXIpIHsKPiArICAgICAgICAgICAgcmV0dXJuIDA7Cj4gKyAgICAgICAgfQo+ICsKPiArICAg
ICAgICAvKiBoZWxsbyBpcyBzaG9ydCBoZWFkZXIgKDEyKSArIGhlbGxvIHN0cnVjdCAoNjQpICov
Cj4gKyAgICAgICAgY29uc3QgaW50IGhlbGxvX3NpemUgPSAxMiArIHNpemVvZihzdHJ1Y3QgdXNi
X3JlZGlyX2hlbGxvX2hlYWRlcik7Cj4gKyAgICAgICAgZ19hc3NlcnQoY291bnQgPj0gaGVsbG9f
c2l6ZSArIDQpOwo+ICsgICAgICAgIGdfYXNzZXJ0KFNQSUNFX0FMSUdORURfQ0FTVChzdHJ1Y3Qg
dXNiX3JlZGlyX2hlYWRlciAqLCBkYXRhKS0+dHlwZSA9PSB1c2JfcmVkaXJfaGVsbG8pOwo+ICsK
PiArICAgICAgICBjb25zdCB1aW50MzJfdCBmbGFncyA9Cj4gKyAgICAgICAgICAgIHVzYnJlZGly
cGFyc2VyX2ZsX3dyaXRlX2NiX293bnNfYnVmZmVyIHwgdXNicmVkaXJwYXJzZXJfZmxfdXNiX2hv
c3QgfAo+ICsgICAgICAgICAgICB1c2JyZWRpcnBhcnNlcl9mbF9ub19oZWxsbzsKPiArCj4gKyAg
ICAgICAgdXNicmVkaXJwYXJzZXJfaW5pdChjaC0+cGFyc2VyLAo+ICsgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgUEFDS0FHRV9TVFJJTkcsCj4gKyAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBTUElDRV9BTElHTkVEX0NBU1QodWludDMyX3QgKiwgZGF0YSArIGhlbGxvX3NpemUpLAo+ICsg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgKGNvdW50IC0gaGVsbG9fc2l6ZSkgLyBzaXplb2Yo
dWludDMyX3QpLAo+ICsgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxhZ3MpOwo+ICsKPiAr
ICAgICAgICByZXR1cm4gMDsKCldoeSByZXR1cm4gMCBhbmQgbm90IGp1c3QgZmFsbCB0aHJvdWdo
PwpJZiBhIHdyaXRlIHJldHJ5IGlzIG5lY2Vzc2FyeSwgY291bGQgeW91IGFkZCBhIGNvbW1lbnQg
ZXhwbGFpbmluZyB3aHk/CgpTaWRlIGNvbW1lbnQ6IHVzYnJlZGlyX3dyaXRlX2NhbGxiYWNrIHVz
ZWQgdG8gYmUgYSBtZXJlIHdyYXBwZXIgYXJvdW5kCnNwaWNlX3VzYnJlZGlyX3dyaXRlX2NhbGxi
YWNrLiBOb3csIGl0IGhhcyBhIHdob2xlIGxvdCBvZiBsb2dpYyBpbiBpdC4KSXMgaXQgaW50ZW50
aW9uYWwsIG9yIHNob3VsZCBzb21lIG9mIHRoYXQgbG9naWMgYmUgbW92ZWQgdG8gc2hhcmVkIGNv
ZGU/CgoKPiAgICAgIH0KPiAgICAgIHJlcyA9IHNwaWNlX3VzYnJlZGlyX3dyaXRlX2NhbGxiYWNr
KGNoLT51c2VyX2RhdGEsIGRhdGEsIGNvdW50KTsKPiAgICAgIHJldHVybiByZXM7Cj4gQEAgLTcw
NywzMSArNzI5LDMzIEBAIGludCBzcGljZV91c2JfYmFja2VuZF9yZWFkX2d1ZXN0X2RhdGEoU3Bp
Y2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsIHVpbnQ4X3QgKmRhdGEsCj4KPiAgICAgIGNoLT5yZWFk
X2J1ZiA9IGRhdGE7Cj4gICAgICBjaC0+cmVhZF9idWZfc2l6ZSA9IGNvdW50Owo+IC0gICAgaWYg
KGNoLT51c2JyZWRpcmhvc3QpIHsKPiAtICAgICAgICByZXMgPSB1c2JyZWRpcmhvc3RfcmVhZF9n
dWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3QpOwo+IC0gICAgICAgIGlmICghY2gtPmhlbGxvX2Rv
bmVfcGFyc2VyKSB7Cj4gLSAgICAgICAgICAgIGludCByZXNfcGFyc2VyOwo+ICsgICAgaWYgKFNQ
SUNFX1VOTElLRUxZKGNoLT5zdGF0ZSA9PSBVU0JfQ0hBTk5FTF9TVEFURV9JTklUSUFMSVpJTkcp
KSB7Cj4gKyAgICAgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QgIT0gTlVMTCkgewo+ICsgICAgICAg
ICAgICByZXMgPSB1c2JyZWRpcmhvc3RfcmVhZF9ndWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3Qp
Owo+ICsgICAgICAgICAgICBpZiAocmVzICE9IDApIHsKPiArICAgICAgICAgICAgICAgIHJldHVy
biByZXM7Cj4gKyAgICAgICAgICAgIH0KPiArICAgICAgICAgICAgY2gtPnN0YXRlID0gVVNCX0NI
QU5ORUxfU1RBVEVfSE9TVDsKPiArCj4gICAgICAgICAgICAgIC8qIHVzYnJlZGlyaG9zdCBzaG91
bGQgY29uc3VtZSBoZWxsbyByZXNwb25zZSAqLwo+ICAgICAgICAgICAgICBnX3JldHVybl92YWxf
aWZfZmFpbChjaC0+cmVhZF9idWYgPT0gTlVMTCwgVVNCX1JFRElSX0VSUk9SX1JFQURfUEFSU0Up
Owo+ICsgICAgICAgIH0gZWxzZSB7Cj4gKyAgICAgICAgICAgIGNoLT5zdGF0ZSA9IFVTQl9DSEFO
TkVMX1NUQVRFX1BBUlNFUjsKPiArICAgICAgICB9Cj4KPiAtICAgICAgICAgICAgY2gtPnJlYWRf
YnVmID0gZGF0YTsKPiAtICAgICAgICAgICAgY2gtPnJlYWRfYnVmX3NpemUgPSBjb3VudDsKPiAt
ICAgICAgICAgICAgY2gtPmhlbGxvX2RvbmVfcGFyc2VyID0gMTsKPiAtICAgICAgICAgICAgaWYg
KGNoLT5hdHRhY2hlZCAmJiBjaC0+YXR0YWNoZWQtPmVkZXYpIHsKPiAtICAgICAgICAgICAgICAg
IC8qIGNhc2Ugb2YgQ0Qgc2hhcmluZyBvbiBjb25uZWN0ICovCj4gLSAgICAgICAgICAgICAgICBj
aC0+dXNicmVkaXJob3N0ID0gTlVMTDsKPiAtICAgICAgICAgICAgICAgIGNoLT5wYXJzZXIgPSBj
aC0+aGlkZGVuX3BhcnNlcjsKPiAtICAgICAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlczogc3dp
dGNoICVwIHRvIHBhcnNlciIsIF9fRlVOQ1RJT05fXywgY2gpOwo+IC0gICAgICAgICAgICB9Cj4g
LSAgICAgICAgICAgIHJlc19wYXJzZXIgPSB1c2JyZWRpcnBhcnNlcl9kb19yZWFkKGNoLT5oaWRk
ZW5fcGFyc2VyKTsKPiAtICAgICAgICAgICAgaWYgKHJlcyA+PSAwKSB7Cj4gLSAgICAgICAgICAg
ICAgICByZXMgPSByZXNfcGFyc2VyOwo+IC0gICAgICAgICAgICB9Cj4gKyAgICAgICAgY2gtPnJl
YWRfYnVmID0gZGF0YTsKPiArICAgICAgICBjaC0+cmVhZF9idWZfc2l6ZSA9IGNvdW50Owo+ICsg
ICAgICAgIGlmIChjaC0+YXR0YWNoZWQgJiYgY2gtPmF0dGFjaGVkLT5lZGV2KSB7Cj4gKyAgICAg
ICAgICAgIC8qIGNhc2Ugb2YgQ0Qgc2hhcmluZyBvbiBjb25uZWN0ICovCj4gKyAgICAgICAgICAg
IGNoLT5zdGF0ZSA9IFVTQl9DSEFOTkVMX1NUQVRFX1BBUlNFUjsKPiArICAgICAgICAgICAgU1BJ
Q0VfREVCVUcoIiVzOiBzd2l0Y2ggJXAgdG8gcGFyc2VyIiwgX19GVU5DVElPTl9fLCBjaCk7Cj4g
ICAgICAgICAgfQo+IC0gICAgfSBlbHNlIGlmIChjaC0+cGFyc2VyKSB7Cj4gLSAgICAgICAgcmVz
ID0gdXNicmVkaXJwYXJzZXJfZG9fcmVhZChjaC0+cGFyc2VyKTsKPiArICAgICAgICByZXR1cm4g
dXNicmVkaXJwYXJzZXJfZG9fcmVhZChjaC0+cGFyc2VyKTsKPiArICAgIH0KPiArICAgIGlmIChj
aC0+c3RhdGUgPT0gVVNCX0NIQU5ORUxfU1RBVEVfSE9TVCkgewo+ICsgICAgICAgIHJlcyA9IHVz
YnJlZGlyaG9zdF9yZWFkX2d1ZXN0X2RhdGEoY2gtPnVzYnJlZGlyaG9zdCk7Cj4gICAgICB9IGVs
c2Ugewo+IC0gICAgICAgIHJlcyA9IFVTQl9SRURJUl9FUlJPUl9JTzsKPiArICAgICAgICByZXMg
PSB1c2JyZWRpcnBhcnNlcl9kb19yZWFkKGNoLT5wYXJzZXIpOwo+ICAgICAgfQo+ICAgICAgc3dp
dGNoIChyZXMpCj4gICAgICB7Cj4gQEAgLTc4MywxNCArODA3LDEyIEBAIEdFcnJvciAqc3BpY2Vf
dXNiX2JhY2tlbmRfZ2V0X2Vycm9yX2RldGFpbHMoaW50IGVycm9yX2NvZGUsIGdjaGFyICpkZXNj
KQo+Cj4gIHZvaWQgc3BpY2VfdXNiX2JhY2tlbmRfcmV0dXJuX3dyaXRlX2RhdGEoU3BpY2VVc2JC
YWNrZW5kQ2hhbm5lbCAqY2gsIHZvaWQgKmRhdGEpCj4gIHsKPiAtICAgIGlmIChjaC0+dXNicmVk
aXJob3N0KSB7Cj4gKyAgICBpZiAoY2gtPnN0YXRlID09IFVTQl9DSEFOTkVMX1NUQVRFX0hPU1Qp
IHsKPiAgICAgICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAgLT4gdXNicmVkaXJob3N0IiwgX19G
VU5DVElPTl9fLCBjaCk7Cj4gICAgICAgICAgdXNicmVkaXJob3N0X2ZyZWVfd3JpdGVfYnVmZmVy
KGNoLT51c2JyZWRpcmhvc3QsIGRhdGEpOwo+IC0gICAgfSBlbHNlIGlmIChjaC0+cGFyc2VyKSB7
Cj4gKyAgICB9IGVsc2Ugewo+ICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAtPiBwYXJz
ZXIiLCBfX0ZVTkNUSU9OX18sIGNoKTsKPiAgICAgICAgICB1c2JyZWRpcnBhcnNlcl9mcmVlX3dy
aXRlX2J1ZmZlcihjaC0+cGFyc2VyLCBkYXRhKTsKPiAtICAgIH0gZWxzZSB7Cj4gLSAgICAgICAg
U1BJQ0VfREVCVUcoIiVzIGNoICVwIC0gTk9CT0RZIFRPIENBTEwiLCBfX0ZVTkNUSU9OX18sIGNo
KTsKPiAgICAgIH0KPiAgfQo+Cj4gQEAgLTEwMDUsMTAgKzEwMjcsMTAgQEAgc3RhdGljIHZvaWQg
dXNicmVkaXJfZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrKHZvaWQgKnByaXYpCj4gIHsKPiAgICAgIFNw
aWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKPiAgICAgIFNQSUNFX0RFQlVHKCIlcyBj
aCAlcCIsIF9fRlVOQ1RJT05fXywgY2gpOwo+IC0gICAgaWYgKGNoLT5wYXJzZXIgJiYgY2gtPndh
aXRfZGlzY29ubmVjdF9hY2spIHsKPiAtICAgICAgICBjaC0+cGFyc2VyID0gTlVMTDsKPiArICAg
IGlmIChjaC0+c3RhdGUgPT0gVVNCX0NIQU5ORUxfU1RBVEVfUEFSU0VSICYmIGNoLT51c2JyZWRp
cmhvc3QgIT0gTlVMTCAmJgo+ICsgICAgICAgIGNoLT53YWl0X2Rpc2Nvbm5lY3RfYWNrKSB7Cj4g
KyAgICAgICAgY2gtPnN0YXRlID0gVVNCX0NIQU5ORUxfU1RBVEVfSE9TVDsKPiAgICAgICAgICBT
UElDRV9ERUJVRygiJXMgc3dpdGNoIHRvIHVzYnJlZGlyaG9zdCIsIF9fRlVOQ1RJT05fXyk7Cj4g
LSAgICAgICAgY2gtPnVzYnJlZGlyaG9zdCA9IGNoLT5oaWRkZW5faG9zdDsKPiAgICAgIH0KPiAg
ICAgIGNoLT53YWl0X2Rpc2Nvbm5lY3RfYWNrID0gMDsKPiAgfQo+IEBAIC0xMDI3LDkgKzEwNDks
NiBAQCB1c2JyZWRpcl9oZWxsbyh2b2lkICpwcml2LCBzdHJ1Y3QgdXNiX3JlZGlyX2hlbGxvX2hl
YWRlciAqaGVsbG8pCj4gICAgICBTUElDRV9ERUJVRygiJXMgJXAgJXNhdHRhY2hlZCAlcyIsIF9f
RlVOQ1RJT05fXywgY2gsCj4gICAgICAgICAgZWRldiA/ICIiIDogIm5vdCAiLCAgaGVsbG8gPyAi
IiA6ICIoaW50ZXJuYWwpIik7Cj4KPiAtICAgIGlmIChoZWxsbykgewo+IC0gICAgICAgIGNoLT5o
ZWxsb19kb25lX3BhcnNlciA9IDE7Cj4gLSAgICB9Cj4gICAgICBpZiAoIWVkZXYpIHsKPiAgICAg
ICAgICByZXR1cm47Cj4gICAgICB9Cj4gQEAgLTEwNzksNTMgKzEwOTgsMjQgQEAgdXNicmVkaXJf
aGVsbG8odm9pZCAqcHJpdiwgc3RydWN0IHVzYl9yZWRpcl9oZWxsb19oZWFkZXIgKmhlbGxvKQo+
ICAgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2soY2gpOwo+ICB9Cj4KPiAtc3RhdGlj
IHZvaWQgaW5pdGlhbGl6ZV9wYXJzZXIoU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsIGdib29s
ZWFuIGRvX2hlbGxvKQo+ICtzdGF0aWMgdm9pZCBpbml0aWFsaXplX3BhcnNlcihTcGljZVVzYkJh
Y2tlbmRDaGFubmVsICpjaCkKPiAgewo+ICAgICAgdWludDMyX3QgZmxhZ3MsIGNhcHNbVVNCX1JF
RElSX0NBUFNfU0laRV0gPSB7IDAgfTsKPgo+IC0gICAgZ19yZXR1cm5faWZfZmFpbChjaC0+aGlk
ZGVuX3BhcnNlciAhPSBOVUxMKTsKPiAtICAgIGlmIChjaC0+cGFyc2VyX2luaXRfZG9uZSkgewo+
IC0gICAgICAgIGlmIChjaC0+cGFyc2VyX3dpdGhfaGVsbG8gIT0gZG9faGVsbG8pIHsKPiAtICAg
ICAgICAgICAgZ19yZXR1cm5faWZfcmVhY2hlZCgpOwo+IC0gICAgICAgIH0KPiAtICAgICAgICBy
ZXR1cm47Cj4gLSAgICB9Cj4gKyAgICBnX2Fzc2VydChjaC0+dXNicmVkaXJob3N0ID09IE5VTEwp
Owo+Cj4gLSAgICBjaC0+cGFyc2VyX2luaXRfZG9uZSA9IDE7Cj4gLSAgICBjaC0+cGFyc2VyX3dp
dGhfaGVsbG8gPSBkb19oZWxsbzsKPiAgICAgIGZsYWdzID0gdXNicmVkaXJwYXJzZXJfZmxfd3Jp
dGVfY2Jfb3duc19idWZmZXIgfCB1c2JyZWRpcnBhcnNlcl9mbF91c2JfaG9zdDsKPgo+IC0gICAg
aWYgKGRvX2hlbGxvKSB7Cj4gLSAgICAgICAgY2gtPmhlbGxvX3NlbnQgPSAxOwo+IC0gICAgICAg
IGNoLT5ob3N0X2NhcHMgfD0gMSA8PCB1c2JfcmVkaXJfY2FwX2Nvbm5lY3RfZGV2aWNlX3ZlcnNp
b247Cj4gLSAgICAgICAgY2gtPmhvc3RfY2FwcyB8PSAxIDw8IHVzYl9yZWRpcl9jYXBfZGV2aWNl
X2Rpc2Nvbm5lY3RfYWNrOwo+IC0gICAgICAgIGNoLT5ob3N0X2NhcHMgfD0gMSA8PCB1c2JfcmVk
aXJfY2FwX2VwX2luZm9fbWF4X3BhY2tldF9zaXplOwo+IC0gICAgICAgIGNoLT5ob3N0X2NhcHMg
fD0gMSA8PCB1c2JfcmVkaXJfY2FwXzY0Yml0c19pZHM7Cj4gLSAgICAgICAgY2gtPmhvc3RfY2Fw
cyB8PSAxIDw8IHVzYl9yZWRpcl9jYXBfMzJiaXRzX2J1bGtfbGVuZ3RoOwo+IC0gICAgfSBlbHNl
IHsKPiAtICAgICAgICBmbGFncyB8PSB1c2JyZWRpcnBhcnNlcl9mbF9ub19oZWxsbzsKPiAtICAg
IH0KPiAtCj4gLSAgICBpZiAoY2gtPmhvc3RfY2FwcyAmICgxIDw8IHVzYl9yZWRpcl9jYXBfY29u
bmVjdF9kZXZpY2VfdmVyc2lvbikpIHsKPiAtICAgICAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3Nl
dF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF9jb25uZWN0X2RldmljZV92ZXJzaW9uKTsKPiAtICAg
IH0KPiArICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJfY2Fw
X2Nvbm5lY3RfZGV2aWNlX3ZlcnNpb24pOwo+ICAgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRf
Y2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfZmlsdGVyKTsKPiAtICAgIGlmIChjaC0+aG9zdF9jYXBz
ICYgKDEgPDwgdXNiX3JlZGlyX2NhcF9kZXZpY2VfZGlzY29ubmVjdF9hY2spKSB7Cj4gLSAgICAg
ICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfZGV2aWNl
X2Rpc2Nvbm5lY3RfYWNrKTsKPiAtICAgIH0KPiAtICAgIGlmIChjaC0+aG9zdF9jYXBzICYgKDEg
PDwgdXNiX3JlZGlyX2NhcF9lcF9pbmZvX21heF9wYWNrZXRfc2l6ZSkpIHsKPiAtICAgICAgICB1
c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF9lcF9pbmZvX21h
eF9wYWNrZXRfc2l6ZSk7Cj4gLSAgICB9Cj4gLSAgICBpZiAoY2gtPmhvc3RfY2FwcyAmICgxIDw8
IHVzYl9yZWRpcl9jYXBfNjRiaXRzX2lkcykpIHsKPiAtICAgICAgICB1c2JyZWRpcnBhcnNlcl9j
YXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF82NGJpdHNfaWRzKTsKPiAtICAgIH0KPiAt
ICAgIGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF8zMmJpdHNfYnVsa19s
ZW5ndGgpKSB7Cj4gLSAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVz
Yl9yZWRpcl9jYXBfMzJiaXRzX2J1bGtfbGVuZ3RoKTsKPiAtICAgIH0KPiAtICAgIGlmIChjaC0+
aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF9idWxrX3N0cmVhbXMpKSB7Cj4gLSAgICAg
ICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfYnVsa19z
dHJlYW1zKTsKPiAtICAgIH0KPiAtICAgIHVzYnJlZGlycGFyc2VyX2luaXQoY2gtPmhpZGRlbl9w
YXJzZXIsIFBBQ0tBR0VfU1RSSU5HLCBjYXBzLCBVU0JfUkVESVJfQ0FQU19TSVpFLCBmbGFncyk7
Cj4gKyAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF9k
ZXZpY2VfZGlzY29ubmVjdF9hY2spOwo+ICsgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2Fw
KGNhcHMsIHVzYl9yZWRpcl9jYXBfZXBfaW5mb19tYXhfcGFja2V0X3NpemUpOwo+ICsgICAgdXNi
cmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfNjRiaXRzX2lkcyk7
Cj4gKyAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF8z
MmJpdHNfYnVsa19sZW5ndGgpOwo+ICsgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNh
cHMsIHVzYl9yZWRpcl9jYXBfYnVsa19yZWNlaXZpbmcpOwo+ICsgICAgdXNicmVkaXJwYXJzZXJf
Y2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfYnVsa19zdHJlYW1zKTsKPiArCj4gKyAg
ICB1c2JyZWRpcnBhcnNlcl9pbml0KGNoLT5wYXJzZXIsIFBBQ0tBR0VfU1RSSU5HLCBjYXBzLCBV
U0JfUkVESVJfQ0FQU19TSVpFLCBmbGFncyk7Cj4gIH0KPgo+ICAvKgo+IEBAIC0xMTgwLDcgKzEx
NzAsNyBAQCBzdGF0aWMgZ2Jvb2xlYW4gYXR0YWNoX2VkZXYoU3BpY2VVc2JCYWNrZW5kQ2hhbm5l
bCAqY2gsCj4gICAgICAgICAgICAgXygiRmFpbGVkIHRvIHJlZGlyZWN0IGRldmljZSAlZCIpLCAx
KTsKPiAgICAgICAgICByZXR1cm4gRkFMU0U7Cj4gICAgICB9Cj4gLSAgICBpZiAoY2gtPnVzYnJl
ZGlyaG9zdCAmJiAhY2gtPmhlbGxvX2RvbmVfcGFyc2VyKSB7Cj4gKyAgICBpZiAoY2gtPnN0YXRl
ID09IFVTQl9DSEFOTkVMX1NUQVRFX0lOSVRJQUxJWklORykgewo+ICAgICAgICAgIC8qCj4gICAg
ICAgICAgICAgIHdlIGNhbid0IGluaXRpYWxpemUgcGFyc2VyIHVudGlsIHdlIHNlZSBoZWxsbyBm
cm9tIHVzYnJlZGlyCj4gICAgICAgICAgICAgIGFuZCB0aGUgcGFyc2VyIGNhbid0IHdvcmsgdW50
aWwgaXQgc2VlcyB0aGUgaGVsbG8gcmVzcG9uc2UuCj4gQEAgLTExOTAsMTUgKzExODAsMTMgQEAg
c3RhdGljIGdib29sZWFuIGF0dGFjaF9lZGV2KFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLAo+
ICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyB3YWl0aW5nIHVudGlsIHRoZSBjaGFubmVsIGlzIHJl
YWR5IiwgX19GVU5DVElPTl9fKTsKPgo+ICAgICAgfSBlbHNlIHsKPiAtICAgICAgICBpbml0aWFs
aXplX3BhcnNlcihjaCwgY2gtPmhpZGRlbl9ob3N0ID09IE5VTEwpOwo+IC0gICAgICAgIGNoLT51
c2JyZWRpcmhvc3QgPSBOVUxMOwo+IC0gICAgICAgIGNoLT5wYXJzZXIgPSBjaC0+aGlkZGVuX3Bh
cnNlcjsKPiArICAgICAgICBjaC0+c3RhdGUgPSBVU0JfQ0hBTk5FTF9TVEFURV9QQVJTRVI7Cj4g
ICAgICB9Cj4gICAgICBjaC0+d2FpdF9kaXNjb25uZWN0X2FjayA9IDA7Cj4gICAgICBjaC0+YXR0
YWNoZWQgPSBkZXY7Cj4gICAgICBkZXYtPmF0dGFjaGVkX3RvID0gY2g7Cj4gLSAgICBkZXZpY2Vf
b3BzKGRldi0+ZWRldiktPmF0dGFjaChkZXYtPmVkZXYsIGNoLT5oaWRkZW5fcGFyc2VyKTsKPiAt
ICAgIGlmIChjaC0+aGVsbG9fZG9uZV9wYXJzZXIpIHsKPiArICAgIGRldmljZV9vcHMoZGV2LT5l
ZGV2KS0+YXR0YWNoKGRldi0+ZWRldiwgY2gtPnBhcnNlcik7Cj4gKyAgICBpZiAoY2gtPnN0YXRl
ID09IFVTQl9DSEFOTkVMX1NUQVRFX1BBUlNFUikgewo+ICAgICAgICAgIC8qIHNlbmQgZGV2aWNl
IGluZm8gKi8KPiAgICAgICAgICB1c2JyZWRpcl9oZWxsbyhjaCwgTlVMTCk7Cj4gICAgICB9Cj4g
QEAgLTEyMTgsOSArMTIwNiwxNSBAQCBnYm9vbGVhbiBzcGljZV91c2JfYmFja2VuZF9jaGFubmVs
X2F0dGFjaChTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwKPiAgICAgICAgICByZXR1cm4gYXR0
YWNoX2VkZXYoY2gsIGRldiwgZXJyb3IpOwo+ICAgICAgfQo+Cj4gKyAgICAvLyBubyBwaHlzaWNh
bCBkZXZpY2UgZW5hYmxlZAo+ICsgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QgPT0gTlVMTCkgewo+
ICsgICAgICAgIHJldHVybiBGQUxTRTsKPiArICAgIH0KPiArCj4gICAgICBsaWJ1c2JfZGV2aWNl
X2hhbmRsZSAqaGFuZGxlID0gTlVMTDsKPiAtICAgIGNoLT51c2JyZWRpcmhvc3QgPSBjaC0+aGlk
ZGVuX2hvc3Q7Cj4gLSAgICBjaC0+cGFyc2VyID0gTlVMTDsKPiArICAgIGlmIChjaC0+c3RhdGUg
IT0gVVNCX0NIQU5ORUxfU1RBVEVfSU5JVElBTElaSU5HKSB7Cj4gKyAgICAgICAgY2gtPnN0YXRl
ID0gVVNCX0NIQU5ORUxfU1RBVEVfSE9TVDsKPiArICAgIH0KPgo+ICAgICAgLyoKPiAgICAgICAg
IFVuZGVyIFdpbmRvd3Mgd2UgbmVlZCB0byBhdm9pZCB1cGRhdGluZwo+IEBAIC0xMjYxLDEwICsx
MjU1LDEwIEBAIHZvaWQgc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9kZXRhY2goU3BpY2VVc2JC
YWNrZW5kQ2hhbm5lbCAqY2gpCj4gICAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBub3RoaW5nIHRv
IGRldGFjaCIsIF9fRlVOQ1RJT05fXyk7Cj4gICAgICAgICAgcmV0dXJuOwo+ICAgICAgfQo+IC0g
ICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKPiArICAgIGlmIChjaC0+c3RhdGUgPT0gVVNCX0NI
QU5ORUxfU1RBVEVfSE9TVCkgewo+ICAgICAgICAgIC8qIGl0IHdpbGwgY2FsbCBsaWJ1c2JfY2xv
c2UgaW50ZXJuYWxseSAqLwo+ICAgICAgICAgIHVzYnJlZGlyaG9zdF9zZXRfZGV2aWNlKGNoLT51
c2JyZWRpcmhvc3QsIE5VTEwpOwo+IC0gICAgfSBlbHNlIGlmIChjaC0+cGFyc2VyKSB7Cj4gKyAg
ICB9IGVsc2Ugewo+ICAgICAgICAgIGlmIChlZGV2KSB7Cj4gICAgICAgICAgICAgIGRldmljZV9v
cHMoZWRldiktPmRldGFjaChlZGV2KTsKPiAgICAgICAgICB9Cj4gQEAgLTEyNzIsOSArMTI2Niw4
IEBAIHZvaWQgc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9kZXRhY2goU3BpY2VVc2JCYWNrZW5k
Q2hhbm5lbCAqY2gpCj4gICAgICAgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2soY2gp
Owo+ICAgICAgICAgIGNoLT53YWl0X2Rpc2Nvbm5lY3RfYWNrID0KPiAgICAgICAgICAgICAgdXNi
cmVkaXJwYXJzZXJfcGVlcl9oYXNfY2FwKGNoLT5wYXJzZXIsIHVzYl9yZWRpcl9jYXBfZGV2aWNl
X2Rpc2Nvbm5lY3RfYWNrKTsKPiAtICAgICAgICBpZiAoIWNoLT53YWl0X2Rpc2Nvbm5lY3RfYWNr
KSB7Cj4gLSAgICAgICAgICAgIGNoLT51c2JyZWRpcmhvc3QgPSBjaC0+aGlkZGVuX2hvc3Q7Cj4g
LSAgICAgICAgICAgIGNoLT5wYXJzZXIgPSBOVUxMOwo+ICsgICAgICAgIGlmICghY2gtPndhaXRf
ZGlzY29ubmVjdF9hY2sgJiYgY2gtPnVzYnJlZGlyaG9zdCAhPSBOVUxMKSB7Cj4gKyAgICAgICAg
ICAgIGNoLT5zdGF0ZSA9IFVTQl9DSEFOTkVMX1NUQVRFX0hPU1Q7Cj4gICAgICAgICAgfQo+ICAg
ICAgfQo+ICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwLCBkZXRhY2ggZG9uZSIsIF9fRlVOQ1RJ
T05fXywgY2gpOwo+IEBAIC0xMzExLDE2ICsxMzA0LDIyIEBAIFNwaWNlVXNiQmFja2VuZENoYW5u
ZWwgKnNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfbmV3KFNwaWNlVXNiQmFja2VuZCAqYmUsCj4g
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2JyZWRpcnBhcnNlcl93
YXJuaW5nLAo+ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzYnJlZGlyaG9z
dF9mbF93cml0ZV9jYl9vd25zX2J1ZmZlcik7Cj4gICAgICAgICAgZ193YXJuX2lmX2ZhaWwoY2gt
PnVzYnJlZGlyaG9zdCAhPSBOVUxMKTsKPiArICAgICAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCAh
PSBOVUxMKSB7Cj4gKyAgICAgICAgICAgIHVzYnJlZGlyaG9zdF9zZXRfYnVmZmVyZWRfb3V0cHV0
X3NpemVfY2IoY2gtPnVzYnJlZGlyaG9zdCwKPiArICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICB1c2JyZWRpcl9idWZmZXJlZF9vdXRwdXRfc2l6ZV9j
YWxsYmFjayk7Cj4gKyAgICAgICAgICAgIC8vIGZvcmNlIGZsdXNoIG9mIEhFTExPIHBhY2tldCBh
bmQgY3JlYXRpb24gb2YgcGFyc2VyCj4gKyAgICAgICAgICAgIHVzYnJlZGlyaG9zdF93cml0ZV9n
dWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3QpOwo+ICsgICAgICAgIH0KPiArICAgIH0gZWxzZSB7
Cj4gKyAgICAgICAgLy8gbm8gcGh5c2ljYWwgZGV2aWNlIHN1cHBvcnQsIG9ubHkgZW11bGF0ZWQs
IGNyZWF0ZSB0aGUKPiArICAgICAgICAvLyBwYXJzZXIKPiArICAgICAgICBjaC0+cGFyc2VyID0g
Y3JlYXRlX3BhcnNlcihjaCk7Cj4gKyAgICAgICAgaWYgKGNoLT5wYXJzZXIgIT0gTlVMTCkgewo+
ICsgICAgICAgICAgICBpbml0aWFsaXplX3BhcnNlcihjaCk7Cj4gKyAgICAgICAgfQo+ICAgICAg
fQo+Cj4gLSAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgewo+IC0gICAgICAgIGNoLT5oaWRkZW5f
cGFyc2VyID0gY3JlYXRlX3BhcnNlcihjaCk7Cj4gLSAgICAgICAgY2gtPmhpZGRlbl9ob3N0ID0g
Y2gtPnVzYnJlZGlyaG9zdDsKPiAtICAgICAgICB1c2JyZWRpcmhvc3Rfc2V0X2J1ZmZlcmVkX291
dHB1dF9zaXplX2NiKGNoLT51c2JyZWRpcmhvc3QsCj4gLSAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICB1c2JyZWRpcl9idWZmZXJlZF9vdXRwdXRfc2l6ZV9j
YWxsYmFjayk7Cj4gLSAgICB9Cj4gLQo+IC0gICAgaWYgKCFjaC0+aGlkZGVuX3BhcnNlcikgewo+
ICsgICAgaWYgKCFjaC0+cGFyc2VyKSB7Cj4gICAgICAgICAgc3BpY2VfdXNiX2JhY2tlbmRfY2hh
bm5lbF9kZWxldGUoY2gpOwo+ICAgICAgICAgIGNoID0gTlVMTDsKPiAgICAgIH0KPiBAQCAtMTMz
MiwxMiArMTMzMSw5IEBAIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKnNwaWNlX3VzYl9iYWNrZW5k
X2NoYW5uZWxfbmV3KFNwaWNlVXNiQmFja2VuZCAqYmUsCj4gIHZvaWQgc3BpY2VfdXNiX2JhY2tl
bmRfY2hhbm5lbF9mbHVzaF93cml0ZXMoU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gpCj4gIHsK
PiAgICAgIFNQSUNFX0RFQlVHKCIlcyAlcCBpcyB1cCIsIF9fRlVOQ1RJT05fXywgY2gpOwo+IC0g
ICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKPiArICAgIGlmIChjaC0+c3RhdGUgIT0gVVNCX0NI
QU5ORUxfU1RBVEVfUEFSU0VSICYmIGNoLT51c2JyZWRpcmhvc3QgIT0gTlVMTCkgewo+ICAgICAg
ICAgIHVzYnJlZGlyaG9zdF93cml0ZV9ndWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3QpOwo+IC0g
ICAgICAgIGluaXRpYWxpemVfcGFyc2VyKGNoLCBGQUxTRSk7Cj4gICAgICB9IGVsc2Ugewo+IC0g
ICAgICAgIGluaXRpYWxpemVfcGFyc2VyKGNoLCBUUlVFKTsKPiAtICAgICAgICBjaC0+cGFyc2Vy
ID0gY2gtPmhpZGRlbl9wYXJzZXI7Cj4gICAgICAgICAgdXNicmVkaXJwYXJzZXJfZG9fd3JpdGUo
Y2gtPnBhcnNlcik7Cj4gICAgICB9Cj4gIH0KPiBAQCAtMTM0OCwxMSArMTM0NCwxMSBAQCB2b2lk
IHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfZGVsZXRlKFNwaWNlVXNiQmFja2VuZENoYW5uZWwg
KmNoKQo+ICAgICAgaWYgKCFjaCkgewo+ICAgICAgICAgIHJldHVybjsKPiAgICAgIH0KPiAtICAg
IGlmIChjaC0+aGlkZGVuX2hvc3QpIHsKPiAtICAgICAgICB1c2JyZWRpcmhvc3RfY2xvc2UoY2gt
PmhpZGRlbl9ob3N0KTsKPiArICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7Cj4gKyAgICAgICAg
dXNicmVkaXJob3N0X2Nsb3NlKGNoLT51c2JyZWRpcmhvc3QpOwo+ICAgICAgfQo+IC0gICAgaWYg
KGNoLT5oaWRkZW5fcGFyc2VyKSB7Cj4gLSAgICAgICAgdXNicmVkaXJwYXJzZXJfZGVzdHJveShj
aC0+aGlkZGVuX3BhcnNlcik7Cj4gKyAgICBpZiAoY2gtPnBhcnNlcikgewo+ICsgICAgICAgIHVz
YnJlZGlycGFyc2VyX2Rlc3Ryb3koY2gtPnBhcnNlcik7Cj4gICAgICB9Cj4KPiAgICAgIGlmIChj
aC0+cnVsZXMpIHsKPiBAQCAtMTM3Miw3ICsxMzY4LDcgQEAgc3BpY2VfdXNiX2JhY2tlbmRfY2hh
bm5lbF9nZXRfZ3Vlc3RfZmlsdGVyKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLAo+ICAgICAg
aW50IGk7Cj4gICAgICAqciA9IE5VTEw7Cj4gICAgICAqY291bnQgPSAwOwo+IC0gICAgaWYgKGNo
LT51c2JyZWRpcmhvc3QpIHsKPiArICAgIGlmIChjaC0+dXNicmVkaXJob3N0ICE9IE5VTEwpIHsK
PiAgICAgICAgICB1c2JyZWRpcmhvc3RfZ2V0X2d1ZXN0X2ZpbHRlcihjaC0+dXNicmVkaXJob3N0
LCByLCBjb3VudCk7Cj4gICAgICB9Cj4gICAgICBpZiAoKnIgPT0gTlVMTCkgewoKCi0tCkNoZWVy
cywKQ2hyaXN0b3BoZSBkZSBEaW5lY2hpbiAoSVJDIGMzZCkKX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX18KU3BpY2UtZGV2ZWwgbWFpbGluZyBsaXN0ClNwaWNl
LWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9y
Zy9tYWlsbWFuL2xpc3RpbmZvL3NwaWNlLWRldmVs
