Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 306A587CA1
	for <lists+spice-devel@lfdr.de>; Fri,  9 Aug 2019 16:27:23 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 899B26EE1E;
	Fri,  9 Aug 2019 14:27:21 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 587136EE1E
 for <spice-devel@lists.freedesktop.org>; Fri,  9 Aug 2019 14:27:20 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx07.intmail.prod.int.phx2.redhat.com
 [10.5.11.22])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id F41C43002889
 for <spice-devel@lists.freedesktop.org>; Fri,  9 Aug 2019 14:27:19 +0000 (UTC)
Received: from fziglio.remote.csb (ovpn-204-160.brq.redhat.com [10.40.204.160])
 by smtp.corp.redhat.com (Postfix) with ESMTP id CEA3D1001284;
 Fri,  9 Aug 2019 14:27:15 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Fri,  9 Aug 2019 15:26:25 +0100
Message-Id: <20190809142651.2967-8-fziglio@redhat.com>
In-Reply-To: <20190809142651.2967-1-fziglio@redhat.com>
References: <20190809142651.2967-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.84 on 10.5.11.22
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.43]); Fri, 09 Aug 2019 14:27:20 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-gtk v2 07/33] fixup! usb-redir: extend
 USB backend to support emulated devices
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

LS0tCiBzcmMvdXNiLWJhY2tlbmQuYyB8IDc5ICsrKysrKysrKysrKysrKysrKysrKy0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgMzYgaW5zZXJ0aW9ucygrKSwgNDMg
ZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvc3JjL3VzYi1iYWNrZW5kLmMgYi9zcmMvdXNiLWJh
Y2tlbmQuYwppbmRleCBiZWQ0MzFjMy4uOWFlZTZjN2QgMTAwNjQ0Ci0tLSBhL3NyYy91c2ItYmFj
a2VuZC5jCisrKyBiL3NyYy91c2ItYmFja2VuZC5jCkBAIC01NzksOCArNTc5LDcgQEAgc3RhdGlj
IGludCBjaGVja19lZGV2X2RldmljZV9maWx0ZXIoU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkZXYs
CiAgICAgaWYgKCFlZGV2KSB7CiAgICAgICAgIHJldHVybiAxOwogICAgIH0KLSAgICBpZiAoIWRl
dmljZV9vcHMoZWRldiktPmdldF9kZXNjcmlwdG9yKAotICAgICAgICAgICAgZWRldiwgTElCVVNC
X0RUX0NPTkZJRywgMCwgKHZvaWQgKiopJmNmZywgJnNpemUpKSB7CisgICAgaWYgKCFkZXZpY2Vf
b3BzKGVkZXYpLT5nZXRfZGVzY3JpcHRvcihlZGV2LCBMSUJVU0JfRFRfQ09ORklHLCAwLCAodm9p
ZCAqKikmY2ZnLCAmc2l6ZSkpIHsKICAgICAgICAgcmV0dXJuIDE7CiAgICAgfQogICAgIHdoaWxl
ICgob2Zmc2V0ICsgMSkgPCBzaXplKSB7CkBAIC01OTgsMjUgKzU5NywyMSBAQCBzdGF0aWMgaW50
IGNoZWNrX2VkZXZfZGV2aWNlX2ZpbHRlcihTcGljZVVzYkJhY2tlbmREZXZpY2UgKmRldiwKICAg
ICAgICAgb2Zmc2V0ICs9IGxlbjsKICAgICB9CiAKLSAgICByZXR1cm4gdXNicmVkaXJmaWx0ZXJf
Y2hlY2soCi0gICAgICAgIHJ1bGVzLCBjb3VudCwKLSAgICAgICAgZGV2LT5kZXZpY2VfaW5mby5j
bGFzcywKLSAgICAgICAgZGV2LT5kZXZpY2VfaW5mby5zdWJjbGFzcywKLSAgICAgICAgZGV2LT5k
ZXZpY2VfaW5mby5wcm90b2NvbCwKLSAgICAgICAgY2xzLCBzdWJjbHMsIHByb3RvLCBpZm51bSwK
LSAgICAgICAgZGV2LT5kZXZpY2VfaW5mby52aWQsCi0gICAgICAgIGRldi0+ZGV2aWNlX2luZm8u
cGlkLAotICAgICAgICBkZXYtPmRldmljZV9pbmZvLmJjZFVTQiwgMCk7CisgICAgcmV0dXJuIHVz
YnJlZGlyZmlsdGVyX2NoZWNrKHJ1bGVzLCBjb3VudCwKKyAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgZGV2LT5kZXZpY2VfaW5mby5jbGFzcywKKyAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgZGV2LT5kZXZpY2VfaW5mby5zdWJjbGFzcywKKyAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgZGV2LT5kZXZpY2VfaW5mby5wcm90b2NvbCwKKyAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgY2xzLCBzdWJjbHMsIHByb3RvLCBpZm51bSwKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgZGV2LT5kZXZpY2VfaW5mby52aWQsCisgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIGRldi0+ZGV2aWNlX2luZm8ucGlkLAorICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICBkZXYtPmRldmljZV9pbmZvLmJjZFVTQiwgMCk7CiB9CiAKLWludCBzcGlj
ZV91c2JfYmFja2VuZF9kZXZpY2VfY2hlY2tfZmlsdGVyKAotICAgIFNwaWNlVXNiQmFja2VuZERl
dmljZSAqZGV2LAotICAgIGNvbnN0IHN0cnVjdCB1c2JyZWRpcmZpbHRlcl9ydWxlICpydWxlcywK
LSAgICBpbnQgY291bnQpCitpbnQgc3BpY2VfdXNiX2JhY2tlbmRfZGV2aWNlX2NoZWNrX2ZpbHRl
cihTcGljZVVzYkJhY2tlbmREZXZpY2UgKmRldiwKKyAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIGNvbnN0IHN0cnVjdCB1c2JyZWRpcmZpbHRlcl9ydWxlICpydWxlcywg
aW50IGNvdW50KQogewogICAgIGlmIChkZXYtPmxpYnVzYl9kZXZpY2UpIHsKLSAgICAgICAgcmV0
dXJuIHVzYnJlZGlyaG9zdF9jaGVja19kZXZpY2VfZmlsdGVyKAotICAgICAgICAgICAgcnVsZXMs
IGNvdW50LCBkZXYtPmxpYnVzYl9kZXZpY2UsIDApOworICAgICAgICByZXR1cm4gdXNicmVkaXJo
b3N0X2NoZWNrX2RldmljZV9maWx0ZXIocnVsZXMsIGNvdW50LCBkZXYtPmxpYnVzYl9kZXZpY2Us
IDApOwogICAgIH0gZWxzZSB7CiAgICAgICAgIHJldHVybiBjaGVja19lZGV2X2RldmljZV9maWx0
ZXIoZGV2LCBydWxlcywgY291bnQpOwogICAgIH0KQEAgLTgyNCw5ICs4MTksOCBAQCBzdGF0aWMg
dm9pZCB1c2JyZWRpcl9jb250cm9sX3BhY2tldCh2b2lkICpwcml2LAogICAgIH0gZWxzZSBpZiAo
cmVxdHlwZSA9PSAoTElCVVNCX1JFUVVFU1RfVFlQRV9TVEFOREFSRCB8IExJQlVTQl9SRUNJUElF
TlRfREVWSUNFKSAmJgogICAgICAgICAgICAgICAgaC0+cmVxdWVzdCA9PSBMSUJVU0JfUkVRVUVT
VF9HRVRfREVTQ1JJUFRPUikgewogICAgICAgICB1aW50MTZfdCBzaXplOwotICAgICAgICBkb25l
ID0gZGV2aWNlX29wcyhlZGV2KS0+Z2V0X2Rlc2NyaXB0b3IoCi0gICAgICAgICAgICBlZGV2LCBo
LT52YWx1ZSA+PiA4LCBoLT52YWx1ZSAmIDB4ZmYsCi0gICAgICAgICAgICAmb3V0X2J1ZmZlciwg
JnNpemUpOworICAgICAgICBkb25lID0gZGV2aWNlX29wcyhlZGV2KS0+Z2V0X2Rlc2NyaXB0b3Io
ZWRldiwgaC0+dmFsdWUgPj4gOCwgaC0+dmFsdWUgJiAweGZmLAorICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJm91dF9idWZmZXIsICZzaXplKTsKICAgICAg
ICAgcmVzcG9uc2UubGVuZ3RoID0gc2l6ZTsKICAgICAgICAgaWYgKGRvbmUpIHsKICAgICAgICAg
ICAgIHJlc3BvbnNlLnN0YXR1cyA9IDA7CkBAIC04MzUsOCArODI5LDcgQEAgc3RhdGljIHZvaWQg
dXNicmVkaXJfY29udHJvbF9wYWNrZXQodm9pZCAqcHJpdiwKICAgICB9CiAKICAgICBpZiAoIWRv
bmUpIHsKLSAgICAgICAgZGV2aWNlX29wcyhlZGV2KS0+Y29udHJvbF9yZXF1ZXN0KAotICAgICAg
ICAgICAgZWRldiwgZGF0YSwgZGF0YV9sZW4sICZyZXNwb25zZSwgJm91dF9idWZmZXIpOworICAg
ICAgICBkZXZpY2Vfb3BzKGVkZXYpLT5jb250cm9sX3JlcXVlc3QoZWRldiwgZGF0YSwgZGF0YV9s
ZW4sICZyZXNwb25zZSwgJm91dF9idWZmZXIpOwogICAgICAgICBkb25lID0gVFJVRTsKICAgICB9
CiAKQEAgLTg0OCwxMCArODQxLDkgQEAgc3RhdGljIHZvaWQgdXNicmVkaXJfY29udHJvbF9wYWNr
ZXQodm9pZCAqcHJpdiwKIAogICAgIFNQSUNFX0RFQlVHKCIlcyByZXNwb25kaW5nIHdpdGggcGF5
bG9hZCBvZiAlMDJYLCBzdGF0dXMgJVgiLAogICAgICAgICAgICAgICAgIF9fRlVOQ1RJT05fXywg
cmVzcG9uc2UubGVuZ3RoLCByZXNwb25zZS5zdGF0dXMpOwotICAgIHVzYnJlZGlycGFyc2VyX3Nl
bmRfY29udHJvbF9wYWNrZXQoCi0gICAgICAgIGNoLT5wYXJzZXIsIGlkLCAmcmVzcG9uc2UsCi0g
ICAgICAgIHJlc3BvbnNlLmxlbmd0aCA/IG91dF9idWZmZXIgOiBOVUxMLAotICAgICAgICByZXNw
b25zZS5sZW5ndGgpOworICAgIHVzYnJlZGlycGFyc2VyX3NlbmRfY29udHJvbF9wYWNrZXQoY2gt
PnBhcnNlciwgaWQsICZyZXNwb25zZSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIHJlc3BvbnNlLmxlbmd0aCA/IG91dF9idWZmZXIgOiBOVUxMLAorICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UubGVuZ3RoKTsKIAogICAgIHVzYnJl
ZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsKICAgICB1c2JyZWRpcnBhcnNlcl9mcmVlX3Bh
Y2tldF9kYXRhKGNoLT5wYXJzZXIsIGRhdGEpOwpAQCAtMTA0MCw4ICsxMDMyLDcgQEAgc3RhdGlj
IHZvaWQgdXNicmVkaXJfaGVsbG8odm9pZCAqcHJpdiwKICAgICBpZiAoIWVkZXYpIHsKICAgICAg
ICAgcmV0dXJuOwogICAgIH0KLSAgICBpZiAoIWRldmljZV9vcHMoZWRldiktPmdldF9kZXNjcmlw
dG9yKAotICAgICAgICAgICAgZWRldiwgTElCVVNCX0RUX0NPTkZJRywgMCwgKHZvaWQgKiopJmNm
ZywgJnNpemUpKSB7CisgICAgaWYgKCFkZXZpY2Vfb3BzKGVkZXYpLT5nZXRfZGVzY3JpcHRvcihl
ZGV2LCBMSUJVU0JfRFRfQ09ORklHLCAwLCAodm9pZCAqKikmY2ZnLCAmc2l6ZSkpIHsKICAgICAg
ICAgcmV0dXJuOwogICAgIH0KICAgICB3aGlsZSAoKG9mZnNldCArIDEpIDwgc2l6ZSkgewpAQCAt
MTMwMywyNyArMTI5NCwyOSBAQCBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpzcGljZV91c2JfYmFj
a2VuZF9jaGFubmVsX25ldyhTcGljZVVzYkJhY2tlbmQgKmJlLAogICAgIGNoLT51c2VyX2RhdGEg
PSBTUElDRV9VU0JSRURJUl9DSEFOTkVMKHVzZXJfZGF0YSk7CiAgICAgaWYgKGJlLT5saWJ1c2Jf
Y29udGV4dCkgewogICAgICAgICBjaC0+YmFja2VuZCA9IGJlOwotICAgICAgICBjaC0+dXNicmVk
aXJob3N0ID0gdXNicmVkaXJob3N0X29wZW5fZnVsbCgKLSAgICAgICAgICAgIGJlLT5saWJ1c2Jf
Y29udGV4dCwKLSAgICAgICAgICAgIE5VTEwsCi0gICAgICAgICAgICB1c2JyZWRpcl9sb2csCi0g
ICAgICAgICAgICB1c2JyZWRpcl9yZWFkX2NhbGxiYWNrLAotICAgICAgICAgICAgdXNicmVkaXJf
d3JpdGVfY2FsbGJhY2ssCi0gICAgICAgICAgICB1c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFj
aywKLSAgICAgICAgICAgIHVzYnJlZGlyX2FsbG9jX2xvY2ssCi0gICAgICAgICAgICB1c2JyZWRp
cl9sb2NrX2xvY2ssCi0gICAgICAgICAgICB1c2JyZWRpcl91bmxvY2tfbG9jaywKLSAgICAgICAg
ICAgIHVzYnJlZGlyX2ZyZWVfbG9jaywKLSAgICAgICAgICAgIGNoLCBQQUNLQUdFX1NUUklORywK
LSAgICAgICAgICAgIHNwaWNlX3V0aWxfZ2V0X2RlYnVnKCkgPyB1c2JyZWRpcnBhcnNlcl9kZWJ1
ZyA6IHVzYnJlZGlycGFyc2VyX3dhcm5pbmcsCi0gICAgICAgICAgICB1c2JyZWRpcmhvc3RfZmxf
d3JpdGVfY2Jfb3duc19idWZmZXIpOworICAgICAgICBjaC0+dXNicmVkaXJob3N0ID0KKyAgICAg
ICAgICAgIHVzYnJlZGlyaG9zdF9vcGVuX2Z1bGwoYmUtPmxpYnVzYl9jb250ZXh0LAorICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBOVUxMLAorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICB1c2JyZWRpcl9sb2csCisgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIHVzYnJlZGlyX3JlYWRfY2FsbGJhY2ssCisgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIHVzYnJlZGlyX3dyaXRlX2NhbGxiYWNrLAorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICB1c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFjaywKKyAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgdXNicmVkaXJfYWxsb2NfbG9jaywKKyAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgdXNicmVkaXJfbG9ja19sb2NrLAorICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICB1c2JyZWRpcl91bmxvY2tfbG9jaywKKyAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgdXNicmVkaXJfZnJlZV9sb2NrLAorICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICBjaCwgUEFDS0FHRV9TVFJJTkcsCisgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIHNwaWNlX3V0aWxfZ2V0X2RlYnVnKCkgPyB1c2JyZWRpcnBh
cnNlcl9kZWJ1ZyA6CisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNi
cmVkaXJwYXJzZXJfd2FybmluZywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
dXNicmVkaXJob3N0X2ZsX3dyaXRlX2NiX293bnNfYnVmZmVyKTsKICAgICAgICAgZ193YXJuX2lm
X2ZhaWwoY2gtPnVzYnJlZGlyaG9zdCAhPSBOVUxMKTsKICAgICB9CiAKICAgICBpZiAoY2gtPnVz
YnJlZGlyaG9zdCkgewogICAgICAgICBjaC0+aGlkZGVuX3BhcnNlciA9IGNyZWF0ZV9wYXJzZXIo
Y2gpOwogICAgICAgICBjaC0+aGlkZGVuX2hvc3QgPSBjaC0+dXNicmVkaXJob3N0OwotICAgICAg
ICB1c2JyZWRpcmhvc3Rfc2V0X2J1ZmZlcmVkX291dHB1dF9zaXplX2NiKGNoLT51c2JyZWRpcmhv
c3QsIHVzYnJlZGlyX2J1ZmZlcmVkX291dHB1dF9zaXplX2NhbGxiYWNrKTsKKyAgICAgICAgdXNi
cmVkaXJob3N0X3NldF9idWZmZXJlZF9vdXRwdXRfc2l6ZV9jYihjaC0+dXNicmVkaXJob3N0LAor
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzYnJlZGly
X2J1ZmZlcmVkX291dHB1dF9zaXplX2NhbGxiYWNrKTsKICAgICB9CiAKICAgICBpZiAoIWNoLT5o
aWRkZW5fcGFyc2VyKSB7Ci0tIAoyLjIwLjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fClNwaWNlLWRldmVsIG1haWxpbmcgbGlzdApTcGljZS1kZXZlbEBs
aXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1h
bi9saXN0aW5mby9zcGljZS1kZXZlbA==
