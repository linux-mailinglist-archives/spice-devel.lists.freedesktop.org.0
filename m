Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id C938E55417
	for <lists+spice-devel@lfdr.de>; Tue, 25 Jun 2019 18:11:57 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 449F86E161;
	Tue, 25 Jun 2019 16:11:56 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 56BBD6E161
 for <spice-devel@lists.freedesktop.org>; Tue, 25 Jun 2019 16:11:55 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx05.intmail.prod.int.phx2.redhat.com
 [10.5.11.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id F0C8E8762E;
 Tue, 25 Jun 2019 16:11:54 +0000 (UTC)
Received: from fziglio.remote.csb (unknown [10.33.32.4])
 by smtp.corp.redhat.com (Postfix) with ESMTP id F3EA35D70D;
 Tue, 25 Jun 2019 16:11:53 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Tue, 25 Jun 2019 17:11:27 +0100
Message-Id: <20190625161147.25211-4-fziglio@redhat.com>
In-Reply-To: <20190625161147.25211-1-fziglio@redhat.com>
References: <20190625161147.25211-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.15
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.26]); Tue, 25 Jun 2019 16:11:55 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-server 03/23] Add support for clients
 connecting with the WebSocket protocol.
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

RnJvbTogSmVyZW15IFdoaXRlIDxqd2hpdGVAY29kZXdlYXZlcnMuY29tPgoKV2UgZG8gdGhpcyBi
eSBhdXRvIGRldGVjdGluZyB0aGUgaW5ib3VuZCBodHRwKHMpICdHRVQnIGFuZCBwcm9iaW5nCmZv
ciBhIHdlbGwgZm9ybXVsYXRlZCBXZWJTb2NrZXQgYmluYXJ5IGNvbm5lY3Rpb24sIHN1Y2ggYXMg
dXNlZApieSB0aGUgc3BpY2UtaHRtbDUgY2xpZW50LiAgSWYgZGV0ZWN0ZWQsIHdlIGltcGxlbWVu
dCBhIHNldCBvZgpjb3ZlciBmdW5jdGlvbnMgdGhhdCBhYnN0cmFjdCB0aGUgcmVhZC93cml0ZS93
cml0ZXYgZnVuY3Rpb25zLAppbiBhIGZhc2hpb24gc2ltaWxhciB0byB0aGUgU0FTTCBpbXBsZW1l
bnRhdGlvbi4KClRoaXMgaW5jbHVkZXMgYSBsaW1pdGVkIGltcGxlbWVudGF0aW9uIG9mIHRoZSBX
ZWJTb2NrZXQgcHJvdG9jb2wsCnN1ZmZpY2llbnQgZm9yIG91ciBwdXJwb3Nlcy4KClNpZ25lZC1v
ZmYtYnk6IEplcmVteSBXaGl0ZSA8andoaXRlQGNvZGV3ZWF2ZXJzLmNvbT4KLS0tCiBzZXJ2ZXIv
TWFrZWZpbGUuYW0gIHwgICAyICsKIHNlcnZlci9tZXNvbi5idWlsZCAgfCAgIDIgKwogc2VydmVy
L3JlZC1zdHJlYW0uYyB8IDExOCArKysrKysrKysrKysKIHNlcnZlci9yZWQtc3RyZWFtLmggfCAg
IDIgKwogc2VydmVyL3JlZHMuYyAgICAgICB8ICAxMyArKwogc2VydmVyL3dlYnNvY2tldC5jICB8
IDQ1NyArKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKwogc2VydmVy
L3dlYnNvY2tldC5oICB8ICA0NCArKysrKwogNyBmaWxlcyBjaGFuZ2VkLCA2MzggaW5zZXJ0aW9u
cygrKQogY3JlYXRlIG1vZGUgMTAwNjQ0IHNlcnZlci93ZWJzb2NrZXQuYwogY3JlYXRlIG1vZGUg
MTAwNjQ0IHNlcnZlci93ZWJzb2NrZXQuaAoKZGlmZiAtLWdpdCBhL3NlcnZlci9NYWtlZmlsZS5h
bSBiL3NlcnZlci9NYWtlZmlsZS5hbQppbmRleCAyMGFkZjY1ZjAuLjcxYzdlMTczMiAxMDA2NDQK
LS0tIGEvc2VydmVyL01ha2VmaWxlLmFtCisrKyBiL3NlcnZlci9NYWtlZmlsZS5hbQpAQCAtMTc3
LDYgKzE3Nyw4IEBAIGxpYnNlcnZlcl9sYV9TT1VSQ0VTID0JCQkJXAogCXZpZGVvLWVuY29kZXIu
aAkJCQlcCiAJdmlkZW8tc3RyZWFtLmMJCQkJXAogCXZpZGVvLXN0cmVhbS5oCQkJCVwKKwl3ZWJz
b2NrZXQuYwkJCQlcCisJd2Vic29ja2V0LmgJCQkJXAogCXpsaWItZW5jb2Rlci5jCQkJCVwKIAl6
bGliLWVuY29kZXIuaAkJCQlcCiAJJChOVUxMKQpkaWZmIC0tZ2l0IGEvc2VydmVyL21lc29uLmJ1
aWxkIGIvc2VydmVyL21lc29uLmJ1aWxkCmluZGV4IGE3Njc2ZjdlMy4uMzk1ODExYzgwIDEwMDY0
NAotLS0gYS9zZXJ2ZXIvbWVzb24uYnVpbGQKKysrIGIvc2VydmVyL21lc29uLmJ1aWxkCkBAIC0x
NDQsNiArMTQ0LDggQEAgc3BpY2Vfc2VydmVyX3NvdXJjZXMgPSBbCiAgICd2aWRlby1lbmNvZGVy
LmgnLAogICAndmlkZW8tc3RyZWFtLmMnLAogICAndmlkZW8tc3RyZWFtLmgnLAorICAnd2Vic29j
a2V0LmMnLAorICAnd2Vic29ja2V0LmgnLAogICAnemxpYi1lbmNvZGVyLmMnLAogICAnemxpYi1l
bmNvZGVyLmgnLAogXQpkaWZmIC0tZ2l0IGEvc2VydmVyL3JlZC1zdHJlYW0uYyBiL3NlcnZlci9y
ZWQtc3RyZWFtLmMKaW5kZXggNzdmZWQwOTdlLi40Yjg5OTI0MTEgMTAwNjQ0Ci0tLSBhL3NlcnZl
ci9yZWQtc3RyZWFtLmMKKysrIGIvc2VydmVyL3JlZC1zdHJlYW0uYwpAQCAtMzksNiArMzksNyBA
QAogI2luY2x1ZGUgInJlZC1jb21tb24uaCIKICNpbmNsdWRlICJyZWQtc3RyZWFtLmgiCiAjaW5j
bHVkZSAicmVkcy5oIgorI2luY2x1ZGUgIndlYnNvY2tldC5oIgogCiAvLyBjb21wYXRpYmlsaXR5
IGZvciAqQlNEIHN5c3RlbXMKICNpZiAhZGVmaW5lZChUQ1BfQ09SSykgJiYgIWRlZmluZWQoX1dJ
TjMyKQpAQCAtNzcsNiArNzgsMTcgQEAgdHlwZWRlZiBzdHJ1Y3QgUmVkU0FTTCB7CiB9IFJlZFNB
U0w7CiAjZW5kaWYKIAordHlwZWRlZiBzdHJ1Y3QgeworICAgIGludCBjbG9zZWQ7CisKKyAgICB3
ZWJzb2NrZXRfZnJhbWVfdCByZWFkX2ZyYW1lOworICAgIHVpbnQ2NF90IHdyaXRlX3JlbWFpbmRl
cjsKKworICAgIHNzaXplX3QgKCpyYXdfcmVhZCkoUmVkU3RyZWFtICpzLCB2b2lkICpidWYsIHNp
emVfdCBuYnl0ZSk7CisgICAgc3NpemVfdCAoKnJhd193cml0ZSkoUmVkU3RyZWFtICpzLCBjb25z
dCB2b2lkICpidWYsIHNpemVfdCBuYnl0ZSk7CisgICAgc3NpemVfdCAoKnJhd193cml0ZXYpKFJl
ZFN0cmVhbSAqcywgY29uc3Qgc3RydWN0IGlvdmVjICppb3YsIGludCBpb3ZjbnQpOworfSBSZWRz
V2ViU29ja2V0OworCiBzdHJ1Y3QgUmVkU3RyZWFtUHJpdmF0ZSB7CiAgICAgU1NMICpzc2w7CiAK
QEAgLTg2LDYgKzk4LDggQEAgc3RydWN0IFJlZFN0cmVhbVByaXZhdGUgewogCiAgICAgQXN5bmNS
ZWFkIGFzeW5jX3JlYWQ7CiAKKyAgICBSZWRzV2ViU29ja2V0ICp3czsKKwogICAgIC8qIGxpZmUg
dGltZSBvZiBpbmZvOgogICAgICAqIGFsbG9jYXRlZCB3aGVuIGNyZWF0aW5nIFJlZFN0cmVhbS4K
ICAgICAgKiBkZWFsbG9jYXRlZCB3aGVuIG1haW5fZGlzcGF0Y2hlciBoYW5kbGVzIHRoZSBTUElD
RV9DSEFOTkVMX0VWRU5UX0RJU0NPTk5FQ1RFRApAQCAtNDMzLDYgKzQ0Nyw4IEBAIHZvaWQgcmVk
X3N0cmVhbV9mcmVlKFJlZFN0cmVhbSAqcykKICAgICAgICAgU1NMX2ZyZWUocy0+cHJpdi0+c3Ns
KTsKICAgICB9CiAKKyAgICBnX2ZyZWUocy0+cHJpdi0+d3MpOworCiAgICAgcmVkX3N0cmVhbV9y
ZW1vdmVfd2F0Y2gocyk7CiAgICAgc29ja2V0X2Nsb3NlKHMtPnNvY2tldCk7CiAKQEAgLTExNTUs
MyArMTE3MSwxMDUgQEAgZXJyb3I6CiAgICAgcmV0dXJuIGZhbHNlOwogfQogI2VuZGlmCisKK3N0
YXRpYyBzc2l6ZV90IHN0cmVhbV93ZWJzb2NrZXRfcmVhZChSZWRTdHJlYW0gKnMsIHZvaWQgKmJ1
Ziwgc2l6ZV90IHNpemUpCit7CisgICAgaW50IHJjOworCisgICAgaWYgKHMtPnByaXYtPndzLT5j
bG9zZWQpCisgICAgICAgIHJldHVybiAwOworCisgICAgcmMgPSB3ZWJzb2NrZXRfcmVhZCgodm9p
ZCAqKXMsIGJ1Ziwgc2l6ZSwgJnMtPnByaXYtPndzLT5yZWFkX2ZyYW1lLAorICAgICAgICAod2Vi
c29ja2V0X3JlYWRfY2JfdCkgcy0+cHJpdi0+d3MtPnJhd19yZWFkLAorICAgICAgICAod2Vic29j
a2V0X3dyaXRlX2NiX3QpIHMtPnByaXYtPndzLT5yYXdfd3JpdGUpOworCisgICAgaWYgKHJjID09
IDApCisgICAgICAgIHMtPnByaXYtPndzLT5jbG9zZWQgPSAxOworCisgICAgcmV0dXJuIHJjOwor
fQorCitzdGF0aWMgc3NpemVfdCBzdHJlYW1fd2Vic29ja2V0X3dyaXRlKFJlZFN0cmVhbSAqcywg
Y29uc3Qgdm9pZCAqYnVmLCBzaXplX3Qgc2l6ZSkKK3sKKyAgICBpZiAocy0+cHJpdi0+d3MtPmNs
b3NlZCkgeworICAgICAgICBlcnJubyA9IEVQSVBFOworICAgICAgICByZXR1cm4gLTE7CisgICAg
fQorICAgIHJldHVybiB3ZWJzb2NrZXRfd3JpdGUoKHZvaWQgKilzLCBidWYsIHNpemUsICZzLT5w
cml2LT53cy0+d3JpdGVfcmVtYWluZGVyLAorICAgICAgICAod2Vic29ja2V0X3dyaXRlX2NiX3Qp
IHMtPnByaXYtPndzLT5yYXdfd3JpdGUpOworfQorCitzdGF0aWMgc3NpemVfdCBzdHJlYW1fd2Vi
c29ja2V0X3dyaXRldihSZWRTdHJlYW0gKnMsIGNvbnN0IHN0cnVjdCBpb3ZlYyAqaW92LCBpbnQg
aW92Y250KQoreworICAgIGlmIChzLT5wcml2LT53cy0+Y2xvc2VkKSB7CisgICAgICAgIGVycm5v
ID0gRVBJUEU7CisgICAgICAgIHJldHVybiAtMTsKKyAgICB9CisgICAgcmV0dXJuIHdlYnNvY2tl
dF93cml0ZXYoKHZvaWQgKilzLCAoc3RydWN0IGlvdmVjICopIGlvdiwgaW92Y250LCAmcy0+cHJp
di0+d3MtPndyaXRlX3JlbWFpbmRlciwKKyAgICAgICAgKHdlYnNvY2tldF93cml0ZXZfY2JfdCkg
cy0+cHJpdi0+d3MtPnJhd193cml0ZXYpOworfQorCisvKgorICAgIElmIHdlIGRldGVjdCB0aGF0
IGEgbmV3bHkgb3BlbmVkIHN0cmVhbSBhcHBlYXJzIHRvIGJlIHVzaW5nCisgICAgdGhlIFdlYlNv
Y2tldCBwcm90b2NvbCwgd2Ugd2lsbCBwdXQgaW4gcGxhY2UgY292ZXIgZnVuY3Rpb25zCisgICAg
dGhhdCB3aWxsIHNwZWFrIFdlYlNvY2tldCB0byB0aGUgY2xpZW50LCBidXQgYWxsb3cgdGhlIHNl
cnZlcgorICAgIHRvIGNvbnRpbnVlIHRvIHVzZSBub3JtYWwgc3RyZWFtIHJlYWQvd3JpdGUvd3Jp
dGV2IHNlbWFudGljcy4KKyovCitib29sIHJlZF9zdHJlYW1faXNfd2Vic29ja2V0KFJlZFN0cmVh
bSAqc3RyZWFtLCBjb25zdCB2b2lkICpidWYsIHNpemVfdCBsZW4pCit7CisgICAgY2hhciByYnVm
WzQwOTZdOworICAgIGludCByYzsKKworICAgIGlmIChzdHJlYW0tPnByaXYtPndzKSB7CisgICAg
ICAgIHJldHVybiBmYWxzZTsKKyAgICB9CisKKyAgICBtZW1jcHkocmJ1ZiwgYnVmLCBsZW4pOwor
ICAgIHJjID0gc3RyZWFtLT5wcml2LT5yZWFkKHN0cmVhbSwgcmJ1ZiArIGxlbiwgc2l6ZW9mKHJi
dWYpIC0gbGVuIC0gMSk7CisgICAgaWYgKHJjIDw9IDApIHsKKyAgICAgICAgcmV0dXJuIGZhbHNl
OworICAgIH0KKyAgICBsZW4gKz0gcmM7CisgICAgcmJ1ZltsZW5dID0gMDsKKworICAgIC8qIFRP
RE86ICB0aGlzIGhhcyBhIHRoZW9yZXRpY2FsIGZsYXcgYXJvdW5kIHBhY2tldCBidWZmZXJpbmcK
KyAgICAgICAgICAgICAgdGhhdCBpcyBub3QgbGlrZWx5IHRvIG9jY3VyIGluIHByYWN0aWNlLiAg
VGhhdCBpcywKKyAgICAgICAgICAgICAgdG8gYmUgZnVsbHkgY29ycmVjdCwgd2Ugc2hvdWxkIHJl
cGVhdGVkbHkgcmVhZCBieXRlcyB1bnRpbAorICAgICAgICAgICAgICBlaXRoZXIgd2UgZ2V0IHRo
ZSBlbmQgb2YgdGhlIEdFVCBoZWFkZXIgKFxyXG5cclxuKSwgb3IgdW50aWwKKyAgICAgICAgICAg
ICAgYW4gYW1vdW50IG9mIHRpbWUgaGFzIHBhc3NlZC4gIEluc3RlYWQsIHdlIGp1c3QgcmVhZCBm
b3IKKyAgICAgICAgICAgICAgMTYgYnl0ZXMsIGFuZCB0aGVuIHJlYWQgdXAgdG8gdGhlIHNpemVv
ZiByYnVmLiAgU28gaWYgdGhlCisgICAgICAgICAgICAgIEdFVCByZXF1ZXN0IGlzIG9ubHkgcGFy
dGlhbGx5IGNvbXBsZXRlIGF0IHRoaXMgcG9pbnQgd2UKKyAgICAgICAgICAgICAgd2lsbCBmYWls
LgorCisgICAgICAgICAgICAgIEEgdHlwaWNhbCBHRVQgcmVxdWVzdCBpcyA1MjAgYnl0ZXMsIGFu
ZCBpdCdzIGRpZmZpY3VsdCB0bworICAgICAgICAgICAgICBpbWFnaW5lIGEgcmVhbCB3b3JsZCBj
YXNlIHdoZXJlIHRoYXQgd2lsbCBjb21lIGluIGZyYWdtZW50ZWQKKyAgICAgICAgICAgICAgc3Vj
aCB0aGF0IHdlIHRyaWdnZXIgdGhpcyBmYWlsdXJlLiAgRnVydGhlciwgdGhlIHNwaWNlIHJlZHMK
KyAgICAgICAgICAgICAgY29kZSBoYXMgbm8gcmVhbCBtZWNoYW5pc20gdG8gZG8gdmFyaWFibGUg
bGVuZ3RoL3RpbWUgYmFzZWQgcmVhZHMsCisgICAgICAgICAgICAgIHNvIGl0IHNlZW1zIHdpc2Vz
dCB0byBsaXZlIHdpdGggdGhpcyB0aGVvcmV0aWNhbCBmbGF3LgorICAgICovCisKKyAgICBpZiAo
d2Vic29ja2V0X2lzX3N0YXJ0KHJidWYpKSB7CisgICAgICAgIGNoYXIgb3V0YnVmWzEwMjRdOwor
CisgICAgICAgIHdlYnNvY2tldF9jcmVhdGVfcmVwbHkocmJ1Ziwgb3V0YnVmKTsKKyAgICAgICAg
cmMgPSBzdHJlYW0tPnByaXYtPndyaXRlKHN0cmVhbSwgb3V0YnVmLCBzdHJsZW4ob3V0YnVmKSk7
CisgICAgICAgIGlmIChyYyA9PSBzdHJsZW4ob3V0YnVmKSkgeworICAgICAgICAgICAgc3RyZWFt
LT5wcml2LT53cyA9IGdfbWFsbG9jMChzaXplb2YoKnN0cmVhbS0+cHJpdi0+d3MpKTsKKworICAg
ICAgICAgICAgc3RyZWFtLT5wcml2LT53cy0+cmF3X3JlYWQgPSBzdHJlYW0tPnByaXYtPnJlYWQ7
CisgICAgICAgICAgICBzdHJlYW0tPnByaXYtPndzLT5yYXdfd3JpdGUgPSBzdHJlYW0tPnByaXYt
PndyaXRlOworCisgICAgICAgICAgICBzdHJlYW0tPnByaXYtPnJlYWQgPSBzdHJlYW1fd2Vic29j
a2V0X3JlYWQ7CisgICAgICAgICAgICBzdHJlYW0tPnByaXYtPndyaXRlID0gc3RyZWFtX3dlYnNv
Y2tldF93cml0ZTsKKworICAgICAgICAgICAgaWYgKHN0cmVhbS0+cHJpdi0+d3JpdGV2KSB7Cisg
ICAgICAgICAgICAgICAgc3RyZWFtLT5wcml2LT53cy0+cmF3X3dyaXRldiA9IHN0cmVhbS0+cHJp
di0+d3JpdGV2OworICAgICAgICAgICAgICAgIHN0cmVhbS0+cHJpdi0+d3JpdGV2ID0gc3RyZWFt
X3dlYnNvY2tldF93cml0ZXY7CisgICAgICAgICAgICB9CisKKyAgICAgICAgICAgIHJldHVybiB0
cnVlOworICAgICAgICB9CisgICAgfQorCisgICAgcmV0dXJuIGZhbHNlOworfQpkaWZmIC0tZ2l0
IGEvc2VydmVyL3JlZC1zdHJlYW0uaCBiL3NlcnZlci9yZWQtc3RyZWFtLmgKaW5kZXggY2E2ZGM3
MWE5Li5hMTkxZGQ0MmIgMTAwNjQ0Ci0tLSBhL3NlcnZlci9yZWQtc3RyZWFtLmgKKysrIGIvc2Vy
dmVyL3JlZC1zdHJlYW0uaApAQCAtOTEsNiArOTEsOCBAQCBib29sIHJlZF9zdHJlYW1fc2V0X2F1
dG9fZmx1c2goUmVkU3RyZWFtICpzdHJlYW0sIGJvb2wgYXV0b19mbHVzaCk7CiAgKi8KIHZvaWQg
cmVkX3N0cmVhbV9mbHVzaChSZWRTdHJlYW0gKnN0cmVhbSk7CiAKK2Jvb2wgcmVkX3N0cmVhbV9p
c193ZWJzb2NrZXQoUmVkU3RyZWFtICpzdHJlYW0sIGNvbnN0IHZvaWQgKmJ1Ziwgc2l6ZV90IGxl
bik7CisKIHR5cGVkZWYgZW51bSB7CiAgICAgUkVEX1NBU0xfRVJST1JfT0ssCiAgICAgUkVEX1NB
U0xfRVJST1JfR0VORVJJQywKZGlmZiAtLWdpdCBhL3NlcnZlci9yZWRzLmMgYi9zZXJ2ZXIvcmVk
cy5jCmluZGV4IGI0MDYxZmJjMy4uNjcxZTBhODZkIDEwMDY0NAotLS0gYS9zZXJ2ZXIvcmVkcy5j
CisrKyBiL3NlcnZlci9yZWRzLmMKQEAgLTI0MTgsNiArMjQxOCw3IEBAIHN0YXRpYyB2b2lkIHJl
ZHNfaGFuZGxlX2xpbmtfZXJyb3Iodm9pZCAqb3BhcXVlLCBpbnQgZXJyKQogICAgIHJlZHNfbGlu
a19mcmVlKGxpbmspOwogfQogCitzdGF0aWMgdm9pZCByZWRzX2hhbmRsZV9uZXdfbGluayhSZWRM
aW5rSW5mbyAqbGluayk7CiBzdGF0aWMgdm9pZCByZWRzX2hhbmRsZV9yZWFkX2hlYWRlcl9kb25l
KHZvaWQgKm9wYXF1ZSkKIHsKICAgICBSZWRMaW5rSW5mbyAqbGluayA9IChSZWRMaW5rSW5mbyAq
KW9wYXF1ZTsKQEAgLTI0NjAsNiArMjQ2MSwxOCBAQCBzdGF0aWMgdm9pZCByZWRzX2hhbmRsZV9y
ZWFkX21hZ2ljX2RvbmUodm9pZCAqb3BhcXVlKQogICAgIGNvbnN0IFNwaWNlTGlua0hlYWRlciAq
aGVhZGVyID0gJmxpbmstPmxpbmtfaGVhZGVyOwogCiAgICAgaWYgKGhlYWRlci0+bWFnaWMgIT0g
U1BJQ0VfTUFHSUMpIHsKKyAgICAgICAgLyogQXR0ZW1wdCB0byBkZXRlY3QgYW5kIHN1cHBvcnQg
YSBXZWJTb2NrZXQgY29ubmVjdGlvbiwKKyAgICAgICAgICAgd2hpY2ggd2lsbCBiZSBwcm9jZWVk
ZWQgYnkgYSB2YXJpYWJsZSBsZW5ndGggR0VUIHN0eWxlIHJlcXVlc3QuCisgICAgICAgICAgIFdl
IGNhbm5vdCBrbm93IHdlIGFyZSBkZWFsaW5nIHdpdGggYSBXZWJTb2NrZXQgY29ubmVjdGlvbgor
ICAgICAgICAgICB1bnRpbCB3ZSBoYXZlIHJlYWQgYXQgbGVhc3QgMyBieXRlcywgYW5kIHdlIHdp
bGwgaGF2ZSB0bworICAgICAgICAgICByZWFkIG1hbnkgbW9yZSBieXRlcyB0aGFuIGFyZSBjb250
YWluZWQgaW4gYSBTcGljZUxpbmtIZWFkZXIuCisgICAgICAgICAgIFNvIHdlIG1heSBhcyB3ZWxs
IHJlYWQgYSBTcGljZUxpbmtIZWFkZXIncyB3b3J0aCBvZiBkYXRhLCBhbmQgaWYgaXQncworICAg
ICAgICAgICBjbGVhciB0aGF0IGEgV2ViU29ja2V0IGNvbm5lY3Rpb24gd2FzIHJlcXVlc3RlZCwg
d2Ugc3dpdGNoCisgICAgICAgICAgIGJlZm9yZSBwcm9jZWVkaW5nIGZ1cnRoZXIuICovCisgICAg
ICAgIGlmIChyZWRfc3RyZWFtX2lzX3dlYnNvY2tldChsaW5rLT5zdHJlYW0sICZoZWFkZXItPm1h
Z2ljLCBzaXplb2YoaGVhZGVyLT5tYWdpYykpKSB7CisgICAgICAgICAgICByZWRzX2hhbmRsZV9u
ZXdfbGluayhsaW5rKTsKKyAgICAgICAgICAgIHJldHVybjsKKyAgICAgICAgfQogICAgICAgICBy
ZWRzX3NlbmRfbGlua19lcnJvcihsaW5rLCBTUElDRV9MSU5LX0VSUl9JTlZBTElEX01BR0lDKTsK
ICAgICAgICAgcmVkc19saW5rX2ZyZWUobGluayk7CiAgICAgICAgIHJldHVybjsKZGlmZiAtLWdp
dCBhL3NlcnZlci93ZWJzb2NrZXQuYyBiL3NlcnZlci93ZWJzb2NrZXQuYwpuZXcgZmlsZSBtb2Rl
IDEwMDY0NAppbmRleCAwMDAwMDAwMDAuLjU4ZjM2ZGEwYQotLS0gL2Rldi9udWxsCisrKyBiL3Nl
cnZlci93ZWJzb2NrZXQuYwpAQCAtMCwwICsxLDQ1NyBAQAorLyogLSotIE1vZGU6IEM7IGMtYmFz
aWMtb2Zmc2V0OiA0OyBpbmRlbnQtdGFicy1tb2RlOiBuaWwgLSotICovCisvKgorICAgQ29weXJp
Z2h0IChDKSAyMDE1IEplcmVteSBXaGl0ZQorCisgICBUaGlzIGxpYnJhcnkgaXMgZnJlZSBzb2Z0
d2FyZTsgeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yCisgICBtb2RpZnkgaXQgdW5kZXIg
dGhlIHRlcm1zIG9mIHRoZSBHTlUgTGVzc2VyIEdlbmVyYWwgUHVibGljCisgICBMaWNlbnNlIGFz
IHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIKKyAgIHZl
cnNpb24gMi4xIG9mIHRoZSBMaWNlbnNlLCBvciAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2
ZXJzaW9uLgorCisgICBUaGlzIGxpYnJhcnkgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhh
dCBpdCB3aWxsIGJlIHVzZWZ1bCwKKyAgIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91
dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCisgICBNRVJDSEFOVEFCSUxJVFkgb3IgRklU
TkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlIEdOVQorICAgTGVzc2VyIEdl
bmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KKworICAgWW91IHNob3VsZCBo
YXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIExlc3NlciBHZW5lcmFsIFB1YmxpYworICAg
TGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgbGlicmFyeTsgaWYgbm90LCBzZWUgPGh0dHA6Ly93d3cu
Z251Lm9yZy9saWNlbnNlcy8+LgorKi8KKyNkZWZpbmUgX0dOVV9TT1VSQ0UKKyNpbmNsdWRlIDxj
b25maWcuaD4KKyNpbmNsdWRlIDxzdGRpby5oPgorI2luY2x1ZGUgPHN0ZGxpYi5oPgorI2luY2x1
ZGUgPHN0ZGJvb2wuaD4KKyNpbmNsdWRlIDxzdHJpbmcuaD4KKyNpbmNsdWRlIDxjdHlwZS5oPgor
I2luY2x1ZGUgPGVycm5vLmg+CisKKyNpbmNsdWRlIDxzeXMvdHlwZXMuaD4KKyNpZm5kZWYgX1dJ
TjMyCisjaW5jbHVkZSA8c3lzL3NvY2tldC5oPgorI2luY2x1ZGUgPHVuaXN0ZC5oPgorI2VuZGlm
CisKKyNpbmNsdWRlIDxnbGliLmg+CisKKyNpbmNsdWRlIDxjb21tb24vbG9nLmg+CisjaW5jbHVk
ZSA8Y29tbW9uL21lbS5oPgorCisjaW5jbHVkZSAic3lzLXNvY2tldC5oIgorI2luY2x1ZGUgIndl
YnNvY2tldC5oIgorCisjaWZkZWYgX1dJTjMyCisjaW5jbHVkZSA8c2hsd2FwaS5oPgorI2RlZmlu
ZSBzdHJjYXNlc3RyKGhheXN0YWNrLCBuZWVkbGUpIFN0clN0cklBKGhheXN0YWNrLCBuZWVkbGUp
CisjZW5kaWYKKworLyogQ29uc3RhbnRzIC8gbWFza3MgYWxsIGZyb20gUkZDIDY0NTUgKi8KKwor
I2RlZmluZSBGSU5fRkxBRyAgICAgICAgMHg4MAorI2RlZmluZSBUWVBFX01BU0sgICAgICAgMHgw
RgorCisjZGVmaW5lIENPTlRJTlVBVElPTl9GUkFNRSAgMHgwCisjZGVmaW5lIFRFWFRfRlJBTUUg
ICAgICAweDEKKyNkZWZpbmUgQklOQVJZX0ZSQU1FICAgIDB4MgorI2RlZmluZSBDTE9TRV9GUkFN
RSAgICAgMHg4CisjZGVmaW5lIFBJTkdfRlJBTUUgICAgICAweDkKKyNkZWZpbmUgUE9OR19GUkFN
RSAgICAgIDB4QQorCisjZGVmaW5lIExFTkdUSF9NQVNLICAgICAweDdGCisjZGVmaW5lIExFTkdU
SF8xNkJJVCAgICAweDdFCisjZGVmaW5lIExFTkdUSF82NEJJVCAgICAweDdGCisKKyNkZWZpbmUg
TUFTS19GTEFHICAgICAgIDB4ODAKKworI2RlZmluZSBXRUJTT0NLRVRfR1VJRCAiMjU4RUFGQTUt
RTkxNC00N0RBLTk1Q0EtQzVBQjBEQzg1QjExIgorCisvKiBQZXJmb3JtIGEgY2FzZSBpbnNlbnNp
dGl2ZSBzZWFyY2ggZm9yIG5lZWRsZSBpbiBoYXlzdGFjay4KKyAgIElmIGZvdW5kLCByZXR1cm4g
YSBwb2ludGVyIHRvIHRoZSBieXRlIGFmdGVyIHRoZSBlbmQgb2YgbmVlZGxlLgorICAgT3RoZXJ3
aXNlLCByZXR1cm4gTlVMTCAqLworc3RhdGljIGNvbnN0IGNoYXIgKmZpbmRfc3RyKGNvbnN0IGNo
YXIgKmhheXN0YWNrLCBjb25zdCBjaGFyICpuZWVkbGUpCit7CisgICAgY29uc3QgY2hhciAqcyA9
IHN0cmNhc2VzdHIoaGF5c3RhY2ssIG5lZWRsZSk7CisKKyAgICBpZiAocykgeworICAgICAgICBy
ZXR1cm4gcyArIHN0cmxlbihuZWVkbGUpOworICAgIH0KKyAgICByZXR1cm4gTlVMTDsKK30KKwor
LyogRXh0cmFjdCBXZWJTb2NrZXQgc3R5bGUgbGVuZ3RoLiBSZXR1cm5zIDAgaWYgbm90IGVub3Vn
aCBkYXRhIHByZXNlbnQsCisgICBBbHdheXMgdXBkYXRlcyB0aGUgb3V0cHV0ICd1c2VkJyB2YXJp
YWJsZSB0byB0aGUgbnVtYmVyIG9mIGJ5dGVzCisgICByZXF1aXJlZCB0byBleHRyYWN0IHRoZSBs
ZW5ndGg7IHVzZWZ1bCBmb3IgdHJhY2tpbmcgd2hlcmUgdGhlCisgICBtYXNrIHdpbGwgYmUuCisq
Lworc3RhdGljIHVpbnQ2NF90IGV4dHJhY3RfbGVuZ3RoKGNvbnN0IHVpbnQ4X3QgKmJ1ZiwgaW50
ICp1c2VkKQoreworICAgIGludCBpOworICAgIHVpbnQ2NF90IG91dGxlbiA9ICgqYnVmKyspICYg
TEVOR1RIX01BU0s7CisKKyAgICAoKnVzZWQpKys7CisKKyAgICBzd2l0Y2ggKG91dGxlbikgewor
ICAgIGNhc2UgTEVOR1RIXzY0QklUOgorICAgICAgICAqdXNlZCArPSA4OworICAgICAgICBvdXRs
ZW4gPSAwOworICAgICAgICBmb3IgKGkgPSA1NjsgaSA+PSAwOyBpIC09IDgpIHsKKyAgICAgICAg
ICAgIG91dGxlbiB8PSAoKmJ1ZisrKSA8PCBpOworICAgICAgICB9CisgICAgICAgIGJyZWFrOwor
CisgICAgY2FzZSBMRU5HVEhfMTZCSVQ6CisgICAgICAgICp1c2VkICs9IDI7CisgICAgICAgIG91
dGxlbiA9ICgoKmJ1ZikgPDwgOCkgfCAqKGJ1ZiArIDEpOworICAgICAgICBicmVhazsKKworICAg
IGRlZmF1bHQ6CisgICAgICAgIGJyZWFrOworICAgIH0KKyAgICByZXR1cm4gb3V0bGVuOworfQor
CitzdGF0aWMgaW50IGZyYW1lX2J5dGVzX25lZWRlZCh3ZWJzb2NrZXRfZnJhbWVfdCAqZnJhbWUp
Cit7CisgICAgaW50IG5lZWRlZCA9IDI7CisgICAgaWYgKGZyYW1lLT5oZWFkZXJfcG9zIDwgbmVl
ZGVkKSB7CisgICAgICAgIHJldHVybiBuZWVkZWQgLSBmcmFtZS0+aGVhZGVyX3BvczsKKyAgICB9
CisKKyAgICBzd2l0Y2ggKGZyYW1lLT5oZWFkZXJbMV0gJiBMRU5HVEhfTUFTSykgeworICAgIGNh
c2UgTEVOR1RIXzY0QklUOgorICAgICAgICBuZWVkZWQgKz0gODsKKyAgICAgICAgYnJlYWs7Cisg
ICAgY2FzZSBMRU5HVEhfMTZCSVQ6CisgICAgICAgIG5lZWRlZCArPSAyOworICAgICAgICBicmVh
azsKKyAgICB9CisKKyAgICBpZiAoZnJhbWUtPmhlYWRlclsxXSAmIE1BU0tfRkxBRykgeworICAg
ICAgICBuZWVkZWQgKz0gNDsKKyAgICB9CisKKyAgICByZXR1cm4gbmVlZGVkIC0gZnJhbWUtPmhl
YWRlcl9wb3M7Cit9CisKKy8qCisqIEdlbmVyYXRlIFdlYlNvY2tldCBzdHlsZSByZXNwb25zZSBr
ZXksIGJhc2VkIG9uIHRoZQorKiAgb3JpZ2luYWwga2V5IHNlbnQgdG8gdXMKKyogSWYgbm9uIG51
bGwsIGNhbGxlciBtdXN0IGZyZWUgcmV0dXJuZWQga2V5IHN0cmluZy4KKyovCitzdGF0aWMgY2hh
ciAqZ2VuZXJhdGVfcmVwbHlfa2V5KGNoYXIgKmJ1ZikKK3sKKyAgICBHQ2hlY2tzdW0gKmNoZWNr
c3VtOworICAgIGNoYXIgKmI2NCA9IE5VTEw7CisgICAgdWludDhfdCAqc2hhMTsKKyAgICBzaXpl
X3Qgc2hhMV9zaXplOworICAgIGNvbnN0IGNoYXIgKmtleTsKKyAgICBjb25zdCBjaGFyICpwOwor
ICAgIGNoYXIgKms7CisKKyAgICBrZXkgPSBmaW5kX3N0cihidWYsICJcblNlYy1XZWJTb2NrZXQt
S2V5OiIpOworICAgIGlmIChrZXkpIHsKKyAgICAgICAgcCA9IHN0cmNocihrZXksICdccicpOwor
ICAgICAgICBpZiAocCkgeworICAgICAgICAgICAgayA9IGdfc3RybmR1cChrZXksIHAgLSBrZXkp
OworICAgICAgICAgICAgayA9IGdfc3Ryc3RyaXAoayk7CisgICAgICAgICAgICBjaGVja3N1bSA9
IGdfY2hlY2tzdW1fbmV3KEdfQ0hFQ0tTVU1fU0hBMSk7CisgICAgICAgICAgICBnX2NoZWNrc3Vt
X3VwZGF0ZShjaGVja3N1bSwgKHVpbnQ4X3QgKikgaywgc3RybGVuKGspKTsKKyAgICAgICAgICAg
IGdfY2hlY2tzdW1fdXBkYXRlKGNoZWNrc3VtLCAodWludDhfdCAqKSBXRUJTT0NLRVRfR1VJRCwg
c3RybGVuKFdFQlNPQ0tFVF9HVUlEKSk7CisgICAgICAgICAgICBnX2ZyZWUoayk7CisKKyAgICAg
ICAgICAgIHNoYTFfc2l6ZSA9IGdfY2hlY2tzdW1fdHlwZV9nZXRfbGVuZ3RoKEdfQ0hFQ0tTVU1f
U0hBMSk7CisgICAgICAgICAgICBzaGExID0gZ19tYWxsb2Moc2hhMV9zaXplKTsKKworICAgICAg
ICAgICAgZ19jaGVja3N1bV9nZXRfZGlnZXN0KGNoZWNrc3VtLCBzaGExLCAmc2hhMV9zaXplKTsK
KworICAgICAgICAgICAgYjY0ID0gZ19iYXNlNjRfZW5jb2RlKHNoYTEsIHNoYTFfc2l6ZSk7CisK
KyAgICAgICAgICAgIGdfY2hlY2tzdW1fZnJlZShjaGVja3N1bSk7CisgICAgICAgICAgICBnX2Zy
ZWUoc2hhMSk7CisgICAgICAgIH0KKyAgICB9CisKKyAgICByZXR1cm4gYjY0OworfQorCisKK3N0
YXRpYyB2b2lkIHdlYnNvY2tldF9jbGVhcl9mcmFtZSh3ZWJzb2NrZXRfZnJhbWVfdCAqZnJhbWUp
Cit7CisgICAgbWVtc2V0KGZyYW1lLCAwLCBzaXplb2YoKmZyYW1lKSk7Cit9CisKKy8qIEV4dHJh
Y3QgYSBmcmFtZSBoZWFkZXIgb2YgZGF0YSBmcm9tIGEgc2V0IG9mIGRhdGEgdHJhbnNtaXR0ZWQg
YnkKKyAgICBhIFdlYlNvY2tldCBjbGllbnQuICovCitzdGF0aWMgdm9pZCB3ZWJzb2NrZXRfZ2V0
X2ZyYW1lX2hlYWRlcih3ZWJzb2NrZXRfZnJhbWVfdCAqZnJhbWUpCit7CisgICAgaW50IGZpbjsK
KyAgICBpbnQgdXNlZCA9IDA7CisKKyAgICBpZiAoZnJhbWVfYnl0ZXNfbmVlZGVkKGZyYW1lKSA+
IDApIHsKKyAgICAgICAgcmV0dXJuOworICAgIH0KKworICAgIGZpbiA9IGZyYW1lLT5oZWFkZXJb
MF0gJiBGSU5fRkxBRzsKKyAgICBmcmFtZS0+dHlwZSA9IGZyYW1lLT5oZWFkZXJbMF0gJiBUWVBF
X01BU0s7CisgICAgdXNlZCsrOworCisgICAgZnJhbWUtPm1hc2tlZCA9IGZyYW1lLT5oZWFkZXJb
MV0gJiBNQVNLX0ZMQUc7CisKKyAgICAvKiBUaGlzIGlzIGEgU3BpY2Ugc3BlY2lmaWMgb3B0aW1p
emF0aW9uLiAgV2UgZG9uJ3QgcmVhbGx5CisgICAgICAgY2FyZSBhYm91dCBhc3NlbWJsaW5nIGZy
YW1lcyBmdWxseSwgc28gd2UgdHJlYXQKKyAgICAgICBhIGZyYW1lIGluIHByb2Nlc3MgYXMgYSBm
aW5pc2hlZCBmcmFtZSBhbmQgcGFzcyBpdCBhbG9uZy4gKi8KKyAgICBpZiAoIWZpbiAmJiBmcmFt
ZS0+dHlwZSA9PSBDT05USU5VQVRJT05fRlJBTUUpIHsKKyAgICAgICAgZnJhbWUtPnR5cGUgPSBC
SU5BUllfRlJBTUU7CisgICAgfQorCisgICAgZnJhbWUtPmV4cGVjdGVkX2xlbiA9IGV4dHJhY3Rf
bGVuZ3RoKGZyYW1lLT5oZWFkZXIgKyB1c2VkLCAmdXNlZCk7CisKKyAgICBpZiAoZnJhbWUtPm1h
c2tlZCkgeworICAgICAgICBtZW1jcHkoZnJhbWUtPm1hc2ssIGZyYW1lLT5oZWFkZXIgKyB1c2Vk
LCA0KTsKKyAgICB9CisKKyAgICBmcmFtZS0+cmVsYXllZCA9IDA7CisgICAgZnJhbWUtPmZyYW1l
X3JlYWR5ID0gMTsKK30KKworc3RhdGljIGludCByZWxheV9kYXRhKHVpbnQ4X3QqIGJ1Ziwgc2l6
ZV90IHNpemUsIHdlYnNvY2tldF9mcmFtZV90ICpmcmFtZSkKK3sKKyAgICBpbnQgaTsKKyAgICBp
bnQgbiA9IE1JTihzaXplLCBmcmFtZS0+ZXhwZWN0ZWRfbGVuIC0gZnJhbWUtPnJlbGF5ZWQpOwor
CisgICAgaWYgKGZyYW1lLT5tYXNrZWQpIHsKKyAgICAgICAgZm9yIChpID0gMDsgaSA8IG47IGkr
KywgZnJhbWUtPnJlbGF5ZWQrKykgeworICAgICAgICAgICAgKmJ1ZisrIF49IGZyYW1lLT5tYXNr
W2ZyYW1lLT5yZWxheWVkICUgNF07CisgICAgICAgIH0KKyAgICB9CisKKyAgICByZXR1cm4gbjsK
K30KKworaW50IHdlYnNvY2tldF9yZWFkKHZvaWQgKm9wYXF1ZSwgdWludDhfdCAqYnVmLCBpbnQg
c2l6ZSwgd2Vic29ja2V0X2ZyYW1lX3QgKmZyYW1lLAorICAgICAgICAgICAgICAgICAgICB3ZWJz
b2NrZXRfcmVhZF9jYl90IHJlYWRfY2IsCisgICAgICAgICAgICAgICAgICAgIHdlYnNvY2tldF93
cml0ZV9jYl90IHdyaXRlX2NiKQoreworICAgIGludCBuID0gMDsKKyAgICBpbnQgcmM7CisKKyAg
ICB3aGlsZSAoc2l6ZSA+IDApIHsKKyAgICAgICAgLy8gbWFrZSBzdXJlIHdlIGhhdmUgYSBwcm9w
ZXIgZnJhbWUgcmVhZHkKKyAgICAgICAgaWYgKCFmcmFtZS0+ZnJhbWVfcmVhZHkpIHsKKyAgICAg
ICAgICAgIHJjID0gcmVhZF9jYihvcGFxdWUsIGZyYW1lLT5oZWFkZXIgKyBmcmFtZS0+aGVhZGVy
X3BvcywgZnJhbWVfYnl0ZXNfbmVlZGVkKGZyYW1lKSk7CisgICAgICAgICAgICBpZiAocmMgPD0g
MCkgeworICAgICAgICAgICAgICAgIGdvdG8gcmVhZF9lcnJvcjsKKyAgICAgICAgICAgIH0KKyAg
ICAgICAgICAgIGZyYW1lLT5oZWFkZXJfcG9zICs9IHJjOworCisgICAgICAgICAgICB3ZWJzb2Nr
ZXRfZ2V0X2ZyYW1lX2hlYWRlcihmcmFtZSk7CisgICAgICAgIH0gZWxzZSBpZiAoZnJhbWUtPnR5
cGUgPT0gQ0xPU0VfRlJBTUUpIHsKKyAgICAgICAgICAgIHdlYnNvY2tldF9hY2tfY2xvc2Uob3Bh
cXVlLCB3cml0ZV9jYik7CisgICAgICAgICAgICB3ZWJzb2NrZXRfY2xlYXJfZnJhbWUoZnJhbWUp
OworICAgICAgICAgICAgcmV0dXJuIDA7CisgICAgICAgIH0gZWxzZSBpZiAoZnJhbWUtPnR5cGUg
PT0gQklOQVJZX0ZSQU1FKSB7CisgICAgICAgICAgICByYyA9IHJlYWRfY2Iob3BhcXVlLCBidWYs
IE1JTihzaXplLCBmcmFtZS0+ZXhwZWN0ZWRfbGVuIC0gZnJhbWUtPnJlbGF5ZWQpKTsKKyAgICAg
ICAgICAgIGlmIChyYyA8PSAwKSB7CisgICAgICAgICAgICAgICAgZ290byByZWFkX2Vycm9yOwor
ICAgICAgICAgICAgfQorCisgICAgICAgICAgICByYyA9IHJlbGF5X2RhdGEoYnVmLCByYywgZnJh
bWUpOworICAgICAgICAgICAgbiArPSByYzsKKyAgICAgICAgICAgIGJ1ZiArPSByYzsKKyAgICAg
ICAgICAgIHNpemUgLT0gcmM7CisgICAgICAgICAgICBpZiAoZnJhbWUtPnJlbGF5ZWQgPj0gZnJh
bWUtPmV4cGVjdGVkX2xlbikgeworICAgICAgICAgICAgICAgIHdlYnNvY2tldF9jbGVhcl9mcmFt
ZShmcmFtZSk7CisgICAgICAgICAgICB9CisgICAgICAgIH0gZWxzZSB7CisgICAgICAgICAgICAv
KiBUT0RPIC0gV2UgZG9uJ3QgaGFuZGxlIFBJTkcgYXQgdGhpcyBwb2ludCAqLworICAgICAgICAg
ICAgc3BpY2Vfd2FybmluZygiVW5leHBlY3RlZCBXZWJTb2NrZXQgZnJhbWUudHlwZSAlZC4gIEZh
aWx1cmUgbm93IGxpa2VseS4iLCBmcmFtZS0+dHlwZSk7CisgICAgICAgICAgICB3ZWJzb2NrZXRf
Y2xlYXJfZnJhbWUoZnJhbWUpOworICAgICAgICAgICAgY29udGludWU7CisgICAgICAgIH0KKyAg
ICB9CisKKyAgICByZXR1cm4gbjsKKworcmVhZF9lcnJvcjoKKyAgICBpZiAobiA+IDAgJiYgcmMg
PT0gLTEgJiYgKGVycm5vID09IEVJTlRSIHx8IGVycm5vID09IEVBR0FJTikpIHsKKyAgICAgICAg
cmV0dXJuIG47CisgICAgfQorICAgIHJldHVybiByYzsKK30KKworc3RhdGljIGludCBmaWxsX2hl
YWRlcih1aW50OF90ICpoZWFkZXIsIHVpbnQ2NF90IGxlbikKK3sKKyAgICBpbnQgdXNlZCA9IDA7
CisgICAgaW50IGk7CisKKyAgICBoZWFkZXJbMF0gPSBGSU5fRkxBRyB8IEJJTkFSWV9GUkFNRTsK
KyAgICB1c2VkKys7CisKKyAgICBoZWFkZXJbMV0gPSAwOworICAgIHVzZWQrKzsKKyAgICBpZiAo
bGVuID4gNjU1MzUpIHsKKyAgICAgICAgaGVhZGVyWzFdIHw9IExFTkdUSF82NEJJVDsKKyAgICAg
ICAgZm9yIChpID0gOTsgaSA+PSAyOyBpLS0pIHsKKyAgICAgICAgICAgIGhlYWRlcltpXSA9IGxl
biAmIDB4RkY7CisgICAgICAgICAgICBsZW4gPj49IDg7CisgICAgICAgIH0KKyAgICAgICAgdXNl
ZCArPSA4OworICAgIH0gZWxzZSBpZiAobGVuID49IExFTkdUSF8xNkJJVCkgeworICAgICAgICBo
ZWFkZXJbMV0gfD0gTEVOR1RIXzE2QklUOworICAgICAgICBoZWFkZXJbMl0gPSBsZW4gPj4gODsK
KyAgICAgICAgaGVhZGVyWzNdID0gbGVuICYgMHhGRjsKKyAgICAgICAgdXNlZCArPSAyOworICAg
IH0gZWxzZSB7CisgICAgICAgIGhlYWRlclsxXSB8PSBsZW47CisgICAgfQorCisgICAgcmV0dXJu
IHVzZWQ7Cit9CisKK3N0YXRpYyB2b2lkIGNvbnN0cmFpbl9pb3Yoc3RydWN0IGlvdmVjICppb3Ys
IGludCBpb3ZjbnQsCisgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cnVjdCBpb3ZlYyAqKmlv
dl9vdXQsIGludCAqaW92X291dF9jbnQsCisgICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQ2
NF90IG1heGxlbikKK3sKKyAgICBpbnQgaSwgajsKKworICAgICppb3Zfb3V0ID0gaW92OworICAg
ICppb3Zfb3V0X2NudCA9IGlvdmNudDsKKworICAgIGZvciAoaSA9IDA7IGkgPCBpb3ZjbnQgJiYg
bWF4bGVuID4gMDsgaSsrKSB7CisgICAgICAgIGlmIChpb3ZbaV0uaW92X2xlbiA+IG1heGxlbikg
eworICAgICAgICAgICAgLyogVE9ETyAtIFRoaXMgY29kZSBoYXMgbmV2ZXIgdHJpZ2dlcmVkIGFm
YWlrLi4uICovCisgICAgICAgICAgICAqaW92X291dF9jbnQgPSBpICsgMTsKKyAgICAgICAgICAg
ICppb3Zfb3V0ID0gZ19tYWxsb2MoKCppb3Zfb3V0X2NudCkgKiBzaXplb2YgKCoqaW92X291dCkp
OworICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IGk7IGorKykgeworICAgICAgICAgICAgICAg
ICgqaW92X291dClbal0uaW92X2Jhc2UgPSBpb3Zbal0uaW92X2Jhc2U7CisgICAgICAgICAgICAg
ICAgKCppb3Zfb3V0KVtqXS5pb3ZfbGVuID0gaW92W2pdLmlvdl9sZW47CisgICAgICAgICAgICB9
CisgICAgICAgICAgICAoKmlvdl9vdXQpW2pdLmlvdl9iYXNlID0gaW92W2pdLmlvdl9iYXNlOwor
ICAgICAgICAgICAgKCppb3Zfb3V0KVtqXS5pb3ZfbGVuID0gbWF4bGVuOworICAgICAgICAgICAg
YnJlYWs7CisgICAgICAgIH0KKyAgICAgICAgbWF4bGVuIC09IGlvdltpXS5pb3ZfbGVuOworICAg
IH0KK30KKworCisvKiBXcml0ZSBhIFdlYlNvY2tldCBmcmFtZSB3aXRoIHRoZSBlbmNsb3NlZCBk
YXRhIG91dC4gKi8KK2ludCB3ZWJzb2NrZXRfd3JpdGV2KHZvaWQgKm9wYXF1ZSwgc3RydWN0IGlv
dmVjICppb3YsIGludCBpb3ZjbnQsIHVpbnQ2NF90ICpyZW1haW5kZXIsCisgICAgICAgICB3ZWJz
b2NrZXRfd3JpdGV2X2NiX3Qgd3JpdGV2X2NiKQoreworICAgIHVpbnQ4X3QgaGVhZGVyW1dFQlNP
Q0tFVF9NQVhfSEVBREVSX1NJWkVdOworICAgIHVpbnQ2NF90IGxlbjsKKyAgICBpbnQgcmMgPSAt
MTsKKyAgICBzdHJ1Y3QgaW92ZWMgKmlvdl9vdXQ7CisgICAgaW50IGlvdl9vdXRfY250OworICAg
IGludCBpOworICAgIGludCBoZWFkZXJfbGVuOworCisgICAgaWYgKCpyZW1haW5kZXIgPiAwKSB7
CisgICAgICAgIGNvbnN0cmFpbl9pb3YoaW92LCBpb3ZjbnQsICZpb3Zfb3V0LCAmaW92X291dF9j
bnQsICpyZW1haW5kZXIpOworICAgICAgICByYyA9IHdyaXRldl9jYihvcGFxdWUsIGlvdl9vdXQs
IGlvdl9vdXRfY250KTsKKyAgICAgICAgaWYgKGlvdl9vdXQgIT0gaW92KSB7CisgICAgICAgICAg
ICBnX2ZyZWUoaW92X291dCk7CisgICAgICAgIH0KKyAgICAgICAgaWYgKHJjIDw9IDApIHsKKyAg
ICAgICAgICAgIHJldHVybiByYzsKKyAgICAgICAgfQorICAgICAgICAqcmVtYWluZGVyIC09IHJj
OworICAgICAgICByZXR1cm4gcmM7CisgICAgfQorCisgICAgaW92X291dF9jbnQgPSBpb3ZjbnQg
KyAxOworICAgIGlvdl9vdXQgPSBnX21hbGxvYyhpb3Zfb3V0X2NudCAqIHNpemVvZigqaW92X291
dCkpOworCisgICAgZm9yIChpID0gMCwgbGVuID0gMDsgaSA8IGlvdmNudDsgaSsrKSB7CisgICAg
ICAgIGxlbiArPSBpb3ZbaV0uaW92X2xlbjsKKyAgICAgICAgaW92X291dFtpICsgMV0gPSBpb3Zb
aV07CisgICAgfQorCisgICAgbWVtc2V0KGhlYWRlciwgMCwgc2l6ZW9mKGhlYWRlcikpOworICAg
IGhlYWRlcl9sZW4gPSBmaWxsX2hlYWRlcihoZWFkZXIsIGxlbik7CisgICAgaW92X291dFswXS5p
b3ZfbGVuID0gaGVhZGVyX2xlbjsKKyAgICBpb3Zfb3V0WzBdLmlvdl9iYXNlID0gaGVhZGVyOwor
ICAgIHJjID0gd3JpdGV2X2NiKG9wYXF1ZSwgaW92X291dCwgaW92X291dF9jbnQpOworICAgIGdf
ZnJlZShpb3Zfb3V0KTsKKyAgICBpZiAocmMgPD0gMCkgeworICAgICAgICByZXR1cm4gcmM7Cisg
ICAgfQorICAgIHJjIC09IGhlYWRlcl9sZW47CisKKyAgICBzcGljZV9hc3NlcnQocmMgPj0gMCk7
CisKKyAgICAvKiBLZXkgcG9pbnQ6ICBpZiB3ZSBkaWQgbm90IHdyaXRlIG91dCBhbGwgdGhlIGRh
dGEsIHJlbWVtYmVyIGhvdworICAgICAgIG11Y2ggbW9yZSBkYXRhIHRoZSBjbGllbnQgaXMgZXhw
ZWN0aW5nLCBhbmQgd3JpdGUgdGhhdCBkYXRhIHdpdGhvdXQKKyAgICAgICBhIGhlYWRlciBvZiBh
bnkga2luZCB0aGUgbmV4dCB0aW1lIGFyb3VuZCAqLworICAgICpyZW1haW5kZXIgPSBsZW4gLSBy
YzsKKworICAgIHJldHVybiByYzsKK30KKworaW50IHdlYnNvY2tldF93cml0ZSh2b2lkICpvcGFx
dWUsIGNvbnN0IHVpbnQ4X3QgKmJ1ZiwgaW50IGxlbiwgdWludDY0X3QgKnJlbWFpbmRlciwKKyAg
ICAgICAgIHdlYnNvY2tldF93cml0ZV9jYl90IHdyaXRlX2NiKQoreworICAgIHVpbnQ4X3QgaGVh
ZGVyW1dFQlNPQ0tFVF9NQVhfSEVBREVSX1NJWkVdOworICAgIGludCByYzsKKyAgICBpbnQgaGVh
ZGVyX2xlbjsKKworICAgIGlmICgqcmVtYWluZGVyID09IDApIHsKKyAgICAgICAgaGVhZGVyX2xl
biA9IGZpbGxfaGVhZGVyKGhlYWRlciwgbGVuKTsKKyAgICAgICAgcmMgPSB3cml0ZV9jYihvcGFx
dWUsIGhlYWRlciwgaGVhZGVyX2xlbik7CisgICAgICAgIGlmIChyYyA8PSAwKSB7CisgICAgICAg
ICAgICByZXR1cm4gcmM7CisgICAgICAgIH0KKyAgICAgICAgaWYgKHJjICE9IGhlYWRlcl9sZW4p
IHsKKyAgICAgICAgICAgIC8qIFRPRE8gLSBJbiB0aGVvcnksIHdlIGNhbiBoYW5kbGUgdGhpcyBj
YXNlLiAgSW4gcHJhY3RpY2UsCisgICAgICAgICAgICAgICAgICAgICAgaXQgZG9lcyBub3Qgb2Nj
dXIsIGFuZCBkb2VzIG5vdCBzZWVtIHRvIGJlIHdvcnRoCisgICAgICAgICAgICAgICAgICAgICAg
dGhlIGNvZGUgY29tcGxleGl0eSAqLworICAgICAgICAgICAgZXJybm8gPSBFUElQRTsKKyAgICAg
ICAgICAgIHJldHVybiAtMTsKKyAgICAgICAgfQorICAgIH0gZWxzZSB7CisgICAgICAgIGxlbiA9
IE1JTigqcmVtYWluZGVyLCBsZW4pOworICAgIH0KKworICAgIHJjID0gd3JpdGVfY2Iob3BhcXVl
LCBidWYsIGxlbik7CisgICAgaWYgKHJjIDw9IDApIHsKKyAgICAgICAgKnJlbWFpbmRlciA9IGxl
bjsKKyAgICB9IGVsc2UgeworICAgICAgICAqcmVtYWluZGVyID0gbGVuIC0gcmM7CisgICAgfQor
ICAgIHJldHVybiByYzsKK30KKwordm9pZCB3ZWJzb2NrZXRfYWNrX2Nsb3NlKHZvaWQgKm9wYXF1
ZSwgd2Vic29ja2V0X3dyaXRlX2NiX3Qgd3JpdGVfY2IpCit7CisgICAgdW5zaWduZWQgY2hhciBo
ZWFkZXJbMl07CisKKyAgICBoZWFkZXJbMF0gPSBGSU5fRkxBRyB8IENMT1NFX0ZSQU1FOworICAg
IGhlYWRlclsxXSA9IDA7CisKKyAgICB3cml0ZV9jYihvcGFxdWUsIGhlYWRlciwgc2l6ZW9mKGhl
YWRlcikpOworfQorCitib29sIHdlYnNvY2tldF9pc19zdGFydChjaGFyICpidWYpCit7CisgICAg
aWYgKHN0cm5jbXAoYnVmLCAiR0VUICIsIDQpID09IDAgJiYKKyAgICAgICAgICAgIC8vIFRPRE8g
c3RyaXAsIGRvIG5vdCBhc3N1bWUgYSBzaW5nbGUgc3BhY2UKKyAgICAgICAgICAgIGZpbmRfc3Ry
KGJ1ZiwgIlxuU2VjLVdlYlNvY2tldC1Qcm90b2NvbDogYmluYXJ5IikgJiYKKyAgICAgICAgICAg
IGZpbmRfc3RyKGJ1ZiwgIlxuU2VjLVdlYlNvY2tldC1LZXk6IikgJiYKKyAgICAgICAgICAgIGdf
c3RyX2hhc19zdWZmaXgoYnVmLCAiXHJcblxyXG4iKSkgeworICAgICAgICByZXR1cm4gdHJ1ZTsK
KyAgICB9CisKKyAgICByZXR1cm4gZmFsc2U7Cit9CisKK3ZvaWQgd2Vic29ja2V0X2NyZWF0ZV9y
ZXBseShjaGFyICpidWYsIGNoYXIgKm91dGJ1ZikKK3sKKyAgICBjaGFyICprZXk7CisKKyAgICBr
ZXkgPSBnZW5lcmF0ZV9yZXBseV9rZXkoYnVmKTsKKyAgICBzcHJpbnRmKG91dGJ1ZiwgIkhUVFAv
MS4xIDEwMSBTd2l0Y2hpbmcgUHJvdG9jb2xzXHJcbiIKKyAgICAgICAgICAgICAgICAgICAgIlVw
Z3JhZGU6IHdlYnNvY2tldFxyXG4iCisgICAgICAgICAgICAgICAgICAgICJDb25uZWN0aW9uOiBV
cGdyYWRlXHJcbiIKKyAgICAgICAgICAgICAgICAgICAgIlNlYy1XZWJTb2NrZXQtQWNjZXB0OiAl
c1xyXG4iCisgICAgICAgICAgICAgICAgICAgICJTZWMtV2ViU29ja2V0LVByb3RvY29sOiBiaW5h
cnlcclxuXHJcbiIsIGtleSk7CisgICAgZ19mcmVlKGtleSk7Cit9CmRpZmYgLS1naXQgYS9zZXJ2
ZXIvd2Vic29ja2V0LmggYi9zZXJ2ZXIvd2Vic29ja2V0LmgKbmV3IGZpbGUgbW9kZSAxMDA2NDQK
aW5kZXggMDAwMDAwMDAwLi42M2Q3YjEwYzIKLS0tIC9kZXYvbnVsbAorKysgYi9zZXJ2ZXIvd2Vi
c29ja2V0LmgKQEAgLTAsMCArMSw0NCBAQAorLyoKKyAqICBDb3B5cmlnaHQgKEMpIDIwMTUgSmVy
ZW15IFdoaXRlCisgKgorICogIFRoaXMgbGlicmFyeSBpcyBmcmVlIHNvZnR3YXJlOyB5b3UgY2Fu
IHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IKKyAqICBtb2RpZnkgaXQgdW5kZXIgdGhlIHRlcm1zIG9m
IHRoZSBHTlUgTGVzc2VyIEdlbmVyYWwgUHVibGljCisgKiAgTGljZW5zZSBhcyBwdWJsaXNoZWQg
YnkgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbjsgZWl0aGVyCisgKiAgdmVyc2lvbiAyLjEg
b2YgdGhlIExpY2Vuc2UsIG9yIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCisg
KgorICogIFRoaXMgbGlicmFyeSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdp
bGwgYmUgdXNlZnVsLAorICogIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVu
IHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mCisgKiAgTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1Mg
Rk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZSBHTlUKKyAqICBMZXNzZXIgR2VuZXJh
bCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgorICoKKyAqICBZb3Ugc2hvdWxkIGhh
dmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgTGVzc2VyIEdlbmVyYWwgUHVibGljCisgKiAg
TGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgbGlicmFyeTsgaWYgbm90LCBzZWUgPGh0dHA6Ly93d3cu
Z251Lm9yZy9saWNlbnNlcy8+LgorICovCisKKyNkZWZpbmUgV0VCU09DS0VUX01BWF9IRUFERVJf
U0laRSAoMSArIDkgKyA0KQorCit0eXBlZGVmIHN0cnVjdCB7CisgICAgaW50IHR5cGU7CisgICAg
aW50IG1hc2tlZDsKKyAgICB1aW50OF90IGhlYWRlcltXRUJTT0NLRVRfTUFYX0hFQURFUl9TSVpF
XTsKKyAgICBpbnQgaGVhZGVyX3BvczsKKyAgICBpbnQgZnJhbWVfcmVhZHk6MTsKKyAgICB1aW50
OF90IG1hc2tbNF07CisgICAgdWludDY0X3QgcmVsYXllZDsKKyAgICB1aW50NjRfdCBleHBlY3Rl
ZF9sZW47Cit9IHdlYnNvY2tldF9mcmFtZV90OworCit0eXBlZGVmIHNzaXplX3QgKCp3ZWJzb2Nr
ZXRfcmVhZF9jYl90KSh2b2lkICpvcGFxdWUsIHZvaWQgKmJ1Ziwgc2l6ZV90IG5ieXRlKTsKK3R5
cGVkZWYgc3NpemVfdCAoKndlYnNvY2tldF93cml0ZV9jYl90KSh2b2lkICpvcGFxdWUsIGNvbnN0
IHZvaWQgKmJ1Ziwgc2l6ZV90IG5ieXRlKTsKK3R5cGVkZWYgc3NpemVfdCAoKndlYnNvY2tldF93
cml0ZXZfY2JfdCkodm9pZCAqb3BhcXVlLCBzdHJ1Y3QgaW92ZWMgKmlvdiwgaW50IGlvdmNudCk7
CisKK2Jvb2wgd2Vic29ja2V0X2lzX3N0YXJ0KGNoYXIgKmJ1Zik7Cit2b2lkIHdlYnNvY2tldF9j
cmVhdGVfcmVwbHkoY2hhciAqYnVmLCBjaGFyICpvdXRidWYpOworaW50IHdlYnNvY2tldF9yZWFk
KHZvaWQgKm9wYXF1ZSwgdWludDhfdCAqYnVmLCBpbnQgbGVuLCB3ZWJzb2NrZXRfZnJhbWVfdCAq
ZnJhbWUsCisgICAgICAgICB3ZWJzb2NrZXRfcmVhZF9jYl90IHJlYWRfY2IsCisgICAgICAgICB3
ZWJzb2NrZXRfd3JpdGVfY2JfdCB3cml0ZV9jYik7CitpbnQgd2Vic29ja2V0X3dyaXRlKHZvaWQg
Km9wYXF1ZSwgY29uc3QgdWludDhfdCAqYnVmLCBpbnQgbGVuLCB1aW50NjRfdCAqcmVtYWluZGVy
LAorICAgICAgICAgd2Vic29ja2V0X3dyaXRlX2NiX3Qgd3JpdGVfY2IpOworaW50IHdlYnNvY2tl
dF93cml0ZXYodm9pZCAqb3BhcXVlLCBzdHJ1Y3QgaW92ZWMgKmlvdiwgaW50IGlvdmNudCwgdWlu
dDY0X3QgKnJlbWFpbmRlciwKKyAgICAgICAgIHdlYnNvY2tldF93cml0ZXZfY2JfdCB3cml0ZXZf
Y2IpOwordm9pZCB3ZWJzb2NrZXRfYWNrX2Nsb3NlKHZvaWQgKm9wYXF1ZSwgd2Vic29ja2V0X3dy
aXRlX2NiX3Qgd3JpdGVfY2IpOwotLSAKMi4yMC4xCgpfX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fXwpTcGljZS1kZXZlbCBtYWlsaW5nIGxpc3QKU3BpY2UtZGV2
ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21h
aWxtYW4vbGlzdGluZm8vc3BpY2UtZGV2ZWw=
