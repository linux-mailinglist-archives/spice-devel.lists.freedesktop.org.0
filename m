Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 0861FA0462
	for <lists+spice-devel@lfdr.de>; Wed, 28 Aug 2019 16:14:35 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 2887D88D18;
	Wed, 28 Aug 2019 14:14:33 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id A2FD78992E
 for <spice-devel@lists.freedesktop.org>; Wed, 28 Aug 2019 14:14:31 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx02.intmail.prod.int.phx2.redhat.com
 [10.5.11.12])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 4571A7BDA9;
 Wed, 28 Aug 2019 14:14:31 +0000 (UTC)
Received: from fziglio.remote.csb (unknown [10.33.32.21])
 by smtp.corp.redhat.com (Postfix) with ESMTP id 5FC8860C5D;
 Wed, 28 Aug 2019 14:14:30 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Wed, 28 Aug 2019 15:14:07 +0100
Message-Id: <20190828141421.18902-5-fziglio@redhat.com>
In-Reply-To: <20190828141421.18902-1-fziglio@redhat.com>
References: <20190828141421.18902-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.12
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.26]); Wed, 28 Aug 2019 14:14:31 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-gtk v5 04/18] usb-redir: extend USB
 backend to support emulated devices
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

RnJvbTogWXVyaSBCZW5kaXRvdmljaCA8eXVyaS5iZW5kaXRvdmljaEBkYXluaXguY29tPgoKUmVk
aXJlY3Rpb24gb2YgZW11bGF0ZWQgZGV2aWNlcyByZXF1aXJlcyBzcGVjaWFsIGFwcHJvYWNoLAph
cyB1c2JyZWRpcmhvc3QgY2FuJ3QgYmUgdXNlZCBmb3IgdGhhdCAoaXQgd29ya3Mgb25seSB3aXRo
CmxpYnVzYiBkZXZpY2VzKS4gRm9yIGVtdWxhdGVkIGRldmljZXMgd2UgY3JlYXRlIGluc3RhbmNl
IG9mCnVzYnJlZGlycGFyc2VyIHRoYXQgaW1wbGVtZW50cyBVU0IgcmVkaXJlY3Rpb24gcHJvdG9j
b2wuCkluIG9yZGVyIHRvIHdvcmsgd2l0aCB0aGUgc2FtZSBzZXQgb2YgcHJvdG9jb2wgY2FwYWJp
bGl0aWVzCnRoYXQgdXNicmVkaXJob3N0IHNldHMgdXAgd2l0aCByZW1vdGUgc2lkZSwgdGhlIHBh
cnNlciBzaGFsbDoKLSBub3Qgc2VuZCBpdHMgb3duICdoZWxsbycgdG8gdGhlIHNlcnZlcgotIGlu
aXRpYWxpemUgdGhlIHNhbWUgY2FwYWJpbGl0aWVzIHRoYXQgdXNicmVkaXJob3N0Ci0gcmVjZWl2
ZSB0aGUgc2FtZSAnaGVsbG8nIHJlc3BvbnNlCkZvciB0aGF0IHdlIGFuYWx5emUgJ2hlbGxvJyBz
ZW50IGJ5IFVTQiByZWRpciBwYXJzZXIgYW5kCmV4dHJhY3Qgc2V0IG9mIGNhcGFiaWxpdGllcyBm
cm9tIGl0IGFuZCB1cG9uIHJlY2VpdmUgb2YKJ2hlbGxvJyByZXNwb25zZSB3ZSBwcm92aWRlIGl0
IGFsc28gdG8gdGhlIHBhcnNlci4KV2hlbiBsaWJ1c2IgZGV2aWNlIGlzIHJlZGlyZWN0ZWQgdmlh
IGEgY2hhbm5lbCwgaW5zdGFuY2Ugb2YKdXNicmVkaXJob3N0IHNlcnZlcyBpdC4KV2hlbiBlbXVs
YXRlZCBkZXZpY2UgaXMgcmVkaXJlY3RlZCB2aWEgYSBjaGFubmVsLCBpbnN0YW5jZQpvZiB1c2Jy
ZWRpcnBhcnNlciBkb2VzIHRoZSBqb2IuCgpTaWduZWQtb2ZmLWJ5OiBZdXJpIEJlbmRpdG92aWNo
IDx5dXJpLmJlbmRpdG92aWNoQGRheW5peC5jb20+Ci0tLQogc3JjL3VzYi1iYWNrZW5kLmMgfCA2
MTcgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKy0tLQogMSBmaWxl
IGNoYW5nZWQsIDU4MSBpbnNlcnRpb25zKCspLCAzNiBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQg
YS9zcmMvdXNiLWJhY2tlbmQuYyBiL3NyYy91c2ItYmFja2VuZC5jCmluZGV4IDI1MmMwYTY0Li4z
NmE3M2E4OSAxMDA2NDQKLS0tIGEvc3JjL3VzYi1iYWNrZW5kLmMKKysrIGIvc3JjL3VzYi1iYWNr
ZW5kLmMKQEAgLTU1LDYgKzU1LDcgQEAgc3RydWN0IF9TcGljZVVzYkJhY2tlbmREZXZpY2UKICAg
ICBnaW50IHJlZl9jb3VudDsKICAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICphdHRhY2hlZF90
bzsKICAgICBVc2JEZXZpY2VJbmZvcm1hdGlvbiBkZXZpY2VfaW5mbzsKKyAgICBnYm9vbGVhbiBl
ZGV2X2NvbmZpZ3VyZWQ7CiB9OwogCiBzdHJ1Y3QgX1NwaWNlVXNiQmFja2VuZApAQCAtODAsMTAg
KzgxLDIwIEBAIHN0cnVjdCBfU3BpY2VVc2JCYWNrZW5kCiBzdHJ1Y3QgX1NwaWNlVXNiQmFja2Vu
ZENoYW5uZWwKIHsKICAgICBzdHJ1Y3QgdXNicmVkaXJob3N0ICp1c2JyZWRpcmhvc3Q7CisgICAg
c3RydWN0IHVzYnJlZGlyaG9zdCAqaGlkZGVuX2hvc3Q7CisgICAgc3RydWN0IHVzYnJlZGlycGFy
c2VyICpwYXJzZXI7CisgICAgc3RydWN0IHVzYnJlZGlycGFyc2VyICpoaWRkZW5fcGFyc2VyOwog
ICAgIHVpbnQ4X3QgKnJlYWRfYnVmOwogICAgIGludCByZWFkX2J1Zl9zaXplOwogICAgIHN0cnVj
dCB1c2JyZWRpcmZpbHRlcl9ydWxlICpydWxlczsKICAgICBpbnQgcnVsZXNfY291bnQ7CisgICAg
dWludDMyX3QgaG9zdF9jYXBzOworICAgIHVpbnQzMl90IHBhcnNlcl9pbml0X2RvbmUgIDogMTsK
KyAgICB1aW50MzJfdCBwYXJzZXJfd2l0aF9oZWxsbyA6IDE7CisgICAgdWludDMyX3QgaGVsbG9f
ZG9uZV9wYXJzZXIgOiAxOworICAgIHVpbnQzMl90IGhlbGxvX3NlbnQgICAgICAgIDogMTsKKyAg
ICB1aW50MzJfdCByZWplY3RlZCAgICAgICAgICA6IDE7CisgICAgdWludDMyX3Qgd2FpdF9kaXNj
b25uZWN0X2FjayA6IDE7CiAgICAgU3BpY2VVc2JCYWNrZW5kRGV2aWNlICphdHRhY2hlZDsKICAg
ICBTcGljZVVzYnJlZGlyQ2hhbm5lbCAgKnVzZXJfZGF0YTsKICAgICBTcGljZVVzYkJhY2tlbmQg
KmJhY2tlbmQ7CkBAIC0zNTUsNyArMzY2LDExIEBAIGdib29sZWFuIHNwaWNlX3VzYl9iYWNrZW5k
X2RldmljZV9pc29jaChTcGljZVVzYkJhY2tlbmREZXZpY2UgKmRldikKICAgICBnaW50IGksIGos
IGs7CiAgICAgaW50IHJjOwogCi0gICAgZ19yZXR1cm5fdmFsX2lmX2ZhaWwobGliZGV2ICE9IE5V
TEwsIDApOworICAgIGdfcmV0dXJuX3ZhbF9pZl9mYWlsKGxpYmRldiAhPSBOVUxMIHx8IGRldi0+
ZWRldiAhPSBOVUxMLCAwKTsKKyAgICBpZiAoZGV2LT5lZGV2KSB7CisgICAgICAgIC8qIGN1cnJl
bnRseSB3ZSBkbyBub3QgZW11bGF0ZSBpc29jaCBkZXZpY2VzICovCisgICAgICAgIHJldHVybiBG
QUxTRTsKKyAgICB9CiAKICAgICByYyA9IGxpYnVzYl9nZXRfYWN0aXZlX2NvbmZpZ19kZXNjcmlw
dG9yKGxpYmRldiwgJmNvbmZfZGVzYyk7CiAgICAgaWYgKHJjKSB7CkBAIC0zOTAsMTMgKzQwNSwx
NiBAQCBmcm9tIGJvdGggdGhlIG1haW4gdGhyZWFkIGFzIHdlbGwgYXMgZnJvbSB0aGUgdXNiIGV2
ZW50IGhhbmRsaW5nIHRocmVhZCAqLwogc3RhdGljIHZvaWQgdXNicmVkaXJfd3JpdGVfZmx1c2hf
Y2FsbGJhY2sodm9pZCAqdXNlcl9kYXRhKQogewogICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwg
KmNoID0gdXNlcl9kYXRhOwotICAgIGlmICghY2gtPnVzYnJlZGlyaG9zdCkgewotICAgICAgICAv
KiBqdXN0IHRvIGJlIG9uIHRoZSBzYWZlIHNpZGUgKi8KLSAgICAgICAgcmV0dXJuOwotICAgIH0K
ICAgICBpZiAoaXNfY2hhbm5lbF9yZWFkeShjaC0+dXNlcl9kYXRhKSkgewotICAgICAgICBTUElD
RV9ERUJVRygiJXMgY2ggJXAgLT4gdXNicmVkaXJob3N0IiwgX19GVU5DVElPTl9fLCBjaCk7Ci0g
ICAgICAgIHVzYnJlZGlyaG9zdF93cml0ZV9ndWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3QpOwor
ICAgICAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgeworICAgICAgICAgICAgU1BJQ0VfREVCVUco
IiVzIGNoICVwIC0+IHVzYnJlZGlyaG9zdCIsIF9fRlVOQ1RJT05fXywgY2gpOworICAgICAgICAg
ICAgdXNicmVkaXJob3N0X3dyaXRlX2d1ZXN0X2RhdGEoY2gtPnVzYnJlZGlyaG9zdCk7CisgICAg
ICAgIH0gZWxzZSBpZiAoY2gtPnBhcnNlcikgeworICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVz
IGNoICVwIC0+IHBhcnNlciIsIF9fRlVOQ1RJT05fXywgY2gpOworICAgICAgICAgICAgdXNicmVk
aXJwYXJzZXJfZG9fd3JpdGUoY2gtPnBhcnNlcik7CisgICAgICAgIH0gZWxzZSB7CisgICAgICAg
ICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAgKE5PVCBBQ1RJVkUpIiwgX19GVU5DVElPTl9fLCBj
aCk7CisgICAgICAgIH0KICAgICB9IGVsc2UgewogICAgICAgICBTUElDRV9ERUJVRygiJXMgY2gg
JXAgKG5vdCByZWFkeSkiLCBfX0ZVTkNUSU9OX18sIGNoKTsKICAgICB9CkBAIC01NTEsMTMgKzU2
OSw1MiBAQCB2b2lkIHNwaWNlX3VzYl9iYWNrZW5kX2RldmljZV91bnJlZihTcGljZVVzYkJhY2tl
bmREZXZpY2UgKmRldikKICAgICB9CiB9CiAKLWludCBzcGljZV91c2JfYmFja2VuZF9kZXZpY2Vf
Y2hlY2tfZmlsdGVyKAotICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqZGV2LAotICAgIGNvbnN0
IHN0cnVjdCB1c2JyZWRpcmZpbHRlcl9ydWxlICpydWxlcywKLSAgICBpbnQgY291bnQpCitzdGF0
aWMgaW50IGNoZWNrX2VkZXZfZGV2aWNlX2ZpbHRlcihTcGljZVVzYkJhY2tlbmREZXZpY2UgKmRl
diwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0cnVjdCB1c2Jy
ZWRpcmZpbHRlcl9ydWxlICpydWxlcywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIGludCBjb3VudCkKIHsKLSAgICByZXR1cm4gdXNicmVkaXJob3N0X2NoZWNrX2RldmljZV9m
aWx0ZXIoCi0gICAgICAgIHJ1bGVzLCBjb3VudCwgZGV2LT5saWJ1c2JfZGV2aWNlLCAwKTsKKyAg
ICBTcGljZVVzYkVtdWxhdGVkRGV2aWNlICplZGV2ID0gZGV2LT5lZGV2OworICAgIHVpbnQ4X3Qg
Y2xzWzMyXSwgc3ViY2xzWzMyXSwgcHJvdG9bMzJdLCAqY2ZnLCBpZm51bSA9IDA7CisgICAgdWlu
dDE2X3Qgc2l6ZSwgb2Zmc2V0ID0gMDsKKyAgICBpZiAoIWVkZXYpIHsKKyAgICAgICAgcmV0dXJu
IDE7CisgICAgfQorICAgIGlmICghZGV2aWNlX29wcyhlZGV2KS0+Z2V0X2Rlc2NyaXB0b3IoZWRl
diwgTElCVVNCX0RUX0NPTkZJRywgMCwgKHZvaWQgKiopJmNmZywgJnNpemUpKSB7CisgICAgICAg
IHJldHVybiAxOworICAgIH0KKyAgICB3aGlsZSAoKG9mZnNldCArIDEpIDwgc2l6ZSkgeworICAg
ICAgICB1aW50OF90IGxlbiAgPSBjZmdbb2Zmc2V0XTsKKyAgICAgICAgdWludDhfdCB0eXBlID0g
Y2ZnW29mZnNldCArIDFdOworICAgICAgICBpZiAoKG9mZnNldCArIGxlbikgPiBzaXplKSB7Cisg
ICAgICAgICAgICBicmVhazsKKyAgICAgICAgfQorICAgICAgICBpZiAodHlwZSA9PSBMSUJVU0Jf
RFRfSU5URVJGQUNFKSB7CisgICAgICAgICAgICBjbHNbaWZudW1dID0gY2ZnW29mZnNldCArIDVd
OworICAgICAgICAgICAgc3ViY2xzW2lmbnVtXSA9IGNmZ1tvZmZzZXQgKyA2XTsKKyAgICAgICAg
ICAgIHByb3RvW2lmbnVtXSA9IGNmZ1tvZmZzZXQgKyA3XTsKKyAgICAgICAgICAgIGlmbnVtKys7
CisgICAgICAgIH0KKyAgICAgICAgb2Zmc2V0ICs9IGxlbjsKKyAgICB9CisKKyAgICByZXR1cm4g
dXNicmVkaXJmaWx0ZXJfY2hlY2socnVsZXMsIGNvdW50LAorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICBkZXYtPmRldmljZV9pbmZvLmNsYXNzLAorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICBkZXYtPmRldmljZV9pbmZvLnN1YmNsYXNzLAorICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICBkZXYtPmRldmljZV9pbmZvLnByb3RvY29sLAorICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICBjbHMsIHN1YmNscywgcHJvdG8sIGlmbnVtLAorICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICBkZXYtPmRldmljZV9pbmZvLnZpZCwKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgZGV2LT5kZXZpY2VfaW5mby5waWQsCisgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIGRldi0+ZGV2aWNlX2luZm8uYmNkVVNCLCAwKTsKK30KKworaW50IHNw
aWNlX3VzYl9iYWNrZW5kX2RldmljZV9jaGVja19maWx0ZXIoU3BpY2VVc2JCYWNrZW5kRGV2aWNl
ICpkZXYsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBz
dHJ1Y3QgdXNicmVkaXJmaWx0ZXJfcnVsZSAqcnVsZXMsIGludCBjb3VudCkKK3sKKyAgICBpZiAo
ZGV2LT5saWJ1c2JfZGV2aWNlKSB7CisgICAgICAgIHJldHVybiB1c2JyZWRpcmhvc3RfY2hlY2tf
ZGV2aWNlX2ZpbHRlcihydWxlcywgY291bnQsIGRldi0+bGlidXNiX2RldmljZSwgMCk7CisgICAg
fSBlbHNlIHsKKyAgICAgICAgcmV0dXJuIGNoZWNrX2VkZXZfZGV2aWNlX2ZpbHRlcihkZXYsIHJ1
bGVzLCBjb3VudCk7CisgICAgfQogfQogCiBzdGF0aWMgaW50IHVzYnJlZGlyX3JlYWRfY2FsbGJh
Y2sodm9pZCAqdXNlcl9kYXRhLCB1aW50OF90ICpkYXRhLCBpbnQgY291bnQpCkBAIC02MjEsNiAr
Njc4LDE3IEBAIHN0YXRpYyBpbnQgdXNicmVkaXJfd3JpdGVfY2FsbGJhY2sodm9pZCAqdXNlcl9k
YXRhLCB1aW50OF90ICpkYXRhLCBpbnQgY291bnQpCiAgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5l
bCAqY2ggPSB1c2VyX2RhdGE7CiAgICAgaW50IHJlczsKICAgICBTUElDRV9ERUJVRygiJXMgY2gg
JXAsICVkIGJ5dGVzIiwgX19GVU5DVElPTl9fLCBjaCwgY291bnQpOworICAgIGlmICghY2gtPmhl
bGxvX3NlbnQpIHsKKyAgICAgICAgLyogaGVsbG8gaXMgc2hvcnQgaGVhZGVyICgxMikgKyBoZWxs
byBzdHJ1Y3QgKDY0KSArIGNhcGFiaWxpdGllcyAoNCkgKi8KKyAgICAgICAgaW50IGhlbGxvX3Np
emUgPSBzaXplb2Yoc3RydWN0IHVzYl9yZWRpcl9oZWFkZXIpICsgc2l6ZW9mKHN0cnVjdCB1c2Jf
cmVkaXJfaGVsbG9faGVhZGVyKTsKKyAgICAgICAgY2gtPmhlbGxvX3NlbnQgPSAxOworICAgICAg
ICBpZiAoY291bnQgPT0gaGVsbG9fc2l6ZSkgeworICAgICAgICAgICAgbWVtY3B5KCZjaC0+aG9z
dF9jYXBzLCBkYXRhICsgaGVsbG9fc2l6ZSAtIHNpemVvZihjaC0+aG9zdF9jYXBzKSwKKyAgICAg
ICAgICAgICAgICAgICBzaXplb2YoY2gtPmhvc3RfY2FwcykpOworICAgICAgICAgICAgU1BJQ0Vf
REVCVUcoIiVzIGNoICVwLCBzZW5kaW5nIGZpcnN0IGhlbGxvLCBjYXBzICUwOFgiLAorICAgICAg
ICAgICAgICAgICAgICAgICAgX19GVU5DVElPTl9fLCBjaCwgY2gtPmhvc3RfY2Fwcyk7CisgICAg
ICAgIH0KKyAgICB9CiAgICAgcmVzID0gc3BpY2VfdXNicmVkaXJfd3JpdGVfY2FsbGJhY2soY2gt
PnVzZXJfZGF0YSwgZGF0YSwgY291bnQpOwogICAgIHJldHVybiByZXM7CiB9CkBAIC02NDEsNiAr
NzA5LDI3IEBAIGludCBzcGljZV91c2JfYmFja2VuZF9yZWFkX2d1ZXN0X2RhdGEoU3BpY2VVc2JC
YWNrZW5kQ2hhbm5lbCAqY2gsIHVpbnQ4X3QgKmRhdGEsCiAgICAgY2gtPnJlYWRfYnVmX3NpemUg
PSBjb3VudDsKICAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgewogICAgICAgICByZXMgPSB1c2Jy
ZWRpcmhvc3RfcmVhZF9ndWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3QpOworICAgICAgICBpZiAo
IWNoLT5oZWxsb19kb25lX3BhcnNlcikgeworICAgICAgICAgICAgaW50IHJlc19wYXJzZXI7Cisg
ICAgICAgICAgICAvKiB1c2JyZWRpcmhvc3Qgc2hvdWxkIGNvbnN1bWUgaGVsbG8gcmVzcG9uc2Ug
Ki8KKyAgICAgICAgICAgIGdfcmV0dXJuX3ZhbF9pZl9mYWlsKGNoLT5yZWFkX2J1ZiA9PSBOVUxM
LCBVU0JfUkVESVJfRVJST1JfUkVBRF9QQVJTRSk7CisKKyAgICAgICAgICAgIGNoLT5yZWFkX2J1
ZiA9IGRhdGE7CisgICAgICAgICAgICBjaC0+cmVhZF9idWZfc2l6ZSA9IGNvdW50OworICAgICAg
ICAgICAgY2gtPmhlbGxvX2RvbmVfcGFyc2VyID0gMTsKKyAgICAgICAgICAgIGlmIChjaC0+YXR0
YWNoZWQgJiYgY2gtPmF0dGFjaGVkLT5lZGV2KSB7CisgICAgICAgICAgICAgICAgLyogY2FzZSBv
ZiBDRCBzaGFyaW5nIG9uIGNvbm5lY3QgKi8KKyAgICAgICAgICAgICAgICBjaC0+dXNicmVkaXJo
b3N0ID0gTlVMTDsKKyAgICAgICAgICAgICAgICBjaC0+cGFyc2VyID0gY2gtPmhpZGRlbl9wYXJz
ZXI7CisgICAgICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBzd2l0Y2ggJXAgdG8gcGFyc2Vy
IiwgX19GVU5DVElPTl9fLCBjaCk7CisgICAgICAgICAgICB9CisgICAgICAgICAgICByZXNfcGFy
c2VyID0gdXNicmVkaXJwYXJzZXJfZG9fcmVhZChjaC0+aGlkZGVuX3BhcnNlcik7CisgICAgICAg
ICAgICBpZiAocmVzID49IDApIHsKKyAgICAgICAgICAgICAgICByZXMgPSByZXNfcGFyc2VyOwor
ICAgICAgICAgICAgfQorICAgICAgICB9CisgICAgfSBlbHNlIGlmIChjaC0+cGFyc2VyKSB7Cisg
ICAgICAgIHJlcyA9IHVzYnJlZGlycGFyc2VyX2RvX3JlYWQoY2gtPnBhcnNlcik7CiAgICAgfSBl
bHNlIHsKICAgICAgICAgcmVzID0gVVNCX1JFRElSX0VSUk9SX0lPOwogICAgIH0KQEAgLTY2MSw2
ICs3NTAsMTEgQEAgaW50IHNwaWNlX3VzYl9iYWNrZW5kX3JlYWRfZ3Vlc3RfZGF0YShTcGljZVVz
YkJhY2tlbmRDaGFubmVsICpjaCwgdWludDhfdCAqZGF0YSwKICAgICB9CiAgICAgU1BJQ0VfREVC
VUcoIiVzIGNoICVwLCAlZCBieXRlcywgcmVzICVkIiwgX19GVU5DVElPTl9fLCBjaCwgY291bnQs
IHJlcyk7CiAKKyAgICBpZiAoY2gtPnJlamVjdGVkKSB7CisgICAgICAgIGNoLT5yZWplY3RlZCA9
IDA7CisgICAgICAgIHJlcyA9IFVTQl9SRURJUl9FUlJPUl9ERVZfUkVKRUNURUQ7CisgICAgfQor
CiAgICAgcmV0dXJuIHJlczsKIH0KIApAQCAtNjkwLDEzICs3ODQsNDI3IEBAIEdFcnJvciAqc3Bp
Y2VfdXNiX2JhY2tlbmRfZ2V0X2Vycm9yX2RldGFpbHMoaW50IGVycm9yX2NvZGUsIGdjaGFyICpk
ZXNjKQogdm9pZCBzcGljZV91c2JfYmFja2VuZF9yZXR1cm5fd3JpdGVfZGF0YShTcGljZVVzYkJh
Y2tlbmRDaGFubmVsICpjaCwgdm9pZCAqZGF0YSkKIHsKICAgICBpZiAoY2gtPnVzYnJlZGlyaG9z
dCkgewotICAgICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAiLCBfX0ZVTkNUSU9OX18sIGNoKTsK
KyAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIC0+IHVzYnJlZGlyaG9zdCIsIF9fRlVOQ1RJ
T05fXywgY2gpOwogICAgICAgICB1c2JyZWRpcmhvc3RfZnJlZV93cml0ZV9idWZmZXIoY2gtPnVz
YnJlZGlyaG9zdCwgZGF0YSk7CisgICAgfSBlbHNlIGlmIChjaC0+cGFyc2VyKSB7CisgICAgICAg
IFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAtPiBwYXJzZXIiLCBfX0ZVTkNUSU9OX18sIGNoKTsKKyAg
ICAgICAgdXNicmVkaXJwYXJzZXJfZnJlZV93cml0ZV9idWZmZXIoY2gtPnBhcnNlciwgZGF0YSk7
CiAgICAgfSBlbHNlIHsKICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIC0gTk9CT0RZIFRP
IENBTEwiLCBfX0ZVTkNUSU9OX18sIGNoKTsKICAgICB9CiB9CiAKK3N0YXRpYyB2b2lkCit1c2Jy
ZWRpcl9jb250cm9sX3BhY2tldCh2b2lkICpwcml2LCB1aW50NjRfdCBpZCwgc3RydWN0IHVzYl9y
ZWRpcl9jb250cm9sX3BhY2tldF9oZWFkZXIgKmgsCisgICAgICAgICAgICAgICAgICAgICAgICB1
aW50OF90ICpkYXRhLCBpbnQgZGF0YV9sZW4pCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5l
bCAqY2ggPSBwcml2OworICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqZCA9IGNoLT5hdHRhY2hl
ZDsKKyAgICBTcGljZVVzYkVtdWxhdGVkRGV2aWNlICplZGV2ID0gZCA/IGQtPmVkZXYgOiBOVUxM
OworICAgIHN0cnVjdCB1c2JfcmVkaXJfY29udHJvbF9wYWNrZXRfaGVhZGVyIHJlc3BvbnNlID0g
Kmg7CisgICAgdWludDhfdCByZXF0eXBlID0gaC0+cmVxdWVzdHR5cGUgJiAweDdmOworICAgIGdi
b29sZWFuIGRvbmUgPSBGQUxTRTsKKyAgICB2b2lkICpvdXRfYnVmZmVyID0gTlVMTDsKKworICAg
IHJlc3BvbnNlLnN0YXR1cyA9IHVzYl9yZWRpcl9zdGFsbDsKKyAgICBTUElDRV9ERUJVRygiJXMg
JXA6IFRSVklMICUwMlggJTAyWCAlMDRYICUwNFggJTA0WCIsCisgICAgICAgICAgICAgICAgX19G
VU5DVElPTl9fLAorICAgICAgICAgICAgICAgIGNoLCBoLT5yZXF1ZXN0dHlwZSwgaC0+cmVxdWVz
dCwKKyAgICAgICAgICAgICAgICBoLT52YWx1ZSwgaC0+aW5kZXgsIGgtPmxlbmd0aCk7CisKKyAg
ICBpZiAoIWVkZXYpIHsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBkZXZpY2Ugbm90IGF0dGFj
aGVkIiwgX19GVU5DVElPTl9fKTsKKyAgICAgICAgcmVzcG9uc2Uuc3RhdHVzID0gdXNiX3JlZGly
X2lvZXJyb3I7CisgICAgICAgIGRvbmUgPSBUUlVFOworICAgIH0gZWxzZSBpZiAocmVxdHlwZSA9
PSAoTElCVVNCX1JFUVVFU1RfVFlQRV9TVEFOREFSRCB8IExJQlVTQl9SRUNJUElFTlRfREVWSUNF
KSAmJgorICAgICAgICAgICAgICAgaC0+cmVxdWVzdCA9PSBMSUJVU0JfUkVRVUVTVF9HRVRfREVT
Q1JJUFRPUikgeworICAgICAgICB1aW50MTZfdCBzaXplOworICAgICAgICBkb25lID0gZGV2aWNl
X29wcyhlZGV2KS0+Z2V0X2Rlc2NyaXB0b3IoZWRldiwgaC0+dmFsdWUgPj4gOCwgaC0+dmFsdWUg
JiAweGZmLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
Jm91dF9idWZmZXIsICZzaXplKTsKKyAgICAgICAgcmVzcG9uc2UubGVuZ3RoID0gc2l6ZTsKKyAg
ICAgICAgaWYgKGRvbmUpIHsKKyAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1cyA9IDA7CisgICAg
ICAgIH0KKyAgICAgICAgZG9uZSA9IFRSVUU7CisgICAgfQorCisgICAgaWYgKCFkb25lKSB7Cisg
ICAgICAgIGRldmljZV9vcHMoZWRldiktPmNvbnRyb2xfcmVxdWVzdChlZGV2LCBkYXRhLCBkYXRh
X2xlbiwgJnJlc3BvbnNlLCAmb3V0X2J1ZmZlcik7CisgICAgICAgIGRvbmUgPSBUUlVFOworICAg
IH0KKworICAgIGlmIChyZXNwb25zZS5zdGF0dXMpIHsKKyAgICAgICAgcmVzcG9uc2UubGVuZ3Ro
ID0gMDsKKyAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmxlbmd0aCA+IGgtPmxlbmd0aCkgeworICAg
ICAgICByZXNwb25zZS5sZW5ndGggPSBoLT5sZW5ndGg7CisgICAgfQorCisgICAgU1BJQ0VfREVC
VUcoIiVzIHJlc3BvbmRpbmcgd2l0aCBwYXlsb2FkIG9mICUwMlgsIHN0YXR1cyAlWCIsCisgICAg
ICAgICAgICAgICAgX19GVU5DVElPTl9fLCByZXNwb25zZS5sZW5ndGgsIHJlc3BvbnNlLnN0YXR1
cyk7CisgICAgdXNicmVkaXJwYXJzZXJfc2VuZF9jb250cm9sX3BhY2tldChjaC0+cGFyc2VyLCBp
ZCwgJnJlc3BvbnNlLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVz
cG9uc2UubGVuZ3RoID8gb3V0X2J1ZmZlciA6IE5VTEwsCisgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICByZXNwb25zZS5sZW5ndGgpOworCisgICAgdXNicmVkaXJfd3JpdGVf
Zmx1c2hfY2FsbGJhY2soY2gpOworICAgIHVzYnJlZGlycGFyc2VyX2ZyZWVfcGFja2V0X2RhdGEo
Y2gtPnBhcnNlciwgZGF0YSk7Cit9CisKK3N0YXRpYyB2b2lkCit1c2JyZWRpcl9idWxrX3BhY2tl
dCh2b2lkICpwcml2LCB1aW50NjRfdCBpZCwgc3RydWN0IHVzYl9yZWRpcl9idWxrX3BhY2tldF9o
ZWFkZXIgKmgsCisgICAgICAgICAgICAgICAgICAgICB1aW50OF90ICpkYXRhLCBpbnQgZGF0YV9s
ZW4pCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIFNwaWNl
VXNiQmFja2VuZERldmljZSAqZCA9IGNoLT5hdHRhY2hlZDsKKyAgICBTcGljZVVzYkVtdWxhdGVk
RGV2aWNlICplZGV2ID0gZCA/IGQtPmVkZXYgOiBOVUxMOworICAgIHN0cnVjdCB1c2JfcmVkaXJf
YnVsa19wYWNrZXRfaGVhZGVyIGhvdXQgPSAqaDsKKyAgICB1aW50MzJfdCBsZW4gPSAoaC0+bGVu
Z3RoX2hpZ2ggPDwgMTYpIHwgaC0+bGVuZ3RoOworICAgIFNQSUNFX0RFQlVHKCIlcyAlcDogZXAg
JVgsIGxlbiAldSwgaWQgJSIgR19HVUlOVDY0X0ZPUk1BVCwgX19GVU5DVElPTl9fLAorICAgICAg
ICAgICAgICAgIGNoLCBoLT5lbmRwb2ludCwgbGVuLCBpZCk7CisKKyAgICBpZiAoIWVkZXYpIHsK
KyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBkZXZpY2Ugbm90IGF0dGFjaGVkIiwgX19GVU5DVElP
Tl9fKTsKKyAgICAgICAgaG91dC5zdGF0dXMgPSB1c2JfcmVkaXJfaW9lcnJvcjsKKyAgICAgICAg
aG91dC5sZW5ndGggPSBob3V0Lmxlbmd0aF9oaWdoID0gMDsKKyAgICAgICAgU1BJQ0VfREVCVUco
IiVzOiByZXNwb25kaW5nIHdpdGggWkxQIHN0YXR1cyAlZCIsIF9fRlVOQ1RJT05fXywgaG91dC5z
dGF0dXMpOworICAgIH0gZWxzZSBpZiAoaC0+ZW5kcG9pbnQgJiBMSUJVU0JfRU5EUE9JTlRfSU4p
IHsKKyAgICAgICAgaWYgKGRldmljZV9vcHMoZWRldiktPmJ1bGtfaW5fcmVxdWVzdChlZGV2LCBp
ZCwgJmhvdXQpKSB7CisgICAgICAgICAgICB1c2JyZWRpcnBhcnNlcl9mcmVlX3BhY2tldF9kYXRh
KGNoLT5wYXJzZXIsIGRhdGEpOworICAgICAgICAgICAgLyogY29tcGxldGlvbiBpcyBhc3luY2hy
b25vdXMgKi8KKyAgICAgICAgICAgIHJldHVybjsKKyAgICAgICAgfQorICAgIH0gZWxzZSB7Cisg
ICAgICAgIGhvdXQuc3RhdHVzID0gdXNiX3JlZGlyX3N0YWxsOworICAgICAgICBkZXZpY2Vfb3Bz
KGVkZXYpLT5idWxrX291dF9yZXF1ZXN0KGVkZXYsIGgtPmVuZHBvaW50LCBkYXRhLCBkYXRhX2xl
biwgJmhvdXQuc3RhdHVzKTsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiByZXNwb25kaW5nIHN0
YXR1cyAlZCIsIF9fRlVOQ1RJT05fXywgaG91dC5zdGF0dXMpOworICAgIH0KKworICAgIHVzYnJl
ZGlycGFyc2VyX3NlbmRfYnVsa19wYWNrZXQoY2gtPnBhcnNlciwgaWQsICZob3V0LCBOVUxMLCAw
KTsKKyAgICB1c2JyZWRpcnBhcnNlcl9mcmVlX3BhY2tldF9kYXRhKGNoLT5wYXJzZXIsIGRhdGEp
OworICAgIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsKK30KKworc3RhdGljIHZv
aWQgdXNicmVkaXJfZGV2aWNlX3Jlc2V0KHZvaWQgKnByaXYpCit7CisgICAgU3BpY2VVc2JCYWNr
ZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqZCA9IGNo
LT5hdHRhY2hlZDsKKyAgICBTcGljZVVzYkVtdWxhdGVkRGV2aWNlICplZGV2ID0gZCA/IGQtPmVk
ZXYgOiBOVUxMOworICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCIsIF9fRlVOQ1RJT05fXywgY2gp
OworICAgIGlmIChlZGV2KSB7CisgICAgICAgIGRldmljZV9vcHMoZWRldiktPnJlc2V0KGVkZXYp
OworICAgIH0KK30KKworc3RhdGljIHZvaWQKK3VzYnJlZGlyX2ludGVyZmFjZV9pbmZvKHZvaWQg
KnByaXYsIHN0cnVjdCB1c2JfcmVkaXJfaW50ZXJmYWNlX2luZm9faGVhZGVyICppbnRlcmZhY2Vf
aW5mbykKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU1BJ
Q0VfREVCVUcoIiVzIG5vdCBpbXBsZW1lbnRlZCAlcCIsIF9fRlVOQ1RJT05fXywgY2gpOworfQor
CitzdGF0aWMgdm9pZAordXNicmVkaXJfaW50ZXJmYWNlX2VwX2luZm8odm9pZCAqcHJpdiwgc3Ry
dWN0IHVzYl9yZWRpcl9lcF9pbmZvX2hlYWRlciAqZXBfaW5mbykKK3sKKyAgICBTcGljZVVzYkJh
Y2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU1BJQ0VfREVCVUcoIiVzIG5vdCBpbXBsZW1l
bnRlZCAlcCIsIF9fRlVOQ1RJT05fXywgY2gpOworfQorCitzdGF0aWMgdm9pZAordXNicmVkaXJf
c2V0X2NvbmZpZ3VyYXRpb24odm9pZCAqcHJpdiwgdWludDY0X3QgaWQsCisgICAgICAgICAgICAg
ICAgICAgICAgICAgICBzdHJ1Y3QgdXNiX3JlZGlyX3NldF9jb25maWd1cmF0aW9uX2hlYWRlciAq
c2V0X2NvbmZpZ3VyYXRpb24pCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBw
cml2OworICAgIHN0cnVjdCB1c2JfcmVkaXJfY29uZmlndXJhdGlvbl9zdGF0dXNfaGVhZGVyIGg7
CisgICAgaC5zdGF0dXMgPSAwOworICAgIGguY29uZmlndXJhdGlvbiA9IHNldF9jb25maWd1cmF0
aW9uLT5jb25maWd1cmF0aW9uOworICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCwgY2ZnICVkIiwg
X19GVU5DVElPTl9fLCBjaCwgaC5jb25maWd1cmF0aW9uKTsKKyAgICBpZiAoY2gtPmF0dGFjaGVk
KSB7CisgICAgICAgIGNoLT5hdHRhY2hlZC0+ZWRldl9jb25maWd1cmVkID0gaC5jb25maWd1cmF0
aW9uICE9IDA7CisgICAgfQorICAgIHVzYnJlZGlycGFyc2VyX3NlbmRfY29uZmlndXJhdGlvbl9z
dGF0dXMoY2gtPnBhcnNlciwgaWQsICZoKTsKKyAgICB1c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxs
YmFjayhjaCk7Cit9CisKK3N0YXRpYyB2b2lkIHVzYnJlZGlyX2dldF9jb25maWd1cmF0aW9uKHZv
aWQgKnByaXYsIHVpbnQ2NF90IGlkKQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNo
ID0gcHJpdjsKKyAgICBzdHJ1Y3QgdXNiX3JlZGlyX2NvbmZpZ3VyYXRpb25fc3RhdHVzX2hlYWRl
ciBoOworICAgIGguc3RhdHVzID0gMDsKKyAgICBoLmNvbmZpZ3VyYXRpb24gPSBjaC0+YXR0YWNo
ZWQgJiYgY2gtPmF0dGFjaGVkLT5lZGV2X2NvbmZpZ3VyZWQ7CisgICAgU1BJQ0VfREVCVUcoIiVz
IGNoICVwLCBjZmcgJWQiLCBfX0ZVTkNUSU9OX18sIGNoLCBoLmNvbmZpZ3VyYXRpb24pOworICAg
IHVzYnJlZGlycGFyc2VyX3NlbmRfY29uZmlndXJhdGlvbl9zdGF0dXMoY2gtPnBhcnNlciwgaWQs
ICZoKTsKKyAgICB1c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFjayhjaCk7Cit9CisKK3N0YXRp
YyB2b2lkCit1c2JyZWRpcl9zZXRfYWx0X3NldHRpbmcodm9pZCAqcHJpdiwgdWludDY0X3QgaWQs
IHN0cnVjdCB1c2JfcmVkaXJfc2V0X2FsdF9zZXR0aW5nX2hlYWRlciAqcykKK3sKKyAgICBTcGlj
ZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgc3RydWN0IHVzYl9yZWRpcl9hbHRf
c2V0dGluZ19zdGF0dXNfaGVhZGVyIHNoOworICAgIHNoLnN0YXR1cyA9ICghcy0+aW50ZXJmYWNl
ICYmICFzLT5hbHQpID8gMCA6IHVzYl9yZWRpcl9zdGFsbDsKKyAgICBzaC5pbnRlcmZhY2UgPSBz
LT5pbnRlcmZhY2U7CisgICAgc2guYWx0ID0gcy0+YWx0OworICAgIFNQSUNFX0RFQlVHKCIlcyBj
aCAlcCwgJWQ6JWQiLCBfX0ZVTkNUSU9OX18sIGNoLCBzLT5pbnRlcmZhY2UsIHMtPmFsdCk7Cisg
ICAgdXNicmVkaXJwYXJzZXJfc2VuZF9hbHRfc2V0dGluZ19zdGF0dXMoY2gtPnBhcnNlciwgaWQs
ICZzaCk7CisgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2soY2gpOworfQorCitzdGF0
aWMgdm9pZAordXNicmVkaXJfZ2V0X2FsdF9zZXR0aW5nKHZvaWQgKnByaXYsIHVpbnQ2NF90IGlk
LCBzdHJ1Y3QgdXNiX3JlZGlyX2dldF9hbHRfc2V0dGluZ19oZWFkZXIgKnMpCit7CisgICAgU3Bp
Y2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIHN0cnVjdCB1c2JfcmVkaXJfYWx0
X3NldHRpbmdfc3RhdHVzX2hlYWRlciBzaDsKKyAgICBzaC5zdGF0dXMgPSAocy0+aW50ZXJmYWNl
ID09IDApID8gMCA6IHVzYl9yZWRpcl9zdGFsbDsKKyAgICBzaC5pbnRlcmZhY2UgPSBzLT5pbnRl
cmZhY2U7CisgICAgc2guYWx0ID0gMDsKKyAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAsIGlmICVk
IiwgX19GVU5DVElPTl9fLCBjaCwgcy0+aW50ZXJmYWNlKTsKKyAgICB1c2JyZWRpcnBhcnNlcl9z
ZW5kX2FsdF9zZXR0aW5nX3N0YXR1cyhjaC0+cGFyc2VyLCBpZCwgJnNoKTsKKyAgICB1c2JyZWRp
cl93cml0ZV9mbHVzaF9jYWxsYmFjayhjaCk7Cit9CisKK3N0YXRpYyB2b2lkIHVzYnJlZGlyX2Nh
bmNlbF9kYXRhKHZvaWQgKnByaXYsIHVpbnQ2NF90IGlkKQoreworICAgIFNwaWNlVXNiQmFja2Vu
ZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBTcGljZVVzYkJhY2tlbmREZXZpY2UgKmQgPSBjaC0+
YXR0YWNoZWQ7CisgICAgU3BpY2VVc2JFbXVsYXRlZERldmljZSAqZWRldiA9IGQgPyBkLT5lZGV2
IDogTlVMTDsKKyAgICBpZiAoIWVkZXYpIHsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBkZXZp
Y2Ugbm90IGF0dGFjaGVkIiwgX19GVU5DVElPTl9fKTsKKyAgICAgICAgcmV0dXJuOworICAgIH0K
KyAgICBkZXZpY2Vfb3BzKGVkZXYpLT5jYW5jZWxfcmVxdWVzdChlZGV2LCBpZCk7Cit9CisKK3N0
YXRpYyB2b2lkIHVzYnJlZGlyX2ZpbHRlcl9yZWplY3Qodm9pZCAqcHJpdikKK3sKKyAgICBTcGlj
ZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU1BJQ0VfREVCVUcoIiVzICVwIiwg
X19GVU5DVElPTl9fLCBjaCk7CisgICAgY2gtPnJlamVjdGVkID0gMTsKK30KKworLyogTm90ZSB0
aGF0IHRoZSBvd25lcnNoaXAgb2YgdGhlIHJ1bGVzIGFycmF5IGlzIHBhc3NlZCBvbiB0byB0aGUg
Y2FsbGJhY2suICovCitzdGF0aWMgdm9pZAordXNicmVkaXJfZmlsdGVyX2ZpbHRlcih2b2lkICpw
cml2LCBzdHJ1Y3QgdXNicmVkaXJmaWx0ZXJfcnVsZSAqciwgaW50IGNvdW50KQoreworICAgIFNw
aWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBTUElDRV9ERUJVRygiJXMgY2gg
JXAgJWQgZmlsdGVycyIsIF9fRlVOQ1RJT05fXywgY2gsIGNvdW50KTsKKworICAgIGZyZWUoY2gt
PnJ1bGVzKTsKKworICAgIGNoLT5ydWxlcyA9IHI7CisgICAgY2gtPnJ1bGVzX2NvdW50ID0gY291
bnQ7CisgICAgaWYgKGNvdW50KSB7CisgICAgICAgIGludCBpOworICAgICAgICBmb3IgKGkgPSAw
OyBpIDwgY291bnQ7IGkrKykgeworICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNsYXNzICVk
LCAlWDolWCIsCisgICAgICAgICAgICAgICAgcltpXS5hbGxvdyA/ICJhbGxvd2VkIiA6ICJkZW5p
ZWQiLCByW2ldLmRldmljZV9jbGFzcywKKyAgICAgICAgICAgICAgICAodWludDMyX3QpcltpXS52
ZW5kb3JfaWQsICh1aW50MzJfdClyW2ldLnByb2R1Y3RfaWQpOworICAgICAgICB9CisgICAgfQor
fQorCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9kZXZpY2VfZGlzY29ubmVjdF9hY2sodm9pZCAqcHJp
dikKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU1BJQ0Vf
REVCVUcoIiVzIGNoICVwIiwgX19GVU5DVElPTl9fLCBjaCk7CisgICAgaWYgKGNoLT5wYXJzZXIg
JiYgY2gtPndhaXRfZGlzY29ubmVjdF9hY2spIHsKKyAgICAgICAgY2gtPnBhcnNlciA9IE5VTEw7
CisgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBzd2l0Y2ggdG8gdXNicmVkaXJob3N0IiwgX19GVU5D
VElPTl9fKTsKKyAgICAgICAgY2gtPnVzYnJlZGlyaG9zdCA9IGNoLT5oaWRkZW5faG9zdDsKKyAg
ICB9CisgICAgY2gtPndhaXRfZGlzY29ubmVjdF9hY2sgPSAwOworfQorCitzdGF0aWMgdm9pZAor
dXNicmVkaXJfaGVsbG8odm9pZCAqcHJpdiwgc3RydWN0IHVzYl9yZWRpcl9oZWxsb19oZWFkZXIg
KmhlbGxvKQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBT
cGljZVVzYkJhY2tlbmREZXZpY2UgKmQgPSBjaC0+YXR0YWNoZWQ7CisgICAgU3BpY2VVc2JFbXVs
YXRlZERldmljZSAqZWRldiA9IGQgPyBkLT5lZGV2IDogTlVMTDsKKyAgICBzdHJ1Y3QgdXNiX3Jl
ZGlyX2RldmljZV9jb25uZWN0X2hlYWRlciBkZXZpY2VfY29ubmVjdDsKKyAgICBzdHJ1Y3QgdXNi
X3JlZGlyX2VwX2luZm9faGVhZGVyIGVwX2luZm8gPSB7IDAgfTsKKyAgICBzdHJ1Y3QgdXNiX3Jl
ZGlyX2ludGVyZmFjZV9pbmZvX2hlYWRlciBpbnRlcmZhY2VfaW5mbyA9IHsgMCB9OworICAgIHVp
bnQ4X3QgKmNmZzsKKyAgICB1aW50MTZfdCBzaXplLCBvZmZzZXQgPSAwOworICAgIFNQSUNFX0RF
QlVHKCIlcyAlcCAlc2F0dGFjaGVkICVzIiwgX19GVU5DVElPTl9fLCBjaCwKKyAgICAgICAgZWRl
diA/ICIiIDogIm5vdCAiLCAgaGVsbG8gPyAiIiA6ICIoaW50ZXJuYWwpIik7CisKKyAgICBpZiAo
aGVsbG8pIHsKKyAgICAgICAgY2gtPmhlbGxvX2RvbmVfcGFyc2VyID0gMTsKKyAgICB9CisgICAg
aWYgKCFlZGV2KSB7CisgICAgICAgIHJldHVybjsKKyAgICB9CisgICAgaWYgKCFkZXZpY2Vfb3Bz
KGVkZXYpLT5nZXRfZGVzY3JpcHRvcihlZGV2LCBMSUJVU0JfRFRfQ09ORklHLCAwLCAodm9pZCAq
KikmY2ZnLCAmc2l6ZSkpIHsKKyAgICAgICAgcmV0dXJuOworICAgIH0KKyAgICB3aGlsZSAoKG9m
ZnNldCArIDEpIDwgc2l6ZSkgeworICAgICAgICB1aW50OF90IGxlbiAgPSBjZmdbb2Zmc2V0XTsK
KyAgICAgICAgdWludDhfdCB0eXBlID0gY2ZnW29mZnNldCArIDFdOworICAgICAgICBpZiAoKG9m
ZnNldCArIGxlbikgPiBzaXplKSB7CisgICAgICAgICAgICBicmVhazsKKyAgICAgICAgfQorICAg
ICAgICBpZiAodHlwZSA9PSBMSUJVU0JfRFRfSU5URVJGQUNFKSB7CisgICAgICAgICAgICB1aW50
MzJfdCBpID0gaW50ZXJmYWNlX2luZm8uaW50ZXJmYWNlX2NvdW50OworICAgICAgICAgICAgdWlu
dDhfdCBjbGFzcywgc3ViY2xhc3MsIHByb3RvY29sOworICAgICAgICAgICAgY2xhc3MgPSBjZmdb
b2Zmc2V0ICsgNV07CisgICAgICAgICAgICBzdWJjbGFzcyA9IGNmZ1tvZmZzZXQgKyA2XTsKKyAg
ICAgICAgICAgIHByb3RvY29sID0gY2ZnW29mZnNldCArIDddOworICAgICAgICAgICAgaW50ZXJm
YWNlX2luZm8uaW50ZXJmYWNlX2NsYXNzW2ldID0gY2xhc3M7CisgICAgICAgICAgICBpbnRlcmZh
Y2VfaW5mby5pbnRlcmZhY2Vfc3ViY2xhc3NbaV0gPSBzdWJjbGFzczsKKyAgICAgICAgICAgIGlu
dGVyZmFjZV9pbmZvLmludGVyZmFjZV9wcm90b2NvbFtpXSA9IHByb3RvY29sOworICAgICAgICAg
ICAgaW50ZXJmYWNlX2luZm8uaW50ZXJmYWNlX2NvdW50Kys7CisgICAgICAgICAgICBTUElDRV9E
RUJVRygiJXMgSUYlZDogJWQvJWQvJWQiLCBfX0ZVTkNUSU9OX18sIGksIGNsYXNzLCBzdWJjbGFz
cywgcHJvdG9jb2wpOworICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT0gTElCVVNCX0RUX0VORFBP
SU5UKSB7CisgICAgICAgICAgICB1aW50OF90IGFkZHJlc3MgPSBjZmdbb2Zmc2V0ICsgMl07Cisg
ICAgICAgICAgICB1aW50MTZfdCBtYXhfcGFja2V0X3NpemUgPSAweDEwMCAqIGNmZ1tvZmZzZXQg
KyA1XSArIGNmZ1tvZmZzZXQgKyA0XTsKKyAgICAgICAgICAgIHVpbnQ4X3QgaW5kZXggPSBhZGRy
ZXNzICYgMHhmOworICAgICAgICAgICAgaWYgKGFkZHJlc3MgJiAweDgwKSBpbmRleCArPSAweDEw
OworICAgICAgICAgICAgZXBfaW5mby50eXBlW2luZGV4XSA9IGNmZ1tvZmZzZXQgKyAzXSAmIDB4
MzsKKyAgICAgICAgICAgIGVwX2luZm8ubWF4X3BhY2tldF9zaXplW2luZGV4XSA9IG1heF9wYWNr
ZXRfc2l6ZTsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBFUFslMDJYXTogJWQvJWQiLCBf
X0ZVTkNUSU9OX18sIGluZGV4LCBlcF9pbmZvLnR5cGVbaW5kZXhdLCBtYXhfcGFja2V0X3NpemUp
OworICAgICAgICB9CisgICAgICAgIG9mZnNldCArPSBsZW47CisgICAgfQorCisgICAgdXNicmVk
aXJwYXJzZXJfc2VuZF9pbnRlcmZhY2VfaW5mbyhjaC0+cGFyc2VyLCAmaW50ZXJmYWNlX2luZm8p
OworICAgIHVzYnJlZGlycGFyc2VyX3NlbmRfZXBfaW5mbyhjaC0+cGFyc2VyLCAmZXBfaW5mbyk7
CisKKyAgICBkZXZpY2VfY29ubmVjdC5kZXZpY2VfY2xhc3MgPSAwOyAvL2QtPmRldmljZV9pbmZv
LmNsYXNzOworICAgIGRldmljZV9jb25uZWN0LmRldmljZV9zdWJjbGFzcyA9IDA7IC8vZC0+ZGV2
aWNlX2luZm8uc3ViY2xhc3M7CisgICAgZGV2aWNlX2Nvbm5lY3QuZGV2aWNlX3Byb3RvY29sID0g
MDsgLy9kLT5kZXZpY2VfaW5mby5wcm90b2NvbDs7CisgICAgZGV2aWNlX2Nvbm5lY3QudmVuZG9y
X2lkID0gZC0+ZGV2aWNlX2luZm8udmlkOworICAgIGRldmljZV9jb25uZWN0LnByb2R1Y3RfaWQg
PSBkLT5kZXZpY2VfaW5mby5waWQ7CisgICAgZGV2aWNlX2Nvbm5lY3QuZGV2aWNlX3ZlcnNpb25f
YmNkID0gZC0+ZGV2aWNlX2luZm8uYmNkVVNCOworICAgIGRldmljZV9jb25uZWN0LnNwZWVkID0g
dXNiX3JlZGlyX3NwZWVkX2hpZ2g7CisgICAgdXNicmVkaXJwYXJzZXJfc2VuZF9kZXZpY2VfY29u
bmVjdChjaC0+cGFyc2VyLCAmZGV2aWNlX2Nvbm5lY3QpOworICAgIHVzYnJlZGlyX3dyaXRlX2Zs
dXNoX2NhbGxiYWNrKGNoKTsKK30KKworc3RhdGljIHZvaWQgaW5pdGlhbGl6ZV9wYXJzZXIoU3Bp
Y2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsIGdib29sZWFuIGRvX2hlbGxvKQoreworICAgIHVpbnQz
Ml90IGZsYWdzLCBjYXBzW1VTQl9SRURJUl9DQVBTX1NJWkVdID0geyAwIH07CisKKyAgICBnX3Jl
dHVybl9pZl9mYWlsKGNoLT5oaWRkZW5fcGFyc2VyICE9IE5VTEwpOworICAgIGlmIChjaC0+cGFy
c2VyX2luaXRfZG9uZSkgeworICAgICAgICBpZiAoY2gtPnBhcnNlcl93aXRoX2hlbGxvICE9IGRv
X2hlbGxvKSB7CisgICAgICAgICAgICBnX3JldHVybl9pZl9yZWFjaGVkKCk7CisgICAgICAgIH0K
KyAgICAgICAgcmV0dXJuOworICAgIH0KKworICAgIGNoLT5wYXJzZXJfaW5pdF9kb25lID0gMTsK
KyAgICBjaC0+cGFyc2VyX3dpdGhfaGVsbG8gPSBkb19oZWxsbzsKKyAgICBmbGFncyA9IHVzYnJl
ZGlycGFyc2VyX2ZsX3dyaXRlX2NiX293bnNfYnVmZmVyIHwgdXNicmVkaXJwYXJzZXJfZmxfdXNi
X2hvc3Q7CisKKyAgICBpZiAoZG9faGVsbG8pIHsKKyAgICAgICAgY2gtPmhlbGxvX3NlbnQgPSAx
OworICAgICAgICBjaC0+aG9zdF9jYXBzIHw9IDEgPDwgdXNiX3JlZGlyX2NhcF9jb25uZWN0X2Rl
dmljZV92ZXJzaW9uOworICAgICAgICBjaC0+aG9zdF9jYXBzIHw9IDEgPDwgdXNiX3JlZGlyX2Nh
cF9kZXZpY2VfZGlzY29ubmVjdF9hY2s7CisgICAgICAgIGNoLT5ob3N0X2NhcHMgfD0gMSA8PCB1
c2JfcmVkaXJfY2FwX2VwX2luZm9fbWF4X3BhY2tldF9zaXplOworICAgICAgICBjaC0+aG9zdF9j
YXBzIHw9IDEgPDwgdXNiX3JlZGlyX2NhcF82NGJpdHNfaWRzOworICAgICAgICBjaC0+aG9zdF9j
YXBzIHw9IDEgPDwgdXNiX3JlZGlyX2NhcF8zMmJpdHNfYnVsa19sZW5ndGg7CisgICAgfSBlbHNl
IHsKKyAgICAgICAgZmxhZ3MgfD0gdXNicmVkaXJwYXJzZXJfZmxfbm9faGVsbG87CisgICAgfQor
CisgICAgaWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJfY2FwX2Nvbm5lY3RfZGV2
aWNlX3ZlcnNpb24pKSB7CisgICAgICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBz
LCB1c2JfcmVkaXJfY2FwX2Nvbm5lY3RfZGV2aWNlX3ZlcnNpb24pOworICAgIH0KKyAgICB1c2Jy
ZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF9maWx0ZXIpOworICAg
IGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF9kZXZpY2VfZGlzY29ubmVj
dF9hY2spKSB7CisgICAgICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2Jf
cmVkaXJfY2FwX2RldmljZV9kaXNjb25uZWN0X2Fjayk7CisgICAgfQorICAgIGlmIChjaC0+aG9z
dF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF9lcF9pbmZvX21heF9wYWNrZXRfc2l6ZSkpIHsK
KyAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBf
ZXBfaW5mb19tYXhfcGFja2V0X3NpemUpOworICAgIH0KKyAgICBpZiAoY2gtPmhvc3RfY2FwcyAm
ICgxIDw8IHVzYl9yZWRpcl9jYXBfNjRiaXRzX2lkcykpIHsKKyAgICAgICAgdXNicmVkaXJwYXJz
ZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfNjRiaXRzX2lkcyk7CisgICAgfQor
ICAgIGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF8zMmJpdHNfYnVsa19s
ZW5ndGgpKSB7CisgICAgICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2Jf
cmVkaXJfY2FwXzMyYml0c19idWxrX2xlbmd0aCk7CisgICAgfQorICAgIGlmIChjaC0+aG9zdF9j
YXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF9idWxrX3N0cmVhbXMpKSB7CisgICAgICAgIHVzYnJl
ZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJfY2FwX2J1bGtfc3RyZWFtcyk7
CisgICAgfQorICAgIHVzYnJlZGlycGFyc2VyX2luaXQoY2gtPmhpZGRlbl9wYXJzZXIsIFBBQ0tB
R0VfU1RSSU5HLCBjYXBzLCBVU0JfUkVESVJfQ0FQU19TSVpFLCBmbGFncyk7Cit9CisKKy8qCisg
ICAgV2UgY2FuIGluaXRpYWxpemUgdGhlIHVzYnJlZGlycGFyc2VyIHdpdGggSEVMTE8gZW5hYmxl
ZCBvbmx5IGluIGNhc2UKKyAgICB0aGUgbGlidXNiIGlzIG5vdCBhY3RpdmUgYW5kIHRoZSB1c2Jy
ZWRpcmhvc3QgZG9lcyBub3QgZnVuY3Rpb24uCisgICAgVGhlbiB0aGUgcGFyc2VyIHNlbmRzIHNl
c3Npb24gSEVMTE8gYW5kIHJlY2VpdmVzIHNlcnZlcidzIHJlc3BvbnNlLgorICAgIE90aGVyd2lz
ZSAodXNicmVkaXJwYXJzZXIgaW5pdGlhbGl6ZWQgd2l0aCBIRUxMTyBkaXNhYmxlZCk6CisgICAg
LSB0aGUgdXNicmVkaXJob3N0IHNlbmRzIHNlc3Npb24gSEVMTE8KKyAgICAtIHdlIGxvb2sgaW50
byBpdCB0byBrbm93IHNldCBvZiBjYXBhYmlsaXRpZXMgd2Ugc2hhbGwgaW5pdGlhbGl6ZQorICAg
ICAgdGhlIHBhcnNlciB3aXRoCisgICAgLSB3aGVuIHdlIHJlY2VpdmUgc2VydmVyJ3MgcmVzcG9u
c2UgdG8gSEVMTE8gd2UgcHJvdmlkZSBpdCBhbHNvIHRvCisgICAgICBwYXJzZXIgdG8gbGV0IGl0
IHN5bmNocm9uaXplIHdpdGggc2VydmVyJ3MgY2FwYWJpbGl0aWVzCisqLworc3RhdGljIHN0cnVj
dCB1c2JyZWRpcnBhcnNlciAqY3JlYXRlX3BhcnNlcihTcGljZVVzYkJhY2tlbmRDaGFubmVsICpj
aCkKK3sKKyAgICBzdHJ1Y3QgdXNicmVkaXJwYXJzZXIgKnBhcnNlciA9IHVzYnJlZGlycGFyc2Vy
X2NyZWF0ZSgpOworCisgICAgZ19yZXR1cm5fdmFsX2lmX2ZhaWwocGFyc2VyICE9IE5VTEwsIE5V
TEwpOworCisgICAgcGFyc2VyLT5wcml2ID0gY2g7CisgICAgcGFyc2VyLT5sb2dfZnVuYyA9IHVz
YnJlZGlyX2xvZzsKKyAgICBwYXJzZXItPnJlYWRfZnVuYyA9IHVzYnJlZGlyX3JlYWRfY2FsbGJh
Y2s7CisgICAgcGFyc2VyLT53cml0ZV9mdW5jID0gdXNicmVkaXJfd3JpdGVfY2FsbGJhY2s7Cisg
ICAgcGFyc2VyLT5yZXNldF9mdW5jID0gdXNicmVkaXJfZGV2aWNlX3Jlc2V0OworICAgIHBhcnNl
ci0+c2V0X2NvbmZpZ3VyYXRpb25fZnVuYyA9IHVzYnJlZGlyX3NldF9jb25maWd1cmF0aW9uOwor
ICAgIHBhcnNlci0+Z2V0X2NvbmZpZ3VyYXRpb25fZnVuYyA9IHVzYnJlZGlyX2dldF9jb25maWd1
cmF0aW9uOworICAgIHBhcnNlci0+c2V0X2FsdF9zZXR0aW5nX2Z1bmMgPSB1c2JyZWRpcl9zZXRf
YWx0X3NldHRpbmc7CisgICAgcGFyc2VyLT5nZXRfYWx0X3NldHRpbmdfZnVuYyA9IHVzYnJlZGly
X2dldF9hbHRfc2V0dGluZzsKKyAgICBwYXJzZXItPmNhbmNlbF9kYXRhX3BhY2tldF9mdW5jID0g
dXNicmVkaXJfY2FuY2VsX2RhdGE7CisgICAgcGFyc2VyLT5jb250cm9sX3BhY2tldF9mdW5jID0g
dXNicmVkaXJfY29udHJvbF9wYWNrZXQ7CisgICAgcGFyc2VyLT5idWxrX3BhY2tldF9mdW5jID0g
dXNicmVkaXJfYnVsa19wYWNrZXQ7CisgICAgcGFyc2VyLT5hbGxvY19sb2NrX2Z1bmMgPSB1c2Jy
ZWRpcl9hbGxvY19sb2NrOworICAgIHBhcnNlci0+bG9ja19mdW5jID0gdXNicmVkaXJfbG9ja19s
b2NrOworICAgIHBhcnNlci0+dW5sb2NrX2Z1bmMgPSB1c2JyZWRpcl91bmxvY2tfbG9jazsKKyAg
ICBwYXJzZXItPmZyZWVfbG9ja19mdW5jID0gdXNicmVkaXJfZnJlZV9sb2NrOworICAgIHBhcnNl
ci0+aGVsbG9fZnVuYyA9IHVzYnJlZGlyX2hlbGxvOworICAgIHBhcnNlci0+ZmlsdGVyX3JlamVj
dF9mdW5jID0gdXNicmVkaXJfZmlsdGVyX3JlamVjdDsKKyAgICBwYXJzZXItPmRldmljZV9kaXNj
b25uZWN0X2Fja19mdW5jID0gdXNicmVkaXJfZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrOworICAgIHBh
cnNlci0+aW50ZXJmYWNlX2luZm9fZnVuYyA9IHVzYnJlZGlyX2ludGVyZmFjZV9pbmZvOworICAg
IHBhcnNlci0+ZXBfaW5mb19mdW5jID0gdXNicmVkaXJfaW50ZXJmYWNlX2VwX2luZm87CisgICAg
cGFyc2VyLT5maWx0ZXJfZmlsdGVyX2Z1bmMgPSB1c2JyZWRpcl9maWx0ZXJfZmlsdGVyOworCisg
ICAgcmV0dXJuIHBhcnNlcjsKK30KKworc3RhdGljIGdib29sZWFuIGF0dGFjaF9lZGV2KFNwaWNl
VXNiQmFja2VuZENoYW5uZWwgKmNoLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNwaWNl
VXNiQmFja2VuZERldmljZSAqZGV2LAorICAgICAgICAgICAgICAgICAgICAgICAgICAgIEdFcnJv
ciAqKmVycm9yKQoreworICAgIGlmICghZGV2LT5lZGV2KSB7CisgICAgICAgIGdfc2V0X2Vycm9y
KGVycm9yLCBTUElDRV9DTElFTlRfRVJST1IsIFNQSUNFX0NMSUVOVF9FUlJPUl9GQUlMRUQsCisg
ICAgICAgICAgIF8oIkZhaWxlZCB0byByZWRpcmVjdCBkZXZpY2UgJWQiKSwgMSk7CisgICAgICAg
IHJldHVybiBGQUxTRTsKKyAgICB9CisgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QgJiYgIWNoLT5o
ZWxsb19kb25lX3BhcnNlcikgeworICAgICAgICAvKgorICAgICAgICAgICAgd2UgY2FuJ3QgaW5p
dGlhbGl6ZSBwYXJzZXIgdW50aWwgd2Ugc2VlIGhlbGxvIGZyb20gdXNicmVkaXIKKyAgICAgICAg
ICAgIGFuZCB0aGUgcGFyc2VyIGNhbid0IHdvcmsgdW50aWwgaXQgc2VlcyB0aGUgaGVsbG8gcmVz
cG9uc2UuCisgICAgICAgICAgICB0aGlzIGlzIGNhc2Ugb2YgYXV0b2Nvbm5lY3Qgd2hlbiBlbXVs
YXRlZCBkZXZpY2UgaXMgYXR0YWNoZWQKKyAgICAgICAgICAgIGJlZm9yZSB0aGUgY2hhbm5lbCBp
cyB1cAorICAgICAgICAqLworICAgICAgICBTUElDRV9ERUJVRygiJXMgd2FpdGluZyB1bnRpbCB0
aGUgY2hhbm5lbCBpcyByZWFkeSIsIF9fRlVOQ1RJT05fXyk7CisKKyAgICB9IGVsc2UgeworICAg
ICAgICBpbml0aWFsaXplX3BhcnNlcihjaCwgY2gtPmhpZGRlbl9ob3N0ID09IE5VTEwpOworICAg
ICAgICBjaC0+dXNicmVkaXJob3N0ID0gTlVMTDsKKyAgICAgICAgY2gtPnBhcnNlciA9IGNoLT5o
aWRkZW5fcGFyc2VyOworICAgIH0KKyAgICBjaC0+d2FpdF9kaXNjb25uZWN0X2FjayA9IDA7Cisg
ICAgY2gtPmF0dGFjaGVkID0gZGV2OworICAgIGRldi0+YXR0YWNoZWRfdG8gPSBjaDsKKyAgICBk
ZXZpY2Vfb3BzKGRldi0+ZWRldiktPmF0dGFjaChkZXYtPmVkZXYsIGNoLT5oaWRkZW5fcGFyc2Vy
KTsKKyAgICBpZiAoY2gtPmhlbGxvX2RvbmVfcGFyc2VyKSB7CisgICAgICAgIC8qIHNlbmQgZGV2
aWNlIGluZm8gKi8KKyAgICAgICAgdXNicmVkaXJfaGVsbG8oY2gsIE5VTEwpOworICAgIH0KKyAg
ICByZXR1cm4gVFJVRTsKK30KKwogZ2Jvb2xlYW4gc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9h
dHRhY2goU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsCiAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICBTcGljZVVzYkJhY2tlbmREZXZpY2UgKmRldiwKICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEdFcnJvciAqKmVycm9yKQpAQCAtNzA2
LDcgKzEyMTQsMTMgQEAgZ2Jvb2xlYW4gc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9hdHRhY2go
U3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsCiAKICAgICBnX3JldHVybl92YWxfaWZfZmFpbChk
ZXYgIT0gTlVMTCwgRkFMU0UpOwogCisgICAgaWYgKCFkZXYtPmxpYnVzYl9kZXZpY2UpIHsKKyAg
ICAgICAgcmV0dXJuIGF0dGFjaF9lZGV2KGNoLCBkZXYsIGVycm9yKTsKKyAgICB9CisKICAgICBs
aWJ1c2JfZGV2aWNlX2hhbmRsZSAqaGFuZGxlID0gTlVMTDsKKyAgICBjaC0+dXNicmVkaXJob3N0
ID0gY2gtPmhpZGRlbl9ob3N0OworICAgIGNoLT5wYXJzZXIgPSBOVUxMOwogCiAgICAgLyoKICAg
ICAgICBVbmRlciBXaW5kb3dzIHdlIG5lZWQgdG8gYXZvaWQgdXBkYXRpbmcKQEAgLTc0MCwxOCAr
MTI1NCwzMyBAQCBnYm9vbGVhbiBzcGljZV91c2JfYmFja2VuZF9jaGFubmVsX2F0dGFjaChTcGlj
ZVVzYkJhY2tlbmRDaGFubmVsICpjaCwKIAogdm9pZCBzcGljZV91c2JfYmFja2VuZF9jaGFubmVs
X2RldGFjaChTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCkKIHsKKyAgICBTcGljZVVzYkJhY2tl
bmREZXZpY2UgKmQgPSBjaC0+YXR0YWNoZWQ7CisgICAgU3BpY2VVc2JFbXVsYXRlZERldmljZSAq
ZWRldiA9IGQgPyBkLT5lZGV2IDogTlVMTDsKICAgICBTUElDRV9ERUJVRygiJXMgPj4gY2ggJXAs
IHdhcyBhdHRhY2hlZCAlcCIsIF9fRlVOQ1RJT05fXywgY2gsIGNoLT5hdHRhY2hlZCk7Ci0gICAg
aWYgKCFjaC0+YXR0YWNoZWQpIHsKKyAgICBpZiAoIWQpIHsKICAgICAgICAgU1BJQ0VfREVCVUco
IiVzOiBub3RoaW5nIHRvIGRldGFjaCIsIF9fRlVOQ1RJT05fXyk7CiAgICAgICAgIHJldHVybjsK
ICAgICB9CiAgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKICAgICAgICAgLyogaXQgd2lsbCBj
YWxsIGxpYnVzYl9jbG9zZSBpbnRlcm5hbGx5ICovCiAgICAgICAgIHVzYnJlZGlyaG9zdF9zZXRf
ZGV2aWNlKGNoLT51c2JyZWRpcmhvc3QsIE5VTEwpOworICAgIH0gZWxzZSBpZiAoY2gtPnBhcnNl
cikgeworICAgICAgICBpZiAoZWRldikgeworICAgICAgICAgICAgZGV2aWNlX29wcyhlZGV2KS0+
ZGV0YWNoKGVkZXYpOworICAgICAgICB9CisgICAgICAgIHVzYnJlZGlycGFyc2VyX3NlbmRfZGV2
aWNlX2Rpc2Nvbm5lY3QoY2gtPnBhcnNlcik7CisgICAgICAgIHVzYnJlZGlyX3dyaXRlX2ZsdXNo
X2NhbGxiYWNrKGNoKTsKKyAgICAgICAgY2gtPndhaXRfZGlzY29ubmVjdF9hY2sgPQorICAgICAg
ICAgICAgdXNicmVkaXJwYXJzZXJfcGVlcl9oYXNfY2FwKGNoLT5wYXJzZXIsIHVzYl9yZWRpcl9j
YXBfZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrKTsKKyAgICAgICAgaWYgKCFjaC0+d2FpdF9kaXNjb25u
ZWN0X2FjaykgeworICAgICAgICAgICAgY2gtPnVzYnJlZGlyaG9zdCA9IGNoLT5oaWRkZW5faG9z
dDsKKyAgICAgICAgICAgIGNoLT5wYXJzZXIgPSBOVUxMOworICAgICAgICB9CiAgICAgfQogICAg
IFNQSUNFX0RFQlVHKCIlcyBjaCAlcCwgZGV0YWNoIGRvbmUiLCBfX0ZVTkNUSU9OX18sIGNoKTsK
ICAgICBjaC0+YXR0YWNoZWQtPmF0dGFjaGVkX3RvID0gTlVMTDsKICAgICBjaC0+YXR0YWNoZWQg
PSBOVUxMOworICAgIGNoLT5yZWplY3RlZCA9IDA7CiB9CiAKIFNwaWNlVXNiQmFja2VuZENoYW5u
ZWwgKnNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfbmV3KFNwaWNlVXNiQmFja2VuZCAqYmUsCkBA
IC03NjYsMjYgKzEyOTUsMzMgQEAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqc3BpY2VfdXNiX2Jh
Y2tlbmRfY2hhbm5lbF9uZXcoU3BpY2VVc2JCYWNrZW5kICpiZSwKICAgICBjaC0+dXNlcl9kYXRh
ID0gU1BJQ0VfVVNCUkVESVJfQ0hBTk5FTCh1c2VyX2RhdGEpOwogICAgIGlmIChiZS0+bGlidXNi
X2NvbnRleHQpIHsKICAgICAgICAgY2gtPmJhY2tlbmQgPSBiZTsKLSAgICAgICAgY2gtPnVzYnJl
ZGlyaG9zdCA9IHVzYnJlZGlyaG9zdF9vcGVuX2Z1bGwoCi0gICAgICAgICAgICBiZS0+bGlidXNi
X2NvbnRleHQsCi0gICAgICAgICAgICBOVUxMLAotICAgICAgICAgICAgdXNicmVkaXJfbG9nLAot
ICAgICAgICAgICAgdXNicmVkaXJfcmVhZF9jYWxsYmFjaywKLSAgICAgICAgICAgIHVzYnJlZGly
X3dyaXRlX2NhbGxiYWNrLAotICAgICAgICAgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJh
Y2ssCi0gICAgICAgICAgICB1c2JyZWRpcl9hbGxvY19sb2NrLAotICAgICAgICAgICAgdXNicmVk
aXJfbG9ja19sb2NrLAotICAgICAgICAgICAgdXNicmVkaXJfdW5sb2NrX2xvY2ssCi0gICAgICAg
ICAgICB1c2JyZWRpcl9mcmVlX2xvY2ssCi0gICAgICAgICAgICBjaCwgUEFDS0FHRV9TVFJJTkcs
Ci0gICAgICAgICAgICBzcGljZV91dGlsX2dldF9kZWJ1ZygpID8gdXNicmVkaXJwYXJzZXJfZGVi
dWcgOiB1c2JyZWRpcnBhcnNlcl93YXJuaW5nLAotICAgICAgICAgICAgdXNicmVkaXJob3N0X2Zs
X3dyaXRlX2NiX293bnNfYnVmZmVyKTsKKyAgICAgICAgY2gtPnVzYnJlZGlyaG9zdCA9CisgICAg
ICAgICAgICB1c2JyZWRpcmhvc3Rfb3Blbl9mdWxsKGJlLT5saWJ1c2JfY29udGV4dCwKKyAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTlVMTCwKKyAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgdXNicmVkaXJfbG9nLAorICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICB1c2JyZWRpcl9yZWFkX2NhbGxiYWNrLAorICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICB1c2JyZWRpcl93cml0ZV9jYWxsYmFjaywKKyAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2ssCisgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIHVzYnJlZGlyX2FsbG9jX2xvY2ssCisgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIHVzYnJlZGlyX2xvY2tfbG9jaywKKyAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgdXNicmVkaXJfdW5sb2NrX2xvY2ssCisgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIHVzYnJlZGlyX2ZyZWVfbG9jaywKKyAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgY2gsIFBBQ0tBR0VfU1RSSU5HLAorICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICBzcGljZV91dGlsX2dldF9kZWJ1ZygpID8gdXNicmVkaXJw
YXJzZXJfZGVidWcgOgorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVz
YnJlZGlycGFyc2VyX3dhcm5pbmcsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
IHVzYnJlZGlyaG9zdF9mbF93cml0ZV9jYl9vd25zX2J1ZmZlcik7CiAgICAgICAgIGdfd2Fybl9p
Zl9mYWlsKGNoLT51c2JyZWRpcmhvc3QgIT0gTlVMTCk7CiAgICAgfQorCiAgICAgaWYgKGNoLT51
c2JyZWRpcmhvc3QpIHsKLSAgICAgICAgdXNicmVkaXJob3N0X3NldF9idWZmZXJlZF9vdXRwdXRf
c2l6ZV9jYihjaC0+dXNicmVkaXJob3N0LCB1c2JyZWRpcl9idWZmZXJlZF9vdXRwdXRfc2l6ZV9j
YWxsYmFjayk7Ci0gICAgfSBlbHNlIHsKLSAgICAgICAgZ19mcmVlKGNoKTsKKyAgICAgICAgY2gt
PmhpZGRlbl9wYXJzZXIgPSBjcmVhdGVfcGFyc2VyKGNoKTsKKyAgICAgICAgY2gtPmhpZGRlbl9o
b3N0ID0gY2gtPnVzYnJlZGlyaG9zdDsKKyAgICAgICAgdXNicmVkaXJob3N0X3NldF9idWZmZXJl
ZF9vdXRwdXRfc2l6ZV9jYihjaC0+dXNicmVkaXJob3N0LAorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzYnJlZGlyX2J1ZmZlcmVkX291dHB1dF9zaXpl
X2NhbGxiYWNrKTsKKyAgICB9CisKKyAgICBpZiAoIWNoLT5oaWRkZW5fcGFyc2VyKSB7CisgICAg
ICAgIHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfZGVsZXRlKGNoKTsKICAgICAgICAgY2ggPSBO
VUxMOwogICAgIH0KIApAQCAtNzk1LDkgKzEzMzEsMTQgQEAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5l
bCAqc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9uZXcoU3BpY2VVc2JCYWNrZW5kICpiZSwKIAog
dm9pZCBzcGljZV91c2JfYmFja2VuZF9jaGFubmVsX2ZsdXNoX3dyaXRlcyhTcGljZVVzYkJhY2tl
bmRDaGFubmVsICpjaCkKIHsKLSAgICBTUElDRV9ERUJVRygiJXMgJXAsIGhvc3QgJXAiLCBfX0ZV
TkNUSU9OX18sIGNoLCBjaC0+dXNicmVkaXJob3N0KTsKKyAgICBTUElDRV9ERUJVRygiJXMgJXAg
aXMgdXAiLCBfX0ZVTkNUSU9OX18sIGNoKTsKICAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgewog
ICAgICAgICB1c2JyZWRpcmhvc3Rfd3JpdGVfZ3Vlc3RfZGF0YShjaC0+dXNicmVkaXJob3N0KTsK
KyAgICAgICAgaW5pdGlhbGl6ZV9wYXJzZXIoY2gsIEZBTFNFKTsKKyAgICB9IGVsc2UgeworICAg
ICAgICBpbml0aWFsaXplX3BhcnNlcihjaCwgVFJVRSk7CisgICAgICAgIGNoLT5wYXJzZXIgPSBj
aC0+aGlkZGVuX3BhcnNlcjsKKyAgICAgICAgdXNicmVkaXJwYXJzZXJfZG9fd3JpdGUoY2gtPnBh
cnNlcik7CiAgICAgfQogfQogCkBAIC04MDcsMTIgKzEzNDgsMTYgQEAgdm9pZCBzcGljZV91c2Jf
YmFja2VuZF9jaGFubmVsX2RlbGV0ZShTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCkKICAgICBp
ZiAoIWNoKSB7CiAgICAgICAgIHJldHVybjsKICAgICB9Ci0gICAgaWYgKGNoLT51c2JyZWRpcmhv
c3QpIHsKLSAgICAgICAgdXNicmVkaXJob3N0X2Nsb3NlKGNoLT51c2JyZWRpcmhvc3QpOworICAg
IGlmIChjaC0+aGlkZGVuX2hvc3QpIHsKKyAgICAgICAgdXNicmVkaXJob3N0X2Nsb3NlKGNoLT5o
aWRkZW5faG9zdCk7CisgICAgfQorICAgIGlmIChjaC0+aGlkZGVuX3BhcnNlcikgeworICAgICAg
ICB1c2JyZWRpcnBhcnNlcl9kZXN0cm95KGNoLT5oaWRkZW5fcGFyc2VyKTsKICAgICB9CiAKICAg
ICBpZiAoY2gtPnJ1bGVzKSB7Ci0gICAgICAgIGdfZnJlZShjaC0+cnVsZXMpOworICAgICAgICAv
KiBydWxlcyB3ZXJlIGFsbG9jYXRlZCBieSB1c2JyZWRpcnBhcnNlciAqLworICAgICAgICBmcmVl
KGNoLT5ydWxlcyk7CiAgICAgfQogCiAgICAgZ19mcmVlKGNoKTsKLS0gCjIuMjAuMQoKX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KU3BpY2UtZGV2ZWwgbWFp
bGluZyBsaXN0ClNwaWNlLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3Rz
LmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL3NwaWNlLWRldmVs
