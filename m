Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id ED63B80C1D
	for <lists+spice-devel@lfdr.de>; Sun,  4 Aug 2019 21:16:41 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 5759C89E33;
	Sun,  4 Aug 2019 19:16:40 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mail-wm1-x343.google.com (mail-wm1-x343.google.com
 [IPv6:2a00:1450:4864:20::343])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 7F03089DA6
 for <spice-devel@lists.freedesktop.org>; Sun,  4 Aug 2019 19:16:38 +0000 (UTC)
Received: by mail-wm1-x343.google.com with SMTP id f17so70983446wme.2
 for <spice-devel@lists.freedesktop.org>; Sun, 04 Aug 2019 12:16:38 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references;
 bh=Ll2frJvyxBQK+p5RKNdE9iIJ5PoKkUrd1iIFdnx9jxg=;
 b=piVkWgvxiDhJLDcoAA7NANRvf6tQ0nad6rjflK1aCbWcl1FaUyuDv/vmw1eD5UieDs
 9JvPQVxGfviQpta6+45w9x2UBGDpMGnj4YIzZRx2D0flgLQdLc6qkZTbAw+uDGXRDr7c
 l7B9urroMAb4wosY1OJlrfuSvK4BBkDhrIh75b23dc644cUB17w8Yvtg9qVA2PMgnk6w
 pxTP/ownbm1vXhHbSQ53MPTMoxxqY7h/UVlCmgxBFRNCLb8rGqoVUeDCWX7pSKkGvbkl
 4x/XrrQhMYPYMtE2ehf8T4x2oint2S5U8Gz9nQYeVaxBbCORTEWmWEgcPtByLg6uPp4u
 ABCg==
X-Gm-Message-State: APjAAAUaJVac+eR9vnGQ9EBqB87XNl7nwGki85PomjzQ9vcY51/Q4FPU
 pseZoXzjJIyzWfIiNP0+COo+dXaK
X-Google-Smtp-Source: APXvYqzE+cs5pmaIIumU6ImLMfUS93mUpAmA9W5HBj3AWDtJyUCJhq/3NPkRwAIgYOFCSJv9qSXnDQ==
X-Received: by 2002:a1c:ed09:: with SMTP id l9mr14825373wmh.58.1564946196316; 
 Sun, 04 Aug 2019 12:16:36 -0700 (PDT)
Received: from f2.redhat.com (bzq-79-182-115-245.red.bezeqint.net.
 [79.182.115.245])
 by smtp.gmail.com with ESMTPSA id f204sm136527687wme.18.2019.08.04.12.16.35
 (version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
 Sun, 04 Aug 2019 12:16:35 -0700 (PDT)
From: Yuri Benditovich <yuri.benditovich@daynix.com>
To: spice-devel@lists.freedesktop.org
Date: Sun,  4 Aug 2019 22:16:20 +0300
Message-Id: <20190804191624.29235-5-yuri.benditovich@daynix.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190804191624.29235-1-yuri.benditovich@daynix.com>
References: <20190804191624.29235-1-yuri.benditovich@daynix.com>
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=daynix-com.20150623.gappssmtp.com; s=20150623;
 h=from:to:cc:subject:date:message-id:in-reply-to:references;
 bh=Ll2frJvyxBQK+p5RKNdE9iIJ5PoKkUrd1iIFdnx9jxg=;
 b=il2ERjIPl9INU2bKQ6+Ru3rrf2f/J3AnQzgJCVG70RowWvfWFo9Txtc3kkhTWeJttq
 dPtfZfR981aYuMGHwJ3ywTvcAt+Co7BWvHbj6tzasK6n8QW9+oOigvFulG10y8+H+Wly
 9ASKDeEsLGzvITsopCKa+PmzOnkVDmK3ssrIctjxNEUBUjiwQvIYurImlEo7Ev0J+GNm
 L65PGa5QL7uyKMmONEDe8IElVc+/UkJ4sTnxXIWL/NdQxt7QKLNeCd6/hIduj8f8ux7C
 AMXpn3slbvNKYvcDiEX6BXIjJEbeHUg1xfyx+MnBdfZaE37SHYeY1NCi6T3+lY63Cdru
 9PxQ==
Subject: [Spice-devel] [spice-gtk v2 4/8] usb-redir: extend USB backend to
 support emulated devices
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: yan@daynix.com
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

UmVkaXJlY3Rpb24gb2YgZW11bGF0ZWQgZGV2aWNlcyByZXF1aXJlcyBzcGVjaWFsIGFwcHJvYWNo
LAphcyB1c2JyZWRpcmhvc3QgY2FuJ3QgYmUgdXNlZCBmb3IgdGhhdCAoaXQgd29ya3Mgb25seSB3
aXRoCmxpYnVzYiBkZXZpY2VzKS4gRm9yIGVtdWxhdGVkIGRldmljZXMgd2UgY3JlYXRlIGluc3Rh
bmNlIG9mCnVzYnJlZGlycGFyc2VyIHRoYXQgaW1wbGVtZW50cyBVU0IgcmVkaXJlY3Rpb24gcHJv
dG9jb2wuCkluIG9yZGVyIHRvIHdvcmsgd2l0aCB0aGUgc2FtZSBzZXQgb2YgcHJvdG9jb2wgY2Fw
YWJpbGl0aWVzCnRoYXQgdXNicmVkaXJob3N0IHNldHMgdXAgd2l0aCByZW1vdGUgc2lkZSwgdGhl
IHBhcnNlciBzaGFsbDoKLSBub3Qgc2VuZCBpdHMgb3duICdoZWxsbycgdG8gdGhlIHNlcnZlcgot
IGluaXRpYWxpemUgdGhlIHNhbWUgY2FwYWJpbGl0aWVzIHRoYXQgdXNicmVkaXJob3N0Ci0gcmVj
ZWl2ZSB0aGUgc2FtZSAnaGVsbG8nIHJlc3BvbnNlCkZvciB0aGF0IHdlIGFuYWx5emUgJ2hlbGxv
JyBzZW50IGJ5IFVTQiByZWRpciBwYXJzZXIgYW5kCmV4dHJhY3Qgc2V0IG9mIGNhcGFiaWxpdGll
cyBmcm9tIGl0IGFuZCB1cG9uIHJlY2VpdmUgb2YKJ2hlbGxvJyByZXNwb25zZSB3ZSBwcm92aWRl
IGl0IGFsc28gdG8gdGhlIHBhcnNlci4KV2hlbiBsaWJ1c2IgZGV2aWNlIGlzIHJlZGlyZWN0ZWQg
dmlhIGEgY2hhbm5lbCwgaW5zdGFuY2Ugb2YKdXNicmVkaXJob3N0IHNlcnZlcyBpdC4KV2hlbiBl
bXVsYXRlZCBkZXZpY2UgaXMgcmVkaXJlY3RlZCB2aWEgYSBjaGFubmVsLCBpbnN0YW5jZQpvZiB1
c2JyZWRpcnBhcnNlciBkb2VzIHRoZSBqb2IuCgpTaWduZWQtb2ZmLWJ5OiBZdXJpIEJlbmRpdG92
aWNoIDx5dXJpLmJlbmRpdG92aWNoQGRheW5peC5jb20+Ci0tLQogc3JjL3VzYi1iYWNrZW5kLmMg
fCA1ODUgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKystLQogMSBm
aWxlIGNoYW5nZWQsIDU2OCBpbnNlcnRpb25zKCspLCAxNyBkZWxldGlvbnMoLSkKCmRpZmYgLS1n
aXQgYS9zcmMvdXNiLWJhY2tlbmQuYyBiL3NyYy91c2ItYmFja2VuZC5jCmluZGV4IDNhOGEyOGUu
LmE0MTgzNDggMTAwNjQ0Ci0tLSBhL3NyYy91c2ItYmFja2VuZC5jCisrKyBiL3NyYy91c2ItYmFj
a2VuZC5jCkBAIC01NSw2ICs1NSw3IEBAIHN0cnVjdCBfU3BpY2VVc2JCYWNrZW5kRGV2aWNlCiAg
ICAgZ2ludCByZWZfY291bnQ7CiAgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqYXR0YWNoZWRf
dG87CiAgICAgVXNiRGV2aWNlSW5mb3JtYXRpb24gZGV2aWNlX2luZm87CisgICAgZ2Jvb2xlYW4g
ZWRldl9jb25maWd1cmVkOwogfTsKIAogc3RydWN0IF9TcGljZVVzYkJhY2tlbmQKQEAgLTgwLDEw
ICs4MSwyMCBAQCBzdHJ1Y3QgX1NwaWNlVXNiQmFja2VuZAogc3RydWN0IF9TcGljZVVzYkJhY2tl
bmRDaGFubmVsCiB7CiAgICAgc3RydWN0IHVzYnJlZGlyaG9zdCAqdXNicmVkaXJob3N0OworICAg
IHN0cnVjdCB1c2JyZWRpcmhvc3QgKmhpZGRlbl9ob3N0OworICAgIHN0cnVjdCB1c2JyZWRpcnBh
cnNlciAqcGFyc2VyOworICAgIHN0cnVjdCB1c2JyZWRpcnBhcnNlciAqaGlkZGVuX3BhcnNlcjsK
ICAgICB1aW50OF90ICpyZWFkX2J1ZjsKICAgICBpbnQgcmVhZF9idWZfc2l6ZTsKICAgICBzdHJ1
Y3QgdXNicmVkaXJmaWx0ZXJfcnVsZSAqcnVsZXM7CiAgICAgaW50IHJ1bGVzX2NvdW50OworICAg
IHVpbnQzMl90IGhvc3RfY2FwczsKKyAgICB1aW50MzJfdCBwYXJzZXJfaW5pdF9kb25lICA6IDE7
CisgICAgdWludDMyX3QgcGFyc2VyX3dpdGhfaGVsbG8gOiAxOworICAgIHVpbnQzMl90IGhlbGxv
X2RvbmVfcGFyc2VyIDogMTsKKyAgICB1aW50MzJfdCBoZWxsb19zZW50ICAgICAgICA6IDE7Cisg
ICAgdWludDMyX3QgcmVqZWN0ZWQgICAgICAgICAgOiAxOworICAgIHVpbnQzMl90IHdhaXRfZGlz
Y19hY2sgICAgIDogMTsKICAgICBTcGljZVVzYkJhY2tlbmREZXZpY2UgKmF0dGFjaGVkOwogICAg
IFNwaWNlVXNicmVkaXJDaGFubmVsICAqdXNlcl9kYXRhOwogICAgIFNwaWNlVXNiQmFja2VuZCAq
YmFja2VuZDsKQEAgLTM1NSw3ICszNjYsMTEgQEAgZ2Jvb2xlYW4gc3BpY2VfdXNiX2JhY2tlbmRf
ZGV2aWNlX2lzb2NoKFNwaWNlVXNiQmFja2VuZERldmljZSAqZGV2KQogICAgIGdpbnQgaSwgaiwg
azsKICAgICBpbnQgcmM7CiAKLSAgICBnX3JldHVybl92YWxfaWZfZmFpbChsaWJkZXYgIT0gTlVM
TCwgMCk7CisgICAgZ19yZXR1cm5fdmFsX2lmX2ZhaWwobGliZGV2ICE9IE5VTEwgfHwgZGV2LT5l
ZGV2ICE9IE5VTEwsIDApOworICAgIGlmIChkZXYtPmVkZXYpIHsKKyAgICAgICAgLyogY3VycmVu
dGx5IHdlIGRvIG5vdCBlbXVsYXRlIGlzb2NoIGRldmljZXMgKi8KKyAgICAgICAgcmV0dXJuIEZB
TFNFOworICAgIH0KIAogICAgIHJjID0gbGlidXNiX2dldF9hY3RpdmVfY29uZmlnX2Rlc2NyaXB0
b3IobGliZGV2LCAmY29uZl9kZXNjKTsKICAgICBpZiAocmMpIHsKQEAgLTM5MCwxMyArNDA1LDE2
IEBAIGZyb20gYm90aCB0aGUgbWFpbiB0aHJlYWQgYXMgd2VsbCBhcyBmcm9tIHRoZSB1c2IgZXZl
bnQgaGFuZGxpbmcgdGhyZWFkICovCiBzdGF0aWMgdm9pZCB1c2JyZWRpcl93cml0ZV9mbHVzaF9j
YWxsYmFjayh2b2lkICp1c2VyX2RhdGEpCiB7CiAgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAq
Y2ggPSB1c2VyX2RhdGE7Ci0gICAgaWYgKCFjaC0+dXNicmVkaXJob3N0KSB7Ci0gICAgICAgIC8q
IGp1c3QgdG8gYmUgb24gdGhlIHNhZmUgc2lkZSAqLwotICAgICAgICByZXR1cm47Ci0gICAgfQog
ICAgIGlmIChpc19jaGFubmVsX3JlYWR5KGNoLT51c2VyX2RhdGEpKSB7Ci0gICAgICAgIFNQSUNF
X0RFQlVHKCIlcyBjaCAlcCAtPiB1c2JyZWRpcmhvc3QiLCBfX0ZVTkNUSU9OX18sIGNoKTsKLSAg
ICAgICAgdXNicmVkaXJob3N0X3dyaXRlX2d1ZXN0X2RhdGEoY2gtPnVzYnJlZGlyaG9zdCk7Cisg
ICAgICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7CisgICAgICAgICAgICBTUElDRV9ERUJVRygi
JXMgY2ggJXAgLT4gdXNicmVkaXJob3N0IiwgX19GVU5DVElPTl9fLCBjaCk7CisgICAgICAgICAg
ICB1c2JyZWRpcmhvc3Rfd3JpdGVfZ3Vlc3RfZGF0YShjaC0+dXNicmVkaXJob3N0KTsKKyAgICAg
ICAgfSBlbHNlIGlmIChjaC0+cGFyc2VyKSB7CisgICAgICAgICAgICBTUElDRV9ERUJVRygiJXMg
Y2ggJXAgLT4gcGFyc2VyIiwgX19GVU5DVElPTl9fLCBjaCk7CisgICAgICAgICAgICB1c2JyZWRp
cnBhcnNlcl9kb193cml0ZShjaC0+cGFyc2VyKTsKKyAgICAgICAgfSBlbHNlIHsKKyAgICAgICAg
ICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAoTk9UIEFDVElWRSkiLCBfX0ZVTkNUSU9OX18sIGNo
KTsKKyAgICAgICAgfQogICAgIH0gZWxzZSB7CiAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAl
cCAobm90IHJlYWR5KSIsIF9fRlVOQ1RJT05fXywgY2gpOwogICAgIH0KQEAgLTU1MSwxMyArNTY5
LDU3IEBAIHZvaWQgc3BpY2VfdXNiX2JhY2tlbmRfZGV2aWNlX3VucmVmKFNwaWNlVXNiQmFja2Vu
ZERldmljZSAqZGV2KQogICAgIH0KIH0KIAorc3RhdGljIGludCBjaGVja19lZGV2X2RldmljZV9m
aWx0ZXIoU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkZXYsCisgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICBjb25zdCBzdHJ1Y3QgdXNicmVkaXJmaWx0ZXJfcnVsZSAqcnVsZXMsCisg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnQgY291bnQpCit7CisgICAgU3Bp
Y2VVc2JFbXVsYXRlZERldmljZSAqZWRldiA9IGRldi0+ZWRldjsKKyAgICB1aW50OF90IGNsc1sz
Ml0sIHN1YmNsc1szMl0sIHByb3RvWzMyXSwgKmNmZywgaWZudW0gPSAwOworICAgIHVpbnQxNl90
IHNpemUsIG9mZnNldCA9IDA7CisgICAgaWYgKCFlZGV2KSB7CisgICAgICAgIHJldHVybiAxOwor
ICAgIH0KKyAgICBpZiAoIWRldmljZV9vcHMoZWRldiktPmdldF9kZXNjcmlwdG9yKAorICAgICAg
ICAgICAgZWRldiwgTElCVVNCX0RUX0NPTkZJRywgMCwgKHZvaWQgKiopJmNmZywgJnNpemUpKSB7
CisgICAgICAgIHJldHVybiAxOworICAgIH0KKyAgICB3aGlsZSAoKG9mZnNldCArIDEpIDwgc2l6
ZSkgeworICAgICAgICB1aW50OF90IGxlbiAgPSBjZmdbb2Zmc2V0XTsKKyAgICAgICAgdWludDhf
dCB0eXBlID0gY2ZnW29mZnNldCArIDFdOworICAgICAgICBpZiAoKG9mZnNldCArIGxlbikgPiBz
aXplKSB7CisgICAgICAgICAgICBicmVhazsKKyAgICAgICAgfQorICAgICAgICBpZiAodHlwZSA9
PSBMSUJVU0JfRFRfSU5URVJGQUNFKSB7CisgICAgICAgICAgICBjbHNbaWZudW1dID0gY2ZnW29m
ZnNldCArIDVdOworICAgICAgICAgICAgc3ViY2xzW2lmbnVtXSA9IGNmZ1tvZmZzZXQgKyA2XTsK
KyAgICAgICAgICAgIHByb3RvW2lmbnVtXSA9IGNmZ1tvZmZzZXQgKyA3XTsKKyAgICAgICAgICAg
IGlmbnVtKys7CisgICAgICAgIH0KKyAgICAgICAgb2Zmc2V0ICs9IGxlbjsKKyAgICB9CisKKyAg
ICByZXR1cm4gdXNicmVkaXJmaWx0ZXJfY2hlY2soCisgICAgICAgIHJ1bGVzLCBjb3VudCwKKyAg
ICAgICAgZGV2LT5kZXZpY2VfaW5mby5jbGFzcywKKyAgICAgICAgZGV2LT5kZXZpY2VfaW5mby5z
dWJjbGFzcywKKyAgICAgICAgZGV2LT5kZXZpY2VfaW5mby5wcm90b2NvbCwKKyAgICAgICAgY2xz
LCBzdWJjbHMsIHByb3RvLCBpZm51bSwKKyAgICAgICAgZGV2LT5kZXZpY2VfaW5mby52aWQsCisg
ICAgICAgIGRldi0+ZGV2aWNlX2luZm8ucGlkLAorICAgICAgICBkZXYtPmRldmljZV9pbmZvLmJj
ZFVTQiwgMCk7Cit9CisKIGludCBzcGljZV91c2JfYmFja2VuZF9kZXZpY2VfY2hlY2tfZmlsdGVy
KAogICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqZGV2LAogICAgIGNvbnN0IHN0cnVjdCB1c2Jy
ZWRpcmZpbHRlcl9ydWxlICpydWxlcywKICAgICBpbnQgY291bnQpCiB7Ci0gICAgcmV0dXJuIHVz
YnJlZGlyaG9zdF9jaGVja19kZXZpY2VfZmlsdGVyKAotICAgICAgICBydWxlcywgY291bnQsIGRl
di0+bGlidXNiX2RldmljZSwgMCk7CisgICAgaWYgKGRldi0+bGlidXNiX2RldmljZSkgeworICAg
ICAgICByZXR1cm4gdXNicmVkaXJob3N0X2NoZWNrX2RldmljZV9maWx0ZXIoCisgICAgICAgICAg
ICBydWxlcywgY291bnQsIGRldi0+bGlidXNiX2RldmljZSwgMCk7CisgICAgfSBlbHNlIHsKKyAg
ICAgICAgcmV0dXJuIGNoZWNrX2VkZXZfZGV2aWNlX2ZpbHRlcihkZXYsIHJ1bGVzLCBjb3VudCk7
CisgICAgfQogfQogCiBzdGF0aWMgaW50IHVzYnJlZGlyX3JlYWRfY2FsbGJhY2sodm9pZCAqdXNl
cl9kYXRhLCB1aW50OF90ICpkYXRhLCBpbnQgY291bnQpCkBAIC02MjEsNiArNjgzLDE3IEBAIHN0
YXRpYyBpbnQgdXNicmVkaXJfd3JpdGVfY2FsbGJhY2sodm9pZCAqdXNlcl9kYXRhLCB1aW50OF90
ICpkYXRhLCBpbnQgY291bnQpCiAgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSB1c2Vy
X2RhdGE7CiAgICAgaW50IHJlczsKICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAsICVkIGJ5dGVz
IiwgX19GVU5DVElPTl9fLCBjaCwgY291bnQpOworICAgIGlmICghY2gtPmhlbGxvX3NlbnQpIHsK
KyAgICAgICAgLyogaGVsbG8gaXMgc2hvcnQgaGVhZGVyICgxMikgKyBoZWxsbyBzdHJ1Y3QgKDY0
KSArIGNhcGFiaWxpdGllcyAoNCkgKi8KKyAgICAgICAgaW50IGhlbGxvX3NpemUgPSBzaXplb2Yo
c3RydWN0IHVzYl9yZWRpcl9oZWFkZXIpICsgc2l6ZW9mKHN0cnVjdCB1c2JfcmVkaXJfaGVsbG9f
aGVhZGVyKTsKKyAgICAgICAgY2gtPmhlbGxvX3NlbnQgPSAxOworICAgICAgICBpZiAoY291bnQg
PT0gaGVsbG9fc2l6ZSkgeworICAgICAgICAgICAgbWVtY3B5KCZjaC0+aG9zdF9jYXBzLCBkYXRh
ICsgaGVsbG9fc2l6ZSAtIHNpemVvZihjaC0+aG9zdF9jYXBzKSwKKyAgICAgICAgICAgICAgICAg
ICBzaXplb2YoY2gtPmhvc3RfY2FwcykpOworICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNo
ICVwLCBzZW5kaW5nIGZpcnN0IGhlbGxvLCBjYXBzICUwOFgiLAorICAgICAgICAgICAgICAgICAg
ICAgICAgX19GVU5DVElPTl9fLCBjaCwgY2gtPmhvc3RfY2Fwcyk7CisgICAgICAgIH0KKyAgICB9
CiAgICAgcmVzID0gc3BpY2VfdXNicmVkaXJfd3JpdGVfY2FsbGJhY2soY2gtPnVzZXJfZGF0YSwg
ZGF0YSwgY291bnQpOwogICAgIHJldHVybiByZXM7CiB9CkBAIC02NDEsNiArNzE0LDI3IEBAIGlu
dCBzcGljZV91c2JfYmFja2VuZF9yZWFkX2d1ZXN0X2RhdGEoU3BpY2VVc2JCYWNrZW5kQ2hhbm5l
bCAqY2gsIHVpbnQ4X3QgKmRhdGEsCiAgICAgY2gtPnJlYWRfYnVmX3NpemUgPSBjb3VudDsKICAg
ICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgewogICAgICAgICByZXMgPSB1c2JyZWRpcmhvc3RfcmVh
ZF9ndWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3QpOworICAgICAgICBpZiAoIWNoLT5oZWxsb19k
b25lX3BhcnNlcikgeworICAgICAgICAgICAgaW50IHJlc19wYXJzZXI7CisgICAgICAgICAgICAv
KiB1c2JyZWRpcmhvc3Qgc2hvdWxkIGNvbnN1bWUgaGVsbG8gcmVzcG9uc2UgKi8KKyAgICAgICAg
ICAgIGdfcmV0dXJuX3ZhbF9pZl9mYWlsKGNoLT5yZWFkX2J1ZiA9PSBOVUxMLCBVU0JfUkVESVJf
RVJST1JfUkVBRF9QQVJTRSk7CisKKyAgICAgICAgICAgIGNoLT5yZWFkX2J1ZiA9IGRhdGE7Cisg
ICAgICAgICAgICBjaC0+cmVhZF9idWZfc2l6ZSA9IGNvdW50OworICAgICAgICAgICAgY2gtPmhl
bGxvX2RvbmVfcGFyc2VyID0gMTsKKyAgICAgICAgICAgIGlmIChjaC0+YXR0YWNoZWQgJiYgY2gt
PmF0dGFjaGVkLT5lZGV2KSB7CisgICAgICAgICAgICAgICAgLyogY2FzZSBvZiBDRCBzaGFyaW5n
IG9uIGNvbm5lY3QgKi8KKyAgICAgICAgICAgICAgICBjaC0+dXNicmVkaXJob3N0ID0gTlVMTDsK
KyAgICAgICAgICAgICAgICBjaC0+cGFyc2VyID0gY2gtPmhpZGRlbl9wYXJzZXI7CisgICAgICAg
ICAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBzd2l0Y2ggJXAgdG8gcGFyc2VyIiwgX19GVU5DVElP
Tl9fLCBjaCk7CisgICAgICAgICAgICB9CisgICAgICAgICAgICByZXNfcGFyc2VyID0gdXNicmVk
aXJwYXJzZXJfZG9fcmVhZChjaC0+aGlkZGVuX3BhcnNlcik7CisgICAgICAgICAgICBpZiAocmVz
ID49IDApIHsKKyAgICAgICAgICAgICAgICByZXMgPSByZXNfcGFyc2VyOworICAgICAgICAgICAg
fQorICAgICAgICB9CisgICAgfSBlbHNlIGlmIChjaC0+cGFyc2VyKSB7CisgICAgICAgIHJlcyA9
IHVzYnJlZGlycGFyc2VyX2RvX3JlYWQoY2gtPnBhcnNlcik7CiAgICAgfSBlbHNlIHsKICAgICAg
ICAgcmVzID0gVVNCX1JFRElSX0VSUk9SX0lPOwogICAgIH0KQEAgLTY2MSw2ICs3NTUsMTEgQEAg
aW50IHNwaWNlX3VzYl9iYWNrZW5kX3JlYWRfZ3Vlc3RfZGF0YShTcGljZVVzYkJhY2tlbmRDaGFu
bmVsICpjaCwgdWludDhfdCAqZGF0YSwKICAgICB9CiAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVw
LCAlZCBieXRlcywgcmVzICVkIiwgX19GVU5DVElPTl9fLCBjaCwgY291bnQsIHJlcyk7CiAKKyAg
ICBpZiAoY2gtPnJlamVjdGVkKSB7CisgICAgICAgIGNoLT5yZWplY3RlZCA9IDA7CisgICAgICAg
IHJlcyA9IFVTQl9SRURJUl9FUlJPUl9ERVZfUkVKRUNURUQ7CisgICAgfQorCiAgICAgcmV0dXJu
IHJlczsKIH0KIApAQCAtNjkwLDEzICs3ODksNDMwIEBAIEdFcnJvciAqc3BpY2VfdXNiX2JhY2tl
bmRfZ2V0X2Vycm9yX2RldGFpbHMoaW50IGVycm9yX2NvZGUsIGdjaGFyICpkZXNjKQogdm9pZCBz
cGljZV91c2JfYmFja2VuZF9yZXR1cm5fd3JpdGVfZGF0YShTcGljZVVzYkJhY2tlbmRDaGFubmVs
ICpjaCwgdm9pZCAqZGF0YSkKIHsKICAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgewotICAgICAg
ICBTUElDRV9ERUJVRygiJXMgY2ggJXAiLCBfX0ZVTkNUSU9OX18sIGNoKTsKKyAgICAgICAgU1BJ
Q0VfREVCVUcoIiVzIGNoICVwIC0+IHVzYnJlZGlyaG9zdCIsIF9fRlVOQ1RJT05fXywgY2gpOwog
ICAgICAgICB1c2JyZWRpcmhvc3RfZnJlZV93cml0ZV9idWZmZXIoY2gtPnVzYnJlZGlyaG9zdCwg
ZGF0YSk7CisgICAgfSBlbHNlIGlmIChjaC0+cGFyc2VyKSB7CisgICAgICAgIFNQSUNFX0RFQlVH
KCIlcyBjaCAlcCAtPiBwYXJzZXIiLCBfX0ZVTkNUSU9OX18sIGNoKTsKKyAgICAgICAgdXNicmVk
aXJwYXJzZXJfZnJlZV93cml0ZV9idWZmZXIoY2gtPnBhcnNlciwgZGF0YSk7CiAgICAgfSBlbHNl
IHsKICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIC0gTk9CT0RZIFRPIENBTEwiLCBfX0ZV
TkNUSU9OX18sIGNoKTsKICAgICB9CiB9CiAKK3N0YXRpYyB2b2lkIHVzYnJlZGlyX2NvbnRyb2xf
cGFja2V0KHZvaWQgKnByaXYsCisgICAgdWludDY0X3QgaWQsIHN0cnVjdCB1c2JfcmVkaXJfY29u
dHJvbF9wYWNrZXRfaGVhZGVyICpoLAorICAgIHVpbnQ4X3QgKmRhdGEsIGludCBkYXRhX2xlbikK
K3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU3BpY2VVc2JC
YWNrZW5kRGV2aWNlICpkID0gY2gtPmF0dGFjaGVkOworICAgIFNwaWNlVXNiRW11bGF0ZWREZXZp
Y2UgKmVkZXYgPSBkID8gZC0+ZWRldiA6IE5VTEw7CisgICAgc3RydWN0IHVzYl9yZWRpcl9jb250
cm9sX3BhY2tldF9oZWFkZXIgcmVzcG9uc2UgPSAqaDsKKyAgICB1aW50OF90IHJlcXR5cGUgPSBo
LT5yZXF1ZXN0dHlwZSAmIDB4N2Y7CisgICAgZ2Jvb2xlYW4gZG9uZSA9IEZBTFNFOworICAgIHZv
aWQgKm91dF9idWZmZXIgPSBOVUxMOworCisgICAgcmVzcG9uc2Uuc3RhdHVzID0gdXNiX3JlZGly
X3N0YWxsOworICAgIFNQSUNFX0RFQlVHKCIlcyAlcDogVFJWSUwgJTAyWCAlMDJYICUwNFggJTA0
WCAlMDRYIiwKKyAgICAgICAgICAgICAgICBfX0ZVTkNUSU9OX18sCisgICAgICAgICAgICAgICAg
Y2gsIGgtPnJlcXVlc3R0eXBlLCBoLT5yZXF1ZXN0LAorICAgICAgICAgICAgICAgIGgtPnZhbHVl
LCBoLT5pbmRleCwgaC0+bGVuZ3RoKTsKKworICAgIGlmICghZWRldikgeworICAgICAgICBTUElD
RV9ERUJVRygiJXM6IGRldmljZSBub3QgYXR0YWNoZWQiLCBfX0ZVTkNUSU9OX18pOworICAgICAg
ICByZXNwb25zZS5zdGF0dXMgPSB1c2JfcmVkaXJfaW9lcnJvcjsKKyAgICAgICAgZG9uZSA9IFRS
VUU7CisgICAgfSBlbHNlIGlmIChyZXF0eXBlID09IChMSUJVU0JfUkVRVUVTVF9UWVBFX1NUQU5E
QVJEIHwgTElCVVNCX1JFQ0lQSUVOVF9ERVZJQ0UpICYmCisgICAgICAgICAgICAgICBoLT5yZXF1
ZXN0ID09IExJQlVTQl9SRVFVRVNUX0dFVF9ERVNDUklQVE9SKSB7CisgICAgICAgIHVpbnQxNl90
IHNpemU7CisgICAgICAgIGRvbmUgPSBkZXZpY2Vfb3BzKGVkZXYpLT5nZXRfZGVzY3JpcHRvcigK
KyAgICAgICAgICAgIGVkZXYsIGgtPnZhbHVlID4+IDgsIGgtPnZhbHVlICYgMHhmZiwKKyAgICAg
ICAgICAgICZvdXRfYnVmZmVyLCAmc2l6ZSk7CisgICAgICAgIHJlc3BvbnNlLmxlbmd0aCA9IHNp
emU7CisgICAgICAgIGlmIChkb25lKSB7CisgICAgICAgICAgICByZXNwb25zZS5zdGF0dXMgPSAw
OworICAgICAgICB9CisgICAgICAgIGRvbmUgPSBUUlVFOworICAgIH0KKworICAgIGlmICghZG9u
ZSkgeworICAgICAgICBkZXZpY2Vfb3BzKGVkZXYpLT5jb250cm9sX3JlcXVlc3QoCisgICAgICAg
ICAgICBlZGV2LCBkYXRhLCBkYXRhX2xlbiwgJnJlc3BvbnNlLCAmb3V0X2J1ZmZlcik7CisgICAg
ICAgIGRvbmUgPSBUUlVFOworICAgIH0KKworICAgIGlmIChyZXNwb25zZS5zdGF0dXMpIHsKKyAg
ICAgICAgcmVzcG9uc2UubGVuZ3RoID0gMDsKKyAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmxlbmd0
aCA+IGgtPmxlbmd0aCkgeworICAgICAgICByZXNwb25zZS5sZW5ndGggPSBoLT5sZW5ndGg7Cisg
ICAgfQorCisgICAgU1BJQ0VfREVCVUcoIiVzIHJlc3BvbmRpbmcgd2l0aCBwYXlsb2FkIG9mICUw
MlgsIHN0YXR1cyAlWCIsCisgICAgICAgICAgICAgICAgX19GVU5DVElPTl9fLCByZXNwb25zZS5s
ZW5ndGgsIHJlc3BvbnNlLnN0YXR1cyk7CisgICAgdXNicmVkaXJwYXJzZXJfc2VuZF9jb250cm9s
X3BhY2tldCgKKyAgICAgICAgY2gtPnBhcnNlciwgaWQsICZyZXNwb25zZSwKKyAgICAgICAgcmVz
cG9uc2UubGVuZ3RoID8gb3V0X2J1ZmZlciA6IE5VTEwsCisgICAgICAgIHJlc3BvbnNlLmxlbmd0
aCk7CisKKyAgICB1c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFjayhjaCk7CisgICAgdXNicmVk
aXJwYXJzZXJfZnJlZV9wYWNrZXRfZGF0YShjaC0+cGFyc2VyLCBkYXRhKTsKK30KKworc3RhdGlj
IHZvaWQgdXNicmVkaXJfYnVsa19wYWNrZXQodm9pZCAqcHJpdiwKKyAgICB1aW50NjRfdCBpZCwg
c3RydWN0IHVzYl9yZWRpcl9idWxrX3BhY2tldF9oZWFkZXIgKmgsCisgICAgdWludDhfdCAqZGF0
YSwgaW50IGRhdGFfbGVuKQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJp
djsKKyAgICBTcGljZVVzYkJhY2tlbmREZXZpY2UgKmQgPSBjaC0+YXR0YWNoZWQ7CisgICAgU3Bp
Y2VVc2JFbXVsYXRlZERldmljZSAqZWRldiA9IGQgPyBkLT5lZGV2IDogTlVMTDsKKyAgICBzdHJ1
Y3QgdXNiX3JlZGlyX2J1bGtfcGFja2V0X2hlYWRlciBob3V0ID0gKmg7CisgICAgdWludDMyX3Qg
bGVuID0gKGgtPmxlbmd0aF9oaWdoIDw8IDE2KSB8IGgtPmxlbmd0aDsKKyAgICBTUElDRV9ERUJV
RygiJXMgJXA6IGVwICVYLCBsZW4gJXUsIGlkICUiIEdfR1VJTlQ2NF9GT1JNQVQsIF9fRlVOQ1RJ
T05fXywKKyAgICAgICAgICAgICAgICBjaCwgaC0+ZW5kcG9pbnQsIGxlbiwgaWQpOworCisgICAg
aWYgKCFlZGV2KSB7CisgICAgICAgIFNQSUNFX0RFQlVHKCIlczogZGV2aWNlIG5vdCBhdHRhY2hl
ZCIsIF9fRlVOQ1RJT05fXyk7CisgICAgICAgIGhvdXQuc3RhdHVzID0gdXNiX3JlZGlyX2lvZXJy
b3I7CisgICAgICAgIGhvdXQubGVuZ3RoID0gaG91dC5sZW5ndGhfaGlnaCA9IDA7CisgICAgICAg
IFNQSUNFX0RFQlVHKCIlczogcmVzcG9uZGluZyB3aXRoIFpMUCBzdGF0dXMgJWQiLCBfX0ZVTkNU
SU9OX18sIGhvdXQuc3RhdHVzKTsKKyAgICB9IGVsc2UgaWYgKGgtPmVuZHBvaW50ICYgTElCVVNC
X0VORFBPSU5UX0lOKSB7CisgICAgICAgIGlmIChkZXZpY2Vfb3BzKGVkZXYpLT5idWxrX2luX3Jl
cXVlc3QoZWRldiwgaWQsICZob3V0KSkgeworICAgICAgICAgICAgdXNicmVkaXJwYXJzZXJfZnJl
ZV9wYWNrZXRfZGF0YShjaC0+cGFyc2VyLCBkYXRhKTsKKyAgICAgICAgICAgIC8qIGNvbXBsZXRp
b24gaXMgYXN5bmNocm9ub3VzICovCisgICAgICAgICAgICByZXR1cm47CisgICAgICAgIH0KKyAg
ICB9IGVsc2UgeworICAgICAgICBob3V0LnN0YXR1cyA9IHVzYl9yZWRpcl9zdGFsbDsKKyAgICAg
ICAgZGV2aWNlX29wcyhlZGV2KS0+YnVsa19vdXRfcmVxdWVzdChlZGV2LCBoLT5lbmRwb2ludCwg
ZGF0YSwgZGF0YV9sZW4sICZob3V0LnN0YXR1cyk7CisgICAgICAgIFNQSUNFX0RFQlVHKCIlczog
cmVzcG9uZGluZyBzdGF0dXMgJWQiLCBfX0ZVTkNUSU9OX18sIGhvdXQuc3RhdHVzKTsKKyAgICB9
CisKKyAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2J1bGtfcGFja2V0KGNoLT5wYXJzZXIsIGlkLCAm
aG91dCwgTlVMTCwgMCk7CisgICAgdXNicmVkaXJwYXJzZXJfZnJlZV9wYWNrZXRfZGF0YShjaC0+
cGFyc2VyLCBkYXRhKTsKKyAgICB1c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFjayhjaCk7Cit9
CisKK3N0YXRpYyB2b2lkIHVzYnJlZGlyX2RldmljZV9yZXNldCh2b2lkICpwcml2KQoreworICAg
IFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBTcGljZVVzYkJhY2tlbmRE
ZXZpY2UgKmQgPSBjaC0+YXR0YWNoZWQ7CisgICAgU3BpY2VVc2JFbXVsYXRlZERldmljZSAqZWRl
diA9IGQgPyBkLT5lZGV2IDogTlVMTDsKKyAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAiLCBfX0ZV
TkNUSU9OX18sIGNoKTsKKyAgICBpZiAoZWRldikgeworICAgICAgICBkZXZpY2Vfb3BzKGVkZXYp
LT5yZXNldChlZGV2KTsKKyAgICB9Cit9CisKK3N0YXRpYyB2b2lkIHVzYnJlZGlyX2ludGVyZmFj
ZV9pbmZvKHZvaWQgKnByaXYsCisgICAgc3RydWN0IHVzYl9yZWRpcl9pbnRlcmZhY2VfaW5mb19o
ZWFkZXIgKmludGVyZmFjZV9pbmZvKQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNo
ID0gcHJpdjsKKyAgICBTUElDRV9ERUJVRygiJXMgbm90IGltcGxlbWVudGVkICVwIiwgX19GVU5D
VElPTl9fLCBjaCk7Cit9CisKK3N0YXRpYyB2b2lkIHVzYnJlZGlyX2ludGVyZmFjZV9lcF9pbmZv
KHZvaWQgKnByaXYsCisgICAgc3RydWN0IHVzYl9yZWRpcl9lcF9pbmZvX2hlYWRlciAqZXBfaW5m
bykKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU1BJQ0Vf
REVCVUcoIiVzIG5vdCBpbXBsZW1lbnRlZCAlcCIsIF9fRlVOQ1RJT05fXywgY2gpOworfQorCitz
dGF0aWMgdm9pZCB1c2JyZWRpcl9zZXRfY29uZmlndXJhdGlvbih2b2lkICpwcml2LAorICAgIHVp
bnQ2NF90IGlkLCBzdHJ1Y3QgdXNiX3JlZGlyX3NldF9jb25maWd1cmF0aW9uX2hlYWRlciAqc2V0
X2NvbmZpZ3VyYXRpb24pCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2
OworICAgIHN0cnVjdCB1c2JfcmVkaXJfY29uZmlndXJhdGlvbl9zdGF0dXNfaGVhZGVyIGg7Cisg
ICAgaC5zdGF0dXMgPSAwOworICAgIGguY29uZmlndXJhdGlvbiA9IHNldF9jb25maWd1cmF0aW9u
LT5jb25maWd1cmF0aW9uOworICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCwgY2ZnICVkIiwgX19G
VU5DVElPTl9fLCBjaCwgaC5jb25maWd1cmF0aW9uKTsKKyAgICBpZiAoY2gtPmF0dGFjaGVkKSB7
CisgICAgICAgIGNoLT5hdHRhY2hlZC0+ZWRldl9jb25maWd1cmVkID0gaC5jb25maWd1cmF0aW9u
ICE9IDA7CisgICAgfQorICAgIHVzYnJlZGlycGFyc2VyX3NlbmRfY29uZmlndXJhdGlvbl9zdGF0
dXMoY2gtPnBhcnNlciwgaWQsICZoKTsKKyAgICB1c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFj
ayhjaCk7Cit9CisKK3N0YXRpYyB2b2lkIHVzYnJlZGlyX2dldF9jb25maWd1cmF0aW9uKHZvaWQg
KnByaXYsIHVpbnQ2NF90IGlkKQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0g
cHJpdjsKKyAgICBzdHJ1Y3QgdXNiX3JlZGlyX2NvbmZpZ3VyYXRpb25fc3RhdHVzX2hlYWRlciBo
OworICAgIGguc3RhdHVzID0gMDsKKyAgICBoLmNvbmZpZ3VyYXRpb24gPSBjaC0+YXR0YWNoZWQg
JiYgY2gtPmF0dGFjaGVkLT5lZGV2X2NvbmZpZ3VyZWQ7CisgICAgU1BJQ0VfREVCVUcoIiVzIGNo
ICVwLCBjZmcgJWQiLCBfX0ZVTkNUSU9OX18sIGNoLCBoLmNvbmZpZ3VyYXRpb24pOworICAgIHVz
YnJlZGlycGFyc2VyX3NlbmRfY29uZmlndXJhdGlvbl9zdGF0dXMoY2gtPnBhcnNlciwgaWQsICZo
KTsKKyAgICB1c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFjayhjaCk7Cit9CisKK3N0YXRpYyB2
b2lkIHVzYnJlZGlyX3NldF9hbHRfc2V0dGluZyh2b2lkICpwcml2LAorICAgIHVpbnQ2NF90IGlk
LCBzdHJ1Y3QgdXNiX3JlZGlyX3NldF9hbHRfc2V0dGluZ19oZWFkZXIgKnMpCit7CisgICAgU3Bp
Y2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIHN0cnVjdCB1c2JfcmVkaXJfYWx0
X3NldHRpbmdfc3RhdHVzX2hlYWRlciBzaDsKKyAgICBzaC5zdGF0dXMgPSAoIXMtPmludGVyZmFj
ZSAmJiAhcy0+YWx0KSA/IDAgOiB1c2JfcmVkaXJfc3RhbGw7CisgICAgc2guaW50ZXJmYWNlID0g
cy0+aW50ZXJmYWNlOworICAgIHNoLmFsdCA9IHMtPmFsdDsKKyAgICBTUElDRV9ERUJVRygiJXMg
Y2ggJXAsICVkOiVkIiwgX19GVU5DVElPTl9fLCBjaCwgcy0+aW50ZXJmYWNlLCBzLT5hbHQpOwor
ICAgIHVzYnJlZGlycGFyc2VyX3NlbmRfYWx0X3NldHRpbmdfc3RhdHVzKGNoLT5wYXJzZXIsIGlk
LCAmc2gpOworICAgIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsKK30KKworc3Rh
dGljIHZvaWQgdXNicmVkaXJfZ2V0X2FsdF9zZXR0aW5nKHZvaWQgKnByaXYsCisgICAgdWludDY0
X3QgaWQsIHN0cnVjdCB1c2JfcmVkaXJfZ2V0X2FsdF9zZXR0aW5nX2hlYWRlciAqcykKK3sKKyAg
ICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgc3RydWN0IHVzYl9yZWRp
cl9hbHRfc2V0dGluZ19zdGF0dXNfaGVhZGVyIHNoOworICAgIHNoLnN0YXR1cyA9IChzLT5pbnRl
cmZhY2UgPT0gMCkgPyAwIDogdXNiX3JlZGlyX3N0YWxsOworICAgIHNoLmludGVyZmFjZSA9IHMt
PmludGVyZmFjZTsKKyAgICBzaC5hbHQgPSAwOworICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCwg
aWYgJWQiLCBfX0ZVTkNUSU9OX18sIGNoLCBzLT5pbnRlcmZhY2UpOworICAgIHVzYnJlZGlycGFy
c2VyX3NlbmRfYWx0X3NldHRpbmdfc3RhdHVzKGNoLT5wYXJzZXIsIGlkLCAmc2gpOworICAgIHVz
YnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsKK30KKworc3RhdGljIHZvaWQgdXNicmVk
aXJfY2FuY2VsX2RhdGEodm9pZCAqcHJpdiwgdWludDY0X3QgaWQpCit7CisgICAgU3BpY2VVc2JC
YWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqZCA9
IGNoLT5hdHRhY2hlZDsKKyAgICBTcGljZVVzYkVtdWxhdGVkRGV2aWNlICplZGV2ID0gZCA/IGQt
PmVkZXYgOiBOVUxMOworICAgIGlmICghZWRldikgeworICAgICAgICBTUElDRV9ERUJVRygiJXM6
IGRldmljZSBub3QgYXR0YWNoZWQiLCBfX0ZVTkNUSU9OX18pOworICAgICAgICByZXR1cm47Cisg
ICAgfQorICAgIGRldmljZV9vcHMoZWRldiktPmNhbmNlbF9yZXF1ZXN0KGVkZXYsIGlkKTsKK30K
Kworc3RhdGljIHZvaWQgdXNicmVkaXJfZmlsdGVyX3JlamVjdCh2b2lkICpwcml2KQoreworICAg
IFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBTUElDRV9ERUJVRygiJXMg
JXAiLCBfX0ZVTkNUSU9OX18sIGNoKTsKKyAgICBjaC0+cmVqZWN0ZWQgPSAxOworfQorCisvKiBO
b3RlIHRoYXQgdGhlIG93bmVyc2hpcCBvZiB0aGUgcnVsZXMgYXJyYXkgaXMgcGFzc2VkIG9uIHRv
IHRoZSBjYWxsYmFjay4gKi8KK3N0YXRpYyB2b2lkIHVzYnJlZGlyX2ZpbHRlcl9maWx0ZXIodm9p
ZCAqcHJpdiwKKyAgICBzdHJ1Y3QgdXNicmVkaXJmaWx0ZXJfcnVsZSAqciwgaW50IGNvdW50KQor
eworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBTUElDRV9ERUJV
RygiJXMgY2ggJXAgJWQgZmlsdGVycyIsIF9fRlVOQ1RJT05fXywgY2gsIGNvdW50KTsKKworICAg
IGZyZWUoY2gtPnJ1bGVzKTsKKworICAgIGNoLT5ydWxlcyA9IHI7CisgICAgY2gtPnJ1bGVzX2Nv
dW50ID0gY291bnQ7CisgICAgaWYgKGNvdW50KSB7CisgICAgICAgIGludCBpOworICAgICAgICBm
b3IgKGkgPSAwOyBpIDwgY291bnQ7IGkrKykgeworICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVz
IGNsYXNzICVkLCAlWDolWCIsCisgICAgICAgICAgICAgICAgcltpXS5hbGxvdyA/ICJhbGxvd2Vk
IiA6ICJkZW5pZWQiLCByW2ldLmRldmljZV9jbGFzcywKKyAgICAgICAgICAgICAgICAodWludDMy
X3QpcltpXS52ZW5kb3JfaWQsICh1aW50MzJfdClyW2ldLnByb2R1Y3RfaWQpOworICAgICAgICB9
CisgICAgfQorfQorCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9kZXZpY2VfZGlzY29ubmVjdF9hY2so
dm9pZCAqcHJpdikKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7Cisg
ICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIiwgX19GVU5DVElPTl9fLCBjaCk7CisgICAgaWYgKGNo
LT5wYXJzZXIgJiYgY2gtPndhaXRfZGlzY19hY2spIHsKKyAgICAgICAgY2gtPnBhcnNlciA9IE5V
TEw7CisgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBzd2l0Y2ggdG8gdXNicmVkaXJob3N0IiwgX19G
VU5DVElPTl9fKTsKKyAgICAgICAgY2gtPnVzYnJlZGlyaG9zdCA9IGNoLT5oaWRkZW5faG9zdDsK
KyAgICB9CisgICAgY2gtPndhaXRfZGlzY19hY2sgPSAwOworfQorCitzdGF0aWMgdm9pZCB1c2Jy
ZWRpcl9oZWxsbyh2b2lkICpwcml2LAorICAgIHN0cnVjdCB1c2JfcmVkaXJfaGVsbG9faGVhZGVy
ICpoZWxsbykKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAg
U3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkID0gY2gtPmF0dGFjaGVkOworICAgIFNwaWNlVXNiRW11
bGF0ZWREZXZpY2UgKmVkZXYgPSBkID8gZC0+ZWRldiA6IE5VTEw7CisgICAgc3RydWN0IHVzYl9y
ZWRpcl9kZXZpY2VfY29ubmVjdF9oZWFkZXIgZGV2aWNlX2Nvbm5lY3Q7CisgICAgc3RydWN0IHVz
Yl9yZWRpcl9lcF9pbmZvX2hlYWRlciBlcF9pbmZvID0geyAwIH07CisgICAgc3RydWN0IHVzYl9y
ZWRpcl9pbnRlcmZhY2VfaW5mb19oZWFkZXIgaW50ZXJmYWNlX2luZm8gPSB7IDAgfTsKKyAgICB1
aW50OF90ICpjZmc7CisgICAgdWludDE2X3Qgc2l6ZSwgb2Zmc2V0ID0gMDsKKyAgICBTUElDRV9E
RUJVRygiJXMgJXAgJXNhdHRhY2hlZCAlcyIsIF9fRlVOQ1RJT05fXywgY2gsCisgICAgICAgIGVk
ZXYgPyAiIiA6ICJub3QgIiwgIGhlbGxvID8gIiIgOiAiKGludGVybmFsKSIpOworCisgICAgaWYg
KGhlbGxvKSB7CisgICAgICAgIGNoLT5oZWxsb19kb25lX3BhcnNlciA9IDE7CisgICAgfQorICAg
IGlmICghZWRldikgeworICAgICAgICByZXR1cm47CisgICAgfQorICAgIGlmICghZGV2aWNlX29w
cyhlZGV2KS0+Z2V0X2Rlc2NyaXB0b3IoCisgICAgICAgICAgICBlZGV2LCBMSUJVU0JfRFRfQ09O
RklHLCAwLCAodm9pZCAqKikmY2ZnLCAmc2l6ZSkpIHsKKyAgICAgICAgcmV0dXJuOworICAgIH0K
KyAgICB3aGlsZSAoKG9mZnNldCArIDEpIDwgc2l6ZSkgeworICAgICAgICB1aW50OF90IGxlbiAg
PSBjZmdbb2Zmc2V0XTsKKyAgICAgICAgdWludDhfdCB0eXBlID0gY2ZnW29mZnNldCArIDFdOwor
ICAgICAgICBpZiAoKG9mZnNldCArIGxlbikgPiBzaXplKSB7CisgICAgICAgICAgICBicmVhazsK
KyAgICAgICAgfQorICAgICAgICBpZiAodHlwZSA9PSBMSUJVU0JfRFRfSU5URVJGQUNFKSB7Cisg
ICAgICAgICAgICB1aW50MzJfdCBpID0gaW50ZXJmYWNlX2luZm8uaW50ZXJmYWNlX2NvdW50Owor
ICAgICAgICAgICAgdWludDhfdCBjbGFzcywgc3ViY2xhc3MsIHByb3RvY29sOworICAgICAgICAg
ICAgY2xhc3MgPSBjZmdbb2Zmc2V0ICsgNV07CisgICAgICAgICAgICBzdWJjbGFzcyA9IGNmZ1tv
ZmZzZXQgKyA2XTsKKyAgICAgICAgICAgIHByb3RvY29sID0gY2ZnW29mZnNldCArIDddOworICAg
ICAgICAgICAgaW50ZXJmYWNlX2luZm8uaW50ZXJmYWNlX2NsYXNzW2ldID0gY2xhc3M7CisgICAg
ICAgICAgICBpbnRlcmZhY2VfaW5mby5pbnRlcmZhY2Vfc3ViY2xhc3NbaV0gPSBzdWJjbGFzczsK
KyAgICAgICAgICAgIGludGVyZmFjZV9pbmZvLmludGVyZmFjZV9wcm90b2NvbFtpXSA9IHByb3Rv
Y29sOworICAgICAgICAgICAgaW50ZXJmYWNlX2luZm8uaW50ZXJmYWNlX2NvdW50Kys7CisgICAg
ICAgICAgICBTUElDRV9ERUJVRygiJXMgSUYlZDogJWQvJWQvJWQiLCBfX0ZVTkNUSU9OX18sIGks
IGNsYXNzLCBzdWJjbGFzcywgcHJvdG9jb2wpOworICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT0g
TElCVVNCX0RUX0VORFBPSU5UKSB7CisgICAgICAgICAgICB1aW50OF90IGFkZHJlc3MgPSBjZmdb
b2Zmc2V0ICsgMl07CisgICAgICAgICAgICB1aW50MTZfdCBtYXhfcGFja2V0X3NpemUgPSAweDEw
MCAqIGNmZ1tvZmZzZXQgKyA1XSArIGNmZ1tvZmZzZXQgKyA0XTsKKyAgICAgICAgICAgIHVpbnQ4
X3QgaW5kZXggPSBhZGRyZXNzICYgMHhmOworICAgICAgICAgICAgaWYgKGFkZHJlc3MgJiAweDgw
KSBpbmRleCArPSAweDEwOworICAgICAgICAgICAgZXBfaW5mby50eXBlW2luZGV4XSA9IGNmZ1tv
ZmZzZXQgKyAzXSAmIDB4MzsKKyAgICAgICAgICAgIGVwX2luZm8ubWF4X3BhY2tldF9zaXplW2lu
ZGV4XSA9IG1heF9wYWNrZXRfc2l6ZTsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBFUFsl
MDJYXTogJWQvJWQiLCBfX0ZVTkNUSU9OX18sIGluZGV4LCBlcF9pbmZvLnR5cGVbaW5kZXhdLCBt
YXhfcGFja2V0X3NpemUpOworICAgICAgICB9CisgICAgICAgIG9mZnNldCArPSBsZW47CisgICAg
fQorCisgICAgdXNicmVkaXJwYXJzZXJfc2VuZF9pbnRlcmZhY2VfaW5mbyhjaC0+cGFyc2VyLCAm
aW50ZXJmYWNlX2luZm8pOworICAgIHVzYnJlZGlycGFyc2VyX3NlbmRfZXBfaW5mbyhjaC0+cGFy
c2VyLCAmZXBfaW5mbyk7CisKKyAgICBkZXZpY2VfY29ubmVjdC5kZXZpY2VfY2xhc3MgPSAwOyAv
L2QtPmRldmljZV9pbmZvLmNsYXNzOworICAgIGRldmljZV9jb25uZWN0LmRldmljZV9zdWJjbGFz
cyA9IDA7IC8vZC0+ZGV2aWNlX2luZm8uc3ViY2xhc3M7CisgICAgZGV2aWNlX2Nvbm5lY3QuZGV2
aWNlX3Byb3RvY29sID0gMDsgLy9kLT5kZXZpY2VfaW5mby5wcm90b2NvbDs7CisgICAgZGV2aWNl
X2Nvbm5lY3QudmVuZG9yX2lkID0gZC0+ZGV2aWNlX2luZm8udmlkOworICAgIGRldmljZV9jb25u
ZWN0LnByb2R1Y3RfaWQgPSBkLT5kZXZpY2VfaW5mby5waWQ7CisgICAgZGV2aWNlX2Nvbm5lY3Qu
ZGV2aWNlX3ZlcnNpb25fYmNkID0gZC0+ZGV2aWNlX2luZm8uYmNkVVNCOworICAgIGRldmljZV9j
b25uZWN0LnNwZWVkID0gdXNiX3JlZGlyX3NwZWVkX2hpZ2g7CisgICAgdXNicmVkaXJwYXJzZXJf
c2VuZF9kZXZpY2VfY29ubmVjdChjaC0+cGFyc2VyLCAmZGV2aWNlX2Nvbm5lY3QpOworICAgIHVz
YnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsKK30KKworc3RhdGljIHZvaWQgaW5pdGlh
bGl6ZV9wYXJzZXIoU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsIGdib29sZWFuIGRvX2hlbGxv
KQoreworICAgIHVpbnQzMl90IGZsYWdzLCBjYXBzW1VTQl9SRURJUl9DQVBTX1NJWkVdID0geyAw
IH07CisKKyAgICBnX3JldHVybl9pZl9mYWlsKGNoLT5oaWRkZW5fcGFyc2VyICE9IE5VTEwpOwor
ICAgIGlmIChjaC0+cGFyc2VyX2luaXRfZG9uZSkgeworICAgICAgICBpZiAoY2gtPnBhcnNlcl93
aXRoX2hlbGxvICE9IGRvX2hlbGxvKSB7CisgICAgICAgICAgICBnX3JldHVybl9pZl9yZWFjaGVk
KCk7CisgICAgICAgIH0KKyAgICAgICAgcmV0dXJuOworICAgIH0KKworICAgIGNoLT5wYXJzZXJf
aW5pdF9kb25lID0gMTsKKyAgICBjaC0+cGFyc2VyX3dpdGhfaGVsbG8gPSBkb19oZWxsbzsKKyAg
ICBmbGFncyA9IHVzYnJlZGlycGFyc2VyX2ZsX3dyaXRlX2NiX293bnNfYnVmZmVyIHwgdXNicmVk
aXJwYXJzZXJfZmxfdXNiX2hvc3Q7CisKKyAgICBpZiAoZG9faGVsbG8pIHsKKyAgICAgICAgY2gt
PmhlbGxvX3NlbnQgPSAxOworICAgICAgICBjaC0+aG9zdF9jYXBzIHw9IDEgPDwgdXNiX3JlZGly
X2NhcF9jb25uZWN0X2RldmljZV92ZXJzaW9uOworICAgICAgICBjaC0+aG9zdF9jYXBzIHw9IDEg
PDwgdXNiX3JlZGlyX2NhcF9kZXZpY2VfZGlzY29ubmVjdF9hY2s7CisgICAgICAgIGNoLT5ob3N0
X2NhcHMgfD0gMSA8PCB1c2JfcmVkaXJfY2FwX2VwX2luZm9fbWF4X3BhY2tldF9zaXplOworICAg
ICAgICBjaC0+aG9zdF9jYXBzIHw9IDEgPDwgdXNiX3JlZGlyX2NhcF82NGJpdHNfaWRzOworICAg
ICAgICBjaC0+aG9zdF9jYXBzIHw9IDEgPDwgdXNiX3JlZGlyX2NhcF8zMmJpdHNfYnVsa19sZW5n
dGg7CisgICAgfSBlbHNlIHsKKyAgICAgICAgZmxhZ3MgfD0gdXNicmVkaXJwYXJzZXJfZmxfbm9f
aGVsbG87CisgICAgfQorCisgICAgaWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJf
Y2FwX2Nvbm5lY3RfZGV2aWNlX3ZlcnNpb24pKSB7CisgICAgICAgIHVzYnJlZGlycGFyc2VyX2Nh
cHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJfY2FwX2Nvbm5lY3RfZGV2aWNlX3ZlcnNpb24pOwor
ICAgIH0KKyAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2Nh
cF9maWx0ZXIpOworICAgIGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF9k
ZXZpY2VfZGlzY29ubmVjdF9hY2spKSB7CisgICAgICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0
X2NhcChjYXBzLCB1c2JfcmVkaXJfY2FwX2RldmljZV9kaXNjb25uZWN0X2Fjayk7CisgICAgfQor
ICAgIGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF9lcF9pbmZvX21heF9w
YWNrZXRfc2l6ZSkpIHsKKyAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMs
IHVzYl9yZWRpcl9jYXBfZXBfaW5mb19tYXhfcGFja2V0X3NpemUpOworICAgIH0KKyAgICBpZiAo
Y2gtPmhvc3RfY2FwcyAmICgxIDw8IHVzYl9yZWRpcl9jYXBfNjRiaXRzX2lkcykpIHsKKyAgICAg
ICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfNjRiaXRz
X2lkcyk7CisgICAgfQorICAgIGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2Nh
cF8zMmJpdHNfYnVsa19sZW5ndGgpKSB7CisgICAgICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0
X2NhcChjYXBzLCB1c2JfcmVkaXJfY2FwXzMyYml0c19idWxrX2xlbmd0aCk7CisgICAgfQorICAg
IGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF9idWxrX3N0cmVhbXMpKSB7
CisgICAgICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJfY2Fw
X2J1bGtfc3RyZWFtcyk7CisgICAgfQorICAgIHVzYnJlZGlycGFyc2VyX2luaXQoY2gtPmhpZGRl
bl9wYXJzZXIsIFBBQ0tBR0VfU1RSSU5HLCBjYXBzLCBVU0JfUkVESVJfQ0FQU19TSVpFLCBmbGFn
cyk7Cit9CisKKy8qCisgICAgV2UgY2FuIGluaXRpYWxpemUgdGhlIHVzYnJlZGlycGFyc2VyIHdp
dGggSEVMTE8gZW5hYmxlZCBvbmx5IGluIGNhc2UKKyAgICB0aGUgbGlidXNiIGlzIG5vdCBhY3Rp
dmUgYW5kIHRoZSB1c2JyZWRpcmhvc3QgZG9lcyBub3QgZnVuY3Rpb24uCisgICAgVGhlbiB0aGUg
cGFyc2VyIHNlbmRzIHNlc3Npb24gSEVMTE8gYW5kIHJlY2VpdmVzIHNlcnZlcidzIHJlc3BvbnNl
LgorICAgIE90aGVyd2lzZSAodXNicmVkaXJwYXJzZXIgaW5pdGlhbGl6ZWQgd2l0aCBIRUxMTyBk
aXNhYmxlZCk6CisgICAgLSB0aGUgdXNicmVkaXJob3N0IHNlbmRzIHNlc3Npb24gSEVMTE8KKyAg
ICAtIHdlIGxvb2sgaW50byBpdCB0byBrbm93IHNldCBvZiBjYXBhYmlsaXRpZXMgd2Ugc2hhbGwg
aW5pdGlhbGl6ZQorICAgICAgdGhlIHBhcnNlciB3aXRoCisgICAgLSB3aGVuIHdlIHJlY2VpdmUg
c2VydmVyJ3MgcmVzcG9uc2UgdG8gSEVMTE8gd2UgcHJvdmlkZSBpdCBhbHNvIHRvCisgICAgICBw
YXJzZXIgdG8gbGV0IGl0IHN5bmNocm9uaXplIHdpdGggc2VydmVyJ3MgY2FwYWJpbGl0aWVzCisq
Lworc3RhdGljIHN0cnVjdCB1c2JyZWRpcnBhcnNlciAqY3JlYXRlX3BhcnNlcihTcGljZVVzYkJh
Y2tlbmRDaGFubmVsICpjaCkKK3sKKyAgICBzdHJ1Y3QgdXNicmVkaXJwYXJzZXIgKnBhcnNlciA9
IHVzYnJlZGlycGFyc2VyX2NyZWF0ZSgpOworCisgICAgZ19yZXR1cm5fdmFsX2lmX2ZhaWwocGFy
c2VyICE9IE5VTEwsIE5VTEwpOworCisgICAgcGFyc2VyLT5wcml2ID0gY2g7CisgICAgcGFyc2Vy
LT5sb2dfZnVuYyA9IHVzYnJlZGlyX2xvZzsKKyAgICBwYXJzZXItPnJlYWRfZnVuYyA9IHVzYnJl
ZGlyX3JlYWRfY2FsbGJhY2s7CisgICAgcGFyc2VyLT53cml0ZV9mdW5jID0gdXNicmVkaXJfd3Jp
dGVfY2FsbGJhY2s7CisgICAgcGFyc2VyLT5yZXNldF9mdW5jID0gdXNicmVkaXJfZGV2aWNlX3Jl
c2V0OworICAgIHBhcnNlci0+c2V0X2NvbmZpZ3VyYXRpb25fZnVuYyA9IHVzYnJlZGlyX3NldF9j
b25maWd1cmF0aW9uOworICAgIHBhcnNlci0+Z2V0X2NvbmZpZ3VyYXRpb25fZnVuYyA9IHVzYnJl
ZGlyX2dldF9jb25maWd1cmF0aW9uOworICAgIHBhcnNlci0+c2V0X2FsdF9zZXR0aW5nX2Z1bmMg
PSB1c2JyZWRpcl9zZXRfYWx0X3NldHRpbmc7CisgICAgcGFyc2VyLT5nZXRfYWx0X3NldHRpbmdf
ZnVuYyA9IHVzYnJlZGlyX2dldF9hbHRfc2V0dGluZzsKKyAgICBwYXJzZXItPmNhbmNlbF9kYXRh
X3BhY2tldF9mdW5jID0gdXNicmVkaXJfY2FuY2VsX2RhdGE7CisgICAgcGFyc2VyLT5jb250cm9s
X3BhY2tldF9mdW5jID0gdXNicmVkaXJfY29udHJvbF9wYWNrZXQ7CisgICAgcGFyc2VyLT5idWxr
X3BhY2tldF9mdW5jID0gdXNicmVkaXJfYnVsa19wYWNrZXQ7CisgICAgcGFyc2VyLT5hbGxvY19s
b2NrX2Z1bmMgPSB1c2JyZWRpcl9hbGxvY19sb2NrOworICAgIHBhcnNlci0+bG9ja19mdW5jID0g
dXNicmVkaXJfbG9ja19sb2NrOworICAgIHBhcnNlci0+dW5sb2NrX2Z1bmMgPSB1c2JyZWRpcl91
bmxvY2tfbG9jazsKKyAgICBwYXJzZXItPmZyZWVfbG9ja19mdW5jID0gdXNicmVkaXJfZnJlZV9s
b2NrOworICAgIHBhcnNlci0+aGVsbG9fZnVuYyA9IHVzYnJlZGlyX2hlbGxvOworICAgIHBhcnNl
ci0+ZmlsdGVyX3JlamVjdF9mdW5jID0gdXNicmVkaXJfZmlsdGVyX3JlamVjdDsKKyAgICBwYXJz
ZXItPmRldmljZV9kaXNjb25uZWN0X2Fja19mdW5jID0gdXNicmVkaXJfZGV2aWNlX2Rpc2Nvbm5l
Y3RfYWNrOworICAgIHBhcnNlci0+aW50ZXJmYWNlX2luZm9fZnVuYyA9IHVzYnJlZGlyX2ludGVy
ZmFjZV9pbmZvOworICAgIHBhcnNlci0+ZXBfaW5mb19mdW5jID0gdXNicmVkaXJfaW50ZXJmYWNl
X2VwX2luZm87CisgICAgcGFyc2VyLT5maWx0ZXJfZmlsdGVyX2Z1bmMgPSB1c2JyZWRpcl9maWx0
ZXJfZmlsdGVyOworCisgICAgcmV0dXJuIHBhcnNlcjsKK30KKworc3RhdGljIGdib29sZWFuIGF0
dGFjaF9lZGV2KFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLAorICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqZGV2LAorICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIEdFcnJvciAqKmVycm9yKQoreworICAgIGlmICghZGV2LT5lZGV2KSB7CisgICAg
ICAgIGdfc2V0X2Vycm9yKGVycm9yLCBTUElDRV9DTElFTlRfRVJST1IsIFNQSUNFX0NMSUVOVF9F
UlJPUl9GQUlMRUQsCisgICAgICAgICAgIF8oIkZhaWxlZCB0byByZWRpcmVjdCBkZXZpY2UgJWQi
KSwgMSk7CisgICAgICAgIHJldHVybiBGQUxTRTsKKyAgICB9CisgICAgaWYgKGNoLT51c2JyZWRp
cmhvc3QgJiYgIWNoLT5oZWxsb19kb25lX3BhcnNlcikgeworICAgICAgICAvKgorICAgICAgICAg
ICAgd2UgY2FuJ3QgaW5pdGlhbGl6ZSBwYXJzZXIgdW50aWwgd2Ugc2VlIGhlbGxvIGZyb20gdXNi
cmVkaXIKKyAgICAgICAgICAgIGFuZCB0aGUgcGFyc2VyIGNhbid0IHdvcmsgdW50aWwgaXQgc2Vl
cyB0aGUgaGVsbG8gcmVzcG9uc2UuCisgICAgICAgICAgICB0aGlzIGlzIGNhc2Ugb2YgYXV0b2Nv
bm5lY3Qgd2hlbiBlbXVsYXRlZCBkZXZpY2UgaXMgYXR0YWNoZWQKKyAgICAgICAgICAgIGJlZm9y
ZSB0aGUgY2hhbm5lbCBpcyB1cAorICAgICAgICAqLworICAgICAgICBTUElDRV9ERUJVRygiJXMg
d2FpdGluZyB1bnRpbCB0aGUgY2hhbm5lbCBpcyByZWFkeSIsIF9fRlVOQ1RJT05fXyk7CisKKyAg
ICB9IGVsc2UgeworICAgICAgICBpbml0aWFsaXplX3BhcnNlcihjaCwgY2gtPmhpZGRlbl9ob3N0
ID09IE5VTEwpOworICAgICAgICBjaC0+dXNicmVkaXJob3N0ID0gTlVMTDsKKyAgICAgICAgY2gt
PnBhcnNlciA9IGNoLT5oaWRkZW5fcGFyc2VyOworICAgIH0KKyAgICBjaC0+d2FpdF9kaXNjX2Fj
ayA9IDA7CisgICAgY2gtPmF0dGFjaGVkID0gZGV2OworICAgIGRldi0+YXR0YWNoZWRfdG8gPSBj
aDsKKyAgICBkZXZpY2Vfb3BzKGRldi0+ZWRldiktPmF0dGFjaChkZXYtPmVkZXYsIGNoLT5oaWRk
ZW5fcGFyc2VyKTsKKyAgICBpZiAoY2gtPmhlbGxvX2RvbmVfcGFyc2VyKSB7CisgICAgICAgIC8q
IHNlbmQgZGV2aWNlIGluZm8gKi8KKyAgICAgICAgdXNicmVkaXJfaGVsbG8oY2gsIE5VTEwpOwor
ICAgIH0KKyAgICByZXR1cm4gVFJVRTsKK30KKwogZ2Jvb2xlYW4gc3BpY2VfdXNiX2JhY2tlbmRf
Y2hhbm5lbF9hdHRhY2goU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsCiAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTcGljZVVzYkJhY2tlbmREZXZpY2UgKmRldiwK
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEdFcnJvciAqKmVycm9y
KQpAQCAtNzA2LDcgKzEyMjIsMTMgQEAgZ2Jvb2xlYW4gc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5l
bF9hdHRhY2goU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsCiAKICAgICBnX3JldHVybl92YWxf
aWZfZmFpbChkZXYgIT0gTlVMTCwgRkFMU0UpOwogCisgICAgaWYgKCFkZXYtPmxpYnVzYl9kZXZp
Y2UpIHsKKyAgICAgICAgcmV0dXJuIGF0dGFjaF9lZGV2KGNoLCBkZXYsIGVycm9yKTsKKyAgICB9
CisKICAgICBsaWJ1c2JfZGV2aWNlX2hhbmRsZSAqaGFuZGxlID0gTlVMTDsKKyAgICBjaC0+dXNi
cmVkaXJob3N0ID0gY2gtPmhpZGRlbl9ob3N0OworICAgIGNoLT5wYXJzZXIgPSBOVUxMOwogCiAg
ICAgLyoKICAgICAgICBVbmRlciBXaW5kb3dzIHdlIG5lZWQgdG8gYXZvaWQgdXBkYXRpbmcKQEAg
LTc0MCwxOCArMTI2MiwzMyBAQCBnYm9vbGVhbiBzcGljZV91c2JfYmFja2VuZF9jaGFubmVsX2F0
dGFjaChTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwKIAogdm9pZCBzcGljZV91c2JfYmFja2Vu
ZF9jaGFubmVsX2RldGFjaChTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCkKIHsKKyAgICBTcGlj
ZVVzYkJhY2tlbmREZXZpY2UgKmQgPSBjaC0+YXR0YWNoZWQ7CisgICAgU3BpY2VVc2JFbXVsYXRl
ZERldmljZSAqZWRldiA9IGQgPyBkLT5lZGV2IDogTlVMTDsKICAgICBTUElDRV9ERUJVRygiJXMg
Pj4gY2ggJXAsIHdhcyBhdHRhY2hlZCAlcCIsIF9fRlVOQ1RJT05fXywgY2gsIGNoLT5hdHRhY2hl
ZCk7Ci0gICAgaWYgKCFjaC0+YXR0YWNoZWQpIHsKKyAgICBpZiAoIWQpIHsKICAgICAgICAgU1BJ
Q0VfREVCVUcoIiVzOiBub3RoaW5nIHRvIGRldGFjaCIsIF9fRlVOQ1RJT05fXyk7CiAgICAgICAg
IHJldHVybjsKICAgICB9CiAgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKICAgICAgICAgLyog
aXQgd2lsbCBjYWxsIGxpYnVzYl9jbG9zZSBpbnRlcm5hbGx5ICovCiAgICAgICAgIHVzYnJlZGly
aG9zdF9zZXRfZGV2aWNlKGNoLT51c2JyZWRpcmhvc3QsIE5VTEwpOworICAgIH0gZWxzZSBpZiAo
Y2gtPnBhcnNlcikgeworICAgICAgICBpZiAoZWRldikgeworICAgICAgICAgICAgZGV2aWNlX29w
cyhlZGV2KS0+ZGV0YWNoKGVkZXYpOworICAgICAgICB9CisgICAgICAgIHVzYnJlZGlycGFyc2Vy
X3NlbmRfZGV2aWNlX2Rpc2Nvbm5lY3QoY2gtPnBhcnNlcik7CisgICAgICAgIHVzYnJlZGlyX3dy
aXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsKKyAgICAgICAgY2gtPndhaXRfZGlzY19hY2sgPSB1c2Jy
ZWRpcnBhcnNlcl9wZWVyX2hhc19jYXAoY2gtPnBhcnNlciwKKyAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNiX3JlZGlyX2NhcF9kZXZpY2Vf
ZGlzY29ubmVjdF9hY2spOworICAgICAgICBpZiAoIWNoLT53YWl0X2Rpc2NfYWNrKSB7CisgICAg
ICAgICAgICBjaC0+dXNicmVkaXJob3N0ID0gY2gtPmhpZGRlbl9ob3N0OworICAgICAgICAgICAg
Y2gtPnBhcnNlciA9IE5VTEw7CisgICAgICAgIH0KICAgICB9CiAgICAgU1BJQ0VfREVCVUcoIiVz
IGNoICVwLCBkZXRhY2ggZG9uZSIsIF9fRlVOQ1RJT05fXywgY2gpOwogICAgIGNoLT5hdHRhY2hl
ZC0+YXR0YWNoZWRfdG8gPSBOVUxMOwogICAgIGNoLT5hdHRhY2hlZCA9IE5VTEw7CisgICAgY2gt
PnJlamVjdGVkID0gMDsKIH0KIAogU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqc3BpY2VfdXNiX2Jh
Y2tlbmRfY2hhbm5lbF9uZXcoU3BpY2VVc2JCYWNrZW5kICpiZSwKQEAgLTc4MiwxMCArMTMxOSwx
NSBAQCBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpzcGljZV91c2JfYmFja2VuZF9jaGFubmVsX25l
dyhTcGljZVVzYkJhY2tlbmQgKmJlLAogICAgICAgICAgICAgdXNicmVkaXJob3N0X2ZsX3dyaXRl
X2NiX293bnNfYnVmZmVyKTsKICAgICAgICAgZ193YXJuX2lmX2ZhaWwoY2gtPnVzYnJlZGlyaG9z
dCAhPSBOVUxMKTsKICAgICB9CisKICAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgeworICAgICAg
ICBjaC0+aGlkZGVuX3BhcnNlciA9IGNyZWF0ZV9wYXJzZXIoY2gpOworICAgICAgICBjaC0+aGlk
ZGVuX2hvc3QgPSBjaC0+dXNicmVkaXJob3N0OwogICAgICAgICB1c2JyZWRpcmhvc3Rfc2V0X2J1
ZmZlcmVkX291dHB1dF9zaXplX2NiKGNoLT51c2JyZWRpcmhvc3QsIHVzYnJlZGlyX2J1ZmZlcmVk
X291dHB1dF9zaXplX2NhbGxiYWNrKTsKLSAgICB9IGVsc2UgewotICAgICAgICBnX2ZyZWUoY2gp
OworICAgIH0KKworICAgIGlmICghY2gtPmhpZGRlbl9wYXJzZXIpIHsKKyAgICAgICAgc3BpY2Vf
dXNiX2JhY2tlbmRfY2hhbm5lbF9kZWxldGUoY2gpOwogICAgICAgICBjaCA9IE5VTEw7CiAgICAg
fQogCkBAIC03OTUsOSArMTMzNywxNCBAQCBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpzcGljZV91
c2JfYmFja2VuZF9jaGFubmVsX25ldyhTcGljZVVzYkJhY2tlbmQgKmJlLAogCiB2b2lkIHNwaWNl
X3VzYl9iYWNrZW5kX2NoYW5uZWxfZmx1c2hfd3JpdGVzKFNwaWNlVXNiQmFja2VuZENoYW5uZWwg
KmNoKQogewotICAgIFNQSUNFX0RFQlVHKCIlcyAlcCwgaG9zdCAlcCIsIF9fRlVOQ1RJT05fXywg
Y2gsIGNoLT51c2JyZWRpcmhvc3QpOworICAgIFNQSUNFX0RFQlVHKCIlcyAlcCBpcyB1cCIsIF9f
RlVOQ1RJT05fXywgY2gpOwogICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7CiAgICAgICAgIHVz
YnJlZGlyaG9zdF93cml0ZV9ndWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3QpOworICAgICAgICBp
bml0aWFsaXplX3BhcnNlcihjaCwgRkFMU0UpOworICAgIH0gZWxzZSB7CisgICAgICAgIGluaXRp
YWxpemVfcGFyc2VyKGNoLCBUUlVFKTsKKyAgICAgICAgY2gtPnBhcnNlciA9IGNoLT5oaWRkZW5f
cGFyc2VyOworICAgICAgICB1c2JyZWRpcnBhcnNlcl9kb193cml0ZShjaC0+cGFyc2VyKTsKICAg
ICB9CiB9CiAKQEAgLTgwNywxMiArMTM1NCwxNiBAQCB2b2lkIHNwaWNlX3VzYl9iYWNrZW5kX2No
YW5uZWxfZGVsZXRlKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoKQogICAgIGlmICghY2gpIHsK
ICAgICAgICAgcmV0dXJuOwogICAgIH0KLSAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgewotICAg
ICAgICB1c2JyZWRpcmhvc3RfY2xvc2UoY2gtPnVzYnJlZGlyaG9zdCk7CisgICAgaWYgKGNoLT5o
aWRkZW5faG9zdCkgeworICAgICAgICB1c2JyZWRpcmhvc3RfY2xvc2UoY2gtPmhpZGRlbl9ob3N0
KTsKKyAgICB9CisgICAgaWYgKGNoLT5oaWRkZW5fcGFyc2VyKSB7CisgICAgICAgIHVzYnJlZGly
cGFyc2VyX2Rlc3Ryb3koY2gtPmhpZGRlbl9wYXJzZXIpOwogICAgIH0KIAogICAgIGlmIChjaC0+
cnVsZXMpIHsKLSAgICAgICAgZ19mcmVlKGNoLT5ydWxlcyk7CisgICAgICAgIC8qIHJ1bGVzIHdl
cmUgYWxsb2NhdGVkIGJ5IHVzYnJlZGlycGFyc2VyICovCisgICAgICAgIGZyZWUoY2gtPnJ1bGVz
KTsKICAgICB9CiAKICAgICBnX2ZyZWUoY2gpOwotLSAKMi4xNy4xCgpfX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpTcGljZS1kZXZlbCBtYWlsaW5nIGxpc3QK
U3BpY2UtZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0
b3Aub3JnL21haWxtYW4vbGlzdGluZm8vc3BpY2UtZGV2ZWw=
