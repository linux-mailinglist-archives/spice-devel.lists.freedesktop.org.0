Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 9F69B9E3F4
	for <lists+spice-devel@lfdr.de>; Tue, 27 Aug 2019 11:23:16 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 2482C89890;
	Tue, 27 Aug 2019 09:23:15 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 55C468987C
 for <spice-devel@lists.freedesktop.org>; Tue, 27 Aug 2019 09:23:13 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx04.intmail.prod.int.phx2.redhat.com
 [10.5.11.14])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 0113C308FB9A;
 Tue, 27 Aug 2019 09:23:13 +0000 (UTC)
Received: from fziglio.remote.csb (ovpn-204-114.brq.redhat.com [10.40.204.114])
 by smtp.corp.redhat.com (Postfix) with ESMTP id DC6BD5D9CC;
 Tue, 27 Aug 2019 09:23:10 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Tue, 27 Aug 2019 10:22:23 +0100
Message-Id: <20190827092246.10276-7-fziglio@redhat.com>
In-Reply-To: <20190827092246.10276-1-fziglio@redhat.com>
References: <20190827092246.10276-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.14
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.43]); Tue, 27 Aug 2019 09:23:13 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-gtk v4 06/29] usb-redir: extend USB
 backend to support emulated devices
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

RnJvbTogWXVyaSBCZW5kaXRvdmljaCA8eXVyaS5iZW5kaXRvdmljaEBkYXluaXguY29tPgoKUmVk
aXJlY3Rpb24gb2YgZW11bGF0ZWQgZGV2aWNlcyByZXF1aXJlcyBzcGVjaWFsIGFwcHJvYWNoLAph
cyB1c2JyZWRpcmhvc3QgY2FuJ3QgYmUgdXNlZCBmb3IgdGhhdCAoaXQgd29ya3Mgb25seSB3aXRo
CmxpYnVzYiBkZXZpY2VzKS4gRm9yIGVtdWxhdGVkIGRldmljZXMgd2UgY3JlYXRlIGluc3RhbmNl
IG9mCnVzYnJlZGlycGFyc2VyIHRoYXQgaW1wbGVtZW50cyBVU0IgcmVkaXJlY3Rpb24gcHJvdG9j
b2wuCkluIG9yZGVyIHRvIHdvcmsgd2l0aCB0aGUgc2FtZSBzZXQgb2YgcHJvdG9jb2wgY2FwYWJp
bGl0aWVzCnRoYXQgdXNicmVkaXJob3N0IHNldHMgdXAgd2l0aCByZW1vdGUgc2lkZSwgdGhlIHBh
cnNlciBzaGFsbDoKLSBub3Qgc2VuZCBpdHMgb3duICdoZWxsbycgdG8gdGhlIHNlcnZlcgotIGlu
aXRpYWxpemUgdGhlIHNhbWUgY2FwYWJpbGl0aWVzIHRoYXQgdXNicmVkaXJob3N0Ci0gcmVjZWl2
ZSB0aGUgc2FtZSAnaGVsbG8nIHJlc3BvbnNlCkZvciB0aGF0IHdlIGFuYWx5emUgJ2hlbGxvJyBz
ZW50IGJ5IFVTQiByZWRpciBwYXJzZXIgYW5kCmV4dHJhY3Qgc2V0IG9mIGNhcGFiaWxpdGllcyBm
cm9tIGl0IGFuZCB1cG9uIHJlY2VpdmUgb2YKJ2hlbGxvJyByZXNwb25zZSB3ZSBwcm92aWRlIGl0
IGFsc28gdG8gdGhlIHBhcnNlci4KV2hlbiBsaWJ1c2IgZGV2aWNlIGlzIHJlZGlyZWN0ZWQgdmlh
IGEgY2hhbm5lbCwgaW5zdGFuY2Ugb2YKdXNicmVkaXJob3N0IHNlcnZlcyBpdC4KV2hlbiBlbXVs
YXRlZCBkZXZpY2UgaXMgcmVkaXJlY3RlZCB2aWEgYSBjaGFubmVsLCBpbnN0YW5jZQpvZiB1c2Jy
ZWRpcnBhcnNlciBkb2VzIHRoZSBqb2IuCgpTaWduZWQtb2ZmLWJ5OiBZdXJpIEJlbmRpdG92aWNo
IDx5dXJpLmJlbmRpdG92aWNoQGRheW5peC5jb20+Ci0tLQogc3JjL3VzYi1iYWNrZW5kLmMgfCA2
MTYgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKy0tLQogMSBmaWxl
IGNoYW5nZWQsIDU4MCBpbnNlcnRpb25zKCspLCAzNiBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQg
YS9zcmMvdXNiLWJhY2tlbmQuYyBiL3NyYy91c2ItYmFja2VuZC5jCmluZGV4IDI1MmMwYTY0Li45
MzY5YmY1ZSAxMDA2NDQKLS0tIGEvc3JjL3VzYi1iYWNrZW5kLmMKKysrIGIvc3JjL3VzYi1iYWNr
ZW5kLmMKQEAgLTU1LDYgKzU1LDcgQEAgc3RydWN0IF9TcGljZVVzYkJhY2tlbmREZXZpY2UKICAg
ICBnaW50IHJlZl9jb3VudDsKICAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICphdHRhY2hlZF90
bzsKICAgICBVc2JEZXZpY2VJbmZvcm1hdGlvbiBkZXZpY2VfaW5mbzsKKyAgICBnYm9vbGVhbiBl
ZGV2X2NvbmZpZ3VyZWQ7CiB9OwogCiBzdHJ1Y3QgX1NwaWNlVXNiQmFja2VuZApAQCAtODAsMTAg
KzgxLDIwIEBAIHN0cnVjdCBfU3BpY2VVc2JCYWNrZW5kCiBzdHJ1Y3QgX1NwaWNlVXNiQmFja2Vu
ZENoYW5uZWwKIHsKICAgICBzdHJ1Y3QgdXNicmVkaXJob3N0ICp1c2JyZWRpcmhvc3Q7CisgICAg
c3RydWN0IHVzYnJlZGlyaG9zdCAqaGlkZGVuX2hvc3Q7CisgICAgc3RydWN0IHVzYnJlZGlycGFy
c2VyICpwYXJzZXI7CisgICAgc3RydWN0IHVzYnJlZGlycGFyc2VyICpoaWRkZW5fcGFyc2VyOwog
ICAgIHVpbnQ4X3QgKnJlYWRfYnVmOwogICAgIGludCByZWFkX2J1Zl9zaXplOwogICAgIHN0cnVj
dCB1c2JyZWRpcmZpbHRlcl9ydWxlICpydWxlczsKICAgICBpbnQgcnVsZXNfY291bnQ7CisgICAg
dWludDMyX3QgaG9zdF9jYXBzOworICAgIHVpbnQzMl90IHBhcnNlcl9pbml0X2RvbmUgIDogMTsK
KyAgICB1aW50MzJfdCBwYXJzZXJfd2l0aF9oZWxsbyA6IDE7CisgICAgdWludDMyX3QgaGVsbG9f
ZG9uZV9wYXJzZXIgOiAxOworICAgIHVpbnQzMl90IGhlbGxvX3NlbnQgICAgICAgIDogMTsKKyAg
ICB1aW50MzJfdCByZWplY3RlZCAgICAgICAgICA6IDE7CisgICAgdWludDMyX3Qgd2FpdF9kaXNj
X2FjayAgICAgOiAxOwogICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqYXR0YWNoZWQ7CiAgICAg
U3BpY2VVc2JyZWRpckNoYW5uZWwgICp1c2VyX2RhdGE7CiAgICAgU3BpY2VVc2JCYWNrZW5kICpi
YWNrZW5kOwpAQCAtMzU1LDcgKzM2NiwxMSBAQCBnYm9vbGVhbiBzcGljZV91c2JfYmFja2VuZF9k
ZXZpY2VfaXNvY2goU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkZXYpCiAgICAgZ2ludCBpLCBqLCBr
OwogICAgIGludCByYzsKIAotICAgIGdfcmV0dXJuX3ZhbF9pZl9mYWlsKGxpYmRldiAhPSBOVUxM
LCAwKTsKKyAgICBnX3JldHVybl92YWxfaWZfZmFpbChsaWJkZXYgIT0gTlVMTCB8fCBkZXYtPmVk
ZXYgIT0gTlVMTCwgMCk7CisgICAgaWYgKGRldi0+ZWRldikgeworICAgICAgICAvKiBjdXJyZW50
bHkgd2UgZG8gbm90IGVtdWxhdGUgaXNvY2ggZGV2aWNlcyAqLworICAgICAgICByZXR1cm4gRkFM
U0U7CisgICAgfQogCiAgICAgcmMgPSBsaWJ1c2JfZ2V0X2FjdGl2ZV9jb25maWdfZGVzY3JpcHRv
cihsaWJkZXYsICZjb25mX2Rlc2MpOwogICAgIGlmIChyYykgewpAQCAtMzkwLDEzICs0MDUsMTYg
QEAgZnJvbSBib3RoIHRoZSBtYWluIHRocmVhZCBhcyB3ZWxsIGFzIGZyb20gdGhlIHVzYiBldmVu
dCBoYW5kbGluZyB0aHJlYWQgKi8KIHN0YXRpYyB2b2lkIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2Nh
bGxiYWNrKHZvaWQgKnVzZXJfZGF0YSkKIHsKICAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpj
aCA9IHVzZXJfZGF0YTsKLSAgICBpZiAoIWNoLT51c2JyZWRpcmhvc3QpIHsKLSAgICAgICAgLyog
anVzdCB0byBiZSBvbiB0aGUgc2FmZSBzaWRlICovCi0gICAgICAgIHJldHVybjsKLSAgICB9CiAg
ICAgaWYgKGlzX2NoYW5uZWxfcmVhZHkoY2gtPnVzZXJfZGF0YSkpIHsKLSAgICAgICAgU1BJQ0Vf
REVCVUcoIiVzIGNoICVwIC0+IHVzYnJlZGlyaG9zdCIsIF9fRlVOQ1RJT05fXywgY2gpOwotICAg
ICAgICB1c2JyZWRpcmhvc3Rfd3JpdGVfZ3Vlc3RfZGF0YShjaC0+dXNicmVkaXJob3N0KTsKKyAg
ICAgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIl
cyBjaCAlcCAtPiB1c2JyZWRpcmhvc3QiLCBfX0ZVTkNUSU9OX18sIGNoKTsKKyAgICAgICAgICAg
IHVzYnJlZGlyaG9zdF93cml0ZV9ndWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3QpOworICAgICAg
ICB9IGVsc2UgaWYgKGNoLT5wYXJzZXIpIHsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBj
aCAlcCAtPiBwYXJzZXIiLCBfX0ZVTkNUSU9OX18sIGNoKTsKKyAgICAgICAgICAgIHVzYnJlZGly
cGFyc2VyX2RvX3dyaXRlKGNoLT5wYXJzZXIpOworICAgICAgICB9IGVsc2UgeworICAgICAgICAg
ICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIChOT1QgQUNUSVZFKSIsIF9fRlVOQ1RJT05fXywgY2gp
OworICAgICAgICB9CiAgICAgfSBlbHNlIHsKICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVw
IChub3QgcmVhZHkpIiwgX19GVU5DVElPTl9fLCBjaCk7CiAgICAgfQpAQCAtNTUxLDEzICs1Njks
NTIgQEAgdm9pZCBzcGljZV91c2JfYmFja2VuZF9kZXZpY2VfdW5yZWYoU3BpY2VVc2JCYWNrZW5k
RGV2aWNlICpkZXYpCiAgICAgfQogfQogCi1pbnQgc3BpY2VfdXNiX2JhY2tlbmRfZGV2aWNlX2No
ZWNrX2ZpbHRlcigKLSAgICBTcGljZVVzYkJhY2tlbmREZXZpY2UgKmRldiwKLSAgICBjb25zdCBz
dHJ1Y3QgdXNicmVkaXJmaWx0ZXJfcnVsZSAqcnVsZXMsCi0gICAgaW50IGNvdW50KQorc3RhdGlj
IGludCBjaGVja19lZGV2X2RldmljZV9maWx0ZXIoU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkZXYs
CisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJ1Y3QgdXNicmVk
aXJmaWx0ZXJfcnVsZSAqcnVsZXMsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBpbnQgY291bnQpCiB7Ci0gICAgcmV0dXJuIHVzYnJlZGlyaG9zdF9jaGVja19kZXZpY2VfZmls
dGVyKAotICAgICAgICBydWxlcywgY291bnQsIGRldi0+bGlidXNiX2RldmljZSwgMCk7CisgICAg
U3BpY2VVc2JFbXVsYXRlZERldmljZSAqZWRldiA9IGRldi0+ZWRldjsKKyAgICB1aW50OF90IGNs
c1szMl0sIHN1YmNsc1szMl0sIHByb3RvWzMyXSwgKmNmZywgaWZudW0gPSAwOworICAgIHVpbnQx
Nl90IHNpemUsIG9mZnNldCA9IDA7CisgICAgaWYgKCFlZGV2KSB7CisgICAgICAgIHJldHVybiAx
OworICAgIH0KKyAgICBpZiAoIWRldmljZV9vcHMoZWRldiktPmdldF9kZXNjcmlwdG9yKGVkZXYs
IExJQlVTQl9EVF9DT05GSUcsIDAsICh2b2lkICoqKSZjZmcsICZzaXplKSkgeworICAgICAgICBy
ZXR1cm4gMTsKKyAgICB9CisgICAgd2hpbGUgKChvZmZzZXQgKyAxKSA8IHNpemUpIHsKKyAgICAg
ICAgdWludDhfdCBsZW4gID0gY2ZnW29mZnNldF07CisgICAgICAgIHVpbnQ4X3QgdHlwZSA9IGNm
Z1tvZmZzZXQgKyAxXTsKKyAgICAgICAgaWYgKChvZmZzZXQgKyBsZW4pID4gc2l6ZSkgeworICAg
ICAgICAgICAgYnJlYWs7CisgICAgICAgIH0KKyAgICAgICAgaWYgKHR5cGUgPT0gTElCVVNCX0RU
X0lOVEVSRkFDRSkgeworICAgICAgICAgICAgY2xzW2lmbnVtXSA9IGNmZ1tvZmZzZXQgKyA1XTsK
KyAgICAgICAgICAgIHN1YmNsc1tpZm51bV0gPSBjZmdbb2Zmc2V0ICsgNl07CisgICAgICAgICAg
ICBwcm90b1tpZm51bV0gPSBjZmdbb2Zmc2V0ICsgN107CisgICAgICAgICAgICBpZm51bSsrOwor
ICAgICAgICB9CisgICAgICAgIG9mZnNldCArPSBsZW47CisgICAgfQorCisgICAgcmV0dXJuIHVz
YnJlZGlyZmlsdGVyX2NoZWNrKHJ1bGVzLCBjb3VudCwKKyAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgZGV2LT5kZXZpY2VfaW5mby5jbGFzcywKKyAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgZGV2LT5kZXZpY2VfaW5mby5zdWJjbGFzcywKKyAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgZGV2LT5kZXZpY2VfaW5mby5wcm90b2NvbCwKKyAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgY2xzLCBzdWJjbHMsIHByb3RvLCBpZm51bSwKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgZGV2LT5kZXZpY2VfaW5mby52aWQsCisgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIGRldi0+ZGV2aWNlX2luZm8ucGlkLAorICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICBkZXYtPmRldmljZV9pbmZvLmJjZFVTQiwgMCk7Cit9CisKK2ludCBzcGlj
ZV91c2JfYmFja2VuZF9kZXZpY2VfY2hlY2tfZmlsdGVyKFNwaWNlVXNiQmFja2VuZERldmljZSAq
ZGV2LAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3Ry
dWN0IHVzYnJlZGlyZmlsdGVyX3J1bGUgKnJ1bGVzLCBpbnQgY291bnQpCit7CisgICAgaWYgKGRl
di0+bGlidXNiX2RldmljZSkgeworICAgICAgICByZXR1cm4gdXNicmVkaXJob3N0X2NoZWNrX2Rl
dmljZV9maWx0ZXIocnVsZXMsIGNvdW50LCBkZXYtPmxpYnVzYl9kZXZpY2UsIDApOworICAgIH0g
ZWxzZSB7CisgICAgICAgIHJldHVybiBjaGVja19lZGV2X2RldmljZV9maWx0ZXIoZGV2LCBydWxl
cywgY291bnQpOworICAgIH0KIH0KIAogc3RhdGljIGludCB1c2JyZWRpcl9yZWFkX2NhbGxiYWNr
KHZvaWQgKnVzZXJfZGF0YSwgdWludDhfdCAqZGF0YSwgaW50IGNvdW50KQpAQCAtNjIxLDYgKzY3
OCwxNyBAQCBzdGF0aWMgaW50IHVzYnJlZGlyX3dyaXRlX2NhbGxiYWNrKHZvaWQgKnVzZXJfZGF0
YSwgdWludDhfdCAqZGF0YSwgaW50IGNvdW50KQogICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwg
KmNoID0gdXNlcl9kYXRhOwogICAgIGludCByZXM7CiAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVw
LCAlZCBieXRlcyIsIF9fRlVOQ1RJT05fXywgY2gsIGNvdW50KTsKKyAgICBpZiAoIWNoLT5oZWxs
b19zZW50KSB7CisgICAgICAgIC8qIGhlbGxvIGlzIHNob3J0IGhlYWRlciAoMTIpICsgaGVsbG8g
c3RydWN0ICg2NCkgKyBjYXBhYmlsaXRpZXMgKDQpICovCisgICAgICAgIGludCBoZWxsb19zaXpl
ID0gc2l6ZW9mKHN0cnVjdCB1c2JfcmVkaXJfaGVhZGVyKSArIHNpemVvZihzdHJ1Y3QgdXNiX3Jl
ZGlyX2hlbGxvX2hlYWRlcik7CisgICAgICAgIGNoLT5oZWxsb19zZW50ID0gMTsKKyAgICAgICAg
aWYgKGNvdW50ID09IGhlbGxvX3NpemUpIHsKKyAgICAgICAgICAgIG1lbWNweSgmY2gtPmhvc3Rf
Y2FwcywgZGF0YSArIGhlbGxvX3NpemUgLSBzaXplb2YoY2gtPmhvc3RfY2FwcyksCisgICAgICAg
ICAgICAgICAgICAgc2l6ZW9mKGNoLT5ob3N0X2NhcHMpKTsKKyAgICAgICAgICAgIFNQSUNFX0RF
QlVHKCIlcyBjaCAlcCwgc2VuZGluZyBmaXJzdCBoZWxsbywgY2FwcyAlMDhYIiwKKyAgICAgICAg
ICAgICAgICAgICAgICAgIF9fRlVOQ1RJT05fXywgY2gsIGNoLT5ob3N0X2NhcHMpOworICAgICAg
ICB9CisgICAgfQogICAgIHJlcyA9IHNwaWNlX3VzYnJlZGlyX3dyaXRlX2NhbGxiYWNrKGNoLT51
c2VyX2RhdGEsIGRhdGEsIGNvdW50KTsKICAgICByZXR1cm4gcmVzOwogfQpAQCAtNjQxLDYgKzcw
OSwyNyBAQCBpbnQgc3BpY2VfdXNiX2JhY2tlbmRfcmVhZF9ndWVzdF9kYXRhKFNwaWNlVXNiQmFj
a2VuZENoYW5uZWwgKmNoLCB1aW50OF90ICpkYXRhLAogICAgIGNoLT5yZWFkX2J1Zl9zaXplID0g
Y291bnQ7CiAgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKICAgICAgICAgcmVzID0gdXNicmVk
aXJob3N0X3JlYWRfZ3Vlc3RfZGF0YShjaC0+dXNicmVkaXJob3N0KTsKKyAgICAgICAgaWYgKCFj
aC0+aGVsbG9fZG9uZV9wYXJzZXIpIHsKKyAgICAgICAgICAgIGludCByZXNfcGFyc2VyOworICAg
ICAgICAgICAgLyogdXNicmVkaXJob3N0IHNob3VsZCBjb25zdW1lIGhlbGxvIHJlc3BvbnNlICov
CisgICAgICAgICAgICBnX3JldHVybl92YWxfaWZfZmFpbChjaC0+cmVhZF9idWYgPT0gTlVMTCwg
VVNCX1JFRElSX0VSUk9SX1JFQURfUEFSU0UpOworCisgICAgICAgICAgICBjaC0+cmVhZF9idWYg
PSBkYXRhOworICAgICAgICAgICAgY2gtPnJlYWRfYnVmX3NpemUgPSBjb3VudDsKKyAgICAgICAg
ICAgIGNoLT5oZWxsb19kb25lX3BhcnNlciA9IDE7CisgICAgICAgICAgICBpZiAoY2gtPmF0dGFj
aGVkICYmIGNoLT5hdHRhY2hlZC0+ZWRldikgeworICAgICAgICAgICAgICAgIC8qIGNhc2Ugb2Yg
Q0Qgc2hhcmluZyBvbiBjb25uZWN0ICovCisgICAgICAgICAgICAgICAgY2gtPnVzYnJlZGlyaG9z
dCA9IE5VTEw7CisgICAgICAgICAgICAgICAgY2gtPnBhcnNlciA9IGNoLT5oaWRkZW5fcGFyc2Vy
OworICAgICAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlczogc3dpdGNoICVwIHRvIHBhcnNlciIs
IF9fRlVOQ1RJT05fXywgY2gpOworICAgICAgICAgICAgfQorICAgICAgICAgICAgcmVzX3BhcnNl
ciA9IHVzYnJlZGlycGFyc2VyX2RvX3JlYWQoY2gtPmhpZGRlbl9wYXJzZXIpOworICAgICAgICAg
ICAgaWYgKHJlcyA+PSAwKSB7CisgICAgICAgICAgICAgICAgcmVzID0gcmVzX3BhcnNlcjsKKyAg
ICAgICAgICAgIH0KKyAgICAgICAgfQorICAgIH0gZWxzZSBpZiAoY2gtPnBhcnNlcikgeworICAg
ICAgICByZXMgPSB1c2JyZWRpcnBhcnNlcl9kb19yZWFkKGNoLT5wYXJzZXIpOwogICAgIH0gZWxz
ZSB7CiAgICAgICAgIHJlcyA9IFVTQl9SRURJUl9FUlJPUl9JTzsKICAgICB9CkBAIC02NjEsNiAr
NzUwLDExIEBAIGludCBzcGljZV91c2JfYmFja2VuZF9yZWFkX2d1ZXN0X2RhdGEoU3BpY2VVc2JC
YWNrZW5kQ2hhbm5lbCAqY2gsIHVpbnQ4X3QgKmRhdGEsCiAgICAgfQogICAgIFNQSUNFX0RFQlVH
KCIlcyBjaCAlcCwgJWQgYnl0ZXMsIHJlcyAlZCIsIF9fRlVOQ1RJT05fXywgY2gsIGNvdW50LCBy
ZXMpOwogCisgICAgaWYgKGNoLT5yZWplY3RlZCkgeworICAgICAgICBjaC0+cmVqZWN0ZWQgPSAw
OworICAgICAgICByZXMgPSBVU0JfUkVESVJfRVJST1JfREVWX1JFSkVDVEVEOworICAgIH0KKwog
ICAgIHJldHVybiByZXM7CiB9CiAKQEAgLTY5MCwxMyArNzg0LDQyNiBAQCBHRXJyb3IgKnNwaWNl
X3VzYl9iYWNrZW5kX2dldF9lcnJvcl9kZXRhaWxzKGludCBlcnJvcl9jb2RlLCBnY2hhciAqZGVz
YykKIHZvaWQgc3BpY2VfdXNiX2JhY2tlbmRfcmV0dXJuX3dyaXRlX2RhdGEoU3BpY2VVc2JCYWNr
ZW5kQ2hhbm5lbCAqY2gsIHZvaWQgKmRhdGEpCiB7CiAgICAgaWYgKGNoLT51c2JyZWRpcmhvc3Qp
IHsKLSAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIiwgX19GVU5DVElPTl9fLCBjaCk7Cisg
ICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAtPiB1c2JyZWRpcmhvc3QiLCBfX0ZVTkNUSU9O
X18sIGNoKTsKICAgICAgICAgdXNicmVkaXJob3N0X2ZyZWVfd3JpdGVfYnVmZmVyKGNoLT51c2Jy
ZWRpcmhvc3QsIGRhdGEpOworICAgIH0gZWxzZSBpZiAoY2gtPnBhcnNlcikgeworICAgICAgICBT
UElDRV9ERUJVRygiJXMgY2ggJXAgLT4gcGFyc2VyIiwgX19GVU5DVElPTl9fLCBjaCk7CisgICAg
ICAgIHVzYnJlZGlycGFyc2VyX2ZyZWVfd3JpdGVfYnVmZmVyKGNoLT5wYXJzZXIsIGRhdGEpOwog
ICAgIH0gZWxzZSB7CiAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAtIE5PQk9EWSBUTyBD
QUxMIiwgX19GVU5DVElPTl9fLCBjaCk7CiAgICAgfQogfQogCitzdGF0aWMgdm9pZCB1c2JyZWRp
cl9jb250cm9sX3BhY2tldCh2b2lkICpwcml2LAorICAgIHVpbnQ2NF90IGlkLCBzdHJ1Y3QgdXNi
X3JlZGlyX2NvbnRyb2xfcGFja2V0X2hlYWRlciAqaCwKKyAgICB1aW50OF90ICpkYXRhLCBpbnQg
ZGF0YV9sZW4pCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAg
IFNwaWNlVXNiQmFja2VuZERldmljZSAqZCA9IGNoLT5hdHRhY2hlZDsKKyAgICBTcGljZVVzYkVt
dWxhdGVkRGV2aWNlICplZGV2ID0gZCA/IGQtPmVkZXYgOiBOVUxMOworICAgIHN0cnVjdCB1c2Jf
cmVkaXJfY29udHJvbF9wYWNrZXRfaGVhZGVyIHJlc3BvbnNlID0gKmg7CisgICAgdWludDhfdCBy
ZXF0eXBlID0gaC0+cmVxdWVzdHR5cGUgJiAweDdmOworICAgIGdib29sZWFuIGRvbmUgPSBGQUxT
RTsKKyAgICB2b2lkICpvdXRfYnVmZmVyID0gTlVMTDsKKworICAgIHJlc3BvbnNlLnN0YXR1cyA9
IHVzYl9yZWRpcl9zdGFsbDsKKyAgICBTUElDRV9ERUJVRygiJXMgJXA6IFRSVklMICUwMlggJTAy
WCAlMDRYICUwNFggJTA0WCIsCisgICAgICAgICAgICAgICAgX19GVU5DVElPTl9fLAorICAgICAg
ICAgICAgICAgIGNoLCBoLT5yZXF1ZXN0dHlwZSwgaC0+cmVxdWVzdCwKKyAgICAgICAgICAgICAg
ICBoLT52YWx1ZSwgaC0+aW5kZXgsIGgtPmxlbmd0aCk7CisKKyAgICBpZiAoIWVkZXYpIHsKKyAg
ICAgICAgU1BJQ0VfREVCVUcoIiVzOiBkZXZpY2Ugbm90IGF0dGFjaGVkIiwgX19GVU5DVElPTl9f
KTsKKyAgICAgICAgcmVzcG9uc2Uuc3RhdHVzID0gdXNiX3JlZGlyX2lvZXJyb3I7CisgICAgICAg
IGRvbmUgPSBUUlVFOworICAgIH0gZWxzZSBpZiAocmVxdHlwZSA9PSAoTElCVVNCX1JFUVVFU1Rf
VFlQRV9TVEFOREFSRCB8IExJQlVTQl9SRUNJUElFTlRfREVWSUNFKSAmJgorICAgICAgICAgICAg
ICAgaC0+cmVxdWVzdCA9PSBMSUJVU0JfUkVRVUVTVF9HRVRfREVTQ1JJUFRPUikgeworICAgICAg
ICB1aW50MTZfdCBzaXplOworICAgICAgICBkb25lID0gZGV2aWNlX29wcyhlZGV2KS0+Z2V0X2Rl
c2NyaXB0b3IoZWRldiwgaC0+dmFsdWUgPj4gOCwgaC0+dmFsdWUgJiAweGZmLAorICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJm91dF9idWZmZXIsICZzaXpl
KTsKKyAgICAgICAgcmVzcG9uc2UubGVuZ3RoID0gc2l6ZTsKKyAgICAgICAgaWYgKGRvbmUpIHsK
KyAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1cyA9IDA7CisgICAgICAgIH0KKyAgICAgICAgZG9u
ZSA9IFRSVUU7CisgICAgfQorCisgICAgaWYgKCFkb25lKSB7CisgICAgICAgIGRldmljZV9vcHMo
ZWRldiktPmNvbnRyb2xfcmVxdWVzdChlZGV2LCBkYXRhLCBkYXRhX2xlbiwgJnJlc3BvbnNlLCAm
b3V0X2J1ZmZlcik7CisgICAgICAgIGRvbmUgPSBUUlVFOworICAgIH0KKworICAgIGlmIChyZXNw
b25zZS5zdGF0dXMpIHsKKyAgICAgICAgcmVzcG9uc2UubGVuZ3RoID0gMDsKKyAgICB9IGVsc2Ug
aWYgKHJlc3BvbnNlLmxlbmd0aCA+IGgtPmxlbmd0aCkgeworICAgICAgICByZXNwb25zZS5sZW5n
dGggPSBoLT5sZW5ndGg7CisgICAgfQorCisgICAgU1BJQ0VfREVCVUcoIiVzIHJlc3BvbmRpbmcg
d2l0aCBwYXlsb2FkIG9mICUwMlgsIHN0YXR1cyAlWCIsCisgICAgICAgICAgICAgICAgX19GVU5D
VElPTl9fLCByZXNwb25zZS5sZW5ndGgsIHJlc3BvbnNlLnN0YXR1cyk7CisgICAgdXNicmVkaXJw
YXJzZXJfc2VuZF9jb250cm9sX3BhY2tldChjaC0+cGFyc2VyLCBpZCwgJnJlc3BvbnNlLAorICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UubGVuZ3RoID8gb3V0
X2J1ZmZlciA6IE5VTEwsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBy
ZXNwb25zZS5sZW5ndGgpOworCisgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2soY2gp
OworICAgIHVzYnJlZGlycGFyc2VyX2ZyZWVfcGFja2V0X2RhdGEoY2gtPnBhcnNlciwgZGF0YSk7
Cit9CisKK3N0YXRpYyB2b2lkIHVzYnJlZGlyX2J1bGtfcGFja2V0KHZvaWQgKnByaXYsCisgICAg
dWludDY0X3QgaWQsIHN0cnVjdCB1c2JfcmVkaXJfYnVsa19wYWNrZXRfaGVhZGVyICpoLAorICAg
IHVpbnQ4X3QgKmRhdGEsIGludCBkYXRhX2xlbikKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFu
bmVsICpjaCA9IHByaXY7CisgICAgU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkID0gY2gtPmF0dGFj
aGVkOworICAgIFNwaWNlVXNiRW11bGF0ZWREZXZpY2UgKmVkZXYgPSBkID8gZC0+ZWRldiA6IE5V
TEw7CisgICAgc3RydWN0IHVzYl9yZWRpcl9idWxrX3BhY2tldF9oZWFkZXIgaG91dCA9ICpoOwor
ICAgIHVpbnQzMl90IGxlbiA9IChoLT5sZW5ndGhfaGlnaCA8PCAxNikgfCBoLT5sZW5ndGg7Cisg
ICAgU1BJQ0VfREVCVUcoIiVzICVwOiBlcCAlWCwgbGVuICV1LCBpZCAlIiBHX0dVSU5UNjRfRk9S
TUFULCBfX0ZVTkNUSU9OX18sCisgICAgICAgICAgICAgICAgY2gsIGgtPmVuZHBvaW50LCBsZW4s
IGlkKTsKKworICAgIGlmICghZWRldikgeworICAgICAgICBTUElDRV9ERUJVRygiJXM6IGRldmlj
ZSBub3QgYXR0YWNoZWQiLCBfX0ZVTkNUSU9OX18pOworICAgICAgICBob3V0LnN0YXR1cyA9IHVz
Yl9yZWRpcl9pb2Vycm9yOworICAgICAgICBob3V0Lmxlbmd0aCA9IGhvdXQubGVuZ3RoX2hpZ2gg
PSAwOworICAgICAgICBTUElDRV9ERUJVRygiJXM6IHJlc3BvbmRpbmcgd2l0aCBaTFAgc3RhdHVz
ICVkIiwgX19GVU5DVElPTl9fLCBob3V0LnN0YXR1cyk7CisgICAgfSBlbHNlIGlmIChoLT5lbmRw
b2ludCAmIExJQlVTQl9FTkRQT0lOVF9JTikgeworICAgICAgICBpZiAoZGV2aWNlX29wcyhlZGV2
KS0+YnVsa19pbl9yZXF1ZXN0KGVkZXYsIGlkLCAmaG91dCkpIHsKKyAgICAgICAgICAgIHVzYnJl
ZGlycGFyc2VyX2ZyZWVfcGFja2V0X2RhdGEoY2gtPnBhcnNlciwgZGF0YSk7CisgICAgICAgICAg
ICAvKiBjb21wbGV0aW9uIGlzIGFzeW5jaHJvbm91cyAqLworICAgICAgICAgICAgcmV0dXJuOwor
ICAgICAgICB9CisgICAgfSBlbHNlIHsKKyAgICAgICAgaG91dC5zdGF0dXMgPSB1c2JfcmVkaXJf
c3RhbGw7CisgICAgICAgIGRldmljZV9vcHMoZWRldiktPmJ1bGtfb3V0X3JlcXVlc3QoZWRldiwg
aC0+ZW5kcG9pbnQsIGRhdGEsIGRhdGFfbGVuLCAmaG91dC5zdGF0dXMpOworICAgICAgICBTUElD
RV9ERUJVRygiJXM6IHJlc3BvbmRpbmcgc3RhdHVzICVkIiwgX19GVU5DVElPTl9fLCBob3V0LnN0
YXR1cyk7CisgICAgfQorCisgICAgdXNicmVkaXJwYXJzZXJfc2VuZF9idWxrX3BhY2tldChjaC0+
cGFyc2VyLCBpZCwgJmhvdXQsIE5VTEwsIDApOworICAgIHVzYnJlZGlycGFyc2VyX2ZyZWVfcGFj
a2V0X2RhdGEoY2gtPnBhcnNlciwgZGF0YSk7CisgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2Fs
bGJhY2soY2gpOworfQorCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9kZXZpY2VfcmVzZXQodm9pZCAq
cHJpdikKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU3Bp
Y2VVc2JCYWNrZW5kRGV2aWNlICpkID0gY2gtPmF0dGFjaGVkOworICAgIFNwaWNlVXNiRW11bGF0
ZWREZXZpY2UgKmVkZXYgPSBkID8gZC0+ZWRldiA6IE5VTEw7CisgICAgU1BJQ0VfREVCVUcoIiVz
IGNoICVwIiwgX19GVU5DVElPTl9fLCBjaCk7CisgICAgaWYgKGVkZXYpIHsKKyAgICAgICAgZGV2
aWNlX29wcyhlZGV2KS0+cmVzZXQoZWRldik7CisgICAgfQorfQorCitzdGF0aWMgdm9pZCB1c2Jy
ZWRpcl9pbnRlcmZhY2VfaW5mbyh2b2lkICpwcml2LAorICAgIHN0cnVjdCB1c2JfcmVkaXJfaW50
ZXJmYWNlX2luZm9faGVhZGVyICppbnRlcmZhY2VfaW5mbykKK3sKKyAgICBTcGljZVVzYkJhY2tl
bmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU1BJQ0VfREVCVUcoIiVzIG5vdCBpbXBsZW1lbnRl
ZCAlcCIsIF9fRlVOQ1RJT05fXywgY2gpOworfQorCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9pbnRl
cmZhY2VfZXBfaW5mbyh2b2lkICpwcml2LAorICAgIHN0cnVjdCB1c2JfcmVkaXJfZXBfaW5mb19o
ZWFkZXIgKmVwX2luZm8pCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2
OworICAgIFNQSUNFX0RFQlVHKCIlcyBub3QgaW1wbGVtZW50ZWQgJXAiLCBfX0ZVTkNUSU9OX18s
IGNoKTsKK30KKworc3RhdGljIHZvaWQgdXNicmVkaXJfc2V0X2NvbmZpZ3VyYXRpb24odm9pZCAq
cHJpdiwKKyAgICB1aW50NjRfdCBpZCwgc3RydWN0IHVzYl9yZWRpcl9zZXRfY29uZmlndXJhdGlv
bl9oZWFkZXIgKnNldF9jb25maWd1cmF0aW9uKQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5u
ZWwgKmNoID0gcHJpdjsKKyAgICBzdHJ1Y3QgdXNiX3JlZGlyX2NvbmZpZ3VyYXRpb25fc3RhdHVz
X2hlYWRlciBoOworICAgIGguc3RhdHVzID0gMDsKKyAgICBoLmNvbmZpZ3VyYXRpb24gPSBzZXRf
Y29uZmlndXJhdGlvbi0+Y29uZmlndXJhdGlvbjsKKyAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAs
IGNmZyAlZCIsIF9fRlVOQ1RJT05fXywgY2gsIGguY29uZmlndXJhdGlvbik7CisgICAgaWYgKGNo
LT5hdHRhY2hlZCkgeworICAgICAgICBjaC0+YXR0YWNoZWQtPmVkZXZfY29uZmlndXJlZCA9IGgu
Y29uZmlndXJhdGlvbiAhPSAwOworICAgIH0KKyAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2NvbmZp
Z3VyYXRpb25fc3RhdHVzKGNoLT5wYXJzZXIsIGlkLCAmaCk7CisgICAgdXNicmVkaXJfd3JpdGVf
Zmx1c2hfY2FsbGJhY2soY2gpOworfQorCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9nZXRfY29uZmln
dXJhdGlvbih2b2lkICpwcml2LCB1aW50NjRfdCBpZCkKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRD
aGFubmVsICpjaCA9IHByaXY7CisgICAgc3RydWN0IHVzYl9yZWRpcl9jb25maWd1cmF0aW9uX3N0
YXR1c19oZWFkZXIgaDsKKyAgICBoLnN0YXR1cyA9IDA7CisgICAgaC5jb25maWd1cmF0aW9uID0g
Y2gtPmF0dGFjaGVkICYmIGNoLT5hdHRhY2hlZC0+ZWRldl9jb25maWd1cmVkOworICAgIFNQSUNF
X0RFQlVHKCIlcyBjaCAlcCwgY2ZnICVkIiwgX19GVU5DVElPTl9fLCBjaCwgaC5jb25maWd1cmF0
aW9uKTsKKyAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2NvbmZpZ3VyYXRpb25fc3RhdHVzKGNoLT5w
YXJzZXIsIGlkLCAmaCk7CisgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2soY2gpOwor
fQorCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9zZXRfYWx0X3NldHRpbmcodm9pZCAqcHJpdiwKKyAg
ICB1aW50NjRfdCBpZCwgc3RydWN0IHVzYl9yZWRpcl9zZXRfYWx0X3NldHRpbmdfaGVhZGVyICpz
KQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBzdHJ1Y3Qg
dXNiX3JlZGlyX2FsdF9zZXR0aW5nX3N0YXR1c19oZWFkZXIgc2g7CisgICAgc2guc3RhdHVzID0g
KCFzLT5pbnRlcmZhY2UgJiYgIXMtPmFsdCkgPyAwIDogdXNiX3JlZGlyX3N0YWxsOworICAgIHNo
LmludGVyZmFjZSA9IHMtPmludGVyZmFjZTsKKyAgICBzaC5hbHQgPSBzLT5hbHQ7CisgICAgU1BJ
Q0VfREVCVUcoIiVzIGNoICVwLCAlZDolZCIsIF9fRlVOQ1RJT05fXywgY2gsIHMtPmludGVyZmFj
ZSwgcy0+YWx0KTsKKyAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2FsdF9zZXR0aW5nX3N0YXR1cyhj
aC0+cGFyc2VyLCBpZCwgJnNoKTsKKyAgICB1c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFjayhj
aCk7Cit9CisKK3N0YXRpYyB2b2lkIHVzYnJlZGlyX2dldF9hbHRfc2V0dGluZyh2b2lkICpwcml2
LAorICAgIHVpbnQ2NF90IGlkLCBzdHJ1Y3QgdXNiX3JlZGlyX2dldF9hbHRfc2V0dGluZ19oZWFk
ZXIgKnMpCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIHN0
cnVjdCB1c2JfcmVkaXJfYWx0X3NldHRpbmdfc3RhdHVzX2hlYWRlciBzaDsKKyAgICBzaC5zdGF0
dXMgPSAocy0+aW50ZXJmYWNlID09IDApID8gMCA6IHVzYl9yZWRpcl9zdGFsbDsKKyAgICBzaC5p
bnRlcmZhY2UgPSBzLT5pbnRlcmZhY2U7CisgICAgc2guYWx0ID0gMDsKKyAgICBTUElDRV9ERUJV
RygiJXMgY2ggJXAsIGlmICVkIiwgX19GVU5DVElPTl9fLCBjaCwgcy0+aW50ZXJmYWNlKTsKKyAg
ICB1c2JyZWRpcnBhcnNlcl9zZW5kX2FsdF9zZXR0aW5nX3N0YXR1cyhjaC0+cGFyc2VyLCBpZCwg
JnNoKTsKKyAgICB1c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFjayhjaCk7Cit9CisKK3N0YXRp
YyB2b2lkIHVzYnJlZGlyX2NhbmNlbF9kYXRhKHZvaWQgKnByaXYsIHVpbnQ2NF90IGlkKQorewor
ICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBTcGljZVVzYkJhY2tl
bmREZXZpY2UgKmQgPSBjaC0+YXR0YWNoZWQ7CisgICAgU3BpY2VVc2JFbXVsYXRlZERldmljZSAq
ZWRldiA9IGQgPyBkLT5lZGV2IDogTlVMTDsKKyAgICBpZiAoIWVkZXYpIHsKKyAgICAgICAgU1BJ
Q0VfREVCVUcoIiVzOiBkZXZpY2Ugbm90IGF0dGFjaGVkIiwgX19GVU5DVElPTl9fKTsKKyAgICAg
ICAgcmV0dXJuOworICAgIH0KKyAgICBkZXZpY2Vfb3BzKGVkZXYpLT5jYW5jZWxfcmVxdWVzdChl
ZGV2LCBpZCk7Cit9CisKK3N0YXRpYyB2b2lkIHVzYnJlZGlyX2ZpbHRlcl9yZWplY3Qodm9pZCAq
cHJpdikKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU1BJ
Q0VfREVCVUcoIiVzICVwIiwgX19GVU5DVElPTl9fLCBjaCk7CisgICAgY2gtPnJlamVjdGVkID0g
MTsKK30KKworLyogTm90ZSB0aGF0IHRoZSBvd25lcnNoaXAgb2YgdGhlIHJ1bGVzIGFycmF5IGlz
IHBhc3NlZCBvbiB0byB0aGUgY2FsbGJhY2suICovCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9maWx0
ZXJfZmlsdGVyKHZvaWQgKnByaXYsCisgICAgc3RydWN0IHVzYnJlZGlyZmlsdGVyX3J1bGUgKnIs
IGludCBjb3VudCkKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7Cisg
ICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwICVkIGZpbHRlcnMiLCBfX0ZVTkNUSU9OX18sIGNoLCBj
b3VudCk7CisKKyAgICBmcmVlKGNoLT5ydWxlcyk7CisKKyAgICBjaC0+cnVsZXMgPSByOworICAg
IGNoLT5ydWxlc19jb3VudCA9IGNvdW50OworICAgIGlmIChjb3VudCkgeworICAgICAgICBpbnQg
aTsKKyAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKKyAgICAgICAgICAgIFNQ
SUNFX0RFQlVHKCIlcyBjbGFzcyAlZCwgJVg6JVgiLAorICAgICAgICAgICAgICAgIHJbaV0uYWxs
b3cgPyAiYWxsb3dlZCIgOiAiZGVuaWVkIiwgcltpXS5kZXZpY2VfY2xhc3MsCisgICAgICAgICAg
ICAgICAgKHVpbnQzMl90KXJbaV0udmVuZG9yX2lkLCAodWludDMyX3QpcltpXS5wcm9kdWN0X2lk
KTsKKyAgICAgICAgfQorICAgIH0KK30KKworc3RhdGljIHZvaWQgdXNicmVkaXJfZGV2aWNlX2Rp
c2Nvbm5lY3RfYWNrKHZvaWQgKnByaXYpCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAq
Y2ggPSBwcml2OworICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCIsIF9fRlVOQ1RJT05fXywgY2gp
OworICAgIGlmIChjaC0+cGFyc2VyICYmIGNoLT53YWl0X2Rpc2NfYWNrKSB7CisgICAgICAgIGNo
LT5wYXJzZXIgPSBOVUxMOworICAgICAgICBTUElDRV9ERUJVRygiJXMgc3dpdGNoIHRvIHVzYnJl
ZGlyaG9zdCIsIF9fRlVOQ1RJT05fXyk7CisgICAgICAgIGNoLT51c2JyZWRpcmhvc3QgPSBjaC0+
aGlkZGVuX2hvc3Q7CisgICAgfQorICAgIGNoLT53YWl0X2Rpc2NfYWNrID0gMDsKK30KKworc3Rh
dGljIHZvaWQgdXNicmVkaXJfaGVsbG8odm9pZCAqcHJpdiwKKyAgICBzdHJ1Y3QgdXNiX3JlZGly
X2hlbGxvX2hlYWRlciAqaGVsbG8pCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gg
PSBwcml2OworICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqZCA9IGNoLT5hdHRhY2hlZDsKKyAg
ICBTcGljZVVzYkVtdWxhdGVkRGV2aWNlICplZGV2ID0gZCA/IGQtPmVkZXYgOiBOVUxMOworICAg
IHN0cnVjdCB1c2JfcmVkaXJfZGV2aWNlX2Nvbm5lY3RfaGVhZGVyIGRldmljZV9jb25uZWN0Owor
ICAgIHN0cnVjdCB1c2JfcmVkaXJfZXBfaW5mb19oZWFkZXIgZXBfaW5mbyA9IHsgMCB9OworICAg
IHN0cnVjdCB1c2JfcmVkaXJfaW50ZXJmYWNlX2luZm9faGVhZGVyIGludGVyZmFjZV9pbmZvID0g
eyAwIH07CisgICAgdWludDhfdCAqY2ZnOworICAgIHVpbnQxNl90IHNpemUsIG9mZnNldCA9IDA7
CisgICAgU1BJQ0VfREVCVUcoIiVzICVwICVzYXR0YWNoZWQgJXMiLCBfX0ZVTkNUSU9OX18sIGNo
LAorICAgICAgICBlZGV2ID8gIiIgOiAibm90ICIsICBoZWxsbyA/ICIiIDogIihpbnRlcm5hbCki
KTsKKworICAgIGlmIChoZWxsbykgeworICAgICAgICBjaC0+aGVsbG9fZG9uZV9wYXJzZXIgPSAx
OworICAgIH0KKyAgICBpZiAoIWVkZXYpIHsKKyAgICAgICAgcmV0dXJuOworICAgIH0KKyAgICBp
ZiAoIWRldmljZV9vcHMoZWRldiktPmdldF9kZXNjcmlwdG9yKGVkZXYsIExJQlVTQl9EVF9DT05G
SUcsIDAsICh2b2lkICoqKSZjZmcsICZzaXplKSkgeworICAgICAgICByZXR1cm47CisgICAgfQor
ICAgIHdoaWxlICgob2Zmc2V0ICsgMSkgPCBzaXplKSB7CisgICAgICAgIHVpbnQ4X3QgbGVuICA9
IGNmZ1tvZmZzZXRdOworICAgICAgICB1aW50OF90IHR5cGUgPSBjZmdbb2Zmc2V0ICsgMV07Cisg
ICAgICAgIGlmICgob2Zmc2V0ICsgbGVuKSA+IHNpemUpIHsKKyAgICAgICAgICAgIGJyZWFrOwor
ICAgICAgICB9CisgICAgICAgIGlmICh0eXBlID09IExJQlVTQl9EVF9JTlRFUkZBQ0UpIHsKKyAg
ICAgICAgICAgIHVpbnQzMl90IGkgPSBpbnRlcmZhY2VfaW5mby5pbnRlcmZhY2VfY291bnQ7Cisg
ICAgICAgICAgICB1aW50OF90IGNsYXNzLCBzdWJjbGFzcywgcHJvdG9jb2w7CisgICAgICAgICAg
ICBjbGFzcyA9IGNmZ1tvZmZzZXQgKyA1XTsKKyAgICAgICAgICAgIHN1YmNsYXNzID0gY2ZnW29m
ZnNldCArIDZdOworICAgICAgICAgICAgcHJvdG9jb2wgPSBjZmdbb2Zmc2V0ICsgN107CisgICAg
ICAgICAgICBpbnRlcmZhY2VfaW5mby5pbnRlcmZhY2VfY2xhc3NbaV0gPSBjbGFzczsKKyAgICAg
ICAgICAgIGludGVyZmFjZV9pbmZvLmludGVyZmFjZV9zdWJjbGFzc1tpXSA9IHN1YmNsYXNzOwor
ICAgICAgICAgICAgaW50ZXJmYWNlX2luZm8uaW50ZXJmYWNlX3Byb3RvY29sW2ldID0gcHJvdG9j
b2w7CisgICAgICAgICAgICBpbnRlcmZhY2VfaW5mby5pbnRlcmZhY2VfY291bnQrKzsKKyAgICAg
ICAgICAgIFNQSUNFX0RFQlVHKCIlcyBJRiVkOiAlZC8lZC8lZCIsIF9fRlVOQ1RJT05fXywgaSwg
Y2xhc3MsIHN1YmNsYXNzLCBwcm90b2NvbCk7CisgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PSBM
SUJVU0JfRFRfRU5EUE9JTlQpIHsKKyAgICAgICAgICAgIHVpbnQ4X3QgYWRkcmVzcyA9IGNmZ1tv
ZmZzZXQgKyAyXTsKKyAgICAgICAgICAgIHVpbnQxNl90IG1heF9wYWNrZXRfc2l6ZSA9IDB4MTAw
ICogY2ZnW29mZnNldCArIDVdICsgY2ZnW29mZnNldCArIDRdOworICAgICAgICAgICAgdWludDhf
dCBpbmRleCA9IGFkZHJlc3MgJiAweGY7CisgICAgICAgICAgICBpZiAoYWRkcmVzcyAmIDB4ODAp
IGluZGV4ICs9IDB4MTA7CisgICAgICAgICAgICBlcF9pbmZvLnR5cGVbaW5kZXhdID0gY2ZnW29m
ZnNldCArIDNdICYgMHgzOworICAgICAgICAgICAgZXBfaW5mby5tYXhfcGFja2V0X3NpemVbaW5k
ZXhdID0gbWF4X3BhY2tldF9zaXplOworICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIEVQWyUw
MlhdOiAlZC8lZCIsIF9fRlVOQ1RJT05fXywgaW5kZXgsIGVwX2luZm8udHlwZVtpbmRleF0sIG1h
eF9wYWNrZXRfc2l6ZSk7CisgICAgICAgIH0KKyAgICAgICAgb2Zmc2V0ICs9IGxlbjsKKyAgICB9
CisKKyAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2ludGVyZmFjZV9pbmZvKGNoLT5wYXJzZXIsICZp
bnRlcmZhY2VfaW5mbyk7CisgICAgdXNicmVkaXJwYXJzZXJfc2VuZF9lcF9pbmZvKGNoLT5wYXJz
ZXIsICZlcF9pbmZvKTsKKworICAgIGRldmljZV9jb25uZWN0LmRldmljZV9jbGFzcyA9IDA7IC8v
ZC0+ZGV2aWNlX2luZm8uY2xhc3M7CisgICAgZGV2aWNlX2Nvbm5lY3QuZGV2aWNlX3N1YmNsYXNz
ID0gMDsgLy9kLT5kZXZpY2VfaW5mby5zdWJjbGFzczsKKyAgICBkZXZpY2VfY29ubmVjdC5kZXZp
Y2VfcHJvdG9jb2wgPSAwOyAvL2QtPmRldmljZV9pbmZvLnByb3RvY29sOzsKKyAgICBkZXZpY2Vf
Y29ubmVjdC52ZW5kb3JfaWQgPSBkLT5kZXZpY2VfaW5mby52aWQ7CisgICAgZGV2aWNlX2Nvbm5l
Y3QucHJvZHVjdF9pZCA9IGQtPmRldmljZV9pbmZvLnBpZDsKKyAgICBkZXZpY2VfY29ubmVjdC5k
ZXZpY2VfdmVyc2lvbl9iY2QgPSBkLT5kZXZpY2VfaW5mby5iY2RVU0I7CisgICAgZGV2aWNlX2Nv
bm5lY3Quc3BlZWQgPSB1c2JfcmVkaXJfc3BlZWRfaGlnaDsKKyAgICB1c2JyZWRpcnBhcnNlcl9z
ZW5kX2RldmljZV9jb25uZWN0KGNoLT5wYXJzZXIsICZkZXZpY2VfY29ubmVjdCk7CisgICAgdXNi
cmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2soY2gpOworfQorCitzdGF0aWMgdm9pZCBpbml0aWFs
aXplX3BhcnNlcihTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwgZ2Jvb2xlYW4gZG9faGVsbG8p
Cit7CisgICAgdWludDMyX3QgZmxhZ3MsIGNhcHNbVVNCX1JFRElSX0NBUFNfU0laRV0gPSB7IDAg
fTsKKworICAgIGdfcmV0dXJuX2lmX2ZhaWwoY2gtPmhpZGRlbl9wYXJzZXIgIT0gTlVMTCk7Cisg
ICAgaWYgKGNoLT5wYXJzZXJfaW5pdF9kb25lKSB7CisgICAgICAgIGlmIChjaC0+cGFyc2VyX3dp
dGhfaGVsbG8gIT0gZG9faGVsbG8pIHsKKyAgICAgICAgICAgIGdfcmV0dXJuX2lmX3JlYWNoZWQo
KTsKKyAgICAgICAgfQorICAgICAgICByZXR1cm47CisgICAgfQorCisgICAgY2gtPnBhcnNlcl9p
bml0X2RvbmUgPSAxOworICAgIGNoLT5wYXJzZXJfd2l0aF9oZWxsbyA9IGRvX2hlbGxvOworICAg
IGZsYWdzID0gdXNicmVkaXJwYXJzZXJfZmxfd3JpdGVfY2Jfb3duc19idWZmZXIgfCB1c2JyZWRp
cnBhcnNlcl9mbF91c2JfaG9zdDsKKworICAgIGlmIChkb19oZWxsbykgeworICAgICAgICBjaC0+
aGVsbG9fc2VudCA9IDE7CisgICAgICAgIGNoLT5ob3N0X2NhcHMgfD0gMSA8PCB1c2JfcmVkaXJf
Y2FwX2Nvbm5lY3RfZGV2aWNlX3ZlcnNpb247CisgICAgICAgIGNoLT5ob3N0X2NhcHMgfD0gMSA8
PCB1c2JfcmVkaXJfY2FwX2RldmljZV9kaXNjb25uZWN0X2FjazsKKyAgICAgICAgY2gtPmhvc3Rf
Y2FwcyB8PSAxIDw8IHVzYl9yZWRpcl9jYXBfZXBfaW5mb19tYXhfcGFja2V0X3NpemU7CisgICAg
ICAgIGNoLT5ob3N0X2NhcHMgfD0gMSA8PCB1c2JfcmVkaXJfY2FwXzY0Yml0c19pZHM7CisgICAg
ICAgIGNoLT5ob3N0X2NhcHMgfD0gMSA8PCB1c2JfcmVkaXJfY2FwXzMyYml0c19idWxrX2xlbmd0
aDsKKyAgICB9IGVsc2UgeworICAgICAgICBmbGFncyB8PSB1c2JyZWRpcnBhcnNlcl9mbF9ub19o
ZWxsbzsKKyAgICB9CisKKyAgICBpZiAoY2gtPmhvc3RfY2FwcyAmICgxIDw8IHVzYl9yZWRpcl9j
YXBfY29ubmVjdF9kZXZpY2VfdmVyc2lvbikpIHsKKyAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fw
c19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfY29ubmVjdF9kZXZpY2VfdmVyc2lvbik7Cisg
ICAgfQorICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJfY2Fw
X2ZpbHRlcik7CisgICAgaWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJfY2FwX2Rl
dmljZV9kaXNjb25uZWN0X2FjaykpIHsKKyAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRf
Y2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrKTsKKyAgICB9Cisg
ICAgaWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJfY2FwX2VwX2luZm9fbWF4X3Bh
Y2tldF9zaXplKSkgeworICAgICAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2Fwcywg
dXNiX3JlZGlyX2NhcF9lcF9pbmZvX21heF9wYWNrZXRfc2l6ZSk7CisgICAgfQorICAgIGlmIChj
aC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF82NGJpdHNfaWRzKSkgeworICAgICAg
ICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF82NGJpdHNf
aWRzKTsKKyAgICB9CisgICAgaWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJfY2Fw
XzMyYml0c19idWxrX2xlbmd0aCkpIHsKKyAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRf
Y2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfMzJiaXRzX2J1bGtfbGVuZ3RoKTsKKyAgICB9CisgICAg
aWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJfY2FwX2J1bGtfc3RyZWFtcykpIHsK
KyAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBf
YnVsa19zdHJlYW1zKTsKKyAgICB9CisgICAgdXNicmVkaXJwYXJzZXJfaW5pdChjaC0+aGlkZGVu
X3BhcnNlciwgUEFDS0FHRV9TVFJJTkcsIGNhcHMsIFVTQl9SRURJUl9DQVBTX1NJWkUsIGZsYWdz
KTsKK30KKworLyoKKyAgICBXZSBjYW4gaW5pdGlhbGl6ZSB0aGUgdXNicmVkaXJwYXJzZXIgd2l0
aCBIRUxMTyBlbmFibGVkIG9ubHkgaW4gY2FzZQorICAgIHRoZSBsaWJ1c2IgaXMgbm90IGFjdGl2
ZSBhbmQgdGhlIHVzYnJlZGlyaG9zdCBkb2VzIG5vdCBmdW5jdGlvbi4KKyAgICBUaGVuIHRoZSBw
YXJzZXIgc2VuZHMgc2Vzc2lvbiBIRUxMTyBhbmQgcmVjZWl2ZXMgc2VydmVyJ3MgcmVzcG9uc2Uu
CisgICAgT3RoZXJ3aXNlICh1c2JyZWRpcnBhcnNlciBpbml0aWFsaXplZCB3aXRoIEhFTExPIGRp
c2FibGVkKToKKyAgICAtIHRoZSB1c2JyZWRpcmhvc3Qgc2VuZHMgc2Vzc2lvbiBIRUxMTworICAg
IC0gd2UgbG9vayBpbnRvIGl0IHRvIGtub3cgc2V0IG9mIGNhcGFiaWxpdGllcyB3ZSBzaGFsbCBp
bml0aWFsaXplCisgICAgICB0aGUgcGFyc2VyIHdpdGgKKyAgICAtIHdoZW4gd2UgcmVjZWl2ZSBz
ZXJ2ZXIncyByZXNwb25zZSB0byBIRUxMTyB3ZSBwcm92aWRlIGl0IGFsc28gdG8KKyAgICAgIHBh
cnNlciB0byBsZXQgaXQgc3luY2hyb25pemUgd2l0aCBzZXJ2ZXIncyBjYXBhYmlsaXRpZXMKKyov
CitzdGF0aWMgc3RydWN0IHVzYnJlZGlycGFyc2VyICpjcmVhdGVfcGFyc2VyKFNwaWNlVXNiQmFj
a2VuZENoYW5uZWwgKmNoKQoreworICAgIHN0cnVjdCB1c2JyZWRpcnBhcnNlciAqcGFyc2VyID0g
dXNicmVkaXJwYXJzZXJfY3JlYXRlKCk7CisKKyAgICBnX3JldHVybl92YWxfaWZfZmFpbChwYXJz
ZXIgIT0gTlVMTCwgTlVMTCk7CisKKyAgICBwYXJzZXItPnByaXYgPSBjaDsKKyAgICBwYXJzZXIt
PmxvZ19mdW5jID0gdXNicmVkaXJfbG9nOworICAgIHBhcnNlci0+cmVhZF9mdW5jID0gdXNicmVk
aXJfcmVhZF9jYWxsYmFjazsKKyAgICBwYXJzZXItPndyaXRlX2Z1bmMgPSB1c2JyZWRpcl93cml0
ZV9jYWxsYmFjazsKKyAgICBwYXJzZXItPnJlc2V0X2Z1bmMgPSB1c2JyZWRpcl9kZXZpY2VfcmVz
ZXQ7CisgICAgcGFyc2VyLT5zZXRfY29uZmlndXJhdGlvbl9mdW5jID0gdXNicmVkaXJfc2V0X2Nv
bmZpZ3VyYXRpb247CisgICAgcGFyc2VyLT5nZXRfY29uZmlndXJhdGlvbl9mdW5jID0gdXNicmVk
aXJfZ2V0X2NvbmZpZ3VyYXRpb247CisgICAgcGFyc2VyLT5zZXRfYWx0X3NldHRpbmdfZnVuYyA9
IHVzYnJlZGlyX3NldF9hbHRfc2V0dGluZzsKKyAgICBwYXJzZXItPmdldF9hbHRfc2V0dGluZ19m
dW5jID0gdXNicmVkaXJfZ2V0X2FsdF9zZXR0aW5nOworICAgIHBhcnNlci0+Y2FuY2VsX2RhdGFf
cGFja2V0X2Z1bmMgPSB1c2JyZWRpcl9jYW5jZWxfZGF0YTsKKyAgICBwYXJzZXItPmNvbnRyb2xf
cGFja2V0X2Z1bmMgPSB1c2JyZWRpcl9jb250cm9sX3BhY2tldDsKKyAgICBwYXJzZXItPmJ1bGtf
cGFja2V0X2Z1bmMgPSB1c2JyZWRpcl9idWxrX3BhY2tldDsKKyAgICBwYXJzZXItPmFsbG9jX2xv
Y2tfZnVuYyA9IHVzYnJlZGlyX2FsbG9jX2xvY2s7CisgICAgcGFyc2VyLT5sb2NrX2Z1bmMgPSB1
c2JyZWRpcl9sb2NrX2xvY2s7CisgICAgcGFyc2VyLT51bmxvY2tfZnVuYyA9IHVzYnJlZGlyX3Vu
bG9ja19sb2NrOworICAgIHBhcnNlci0+ZnJlZV9sb2NrX2Z1bmMgPSB1c2JyZWRpcl9mcmVlX2xv
Y2s7CisgICAgcGFyc2VyLT5oZWxsb19mdW5jID0gdXNicmVkaXJfaGVsbG87CisgICAgcGFyc2Vy
LT5maWx0ZXJfcmVqZWN0X2Z1bmMgPSB1c2JyZWRpcl9maWx0ZXJfcmVqZWN0OworICAgIHBhcnNl
ci0+ZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrX2Z1bmMgPSB1c2JyZWRpcl9kZXZpY2VfZGlzY29ubmVj
dF9hY2s7CisgICAgcGFyc2VyLT5pbnRlcmZhY2VfaW5mb19mdW5jID0gdXNicmVkaXJfaW50ZXJm
YWNlX2luZm87CisgICAgcGFyc2VyLT5lcF9pbmZvX2Z1bmMgPSB1c2JyZWRpcl9pbnRlcmZhY2Vf
ZXBfaW5mbzsKKyAgICBwYXJzZXItPmZpbHRlcl9maWx0ZXJfZnVuYyA9IHVzYnJlZGlyX2ZpbHRl
cl9maWx0ZXI7CisKKyAgICByZXR1cm4gcGFyc2VyOworfQorCitzdGF0aWMgZ2Jvb2xlYW4gYXR0
YWNoX2VkZXYoU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkZXYsCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgR0Vycm9yICoqZXJyb3IpCit7CisgICAgaWYgKCFkZXYtPmVkZXYpIHsKKyAgICAg
ICAgZ19zZXRfZXJyb3IoZXJyb3IsIFNQSUNFX0NMSUVOVF9FUlJPUiwgU1BJQ0VfQ0xJRU5UX0VS
Uk9SX0ZBSUxFRCwKKyAgICAgICAgICAgXygiRmFpbGVkIHRvIHJlZGlyZWN0IGRldmljZSAlZCIp
LCAxKTsKKyAgICAgICAgcmV0dXJuIEZBTFNFOworICAgIH0KKyAgICBpZiAoY2gtPnVzYnJlZGly
aG9zdCAmJiAhY2gtPmhlbGxvX2RvbmVfcGFyc2VyKSB7CisgICAgICAgIC8qCisgICAgICAgICAg
ICB3ZSBjYW4ndCBpbml0aWFsaXplIHBhcnNlciB1bnRpbCB3ZSBzZWUgaGVsbG8gZnJvbSB1c2Jy
ZWRpcgorICAgICAgICAgICAgYW5kIHRoZSBwYXJzZXIgY2FuJ3Qgd29yayB1bnRpbCBpdCBzZWVz
IHRoZSBoZWxsbyByZXNwb25zZS4KKyAgICAgICAgICAgIHRoaXMgaXMgY2FzZSBvZiBhdXRvY29u
bmVjdCB3aGVuIGVtdWxhdGVkIGRldmljZSBpcyBhdHRhY2hlZAorICAgICAgICAgICAgYmVmb3Jl
IHRoZSBjaGFubmVsIGlzIHVwCisgICAgICAgICovCisgICAgICAgIFNQSUNFX0RFQlVHKCIlcyB3
YWl0aW5nIHVudGlsIHRoZSBjaGFubmVsIGlzIHJlYWR5IiwgX19GVU5DVElPTl9fKTsKKworICAg
IH0gZWxzZSB7CisgICAgICAgIGluaXRpYWxpemVfcGFyc2VyKGNoLCBjaC0+aGlkZGVuX2hvc3Qg
PT0gTlVMTCk7CisgICAgICAgIGNoLT51c2JyZWRpcmhvc3QgPSBOVUxMOworICAgICAgICBjaC0+
cGFyc2VyID0gY2gtPmhpZGRlbl9wYXJzZXI7CisgICAgfQorICAgIGNoLT53YWl0X2Rpc2NfYWNr
ID0gMDsKKyAgICBjaC0+YXR0YWNoZWQgPSBkZXY7CisgICAgZGV2LT5hdHRhY2hlZF90byA9IGNo
OworICAgIGRldmljZV9vcHMoZGV2LT5lZGV2KS0+YXR0YWNoKGRldi0+ZWRldiwgY2gtPmhpZGRl
bl9wYXJzZXIpOworICAgIGlmIChjaC0+aGVsbG9fZG9uZV9wYXJzZXIpIHsKKyAgICAgICAgLyog
c2VuZCBkZXZpY2UgaW5mbyAqLworICAgICAgICB1c2JyZWRpcl9oZWxsbyhjaCwgTlVMTCk7Cisg
ICAgfQorICAgIHJldHVybiBUUlVFOworfQorCiBnYm9vbGVhbiBzcGljZV91c2JfYmFja2VuZF9j
aGFubmVsX2F0dGFjaChTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwKICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqZGV2LAog
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgR0Vycm9yICoqZXJyb3Ip
CkBAIC03MDYsNyArMTIxMywxMyBAQCBnYm9vbGVhbiBzcGljZV91c2JfYmFja2VuZF9jaGFubmVs
X2F0dGFjaChTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwKIAogICAgIGdfcmV0dXJuX3ZhbF9p
Zl9mYWlsKGRldiAhPSBOVUxMLCBGQUxTRSk7CiAKKyAgICBpZiAoIWRldi0+bGlidXNiX2Rldmlj
ZSkgeworICAgICAgICByZXR1cm4gYXR0YWNoX2VkZXYoY2gsIGRldiwgZXJyb3IpOworICAgIH0K
KwogICAgIGxpYnVzYl9kZXZpY2VfaGFuZGxlICpoYW5kbGUgPSBOVUxMOworICAgIGNoLT51c2Jy
ZWRpcmhvc3QgPSBjaC0+aGlkZGVuX2hvc3Q7CisgICAgY2gtPnBhcnNlciA9IE5VTEw7CiAKICAg
ICAvKgogICAgICAgIFVuZGVyIFdpbmRvd3Mgd2UgbmVlZCB0byBhdm9pZCB1cGRhdGluZwpAQCAt
NzQwLDE4ICsxMjUzLDMzIEBAIGdib29sZWFuIHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfYXR0
YWNoKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLAogCiB2b2lkIHNwaWNlX3VzYl9iYWNrZW5k
X2NoYW5uZWxfZGV0YWNoKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoKQogeworICAgIFNwaWNl
VXNiQmFja2VuZERldmljZSAqZCA9IGNoLT5hdHRhY2hlZDsKKyAgICBTcGljZVVzYkVtdWxhdGVk
RGV2aWNlICplZGV2ID0gZCA/IGQtPmVkZXYgOiBOVUxMOwogICAgIFNQSUNFX0RFQlVHKCIlcyA+
PiBjaCAlcCwgd2FzIGF0dGFjaGVkICVwIiwgX19GVU5DVElPTl9fLCBjaCwgY2gtPmF0dGFjaGVk
KTsKLSAgICBpZiAoIWNoLT5hdHRhY2hlZCkgeworICAgIGlmICghZCkgewogICAgICAgICBTUElD
RV9ERUJVRygiJXM6IG5vdGhpbmcgdG8gZGV0YWNoIiwgX19GVU5DVElPTl9fKTsKICAgICAgICAg
cmV0dXJuOwogICAgIH0KICAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgewogICAgICAgICAvKiBp
dCB3aWxsIGNhbGwgbGlidXNiX2Nsb3NlIGludGVybmFsbHkgKi8KICAgICAgICAgdXNicmVkaXJo
b3N0X3NldF9kZXZpY2UoY2gtPnVzYnJlZGlyaG9zdCwgTlVMTCk7CisgICAgfSBlbHNlIGlmIChj
aC0+cGFyc2VyKSB7CisgICAgICAgIGlmIChlZGV2KSB7CisgICAgICAgICAgICBkZXZpY2Vfb3Bz
KGVkZXYpLT5kZXRhY2goZWRldik7CisgICAgICAgIH0KKyAgICAgICAgdXNicmVkaXJwYXJzZXJf
c2VuZF9kZXZpY2VfZGlzY29ubmVjdChjaC0+cGFyc2VyKTsKKyAgICAgICAgdXNicmVkaXJfd3Jp
dGVfZmx1c2hfY2FsbGJhY2soY2gpOworICAgICAgICBjaC0+d2FpdF9kaXNjX2FjayA9IHVzYnJl
ZGlycGFyc2VyX3BlZXJfaGFzX2NhcChjaC0+cGFyc2VyLAorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2JfcmVkaXJfY2FwX2RldmljZV9k
aXNjb25uZWN0X2Fjayk7CisgICAgICAgIGlmICghY2gtPndhaXRfZGlzY19hY2spIHsKKyAgICAg
ICAgICAgIGNoLT51c2JyZWRpcmhvc3QgPSBjaC0+aGlkZGVuX2hvc3Q7CisgICAgICAgICAgICBj
aC0+cGFyc2VyID0gTlVMTDsKKyAgICAgICAgfQogICAgIH0KICAgICBTUElDRV9ERUJVRygiJXMg
Y2ggJXAsIGRldGFjaCBkb25lIiwgX19GVU5DVElPTl9fLCBjaCk7CiAgICAgY2gtPmF0dGFjaGVk
LT5hdHRhY2hlZF90byA9IE5VTEw7CiAgICAgY2gtPmF0dGFjaGVkID0gTlVMTDsKKyAgICBjaC0+
cmVqZWN0ZWQgPSAwOwogfQogCiBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpzcGljZV91c2JfYmFj
a2VuZF9jaGFubmVsX25ldyhTcGljZVVzYkJhY2tlbmQgKmJlLApAQCAtNzY2LDI2ICsxMjk0LDMz
IEBAIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKnNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfbmV3
KFNwaWNlVXNiQmFja2VuZCAqYmUsCiAgICAgY2gtPnVzZXJfZGF0YSA9IFNQSUNFX1VTQlJFRElS
X0NIQU5ORUwodXNlcl9kYXRhKTsKICAgICBpZiAoYmUtPmxpYnVzYl9jb250ZXh0KSB7CiAgICAg
ICAgIGNoLT5iYWNrZW5kID0gYmU7Ci0gICAgICAgIGNoLT51c2JyZWRpcmhvc3QgPSB1c2JyZWRp
cmhvc3Rfb3Blbl9mdWxsKAotICAgICAgICAgICAgYmUtPmxpYnVzYl9jb250ZXh0LAotICAgICAg
ICAgICAgTlVMTCwKLSAgICAgICAgICAgIHVzYnJlZGlyX2xvZywKLSAgICAgICAgICAgIHVzYnJl
ZGlyX3JlYWRfY2FsbGJhY2ssCi0gICAgICAgICAgICB1c2JyZWRpcl93cml0ZV9jYWxsYmFjaywK
LSAgICAgICAgICAgIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrLAotICAgICAgICAgICAg
dXNicmVkaXJfYWxsb2NfbG9jaywKLSAgICAgICAgICAgIHVzYnJlZGlyX2xvY2tfbG9jaywKLSAg
ICAgICAgICAgIHVzYnJlZGlyX3VubG9ja19sb2NrLAotICAgICAgICAgICAgdXNicmVkaXJfZnJl
ZV9sb2NrLAotICAgICAgICAgICAgY2gsIFBBQ0tBR0VfU1RSSU5HLAotICAgICAgICAgICAgc3Bp
Y2VfdXRpbF9nZXRfZGVidWcoKSA/IHVzYnJlZGlycGFyc2VyX2RlYnVnIDogdXNicmVkaXJwYXJz
ZXJfd2FybmluZywKLSAgICAgICAgICAgIHVzYnJlZGlyaG9zdF9mbF93cml0ZV9jYl9vd25zX2J1
ZmZlcik7CisgICAgICAgIGNoLT51c2JyZWRpcmhvc3QgPQorICAgICAgICAgICAgdXNicmVkaXJo
b3N0X29wZW5fZnVsbChiZS0+bGlidXNiX2NvbnRleHQsCisgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIE5VTEwsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVz
YnJlZGlyX2xvZywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNicmVkaXJf
cmVhZF9jYWxsYmFjaywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNicmVk
aXJfd3JpdGVfY2FsbGJhY2ssCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVz
YnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrLAorICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICB1c2JyZWRpcl9hbGxvY19sb2NrLAorICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICB1c2JyZWRpcl9sb2NrX2xvY2ssCisgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIHVzYnJlZGlyX3VubG9ja19sb2NrLAorICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICB1c2JyZWRpcl9mcmVlX2xvY2ssCisgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIGNoLCBQQUNLQUdFX1NUUklORywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgc3BpY2VfdXRpbF9nZXRfZGVidWcoKSA/IHVzYnJlZGlycGFyc2VyX2RlYnVnIDoKKyAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2JyZWRpcnBhcnNlcl93YXJu
aW5nLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2JyZWRpcmhvc3RfZmxf
d3JpdGVfY2Jfb3duc19idWZmZXIpOwogICAgICAgICBnX3dhcm5faWZfZmFpbChjaC0+dXNicmVk
aXJob3N0ICE9IE5VTEwpOwogICAgIH0KKwogICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7Ci0g
ICAgICAgIHVzYnJlZGlyaG9zdF9zZXRfYnVmZmVyZWRfb3V0cHV0X3NpemVfY2IoY2gtPnVzYnJl
ZGlyaG9zdCwgdXNicmVkaXJfYnVmZmVyZWRfb3V0cHV0X3NpemVfY2FsbGJhY2spOwotICAgIH0g
ZWxzZSB7Ci0gICAgICAgIGdfZnJlZShjaCk7CisgICAgICAgIGNoLT5oaWRkZW5fcGFyc2VyID0g
Y3JlYXRlX3BhcnNlcihjaCk7CisgICAgICAgIGNoLT5oaWRkZW5faG9zdCA9IGNoLT51c2JyZWRp
cmhvc3Q7CisgICAgICAgIHVzYnJlZGlyaG9zdF9zZXRfYnVmZmVyZWRfb3V0cHV0X3NpemVfY2Io
Y2gtPnVzYnJlZGlyaG9zdCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICB1c2JyZWRpcl9idWZmZXJlZF9vdXRwdXRfc2l6ZV9jYWxsYmFjayk7CisgICAg
fQorCisgICAgaWYgKCFjaC0+aGlkZGVuX3BhcnNlcikgeworICAgICAgICBzcGljZV91c2JfYmFj
a2VuZF9jaGFubmVsX2RlbGV0ZShjaCk7CiAgICAgICAgIGNoID0gTlVMTDsKICAgICB9CiAKQEAg
LTc5NSw5ICsxMzMwLDE0IEBAIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKnNwaWNlX3VzYl9iYWNr
ZW5kX2NoYW5uZWxfbmV3KFNwaWNlVXNiQmFja2VuZCAqYmUsCiAKIHZvaWQgc3BpY2VfdXNiX2Jh
Y2tlbmRfY2hhbm5lbF9mbHVzaF93cml0ZXMoU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gpCiB7
Ci0gICAgU1BJQ0VfREVCVUcoIiVzICVwLCBob3N0ICVwIiwgX19GVU5DVElPTl9fLCBjaCwgY2gt
PnVzYnJlZGlyaG9zdCk7CisgICAgU1BJQ0VfREVCVUcoIiVzICVwIGlzIHVwIiwgX19GVU5DVElP
Tl9fLCBjaCk7CiAgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKICAgICAgICAgdXNicmVkaXJo
b3N0X3dyaXRlX2d1ZXN0X2RhdGEoY2gtPnVzYnJlZGlyaG9zdCk7CisgICAgICAgIGluaXRpYWxp
emVfcGFyc2VyKGNoLCBGQUxTRSk7CisgICAgfSBlbHNlIHsKKyAgICAgICAgaW5pdGlhbGl6ZV9w
YXJzZXIoY2gsIFRSVUUpOworICAgICAgICBjaC0+cGFyc2VyID0gY2gtPmhpZGRlbl9wYXJzZXI7
CisgICAgICAgIHVzYnJlZGlycGFyc2VyX2RvX3dyaXRlKGNoLT5wYXJzZXIpOwogICAgIH0KIH0K
IApAQCAtODA3LDEyICsxMzQ3LDE2IEBAIHZvaWQgc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9k
ZWxldGUoU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gpCiAgICAgaWYgKCFjaCkgewogICAgICAg
ICByZXR1cm47CiAgICAgfQotICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7Ci0gICAgICAgIHVz
YnJlZGlyaG9zdF9jbG9zZShjaC0+dXNicmVkaXJob3N0KTsKKyAgICBpZiAoY2gtPmhpZGRlbl9o
b3N0KSB7CisgICAgICAgIHVzYnJlZGlyaG9zdF9jbG9zZShjaC0+aGlkZGVuX2hvc3QpOworICAg
IH0KKyAgICBpZiAoY2gtPmhpZGRlbl9wYXJzZXIpIHsKKyAgICAgICAgdXNicmVkaXJwYXJzZXJf
ZGVzdHJveShjaC0+aGlkZGVuX3BhcnNlcik7CiAgICAgfQogCiAgICAgaWYgKGNoLT5ydWxlcykg
ewotICAgICAgICBnX2ZyZWUoY2gtPnJ1bGVzKTsKKyAgICAgICAgLyogcnVsZXMgd2VyZSBhbGxv
Y2F0ZWQgYnkgdXNicmVkaXJwYXJzZXIgKi8KKyAgICAgICAgZnJlZShjaC0+cnVsZXMpOwogICAg
IH0KIAogICAgIGdfZnJlZShjaCk7Ci0tIAoyLjIwLjEKCl9fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fClNwaWNlLWRldmVsIG1haWxpbmcgbGlzdApTcGljZS1k
ZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcv
bWFpbG1hbi9saXN0aW5mby9zcGljZS1kZXZlbA==
