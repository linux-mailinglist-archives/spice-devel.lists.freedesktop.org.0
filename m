Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 282B6B7BCC
	for <lists+spice-devel@lfdr.de>; Thu, 19 Sep 2019 16:11:46 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id A66CD6F8A8;
	Thu, 19 Sep 2019 14:11:44 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id D55226F89D
 for <spice-devel@lists.freedesktop.org>; Thu, 19 Sep 2019 14:11:43 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx06.intmail.prod.int.phx2.redhat.com
 [10.5.11.16])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 72C271DA3
 for <spice-devel@lists.freedesktop.org>; Thu, 19 Sep 2019 14:11:43 +0000 (UTC)
Received: from wingsuit.mxp.redhat.com (unknown [10.32.181.155])
 by smtp.corp.redhat.com (Postfix) with ESMTP id E253A5C1B5
 for <spice-devel@lists.freedesktop.org>; Thu, 19 Sep 2019 14:11:42 +0000 (UTC)
From: Victor Toso <victortoso@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Thu, 19 Sep 2019 16:11:24 +0200
Message-Id: <20190919141133.10691-12-victortoso@redhat.com>
In-Reply-To: <20190919141133.10691-1-victortoso@redhat.com>
References: <20190919141133.10691-1-victortoso@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.16
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.6.2
 (mx1.redhat.com [10.5.110.71]); Thu, 19 Sep 2019 14:11:43 +0000 (UTC)
Subject: [Spice-devel] [PATCH v8 11/20] usb-redir: add implementation of
 emulated CD device
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

RnJvbTogWXVyaSBCZW5kaXRvdmljaCA8eXVyaS5iZW5kaXRvdmljaEBkYXluaXguY29tPgoKVGhp
cyBtb2R1bGUgY29udGFpbnMgaW1wbGVtZW50YXRpb24gb2YgZW11bGF0ZWQgZGV2aWNlCmludGVy
ZmFjZSBmb3Igc2hhcmVkIENELgoKU2lnbmVkLW9mZi1ieTogWXVyaSBCZW5kaXRvdmljaCA8eXVy
aS5iZW5kaXRvdmljaEBkYXluaXguY29tPgpBY2tlZC1ieTogRnJlZGlhbm8gWmlnbGlvIDxmemln
bGlvQHJlZGhhdC5jb20+Ci0tLQogc3JjL3VzYi1kZXZpY2UtY2QuYyB8IDc4NCArKysrKysrKysr
KysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKwogc3JjL3VzYi1kZXZpY2UtY2QuaCB8
ICAzNCArKwogMiBmaWxlcyBjaGFuZ2VkLCA4MTggaW5zZXJ0aW9ucygrKQogY3JlYXRlIG1vZGUg
MTAwNjQ0IHNyYy91c2ItZGV2aWNlLWNkLmMKIGNyZWF0ZSBtb2RlIDEwMDY0NCBzcmMvdXNiLWRl
dmljZS1jZC5oCgpkaWZmIC0tZ2l0IGEvc3JjL3VzYi1kZXZpY2UtY2QuYyBiL3NyYy91c2ItZGV2
aWNlLWNkLmMKbmV3IGZpbGUgbW9kZSAxMDA2NDQKaW5kZXggMDAwMDAwMC4uMmY0MjFjNAotLS0g
L2Rldi9udWxsCisrKyBiL3NyYy91c2ItZGV2aWNlLWNkLmMKQEAgLTAsMCArMSw3ODQgQEAKKy8q
IC0qLSBNb2RlOiBDOyBjLWJhc2ljLW9mZnNldDogNDsgaW5kZW50LXRhYnMtbW9kZTogbmlsIC0q
LSAqLworLyoKKyAgICBDb3B5cmlnaHQgKEMpIDIwMTkgUmVkIEhhdCwgSW5jLgorCisgICAgUmVk
IEhhdCBBdXRob3JzOgorICAgIFl1cmkgQmVuZGl0b3ZpY2g8eWJlbmRpdG9AcmVkaGF0LmNvbT4K
KworICAgIFRoaXMgbGlicmFyeSBpcyBmcmVlIHNvZnR3YXJlOyB5b3UgY2FuIHJlZGlzdHJpYnV0
ZSBpdCBhbmQvb3IKKyAgICBtb2RpZnkgaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgTGVz
c2VyIEdlbmVyYWwgUHVibGljCisgICAgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnkgdGhlIEZyZWUg
U29mdHdhcmUgRm91bmRhdGlvbjsgZWl0aGVyCisgICAgdmVyc2lvbiAyLjEgb2YgdGhlIExpY2Vu
c2UsIG9yIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCisKKyAgICBUaGlzIGxp
YnJhcnkgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwK
KyAgICBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3
YXJyYW50eSBvZgorICAgIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VM
QVIgUFVSUE9TRS4gIFNlZSB0aGUgR05VCisgICAgTGVzc2VyIEdlbmVyYWwgUHVibGljIExpY2Vu
c2UgZm9yIG1vcmUgZGV0YWlscy4KKworICAgIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNv
cHkgb2YgdGhlIEdOVSBMZXNzZXIgR2VuZXJhbCBQdWJsaWMKKyAgICBMaWNlbnNlIGFsb25nIHdp
dGggdGhpcyBsaWJyYXJ5OyBpZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2Vz
Lz4uCisqLworCisjaW5jbHVkZSAiY29uZmlnLmgiCisKKyNpZmRlZiBVU0VfVVNCUkVESVIKKwor
I2luY2x1ZGUgPGdsaWItb2JqZWN0Lmg+CisjaW5jbHVkZSA8aW50dHlwZXMuaD4KKyNpbmNsdWRl
IDxnaW8vZ2lvLmg+CisjaW5jbHVkZSA8Z2xpYi9naTE4bi1saWIuaD4KKyNpbmNsdWRlIDxlcnJu
by5oPgorI2luY2x1ZGUgPGxpYnVzYi5oPgorI2luY2x1ZGUgPGZjbnRsLmg+CisKKyNpZmRlZiBH
X09TX1dJTjMyCisjaW5jbHVkZSA8d2luZG93cy5oPgorI2luY2x1ZGUgPG50ZGRjZHJtLmg+Cisj
aW5jbHVkZSA8bnRkZG1tYy5oPgorI2Vsc2UKKyNpbmNsdWRlIDxzeXMvc3RhdC5oPgorI2luY2x1
ZGUgPHN5cy9pb2N0bC5oPgorI2luY2x1ZGUgPGxpbnV4L2ZzLmg+CisjaW5jbHVkZSA8bGludXgv
Y2Ryb20uaD4KKyNlbmRpZgorCisjaW5jbHVkZSAidXNiLWVtdWxhdGlvbi5oIgorI2luY2x1ZGUg
InVzYi1kZXZpY2UtY2QuaCIKKyNpbmNsdWRlICJjZC11c2ItYnVsay1tc2QuaCIKKwordHlwZWRl
ZiBzdHJ1Y3QgU3BpY2VDZExVIHsKKyAgICBjaGFyICpmaWxlbmFtZTsKKyAgICBHRmlsZUlucHV0
U3RyZWFtICpzdHJlYW07CisgICAgdWludDY0X3Qgc2l6ZTsKKyAgICB1aW50MzJfdCBibG9ja1Np
emU7CisgICAgdWludDMyX3QgbG9hZGVkIDogMTsKKyAgICB1aW50MzJfdCBkZXZpY2UgOiAxOwor
fSBTcGljZUNkTFU7CisKKyNkZWZpbmUgTUFYX0xVTl9QRVJfREVWSUNFICAgICAgICAgICAgICAx
CisjZGVmaW5lIFVTQjJfQkNEICAgICAgICAgICAgICAgICAgICAgICAgMHgyMDAKKy8qIFJlZCBI
YXQgVVNCIFZJRCAqLworI2RlZmluZSBDRF9ERVZfVklEICAgICAgICAgICAgICAgICAgICAgIDB4
MmIyMworI2RlZmluZSBDRF9ERVZfUElEICAgICAgICAgICAgICAgICAgICAgIDB4Q0RDRAorI2Rl
ZmluZSBDRF9ERVZfQ0xBU1MgICAgICAgICAgICAgICAgICAgIDgKKyNkZWZpbmUgQ0RfREVWX1NV
QkNMQVNTICAgICAgICAgICAgICAgICA2CisjZGVmaW5lIENEX0RFVl9QUk9UT0NPTCAgICAgICAg
ICAgICAgICAgMHg1MAorI2RlZmluZSBDRF9ERVZfQkxPQ0tfU0laRSAgICAgICAgICAgICAgIDB4
MjAwCisjZGVmaW5lIERWRF9ERVZfQkxPQ0tfU0laRSAgICAgICAgICAgICAgMHg4MDAKKyNkZWZp
bmUgTUFYX0JVTEtfSU5fUkVRVUVTVFMgICAgICAgICAgICA2NAorCitzdHJ1Y3QgQnVmZmVyZWRC
dWxrUmVhZCB7CisgICAgc3RydWN0IHVzYl9yZWRpcl9idWxrX3BhY2tldF9oZWFkZXIgaG91dDsK
KyAgICB1aW50NjRfdCBpZDsKK307CisKK3N0cnVjdCBTcGljZVVzYkVtdWxhdGVkRGV2aWNlIHsK
KyAgICBVc2JEZXZpY2VPcHMgZGV2X29wczsKKyAgICBTcGljZVVzYkJhY2tlbmQgKmJhY2tlbmQ7
CisgICAgU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpwYXJlbnQ7CisgICAgc3RydWN0IHVzYnJlZGly
cGFyc2VyICpwYXJzZXI7CisgICAgVXNiQ2RCdWxrTXNkRGV2aWNlKiBtc2M7CisgICAgU3BpY2VD
ZExVIHVuaXRzW01BWF9MVU5fUEVSX0RFVklDRV07CisgICAgZ2Jvb2xlYW4gbG9ja2VkOworICAg
IGdib29sZWFuIGRlbGV0ZV9vbl9lamVjdDsKKyAgICBnYm9vbGVhbiBkZWxldGluZzsKKyAgICB1
aW50MzJfdCBudW1fcmVhZHM7CisgICAgc3RydWN0IEJ1ZmZlcmVkQnVsa1JlYWQgcmVhZF9idWxr
W01BWF9CVUxLX0lOX1JFUVVFU1RTXTsKKyAgICAvKiBhY2NvcmRpbmcgdG8gVVNCIE1TQyBzcGVj
ICovCisgICAgdWludDE2X3Qgc2VyaWFsWzEyXTsKKyAgICB1aW50OF90IG1heF9sdW5faW5kZXg7
Cit9OworCit0eXBlZGVmIHN0cnVjdCBTcGljZVVzYkVtdWxhdGVkRGV2aWNlIFVzYkNkOworCisj
aWZuZGVmIEdfT1NfV0lOMzIKKworc3RhdGljIGludCBjZF9kZXZpY2Vfb3Blbl9zdHJlYW0oU3Bp
Y2VDZExVICp1bml0LCBjb25zdCBjaGFyICpmaWxlbmFtZSkKK3sKKyAgICB1bml0LT5kZXZpY2Ug
PSAwOworCisgICAgaWYgKCF1bml0LT5maWxlbmFtZSAmJiAhZmlsZW5hbWUpIHsKKyAgICAgICAg
U1BJQ0VfREVCVUcoIiVzOiBmaWxlIG5hbWUgbm90IHByb3ZpZGVkIiwgX19GVU5DVElPTl9fKTsK
KyAgICAgICAgcmV0dXJuIC0xOworICAgIH0KKyAgICBpZiAodW5pdC0+ZmlsZW5hbWUgJiYgZmls
ZW5hbWUpIHsKKyAgICAgICAgZ19mcmVlKHVuaXQtPmZpbGVuYW1lKTsKKyAgICAgICAgdW5pdC0+
ZmlsZW5hbWUgPSBOVUxMOworICAgIH0KKyAgICBpZiAoZmlsZW5hbWUpIHsKKyAgICAgICAgdW5p
dC0+ZmlsZW5hbWUgPSBnX3N0cmR1cChmaWxlbmFtZSk7CisgICAgfQorCisgICAgaW50IGZkID0g
b3Blbih1bml0LT5maWxlbmFtZSwgT19SRE9OTFkgfCBPX05PTkJMT0NLKTsKKyAgICBpZiAoZmQg
PCAwKSB7CisgICAgICAgIFNQSUNFX0RFQlVHKCIlczogY2FuJ3Qgb3BlbiBmaWxlICVzIiwgX19G
VU5DVElPTl9fLCB1bml0LT5maWxlbmFtZSk7CisgICAgICAgIHJldHVybiAtMTsKKyAgICB9CisK
KyAgICBzdHJ1Y3Qgc3RhdCBmaWxlX3N0YXQgPSB7IDAgfTsKKyAgICBpZiAoZnN0YXQoZmQsICZm
aWxlX3N0YXQpIHx8IGZpbGVfc3RhdC5zdF9zaXplID09IDApIHsKKyAgICAgICAgZmlsZV9zdGF0
LnN0X3NpemUgPSAwOworICAgICAgICB1bml0LT5kZXZpY2UgPSAxOworICAgICAgICBpZiAoIWlv
Y3RsKGZkLCBCTEtHRVRTSVpFNjQsICZmaWxlX3N0YXQuc3Rfc2l6ZSkgJiYKKyAgICAgICAgICAg
ICFpb2N0bChmZCwgQkxLU1NaR0VULCAmdW5pdC0+YmxvY2tTaXplKSkgeworICAgICAgICB9Cisg
ICAgfQorICAgIHVuaXQtPnNpemUgPSBmaWxlX3N0YXQuc3Rfc2l6ZTsKKyAgICBjbG9zZShmZCk7
CisgICAgaWYgKHVuaXQtPnNpemUpIHsKKyAgICAgICAgR0ZpbGUgKmZpbGVfb2JqZWN0ID0gZ19m
aWxlX25ld19mb3JfcGF0aCh1bml0LT5maWxlbmFtZSk7CisgICAgICAgIHVuaXQtPnN0cmVhbSA9
IGdfZmlsZV9yZWFkKGZpbGVfb2JqZWN0LCBOVUxMLCBOVUxMKTsKKyAgICAgICAgZ19jbGVhcl9v
YmplY3QoJmZpbGVfb2JqZWN0KTsKKyAgICB9CisgICAgaWYgKCF1bml0LT5zdHJlYW0pIHsKKyAg
ICAgICAgU1BJQ0VfREVCVUcoIiVzOiBjYW4ndCBvcGVuIHN0cmVhbSBvbiAlcyIsIF9fRlVOQ1RJ
T05fXywgdW5pdC0+ZmlsZW5hbWUpOworICAgICAgICByZXR1cm4gLTE7CisgICAgfQorCisgICAg
cmV0dXJuIDA7Cit9CisKK3N0YXRpYyBpbnQgY2RfZGV2aWNlX2xvYWQoU3BpY2VDZExVICp1bml0
LCBnYm9vbGVhbiBsb2FkKQoreworICAgIGludCBlcnJvcjsKKyAgICBpZiAoIXVuaXQtPmRldmlj
ZSB8fCAhdW5pdC0+ZmlsZW5hbWUpIHsKKyAgICAgICAgcmV0dXJuIC0xOworICAgIH0KKyAgICBp
bnQgZmQgPSBvcGVuKHVuaXQtPmZpbGVuYW1lLCBPX1JET05MWSB8IE9fTk9OQkxPQ0spOworICAg
IGlmIChmZCA8IDApIHsKKyAgICAgICAgcmV0dXJuIC0xOworICAgIH0KKyAgICBpZiAobG9hZCkg
eworICAgICAgICBlcnJvciA9IGlvY3RsKGZkLCBDRFJPTUNMT1NFVFJBWSwgMCk7CisgICAgfSBl
bHNlIHsKKyAgICAgICAgZXJyb3IgPSBpb2N0bChmZCwgQ0RST01fTE9DS0RPT1IsIDApOworICAg
ICAgICBlcnJvciA9IGlvY3RsKGZkLCBDRFJPTUVKRUNULCAwKTsKKyAgICB9CisgICAgaWYgKGVy
cm9yKSB7CisgICAgICAgIC8vIG5vdGUgdGhhdCBlamVjdGluZyBtaWdodCBiZSBhdmFpbGFibGUg
b25seSBmb3Igcm9vdAorICAgICAgICAvLyBsb2FkaW5nIG1pZ2h0IGJlIGF2YWlsYWJsZSBhbHNv
IGZvciByZWd1bGFyIHVzZXIKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBjYW4ndCAlc2xvYWQg
JXMsIHJlcyAlZCwgZXJybm8gJWQiLAorICAgICAgICAgICAgX19GVU5DVElPTl9fLCBsb2FkID8g
IiIgOiAidW4iLCB1bml0LT5maWxlbmFtZSwgZXJyb3IsIGVycm5vKTsKKyAgICB9CisgICAgY2xv
c2UoZmQpOworICAgIHJldHVybiBlcnJvcjsKK30KKworc3RhdGljIGludCBjZF9kZXZpY2VfY2hl
Y2soU3BpY2VDZExVICp1bml0KQoreworICAgIGludCBlcnJvcjsKKyAgICBpZiAoIXVuaXQtPmRl
dmljZSB8fCAhdW5pdC0+ZmlsZW5hbWUpIHsKKyAgICAgICAgcmV0dXJuIC0xOworICAgIH0KKyAg
ICBpbnQgZmQgPSBvcGVuKHVuaXQtPmZpbGVuYW1lLCBPX1JET05MWSB8IE9fTk9OQkxPQ0spOwor
ICAgIGlmIChmZCA8IDApIHsKKyAgICAgICAgcmV0dXJuIC0xOworICAgIH0KKyAgICBlcnJvciA9
IGlvY3RsKGZkLCBDRFJPTV9EUklWRV9TVEFUVVMsIDApOworICAgIGVycm9yID0gKGVycm9yID09
IENEU19ESVNDX09LKSA/IDAgOiAtMTsKKyAgICBpZiAoIWVycm9yKSB7CisgICAgICAgIGVycm9y
ID0gaW9jdGwoZmQsIENEUk9NX0RJU0NfU1RBVFVTLCAwKTsKKyAgICAgICAgZXJyb3IgPSAoZXJy
b3IgPT0gQ0RTX0RBVEFfMSkgPyAwIDogLTE7CisgICAgfQorICAgIGNsb3NlKGZkKTsKKyAgICBy
ZXR1cm4gZXJyb3I7Cit9CisKKyNlbHNlCisKK3N0YXRpYyBnYm9vbGVhbiBpc19kZXZpY2VfbmFt
ZShjb25zdCBjaGFyICpmaWxlbmFtZSkKK3sKKyAgICByZXR1cm4gZ19hc2NpaV9pc2FscGhhKGZp
bGVuYW1lWzBdKSAmJiBmaWxlbmFtZVsxXSA9PSAnOicgJiYKKyAgICAgICAgZmlsZW5hbWVbMl0g
PT0gMDsKK30KKworc3RhdGljIEhBTkRMRSBvcGVuX2ZpbGUoY29uc3QgY2hhciAqZmlsZW5hbWUp
Cit7CisgICAgSEFORExFIGggPSBDcmVhdGVGaWxlQShmaWxlbmFtZSwKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgIEdFTkVSSUNfUkVBRCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgIEZJ
TEVfU0hBUkVfUkVBRCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgIE5VTEwsIE9QRU5fRVhJ
U1RJTkcsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAwLAorICAgICAgICAgICAgICAgICAg
ICAgICAgICAgTlVMTCk7CisgICAgaWYgKGggPT0gSU5WQUxJRF9IQU5ETEVfVkFMVUUpIHsKKyAg
ICAgICAgaCA9IE5VTEw7CisgICAgfQorICAgIHJldHVybiBoOworfQorCitzdGF0aWMgdWludDMy
X3QgaW9jdGxfb3V0KEhBTkRMRSBoLCB1aW50MzJfdCBjb2RlLCB2b2lkICpvdXRfYnVmZmVyLCB1
aW50MzJfdCBvdXRfc2l6ZSkKK3sKKyAgICB1aW50MzJfdCBlcnJvcjsKKyAgICBEV09SRCByZXQ7
CisgICAgQk9PTCBiID0gRGV2aWNlSW9Db250cm9sKGgsIGNvZGUsIE5VTEwsIDAsIG91dF9idWZm
ZXIsIG91dF9zaXplLCAmcmV0LCBOVUxMKTsKKyAgICBlcnJvciA9IGIgPyAwIDogR2V0TGFzdEVy
cm9yKCk7CisgICAgcmV0dXJuIGVycm9yOworfQorCitzdGF0aWMgdWludDMyX3QgaW9jdGxfbm9u
ZShIQU5ETEUgaCwgdWludDMyX3QgY29kZSkKK3sKKyAgICByZXR1cm4gaW9jdGxfb3V0KGgsIGNv
ZGUsIE5VTEwsIDApOworfQorCitzdGF0aWMgZ2Jvb2xlYW4gY2hlY2tfZGV2aWNlKEhBTkRMRSBo
KQoreworICAgIEdFVF9DT05GSUdVUkFUSU9OX0lPQ1RMX0lOUFVUIGNmZ0luID0KKyAgICAgICAg
eyBGZWF0dXJlQ2RSZWFkLCBTQ1NJX0dFVF9DT05GSUdVUkFUSU9OX1JFUVVFU1RfVFlQRV9BTEws
IHt9IH07CisgICAgRFdPUkQgcmV0OworICAgIEdFVF9DT05GSUdVUkFUSU9OX0hFQURFUiBjZmdP
dXQ7CisgICAgcmV0dXJuIERldmljZUlvQ29udHJvbChoLCBJT0NUTF9DRFJPTV9HRVRfQ09ORklH
VVJBVElPTiwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICZjZmdJbiwgc2l6ZW9mKGNmZ0lu
KSwgJmNmZ091dCwgc2l6ZW9mKGNmZ091dCksCisgICAgICAgICAgICAgICAgICAgICAgICAgICAm
cmV0LCBOVUxMKTsKK30KKworc3RhdGljIGludCBjZF9kZXZpY2Vfb3Blbl9zdHJlYW0oU3BpY2VD
ZExVICp1bml0LCBjb25zdCBjaGFyICpmaWxlbmFtZSkKK3sKKyAgICBIQU5ETEUgaDsKKyAgICB1
bml0LT5kZXZpY2UgPSAwOworICAgIGlmICghdW5pdC0+ZmlsZW5hbWUgJiYgIWZpbGVuYW1lKSB7
CisgICAgICAgIFNQSUNFX0RFQlVHKCIlczogdW5uYW1lZCBmaWxlIiwgX19GVU5DVElPTl9fKTsK
KyAgICAgICAgcmV0dXJuIC0xOworICAgIH0KKyAgICBpZiAodW5pdC0+ZmlsZW5hbWUgJiYgZmls
ZW5hbWUpIHsKKyAgICAgICAgZ19mcmVlKHVuaXQtPmZpbGVuYW1lKTsKKyAgICAgICAgdW5pdC0+
ZmlsZW5hbWUgPSBOVUxMOworICAgIH0KKyAgICBpZiAoIWZpbGVuYW1lKSB7CisgICAgICAgIC8v
IHJlb3BlbmluZyB0aGUgc3RyZWFtIG9uIGV4aXN0aW5nIGZpbGUgbmFtZQorICAgIH0gZWxzZSBp
ZiAoaXNfZGV2aWNlX25hbWUoZmlsZW5hbWUpKSB7CisgICAgICAgIHVuaXQtPmZpbGVuYW1lID0g
Z19zdHJkdXBfcHJpbnRmKCJcXFxcLlxcJXMiLCBmaWxlbmFtZSk7CisgICAgfSBlbHNlIHsKKyAg
ICAgICAgdW5pdC0+ZmlsZW5hbWUgPSBnX3N0cmR1cChmaWxlbmFtZSk7CisgICAgfQorICAgIGgg
PSBvcGVuX2ZpbGUodW5pdC0+ZmlsZW5hbWUpOworICAgIGlmICghaCkgeworICAgICAgICBTUElD
RV9ERUJVRygiJXM6IGNhbid0IG9wZW4gZmlsZSAlcyIsIF9fRlVOQ1RJT05fXywgdW5pdC0+Zmls
ZW5hbWUpOworICAgICAgICByZXR1cm4gLTE7CisgICAgfQorCisgICAgTEFSR0VfSU5URUdFUiBz
aXplID0geyAwIH07CisgICAgaWYgKCFHZXRGaWxlU2l6ZUV4KGgsICZzaXplKSkgeworICAgICAg
ICB1aW50NjRfdCBidWZmZXJbMjU2XTsKKyAgICAgICAgdWludDMyX3QgcmVzOworICAgICAgICB1
bml0LT5kZXZpY2UgPSBjaGVja19kZXZpY2UoaCk7CisgICAgICAgIFNQSUNFX0RFQlVHKCIlczog
Q0QgZGV2aWNlICVzcmVjb2duaXplZCBvbiAlcyIsCisgICAgICAgICAgICBfX0ZVTkNUSU9OX18s
IHVuaXQtPmRldmljZSA/ICIiIDogIk5PVCAiLCB1bml0LT5maWxlbmFtZSk7CisgICAgICAgIHJl
cyA9IGlvY3RsX291dChoLCBJT0NUTF9ESVNLX0dFVF9EUklWRV9HRU9NRVRSWV9FWCwKKyAgICAg
ICAgICAgICAgICAgICAgICAgIGJ1ZmZlciwgc2l6ZW9mKGJ1ZmZlcikpOworICAgICAgICBpZiAo
IXJlcykgeworICAgICAgICAgICAgRElTS19HRU9NRVRSWV9FWCAqcGcgPSAoRElTS19HRU9NRVRS
WV9FWCAqKWJ1ZmZlcjsKKyAgICAgICAgICAgIHVuaXQtPmJsb2NrU2l6ZSA9IHBnLT5HZW9tZXRy
eS5CeXRlc1BlclNlY3RvcjsKKyAgICAgICAgICAgIHNpemUgPSBwZy0+RGlza1NpemU7CisgICAg
ICAgIH0gZWxzZSB7CisgICAgICAgICAgICBTUElDRV9ERUJVRygiJXM6IGNhbid0IG9idGFpbiBz
aXplIG9mICVzIChlcnJvciAldSkiLAorICAgICAgICAgICAgICAgIF9fRlVOQ1RJT05fXywgdW5p
dC0+ZmlsZW5hbWUsIHJlcyk7CisgICAgICAgIH0KKyAgICB9CisgICAgdW5pdC0+c2l6ZSA9IHNp
emUuUXVhZFBhcnQ7CisgICAgQ2xvc2VIYW5kbGUoaCk7CisgICAgaWYgKHVuaXQtPnNpemUpIHsK
KyAgICAgICAgR0ZpbGUgKmZpbGVfb2JqZWN0ID0gZ19maWxlX25ld19mb3JfcGF0aCh1bml0LT5m
aWxlbmFtZSk7CisgICAgICAgIHVuaXQtPnN0cmVhbSA9IGdfZmlsZV9yZWFkKGZpbGVfb2JqZWN0
LCBOVUxMLCBOVUxMKTsKKyAgICAgICAgZ19jbGVhcl9vYmplY3QoJmZpbGVfb2JqZWN0KTsKKyAg
ICB9CisgICAgaWYgKCF1bml0LT5zdHJlYW0pIHsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBj
YW4ndCBvcGVuIHN0cmVhbSBvbiAlcyIsIF9fRlVOQ1RJT05fXywgdW5pdC0+ZmlsZW5hbWUpOwor
ICAgICAgICByZXR1cm4gLTE7CisgICAgfQorICAgIHJldHVybiAwOworfQorCitzdGF0aWMgaW50
IGNkX2RldmljZV9sb2FkKFNwaWNlQ2RMVSAqdW5pdCwgZ2Jvb2xlYW4gbG9hZCkKK3sKKyAgICBp
bnQgZXJyb3IgPSAwOworICAgIEhBTkRMRSBoOworICAgIGlmICghdW5pdC0+ZGV2aWNlIHx8ICF1
bml0LT5maWxlbmFtZSkgeworICAgICAgICByZXR1cm4gLTE7CisgICAgfQorICAgIGggPSBvcGVu
X2ZpbGUodW5pdC0+ZmlsZW5hbWUpOworICAgIGlmIChoKSB7CisgICAgICAgIHVpbnQzMl90IHJl
cyA9IGlvY3RsX25vbmUoaCwgbG9hZCA/IElPQ1RMX1NUT1JBR0VfTE9BRF9NRURJQSA6IElPQ1RM
X1NUT1JBR0VfRUpFQ1RfTUVESUEpOworICAgICAgICBpZiAocmVzKSB7CisgICAgICAgICAgICBT
UElDRV9ERUJVRygiJXM6IGNhbid0ICVzbG9hZCAlcywgd2luIGVycm9yICV1IiwKKyAgICAgICAg
ICAgICAgICAgICAgICAgIF9fRlVOQ1RJT05fXywgbG9hZCA/ICIiIDogInVuIiwgdW5pdC0+Zmls
ZW5hbWUsIHJlcyk7CisgICAgICAgICAgICBlcnJvciA9IC0xOworICAgICAgICB9IGVsc2Ugewor
ICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBkZXZpY2UgJXMgWyVzXSIsCisgICAgICAgICAg
ICAgICAgICAgICAgICBfX0ZVTkNUSU9OX18sIGxvYWQgPyAibG9hZGVkIiA6ICJlamVjdGVkIiwg
dW5pdC0+ZmlsZW5hbWUpOworICAgICAgICB9CisgICAgICAgIENsb3NlSGFuZGxlKGgpOworICAg
IH0KKyAgICByZXR1cm4gZXJyb3I7Cit9CisKK3N0YXRpYyBpbnQgY2RfZGV2aWNlX2NoZWNrKFNw
aWNlQ2RMVSAqdW5pdCkKK3sKKyAgICBpbnQgZXJyb3IgPSAwOworICAgIENEUk9NX0RJU0tfREFU
QSBkYXRhOworICAgIEhBTkRMRSBoOworICAgIGlmICghdW5pdC0+ZGV2aWNlIHx8ICF1bml0LT5m
aWxlbmFtZSkgeworICAgICAgICByZXR1cm4gLTE7CisgICAgfQorICAgIGggPSBvcGVuX2ZpbGUo
dW5pdC0+ZmlsZW5hbWUpOworICAgIGlmIChoKSB7CisgICAgICAgIHVpbnQzMl90IHJlcyA9IGlv
Y3RsX25vbmUoaCwgSU9DVExfU1RPUkFHRV9DSEVDS19WRVJJRlkpOworICAgICAgICBpZiAoIXJl
cykgeworICAgICAgICAgICAgcmVzID0gaW9jdGxfb3V0KGgsIElPQ1RMX0NEUk9NX0RJU0tfVFlQ
RSwgJmRhdGEsIHNpemVvZihkYXRhKSk7CisgICAgICAgIH0KKyAgICAgICAgaWYgKHJlcyAhPSAw
IHx8IGRhdGEuRGlza0RhdGEgIT0gQ0RST01fRElTS19EQVRBX1RSQUNLKSB7CisgICAgICAgICAg
ICBlcnJvciA9IC0xOworICAgICAgICB9CisgICAgICAgIENsb3NlSGFuZGxlKGgpOworICAgIH0K
KyAgICByZXR1cm4gZXJyb3I7Cit9CisKKyNlbmRpZgorCitzdGF0aWMgZ2Jvb2xlYW4gb3Blbl9z
dHJlYW0oU3BpY2VDZExVICp1bml0LCBjb25zdCBjaGFyICpmaWxlbmFtZSkKK3sKKyAgICBnYm9v
bGVhbiBiOworICAgIGIgPSBjZF9kZXZpY2Vfb3Blbl9zdHJlYW0odW5pdCwgZmlsZW5hbWUpID09
IDA7CisgICAgcmV0dXJuIGI7Cit9CisKK3N0YXRpYyB2b2lkIGNsb3NlX3N0cmVhbShTcGljZUNk
TFUgKnVuaXQpCit7CisgICAgZ19jbGVhcl9vYmplY3QoJnVuaXQtPnN0cmVhbSk7Cit9CisKK3N0
YXRpYyBnYm9vbGVhbiBsb2FkX2x1bihVc2JDZCAqZCwgaW50IHVuaXQsIGdib29sZWFuIGxvYWQp
Cit7CisgICAgZ2Jvb2xlYW4gYiA9IFRSVUU7CisgICAgaWYgKGxvYWQgJiYgZC0+dW5pdHNbdW5p
dF0uZGV2aWNlKSB7CisgICAgICAgIC8vIHRoZXJlIGlzIG9uZSBwb3NzaWJsZSBwcm9ibGVtIGlu
IGNhc2Ugb3VyIGJhY2tlbmQgaXMgdGhlCisgICAgICAgIC8vIGxvY2FsIENEIGRldmljZSBhbmQg
aXQgaXMgZWplY3RlZAorICAgICAgICBjZF9kZXZpY2VfbG9hZCgmZC0+dW5pdHNbdW5pdF0sIFRS
VUUpOworICAgICAgICBjbG9zZV9zdHJlYW0oJmQtPnVuaXRzW3VuaXRdKTsKKyAgICAgICAgaWYg
KGNkX2RldmljZV9jaGVjaygmZC0+dW5pdHNbdW5pdF0pIHx8ICFvcGVuX3N0cmVhbSgmZC0+dW5p
dHNbdW5pdF0sIE5VTEwpKSB7CisgICAgICAgICAgICByZXR1cm4gRkFMU0U7CisgICAgICAgIH0K
KyAgICB9CisKKyAgICBpZiAobG9hZCkgeworICAgICAgICBDZFNjc2lNZWRpYVBhcmFtZXRlcnMg
bWVkaWFfcGFyYW1zID0geyAwIH07CisKKyAgICAgICAgbWVkaWFfcGFyYW1zLnN0cmVhbSA9IGQt
PnVuaXRzW3VuaXRdLnN0cmVhbTsKKyAgICAgICAgbWVkaWFfcGFyYW1zLnNpemUgPSBkLT51bml0
c1t1bml0XS5zaXplOworICAgICAgICBtZWRpYV9wYXJhbXMuYmxvY2tfc2l6ZSA9IGQtPnVuaXRz
W3VuaXRdLmJsb2NrU2l6ZTsKKyAgICAgICAgaWYgKG1lZGlhX3BhcmFtcy5ibG9ja19zaXplID09
IENEX0RFVl9CTE9DS19TSVpFICYmCisgICAgICAgICAgICBtZWRpYV9wYXJhbXMuc2l6ZSAlIERW
RF9ERVZfQkxPQ0tfU0laRSA9PSAwKSB7CisgICAgICAgICAgICBtZWRpYV9wYXJhbXMuYmxvY2tf
c2l6ZSA9IERWRF9ERVZfQkxPQ0tfU0laRTsKKyAgICAgICAgfQorICAgICAgICBTUElDRV9ERUJV
RygiJXM6IGxvYWRpbmcgJXMsIHNpemUgJSIgR19HVUlOVDY0X0ZPUk1BVCAiLCBibG9jayAldSIs
CisgICAgICAgICAgICAgICAgICAgIF9fRlVOQ1RJT05fXywgZC0+dW5pdHNbdW5pdF0uZmlsZW5h
bWUsIG1lZGlhX3BhcmFtcy5zaXplLCBtZWRpYV9wYXJhbXMuYmxvY2tfc2l6ZSk7CisKKyAgICAg
ICAgYiA9ICFjZF91c2JfYnVsa19tc2RfbG9hZChkLT5tc2MsIHVuaXQsICZtZWRpYV9wYXJhbXMp
OworCisgICAgICAgIGQtPnVuaXRzW3VuaXRdLmxvYWRlZCA9ICEhYjsKKworICAgIH0gZWxzZSB7
CisgICAgICAgIFNQSUNFX0RFQlVHKCIlczogdW5sb2FkaW5nICVzIiwgX19GVU5DVElPTl9fLCBk
LT51bml0c1t1bml0XS5maWxlbmFtZSk7CisgICAgICAgIGNkX3VzYl9idWxrX21zZF91bmxvYWQo
ZC0+bXNjLCB1bml0KTsKKyAgICAgICAgZC0+dW5pdHNbdW5pdF0ubG9hZGVkID0gRkFMU0U7Cisg
ICAgfQorICAgIHJldHVybiBiOworfQorCitzdGF0aWMgdm9pZCB1c2JfY2RfdW5yZWFsaXplKFVz
YkNkICpkKQoreworICAgIHVpbnQzMl90IHVuaXQgPSAwOworICAgIGNkX3VzYl9idWxrX21zZF91
bnJlYWxpemUoZC0+bXNjLCB1bml0KTsKKyAgICBnX2NsZWFyX3BvaW50ZXIoJmQtPnVuaXRzW3Vu
aXRdLmZpbGVuYW1lLCBnX2ZyZWUpOworICAgIGNsb3NlX3N0cmVhbSgmZC0+dW5pdHNbdW5pdF0p
OworICAgIGdfY2xlYXJfcG9pbnRlcigmZC0+bXNjLCBjZF91c2JfYnVsa19tc2RfZnJlZSk7Cisg
ICAgZ19mcmVlKGQpOworfQorCitzdGF0aWMgZ2Jvb2xlYW4gdXNiX2NkX2dldF9kZXNjcmlwdG9y
KFVzYkNkICpkLCB1aW50OF90IHR5cGUsIHVpbnQ4X3QgaW5kZXgsCisgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIHZvaWQgKipidWZmZXIsIHVpbnQxNl90ICpzaXplKQorewor
ICAgIHN0YXRpYyBzdHJ1Y3QgbGlidXNiX2RldmljZV9kZXNjcmlwdG9yIGRlc2MgPSB7CisgICAg
ICAgIC5iTGVuZ3RoID0gMTgsCisgICAgICAgIC5iRGVzY3JpcHRvclR5cGUgPSBMSUJVU0JfRFRf
REVWSUNFLAorICAgICAgICAuYmNkVVNCID0gVVNCMl9CQ0QsCisgICAgICAgIC5iRGV2aWNlQ2xh
c3MgPSAwLAorICAgICAgICAuYkRldmljZVN1YkNsYXNzID0gMCwKKyAgICAgICAgLmJEZXZpY2VQ
cm90b2NvbCA9IDAsCisgICAgICAgIC5iTWF4UGFja2V0U2l6ZTAgPSA2NCwKKyAgICAgICAgLmlk
VmVuZG9yID0gQ0RfREVWX1ZJRCwKKyAgICAgICAgLmlkUHJvZHVjdCA9IENEX0RFVl9QSUQsCisg
ICAgICAgIC5iY2REZXZpY2UgPSAweDEwMCwKKyAgICAgICAgLmlNYW51ZmFjdHVyZXIgPSAxLAor
ICAgICAgICAuaVByb2R1Y3QgPSAyLAorICAgICAgICAuaVNlcmlhbE51bWJlciA9IDMsCisgICAg
ICAgIC5iTnVtQ29uZmlndXJhdGlvbnMgPSAxCisgICAgfTsKKyAgICBzdGF0aWMgdWludDhfdCBj
ZmdbXSA9CisgICAgeworICAgICAgICA5LCAvL2xlbiBvZiBjZmcgZGVzYworICAgICAgICBMSUJV
U0JfRFRfQ09ORklHLCAvLyBkZXNjIHR5cGUKKyAgICAgICAgMHgyMCwgLy8gd2xlbgorICAgICAg
ICAwLAorICAgICAgICAxLCAvLyBudW0gaWYKKyAgICAgICAgMSwgLy8gY2ZnIHZhbAorICAgICAg
ICAwLCAvLyBjZmcgbmFtZQorICAgICAgICAweDgwLCAvLyBidXMgcG93ZXJlZAorICAgICAgICAw
eDMyLCAvLyAxMDAgbWEKKyAgICAgICAgOSwgLy8gbGVuIG9mIElGIGRlc2MKKyAgICAgICAgTElC
VVNCX0RUX0lOVEVSRkFDRSwKKyAgICAgICAgMCwgLy8gbnVtIGlmCisgICAgICAgIDAsIC8vIGFs
dCBzZXR0aW5nCisgICAgICAgIDIsIC8vIG51bSBvZiBlbmRwb2ludHMKKyAgICAgICAgQ0RfREVW
X0NMQVNTLAorICAgICAgICBDRF9ERVZfU1VCQ0xBU1MsCisgICAgICAgIENEX0RFVl9QUk9UT0NP
TCwKKyAgICAgICAgMCwgLy8gaWYgbmFtZQorICAgICAgICA3LAorICAgICAgICBMSUJVU0JfRFRf
RU5EUE9JTlQsCisgICAgICAgIDB4ODEsIC8vLT5EaXJlY3Rpb24gOiBJTiAtIEVuZHBvaW50SUQg
OiAxCisgICAgICAgIDB4MDIsIC8vLT5CdWxrIFRyYW5zZmVyIFR5cGUKKyAgICAgICAgMCwgICAg
Ly93TWF4UGFja2V0U2l6ZSA6IDB4MDIwMCA9IDB4MjAwIG1heCBieXRlcworICAgICAgICAyLAor
ICAgICAgICAwLCAgICAvL2JJbnRlcnZhbAorICAgICAgICA3LAorICAgICAgICBMSUJVU0JfRFRf
RU5EUE9JTlQsCisgICAgICAgIDB4MDIsIC8vLT5EaXJlY3Rpb24gOiBPVVQgLSBFbmRwb2ludElE
IDogMgorICAgICAgICAweDAyLCAvLy0+QnVsayBUcmFuc2ZlciBUeXBlCisgICAgICAgIDAsICAg
IC8vd01heFBhY2tldFNpemUgOiAweDAyMDAgPSAweDIwMCBtYXggYnl0ZXMKKyAgICAgICAgMiwK
KyAgICAgICAgMCwgICAgLy9iSW50ZXJ2YWwKKyAgICB9OworICAgIHN0YXRpYyB1aW50MTZfdCBz
MFsyXSA9IHsgMHgzMDQsIDB4NDA5IH07CisgICAgc3RhdGljIHVpbnQxNl90IHMxWzhdID0geyAw
eDMxMCwgJ1InLCAnZScsICdkJywgJyAnLCAnSCcsICdhJywgJ3QnIH07CisgICAgc3RhdGljIHVp
bnQxNl90IHMyWzldID0geyAweDMxMiwgJ1MnLCAncCcsICdpJywgJ2MnLCAnZScsICcgJywgJ0Mn
LCAnRCcgfTsKKworICAgIHZvaWQgKnAgPSBOVUxMOworICAgIHVpbnQxNl90IGxlbiA9IDA7CisK
KyAgICBzd2l0Y2ggKHR5cGUpIHsKKyAgICBjYXNlIExJQlVTQl9EVF9ERVZJQ0U6CisgICAgICAg
IHAgPSAmZGVzYzsKKyAgICAgICAgbGVuID0gc2l6ZW9mKGRlc2MpOworICAgICAgICBicmVhazsK
KyAgICBjYXNlIExJQlVTQl9EVF9DT05GSUc6CisgICAgICAgIHAgPSBjZmc7CisgICAgICAgIGxl
biA9IHNpemVvZihjZmcpOworICAgICAgICBicmVhazsKKyAgICBjYXNlIExJQlVTQl9EVF9TVFJJ
Tkc6CisgICAgICAgIGlmIChpbmRleCA9PSAwKSB7CisgICAgICAgICAgICBwID0gczA7IGxlbiA9
IHNpemVvZihzMCk7CisgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPT0gMSkgeworICAgICAgICAg
ICAgcCA9IHMxOyBsZW4gPSBzaXplb2YoczEpOworICAgICAgICB9IGVsc2UgaWYgKGluZGV4ID09
IDIpIHsKKyAgICAgICAgICAgIHAgPSBzMjsgbGVuID0gc2l6ZW9mKHMyKTsKKyAgICAgICAgfSBl
bHNlIGlmIChpbmRleCA9PSAzKSB7CisgICAgICAgICAgICBwID0gZC0+c2VyaWFsOyBsZW4gPSBz
aXplb2YoZC0+c2VyaWFsKTsKKyAgICAgICAgfQorICAgICAgICBicmVhazsKKyAgICB9CisKKyAg
ICBpZiAocCkgeworICAgICAgICAqYnVmZmVyID0gcDsKKyAgICAgICAgKnNpemUgPSBsZW47Cisg
ICAgfQorCisgICAgcmV0dXJuIHAgIT0gTlVMTDsKK30KKworc3RhdGljIHZvaWQgdXNiX2NkX2F0
dGFjaChVc2JDZCAqZGV2aWNlLCBzdHJ1Y3QgdXNicmVkaXJwYXJzZXIgKnBhcnNlcikKK3sKKyAg
ICBkZXZpY2UtPnBhcnNlciA9IHBhcnNlcjsKK30KKworc3RhdGljIHZvaWQgdXNiX2NkX2RldGFj
aChVc2JDZCAqZGV2aWNlKQoreworICAgIGRldmljZS0+cGFyc2VyID0gTlVMTDsKK30KKworc3Rh
dGljIHZvaWQgdXNiX2NkX3Jlc2V0KFVzYkNkICpkZXZpY2UpCit7CisgICAgY2RfdXNiX2J1bGtf
bXNkX3Jlc2V0KGRldmljZS0+bXNjKTsKK30KKworc3RhdGljIHZvaWQgdXNiX2NkX2NvbnRyb2xf
cmVxdWVzdChVc2JDZCAqZGV2aWNlLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICB1aW50OF90ICpkYXRhLCBpbnQgZGF0YV9sZW4sCisgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIHN0cnVjdCB1c2JfcmVkaXJfY29udHJvbF9wYWNrZXRfaGVhZGVyICpoLAorICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2lkICoqYnVmZmVyKQoreworICAgIHVp
bnQ4X3QgcmVxdHlwZSA9IGgtPnJlcXVlc3R0eXBlICYgMHg3ZjsKKyAgICBpZiAoIWRldmljZS0+
bXNjKSB7CisgICAgICAgIHJldHVybjsKKyAgICB9CisgICAgaWYgKHJlcXR5cGUgPT0gKExJQlVT
Ql9SRVFVRVNUX1RZUEVfU1RBTkRBUkQgfCBMSUJVU0JfUkVDSVBJRU5UX0VORFBPSU5UKSkgewor
ICAgICAgICAvLyBtaWdodCBiZSBjbGVhciBzdGFsbCByZXF1ZXN0CisgICAgICAgIGgtPmxlbmd0
aCA9IDA7CisgICAgICAgIGgtPnN0YXR1cyA9IHVzYl9yZWRpcl9zdWNjZXNzOzsKKyAgICAgICAg
cmV0dXJuOworICAgIH0KKworICAgIGlmIChyZXF0eXBlID09IChMSUJVU0JfUkVRVUVTVF9UWVBF
X0NMQVNTIHwgTElCVVNCX1JFQ0lQSUVOVF9JTlRFUkZBQ0UpKSB7CisgICAgICAgIHN3aXRjaCAo
aC0+cmVxdWVzdCkgeworICAgICAgICBjYXNlIDB4RkY6CisgICAgICAgICAgICAvLyBtYXNzLXN0
b3JhZ2UgY2xhc3MgcmVxdWVzdCAncmVzZXQnCisgICAgICAgICAgICB1c2JfY2RfcmVzZXQoZGV2
aWNlKTsKKyAgICAgICAgICAgIGgtPmxlbmd0aCA9IDA7CisgICAgICAgICAgICBoLT5zdGF0dXMg
PSB1c2JfcmVkaXJfc3VjY2VzczsKKyAgICAgICAgICAgIGJyZWFrOworICAgICAgICBjYXNlIDB4
RkU6CisgICAgICAgICAgICAvLyBtYXNzLXN0b3JhZ2UgY2xhc3MgcmVxdWVzdCAnZ2V0IG1heCBs
dW4nCisgICAgICAgICAgICAvLyByZXR1cm5pbmcgb25lIGJ5dGUKKyAgICAgICAgICAgIGlmICho
LT5sZW5ndGgpIHsKKyAgICAgICAgICAgICAgICBoLT5sZW5ndGggPSAxOworICAgICAgICAgICAg
ICAgIGgtPnN0YXR1cyA9IHVzYl9yZWRpcl9zdWNjZXNzOworICAgICAgICAgICAgICAgICpidWZm
ZXIgPSAmZGV2aWNlLT5tYXhfbHVuX2luZGV4OworICAgICAgICAgICAgfQorICAgICAgICAgICAg
YnJlYWs7CisgICAgICAgIH0KKyAgICB9Cit9CisKK3N0YXRpYyB2b2lkIHVzYl9jZF9idWxrX291
dF9yZXF1ZXN0KFVzYkNkICpkZXZpY2UsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICB1aW50OF90IGVwLCB1aW50OF90ICpkYXRhLCBpbnQgZGF0YV9sZW4sCisgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50OF90ICpzdGF0dXMpCit7CisgICAgaWYgKCFj
ZF91c2JfYnVsa19tc2Rfd3JpdGUoZGV2aWNlLT5tc2MsIGRhdGEsIGRhdGFfbGVuKSkgeworICAg
ICAgICAqc3RhdHVzID0gdXNiX3JlZGlyX3N1Y2Nlc3M7CisgICAgfQorfQorCit2b2lkIGNkX3Vz
Yl9idWxrX21zZF9yZWFkX2NvbXBsZXRlKHZvaWQgKnVzZXJfZGF0YSwKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgdWludDhfdCAqZGF0YSwgdWludDMyX3QgbGVuZ3RoLCBDZFVz
YkJ1bGtTdGF0dXMgc3RhdHVzKQoreworICAgIFVzYkNkICpkID0gKFVzYkNkICopdXNlcl9kYXRh
OworCisgICAgaWYgKGQtPmRlbGV0aW5nKSB7CisgICAgICAgIGQtPmRlbGV0aW5nID0gRkFMU0U7
CisgICAgICAgIHNwaWNlX3VzYl9iYWNrZW5kX2RldmljZV9lamVjdChkLT5iYWNrZW5kLCBkLT5w
YXJlbnQpOworICAgIH0KKworICAgIGlmIChkLT5wYXJzZXIpIHsKKyAgICAgICAgaW50IG5yZWFk
OworICAgICAgICB1aW50MzJfdCBvZmZzZXQgPSAwOworCisgICAgICAgIGZvciAobnJlYWQgPSAw
OyBucmVhZCA8IGQtPm51bV9yZWFkczsgbnJlYWQrKykgeworICAgICAgICAgICAgdWludDMyX3Qg
bWF4X2xlbjsKKyAgICAgICAgICAgIG1heF9sZW4gPSAoZC0+cmVhZF9idWxrW25yZWFkXS5ob3V0
Lmxlbmd0aF9oaWdoIDw8IDE2KSB8CisgICAgICAgICAgICAgICAgICAgICAgICBkLT5yZWFkX2J1
bGtbbnJlYWRdLmhvdXQubGVuZ3RoOworICAgICAgICAgICAgaWYgKG1heF9sZW4gPiBsZW5ndGgp
IHsKKyAgICAgICAgICAgICAgICBtYXhfbGVuID0gbGVuZ3RoOworICAgICAgICAgICAgICAgIGQt
PnJlYWRfYnVsa1tucmVhZF0uaG91dC5sZW5ndGggPSBsZW5ndGg7CisgICAgICAgICAgICAgICAg
ZC0+cmVhZF9idWxrW25yZWFkXS5ob3V0Lmxlbmd0aF9oaWdoID0gbGVuZ3RoID4+IDE2OworICAg
ICAgICAgICAgfQorCisgICAgICAgICAgICBzd2l0Y2ggKHN0YXR1cykgeworICAgICAgICAgICAg
Y2FzZSBCVUxLX1NUQVRVU19HT09EOgorICAgICAgICAgICAgICAgIGQtPnJlYWRfYnVsa1tucmVh
ZF0uaG91dC5zdGF0dXMgPSB1c2JfcmVkaXJfc3VjY2VzczsKKyAgICAgICAgICAgICAgICBicmVh
azsKKyAgICAgICAgICAgIGNhc2UgQlVMS19TVEFUVVNfQ0FOQ0VMRUQ6CisgICAgICAgICAgICAg
ICAgZC0+cmVhZF9idWxrW25yZWFkXS5ob3V0LnN0YXR1cyA9IHVzYl9yZWRpcl9jYW5jZWxsZWQ7
CisgICAgICAgICAgICAgICAgYnJlYWs7CisgICAgICAgICAgICBjYXNlIEJVTEtfU1RBVFVTX0VS
Uk9SOgorICAgICAgICAgICAgICAgIGQtPnJlYWRfYnVsa1tucmVhZF0uaG91dC5zdGF0dXMgPSB1
c2JfcmVkaXJfaW9lcnJvcjsKKyAgICAgICAgICAgICAgICBicmVhazsKKyAgICAgICAgICAgIGNh
c2UgQlVMS19TVEFUVVNfU1RBTEw6CisgICAgICAgICAgICBkZWZhdWx0OgorICAgICAgICAgICAg
ICAgIGQtPnJlYWRfYnVsa1tucmVhZF0uaG91dC5zdGF0dXMgPSB1c2JfcmVkaXJfc3RhbGw7Cisg
ICAgICAgICAgICAgICAgYnJlYWs7CisgICAgICAgICAgICB9CisKKyAgICAgICAgICAgIFNQSUNF
X0RFQlVHKCIlczogcmVzcG9uZGluZyAlIiBHX0dVSU5UNjRfRk9STUFUICIgd2l0aCBsZW4gJXUg
b3V0IG9mICV1LCBzdGF0dXMgJWQiLAorICAgICAgICAgICAgICAgICAgICAgICAgX19GVU5DVElP
Tl9fLCBkLT5yZWFkX2J1bGtbbnJlYWRdLmlkLCBtYXhfbGVuLAorICAgICAgICAgICAgICAgICAg
ICAgICAgbGVuZ3RoLCBkLT5yZWFkX2J1bGtbbnJlYWRdLmhvdXQuc3RhdHVzKTsKKyAgICAgICAg
ICAgIHVzYnJlZGlycGFyc2VyX3NlbmRfYnVsa19wYWNrZXQoZC0+cGFyc2VyLCBkLT5yZWFkX2J1
bGtbbnJlYWRdLmlkLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAmZC0+cmVhZF9idWxrW25yZWFkXS5ob3V0LAorICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICBtYXhfbGVuID8gKGRhdGEgKyBvZmZzZXQpIDogTlVMTCwKKyAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4X2xlbik7CisgICAgICAg
ICAgICBvZmZzZXQgKz0gbWF4X2xlbjsKKyAgICAgICAgICAgIGxlbmd0aCAtPSBtYXhfbGVuOwor
ICAgICAgICB9CisgICAgICAgIGQtPm51bV9yZWFkcyA9IDA7CisgICAgICAgIHVzYnJlZGlycGFy
c2VyX2RvX3dyaXRlKGQtPnBhcnNlcik7CisKKyAgICAgICAgaWYgKGxlbmd0aCkgeworICAgICAg
ICAgICAgU1BJQ0VfREVCVUcoIiVzOiBFUlJPUjogJXUgYnl0ZXMgd2VyZSBub3QgcmVwb3J0ZWQh
IiwgX19GVU5DVElPTl9fLCBsZW5ndGgpOworICAgICAgICB9CisKKyAgICB9IGVsc2UgeworICAg
ICAgICBTUElDRV9ERUJVRygiJXM6IGJyb2tlbiBkZXZpY2U8LT5jaGFubmVsIHJlbGF0aW9uc2hp
cCEiLCBfX0ZVTkNUSU9OX18pOworICAgIH0KK30KKworLyogZGV2aWNlIHJlc2V0IGNvbXBsZXRp
b24gY2FsbGJhY2sgKi8KK3ZvaWQgY2RfdXNiX2J1bGtfbXNkX3Jlc2V0X2NvbXBsZXRlKHZvaWQg
KnVzZXJfZGF0YSwgaW50IHN0YXR1cykKK3sKKyAgICAvLyBVc2JDZCAqZCA9IChVc2JDZCAqKXVz
ZXJfZGF0YTsKK30KKworc3RhdGljIGdib29sZWFuIHVzYl9jZF9idWxrX2luX3JlcXVlc3QoVXNi
Q2QgKmQsIHVpbnQ2NF90IGlkLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgc3RydWN0IHVzYl9yZWRpcl9idWxrX3BhY2tldF9oZWFkZXIgKmgpCit7CisgICAgaW50IHJl
czsKKyAgICB1aW50MzJfdCBsZW4gPSAoaC0+bGVuZ3RoX2hpZ2ggPDwgMTYpIHwgaC0+bGVuZ3Ro
OworICAgIGlmIChkLT5udW1fcmVhZHMgPj0gTUFYX0JVTEtfSU5fUkVRVUVTVFMpIHsKKyAgICAg
ICAgaC0+bGVuZ3RoID0gaC0+bGVuZ3RoX2hpZ2ggPSAwOworICAgICAgICBTUElDRV9ERUJVRygi
JXM6IHRvbyBtYW55IHBlbmRpbmcgcmVhZHMiLCBfX0ZVTkNUSU9OX18pOworICAgICAgICBoLT5z
dGF0dXMgPSB1c2JfcmVkaXJfYmFiYmxlOworICAgICAgICByZXR1cm4gRkFMU0U7CisgICAgfQor
CisgICAgaWYgKGQtPm51bV9yZWFkcykgeworICAgICAgICBTUElDRV9ERUJVRygiJXM6IGFscmVh
ZHkgaGFzICV1IHBlbmRpbmcgcmVhZHMiLCBfX0ZVTkNUSU9OX18sIGQtPm51bV9yZWFkcyk7Cisg
ICAgfQorCisgICAgZC0+cmVhZF9idWxrW2QtPm51bV9yZWFkc10uaG91dCA9ICpoOworICAgIGQt
PnJlYWRfYnVsa1tkLT5udW1fcmVhZHNdLmlkID0gaWQ7CisgICAgZC0+bnVtX3JlYWRzKys7Cisg
ICAgcmVzID0gY2RfdXNiX2J1bGtfbXNkX3JlYWQoZC0+bXNjLCBsZW4pOworICAgIGlmICghcmVz
KSB7CisgICAgICAgIHJldHVybiBUUlVFOworICAgIH0KKworICAgIFNQSUNFX0RFQlVHKCIlczog
ZXJyb3Igb24gYnVsayByZWFkIiwgX19GVU5DVElPTl9fKTsKKyAgICBkLT5udW1fcmVhZHMtLTsK
KyAgICBoLT5sZW5ndGggPSBoLT5sZW5ndGhfaGlnaCA9IDA7CisgICAgaC0+c3RhdHVzID0gdXNi
X3JlZGlyX2lvZXJyb3I7CisKKyAgICByZXR1cm4gRkFMU0U7Cit9CisKK3N0YXRpYyB2b2lkIHVz
Yl9jZF9jYW5jZWxfcmVxdWVzdChVc2JDZCAqZCwgdWludDY0X3QgaWQpCit7CisgICAgdWludDMy
X3QgbnJlYWQ7CisKKyAgICBmb3IgKG5yZWFkID0gMDsgbnJlYWQgPCBkLT5udW1fcmVhZHM7IG5y
ZWFkKyspIHsKKyAgICAgICAgaWYgKGQtPnJlYWRfYnVsa1tucmVhZF0uaWQgPT0gaWQpIHsKKyAg
ICAgICAgICAgIGlmIChjZF91c2JfYnVsa19tc2RfY2FuY2VsX3JlYWQoZC0+bXNjKSkgeworICAg
ICAgICAgICAgICAgIGNkX3VzYl9idWxrX21zZF9yZWFkX2NvbXBsZXRlKGQsIE5VTEwsIDAsIEJV
TEtfU1RBVFVTX0NBTkNFTEVEKTsKKyAgICAgICAgICAgIH0KKyAgICAgICAgICAgIHJldHVybjsK
KyAgICAgICAgfQorICAgIH0KKyAgICBTUElDRV9ERUJVRygiJXM6IEVSUk9SOiBubyBzdWNoIGlk
IHRvIGNhbmNlbCEiLCBfX0ZVTkNUSU9OX18pOworfQorCisvLyBjYWxsZWQgd2hlbiBhIGNoYW5n
ZSBoYXBwZW5zIG9uIFNDU0kgbGF5ZXIKK3ZvaWQgY2RfdXNiX2J1bGtfbXNkX2x1bl9jaGFuZ2Vk
KHZvaWQgKnVzZXJfZGF0YSwgdWludDMyX3QgbHVuKQoreworICAgIFVzYkNkICpkID0gKFVzYkNk
ICopdXNlcl9kYXRhOworICAgIENkU2NzaURldmljZUluZm8gY2RfaW5mbzsKKworICAgIGlmICgh
Y2RfdXNiX2J1bGtfbXNkX2dldF9pbmZvKGQtPm1zYywgbHVuLCAmY2RfaW5mbykpIHsKKyAgICAg
ICAgLy8gbG9hZCBvciB1bmxvYWQgY29tbWFuZCByZWNlaXZlZCBmcm9tIFNDU0kKKyAgICAgICAg
aWYgKGQtPnVuaXRzW2x1bl0ubG9hZGVkICE9IGNkX2luZm8ubG9hZGVkKSB7CisgICAgICAgICAg
ICBpZiAoIWxvYWRfbHVuKGQsIGx1biwgY2RfaW5mby5sb2FkZWQpKSB7CisgICAgICAgICAgICAg
ICAgU1BJQ0VfREVCVUcoIiVzOiBsb2FkIGZhaWxlZCwgdW5sb2FkaW5nIHVuaXQiLCBfX0ZVTkNU
SU9OX18pOworICAgICAgICAgICAgICAgIGNkX3VzYl9idWxrX21zZF91bmxvYWQoZC0+bXNjLCBs
dW4pOworICAgICAgICAgICAgfQorICAgICAgICB9CisgICAgfQorCisgICAgaWYgKGQtPmRlbGV0
ZV9vbl9lamVjdCkgeworICAgICAgICBkLT5kZWxldGVfb25fZWplY3QgPSBGQUxTRTsKKyAgICAg
ICAgZC0+ZGVsZXRpbmcgPSBUUlVFOworICAgIH0gZWxzZSB7CisgICAgICAgIHNwaWNlX3VzYl9i
YWNrZW5kX2RldmljZV9yZXBvcnRfY2hhbmdlKGQtPmJhY2tlbmQsIGQtPnBhcmVudCk7CisgICAg
fQorfQorCitzdGF0aWMgZ2NoYXIgKnVzYl9jZF9nZXRfcHJvZHVjdF9kZXNjcmlwdGlvbihVc2JD
ZCAqZGV2aWNlKQoreworICAgIGdjaGFyICpiYXNlX25hbWUgPSBnX3BhdGhfZ2V0X2Jhc2VuYW1l
KGRldmljZS0+dW5pdHNbMF0uZmlsZW5hbWUpOworICAgIGdjaGFyICpyZXMgPSBnX3N0cmR1cF9w
cmludGYoIlNQSUNFIENEICglcykiLCBiYXNlX25hbWUpOworICAgIGdfZnJlZShiYXNlX25hbWUp
OworICAgIHJldHVybiByZXM7Cit9CisKK3N0YXRpYyBjb25zdCBVc2JEZXZpY2VPcHMgZGV2b3Bz
ID0KK3sKKyAgICAuZ2V0X2Rlc2NyaXB0b3IgPSB1c2JfY2RfZ2V0X2Rlc2NyaXB0b3IsCisgICAg
LmdldF9wcm9kdWN0X2Rlc2NyaXB0aW9uID0gdXNiX2NkX2dldF9wcm9kdWN0X2Rlc2NyaXB0aW9u
LAorICAgIC5hdHRhY2ggPSB1c2JfY2RfYXR0YWNoLAorICAgIC5yZXNldCA9IHVzYl9jZF9yZXNl
dCwKKyAgICAuZGV0YWNoID0gdXNiX2NkX2RldGFjaCwKKyAgICAuY29udHJvbF9yZXF1ZXN0ID0g
dXNiX2NkX2NvbnRyb2xfcmVxdWVzdCwKKyAgICAuYnVsa19vdXRfcmVxdWVzdCA9IHVzYl9jZF9i
dWxrX291dF9yZXF1ZXN0LAorICAgIC5idWxrX2luX3JlcXVlc3QgPSB1c2JfY2RfYnVsa19pbl9y
ZXF1ZXN0LAorICAgIC5jYW5jZWxfcmVxdWVzdCA9IHVzYl9jZF9jYW5jZWxfcmVxdWVzdCwKKyAg
ICAudW5yZWFsaXplID0gdXNiX2NkX3VucmVhbGl6ZSwKK307CisKK3N0YXRpYyBVc2JDZCogdXNi
X2NkX2NyZWF0ZShTcGljZVVzYkJhY2tlbmQgKmJlLAorICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqcGFyZW50LAorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIHZvaWQgKm9wYXF1ZV9wYXJhbSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICBH
RXJyb3IgKiplcnIpCit7CisgICAgQ2RFbXVsYXRpb25QYXJhbXMgKnBhcmFtID0gb3BhcXVlX3Bh
cmFtOworICAgIGludCBlcnJvciA9IDAsIGk7CisgICAgdWludDMyX3QgdW5pdCA9IDA7CisgICAg
VXNiQ2QgKmQgPSBnX25ldzAoVXNiQ2QsIDEpOworICAgIENkU2NzaURldmljZVBhcmFtZXRlcnMg
ZGV2X3BhcmFtcyA9IHsgMCB9OworICAgIHVpbnQxNl90IGFkZHJlc3MgPSBzcGljZV91c2JfYmFj
a2VuZF9kZXZpY2VfZ2V0X2luZm8ocGFyZW50KS0+YWRkcmVzczsKKworICAgIGQtPmRldl9vcHMg
PSBkZXZvcHM7CisgICAgZC0+YmFja2VuZCA9IGJlOworICAgIGQtPnBhcmVudCAgPSBwYXJlbnQ7
CisgICAgZC0+ZGVsZXRlX29uX2VqZWN0ID0gISFwYXJhbS0+ZGVsZXRlX29uX2VqZWN0OworICAg
IGQtPmxvY2tlZCA9ICFkLT5kZWxldGVfb25fZWplY3Q7CisgICAgZC0+c2VyaWFsWzBdID0gMHgw
MzAwICsgc2l6ZW9mKGQtPnNlcmlhbCk7CisgICAgZC0+c2VyaWFsWzFdID0gJzAnICsgYWRkcmVz
cyAvIDEwOworICAgIGQtPnNlcmlhbFsyXSA9ICcwJyArIGFkZHJlc3MgJSAxMDsKKyAgICBmb3Ig
KGkgPSAzOyBpIDwgR19OX0VMRU1FTlRTKGQtPnNlcmlhbCk7ICsraSkgeworICAgICAgICBkLT5z
ZXJpYWxbaV0gPSAnMCc7CisgICAgfQorICAgIGQtPm1heF9sdW5faW5kZXggPSBNQVhfTFVOX1BF
Ul9ERVZJQ0UgLSAxOworCisgICAgZGV2X3BhcmFtcy52ZW5kb3IgPSAiUmVkIEhhdCI7CisgICAg
ZGV2X3BhcmFtcy5wcm9kdWN0ID0gIlNQSUNFIENEIjsKKyAgICBkZXZfcGFyYW1zLnZlcnNpb24g
PSAiMCI7CisKKyAgICBkLT5tc2MgPSBjZF91c2JfYnVsa19tc2RfYWxsb2MoZCwgTUFYX0xVTl9Q
RVJfREVWSUNFKTsKKyAgICBpZiAoIWQtPm1zYykgeworICAgICAgICBnX2NsZWFyX3BvaW50ZXIo
JmQsIGdfZnJlZSk7CisgICAgICAgIGdfc2V0X2Vycm9yKGVyciwgU1BJQ0VfQ0xJRU5UX0VSUk9S
LCBTUElDRV9DTElFTlRfRVJST1JfRkFJTEVELAorICAgICAgICAgICAgICAgICAgICBfKCJjYW4n
dCBhbGxvY2F0ZSBkZXZpY2UiKSk7CisgICAgICAgIHJldHVybiBOVUxMOworICAgIH0KKyAgICBk
LT51bml0c1t1bml0XS5ibG9ja1NpemUgPSBDRF9ERVZfQkxPQ0tfU0laRTsKKyAgICBpZiAoIWNk
X3VzYl9idWxrX21zZF9yZWFsaXplKGQtPm1zYywgdW5pdCwgJmRldl9wYXJhbXMpKSB7CisgICAg
ICAgIGlmIChvcGVuX3N0cmVhbSgmZC0+dW5pdHNbdW5pdF0sIHBhcmFtLT5maWxlbmFtZSkgJiYK
KyAgICAgICAgICAgIGxvYWRfbHVuKGQsIHVuaXQsIFRSVUUpKSB7CisgICAgICAgICAgICBpZiAo
ZC0+bG9ja2VkKSB7CisgICAgICAgICAgICAgICAgY2RfdXNiX2J1bGtfbXNkX2xvY2soZC0+bXNj
LCB1bml0LCBUUlVFKTsKKyAgICAgICAgICAgIH0KKyAgICAgICAgfSBlbHNlIHsKKyAgICAgICAg
ICAgIGNsb3NlX3N0cmVhbSgmZC0+dW5pdHNbdW5pdF0pOworICAgICAgICAgICAgY2RfdXNiX2J1
bGtfbXNkX3VucmVhbGl6ZShkLT5tc2MsIHVuaXQpOworICAgICAgICAgICAgZ19zZXRfZXJyb3Io
ZXJyLCBTUElDRV9DTElFTlRfRVJST1IsIFNQSUNFX0NMSUVOVF9FUlJPUl9GQUlMRUQsCisgICAg
ICAgICAgICAgICAgICAgICAgICBfKCJjYW4ndCBjcmVhdGUgZGV2aWNlIHdpdGggJXMiKSwKKyAg
ICAgICAgICAgICAgICAgICAgICAgIHBhcmFtLT5maWxlbmFtZSk7CisgICAgICAgICAgICBlcnJv
ciA9IDE7CisgICAgICAgIH0KKyAgICB9IGVsc2UgeworICAgICAgICBnX3NldF9lcnJvcihlcnIs
IFNQSUNFX0NMSUVOVF9FUlJPUiwgU1BJQ0VfQ0xJRU5UX0VSUk9SX0ZBSUxFRCwKKyAgICAgICAg
ICAgICAgICAgICAgXygiY2FuJ3QgYWxsb2NhdGUgZGV2aWNlIikpOworICAgICAgICBlcnJvciA9
IDE7CisgICAgfQorICAgIGlmIChlcnJvcikgeworICAgICAgICBnX2NsZWFyX3BvaW50ZXIoJmQt
Pm1zYywgY2RfdXNiX2J1bGtfbXNkX2ZyZWUpOworICAgICAgICBnX2NsZWFyX3BvaW50ZXIoJmQs
IGdfZnJlZSk7CisgICAgICAgIHJldHVybiBOVUxMOworICAgIH0KKworICAgIHJldHVybiBkOwor
fQorCitnYm9vbGVhbgorY3JlYXRlX2VtdWxhdGVkX2NkKFNwaWNlVXNiQmFja2VuZCAqYmUsCisg
ICAgICAgICAgICAgICAgICAgQ2RFbXVsYXRpb25QYXJhbXMgKnBhcmFtLAorICAgICAgICAgICAg
ICAgICAgIEdFcnJvciAqKmVycikKK3sKKyAgICByZXR1cm4gc3BpY2VfdXNiX2JhY2tlbmRfY3Jl
YXRlX2VtdWxhdGVkX2RldmljZShiZSwgdXNiX2NkX2NyZWF0ZSwgcGFyYW0sIGVycik7Cit9CisK
KyNlbmRpZiAvKiBVU0VfVVNCUkVESVIgKi8KZGlmZiAtLWdpdCBhL3NyYy91c2ItZGV2aWNlLWNk
LmggYi9zcmMvdXNiLWRldmljZS1jZC5oCm5ldyBmaWxlIG1vZGUgMTAwNjQ0CmluZGV4IDAwMDAw
MDAuLmU5ODUyNDIKLS0tIC9kZXYvbnVsbAorKysgYi9zcmMvdXNiLWRldmljZS1jZC5oCkBAIC0w
LDAgKzEsMzQgQEAKKy8qIC0qLSBNb2RlOiBDOyBjLWJhc2ljLW9mZnNldDogNDsgaW5kZW50LXRh
YnMtbW9kZTogbmlsIC0qLSAqLworLyoKKyAgICBDb3B5cmlnaHQgKEMpIDIwMTkgUmVkIEhhdCwg
SW5jLgorCisgICAgUmVkIEhhdCBBdXRob3JzOgorICAgIFl1cmkgQmVuZGl0b3ZpY2g8eWJlbmRp
dG9AcmVkaGF0LmNvbT4KKworICAgIFRoaXMgbGlicmFyeSBpcyBmcmVlIHNvZnR3YXJlOyB5b3Ug
Y2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IKKyAgICBtb2RpZnkgaXQgdW5kZXIgdGhlIHRlcm1z
IG9mIHRoZSBHTlUgTGVzc2VyIEdlbmVyYWwgUHVibGljCisgICAgTGljZW5zZSBhcyBwdWJsaXNo
ZWQgYnkgdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbjsgZWl0aGVyCisgICAgdmVyc2lvbiAy
LjEgb2YgdGhlIExpY2Vuc2UsIG9yIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24u
CisKKyAgICBUaGlzIGxpYnJhcnkgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3
aWxsIGJlIHVzZWZ1bCwKKyAgICBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZl
biB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgorICAgIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNT
IEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGUgR05VCisgICAgTGVzc2VyIEdlbmVy
YWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KKworICAgIFlvdSBzaG91bGQgaGF2
ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBMZXNzZXIgR2VuZXJhbCBQdWJsaWMKKyAgICBM
aWNlbnNlIGFsb25nIHdpdGggdGhpcyBsaWJyYXJ5OyBpZiBub3QsIHNlZSA8aHR0cDovL3d3dy5n
bnUub3JnL2xpY2Vuc2VzLz4uCisqLworCisjcHJhZ21hIG9uY2UKKworI2luY2x1ZGUgInVzYi1i
YWNrZW5kLmgiCisKK3R5cGVkZWYgc3RydWN0IENkRW11bGF0aW9uUGFyYW1zIHsKKyAgICBjb25z
dCBjaGFyICpmaWxlbmFtZTsKKyAgICB1aW50MzJfdCBkZWxldGVfb25fZWplY3QgOiAxOworfSBD
ZEVtdWxhdGlvblBhcmFtczsKKworZ2Jvb2xlYW4KK2NyZWF0ZV9lbXVsYXRlZF9jZChTcGljZVVz
YkJhY2tlbmQgKmJlLAorICAgICAgICAgICAgICAgICAgIENkRW11bGF0aW9uUGFyYW1zICpwYXJh
bSwKKyAgICAgICAgICAgICAgICAgICBHRXJyb3IgKiplcnIpOwotLSAKMi4yMS4wCgpfX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpTcGljZS1kZXZlbCBtYWls
aW5nIGxpc3QKU3BpY2UtZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMu
ZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vc3BpY2UtZGV2ZWw=
