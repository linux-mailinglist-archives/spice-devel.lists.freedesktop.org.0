Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id A92CD6B46D
	for <lists+spice-devel@lfdr.de>; Wed, 17 Jul 2019 04:16:34 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 14F756E219;
	Wed, 17 Jul 2019 02:16:33 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mail.codeweavers.com (mail.codeweavers.com [50.203.203.244])
 by gabe.freedesktop.org (Postfix) with ESMTPS id DA71D6E219
 for <spice-devel@lists.freedesktop.org>; Wed, 17 Jul 2019 02:16:31 +0000 (UTC)
Received: from cpe-107-184-2-226.socal.res.rr.com ([107.184.2.226]
 helo=brendan-dell.bslabs.net)
 by mail.codeweavers.com with esmtpsa (TLS1.2:ECDHE_RSA_AES_128_GCM_SHA256:128)
 (Exim 4.89) (envelope-from <bshanks@codeweavers.com>)
 id 1hnZUz-0006Ub-SS; Tue, 16 Jul 2019 21:16:55 -0500
From: Brendan Shanks <bshanks@codeweavers.com>
To: spice-devel@lists.freedesktop.org
Date: Tue, 16 Jul 2019 19:16:06 -0700
Message-Id: <20190717021606.2737-4-bshanks@codeweavers.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190717021606.2737-1-bshanks@codeweavers.com>
References: <20190711200305.4616-1-bshanks@codeweavers.com>
 <20190717021606.2737-1-bshanks@codeweavers.com>
X-Spam-Score: -106.0
X-Spam-Report: Spam detection software,
 running on the system "mail.codeweavers.com", 
 has NOT identified this incoming email as spam.  The original
 message has been attached to this so you can view it or label
 similar future email.  If you have any questions, see
 the administrator of that system for details.
 Content preview: Add a cache to allow the reuse of SHM segments. Shared memory
 segments are added to the cache instead of being deallocated, and the cache
 is searched instead of/before allocating a new segment. Both the SHM segments
 and their attachment with the X server are cached. 
 Content analysis details:   (-106.0 points, 5.0 required)
 pts rule name              description
 ---- ---------------------- --------------------------------------------------
 -100 USER_IN_WHITELIST      From: address is in the user's white-list
 -6.0 ALL_TRUSTED            Passed through trusted hosts only via SMTP
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt;
 c=relaxed/relaxed; 
 d=codeweavers.com; s=6377696661; h=References:In-Reply-To:Message-Id:Date:
 Subject:Cc:To:From:Sender:Reply-To:MIME-Version:Content-Type:
 Content-Transfer-Encoding:Content-ID:Content-Description:Resent-Date:
 Resent-From:Resent-Sender:Resent-To:Resent-Cc:Resent-Message-ID:List-Id:
 List-Help:List-Unsubscribe:List-Subscribe:List-Post:List-Owner:List-Archive;
 bh=TSlOTTxDcNquncicUvIltMF0Gp1pMmN7zyqfuyPR7hc=; b=CVGUyiQX3SDH+eP6JBZzgDAVe
 R2LAfnCYgkPHd9YqQAr9FTQ+YiWGhJ7Z/JjiXv9UsEYAc7g/uaKIXzW8PECN+yc2VO2/W3AdntBqi
 4eNA/jBgf3zhU+3Icu+hBC1vgSgDLCRR/eO/hNKugXTmrIMkDX9pNFtdnfV5KL2Yt2FiU=;
Subject: [Spice-devel] [PATCH x11spice v2 3/3] Add cache for SHM segments
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

QWRkIGEgY2FjaGUgdG8gYWxsb3cgdGhlIHJldXNlIG9mIFNITSBzZWdtZW50cy4KU2hhcmVkIG1l
bW9yeSBzZWdtZW50cyBhcmUgYWRkZWQgdG8gdGhlIGNhY2hlIGluc3RlYWQgb2YgYmVpbmcKZGVh
bGxvY2F0ZWQsIGFuZCB0aGUgY2FjaGUgaXMgc2VhcmNoZWQgaW5zdGVhZCBvZi9iZWZvcmUgYWxs
b2NhdGluZyBhCm5ldyBzZWdtZW50LgoKQm90aCB0aGUgU0hNIHNlZ21lbnRzIGFuZCB0aGVpciBh
dHRhY2htZW50IHdpdGggdGhlIFggc2VydmVyIGFyZSBjYWNoZWQuCgpUaGUgY2FjaGUgY3VycmVu
dGx5IGhhcyBhIGZpeGVkIG51bWJlciBvZiAxMCBlbnRyaWVzLCB0aGlzIHByb3ZpZGVkIGEKZ29v
ZCBjYWNoZSBoaXQgcmF0ZSB3aGlsZSBrZWVwaW5nIG1lbW9yeSB1c2FnZSB1bmRlciBjb250cm9s
LgpCdWlsZGluZyB3aXRoIERFQlVHX1NITV9DQUNIRSBkZWZpbmVkIGFuZCBydW5uaW5nIHdpdGgK
R19NRVNTQUdFU19ERUJVRz1hbGwgd2lsbCBwZXJpb2RpY2FsbHkgcHJpbnQgb3V0IHRoZSBTSE0g
Y2FjaGUgaGl0CnJhdGUuCgpPbiBteSBVYnVudHUgMTguMDQgc3lzdGVtIHJ1bm5pbmcgWEZDRTQg
d2l0aCBhIDI1NjB4MTQ0MCBzY3JlZW4sIHRoZQpjYWNoZSBoaXQgcmF0ZSBzdGFydHMgYXJvdW5k
IDcyJS4gT24tc2NyZWVuIHdpbmRvd3MgdGhhdCB1cGRhdGUgb2Z0ZW4KYW5kIGhhdmUgY29uc2lz
dGVudGx5LXNpemVkIGRhbWFnZSByZWN0YW5nbGVzIGFyZSB0aGUgYmVzdCBjYXNlLiBXaXRoCnNl
dmVyYWwgb2YgdGhvc2UgKHNjcm9sbGluZyB0ZXJtaW5hbCB3aW5kb3dzLCB3ZWIgYnJvd3NlciBz
aG93aW5nIGEKV2ViR0wgZGVtbyksIHRoZSBoaXQgcmF0ZSBzbG93bHkgcmlzZXMgdG8gYXJvdW5k
IDkyJS4KT3BlcmF0aW9ucyB0aGF0IGdlbmVyYXRlIHJhcGlkIGRhbWFnZSByZXBvcnRzIChsaWtl
IHJlc2l6aW5nIG9yIG1vdmluZwp3aW5kb3dzKSB3aWxsIGxvd2VyIHRoZSBoaXQgcmF0ZS4KClNp
Z25lZC1vZmYtYnk6IEJyZW5kYW4gU2hhbmtzIDxic2hhbmtzQGNvZGV3ZWF2ZXJzLmNvbT4KLS0t
CiBzcmMvZGlzcGxheS5jIHwgMTc3ICsrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrKysrKystLS0tCiBzcmMvZGlzcGxheS5oIHwgICA3ICstCiAyIGZpbGVzIGNoYW5nZWQs
IDE2OSBpbnNlcnRpb25zKCspLCAxNSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9zcmMvZGlz
cGxheS5jIGIvc3JjL2Rpc3BsYXkuYwppbmRleCA5NGYxOTJjLi4xNjY4ZDhhIDEwMDY0NAotLS0g
YS9zcmMvZGlzcGxheS5jCisrKyBiL3NyYy9kaXNwbGF5LmMKQEAgLTIxMywxMSArMjEzLDE1NyBA
QCBzdGF0aWMgaW50IHJlZ2lzdGVyX2Zvcl9ldmVudHMoZGlzcGxheV90ICpkKQogICAgIHJldHVy
biAwOwogfQogCitzdGF0aWMgdm9pZCBzaG1fc2VnbWVudF9kZXN0cm95KGRpc3BsYXlfdCAqZCwg
c2htX3NlZ21lbnRfdCAqc2VnbWVudCkKK3sKKyAgICBpZiAoc2VnbWVudC0+c2htaWQgPT0gLTEp
IHsKKyAgICAgICAgcmV0dXJuOworICAgIH0KKworICAgIHhjYl9zaG1fZGV0YWNoKGQtPmMsIHNl
Z21lbnQtPnNobXNlZyk7CisgICAgc2VnbWVudC0+c2htc2VnID0gLTE7CisKKyAgICBzaG1kdChz
ZWdtZW50LT5zaG1hZGRyKTsKKyAgICBzZWdtZW50LT5zaG1hZGRyID0gTlVMTDsKKworICAgIHNo
bWN0bChzZWdtZW50LT5zaG1pZCwgSVBDX1JNSUQsIE5VTEwpOworICAgIHNlZ21lbnQtPnNobWlk
ID0gLTE7Cit9CisKKworc3RhdGljIGludCBzaG1fY2FjaGVfZ2V0KGRpc3BsYXlfdCAqZCwgc2l6
ZV90IHNpemUsIHNobV9zZWdtZW50X3QgKnNlZ21lbnQpCit7CisgICAgaW50IGksIHJldDsKKyAg
ICBzaG1fc2VnbWVudF90ICpiaWdnZXJfZW50cnkgPSBOVUxMOworICAgIHNobV9zZWdtZW50X3Qg
KmVudHJ5X3RvX3VzZSA9IE5VTEw7CisKKyNpZiBkZWZpbmVkKERFQlVHX1NITV9DQUNIRSkKKyAg
ICBzdGF0aWMgZ3VpbnQgY2FjaGVfaGl0cyA9IDA7CisgICAgc3RhdGljIGd1aW50IGNhY2hlX3Rv
dGFsID0gMDsKKworICAgIGNhY2hlX3RvdGFsKys7CisjZW5kaWYKKworICAgIGdfbXV0ZXhfbG9j
aygmZC0+c2htX2NhY2hlX211dGV4KTsKKworICAgIC8qIENoZWNrIHRoZSBjYWNoZSBmb3IgYSBz
ZWdtZW50IG9mIHNpemUgJ3NpemUnIG9yIGJpZ2dlci4KKyAgICAgKiBVc2UgYW4gZXhhY3Qtc2l6
ZSBzZWdtZW50IGlmIGZvdW5kLgorICAgICAqIElmIG5vdCwgdXNlIHRoZSBzbWFsbGVzdCBlbnRy
eSB0aGF0IGlzIGJpZyBlbm91Z2guCisgICAgICovCisgICAgZm9yIChpID0gMDsgaSA8IEdfTl9F
TEVNRU5UUyhkLT5zaG1fY2FjaGUpOyBpKyspIHsKKyAgICAgICAgc2htX3NlZ21lbnRfdCAqZW50
cnkgPSAmZC0+c2htX2NhY2hlW2ldOworCisgICAgICAgIGlmIChlbnRyeS0+c2htaWQgIT0gLTEp
IHsKKyAgICAgICAgICAgIC8qIElmIGEgY2FjaGUgZW50cnkgb2YgdGhlIGV4YWN0IHNpemUgYmVp
bmcgcmVxdWVzdGVkIGlzIGZvdW5kLCB1c2UgdGhhdCAqLworICAgICAgICAgICAgaWYgKHNpemUg
PT0gZW50cnktPnNpemUpIHsKKyAgICAgICAgICAgICAgICBlbnRyeV90b191c2UgPSBlbnRyeTsK
KyAgICAgICAgICAgICAgICBicmVhazsKKyAgICAgICAgICAgIH0KKworICAgICAgICAgICAgLyog
S2VlcCB0cmFjayBvZiB0aGUgbmV4dC1iaWdnZXN0IGVudHJ5IGluIGNhc2UgYW4gZXhhY3Qtc2l6
ZSBtYXRjaCBpc24ndCBmb3VuZCAqLworICAgICAgICAgICAgaWYgKHNpemUgPCBlbnRyeS0+c2l6
ZSkgeworICAgICAgICAgICAgICAgIGlmIChiaWdnZXJfZW50cnkgJiYgZW50cnktPnNpemUgPCBi
aWdnZXJfZW50cnktPnNpemUpIHsKKyAgICAgICAgICAgICAgICAgICAgYmlnZ2VyX2VudHJ5ID0g
ZW50cnk7CisgICAgICAgICAgICAgICAgfSBlbHNlIHsKKyAgICAgICAgICAgICAgICAgICAgYmln
Z2VyX2VudHJ5ID0gZW50cnk7CisgICAgICAgICAgICAgICAgfQorICAgICAgICAgICAgfQorICAg
ICAgICB9CisgICAgfQorCisgICAgLyogQW4gZXhhY3Qtc2l6ZSBlbnRyeSB3YXNuJ3QgZm91bmQs
IHVzZSB0aGUgbmV4dCBiaWdnZXN0IGVudHJ5IHRoYXQgd2FzIGZvdW5kICovCisgICAgaWYgKCFl
bnRyeV90b191c2UpIHsKKyAgICAgICAgZW50cnlfdG9fdXNlID0gYmlnZ2VyX2VudHJ5OworICAg
IH0KKworICAgIGlmIChlbnRyeV90b191c2UpIHsKKyAgICAgICAgKnNlZ21lbnQgPSAqZW50cnlf
dG9fdXNlOworICAgICAgICBlbnRyeV90b191c2UtPnNobWlkID0gLTE7CisKKyAgICAgICAgcmV0
ID0gMTsKKworI2lmIGRlZmluZWQoREVCVUdfU0hNX0NBQ0hFKQorICAgICAgICBjYWNoZV9oaXRz
Kys7CisgICAgICAgIGlmICgoY2FjaGVfaGl0cyAlIDEwMCA9PSAwKSkgeworICAgICAgICAgICAg
Z19kZWJ1ZygiU0hNIGNhY2hlIGhpdHJhdGU6ICV1LyV1ICglLjJmJSUpIiwgY2FjaGVfaGl0cywg
Y2FjaGVfdG90YWwsCisgICAgICAgICAgICAgICAgICAgIChmbG9hdCkgKChmbG9hdCkgY2FjaGVf
aGl0cyAvIChmbG9hdCkgY2FjaGVfdG90YWwpICogMTAwKTsKKyAgICAgICAgfQorI2VuZGlmCisg
ICAgfSBlbHNlIHsKKyAgICAgICAgLyogTm8gdXNhYmxlIGVudHJ5IGZvdW5kIGluIHRoZSBjYWNo
ZSAqLworICAgICAgICByZXQgPSAwOworICAgIH0KKworICAgIGdfbXV0ZXhfdW5sb2NrKCZkLT5z
aG1fY2FjaGVfbXV0ZXgpOworICAgIHJldHVybiByZXQ7Cit9CisKK3N0YXRpYyBpbnQgc2htX2Nh
Y2hlX2FkZChkaXNwbGF5X3QgKmQsIHNobV9zZWdtZW50X3QgKnNlZ21lbnQpCit7CisgICAgaW50
IGksIHJldDsKKyAgICBzaG1fc2VnbWVudF90ICpzbWFsbGVzdF9lbnRyeSA9IE5VTEw7CisgICAg
c2htX3NlZ21lbnRfdCAqZW50cnlfdG9fdXNlID0gTlVMTDsKKworICAgIGdfbXV0ZXhfbG9jaygm
ZC0+c2htX2NhY2hlX211dGV4KTsKKworICAgIC8qICdzZWdtZW50JyBpcyBub3cgdW51c2VkLCB0
cnkgdG8gYWRkIGl0IHRvIHRoZSBjYWNoZS4KKyAgICAgKiBVc2UgYW4gZW1wdHkgc2xvdCBpbiB0
aGUgY2FjaGUgaWYgYXZhaWxhYmxlLgorICAgICAqIElmIG5vdCwgZXZpY3QgdGhlIHNtYWxsZXN0
IGVudHJ5ICh3aGljaCBhbHNvIG11c3QgYmUgc21hbGxlciB0aGFuICdzZWdtZW50JykgZnJvbSB0
aGUgY2FjaGUuCisgICAgICovCisgICAgZm9yIChpID0gMDsgaSA8IEdfTl9FTEVNRU5UUyhkLT5z
aG1fY2FjaGUpOyBpKyspIHsKKyAgICAgICAgc2htX3NlZ21lbnRfdCAqZW50cnkgPSAmZC0+c2ht
X2NhY2hlW2ldOworCisgICAgICAgIGlmIChlbnRyeS0+c2htaWQgPT0gLTEpIHsKKyAgICAgICAg
ICAgIC8qIFVzZSBhbiBlbXB0eSBzbG90IGlmIGZvdW5kICovCisgICAgICAgICAgICBlbnRyeV90
b191c2UgPSBlbnRyeTsKKyAgICAgICAgICAgIGJyZWFrOworICAgICAgICB9CisKKyAgICAgICAg
LyogS2VlcCB0cmFjayBvZiB0aGUgc21hbGxlc3QgZW50cnkgdGhhdCdzIHNtYWxsZXIgdGhhbiAn
c2VnbWVudCcgKi8KKyAgICAgICAgaWYgKGVudHJ5LT5zaXplIDwgc2VnbWVudC0+c2l6ZSkgewor
ICAgICAgICAgICAgaWYgKHNtYWxsZXN0X2VudHJ5ICYmIGVudHJ5LT5zaXplIDwgc21hbGxlc3Rf
ZW50cnktPnNpemUpIHsKKyAgICAgICAgICAgICAgICBzbWFsbGVzdF9lbnRyeSA9IGVudHJ5Owor
ICAgICAgICAgICAgfSBlbHNlIGlmICghc21hbGxlc3RfZW50cnkpIHsKKyAgICAgICAgICAgICAg
ICBzbWFsbGVzdF9lbnRyeSA9IGVudHJ5OworICAgICAgICAgICAgfQorICAgICAgICB9CisgICAg
fQorCisgICAgLyogSWYgbm8gZW1wdHkgZW50cmllcyB3ZXJlIGZvdW5kLCBldmljdCAnc21hbGxl
c3RfZW50cnknIGFuZCByZXVzZSBpdCAqLworICAgIGlmICghZW50cnlfdG9fdXNlICYmIHNtYWxs
ZXN0X2VudHJ5KSB7CisgICAgICAgIHNobV9zZWdtZW50X2Rlc3Ryb3koZCwgc21hbGxlc3RfZW50
cnkpOworICAgICAgICBlbnRyeV90b191c2UgPSBzbWFsbGVzdF9lbnRyeTsKKyAgICB9CisKKyAg
ICBpZiAoZW50cnlfdG9fdXNlKSB7CisgICAgICAgICplbnRyeV90b191c2UgPSAqc2VnbWVudDsK
KyAgICAgICAgcmV0ID0gMTsKKyAgICB9IGVsc2UgeworICAgICAgICAvKiBDYWNoZSBpcyBmdWxs
LCBhbmQgY29udGFpbmVkIG5vIGVudHJpZXMgc21hbGxlciB0aGFuIHRoZSBvbmUgYmVpbmcgYWRk
ZWQgKi8KKyAgICAgICAgcmV0ID0gMDsKKyAgICB9CisKKyAgICBnX211dGV4X3VubG9jaygmZC0+
c2htX2NhY2hlX211dGV4KTsKKyAgICByZXR1cm4gcmV0OworfQorCitzdGF0aWMgdm9pZCBzaG1f
Y2FjaGVfZGVzdHJveShkaXNwbGF5X3QgKmQpCit7CisgICAgaW50IGk7CisKKyAgICBnX211dGV4
X2xvY2soJmQtPnNobV9jYWNoZV9tdXRleCk7CisgICAgZm9yIChpID0gMDsgaSA8IEdfTl9FTEVN
RU5UUyhkLT5zaG1fY2FjaGUpOyBpKyspIHsKKyAgICAgICAgc2htX3NlZ21lbnRfdCAqZW50cnkg
PSAmZC0+c2htX2NhY2hlW2ldOworCisgICAgICAgIHNobV9zZWdtZW50X2Rlc3Ryb3koZCwgZW50
cnkpOworICAgIH0KKyAgICBnX211dGV4X3VubG9jaygmZC0+c2htX2NhY2hlX211dGV4KTsKK30K
IAogaW50IGRpc3BsYXlfb3BlbihkaXNwbGF5X3QgKmQsIHNlc3Npb25fdCAqc2Vzc2lvbikKIHsK
ICAgICBpbnQgc2NyOwogICAgIGludCByYzsKKyAgICBpbnQgaTsKICAgICB4Y2JfZGFtYWdlX3F1
ZXJ5X3ZlcnNpb25fY29va2llX3QgZGNvb2tpZTsKICAgICB4Y2JfZGFtYWdlX3F1ZXJ5X3ZlcnNp
b25fcmVwbHlfdCAqZGFtYWdlX3ZlcnNpb247CiAgICAgeGNiX3hrYl91c2VfZXh0ZW5zaW9uX2Nv
b2tpZV90IHVzZV9jb29raWU7CkBAIC0zMTQsNiArNDYwLDExIEBAIGludCBkaXNwbGF5X29wZW4o
ZGlzcGxheV90ICpkLCBzZXNzaW9uX3QgKnNlc3Npb24pCiAgICAgaWYgKHJjKQogICAgICAgICBy
ZXR1cm4gcmM7CiAKKyAgICBnX211dGV4X2luaXQoJmQtPnNobV9jYWNoZV9tdXRleCk7CisgICAg
Zm9yIChpID0gMDsgaSA8IEdfTl9FTEVNRU5UUyhkLT5zaG1fY2FjaGUpOyBpKyspIHsKKyAgICAg
ICAgZC0+c2htX2NhY2hlW2ldLnNobWlkID0gLTE7CisgICAgfQorCiAgICAgcmMgPSBkaXNwbGF5
X2NyZWF0ZV9zY3JlZW5faW1hZ2VzKGQpOwogCiAgICAgZ19tZXNzYWdlKCJEaXNwbGF5ICVzIG9w
ZW5lZCIsIHNlc3Npb24tPm9wdGlvbnMuZGlzcGxheSA/IHNlc3Npb24tPm9wdGlvbnMuZGlzcGxh
eSA6ICIiKTsKQEAgLTMyMSwxNyArNDcyLDYgQEAgaW50IGRpc3BsYXlfb3BlbihkaXNwbGF5X3Qg
KmQsIHNlc3Npb25fdCAqc2Vzc2lvbikKICAgICByZXR1cm4gcmM7CiB9CiAKLS8qIAotICBUT0RP
OiBJbXBsZW1lbnQgYSBjYWNoZSBmb3Igc2hhcmVkIG1lbW9yeSBoYW5kbGVzCi0gICAgICAgIFRo
YXQgaXMsIGluc3RlYWQgb2YgZG9pbmcgdGhlIHNobWdldC9zaG1hdCBmb3IgZXZlcnkgcmVhZCwK
LSAgICAgICAgd2Ugc2hvdWxkIGNhY2hlIHRoZSBzaG1pZCwgYW5kIHJldXNlIGlmIHdlJ3JlIGRv
aW5nIGEgbGF0ZXIKLSAgICAgICAgcmVhZCBvZiBhIHNpbWlsYXIgc2l6ZS4KLQotICAgICAgICBX
ZSB3b3VsZCBsaWtlbHkgc2VlIGEgNDAlIGltcHJvdmVtZW50IGluIHJhdyByZWFkIHRpbWUuICBO
b3RlCi0gICAgICAgIHRoYXQgYSBjYWxsZ3JpbmQgcnVuIHN1Z2dlc3RlZCB0aGF0IHdvdWxkIGJl
IG9uIHRoZSBvcmRlciBvZiA1JQotICAgICAgICBvdmVyYWxsLgotKi8KLQogc2htX2ltYWdlX3Qg
KmNyZWF0ZV9zaG1faW1hZ2UoZGlzcGxheV90ICpkLCB1bnNpZ25lZCBpbnQgdywgdW5zaWduZWQg
aW50IGgpCiB7CiAgICAgc2htX2ltYWdlX3QgKnNobWk7CkBAIC0zNDksNiArNDg5LDExIEBAIHNo
bV9pbWFnZV90ICpjcmVhdGVfc2htX2ltYWdlKGRpc3BsYXlfdCAqZCwgdW5zaWduZWQgaW50IHcs
IHVuc2lnbmVkIGludCBoKQogICAgIHNobWktPmJ5dGVzX3Blcl9saW5lID0gKGJpdHNfcGVyX3Bp
eGVsKGQpIC8gOCkgKiBzaG1pLT53OwogICAgIGltZ3NpemUgPSBzaG1pLT5ieXRlc19wZXJfbGlu
ZSAqIHNobWktPmg7CiAKKyAgICBpZiAoc2htX2NhY2hlX2dldChkLCBpbWdzaXplLCAmc2htaS0+
c2VnbWVudCkpIHsKKyAgICAgICAgcmV0dXJuIHNobWk7CisgICAgfQorCisgICAgLyogTm8gdXNh
YmxlIHNoYXJlZCBtZW1vcnkgc2VnbWVudCBmb3VuZCBpbiBjYWNoZSwgYWxsb2NhdGUgYSBuZXcg
b25lICovCiAgICAgc2htaS0+c2VnbWVudC5zaG1pZCA9IHNobWdldChJUENfUFJJVkFURSwgaW1n
c2l6ZSwgSVBDX0NSRUFUIHwgMDcwMCk7CiAgICAgaWYgKHNobWktPnNlZ21lbnQuc2htaWQgIT0g
LTEpCiAgICAgICAgIHNobWktPnNlZ21lbnQuc2htYWRkciA9IHNobWF0KHNobWktPnNlZ21lbnQu
c2htaWQsIDAsIDApOwpAQCAtMzYwLDYgKzUwNSw3IEBAIHNobV9pbWFnZV90ICpjcmVhdGVfc2ht
X2ltYWdlKGRpc3BsYXlfdCAqZCwgdW5zaWduZWQgaW50IHcsIHVuc2lnbmVkIGludCBoKQogICAg
IC8qIFdlIHRlbGwgc2htY3RsIHRvIGRldGFjaCBub3c7IHRoYXQgcHJldmVudHMgdXMgZnJvbSBo
b2xkaW5nIHRoaXMKICAgICAgICBzaGFyZWQgbWVtb3J5IHNlZ21lbnQgZm9yZXZlciBpbiBjYXNl
IG9mIGFibm9ybWFsIHByb2Nlc3MgZXhpdC4gKi8KICAgICBzaG1jdGwoc2htaS0+c2VnbWVudC5z
aG1pZCwgSVBDX1JNSUQsIE5VTEwpOworICAgIHNobWktPnNlZ21lbnQuc2l6ZSA9IGltZ3NpemU7
CiAKICAgICBzaG1pLT5zZWdtZW50LnNobXNlZyA9IHhjYl9nZW5lcmF0ZV9pZChkLT5jKTsKICAg
ICBjb29raWUgPSB4Y2Jfc2htX2F0dGFjaF9jaGVja2VkKGQtPmMsIHNobWktPnNlZ21lbnQuc2ht
c2VnLCBzaG1pLT5zZWdtZW50LnNobWlkLCAwKTsKQEAgLTQ1MSw5ICs1OTcsMTAgQEAgdm9pZCBk
aXNwbGF5X2NvcHlfaW1hZ2VfaW50b19mdWxsc2NyZWVuKGRpc3BsYXlfdCAqZCwgc2htX2ltYWdl
X3QgKnNobWksIGludCB4LAogCiB2b2lkIGRlc3Ryb3lfc2htX2ltYWdlKGRpc3BsYXlfdCAqZCwg
c2htX2ltYWdlX3QgKnNobWkpCiB7Ci0gICAgeGNiX3NobV9kZXRhY2goZC0+Yywgc2htaS0+c2Vn
bWVudC5zaG1zZWcpOwotICAgIHNobWR0KHNobWktPnNlZ21lbnQuc2htYWRkcik7Ci0gICAgc2ht
Y3RsKHNobWktPnNlZ21lbnQuc2htaWQsIElQQ19STUlELCBOVUxMKTsKKyAgICBpZiAoIXNobV9j
YWNoZV9hZGQoZCwgJnNobWktPnNlZ21lbnQpKSB7CisgICAgICAgIC8qIENvdWxkIG5vdCBhZGQg
dG8gY2FjaGUsIGRlc3Ryb3kgdGhpcyBzZWdtZW50ICovCisgICAgICAgIHNobV9zZWdtZW50X2Rl
c3Ryb3koZCwgJnNobWktPnNlZ21lbnQpOworICAgIH0KICAgICBpZiAoc2htaS0+ZHJhd2FibGVf
cHRyKQogICAgICAgICBmcmVlKHNobWktPmRyYXdhYmxlX3B0cik7CiAgICAgZnJlZShzaG1pKTsK
QEAgLTUwMyw2ICs2NTAsOCBAQCB2b2lkIGRpc3BsYXlfc3RvcF9ldmVudF90aHJlYWQoZGlzcGxh
eV90ICpkKQogCiB2b2lkIGRpc3BsYXlfY2xvc2UoZGlzcGxheV90ICpkKQogeworICAgIHNobV9j
YWNoZV9kZXN0cm95KGQpOworICAgIGdfbXV0ZXhfY2xlYXIoJmQtPnNobV9jYWNoZV9tdXRleCk7
CiAgICAgeGNiX2RhbWFnZV9kZXN0cm95KGQtPmMsIGQtPmRhbWFnZSk7CiAgICAgZGlzcGxheV9k
ZXN0cm95X3NjcmVlbl9pbWFnZXMoZCk7CiAgICAgeGNiX2Rpc2Nvbm5lY3QoZC0+Yyk7CmRpZmYg
LS1naXQgYS9zcmMvZGlzcGxheS5oIGIvc3JjL2Rpc3BsYXkuaAppbmRleCAwODA5NDQxLi5iYmZm
MDBmIDEwMDY0NAotLS0gYS9zcmMvZGlzcGxheS5oCisrKyBiL3NyYy9kaXNwbGF5LmgKQEAgLTIx
LDYgKzIxLDcgQEAKICNpZm5kZWYgRElTUExBWV9IXwogI2RlZmluZSBESVNQTEFZX0hfCiAKKyNp
bmNsdWRlIDxnbGliLmg+CiAjaW5jbHVkZSA8eGNiL3hjYi5oPgogI2luY2x1ZGUgPHhjYi9kYW1h
Z2UuaD4KICNpbmNsdWRlIDx4Y2Ivc2htLmg+CkBAIC0zMiw3ICszMyw4IEBAIHN0cnVjdCBzZXNz
aW9uX3N0cnVjdDsKICoqICBTdHJ1Y3R1cmUgZGVmaW5pdGlvbnMKICoqLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0qLwogdHlwZWRlZiBzdHJ1Y3QgewotICAgIGludCBzaG1pZDsKKyAgICBpbnQgc2htaWQ7ICAg
ICAgLyogaWYgc2htaWQgaXMgLTE6IHRoZSBzaG1fc2VnbWVudF90IGlzICJlbXB0eSIsIG90aGVy
IG1lbWJlcnMgYXJlIHVuZGVmaW5lZCAqLworICAgIHNpemVfdCBzaXplOwogICAgIHhjYl9zaG1f
c2VnX3Qgc2htc2VnOwogICAgIHZvaWQgKnNobWFkZHI7CiB9IHNobV9zZWdtZW50X3Q7CkBAIC02
Miw2ICs2NCw5IEBAIHR5cGVkZWYgc3RydWN0IHsKICAgICBzaG1faW1hZ2VfdCAqZnVsbHNjcmVl
bjsKICAgICBzaG1faW1hZ2VfdCAqc2NhbmxpbmU7CiAKKyAgICBzaG1fc2VnbWVudF90IHNobV9j
YWNoZVsxMF07CisgICAgR011dGV4IHNobV9jYWNoZV9tdXRleDsKKwogICAgIHB0aHJlYWRfdCBl
dmVudF90aHJlYWQ7CiAgICAgc3RydWN0IHNlc3Npb25fc3RydWN0ICpzZXNzaW9uOwogfSBkaXNw
bGF5X3Q7Ci0tIAoyLjE3LjEKCl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fClNwaWNlLWRldmVsIG1haWxpbmcgbGlzdApTcGljZS1kZXZlbEBsaXN0cy5mcmVl
ZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5m
by9zcGljZS1kZXZlbA==
