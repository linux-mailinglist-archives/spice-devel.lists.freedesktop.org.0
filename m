Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 2C44072B5E
	for <lists+spice-devel@lfdr.de>; Wed, 24 Jul 2019 11:28:32 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id BFF3F6E4CD;
	Wed, 24 Jul 2019 09:28:30 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id C92F96E4CD
 for <spice-devel@lists.freedesktop.org>; Wed, 24 Jul 2019 09:28:29 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx06.intmail.prod.int.phx2.redhat.com
 [10.5.11.16])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 738B930BA077
 for <spice-devel@lists.freedesktop.org>; Wed, 24 Jul 2019 09:28:29 +0000 (UTC)
Received: from fziglio.remote.csb (unknown [10.33.32.9])
 by smtp.corp.redhat.com (Postfix) with ESMTP id 535415C28C;
 Wed, 24 Jul 2019 09:28:28 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Wed, 24 Jul 2019 10:28:23 +0100
Message-Id: <20190724092823.12551-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.16
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.46]); Wed, 24 Jul 2019 09:28:29 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-server v2] event loop: improve
 implementation of watches for Unix systems
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

QXZvaWQgaGF2aW5nIHRvIGRlc3Ryb3kgYW5kIGNyZWF0ZSBhIG5ldyBHU291cmNlIGV2ZXJ5IHRp
bWUKd2UgY2hhbmdlIGV2ZW50IG1hc2suCkludGVyZmFjZXMgcmVxdWlyZWQgZm9yIHRoaXMgcGF0
Y2ggYXJlIGF2YWlsYWJsZSBzaW5jZSBHTGliIDIuMzYKYW5kIGFyZSBzcGVjaWZpYyB0byBVbml4
LgpPbiB1c2Ugb2xkIGltcGxlbWVudGF0aW9uLgoKU2lnbmVkLW9mZi1ieTogRnJlZGlhbm8gWmln
bGlvIDxmemlnbGlvQHJlZGhhdC5jb20+Ci0tLQpDaGFuZ2VzIHNpbmNlIHYxOgotIFVzZSBnX3Nv
dXJjZV9hZGRfdW5peF9mZCBhbmQgZmFtaWx5IGluc3RlYWQgb2YgZ19zb3VyY2VfYWRkX3BvbGwK
CkNJIGF0IGh0dHBzOi8vZ2l0bGFiLmZyZWVkZXNrdG9wLm9yZy9memlnbGlvL3NwaWNlL3BpcGVs
aW5lcy81MDg1NQotLS0KIHNlcnZlci9ldmVudC1sb29wLmMgfCA5NCArKysrKysrKysrKysrKysr
KysrKysrKysrKysrKysrKysrKysrKystLS0tLS0KIDEgZmlsZSBjaGFuZ2VkLCA4MiBpbnNlcnRp
b25zKCspLCAxMiBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9zZXJ2ZXIvZXZlbnQtbG9vcC5j
IGIvc2VydmVyL2V2ZW50LWxvb3AuYwppbmRleCA4MGFmMjk1NGYuLjgxMmMzYTUzYiAxMDA2NDQK
LS0tIGEvc2VydmVyL2V2ZW50LWxvb3AuYworKysgYi9zZXJ2ZXIvZXZlbnQtbG9vcC5jCkBAIC04
NSwxNCArODUsNiBAQCBzdGF0aWMgdm9pZCB0aW1lcl9yZW1vdmUoY29uc3QgU3BpY2VDb3JlSW50
ZXJmYWNlSW50ZXJuYWwgKmlmYWNlLAogICAgIGdfZnJlZSh0aW1lcik7CiB9CiAKLXN0cnVjdCBT
cGljZVdhdGNoIHsKLSAgICBHTWFpbkNvbnRleHQgKmNvbnRleHQ7Ci0gICAgdm9pZCAqb3BhcXVl
OwotICAgIEdTb3VyY2UgKnNvdXJjZTsKLSAgICBHSU9DaGFubmVsICpjaGFubmVsOwotICAgIFNw
aWNlV2F0Y2hGdW5jIGZ1bmM7Ci19OwotCiBzdGF0aWMgR0lPQ29uZGl0aW9uIHNwaWNlX2V2ZW50
X3RvX2dpb2NvbmRpdGlvbihpbnQgZXZlbnRfbWFzaykKIHsKICAgICBHSU9Db25kaXRpb24gY29u
ZGl0aW9uID0gMDsKQEAgLTExNyw2ICsxMDksMTUgQEAgc3RhdGljIGludCBnaW9jb25kaXRpb25f
dG9fc3BpY2VfZXZlbnQoR0lPQ29uZGl0aW9uIGNvbmRpdGlvbikKICAgICByZXR1cm4gZXZlbnQ7
CiB9CiAKKyNpZmRlZiBfV0lOMzIKK3N0cnVjdCBTcGljZVdhdGNoIHsKKyAgICBHTWFpbkNvbnRl
eHQgKmNvbnRleHQ7CisgICAgdm9pZCAqb3BhcXVlOworICAgIEdTb3VyY2UgKnNvdXJjZTsKKyAg
ICBHSU9DaGFubmVsICpjaGFubmVsOworICAgIFNwaWNlV2F0Y2hGdW5jIGZ1bmM7Cit9OworCiBz
dGF0aWMgZ2Jvb2xlYW4gd2F0Y2hfZnVuYyhHSU9DaGFubmVsICpzb3VyY2UsIEdJT0NvbmRpdGlv
biBjb25kaXRpb24sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncG9pbnRlciBkYXRhKQog
ewpAQCAtMTYxLDExICsxNjIsNyBAQCBzdGF0aWMgU3BpY2VXYXRjaCAqd2F0Y2hfYWRkKGNvbnN0
IFNwaWNlQ29yZUludGVyZmFjZUludGVybmFsICppZmFjZSwKIAogICAgIHdhdGNoID0gZ19uZXcw
KFNwaWNlV2F0Y2gsIDEpOwogICAgIHdhdGNoLT5jb250ZXh0ID0gaWZhY2UtPm1haW5fY29udGV4
dDsKLSNpZm5kZWYgX1dJTjMyCi0gICAgd2F0Y2gtPmNoYW5uZWwgPSBnX2lvX2NoYW5uZWxfdW5p
eF9uZXcoZmQpOwotI2Vsc2UKICAgICB3YXRjaC0+Y2hhbm5lbCA9IGdfaW9fY2hhbm5lbF93aW4z
Ml9uZXdfc29ja2V0KGZkKTsKLSNlbmRpZgogICAgIHdhdGNoLT5mdW5jID0gZnVuYzsKICAgICB3
YXRjaC0+b3BhcXVlID0gb3BhcXVlOwogCkBAIC0xODQsNiArMTgxLDc5IEBAIHN0YXRpYyB2b2lk
IHdhdGNoX3JlbW92ZShjb25zdCBTcGljZUNvcmVJbnRlcmZhY2VJbnRlcm5hbCAqaWZhY2UsCiAg
ICAgZ19mcmVlKHdhdGNoKTsKIH0KIAorI2Vsc2UKKworc3RydWN0IFNwaWNlV2F0Y2ggeworICAg
IEdTb3VyY2Ugc291cmNlOworICAgIGdwb2ludGVyIHVuaXhfZmQ7CisgICAgaW50IGZkOworfTsK
Kworc3RhdGljIGdib29sZWFuCitzcGljZV93YXRjaF9jaGVjayhHU291cmNlICpzb3VyY2UpCit7
CisgICAgU3BpY2VXYXRjaCAqd2F0Y2ggPSBTUElDRV9DT05UQUlORVJPRihzb3VyY2UsIFNwaWNl
V2F0Y2gsIHNvdXJjZSk7CisKKyAgICByZXR1cm4gZ19zb3VyY2VfcXVlcnlfdW5peF9mZCgmd2F0
Y2gtPnNvdXJjZSwgd2F0Y2gtPnVuaXhfZmQpICE9IDA7Cit9CisKK3N0YXRpYyBnYm9vbGVhbgor
c3BpY2Vfd2F0Y2hfZGlzcGF0Y2goR1NvdXJjZSAgICAgKnNvdXJjZSwKKyAgICAgICAgICAgICAg
ICAgICAgIEdTb3VyY2VGdW5jICBjYWxsYmFjaywKKyAgICAgICAgICAgICAgICAgICAgIGdwb2lu
dGVyICAgICB1c2VyX2RhdGEpCit7CisgICAgU3BpY2VXYXRjaCAqd2F0Y2ggPSBTUElDRV9DT05U
QUlORVJPRihzb3VyY2UsIFNwaWNlV2F0Y2gsIHNvdXJjZSk7CisgICAgU3BpY2VXYXRjaEZ1bmMg
ZnVuYyA9IChTcGljZVdhdGNoRnVuYykodm9pZCopIGNhbGxiYWNrOworICAgIEdJT0NvbmRpdGlv
biBjb25kaXRpb24gPSBnX3NvdXJjZV9xdWVyeV91bml4X2ZkKCZ3YXRjaC0+c291cmNlLCB3YXRj
aC0+dW5peF9mZCk7CisKKyAgICBmdW5jKHdhdGNoLT5mZCwgZ2lvY29uZGl0aW9uX3RvX3NwaWNl
X2V2ZW50KGNvbmRpdGlvbiksIHVzZXJfZGF0YSk7CisgICAgLyogdGltZXIgbWlnaHQgYmUgZnJl
ZSBhZnRlciBmdW5jKCksIGRvbid0IHRvdWNoICovCisKKyAgICByZXR1cm4gR19TT1VSQ0VfQ09O
VElOVUU7Cit9CisKK3N0YXRpYyBHU291cmNlRnVuY3Mgc3BpY2Vfd2F0Y2hfZnVuY3MgPSB7Cisg
ICAgLmNoZWNrID0gc3BpY2Vfd2F0Y2hfY2hlY2ssCisgICAgLmRpc3BhdGNoID0gc3BpY2Vfd2F0
Y2hfZGlzcGF0Y2gsCit9OworCitzdGF0aWMgdm9pZCB3YXRjaF91cGRhdGVfbWFzayhjb25zdCBT
cGljZUNvcmVJbnRlcmZhY2VJbnRlcm5hbCAqaWZhY2UsCisgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICBTcGljZVdhdGNoICp3YXRjaCwgaW50IGV2ZW50X21hc2spCit7CisgICAgR0lPQ29u
ZGl0aW9uIGNvbmRpdGlvbiA9IHNwaWNlX2V2ZW50X3RvX2dpb2NvbmRpdGlvbihldmVudF9tYXNr
KTsKKworICAgIGdfc291cmNlX21vZGlmeV91bml4X2ZkKCZ3YXRjaC0+c291cmNlLCB3YXRjaC0+
dW5peF9mZCwgY29uZGl0aW9uKTsKK30KKworc3RhdGljIFNwaWNlV2F0Y2ggKndhdGNoX2FkZChj
b25zdCBTcGljZUNvcmVJbnRlcmZhY2VJbnRlcm5hbCAqaWZhY2UsCisgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIGludCBmZCwgaW50IGV2ZW50X21hc2ssIFNwaWNlV2F0Y2hGdW5jIGZ1bmMs
IHZvaWQgKm9wYXF1ZSkKK3sKKyAgICBTcGljZVdhdGNoICp3YXRjaCA9IChTcGljZVdhdGNoICop
IGdfc291cmNlX25ldygmc3BpY2Vfd2F0Y2hfZnVuY3MsIHNpemVvZihTcGljZVdhdGNoKSk7CisK
KyAgICBzcGljZV9yZXR1cm5fdmFsX2lmX2ZhaWwoZmQgIT0gLTEsIE5VTEwpOworICAgIHNwaWNl
X3JldHVybl92YWxfaWZfZmFpbChmdW5jICE9IE5VTEwsIE5VTEwpOworCisgICAgd2F0Y2gtPmZk
ID0gZmQ7CisKKyAgICBnX3NvdXJjZV9zZXRfY2FsbGJhY2soJndhdGNoLT5zb3VyY2UsIChHU291
cmNlRnVuYykodm9pZCopKFNwaWNlV2F0Y2hGdW5jKSBmdW5jLCBvcGFxdWUsIE5VTEwpOworCisg
ICAgZ19zb3VyY2VfYXR0YWNoKCZ3YXRjaC0+c291cmNlLCBpZmFjZS0+bWFpbl9jb250ZXh0KTsK
KworICAgIEdJT0NvbmRpdGlvbiBjb25kaXRpb24gPSBzcGljZV9ldmVudF90b19naW9jb25kaXRp
b24oZXZlbnRfbWFzayk7CisgICAgd2F0Y2gtPnVuaXhfZmQgPSBnX3NvdXJjZV9hZGRfdW5peF9m
ZCgmd2F0Y2gtPnNvdXJjZSwgd2F0Y2gtPmZkLCBjb25kaXRpb24pOworCisgICAgcmV0dXJuIHdh
dGNoOworfQorCitzdGF0aWMgdm9pZCB3YXRjaF9yZW1vdmUoY29uc3QgU3BpY2VDb3JlSW50ZXJm
YWNlSW50ZXJuYWwgKmlmYWNlLAorICAgICAgICAgICAgICAgICAgICAgICAgIFNwaWNlV2F0Y2gg
KndhdGNoKQoreworICAgIGdfc291cmNlX3JlbW92ZV91bml4X2ZkKCZ3YXRjaC0+c291cmNlLCB3
YXRjaC0+dW5peF9mZCk7CisgICAgZ19zb3VyY2VfZGVzdHJveSgmd2F0Y2gtPnNvdXJjZSk7Cisg
ICAgZ19zb3VyY2VfdW5yZWYoJndhdGNoLT5zb3VyY2UpOworfQorI2VuZGlmCisKIGNvbnN0IFNw
aWNlQ29yZUludGVyZmFjZUludGVybmFsIGV2ZW50X2xvb3BfY29yZSA9IHsKICAgICAudGltZXJf
YWRkID0gdGltZXJfYWRkLAogICAgIC50aW1lcl9zdGFydCA9IHRpbWVyX3N0YXJ0LAotLSAKMi4y
MC4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpTcGlj
ZS1kZXZlbCBtYWlsaW5nIGxpc3QKU3BpY2UtZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Aub3JnCmh0
dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vc3BpY2UtZGV2ZWw=
