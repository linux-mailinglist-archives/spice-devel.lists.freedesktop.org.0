Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 2246287CA0
	for <lists+spice-devel@lfdr.de>; Fri,  9 Aug 2019 16:27:18 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id A9DE66EE23;
	Fri,  9 Aug 2019 14:27:16 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 684266EE1F
 for <spice-devel@lists.freedesktop.org>; Fri,  9 Aug 2019 14:27:15 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx07.intmail.prod.int.phx2.redhat.com
 [10.5.11.22])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 12F1730832DA;
 Fri,  9 Aug 2019 14:27:15 +0000 (UTC)
Received: from fziglio.remote.csb (ovpn-204-160.brq.redhat.com [10.40.204.160])
 by smtp.corp.redhat.com (Postfix) with ESMTP id EEB8E100034E;
 Fri,  9 Aug 2019 14:27:12 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Fri,  9 Aug 2019 15:26:24 +0100
Message-Id: <20190809142651.2967-7-fziglio@redhat.com>
In-Reply-To: <20190809142651.2967-1-fziglio@redhat.com>
References: <20190809142651.2967-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.84 on 10.5.11.22
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.44]); Fri, 09 Aug 2019 14:27:15 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-gtk v2 06/33] usb-redir: extend USB
 backend to support emulated devices
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

RnJvbTogWXVyaSBCZW5kaXRvdmljaCA8eXVyaS5iZW5kaXRvdmljaEBkYXluaXguY29tPgoKUmVk
aXJlY3Rpb24gb2YgZW11bGF0ZWQgZGV2aWNlcyByZXF1aXJlcyBzcGVjaWFsIGFwcHJvYWNoLAph
cyB1c2JyZWRpcmhvc3QgY2FuJ3QgYmUgdXNlZCBmb3IgdGhhdCAoaXQgd29ya3Mgb25seSB3aXRo
CmxpYnVzYiBkZXZpY2VzKS4gRm9yIGVtdWxhdGVkIGRldmljZXMgd2UgY3JlYXRlIGluc3RhbmNl
IG9mCnVzYnJlZGlycGFyc2VyIHRoYXQgaW1wbGVtZW50cyBVU0IgcmVkaXJlY3Rpb24gcHJvdG9j
b2wuCkluIG9yZGVyIHRvIHdvcmsgd2l0aCB0aGUgc2FtZSBzZXQgb2YgcHJvdG9jb2wgY2FwYWJp
bGl0aWVzCnRoYXQgdXNicmVkaXJob3N0IHNldHMgdXAgd2l0aCByZW1vdGUgc2lkZSwgdGhlIHBh
cnNlciBzaGFsbDoKLSBub3Qgc2VuZCBpdHMgb3duICdoZWxsbycgdG8gdGhlIHNlcnZlcgotIGlu
aXRpYWxpemUgdGhlIHNhbWUgY2FwYWJpbGl0aWVzIHRoYXQgdXNicmVkaXJob3N0Ci0gcmVjZWl2
ZSB0aGUgc2FtZSAnaGVsbG8nIHJlc3BvbnNlCkZvciB0aGF0IHdlIGFuYWx5emUgJ2hlbGxvJyBz
ZW50IGJ5IFVTQiByZWRpciBwYXJzZXIgYW5kCmV4dHJhY3Qgc2V0IG9mIGNhcGFiaWxpdGllcyBm
cm9tIGl0IGFuZCB1cG9uIHJlY2VpdmUgb2YKJ2hlbGxvJyByZXNwb25zZSB3ZSBwcm92aWRlIGl0
IGFsc28gdG8gdGhlIHBhcnNlci4KV2hlbiBsaWJ1c2IgZGV2aWNlIGlzIHJlZGlyZWN0ZWQgdmlh
IGEgY2hhbm5lbCwgaW5zdGFuY2Ugb2YKdXNicmVkaXJob3N0IHNlcnZlcyBpdC4KV2hlbiBlbXVs
YXRlZCBkZXZpY2UgaXMgcmVkaXJlY3RlZCB2aWEgYSBjaGFubmVsLCBpbnN0YW5jZQpvZiB1c2Jy
ZWRpcnBhcnNlciBkb2VzIHRoZSBqb2IuCgpTaWduZWQtb2ZmLWJ5OiBZdXJpIEJlbmRpdG92aWNo
IDx5dXJpLmJlbmRpdG92aWNoQGRheW5peC5jb20+Ci0tLQogc3JjL3VzYi1iYWNrZW5kLmMgfCA1
ODUgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKystLQogMSBmaWxl
IGNoYW5nZWQsIDU2OCBpbnNlcnRpb25zKCspLCAxNyBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQg
YS9zcmMvdXNiLWJhY2tlbmQuYyBiL3NyYy91c2ItYmFja2VuZC5jCmluZGV4IGFhMTFjNzkxLi5i
ZWQ0MzFjMyAxMDA2NDQKLS0tIGEvc3JjL3VzYi1iYWNrZW5kLmMKKysrIGIvc3JjL3VzYi1iYWNr
ZW5kLmMKQEAgLTU1LDYgKzU1LDcgQEAgc3RydWN0IF9TcGljZVVzYkJhY2tlbmREZXZpY2UKICAg
ICBnaW50IHJlZl9jb3VudDsKICAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICphdHRhY2hlZF90
bzsKICAgICBVc2JEZXZpY2VJbmZvcm1hdGlvbiBkZXZpY2VfaW5mbzsKKyAgICBnYm9vbGVhbiBl
ZGV2X2NvbmZpZ3VyZWQ7CiB9OwogCiBzdHJ1Y3QgX1NwaWNlVXNiQmFja2VuZApAQCAtODAsMTAg
KzgxLDIwIEBAIHN0cnVjdCBfU3BpY2VVc2JCYWNrZW5kCiBzdHJ1Y3QgX1NwaWNlVXNiQmFja2Vu
ZENoYW5uZWwKIHsKICAgICBzdHJ1Y3QgdXNicmVkaXJob3N0ICp1c2JyZWRpcmhvc3Q7CisgICAg
c3RydWN0IHVzYnJlZGlyaG9zdCAqaGlkZGVuX2hvc3Q7CisgICAgc3RydWN0IHVzYnJlZGlycGFy
c2VyICpwYXJzZXI7CisgICAgc3RydWN0IHVzYnJlZGlycGFyc2VyICpoaWRkZW5fcGFyc2VyOwog
ICAgIHVpbnQ4X3QgKnJlYWRfYnVmOwogICAgIGludCByZWFkX2J1Zl9zaXplOwogICAgIHN0cnVj
dCB1c2JyZWRpcmZpbHRlcl9ydWxlICpydWxlczsKICAgICBpbnQgcnVsZXNfY291bnQ7CisgICAg
dWludDMyX3QgaG9zdF9jYXBzOworICAgIHVpbnQzMl90IHBhcnNlcl9pbml0X2RvbmUgIDogMTsK
KyAgICB1aW50MzJfdCBwYXJzZXJfd2l0aF9oZWxsbyA6IDE7CisgICAgdWludDMyX3QgaGVsbG9f
ZG9uZV9wYXJzZXIgOiAxOworICAgIHVpbnQzMl90IGhlbGxvX3NlbnQgICAgICAgIDogMTsKKyAg
ICB1aW50MzJfdCByZWplY3RlZCAgICAgICAgICA6IDE7CisgICAgdWludDMyX3Qgd2FpdF9kaXNj
X2FjayAgICAgOiAxOwogICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqYXR0YWNoZWQ7CiAgICAg
U3BpY2VVc2JyZWRpckNoYW5uZWwgICp1c2VyX2RhdGE7CiAgICAgU3BpY2VVc2JCYWNrZW5kICpi
YWNrZW5kOwpAQCAtMzU1LDcgKzM2NiwxMSBAQCBnYm9vbGVhbiBzcGljZV91c2JfYmFja2VuZF9k
ZXZpY2VfaXNvY2goU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkZXYpCiAgICAgZ2ludCBpLCBqLCBr
OwogICAgIGludCByYzsKIAotICAgIGdfcmV0dXJuX3ZhbF9pZl9mYWlsKGxpYmRldiAhPSBOVUxM
LCAwKTsKKyAgICBnX3JldHVybl92YWxfaWZfZmFpbChsaWJkZXYgIT0gTlVMTCB8fCBkZXYtPmVk
ZXYgIT0gTlVMTCwgMCk7CisgICAgaWYgKGRldi0+ZWRldikgeworICAgICAgICAvKiBjdXJyZW50
bHkgd2UgZG8gbm90IGVtdWxhdGUgaXNvY2ggZGV2aWNlcyAqLworICAgICAgICByZXR1cm4gRkFM
U0U7CisgICAgfQogCiAgICAgcmMgPSBsaWJ1c2JfZ2V0X2FjdGl2ZV9jb25maWdfZGVzY3JpcHRv
cihsaWJkZXYsICZjb25mX2Rlc2MpOwogICAgIGlmIChyYykgewpAQCAtMzkwLDEzICs0MDUsMTYg
QEAgZnJvbSBib3RoIHRoZSBtYWluIHRocmVhZCBhcyB3ZWxsIGFzIGZyb20gdGhlIHVzYiBldmVu
dCBoYW5kbGluZyB0aHJlYWQgKi8KIHN0YXRpYyB2b2lkIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2Nh
bGxiYWNrKHZvaWQgKnVzZXJfZGF0YSkKIHsKICAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpj
aCA9IHVzZXJfZGF0YTsKLSAgICBpZiAoIWNoLT51c2JyZWRpcmhvc3QpIHsKLSAgICAgICAgLyog
anVzdCB0byBiZSBvbiB0aGUgc2FmZSBzaWRlICovCi0gICAgICAgIHJldHVybjsKLSAgICB9CiAg
ICAgaWYgKGlzX2NoYW5uZWxfcmVhZHkoY2gtPnVzZXJfZGF0YSkpIHsKLSAgICAgICAgU1BJQ0Vf
REVCVUcoIiVzIGNoICVwIC0+IHVzYnJlZGlyaG9zdCIsIF9fRlVOQ1RJT05fXywgY2gpOwotICAg
ICAgICB1c2JyZWRpcmhvc3Rfd3JpdGVfZ3Vlc3RfZGF0YShjaC0+dXNicmVkaXJob3N0KTsKKyAg
ICAgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIl
cyBjaCAlcCAtPiB1c2JyZWRpcmhvc3QiLCBfX0ZVTkNUSU9OX18sIGNoKTsKKyAgICAgICAgICAg
IHVzYnJlZGlyaG9zdF93cml0ZV9ndWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3QpOworICAgICAg
ICB9IGVsc2UgaWYgKGNoLT5wYXJzZXIpIHsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBj
aCAlcCAtPiBwYXJzZXIiLCBfX0ZVTkNUSU9OX18sIGNoKTsKKyAgICAgICAgICAgIHVzYnJlZGly
cGFyc2VyX2RvX3dyaXRlKGNoLT5wYXJzZXIpOworICAgICAgICB9IGVsc2UgeworICAgICAgICAg
ICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIChOT1QgQUNUSVZFKSIsIF9fRlVOQ1RJT05fXywgY2gp
OworICAgICAgICB9CiAgICAgfSBlbHNlIHsKICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVw
IChub3QgcmVhZHkpIiwgX19GVU5DVElPTl9fLCBjaCk7CiAgICAgfQpAQCAtNTUxLDEzICs1Njks
NTcgQEAgdm9pZCBzcGljZV91c2JfYmFja2VuZF9kZXZpY2VfdW5yZWYoU3BpY2VVc2JCYWNrZW5k
RGV2aWNlICpkZXYpCiAgICAgfQogfQogCitzdGF0aWMgaW50IGNoZWNrX2VkZXZfZGV2aWNlX2Zp
bHRlcihTcGljZVVzYkJhY2tlbmREZXZpY2UgKmRldiwKKyAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIGNvbnN0IHN0cnVjdCB1c2JyZWRpcmZpbHRlcl9ydWxlICpydWxlcywKKyAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludCBjb3VudCkKK3sKKyAgICBTcGlj
ZVVzYkVtdWxhdGVkRGV2aWNlICplZGV2ID0gZGV2LT5lZGV2OworICAgIHVpbnQ4X3QgY2xzWzMy
XSwgc3ViY2xzWzMyXSwgcHJvdG9bMzJdLCAqY2ZnLCBpZm51bSA9IDA7CisgICAgdWludDE2X3Qg
c2l6ZSwgb2Zmc2V0ID0gMDsKKyAgICBpZiAoIWVkZXYpIHsKKyAgICAgICAgcmV0dXJuIDE7Cisg
ICAgfQorICAgIGlmICghZGV2aWNlX29wcyhlZGV2KS0+Z2V0X2Rlc2NyaXB0b3IoCisgICAgICAg
ICAgICBlZGV2LCBMSUJVU0JfRFRfQ09ORklHLCAwLCAodm9pZCAqKikmY2ZnLCAmc2l6ZSkpIHsK
KyAgICAgICAgcmV0dXJuIDE7CisgICAgfQorICAgIHdoaWxlICgob2Zmc2V0ICsgMSkgPCBzaXpl
KSB7CisgICAgICAgIHVpbnQ4X3QgbGVuICA9IGNmZ1tvZmZzZXRdOworICAgICAgICB1aW50OF90
IHR5cGUgPSBjZmdbb2Zmc2V0ICsgMV07CisgICAgICAgIGlmICgob2Zmc2V0ICsgbGVuKSA+IHNp
emUpIHsKKyAgICAgICAgICAgIGJyZWFrOworICAgICAgICB9CisgICAgICAgIGlmICh0eXBlID09
IExJQlVTQl9EVF9JTlRFUkZBQ0UpIHsKKyAgICAgICAgICAgIGNsc1tpZm51bV0gPSBjZmdbb2Zm
c2V0ICsgNV07CisgICAgICAgICAgICBzdWJjbHNbaWZudW1dID0gY2ZnW29mZnNldCArIDZdOwor
ICAgICAgICAgICAgcHJvdG9baWZudW1dID0gY2ZnW29mZnNldCArIDddOworICAgICAgICAgICAg
aWZudW0rKzsKKyAgICAgICAgfQorICAgICAgICBvZmZzZXQgKz0gbGVuOworICAgIH0KKworICAg
IHJldHVybiB1c2JyZWRpcmZpbHRlcl9jaGVjaygKKyAgICAgICAgcnVsZXMsIGNvdW50LAorICAg
ICAgICBkZXYtPmRldmljZV9pbmZvLmNsYXNzLAorICAgICAgICBkZXYtPmRldmljZV9pbmZvLnN1
YmNsYXNzLAorICAgICAgICBkZXYtPmRldmljZV9pbmZvLnByb3RvY29sLAorICAgICAgICBjbHMs
IHN1YmNscywgcHJvdG8sIGlmbnVtLAorICAgICAgICBkZXYtPmRldmljZV9pbmZvLnZpZCwKKyAg
ICAgICAgZGV2LT5kZXZpY2VfaW5mby5waWQsCisgICAgICAgIGRldi0+ZGV2aWNlX2luZm8uYmNk
VVNCLCAwKTsKK30KKwogaW50IHNwaWNlX3VzYl9iYWNrZW5kX2RldmljZV9jaGVja19maWx0ZXIo
CiAgICAgU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkZXYsCiAgICAgY29uc3Qgc3RydWN0IHVzYnJl
ZGlyZmlsdGVyX3J1bGUgKnJ1bGVzLAogICAgIGludCBjb3VudCkKIHsKLSAgICByZXR1cm4gdXNi
cmVkaXJob3N0X2NoZWNrX2RldmljZV9maWx0ZXIoCi0gICAgICAgIHJ1bGVzLCBjb3VudCwgZGV2
LT5saWJ1c2JfZGV2aWNlLCAwKTsKKyAgICBpZiAoZGV2LT5saWJ1c2JfZGV2aWNlKSB7CisgICAg
ICAgIHJldHVybiB1c2JyZWRpcmhvc3RfY2hlY2tfZGV2aWNlX2ZpbHRlcigKKyAgICAgICAgICAg
IHJ1bGVzLCBjb3VudCwgZGV2LT5saWJ1c2JfZGV2aWNlLCAwKTsKKyAgICB9IGVsc2UgeworICAg
ICAgICByZXR1cm4gY2hlY2tfZWRldl9kZXZpY2VfZmlsdGVyKGRldiwgcnVsZXMsIGNvdW50KTsK
KyAgICB9CiB9CiAKIHN0YXRpYyBpbnQgdXNicmVkaXJfcmVhZF9jYWxsYmFjayh2b2lkICp1c2Vy
X2RhdGEsIHVpbnQ4X3QgKmRhdGEsIGludCBjb3VudCkKQEAgLTYyMSw2ICs2ODMsMTcgQEAgc3Rh
dGljIGludCB1c2JyZWRpcl93cml0ZV9jYWxsYmFjayh2b2lkICp1c2VyX2RhdGEsIHVpbnQ4X3Qg
KmRhdGEsIGludCBjb3VudCkKICAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHVzZXJf
ZGF0YTsKICAgICBpbnQgcmVzOwogICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCwgJWQgYnl0ZXMi
LCBfX0ZVTkNUSU9OX18sIGNoLCBjb3VudCk7CisgICAgaWYgKCFjaC0+aGVsbG9fc2VudCkgewor
ICAgICAgICAvKiBoZWxsbyBpcyBzaG9ydCBoZWFkZXIgKDEyKSArIGhlbGxvIHN0cnVjdCAoNjQp
ICsgY2FwYWJpbGl0aWVzICg0KSAqLworICAgICAgICBpbnQgaGVsbG9fc2l6ZSA9IHNpemVvZihz
dHJ1Y3QgdXNiX3JlZGlyX2hlYWRlcikgKyBzaXplb2Yoc3RydWN0IHVzYl9yZWRpcl9oZWxsb19o
ZWFkZXIpOworICAgICAgICBjaC0+aGVsbG9fc2VudCA9IDE7CisgICAgICAgIGlmIChjb3VudCA9
PSBoZWxsb19zaXplKSB7CisgICAgICAgICAgICBtZW1jcHkoJmNoLT5ob3N0X2NhcHMsIGRhdGEg
KyBoZWxsb19zaXplIC0gc2l6ZW9mKGNoLT5ob3N0X2NhcHMpLAorICAgICAgICAgICAgICAgICAg
IHNpemVvZihjaC0+aG9zdF9jYXBzKSk7CisgICAgICAgICAgICBTUElDRV9ERUJVRygiJXMgY2gg
JXAsIHNlbmRpbmcgZmlyc3QgaGVsbG8sIGNhcHMgJTA4WCIsCisgICAgICAgICAgICAgICAgICAg
ICAgICBfX0ZVTkNUSU9OX18sIGNoLCBjaC0+aG9zdF9jYXBzKTsKKyAgICAgICAgfQorICAgIH0K
ICAgICByZXMgPSBzcGljZV91c2JyZWRpcl93cml0ZV9jYWxsYmFjayhjaC0+dXNlcl9kYXRhLCBk
YXRhLCBjb3VudCk7CiAgICAgcmV0dXJuIHJlczsKIH0KQEAgLTY0MSw2ICs3MTQsMjcgQEAgaW50
IHNwaWNlX3VzYl9iYWNrZW5kX3JlYWRfZ3Vlc3RfZGF0YShTcGljZVVzYkJhY2tlbmRDaGFubmVs
ICpjaCwgdWludDhfdCAqZGF0YSwKICAgICBjaC0+cmVhZF9idWZfc2l6ZSA9IGNvdW50OwogICAg
IGlmIChjaC0+dXNicmVkaXJob3N0KSB7CiAgICAgICAgIHJlcyA9IHVzYnJlZGlyaG9zdF9yZWFk
X2d1ZXN0X2RhdGEoY2gtPnVzYnJlZGlyaG9zdCk7CisgICAgICAgIGlmICghY2gtPmhlbGxvX2Rv
bmVfcGFyc2VyKSB7CisgICAgICAgICAgICBpbnQgcmVzX3BhcnNlcjsKKyAgICAgICAgICAgIC8q
IHVzYnJlZGlyaG9zdCBzaG91bGQgY29uc3VtZSBoZWxsbyByZXNwb25zZSAqLworICAgICAgICAg
ICAgZ19yZXR1cm5fdmFsX2lmX2ZhaWwoY2gtPnJlYWRfYnVmID09IE5VTEwsIFVTQl9SRURJUl9F
UlJPUl9SRUFEX1BBUlNFKTsKKworICAgICAgICAgICAgY2gtPnJlYWRfYnVmID0gZGF0YTsKKyAg
ICAgICAgICAgIGNoLT5yZWFkX2J1Zl9zaXplID0gY291bnQ7CisgICAgICAgICAgICBjaC0+aGVs
bG9fZG9uZV9wYXJzZXIgPSAxOworICAgICAgICAgICAgaWYgKGNoLT5hdHRhY2hlZCAmJiBjaC0+
YXR0YWNoZWQtPmVkZXYpIHsKKyAgICAgICAgICAgICAgICAvKiBjYXNlIG9mIENEIHNoYXJpbmcg
b24gY29ubmVjdCAqLworICAgICAgICAgICAgICAgIGNoLT51c2JyZWRpcmhvc3QgPSBOVUxMOwor
ICAgICAgICAgICAgICAgIGNoLT5wYXJzZXIgPSBjaC0+aGlkZGVuX3BhcnNlcjsKKyAgICAgICAg
ICAgICAgICBTUElDRV9ERUJVRygiJXM6IHN3aXRjaCAlcCB0byBwYXJzZXIiLCBfX0ZVTkNUSU9O
X18sIGNoKTsKKyAgICAgICAgICAgIH0KKyAgICAgICAgICAgIHJlc19wYXJzZXIgPSB1c2JyZWRp
cnBhcnNlcl9kb19yZWFkKGNoLT5oaWRkZW5fcGFyc2VyKTsKKyAgICAgICAgICAgIGlmIChyZXMg
Pj0gMCkgeworICAgICAgICAgICAgICAgIHJlcyA9IHJlc19wYXJzZXI7CisgICAgICAgICAgICB9
CisgICAgICAgIH0KKyAgICB9IGVsc2UgaWYgKGNoLT5wYXJzZXIpIHsKKyAgICAgICAgcmVzID0g
dXNicmVkaXJwYXJzZXJfZG9fcmVhZChjaC0+cGFyc2VyKTsKICAgICB9IGVsc2UgewogICAgICAg
ICByZXMgPSBVU0JfUkVESVJfRVJST1JfSU87CiAgICAgfQpAQCAtNjYxLDYgKzc1NSwxMSBAQCBp
bnQgc3BpY2VfdXNiX2JhY2tlbmRfcmVhZF9ndWVzdF9kYXRhKFNwaWNlVXNiQmFja2VuZENoYW5u
ZWwgKmNoLCB1aW50OF90ICpkYXRhLAogICAgIH0KICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAs
ICVkIGJ5dGVzLCByZXMgJWQiLCBfX0ZVTkNUSU9OX18sIGNoLCBjb3VudCwgcmVzKTsKIAorICAg
IGlmIChjaC0+cmVqZWN0ZWQpIHsKKyAgICAgICAgY2gtPnJlamVjdGVkID0gMDsKKyAgICAgICAg
cmVzID0gVVNCX1JFRElSX0VSUk9SX0RFVl9SRUpFQ1RFRDsKKyAgICB9CisKICAgICByZXR1cm4g
cmVzOwogfQogCkBAIC02OTAsMTMgKzc4OSw0MzAgQEAgR0Vycm9yICpzcGljZV91c2JfYmFja2Vu
ZF9nZXRfZXJyb3JfZGV0YWlscyhpbnQgZXJyb3JfY29kZSwgZ2NoYXIgKmRlc2MpCiB2b2lkIHNw
aWNlX3VzYl9iYWNrZW5kX3JldHVybl93cml0ZV9kYXRhKFNwaWNlVXNiQmFja2VuZENoYW5uZWwg
KmNoLCB2b2lkICpkYXRhKQogewogICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7Ci0gICAgICAg
IFNQSUNFX0RFQlVHKCIlcyBjaCAlcCIsIF9fRlVOQ1RJT05fXywgY2gpOworICAgICAgICBTUElD
RV9ERUJVRygiJXMgY2ggJXAgLT4gdXNicmVkaXJob3N0IiwgX19GVU5DVElPTl9fLCBjaCk7CiAg
ICAgICAgIHVzYnJlZGlyaG9zdF9mcmVlX3dyaXRlX2J1ZmZlcihjaC0+dXNicmVkaXJob3N0LCBk
YXRhKTsKKyAgICB9IGVsc2UgaWYgKGNoLT5wYXJzZXIpIHsKKyAgICAgICAgU1BJQ0VfREVCVUco
IiVzIGNoICVwIC0+IHBhcnNlciIsIF9fRlVOQ1RJT05fXywgY2gpOworICAgICAgICB1c2JyZWRp
cnBhcnNlcl9mcmVlX3dyaXRlX2J1ZmZlcihjaC0+cGFyc2VyLCBkYXRhKTsKICAgICB9IGVsc2Ug
ewogICAgICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAgLSBOT0JPRFkgVE8gQ0FMTCIsIF9fRlVO
Q1RJT05fXywgY2gpOwogICAgIH0KIH0KIAorc3RhdGljIHZvaWQgdXNicmVkaXJfY29udHJvbF9w
YWNrZXQodm9pZCAqcHJpdiwKKyAgICB1aW50NjRfdCBpZCwgc3RydWN0IHVzYl9yZWRpcl9jb250
cm9sX3BhY2tldF9oZWFkZXIgKmgsCisgICAgdWludDhfdCAqZGF0YSwgaW50IGRhdGFfbGVuKQor
eworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBTcGljZVVzYkJh
Y2tlbmREZXZpY2UgKmQgPSBjaC0+YXR0YWNoZWQ7CisgICAgU3BpY2VVc2JFbXVsYXRlZERldmlj
ZSAqZWRldiA9IGQgPyBkLT5lZGV2IDogTlVMTDsKKyAgICBzdHJ1Y3QgdXNiX3JlZGlyX2NvbnRy
b2xfcGFja2V0X2hlYWRlciByZXNwb25zZSA9ICpoOworICAgIHVpbnQ4X3QgcmVxdHlwZSA9IGgt
PnJlcXVlc3R0eXBlICYgMHg3ZjsKKyAgICBnYm9vbGVhbiBkb25lID0gRkFMU0U7CisgICAgdm9p
ZCAqb3V0X2J1ZmZlciA9IE5VTEw7CisKKyAgICByZXNwb25zZS5zdGF0dXMgPSB1c2JfcmVkaXJf
c3RhbGw7CisgICAgU1BJQ0VfREVCVUcoIiVzICVwOiBUUlZJTCAlMDJYICUwMlggJTA0WCAlMDRY
ICUwNFgiLAorICAgICAgICAgICAgICAgIF9fRlVOQ1RJT05fXywKKyAgICAgICAgICAgICAgICBj
aCwgaC0+cmVxdWVzdHR5cGUsIGgtPnJlcXVlc3QsCisgICAgICAgICAgICAgICAgaC0+dmFsdWUs
IGgtPmluZGV4LCBoLT5sZW5ndGgpOworCisgICAgaWYgKCFlZGV2KSB7CisgICAgICAgIFNQSUNF
X0RFQlVHKCIlczogZGV2aWNlIG5vdCBhdHRhY2hlZCIsIF9fRlVOQ1RJT05fXyk7CisgICAgICAg
IHJlc3BvbnNlLnN0YXR1cyA9IHVzYl9yZWRpcl9pb2Vycm9yOworICAgICAgICBkb25lID0gVFJV
RTsKKyAgICB9IGVsc2UgaWYgKHJlcXR5cGUgPT0gKExJQlVTQl9SRVFVRVNUX1RZUEVfU1RBTkRB
UkQgfCBMSUJVU0JfUkVDSVBJRU5UX0RFVklDRSkgJiYKKyAgICAgICAgICAgICAgIGgtPnJlcXVl
c3QgPT0gTElCVVNCX1JFUVVFU1RfR0VUX0RFU0NSSVBUT1IpIHsKKyAgICAgICAgdWludDE2X3Qg
c2l6ZTsKKyAgICAgICAgZG9uZSA9IGRldmljZV9vcHMoZWRldiktPmdldF9kZXNjcmlwdG9yKAor
ICAgICAgICAgICAgZWRldiwgaC0+dmFsdWUgPj4gOCwgaC0+dmFsdWUgJiAweGZmLAorICAgICAg
ICAgICAgJm91dF9idWZmZXIsICZzaXplKTsKKyAgICAgICAgcmVzcG9uc2UubGVuZ3RoID0gc2l6
ZTsKKyAgICAgICAgaWYgKGRvbmUpIHsKKyAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1cyA9IDA7
CisgICAgICAgIH0KKyAgICAgICAgZG9uZSA9IFRSVUU7CisgICAgfQorCisgICAgaWYgKCFkb25l
KSB7CisgICAgICAgIGRldmljZV9vcHMoZWRldiktPmNvbnRyb2xfcmVxdWVzdCgKKyAgICAgICAg
ICAgIGVkZXYsIGRhdGEsIGRhdGFfbGVuLCAmcmVzcG9uc2UsICZvdXRfYnVmZmVyKTsKKyAgICAg
ICAgZG9uZSA9IFRSVUU7CisgICAgfQorCisgICAgaWYgKHJlc3BvbnNlLnN0YXR1cykgeworICAg
ICAgICByZXNwb25zZS5sZW5ndGggPSAwOworICAgIH0gZWxzZSBpZiAocmVzcG9uc2UubGVuZ3Ro
ID4gaC0+bGVuZ3RoKSB7CisgICAgICAgIHJlc3BvbnNlLmxlbmd0aCA9IGgtPmxlbmd0aDsKKyAg
ICB9CisKKyAgICBTUElDRV9ERUJVRygiJXMgcmVzcG9uZGluZyB3aXRoIHBheWxvYWQgb2YgJTAy
WCwgc3RhdHVzICVYIiwKKyAgICAgICAgICAgICAgICBfX0ZVTkNUSU9OX18sIHJlc3BvbnNlLmxl
bmd0aCwgcmVzcG9uc2Uuc3RhdHVzKTsKKyAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2NvbnRyb2xf
cGFja2V0KAorICAgICAgICBjaC0+cGFyc2VyLCBpZCwgJnJlc3BvbnNlLAorICAgICAgICByZXNw
b25zZS5sZW5ndGggPyBvdXRfYnVmZmVyIDogTlVMTCwKKyAgICAgICAgcmVzcG9uc2UubGVuZ3Ro
KTsKKworICAgIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsKKyAgICB1c2JyZWRp
cnBhcnNlcl9mcmVlX3BhY2tldF9kYXRhKGNoLT5wYXJzZXIsIGRhdGEpOworfQorCitzdGF0aWMg
dm9pZCB1c2JyZWRpcl9idWxrX3BhY2tldCh2b2lkICpwcml2LAorICAgIHVpbnQ2NF90IGlkLCBz
dHJ1Y3QgdXNiX3JlZGlyX2J1bGtfcGFja2V0X2hlYWRlciAqaCwKKyAgICB1aW50OF90ICpkYXRh
LCBpbnQgZGF0YV9sZW4pCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2
OworICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqZCA9IGNoLT5hdHRhY2hlZDsKKyAgICBTcGlj
ZVVzYkVtdWxhdGVkRGV2aWNlICplZGV2ID0gZCA/IGQtPmVkZXYgOiBOVUxMOworICAgIHN0cnVj
dCB1c2JfcmVkaXJfYnVsa19wYWNrZXRfaGVhZGVyIGhvdXQgPSAqaDsKKyAgICB1aW50MzJfdCBs
ZW4gPSAoaC0+bGVuZ3RoX2hpZ2ggPDwgMTYpIHwgaC0+bGVuZ3RoOworICAgIFNQSUNFX0RFQlVH
KCIlcyAlcDogZXAgJVgsIGxlbiAldSwgaWQgJSIgR19HVUlOVDY0X0ZPUk1BVCwgX19GVU5DVElP
Tl9fLAorICAgICAgICAgICAgICAgIGNoLCBoLT5lbmRwb2ludCwgbGVuLCBpZCk7CisKKyAgICBp
ZiAoIWVkZXYpIHsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBkZXZpY2Ugbm90IGF0dGFjaGVk
IiwgX19GVU5DVElPTl9fKTsKKyAgICAgICAgaG91dC5zdGF0dXMgPSB1c2JfcmVkaXJfaW9lcnJv
cjsKKyAgICAgICAgaG91dC5sZW5ndGggPSBob3V0Lmxlbmd0aF9oaWdoID0gMDsKKyAgICAgICAg
U1BJQ0VfREVCVUcoIiVzOiByZXNwb25kaW5nIHdpdGggWkxQIHN0YXR1cyAlZCIsIF9fRlVOQ1RJ
T05fXywgaG91dC5zdGF0dXMpOworICAgIH0gZWxzZSBpZiAoaC0+ZW5kcG9pbnQgJiBMSUJVU0Jf
RU5EUE9JTlRfSU4pIHsKKyAgICAgICAgaWYgKGRldmljZV9vcHMoZWRldiktPmJ1bGtfaW5fcmVx
dWVzdChlZGV2LCBpZCwgJmhvdXQpKSB7CisgICAgICAgICAgICB1c2JyZWRpcnBhcnNlcl9mcmVl
X3BhY2tldF9kYXRhKGNoLT5wYXJzZXIsIGRhdGEpOworICAgICAgICAgICAgLyogY29tcGxldGlv
biBpcyBhc3luY2hyb25vdXMgKi8KKyAgICAgICAgICAgIHJldHVybjsKKyAgICAgICAgfQorICAg
IH0gZWxzZSB7CisgICAgICAgIGhvdXQuc3RhdHVzID0gdXNiX3JlZGlyX3N0YWxsOworICAgICAg
ICBkZXZpY2Vfb3BzKGVkZXYpLT5idWxrX291dF9yZXF1ZXN0KGVkZXYsIGgtPmVuZHBvaW50LCBk
YXRhLCBkYXRhX2xlbiwgJmhvdXQuc3RhdHVzKTsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBy
ZXNwb25kaW5nIHN0YXR1cyAlZCIsIF9fRlVOQ1RJT05fXywgaG91dC5zdGF0dXMpOworICAgIH0K
KworICAgIHVzYnJlZGlycGFyc2VyX3NlbmRfYnVsa19wYWNrZXQoY2gtPnBhcnNlciwgaWQsICZo
b3V0LCBOVUxMLCAwKTsKKyAgICB1c2JyZWRpcnBhcnNlcl9mcmVlX3BhY2tldF9kYXRhKGNoLT5w
YXJzZXIsIGRhdGEpOworICAgIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsKK30K
Kworc3RhdGljIHZvaWQgdXNicmVkaXJfZGV2aWNlX3Jlc2V0KHZvaWQgKnByaXYpCit7CisgICAg
U3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIFNwaWNlVXNiQmFja2VuZERl
dmljZSAqZCA9IGNoLT5hdHRhY2hlZDsKKyAgICBTcGljZVVzYkVtdWxhdGVkRGV2aWNlICplZGV2
ID0gZCA/IGQtPmVkZXYgOiBOVUxMOworICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCIsIF9fRlVO
Q1RJT05fXywgY2gpOworICAgIGlmIChlZGV2KSB7CisgICAgICAgIGRldmljZV9vcHMoZWRldikt
PnJlc2V0KGVkZXYpOworICAgIH0KK30KKworc3RhdGljIHZvaWQgdXNicmVkaXJfaW50ZXJmYWNl
X2luZm8odm9pZCAqcHJpdiwKKyAgICBzdHJ1Y3QgdXNiX3JlZGlyX2ludGVyZmFjZV9pbmZvX2hl
YWRlciAqaW50ZXJmYWNlX2luZm8pCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gg
PSBwcml2OworICAgIFNQSUNFX0RFQlVHKCIlcyBub3QgaW1wbGVtZW50ZWQgJXAiLCBfX0ZVTkNU
SU9OX18sIGNoKTsKK30KKworc3RhdGljIHZvaWQgdXNicmVkaXJfaW50ZXJmYWNlX2VwX2luZm8o
dm9pZCAqcHJpdiwKKyAgICBzdHJ1Y3QgdXNiX3JlZGlyX2VwX2luZm9faGVhZGVyICplcF9pbmZv
KQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBTUElDRV9E
RUJVRygiJXMgbm90IGltcGxlbWVudGVkICVwIiwgX19GVU5DVElPTl9fLCBjaCk7Cit9CisKK3N0
YXRpYyB2b2lkIHVzYnJlZGlyX3NldF9jb25maWd1cmF0aW9uKHZvaWQgKnByaXYsCisgICAgdWlu
dDY0X3QgaWQsIHN0cnVjdCB1c2JfcmVkaXJfc2V0X2NvbmZpZ3VyYXRpb25faGVhZGVyICpzZXRf
Y29uZmlndXJhdGlvbikKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7
CisgICAgc3RydWN0IHVzYl9yZWRpcl9jb25maWd1cmF0aW9uX3N0YXR1c19oZWFkZXIgaDsKKyAg
ICBoLnN0YXR1cyA9IDA7CisgICAgaC5jb25maWd1cmF0aW9uID0gc2V0X2NvbmZpZ3VyYXRpb24t
PmNvbmZpZ3VyYXRpb247CisgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwLCBjZmcgJWQiLCBfX0ZV
TkNUSU9OX18sIGNoLCBoLmNvbmZpZ3VyYXRpb24pOworICAgIGlmIChjaC0+YXR0YWNoZWQpIHsK
KyAgICAgICAgY2gtPmF0dGFjaGVkLT5lZGV2X2NvbmZpZ3VyZWQgPSBoLmNvbmZpZ3VyYXRpb24g
IT0gMDsKKyAgICB9CisgICAgdXNicmVkaXJwYXJzZXJfc2VuZF9jb25maWd1cmF0aW9uX3N0YXR1
cyhjaC0+cGFyc2VyLCBpZCwgJmgpOworICAgIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNr
KGNoKTsKK30KKworc3RhdGljIHZvaWQgdXNicmVkaXJfZ2V0X2NvbmZpZ3VyYXRpb24odm9pZCAq
cHJpdiwgdWludDY0X3QgaWQpCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBw
cml2OworICAgIHN0cnVjdCB1c2JfcmVkaXJfY29uZmlndXJhdGlvbl9zdGF0dXNfaGVhZGVyIGg7
CisgICAgaC5zdGF0dXMgPSAwOworICAgIGguY29uZmlndXJhdGlvbiA9IGNoLT5hdHRhY2hlZCAm
JiBjaC0+YXR0YWNoZWQtPmVkZXZfY29uZmlndXJlZDsKKyAgICBTUElDRV9ERUJVRygiJXMgY2gg
JXAsIGNmZyAlZCIsIF9fRlVOQ1RJT05fXywgY2gsIGguY29uZmlndXJhdGlvbik7CisgICAgdXNi
cmVkaXJwYXJzZXJfc2VuZF9jb25maWd1cmF0aW9uX3N0YXR1cyhjaC0+cGFyc2VyLCBpZCwgJmgp
OworICAgIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsKK30KKworc3RhdGljIHZv
aWQgdXNicmVkaXJfc2V0X2FsdF9zZXR0aW5nKHZvaWQgKnByaXYsCisgICAgdWludDY0X3QgaWQs
IHN0cnVjdCB1c2JfcmVkaXJfc2V0X2FsdF9zZXR0aW5nX2hlYWRlciAqcykKK3sKKyAgICBTcGlj
ZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgc3RydWN0IHVzYl9yZWRpcl9hbHRf
c2V0dGluZ19zdGF0dXNfaGVhZGVyIHNoOworICAgIHNoLnN0YXR1cyA9ICghcy0+aW50ZXJmYWNl
ICYmICFzLT5hbHQpID8gMCA6IHVzYl9yZWRpcl9zdGFsbDsKKyAgICBzaC5pbnRlcmZhY2UgPSBz
LT5pbnRlcmZhY2U7CisgICAgc2guYWx0ID0gcy0+YWx0OworICAgIFNQSUNFX0RFQlVHKCIlcyBj
aCAlcCwgJWQ6JWQiLCBfX0ZVTkNUSU9OX18sIGNoLCBzLT5pbnRlcmZhY2UsIHMtPmFsdCk7Cisg
ICAgdXNicmVkaXJwYXJzZXJfc2VuZF9hbHRfc2V0dGluZ19zdGF0dXMoY2gtPnBhcnNlciwgaWQs
ICZzaCk7CisgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2soY2gpOworfQorCitzdGF0
aWMgdm9pZCB1c2JyZWRpcl9nZXRfYWx0X3NldHRpbmcodm9pZCAqcHJpdiwKKyAgICB1aW50NjRf
dCBpZCwgc3RydWN0IHVzYl9yZWRpcl9nZXRfYWx0X3NldHRpbmdfaGVhZGVyICpzKQoreworICAg
IFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBzdHJ1Y3QgdXNiX3JlZGly
X2FsdF9zZXR0aW5nX3N0YXR1c19oZWFkZXIgc2g7CisgICAgc2guc3RhdHVzID0gKHMtPmludGVy
ZmFjZSA9PSAwKSA/IDAgOiB1c2JfcmVkaXJfc3RhbGw7CisgICAgc2guaW50ZXJmYWNlID0gcy0+
aW50ZXJmYWNlOworICAgIHNoLmFsdCA9IDA7CisgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwLCBp
ZiAlZCIsIF9fRlVOQ1RJT05fXywgY2gsIHMtPmludGVyZmFjZSk7CisgICAgdXNicmVkaXJwYXJz
ZXJfc2VuZF9hbHRfc2V0dGluZ19zdGF0dXMoY2gtPnBhcnNlciwgaWQsICZzaCk7CisgICAgdXNi
cmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2soY2gpOworfQorCitzdGF0aWMgdm9pZCB1c2JyZWRp
cl9jYW5jZWxfZGF0YSh2b2lkICpwcml2LCB1aW50NjRfdCBpZCkKK3sKKyAgICBTcGljZVVzYkJh
Y2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkID0g
Y2gtPmF0dGFjaGVkOworICAgIFNwaWNlVXNiRW11bGF0ZWREZXZpY2UgKmVkZXYgPSBkID8gZC0+
ZWRldiA6IE5VTEw7CisgICAgaWYgKCFlZGV2KSB7CisgICAgICAgIFNQSUNFX0RFQlVHKCIlczog
ZGV2aWNlIG5vdCBhdHRhY2hlZCIsIF9fRlVOQ1RJT05fXyk7CisgICAgICAgIHJldHVybjsKKyAg
ICB9CisgICAgZGV2aWNlX29wcyhlZGV2KS0+Y2FuY2VsX3JlcXVlc3QoZWRldiwgaWQpOworfQor
CitzdGF0aWMgdm9pZCB1c2JyZWRpcl9maWx0ZXJfcmVqZWN0KHZvaWQgKnByaXYpCit7CisgICAg
U3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIFNQSUNFX0RFQlVHKCIlcyAl
cCIsIF9fRlVOQ1RJT05fXywgY2gpOworICAgIGNoLT5yZWplY3RlZCA9IDE7Cit9CisKKy8qIE5v
dGUgdGhhdCB0aGUgb3duZXJzaGlwIG9mIHRoZSBydWxlcyBhcnJheSBpcyBwYXNzZWQgb24gdG8g
dGhlIGNhbGxiYWNrLiAqLworc3RhdGljIHZvaWQgdXNicmVkaXJfZmlsdGVyX2ZpbHRlcih2b2lk
ICpwcml2LAorICAgIHN0cnVjdCB1c2JyZWRpcmZpbHRlcl9ydWxlICpyLCBpbnQgY291bnQpCit7
CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIFNQSUNFX0RFQlVH
KCIlcyBjaCAlcCAlZCBmaWx0ZXJzIiwgX19GVU5DVElPTl9fLCBjaCwgY291bnQpOworCisgICAg
ZnJlZShjaC0+cnVsZXMpOworCisgICAgY2gtPnJ1bGVzID0gcjsKKyAgICBjaC0+cnVsZXNfY291
bnQgPSBjb3VudDsKKyAgICBpZiAoY291bnQpIHsKKyAgICAgICAgaW50IGk7CisgICAgICAgIGZv
ciAoaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CisgICAgICAgICAgICBTUElDRV9ERUJVRygiJXMg
Y2xhc3MgJWQsICVYOiVYIiwKKyAgICAgICAgICAgICAgICByW2ldLmFsbG93ID8gImFsbG93ZWQi
IDogImRlbmllZCIsIHJbaV0uZGV2aWNlX2NsYXNzLAorICAgICAgICAgICAgICAgICh1aW50MzJf
dClyW2ldLnZlbmRvcl9pZCwgKHVpbnQzMl90KXJbaV0ucHJvZHVjdF9pZCk7CisgICAgICAgIH0K
KyAgICB9Cit9CisKK3N0YXRpYyB2b2lkIHVzYnJlZGlyX2RldmljZV9kaXNjb25uZWN0X2Fjayh2
b2lkICpwcml2KQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAg
ICBTUElDRV9ERUJVRygiJXMgY2ggJXAiLCBfX0ZVTkNUSU9OX18sIGNoKTsKKyAgICBpZiAoY2gt
PnBhcnNlciAmJiBjaC0+d2FpdF9kaXNjX2FjaykgeworICAgICAgICBjaC0+cGFyc2VyID0gTlVM
TDsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzIHN3aXRjaCB0byB1c2JyZWRpcmhvc3QiLCBfX0ZV
TkNUSU9OX18pOworICAgICAgICBjaC0+dXNicmVkaXJob3N0ID0gY2gtPmhpZGRlbl9ob3N0Owor
ICAgIH0KKyAgICBjaC0+d2FpdF9kaXNjX2FjayA9IDA7Cit9CisKK3N0YXRpYyB2b2lkIHVzYnJl
ZGlyX2hlbGxvKHZvaWQgKnByaXYsCisgICAgc3RydWN0IHVzYl9yZWRpcl9oZWxsb19oZWFkZXIg
KmhlbGxvKQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBT
cGljZVVzYkJhY2tlbmREZXZpY2UgKmQgPSBjaC0+YXR0YWNoZWQ7CisgICAgU3BpY2VVc2JFbXVs
YXRlZERldmljZSAqZWRldiA9IGQgPyBkLT5lZGV2IDogTlVMTDsKKyAgICBzdHJ1Y3QgdXNiX3Jl
ZGlyX2RldmljZV9jb25uZWN0X2hlYWRlciBkZXZpY2VfY29ubmVjdDsKKyAgICBzdHJ1Y3QgdXNi
X3JlZGlyX2VwX2luZm9faGVhZGVyIGVwX2luZm8gPSB7IDAgfTsKKyAgICBzdHJ1Y3QgdXNiX3Jl
ZGlyX2ludGVyZmFjZV9pbmZvX2hlYWRlciBpbnRlcmZhY2VfaW5mbyA9IHsgMCB9OworICAgIHVp
bnQ4X3QgKmNmZzsKKyAgICB1aW50MTZfdCBzaXplLCBvZmZzZXQgPSAwOworICAgIFNQSUNFX0RF
QlVHKCIlcyAlcCAlc2F0dGFjaGVkICVzIiwgX19GVU5DVElPTl9fLCBjaCwKKyAgICAgICAgZWRl
diA/ICIiIDogIm5vdCAiLCAgaGVsbG8gPyAiIiA6ICIoaW50ZXJuYWwpIik7CisKKyAgICBpZiAo
aGVsbG8pIHsKKyAgICAgICAgY2gtPmhlbGxvX2RvbmVfcGFyc2VyID0gMTsKKyAgICB9CisgICAg
aWYgKCFlZGV2KSB7CisgICAgICAgIHJldHVybjsKKyAgICB9CisgICAgaWYgKCFkZXZpY2Vfb3Bz
KGVkZXYpLT5nZXRfZGVzY3JpcHRvcigKKyAgICAgICAgICAgIGVkZXYsIExJQlVTQl9EVF9DT05G
SUcsIDAsICh2b2lkICoqKSZjZmcsICZzaXplKSkgeworICAgICAgICByZXR1cm47CisgICAgfQor
ICAgIHdoaWxlICgob2Zmc2V0ICsgMSkgPCBzaXplKSB7CisgICAgICAgIHVpbnQ4X3QgbGVuICA9
IGNmZ1tvZmZzZXRdOworICAgICAgICB1aW50OF90IHR5cGUgPSBjZmdbb2Zmc2V0ICsgMV07Cisg
ICAgICAgIGlmICgob2Zmc2V0ICsgbGVuKSA+IHNpemUpIHsKKyAgICAgICAgICAgIGJyZWFrOwor
ICAgICAgICB9CisgICAgICAgIGlmICh0eXBlID09IExJQlVTQl9EVF9JTlRFUkZBQ0UpIHsKKyAg
ICAgICAgICAgIHVpbnQzMl90IGkgPSBpbnRlcmZhY2VfaW5mby5pbnRlcmZhY2VfY291bnQ7Cisg
ICAgICAgICAgICB1aW50OF90IGNsYXNzLCBzdWJjbGFzcywgcHJvdG9jb2w7CisgICAgICAgICAg
ICBjbGFzcyA9IGNmZ1tvZmZzZXQgKyA1XTsKKyAgICAgICAgICAgIHN1YmNsYXNzID0gY2ZnW29m
ZnNldCArIDZdOworICAgICAgICAgICAgcHJvdG9jb2wgPSBjZmdbb2Zmc2V0ICsgN107CisgICAg
ICAgICAgICBpbnRlcmZhY2VfaW5mby5pbnRlcmZhY2VfY2xhc3NbaV0gPSBjbGFzczsKKyAgICAg
ICAgICAgIGludGVyZmFjZV9pbmZvLmludGVyZmFjZV9zdWJjbGFzc1tpXSA9IHN1YmNsYXNzOwor
ICAgICAgICAgICAgaW50ZXJmYWNlX2luZm8uaW50ZXJmYWNlX3Byb3RvY29sW2ldID0gcHJvdG9j
b2w7CisgICAgICAgICAgICBpbnRlcmZhY2VfaW5mby5pbnRlcmZhY2VfY291bnQrKzsKKyAgICAg
ICAgICAgIFNQSUNFX0RFQlVHKCIlcyBJRiVkOiAlZC8lZC8lZCIsIF9fRlVOQ1RJT05fXywgaSwg
Y2xhc3MsIHN1YmNsYXNzLCBwcm90b2NvbCk7CisgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PSBM
SUJVU0JfRFRfRU5EUE9JTlQpIHsKKyAgICAgICAgICAgIHVpbnQ4X3QgYWRkcmVzcyA9IGNmZ1tv
ZmZzZXQgKyAyXTsKKyAgICAgICAgICAgIHVpbnQxNl90IG1heF9wYWNrZXRfc2l6ZSA9IDB4MTAw
ICogY2ZnW29mZnNldCArIDVdICsgY2ZnW29mZnNldCArIDRdOworICAgICAgICAgICAgdWludDhf
dCBpbmRleCA9IGFkZHJlc3MgJiAweGY7CisgICAgICAgICAgICBpZiAoYWRkcmVzcyAmIDB4ODAp
IGluZGV4ICs9IDB4MTA7CisgICAgICAgICAgICBlcF9pbmZvLnR5cGVbaW5kZXhdID0gY2ZnW29m
ZnNldCArIDNdICYgMHgzOworICAgICAgICAgICAgZXBfaW5mby5tYXhfcGFja2V0X3NpemVbaW5k
ZXhdID0gbWF4X3BhY2tldF9zaXplOworICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIEVQWyUw
MlhdOiAlZC8lZCIsIF9fRlVOQ1RJT05fXywgaW5kZXgsIGVwX2luZm8udHlwZVtpbmRleF0sIG1h
eF9wYWNrZXRfc2l6ZSk7CisgICAgICAgIH0KKyAgICAgICAgb2Zmc2V0ICs9IGxlbjsKKyAgICB9
CisKKyAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2ludGVyZmFjZV9pbmZvKGNoLT5wYXJzZXIsICZp
bnRlcmZhY2VfaW5mbyk7CisgICAgdXNicmVkaXJwYXJzZXJfc2VuZF9lcF9pbmZvKGNoLT5wYXJz
ZXIsICZlcF9pbmZvKTsKKworICAgIGRldmljZV9jb25uZWN0LmRldmljZV9jbGFzcyA9IDA7IC8v
ZC0+ZGV2aWNlX2luZm8uY2xhc3M7CisgICAgZGV2aWNlX2Nvbm5lY3QuZGV2aWNlX3N1YmNsYXNz
ID0gMDsgLy9kLT5kZXZpY2VfaW5mby5zdWJjbGFzczsKKyAgICBkZXZpY2VfY29ubmVjdC5kZXZp
Y2VfcHJvdG9jb2wgPSAwOyAvL2QtPmRldmljZV9pbmZvLnByb3RvY29sOzsKKyAgICBkZXZpY2Vf
Y29ubmVjdC52ZW5kb3JfaWQgPSBkLT5kZXZpY2VfaW5mby52aWQ7CisgICAgZGV2aWNlX2Nvbm5l
Y3QucHJvZHVjdF9pZCA9IGQtPmRldmljZV9pbmZvLnBpZDsKKyAgICBkZXZpY2VfY29ubmVjdC5k
ZXZpY2VfdmVyc2lvbl9iY2QgPSBkLT5kZXZpY2VfaW5mby5iY2RVU0I7CisgICAgZGV2aWNlX2Nv
bm5lY3Quc3BlZWQgPSB1c2JfcmVkaXJfc3BlZWRfaGlnaDsKKyAgICB1c2JyZWRpcnBhcnNlcl9z
ZW5kX2RldmljZV9jb25uZWN0KGNoLT5wYXJzZXIsICZkZXZpY2VfY29ubmVjdCk7CisgICAgdXNi
cmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2soY2gpOworfQorCitzdGF0aWMgdm9pZCBpbml0aWFs
aXplX3BhcnNlcihTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwgZ2Jvb2xlYW4gZG9faGVsbG8p
Cit7CisgICAgdWludDMyX3QgZmxhZ3MsIGNhcHNbVVNCX1JFRElSX0NBUFNfU0laRV0gPSB7IDAg
fTsKKworICAgIGdfcmV0dXJuX2lmX2ZhaWwoY2gtPmhpZGRlbl9wYXJzZXIgIT0gTlVMTCk7Cisg
ICAgaWYgKGNoLT5wYXJzZXJfaW5pdF9kb25lKSB7CisgICAgICAgIGlmIChjaC0+cGFyc2VyX3dp
dGhfaGVsbG8gIT0gZG9faGVsbG8pIHsKKyAgICAgICAgICAgIGdfcmV0dXJuX2lmX3JlYWNoZWQo
KTsKKyAgICAgICAgfQorICAgICAgICByZXR1cm47CisgICAgfQorCisgICAgY2gtPnBhcnNlcl9p
bml0X2RvbmUgPSAxOworICAgIGNoLT5wYXJzZXJfd2l0aF9oZWxsbyA9IGRvX2hlbGxvOworICAg
IGZsYWdzID0gdXNicmVkaXJwYXJzZXJfZmxfd3JpdGVfY2Jfb3duc19idWZmZXIgfCB1c2JyZWRp
cnBhcnNlcl9mbF91c2JfaG9zdDsKKworICAgIGlmIChkb19oZWxsbykgeworICAgICAgICBjaC0+
aGVsbG9fc2VudCA9IDE7CisgICAgICAgIGNoLT5ob3N0X2NhcHMgfD0gMSA8PCB1c2JfcmVkaXJf
Y2FwX2Nvbm5lY3RfZGV2aWNlX3ZlcnNpb247CisgICAgICAgIGNoLT5ob3N0X2NhcHMgfD0gMSA8
PCB1c2JfcmVkaXJfY2FwX2RldmljZV9kaXNjb25uZWN0X2FjazsKKyAgICAgICAgY2gtPmhvc3Rf
Y2FwcyB8PSAxIDw8IHVzYl9yZWRpcl9jYXBfZXBfaW5mb19tYXhfcGFja2V0X3NpemU7CisgICAg
ICAgIGNoLT5ob3N0X2NhcHMgfD0gMSA8PCB1c2JfcmVkaXJfY2FwXzY0Yml0c19pZHM7CisgICAg
ICAgIGNoLT5ob3N0X2NhcHMgfD0gMSA8PCB1c2JfcmVkaXJfY2FwXzMyYml0c19idWxrX2xlbmd0
aDsKKyAgICB9IGVsc2UgeworICAgICAgICBmbGFncyB8PSB1c2JyZWRpcnBhcnNlcl9mbF9ub19o
ZWxsbzsKKyAgICB9CisKKyAgICBpZiAoY2gtPmhvc3RfY2FwcyAmICgxIDw8IHVzYl9yZWRpcl9j
YXBfY29ubmVjdF9kZXZpY2VfdmVyc2lvbikpIHsKKyAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fw
c19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfY29ubmVjdF9kZXZpY2VfdmVyc2lvbik7Cisg
ICAgfQorICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJfY2Fw
X2ZpbHRlcik7CisgICAgaWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJfY2FwX2Rl
dmljZV9kaXNjb25uZWN0X2FjaykpIHsKKyAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRf
Y2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrKTsKKyAgICB9Cisg
ICAgaWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJfY2FwX2VwX2luZm9fbWF4X3Bh
Y2tldF9zaXplKSkgeworICAgICAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2Fwcywg
dXNiX3JlZGlyX2NhcF9lcF9pbmZvX21heF9wYWNrZXRfc2l6ZSk7CisgICAgfQorICAgIGlmIChj
aC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF82NGJpdHNfaWRzKSkgeworICAgICAg
ICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF82NGJpdHNf
aWRzKTsKKyAgICB9CisgICAgaWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJfY2Fw
XzMyYml0c19idWxrX2xlbmd0aCkpIHsKKyAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRf
Y2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfMzJiaXRzX2J1bGtfbGVuZ3RoKTsKKyAgICB9CisgICAg
aWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJfY2FwX2J1bGtfc3RyZWFtcykpIHsK
KyAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBf
YnVsa19zdHJlYW1zKTsKKyAgICB9CisgICAgdXNicmVkaXJwYXJzZXJfaW5pdChjaC0+aGlkZGVu
X3BhcnNlciwgUEFDS0FHRV9TVFJJTkcsIGNhcHMsIFVTQl9SRURJUl9DQVBTX1NJWkUsIGZsYWdz
KTsKK30KKworLyoKKyAgICBXZSBjYW4gaW5pdGlhbGl6ZSB0aGUgdXNicmVkaXJwYXJzZXIgd2l0
aCBIRUxMTyBlbmFibGVkIG9ubHkgaW4gY2FzZQorICAgIHRoZSBsaWJ1c2IgaXMgbm90IGFjdGl2
ZSBhbmQgdGhlIHVzYnJlZGlyaG9zdCBkb2VzIG5vdCBmdW5jdGlvbi4KKyAgICBUaGVuIHRoZSBw
YXJzZXIgc2VuZHMgc2Vzc2lvbiBIRUxMTyBhbmQgcmVjZWl2ZXMgc2VydmVyJ3MgcmVzcG9uc2Uu
CisgICAgT3RoZXJ3aXNlICh1c2JyZWRpcnBhcnNlciBpbml0aWFsaXplZCB3aXRoIEhFTExPIGRp
c2FibGVkKToKKyAgICAtIHRoZSB1c2JyZWRpcmhvc3Qgc2VuZHMgc2Vzc2lvbiBIRUxMTworICAg
IC0gd2UgbG9vayBpbnRvIGl0IHRvIGtub3cgc2V0IG9mIGNhcGFiaWxpdGllcyB3ZSBzaGFsbCBp
bml0aWFsaXplCisgICAgICB0aGUgcGFyc2VyIHdpdGgKKyAgICAtIHdoZW4gd2UgcmVjZWl2ZSBz
ZXJ2ZXIncyByZXNwb25zZSB0byBIRUxMTyB3ZSBwcm92aWRlIGl0IGFsc28gdG8KKyAgICAgIHBh
cnNlciB0byBsZXQgaXQgc3luY2hyb25pemUgd2l0aCBzZXJ2ZXIncyBjYXBhYmlsaXRpZXMKKyov
CitzdGF0aWMgc3RydWN0IHVzYnJlZGlycGFyc2VyICpjcmVhdGVfcGFyc2VyKFNwaWNlVXNiQmFj
a2VuZENoYW5uZWwgKmNoKQoreworICAgIHN0cnVjdCB1c2JyZWRpcnBhcnNlciAqcGFyc2VyID0g
dXNicmVkaXJwYXJzZXJfY3JlYXRlKCk7CisKKyAgICBnX3JldHVybl92YWxfaWZfZmFpbChwYXJz
ZXIgIT0gTlVMTCwgTlVMTCk7CisKKyAgICBwYXJzZXItPnByaXYgPSBjaDsKKyAgICBwYXJzZXIt
PmxvZ19mdW5jID0gdXNicmVkaXJfbG9nOworICAgIHBhcnNlci0+cmVhZF9mdW5jID0gdXNicmVk
aXJfcmVhZF9jYWxsYmFjazsKKyAgICBwYXJzZXItPndyaXRlX2Z1bmMgPSB1c2JyZWRpcl93cml0
ZV9jYWxsYmFjazsKKyAgICBwYXJzZXItPnJlc2V0X2Z1bmMgPSB1c2JyZWRpcl9kZXZpY2VfcmVz
ZXQ7CisgICAgcGFyc2VyLT5zZXRfY29uZmlndXJhdGlvbl9mdW5jID0gdXNicmVkaXJfc2V0X2Nv
bmZpZ3VyYXRpb247CisgICAgcGFyc2VyLT5nZXRfY29uZmlndXJhdGlvbl9mdW5jID0gdXNicmVk
aXJfZ2V0X2NvbmZpZ3VyYXRpb247CisgICAgcGFyc2VyLT5zZXRfYWx0X3NldHRpbmdfZnVuYyA9
IHVzYnJlZGlyX3NldF9hbHRfc2V0dGluZzsKKyAgICBwYXJzZXItPmdldF9hbHRfc2V0dGluZ19m
dW5jID0gdXNicmVkaXJfZ2V0X2FsdF9zZXR0aW5nOworICAgIHBhcnNlci0+Y2FuY2VsX2RhdGFf
cGFja2V0X2Z1bmMgPSB1c2JyZWRpcl9jYW5jZWxfZGF0YTsKKyAgICBwYXJzZXItPmNvbnRyb2xf
cGFja2V0X2Z1bmMgPSB1c2JyZWRpcl9jb250cm9sX3BhY2tldDsKKyAgICBwYXJzZXItPmJ1bGtf
cGFja2V0X2Z1bmMgPSB1c2JyZWRpcl9idWxrX3BhY2tldDsKKyAgICBwYXJzZXItPmFsbG9jX2xv
Y2tfZnVuYyA9IHVzYnJlZGlyX2FsbG9jX2xvY2s7CisgICAgcGFyc2VyLT5sb2NrX2Z1bmMgPSB1
c2JyZWRpcl9sb2NrX2xvY2s7CisgICAgcGFyc2VyLT51bmxvY2tfZnVuYyA9IHVzYnJlZGlyX3Vu
bG9ja19sb2NrOworICAgIHBhcnNlci0+ZnJlZV9sb2NrX2Z1bmMgPSB1c2JyZWRpcl9mcmVlX2xv
Y2s7CisgICAgcGFyc2VyLT5oZWxsb19mdW5jID0gdXNicmVkaXJfaGVsbG87CisgICAgcGFyc2Vy
LT5maWx0ZXJfcmVqZWN0X2Z1bmMgPSB1c2JyZWRpcl9maWx0ZXJfcmVqZWN0OworICAgIHBhcnNl
ci0+ZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrX2Z1bmMgPSB1c2JyZWRpcl9kZXZpY2VfZGlzY29ubmVj
dF9hY2s7CisgICAgcGFyc2VyLT5pbnRlcmZhY2VfaW5mb19mdW5jID0gdXNicmVkaXJfaW50ZXJm
YWNlX2luZm87CisgICAgcGFyc2VyLT5lcF9pbmZvX2Z1bmMgPSB1c2JyZWRpcl9pbnRlcmZhY2Vf
ZXBfaW5mbzsKKyAgICBwYXJzZXItPmZpbHRlcl9maWx0ZXJfZnVuYyA9IHVzYnJlZGlyX2ZpbHRl
cl9maWx0ZXI7CisKKyAgICByZXR1cm4gcGFyc2VyOworfQorCitzdGF0aWMgZ2Jvb2xlYW4gYXR0
YWNoX2VkZXYoU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkZXYsCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgR0Vycm9yICoqZXJyb3IpCit7CisgICAgaWYgKCFkZXYtPmVkZXYpIHsKKyAgICAg
ICAgZ19zZXRfZXJyb3IoZXJyb3IsIFNQSUNFX0NMSUVOVF9FUlJPUiwgU1BJQ0VfQ0xJRU5UX0VS
Uk9SX0ZBSUxFRCwKKyAgICAgICAgICAgXygiRmFpbGVkIHRvIHJlZGlyZWN0IGRldmljZSAlZCIp
LCAxKTsKKyAgICAgICAgcmV0dXJuIEZBTFNFOworICAgIH0KKyAgICBpZiAoY2gtPnVzYnJlZGly
aG9zdCAmJiAhY2gtPmhlbGxvX2RvbmVfcGFyc2VyKSB7CisgICAgICAgIC8qCisgICAgICAgICAg
ICB3ZSBjYW4ndCBpbml0aWFsaXplIHBhcnNlciB1bnRpbCB3ZSBzZWUgaGVsbG8gZnJvbSB1c2Jy
ZWRpcgorICAgICAgICAgICAgYW5kIHRoZSBwYXJzZXIgY2FuJ3Qgd29yayB1bnRpbCBpdCBzZWVz
IHRoZSBoZWxsbyByZXNwb25zZS4KKyAgICAgICAgICAgIHRoaXMgaXMgY2FzZSBvZiBhdXRvY29u
bmVjdCB3aGVuIGVtdWxhdGVkIGRldmljZSBpcyBhdHRhY2hlZAorICAgICAgICAgICAgYmVmb3Jl
IHRoZSBjaGFubmVsIGlzIHVwCisgICAgICAgICovCisgICAgICAgIFNQSUNFX0RFQlVHKCIlcyB3
YWl0aW5nIHVudGlsIHRoZSBjaGFubmVsIGlzIHJlYWR5IiwgX19GVU5DVElPTl9fKTsKKworICAg
IH0gZWxzZSB7CisgICAgICAgIGluaXRpYWxpemVfcGFyc2VyKGNoLCBjaC0+aGlkZGVuX2hvc3Qg
PT0gTlVMTCk7CisgICAgICAgIGNoLT51c2JyZWRpcmhvc3QgPSBOVUxMOworICAgICAgICBjaC0+
cGFyc2VyID0gY2gtPmhpZGRlbl9wYXJzZXI7CisgICAgfQorICAgIGNoLT53YWl0X2Rpc2NfYWNr
ID0gMDsKKyAgICBjaC0+YXR0YWNoZWQgPSBkZXY7CisgICAgZGV2LT5hdHRhY2hlZF90byA9IGNo
OworICAgIGRldmljZV9vcHMoZGV2LT5lZGV2KS0+YXR0YWNoKGRldi0+ZWRldiwgY2gtPmhpZGRl
bl9wYXJzZXIpOworICAgIGlmIChjaC0+aGVsbG9fZG9uZV9wYXJzZXIpIHsKKyAgICAgICAgLyog
c2VuZCBkZXZpY2UgaW5mbyAqLworICAgICAgICB1c2JyZWRpcl9oZWxsbyhjaCwgTlVMTCk7Cisg
ICAgfQorICAgIHJldHVybiBUUlVFOworfQorCiBnYm9vbGVhbiBzcGljZV91c2JfYmFja2VuZF9j
aGFubmVsX2F0dGFjaChTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwKICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqZGV2LAog
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgR0Vycm9yICoqZXJyb3Ip
CkBAIC03MDYsNyArMTIyMiwxMyBAQCBnYm9vbGVhbiBzcGljZV91c2JfYmFja2VuZF9jaGFubmVs
X2F0dGFjaChTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwKIAogICAgIGdfcmV0dXJuX3ZhbF9p
Zl9mYWlsKGRldiAhPSBOVUxMLCBGQUxTRSk7CiAKKyAgICBpZiAoIWRldi0+bGlidXNiX2Rldmlj
ZSkgeworICAgICAgICByZXR1cm4gYXR0YWNoX2VkZXYoY2gsIGRldiwgZXJyb3IpOworICAgIH0K
KwogICAgIGxpYnVzYl9kZXZpY2VfaGFuZGxlICpoYW5kbGUgPSBOVUxMOworICAgIGNoLT51c2Jy
ZWRpcmhvc3QgPSBjaC0+aGlkZGVuX2hvc3Q7CisgICAgY2gtPnBhcnNlciA9IE5VTEw7CiAKICAg
ICAvKgogICAgICAgIFVuZGVyIFdpbmRvd3Mgd2UgbmVlZCB0byBhdm9pZCB1cGRhdGluZwpAQCAt
NzQwLDE4ICsxMjYyLDMzIEBAIGdib29sZWFuIHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfYXR0
YWNoKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLAogCiB2b2lkIHNwaWNlX3VzYl9iYWNrZW5k
X2NoYW5uZWxfZGV0YWNoKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoKQogeworICAgIFNwaWNl
VXNiQmFja2VuZERldmljZSAqZCA9IGNoLT5hdHRhY2hlZDsKKyAgICBTcGljZVVzYkVtdWxhdGVk
RGV2aWNlICplZGV2ID0gZCA/IGQtPmVkZXYgOiBOVUxMOwogICAgIFNQSUNFX0RFQlVHKCIlcyA+
PiBjaCAlcCwgd2FzIGF0dGFjaGVkICVwIiwgX19GVU5DVElPTl9fLCBjaCwgY2gtPmF0dGFjaGVk
KTsKLSAgICBpZiAoIWNoLT5hdHRhY2hlZCkgeworICAgIGlmICghZCkgewogICAgICAgICBTUElD
RV9ERUJVRygiJXM6IG5vdGhpbmcgdG8gZGV0YWNoIiwgX19GVU5DVElPTl9fKTsKICAgICAgICAg
cmV0dXJuOwogICAgIH0KICAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgewogICAgICAgICAvKiBp
dCB3aWxsIGNhbGwgbGlidXNiX2Nsb3NlIGludGVybmFsbHkgKi8KICAgICAgICAgdXNicmVkaXJo
b3N0X3NldF9kZXZpY2UoY2gtPnVzYnJlZGlyaG9zdCwgTlVMTCk7CisgICAgfSBlbHNlIGlmIChj
aC0+cGFyc2VyKSB7CisgICAgICAgIGlmIChlZGV2KSB7CisgICAgICAgICAgICBkZXZpY2Vfb3Bz
KGVkZXYpLT5kZXRhY2goZWRldik7CisgICAgICAgIH0KKyAgICAgICAgdXNicmVkaXJwYXJzZXJf
c2VuZF9kZXZpY2VfZGlzY29ubmVjdChjaC0+cGFyc2VyKTsKKyAgICAgICAgdXNicmVkaXJfd3Jp
dGVfZmx1c2hfY2FsbGJhY2soY2gpOworICAgICAgICBjaC0+d2FpdF9kaXNjX2FjayA9IHVzYnJl
ZGlycGFyc2VyX3BlZXJfaGFzX2NhcChjaC0+cGFyc2VyLAorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2JfcmVkaXJfY2FwX2RldmljZV9k
aXNjb25uZWN0X2Fjayk7CisgICAgICAgIGlmICghY2gtPndhaXRfZGlzY19hY2spIHsKKyAgICAg
ICAgICAgIGNoLT51c2JyZWRpcmhvc3QgPSBjaC0+aGlkZGVuX2hvc3Q7CisgICAgICAgICAgICBj
aC0+cGFyc2VyID0gTlVMTDsKKyAgICAgICAgfQogICAgIH0KICAgICBTUElDRV9ERUJVRygiJXMg
Y2ggJXAsIGRldGFjaCBkb25lIiwgX19GVU5DVElPTl9fLCBjaCk7CiAgICAgY2gtPmF0dGFjaGVk
LT5hdHRhY2hlZF90byA9IE5VTEw7CiAgICAgY2gtPmF0dGFjaGVkID0gTlVMTDsKKyAgICBjaC0+
cmVqZWN0ZWQgPSAwOwogfQogCiBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpzcGljZV91c2JfYmFj
a2VuZF9jaGFubmVsX25ldyhTcGljZVVzYkJhY2tlbmQgKmJlLApAQCAtNzgyLDEwICsxMzE5LDE1
IEBAIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKnNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfbmV3
KFNwaWNlVXNiQmFja2VuZCAqYmUsCiAgICAgICAgICAgICB1c2JyZWRpcmhvc3RfZmxfd3JpdGVf
Y2Jfb3duc19idWZmZXIpOwogICAgICAgICBnX3dhcm5faWZfZmFpbChjaC0+dXNicmVkaXJob3N0
ICE9IE5VTEwpOwogICAgIH0KKwogICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7CisgICAgICAg
IGNoLT5oaWRkZW5fcGFyc2VyID0gY3JlYXRlX3BhcnNlcihjaCk7CisgICAgICAgIGNoLT5oaWRk
ZW5faG9zdCA9IGNoLT51c2JyZWRpcmhvc3Q7CiAgICAgICAgIHVzYnJlZGlyaG9zdF9zZXRfYnVm
ZmVyZWRfb3V0cHV0X3NpemVfY2IoY2gtPnVzYnJlZGlyaG9zdCwgdXNicmVkaXJfYnVmZmVyZWRf
b3V0cHV0X3NpemVfY2FsbGJhY2spOwotICAgIH0gZWxzZSB7Ci0gICAgICAgIGdfZnJlZShjaCk7
CisgICAgfQorCisgICAgaWYgKCFjaC0+aGlkZGVuX3BhcnNlcikgeworICAgICAgICBzcGljZV91
c2JfYmFja2VuZF9jaGFubmVsX2RlbGV0ZShjaCk7CiAgICAgICAgIGNoID0gTlVMTDsKICAgICB9
CiAKQEAgLTc5NSw5ICsxMzM3LDE0IEBAIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKnNwaWNlX3Vz
Yl9iYWNrZW5kX2NoYW5uZWxfbmV3KFNwaWNlVXNiQmFja2VuZCAqYmUsCiAKIHZvaWQgc3BpY2Vf
dXNiX2JhY2tlbmRfY2hhbm5lbF9mbHVzaF93cml0ZXMoU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAq
Y2gpCiB7Ci0gICAgU1BJQ0VfREVCVUcoIiVzICVwLCBob3N0ICVwIiwgX19GVU5DVElPTl9fLCBj
aCwgY2gtPnVzYnJlZGlyaG9zdCk7CisgICAgU1BJQ0VfREVCVUcoIiVzICVwIGlzIHVwIiwgX19G
VU5DVElPTl9fLCBjaCk7CiAgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKICAgICAgICAgdXNi
cmVkaXJob3N0X3dyaXRlX2d1ZXN0X2RhdGEoY2gtPnVzYnJlZGlyaG9zdCk7CisgICAgICAgIGlu
aXRpYWxpemVfcGFyc2VyKGNoLCBGQUxTRSk7CisgICAgfSBlbHNlIHsKKyAgICAgICAgaW5pdGlh
bGl6ZV9wYXJzZXIoY2gsIFRSVUUpOworICAgICAgICBjaC0+cGFyc2VyID0gY2gtPmhpZGRlbl9w
YXJzZXI7CisgICAgICAgIHVzYnJlZGlycGFyc2VyX2RvX3dyaXRlKGNoLT5wYXJzZXIpOwogICAg
IH0KIH0KIApAQCAtODA3LDEyICsxMzU0LDE2IEBAIHZvaWQgc3BpY2VfdXNiX2JhY2tlbmRfY2hh
bm5lbF9kZWxldGUoU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gpCiAgICAgaWYgKCFjaCkgewog
ICAgICAgICByZXR1cm47CiAgICAgfQotICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7Ci0gICAg
ICAgIHVzYnJlZGlyaG9zdF9jbG9zZShjaC0+dXNicmVkaXJob3N0KTsKKyAgICBpZiAoY2gtPmhp
ZGRlbl9ob3N0KSB7CisgICAgICAgIHVzYnJlZGlyaG9zdF9jbG9zZShjaC0+aGlkZGVuX2hvc3Qp
OworICAgIH0KKyAgICBpZiAoY2gtPmhpZGRlbl9wYXJzZXIpIHsKKyAgICAgICAgdXNicmVkaXJw
YXJzZXJfZGVzdHJveShjaC0+aGlkZGVuX3BhcnNlcik7CiAgICAgfQogCiAgICAgaWYgKGNoLT5y
dWxlcykgewotICAgICAgICBnX2ZyZWUoY2gtPnJ1bGVzKTsKKyAgICAgICAgLyogcnVsZXMgd2Vy
ZSBhbGxvY2F0ZWQgYnkgdXNicmVkaXJwYXJzZXIgKi8KKyAgICAgICAgZnJlZShjaC0+cnVsZXMp
OwogICAgIH0KIAogICAgIGdfZnJlZShjaCk7Ci0tIAoyLjIwLjEKCl9fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClNwaWNlLWRldmVsIG1haWxpbmcgbGlzdApT
cGljZS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6Ly9saXN0cy5mcmVlZGVza3Rv
cC5vcmcvbWFpbG1hbi9saXN0aW5mby9zcGljZS1kZXZlbA==
