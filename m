Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 155C6762CD
	for <lists+spice-devel@lfdr.de>; Fri, 26 Jul 2019 11:52:27 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 540756ED04;
	Fri, 26 Jul 2019 09:52:25 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id C1C666ED06
 for <spice-devel@lists.freedesktop.org>; Fri, 26 Jul 2019 09:52:23 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx06.intmail.prod.int.phx2.redhat.com
 [10.5.11.16])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 6AD483082129;
 Fri, 26 Jul 2019 09:52:23 +0000 (UTC)
Received: from fziglio.remote.csb (unknown [10.33.32.15])
 by smtp.corp.redhat.com (Postfix) with ESMTP id A7EA55F9DD;
 Fri, 26 Jul 2019 09:52:22 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Fri, 26 Jul 2019 10:52:12 +0100
Message-Id: <20190726095213.15655-6-fziglio@redhat.com>
In-Reply-To: <20190726095213.15655-1-fziglio@redhat.com>
References: <20190726095213.15655-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.16
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.42]); Fri, 26 Jul 2019 09:52:23 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-gtk v3 5/6] spice-session: Keep track of
 the global streams lag
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: Francois Gouget <fgouget@codeweavers.com>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

RnJvbTogRnJhbmNvaXMgR291Z2V0IDxmZ291Z2V0QGNvZGV3ZWF2ZXJzLmNvbT4KCkVhY2ggdmlk
ZW8gYW5kIGF1ZGlvIHN0cmVhbSBoYXMgaXRzIG93biBsYWc6IGZvciB2aWRlbyBzdHJlYW1zIGl0
IGlzCnRoZSBkZWNvZGluZyB0aW1lIGFuZCBmb3IgYXVkaW8gb25lcyBidWZmZXJpbmcgYnkgdGhl
IGF1ZGlvIHN1YnN5c3RlbS4KVGhlIG9ubHkgd2F5IHRvIGtlZXAgdGhlbSBhbGwgaW4gc3luYyBp
cyB0byBzeW5jaHJvbml6ZSB0byB0aGUgbW9zdApsYWdneSBzdHJlYW0uCgpTaWduZWQtb2ZmLWJ5
OiBGcmFuY29pcyBHb3VnZXQgPGZnb3VnZXRAY29kZXdlYXZlcnMuY29tPgotLS0KIHNyYy9jaGFu
bmVsLWRpc3BsYXktZ3N0LmMgICB8ICA5ICsrKysrKysrCiBzcmMvY2hhbm5lbC1kaXNwbGF5LW1q
cGVnLmMgfCAgNiArKysrKysKIHNyYy9jaGFubmVsLWRpc3BsYXktcHJpdi5oICB8ICA0ICsrKysK
IHNyYy9jaGFubmVsLWRpc3BsYXkuYyAgICAgICB8IDMzICsrKysrKysrKysrKysrKysrKysrKysr
KysrKy0tCiBzcmMvY2hhbm5lbC1kaXNwbGF5LmggICAgICAgfCAgMiArKwogc3JjL2NoYW5uZWwt
cGxheWJhY2stcHJpdi5oIHwgIDMgKystCiBzcmMvY2hhbm5lbC1wbGF5YmFjay5jICAgICAgfCAy
MiArKysrKysrKysrKysrKysrLS0tCiBzcmMvc3BpY2Utc2Vzc2lvbi1wcml2LmggICAgfCAgNiAr
KysrKy0KIHNyYy9zcGljZS1zZXNzaW9uLmMgICAgICAgICB8IDQyICsrKysrKysrKysrKysrKysr
KysrKysrKysrKysrKysrKysrLS0KIDkgZmlsZXMgY2hhbmdlZCwgMTE4IGluc2VydGlvbnMoKyks
IDkgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvc3JjL2NoYW5uZWwtZGlzcGxheS1nc3QuYyBi
L3NyYy9jaGFubmVsLWRpc3BsYXktZ3N0LmMKaW5kZXggMTFkNzhhZmMuLmUxOWNmYTczIDEwMDY0
NAotLS0gYS9zcmMvY2hhbm5lbC1kaXNwbGF5LWdzdC5jCisrKyBiL3NyYy9jaGFubmVsLWRpc3Bs
YXktZ3N0LmMKQEAgLTQ1NCw2ICs0NTQsMTUgQEAgc2lua19ldmVudF9wcm9iZShHc3RQYWQgKnBh
ZCwgR3N0UGFkUHJvYmVJbmZvICppbmZvLCBncG9pbnRlciBkYXRhKQogICAgICAgICAgICAgICAg
ICAgIGZyYW1lLT5tbV90aW1lLCBmcmFtZS0+c2l6ZSwgZnJhbWUtPmNyZWF0aW9uX3RpbWUsIGR1
cmF0aW9uLAogICAgICAgICAgICAgICAgICAgIGRlY29kZXItPmRlY29kaW5nX3F1ZXVlLT5sZW5n
dGgsIGdzdGZyYW1lLT5xdWV1ZV9sZW4pOwogCisgICAgICAgICAgICAvKiBBbmQgdGhlIGF2ZXJh
Z2UgZGVjb2RpbmcgdGltZS4gT25seSB0YWtlIGludG8gYWNjb3VudCBmcmFtZXMKKyAgICAgICAg
ICAgICAqIHRoYXQgd2VyZSBub3QgZGVsYXllZCAoc2VlIGFib3ZlKSwgb3IgdGhhdCBwcm92ZSB0
aGUgY3VycmVudAorICAgICAgICAgICAgICogYXZlcmFnZSBpcyBjbGVhcmx5IG92ZXJlc3RpbWF0
ZWQuCisgICAgICAgICAgICAgKi8KKyAgICAgICAgICAgIGlmIChnc3RmcmFtZS0+cXVldWVfbGVu
IDwgTUFYX0RFQ09ERURfRlJBTUVTIHx8CisgICAgICAgICAgICAgICAgZHVyYXRpb24gLyAxMDAw
IDwgZGVjb2Rlci0+YmFzZS5kZWNvZGluZ190aW1lKSB7CisgICAgICAgICAgICAgICAgZGVjb2Rl
ci0+YmFzZS5kZWNvZGluZ190aW1lID0gKGRlY29kZXItPmJhc2UuZGVjb2RpbmdfdGltZSAqIDE1
ICsgZHVyYXRpb24gLyAxMDAwKSAvIDE2OworICAgICAgICAgICAgfQorCiAgICAgICAgICAgICBp
ZiAoIWRlY29kZXItPmFwcHNpbmspIHsKICAgICAgICAgICAgICAgICAvKiBUaGUgc2luayB3aWxs
IGRpc3BsYXkgdGhlIGZyYW1lIGRpcmVjdGx5IHNvIHRoaXMKICAgICAgICAgICAgICAgICAgKiBT
cGljZUdzdEZyYW1lIGFuZCB0aG9zZSBvZiBhbnkgZHJvcHBlZCBmcmFtZSBhcmUgbm8gbG9uZ2Vy
CmRpZmYgLS1naXQgYS9zcmMvY2hhbm5lbC1kaXNwbGF5LW1qcGVnLmMgYi9zcmMvY2hhbm5lbC1k
aXNwbGF5LW1qcGVnLmMKaW5kZXggYjA1ODQyNGUuLjIwZTEwZDliIDEwMDY0NAotLS0gYS9zcmMv
Y2hhbm5lbC1kaXNwbGF5LW1qcGVnLmMKKysrIGIvc3JjL2NoYW5uZWwtZGlzcGxheS1tanBlZy5j
CkBAIC04Niw2ICs4Niw3IEBAIHN0YXRpYyBnYm9vbGVhbiBtanBlZ19kZWNvZGVyX2RlY29kZV9m
cmFtZShncG9pbnRlciB2aWRlb19kZWNvZGVyKQogICAgIEpESU1FTlNJT04gd2lkdGgsIGhlaWdo
dDsKICAgICB1aW50OF90ICpkZXN0OwogICAgIHVpbnQ4X3QgKmxpbmVzWzRdOworICAgIGludDY0
X3Qgc3RhcnQgPSBnX2dldF9tb25vdG9uaWNfdGltZSgpOwogCiAgICAganBlZ19yZWFkX2hlYWRl
cigmZGVjb2Rlci0+bWpwZWdfY2luZm8sIDEpOwogICAgIHdpZHRoID0gZGVjb2Rlci0+bWpwZWdf
Y2luZm8uaW1hZ2Vfd2lkdGg7CkBAIC0xNTYsNiArMTU3LDExIEBAIHN0YXRpYyBnYm9vbGVhbiBt
anBlZ19kZWNvZGVyX2RlY29kZV9mcmFtZShncG9pbnRlciB2aWRlb19kZWNvZGVyKQogICAgIH0K
ICAgICBqcGVnX2ZpbmlzaF9kZWNvbXByZXNzKCZkZWNvZGVyLT5tanBlZ19jaW5mbyk7CiAKKyAg
ICB1aW50MzJfdCBkdXJhdGlvbiA9IChnX2dldF9tb25vdG9uaWNfdGltZSgpIC0gc3RhcnQpIC8g
MTAwMDsKKyAgICBkZWNvZGVyLT5iYXNlLmRlY29kaW5nX3RpbWUgPSBkZWNvZGVyLT5iYXNlLmRl
Y29kaW5nX3RpbWUgPworICAgICAgICAoZGVjb2Rlci0+YmFzZS5kZWNvZGluZ190aW1lICogMTUg
KyBkdXJhdGlvbikgLyAxNiA6CisgICAgICAgIGR1cmF0aW9uOworCiAgICAgLyogRGlzcGxheSB0
aGUgZnJhbWUgYW5kIGRpc3Bvc2Ugb2YgaXQgKi8KICAgICBzdHJlYW1fZGlzcGxheV9mcmFtZShk
ZWNvZGVyLT5iYXNlLnN0cmVhbSwgZGVjb2Rlci0+Y3VyX2ZyYW1lLAogICAgICAgICAgICAgICAg
ICAgICAgICAgIHdpZHRoLCBoZWlnaHQsIFNQSUNFX1VOS05PV05fU1RSSURFLCBkZWNvZGVyLT5v
dXRfZnJhbWUpOwpkaWZmIC0tZ2l0IGEvc3JjL2NoYW5uZWwtZGlzcGxheS1wcml2LmggYi9zcmMv
Y2hhbm5lbC1kaXNwbGF5LXByaXYuaAppbmRleCA1ZGJhNjY5Yi4uMmNlNWU4MGUgMTAwNjQ0Ci0t
LSBhL3NyYy9jaGFubmVsLWRpc3BsYXktcHJpdi5oCisrKyBiL3NyYy9jaGFubmVsLWRpc3BsYXkt
cHJpdi5oCkBAIC03Niw2ICs3Niw5IEBAIHN0cnVjdCBWaWRlb0RlY29kZXIgewogCiAgICAgLyog
VGhlIGFzc29jaWF0ZWQgZGlzcGxheSBzdHJlYW0uICovCiAgICAgZGlzcGxheV9zdHJlYW0gKnN0
cmVhbTsKKworICAgIC8qIFRoZSBhdmVyYWdlIHRpbWUgaXQgdGFrZXMgdG8gZGVjb2RlIGEgZnJh
bWUuICovCisgICAgZmxvYXQgZGVjb2RpbmdfdGltZTsKIH07CiAKIApAQCAtMTIyLDYgKzEyNSw3
IEBAIHN0cnVjdCBkaXNwbGF5X3N0cmVhbSB7CiAgICAgaW50ICAgICAgICAgICAgICAgICAgICAg
ICAgIGhhdmVfcmVnaW9uOwogCiAgICAgVmlkZW9EZWNvZGVyICAgICAgICAgICAgICAgICp2aWRl
b19kZWNvZGVyOworICAgIGd1aW50ICAgICAgICAgICAgICAgICAgICAgICBkZWNvZGVyX2xhZzsK
IAogICAgIFNwaWNlQ2hhbm5lbCAgICAgICAgICAgICAgICAqY2hhbm5lbDsKIApkaWZmIC0tZ2l0
IGEvc3JjL2NoYW5uZWwtZGlzcGxheS5jIGIvc3JjL2NoYW5uZWwtZGlzcGxheS5jCmluZGV4IGMw
YjczYzUxLi4zYTJjZDlhZiAxMDA2NDQKLS0tIGEvc3JjL2NoYW5uZWwtZGlzcGxheS5jCisrKyBi
L3NyYy9jaGFubmVsLWRpc3BsYXkuYwpAQCAtMTQ2Miw2ICsxNDYyLDI3IEBAIHZvaWQgc3RyZWFt
X2Rpc3BsYXlfZnJhbWUoZGlzcGxheV9zdHJlYW0gKnN0LCBTcGljZUZyYW1lICpmcmFtZSwKICAg
ICB9CiB9CiAKK0dfR05VQ19JTlRFUk5BTAorZ3VpbnQzMiBzcGljZV9kaXNwbGF5X2NoYW5uZWxf
Z2V0X2xhZyhTcGljZURpc3BsYXlDaGFubmVsICpjaGFubmVsKQoreworICAgIFNwaWNlRGlzcGxh
eUNoYW5uZWxQcml2YXRlICpjID0gU1BJQ0VfRElTUExBWV9DSEFOTkVMKGNoYW5uZWwpLT5wcml2
OworICAgIGludCBpOworICAgIGd1aW50IGxhZzsKKworICAgIGxhZyA9IDA7CisgICAgaWYgKGMt
PnN0cmVhbXMpIHsKKyAgICAgICAgZm9yIChpID0gMDsgaSA8IGMtPm5zdHJlYW1zOyBpKyspIHsK
KyAgICAgICAgICAgIGRpc3BsYXlfc3RyZWFtICpzdCA9IGMtPnN0cmVhbXNbaV07CisgICAgICAg
ICAgICBpZiAoc3QgIT0gTlVMTCAmJiBzdC0+dmlkZW9fZGVjb2RlcikgeworICAgICAgICAgICAg
ICAgIHN0LT5kZWNvZGVyX2xhZyA9IHN0LT52aWRlb19kZWNvZGVyLT5kZWNvZGluZ190aW1lOwor
ICAgICAgICAgICAgICAgIGxhZyA9IE1BWChsYWcsIHN0LT5kZWNvZGVyX2xhZyk7CisgICAgICAg
ICAgICB9CisgICAgICAgIH0KKyAgICB9CisKKyAgICByZXR1cm4gbGFnOworfQorCiBHX0dOVUNf
SU5URVJOQUwKIGdib29sZWFuIGhhbmRfcGlwZWxpbmVfdG9fd2lkZ2V0KGRpc3BsYXlfc3RyZWFt
ICpzdCwgR3N0UGlwZWxpbmUgKnBpcGVsaW5lKQogewpAQCAtMTUxOCw3ICsxNTM5LDcgQEAgc3Rh
dGljIHZvaWQgZGlzcGxheV91cGRhdGVfc3RyZWFtX3JlcG9ydChTcGljZURpc3BsYXlDaGFubmVs
ICpjaGFubmVsLCB1aW50MzJfdAogICAgICAgICByZXBvcnQubnVtX2Ryb3BzID0gc3QtPiByZXBv
cnRfbnVtX2Ryb3BzOwogICAgICAgICByZXBvcnQubGFzdF9mcmFtZV9kZWxheSA9IG1hcmdpbjsK
ICAgICAgICAgaWYgKHNwaWNlX3Nlc3Npb25faXNfcGxheWJhY2tfYWN0aXZlKHNlc3Npb24pKSB7
Ci0gICAgICAgICAgICByZXBvcnQuYXVkaW9fZGVsYXkgPSBzcGljZV9zZXNzaW9uX2dldF9wbGF5
YmFja19sYXRlbmN5KHNlc3Npb24pOworICAgICAgICAgICAgcmVwb3J0LmF1ZGlvX2RlbGF5ID0g
c3BpY2Vfc2Vzc2lvbl9nZXRfcGxheWJhY2tfbGFnKHNlc3Npb24pOwogICAgICAgICB9IGVsc2Ug
ewogICAgICAgICAgICAgcmVwb3J0LmF1ZGlvX2RlbGF5ID0gVUlOVDMyX01BWDsKICAgICAgICAg
fQpAQCAtMTczNyw3ICsxNzU4LDcgQEAgc3RhdGljIHZvaWQgZGlzcGxheV9oYW5kbGVfc3RyZWFt
X2RhdGEoU3BpY2VDaGFubmVsICpjaGFubmVsLCBTcGljZU1zZ0luICppbikKICAgICAvKiBDb21w
dXRlIHRoZSBsb2NhbCBmcmFtZSBtbXRpbWUgKi8KICAgICBzdHJlYW1fdGltZSA9IHN0cmVhbV9n
ZXRfdGltZShzdCk7CiAgICAgZnJhbWVfdGltZSA9IHNwaWNlX3Nlc3Npb25fbW10aW1lMmNsaWVu
dF90aW1lKHNlc3Npb24sIG9wLT5tdWx0aV9tZWRpYV90aW1lKTsKLSAgICBndWludDMyIHRhcmdl
dF9sYWcgPSBzcGljZV9zZXNzaW9uX2dldF9wbGF5YmFja19sYXRlbmN5KHNlc3Npb24pOworICAg
IGd1aW50MzIgdGFyZ2V0X2xhZyA9IHNwaWNlX3Nlc3Npb25fZ2V0X2xhZyhzZXNzaW9uKTsKICAg
ICBpZiAoc3QtPmxhc3RfZnJhbWVfdGltZSA9PSAwKSB7CiAgICAgICAgIG1hcmdpbiA9IHNwaWNl
X21tdGltZV9kaWZmKGZyYW1lX3RpbWUsIHN0cmVhbV90aW1lKTsKICAgICAgICAgc3QtPmRlbGF5
ID0gTUFYKHRhcmdldF9sYWcgLSBtYXJnaW4sIElOSVRJQUxfREVMQVkpOwpAQCAtMTg0Niw2ICsx
ODY3LDE0IEBAIHN0YXRpYyB2b2lkIGRpc3BsYXlfaGFuZGxlX3N0cmVhbV9kYXRhKFNwaWNlQ2hh
bm5lbCAqY2hhbm5lbCwgU3BpY2VNc2dJbiAqaW4pCiAgICAgICAgIHJldHVybjsKICAgICB9CiAK
KyAgICBpZiAoc3QtPnZpZGVvX2RlY29kZXItPmRlY29kaW5nX3RpbWUgIT0gMCAmJgorICAgICAg
ICAoc3QtPmRlY29kZXJfbGFnID09IDAgfHwKKyAgICAgICAgIHNwaWNlX3Nlc3Npb25fbGFnX25l
ZWRzX3VwZGF0ZShzdC0+ZGVjb2Rlcl9sYWcsIHN0LT52aWRlb19kZWNvZGVyLT5kZWNvZGluZ190
aW1lKSkpIHsKKyAgICAgICAgU3BpY2VTZXNzaW9uICpzZXNzaW9uID0gc3BpY2VfY2hhbm5lbF9n
ZXRfc2Vzc2lvbihTUElDRV9DSEFOTkVMKGNoYW5uZWwpKTsKKyAgICAgICAgLyogRklYTUUgVGhp
cyBtYXkgYmUgdGhlIHdyb25nIGNvbnRleHQgZm9yIHRoaXMgY2FsbCAqLworICAgICAgICBzcGlj
ZV9zZXNzaW9uX3VwZGF0ZV9sYWcoc2Vzc2lvbiwgc3QtPnZpZGVvX2RlY29kZXItPmRlY29kaW5n
X3RpbWUpOworICAgIH0KKwogICAgIGlmIChjLT5lbmFibGVfYWRhcHRpdmVfc3RyZWFtaW5nKSB7
CiAgICAgICAgIGRpc3BsYXlfdXBkYXRlX3N0cmVhbV9yZXBvcnQoU1BJQ0VfRElTUExBWV9DSEFO
TkVMKGNoYW5uZWwpLCBvcC0+aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgb3AtPm11bHRpX21lZGlhX3RpbWUsIG1tdGltZV9tYXJnaW4pOwpkaWZmIC0tZ2l0IGEvc3Jj
L2NoYW5uZWwtZGlzcGxheS5oIGIvc3JjL2NoYW5uZWwtZGlzcGxheS5oCmluZGV4IGNmMTg1Mzhi
Li43MmY5Mjc1YiAxMDA2NDQKLS0tIGEvc3JjL2NoYW5uZWwtZGlzcGxheS5oCisrKyBiL3NyYy9j
aGFubmVsLWRpc3BsYXkuaApAQCAtMTU5LDYgKzE1OSw4IEBAIHZvaWQgICAgICAgICAgICBzcGlj
ZV9nbF9zY2Fub3V0X2ZyZWUgICAgICAgICAoU3BpY2VHbFNjYW5vdXQgKnNjYW5vdXQpOwogY29u
c3QgU3BpY2VHbFNjYW5vdXQqIHNwaWNlX2Rpc3BsYXlfY2hhbm5lbF9nZXRfZ2xfc2Nhbm91dChT
cGljZURpc3BsYXlDaGFubmVsICpjaGFubmVsKTsKIHZvaWQgc3BpY2VfZGlzcGxheV9jaGFubmVs
X2dsX2RyYXdfZG9uZShTcGljZURpc3BsYXlDaGFubmVsICpjaGFubmVsKTsKIAorZ3VpbnQzMiBz
cGljZV9kaXNwbGF5X2NoYW5uZWxfZ2V0X2xhZyhTcGljZURpc3BsYXlDaGFubmVsICpjaGFubmVs
KTsKKwogI2lmbmRlZiBTUElDRV9ESVNBQkxFX0RFUFJFQ0FURUQKIEdfREVQUkVDQVRFRF9GT1Io
c3BpY2VfZGlzcGxheV9jaGFubmVsX2NoYW5nZV9wcmVmZXJyZWRfY29tcHJlc3Npb24pCiB2b2lk
IHNwaWNlX2Rpc3BsYXlfY2hhbmdlX3ByZWZlcnJlZF9jb21wcmVzc2lvbihTcGljZUNoYW5uZWwg
KmNoYW5uZWwsIGdpbnQgY29tcHJlc3Npb24pOwpkaWZmIC0tZ2l0IGEvc3JjL2NoYW5uZWwtcGxh
eWJhY2stcHJpdi5oIGIvc3JjL2NoYW5uZWwtcGxheWJhY2stcHJpdi5oCmluZGV4IGRjODllMmQ4
Li43ZjBlYzMzYyAxMDA2NDQKLS0tIGEvc3JjL2NoYW5uZWwtcGxheWJhY2stcHJpdi5oCisrKyBi
L3NyYy9jaGFubmVsLXBsYXliYWNrLXByaXYuaApAQCAtMTksNSArMTksNiBAQAogI2RlZmluZSBf
X1NQSUNFX0NMSUVOVF9QTEFZQkFDS19DSEFOTkVMX1BSSVZfSF9fCiAKIGdib29sZWFuIHNwaWNl
X3BsYXliYWNrX2NoYW5uZWxfaXNfYWN0aXZlKFNwaWNlUGxheWJhY2tDaGFubmVsICpjaGFubmVs
KTsKLWd1aW50MzIgc3BpY2VfcGxheWJhY2tfY2hhbm5lbF9nZXRfbGF0ZW5jeShTcGljZVBsYXli
YWNrQ2hhbm5lbCAqY2hhbm5lbCk7CitndWludDMyIHNwaWNlX3BsYXliYWNrX2NoYW5uZWxfZ2V0
X2xhZyhTcGljZVBsYXliYWNrQ2hhbm5lbCAqY2hhbm5lbCk7Cit2b2lkIHNwaWNlX3BsYXliYWNr
X2NoYW5uZWxfdXBkYXRlX2xhZyhTcGljZVBsYXliYWNrQ2hhbm5lbCAqY2hhbm5lbCwgZ3VpbnQz
MiBsYWcpOwogI2VuZGlmCmRpZmYgLS1naXQgYS9zcmMvY2hhbm5lbC1wbGF5YmFjay5jIGIvc3Jj
L2NoYW5uZWwtcGxheWJhY2suYwppbmRleCAwZTQzOWVmZi4uMDYxZjA3MWUgMTAwNjQ0Ci0tLSBh
L3NyYy9jaGFubmVsLXBsYXliYWNrLmMKKysrIGIvc3JjL2NoYW5uZWwtcGxheWJhY2suYwpAQCAt
NDU3LDI1ICs0NTcsMzAgQEAgc3RhdGljIHZvaWQgY2hhbm5lbF9zZXRfaGFuZGxlcnMoU3BpY2VD
aGFubmVsQ2xhc3MgKmtsYXNzKQogICogQGNoYW5uZWw6IGEgI1NwaWNlUGxheWJhY2tDaGFubmVs
CiAgKiBAZGVsYXlfbXM6IHRoZSBkZWxheSBpbiBtcwogICoKLSAqIEFkanVzdCB0aGUgbXVsdGlt
ZWRpYSB0aW1lIGFjY29yZGluZyB0byB0aGUgZGVsYXkuCisgKiBBZGp1c3QgdGhlIG11bHRpbWVk
aWEgdGltZSBhbmQgZ2xvYmFsIGxhZyBhY2NvcmRpbmcgdG8gdGhlIGRlbGF5LgogICoqLwogdm9p
ZCBzcGljZV9wbGF5YmFja19jaGFubmVsX3NldF9kZWxheShTcGljZVBsYXliYWNrQ2hhbm5lbCAq
Y2hhbm5lbCwgZ3VpbnQzMiBkZWxheV9tcykKIHsKICAgICBTcGljZVBsYXliYWNrQ2hhbm5lbFBy
aXZhdGUgKmM7CiAgICAgU3BpY2VTZXNzaW9uICpzZXNzaW9uOworICAgIGd1aW50MzIgb2xkX2xh
dGVuY3k7CiAKICAgICBnX3JldHVybl9pZl9mYWlsKFNQSUNFX0lTX1BMQVlCQUNLX0NIQU5ORUwo
Y2hhbm5lbCkpOwogCiAgICAgQ0hBTk5FTF9ERUJVRyhjaGFubmVsLCAicGxheWJhY2sgc2V0X2Rl
bGF5ICV1IG1zIiwgZGVsYXlfbXMpOwogCiAgICAgYyA9IGNoYW5uZWwtPnByaXY7CisgICAgb2xk
X2xhdGVuY3kgPSBjLT5sYXRlbmN5OwogICAgIGMtPmxhdGVuY3kgPSBkZWxheV9tczsKIAogICAg
IHNlc3Npb24gPSBzcGljZV9jaGFubmVsX2dldF9zZXNzaW9uKFNQSUNFX0NIQU5ORUwoY2hhbm5l
bCkpOwogICAgIGlmIChzZXNzaW9uKSB7CiAgICAgICAgIHNwaWNlX3Nlc3Npb25fc2V0X21tX3Rp
bWUoc2Vzc2lvbiwgYy0+bGFzdF90aW1lIC0gZGVsYXlfbXMpOworICAgICAgICBpZiAoc3BpY2Vf
c2Vzc2lvbl9sYWdfbmVlZHNfdXBkYXRlKG9sZF9sYXRlbmN5LCBkZWxheV9tcykpIHsKKyAgICAg
ICAgICAgIHNwaWNlX3Nlc3Npb25fdXBkYXRlX2xhZyhzZXNzaW9uLCBkZWxheV9tcyk7CisgICAg
ICAgIH0KICAgICB9IGVsc2UgewotICAgICAgICBDSEFOTkVMX0RFQlVHKGNoYW5uZWwsICJjaGFu
bmVsIGRldGFjaGVkIGZyb20gc2Vzc2lvbiwgbW0gdGltZSBza2lwcGVkIik7CisgICAgICAgIENI
QU5ORUxfREVCVUcoY2hhbm5lbCwgImNoYW5uZWwgZGV0YWNoZWQgZnJvbSBzZXNzaW9uLCBtbSB0
aW1lICYgZ2xvYmFsIGxhZyBza2lwcGVkIik7CiAgICAgfQogfQogCkBAIC00ODcsNyArNDkyLDcg
QEAgZ2Jvb2xlYW4gc3BpY2VfcGxheWJhY2tfY2hhbm5lbF9pc19hY3RpdmUoU3BpY2VQbGF5YmFj
a0NoYW5uZWwgKmNoYW5uZWwpCiB9CiAKIEdfR05VQ19JTlRFUk5BTAotZ3VpbnQzMiBzcGljZV9w
bGF5YmFja19jaGFubmVsX2dldF9sYXRlbmN5KFNwaWNlUGxheWJhY2tDaGFubmVsICpjaGFubmVs
KQorZ3VpbnQzMiBzcGljZV9wbGF5YmFja19jaGFubmVsX2dldF9sYWcoU3BpY2VQbGF5YmFja0No
YW5uZWwgKmNoYW5uZWwpCiB7CiAgICAgZ19yZXR1cm5fdmFsX2lmX2ZhaWwoU1BJQ0VfSVNfUExB
WUJBQ0tfQ0hBTk5FTChjaGFubmVsKSwgMCk7CiAgICAgaWYgKCFjaGFubmVsLT5wcml2LT5pc19h
Y3RpdmUpIHsKQEAgLTQ5NSwzICs1MDAsMTQgQEAgZ3VpbnQzMiBzcGljZV9wbGF5YmFja19jaGFu
bmVsX2dldF9sYXRlbmN5KFNwaWNlUGxheWJhY2tDaGFubmVsICpjaGFubmVsKQogICAgIH0KICAg
ICByZXR1cm4gY2hhbm5lbC0+cHJpdi0+bGF0ZW5jeTsKIH0KKworR19HTlVDX0lOVEVSTkFMCit2
b2lkIHNwaWNlX3BsYXliYWNrX2NoYW5uZWxfdXBkYXRlX2xhZyhTcGljZVBsYXliYWNrQ2hhbm5l
bCAqY2hhbm5lbCwgZ3VpbnQzMiBsYWcpCit7CisgICAgZ19yZXR1cm5faWZfZmFpbChTUElDRV9J
U19QTEFZQkFDS19DSEFOTkVMKGNoYW5uZWwpKTsKKyAgICBjaGFubmVsLT5wcml2LT5taW5fbGF0
ZW5jeSA9IGxhZzsKKyAgICBpZiAoY2hhbm5lbC0+cHJpdi0+aXNfYWN0aXZlKSB7CisgICAgICAg
IFNQSUNFX0RFQlVHKCIlczogbm90aWZ5IGxhZyB1cGRhdGUgJXUiLCBfX0ZVTkNUSU9OX18sIGNo
YW5uZWwtPnByaXYtPm1pbl9sYXRlbmN5KTsKKyAgICAgICAgZ19jb3JvdXRpbmVfb2JqZWN0X25v
dGlmeShHX09CSkVDVChTUElDRV9DSEFOTkVMKGNoYW5uZWwpKSwgIm1pbi1sYXRlbmN5Iik7Cisg
ICAgfQorfQpkaWZmIC0tZ2l0IGEvc3JjL3NwaWNlLXNlc3Npb24tcHJpdi5oIGIvc3JjL3NwaWNl
LXNlc3Npb24tcHJpdi5oCmluZGV4IGQwZDdiZThlLi5jNjgyNzc0MCAxMDA2NDQKLS0tIGEvc3Jj
L3NwaWNlLXNlc3Npb24tcHJpdi5oCisrKyBiL3NyYy9zcGljZS1zZXNzaW9uLXByaXYuaApAQCAt
ODUsNyArODUsMTEgQEAgU3BpY2VDaGFubmVsKiBzcGljZV9zZXNzaW9uX2xvb2t1cF9jaGFubmVs
KFNwaWNlU2Vzc2lvbiAqc2Vzc2lvbiwgZ2ludCBpZCwgZ2ludAogdm9pZCBzcGljZV9zZXNzaW9u
X3NldF91dWlkKFNwaWNlU2Vzc2lvbiAqc2Vzc2lvbiwgZ3VpbnQ4IHV1aWRbMTZdKTsKIHZvaWQg
c3BpY2Vfc2Vzc2lvbl9zZXRfbmFtZShTcGljZVNlc3Npb24gKnNlc3Npb24sIGNvbnN0IGdjaGFy
ICpuYW1lKTsKIGdib29sZWFuIHNwaWNlX3Nlc3Npb25faXNfcGxheWJhY2tfYWN0aXZlKFNwaWNl
U2Vzc2lvbiAqc2Vzc2lvbik7Ci1ndWludDMyIHNwaWNlX3Nlc3Npb25fZ2V0X3BsYXliYWNrX2xh
dGVuY3koU3BpY2VTZXNzaW9uICpzZXNzaW9uKTsKK2d1aW50MzIgc3BpY2Vfc2Vzc2lvbl9nZXRf
cGxheWJhY2tfbGFnKFNwaWNlU2Vzc2lvbiAqc2Vzc2lvbik7CisjZGVmaW5lIHNwaWNlX3Nlc3Np
b25fbGFnX25lZWRzX3VwZGF0ZShvbGRfbGFnLCBuZXdfbGFnKSBcCisgICAgKG9sZF9sYWcgPT0g
MCB8fCAobmV3X2xhZykgKyAxMCA8IChvbGRfbGFnKSB8fCAobmV3X2xhZykgPiAob2xkX2xhZykg
KyAxMCkKK2d1aW50MzIgc3BpY2Vfc2Vzc2lvbl9nZXRfbGFnKFNwaWNlU2Vzc2lvbiAqc2Vzc2lv
bik7Cit2b2lkIHNwaWNlX3Nlc3Npb25fdXBkYXRlX2xhZyhTcGljZVNlc3Npb24gKnNlc3Npb24s
IGd1aW50MzIgbGFnKTsKIGdib29sZWFuIHNwaWNlX3Nlc3Npb25fZ2V0X2F1ZGlvX2VuYWJsZWQo
U3BpY2VTZXNzaW9uICpzZXNzaW9uKTsKIGdib29sZWFuIHNwaWNlX3Nlc3Npb25fZ2V0X3NtYXJ0
Y2FyZF9lbmFibGVkKFNwaWNlU2Vzc2lvbiAqc2Vzc2lvbik7CiBnYm9vbGVhbiBzcGljZV9zZXNz
aW9uX2dldF91c2JyZWRpcl9lbmFibGVkKFNwaWNlU2Vzc2lvbiAqc2Vzc2lvbik7CmRpZmYgLS1n
aXQgYS9zcmMvc3BpY2Utc2Vzc2lvbi5jIGIvc3JjL3NwaWNlLXNlc3Npb24uYwppbmRleCAwNGEy
ZGE5Ni4uNTRmYTI4M2EgMTAwNjQ0Ci0tLSBhL3NyYy9zcGljZS1zZXNzaW9uLmMKKysrIGIvc3Jj
L3NwaWNlLXNlc3Npb24uYwpAQCAtMTAzLDYgKzEwMyw3IEBAIHN0cnVjdCBfU3BpY2VTZXNzaW9u
UHJpdmF0ZSB7CiAgICAgZ2Jvb2xlYW4gICAgICAgICAgY2xpZW50X3Byb3ZpZGVkX3NvY2tldHM7
CiAgICAgZ3VpbnQ2NCAgICAgICAgICAgbW1fdGltZV9vZmZzZXQ7CiAgICAgZ3VpbnQzMiAgICAg
ICAgICAgY2xpZW50X3RpbWVfb2Zmc2V0OworICAgIGd1aW50MzIgICAgICAgICAgIGxhZzsKICAg
ICBTcGljZVNlc3Npb24gICAgICAqbWlncmF0aW9uOwogICAgIEdMaXN0ICAgICAgICAgICAgICpt
aWdyYXRpb25fbGVmdDsKICAgICBTcGljZVNlc3Npb25NaWdyYXRpb24gbWlncmF0aW9uX3N0YXRl
OwpAQCAtMjY3Miw3ICsyNjczLDcgQEAgZ2Jvb2xlYW4gc3BpY2Vfc2Vzc2lvbl9pc19wbGF5YmFj
a19hY3RpdmUoU3BpY2VTZXNzaW9uICpzZXNzaW9uKQogfQogCiBHX0dOVUNfSU5URVJOQUwKLWd1
aW50MzIgc3BpY2Vfc2Vzc2lvbl9nZXRfcGxheWJhY2tfbGF0ZW5jeShTcGljZVNlc3Npb24gKnNl
c3Npb24pCitndWludDMyIHNwaWNlX3Nlc3Npb25fZ2V0X3BsYXliYWNrX2xhZyhTcGljZVNlc3Np
b24gKnNlc3Npb24pCiB7CiAgICAgZ19yZXR1cm5fdmFsX2lmX2ZhaWwoU1BJQ0VfSVNfU0VTU0lP
TihzZXNzaW9uKSwgMCk7CiAKQEAgLTI2ODAsMTMgKzI2ODEsNTAgQEAgZ3VpbnQzMiBzcGljZV9z
ZXNzaW9uX2dldF9wbGF5YmFja19sYXRlbmN5KFNwaWNlU2Vzc2lvbiAqc2Vzc2lvbikKIAogICAg
IGlmIChzLT5wbGF5YmFja19jaGFubmVsICYmCiAgICAgICAgIHNwaWNlX3BsYXliYWNrX2NoYW5u
ZWxfaXNfYWN0aXZlKHMtPnBsYXliYWNrX2NoYW5uZWwpKSB7Ci0gICAgICAgIHJldHVybiBzcGlj
ZV9wbGF5YmFja19jaGFubmVsX2dldF9sYXRlbmN5KHMtPnBsYXliYWNrX2NoYW5uZWwpOworICAg
ICAgICByZXR1cm4gc3BpY2VfcGxheWJhY2tfY2hhbm5lbF9nZXRfbGFnKHMtPnBsYXliYWNrX2No
YW5uZWwpOwogICAgIH0gZWxzZSB7CiAgICAgICAgIFNQSUNFX0RFQlVHKCIlczogbm90IGltcGxl
bWVudGVkIHdoZW4gdGhlcmUgaXNuJ3QgYXVkaW8gcGxheWJhY2siLCBfX0ZVTkNUSU9OX18pOwog
ICAgICAgICByZXR1cm4gMDsKICAgICB9CiB9CiAKK0dfR05VQ19JTlRFUk5BTAorZ3VpbnQzMiBz
cGljZV9zZXNzaW9uX2dldF9sYWcoU3BpY2VTZXNzaW9uICpzZXNzaW9uKQoreworICAgIGdfcmV0
dXJuX3ZhbF9pZl9mYWlsKFNQSUNFX0lTX1NFU1NJT04oc2Vzc2lvbiksIDApOworCisgICAgcmV0
dXJuIHNlc3Npb24tPnByaXYtPmxhZzsKK30KKworR19HTlVDX0lOVEVSTkFMCit2b2lkIHNwaWNl
X3Nlc3Npb25fdXBkYXRlX2xhZyhTcGljZVNlc3Npb24gKnNlc3Npb24sIGd1aW50MzIgbGFnKQor
eworICAgIGdfcmV0dXJuX2lmX2ZhaWwoU1BJQ0VfSVNfU0VTU0lPTihzZXNzaW9uKSk7CisgICAg
U3BpY2VTZXNzaW9uUHJpdmF0ZSAqcyA9IHNlc3Npb24tPnByaXY7CisKKyAgICBpZiAoc3BpY2Vf
c2Vzc2lvbl9sYWdfbmVlZHNfdXBkYXRlKHMtPmxhZywgbGFnKSkgeworICAgICAgICBndWludDMy
IG5ld19sYWcgPSAwOworICAgICAgICBmb3IgKEdMaXN0ICpsID0gcy0+Y2hhbm5lbHM7IGwgIT0g
TlVMTDsgKSB7CisgICAgICAgICAgICBTcGljZUNoYW5uZWwgKmNoYW5uZWwgPSBsLT5kYXRhOwor
ICAgICAgICAgICAgbCA9IGwtPm5leHQ7CisgICAgICAgICAgICBzd2l0Y2ggKHNwaWNlX2NoYW5u
ZWxfZ2V0X2NoYW5uZWxfdHlwZShjaGFubmVsKSkgeworICAgICAgICAgICAgY2FzZSBTUElDRV9D
SEFOTkVMX0RJU1BMQVk6CisgICAgICAgICAgICAgICAgbmV3X2xhZyA9IE1BWChuZXdfbGFnLCBz
cGljZV9kaXNwbGF5X2NoYW5uZWxfZ2V0X2xhZyhTUElDRV9ESVNQTEFZX0NIQU5ORUwoY2hhbm5l
bCkpKTsKKyAgICAgICAgICAgICAgICBicmVhazsKKyAgICAgICAgICAgIGNhc2UgU1BJQ0VfQ0hB
Tk5FTF9QTEFZQkFDSzoKKyAgICAgICAgICAgICAgICBuZXdfbGFnID0gTUFYKG5ld19sYWcsIHNw
aWNlX3BsYXliYWNrX2NoYW5uZWxfZ2V0X2xhZyhTUElDRV9QTEFZQkFDS19DSEFOTkVMKGNoYW5u
ZWwpKSk7CisgICAgICAgICAgICAgICAgYnJlYWs7CisgICAgICAgICAgICB9CisgICAgICAgIH0K
KyAgICAgICAgaWYgKG5ld19sYWcgIT0gcy0+bGFnKSB7CisgICAgICAgICAgICBzLT5sYWcgPSBu
ZXdfbGFnOworICAgICAgICAgICAgaWYgKHMtPnBsYXliYWNrX2NoYW5uZWwpIHsKKyAgICAgICAg
ICAgICAgICBzcGljZV9wbGF5YmFja19jaGFubmVsX3VwZGF0ZV9sYWcocy0+cGxheWJhY2tfY2hh
bm5lbCwgcy0+bGFnKTsKKyAgICAgICAgICAgIH0KKyAgICAgICAgfQorICAgIH0KK30KKwogc3Rh
dGljIGNvbnN0IGdjaGFyKiBzcGljZV9zZXNzaW9uX2dldF9zaGFyZWRfZGlyKFNwaWNlU2Vzc2lv
biAqc2Vzc2lvbikKIHsKICAgICBnX3JldHVybl92YWxfaWZfZmFpbChTUElDRV9JU19TRVNTSU9O
KHNlc3Npb24pLCBOVUxMKTsKLS0gCjIuMjAuMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX18KU3BpY2UtZGV2ZWwgbWFpbGluZyBsaXN0ClNwaWNlLWRldmVs
QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWls
bWFuL2xpc3RpbmZvL3NwaWNlLWRldmVs
