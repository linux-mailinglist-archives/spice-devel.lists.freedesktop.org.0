Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 86BEEAA4DF
	for <lists+spice-devel@lfdr.de>; Thu,  5 Sep 2019 15:43:20 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id C829C6E0F1;
	Thu,  5 Sep 2019 13:43:18 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id F0EC26E0D6
 for <spice-devel@lists.freedesktop.org>; Thu,  5 Sep 2019 13:43:15 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx06.intmail.prod.int.phx2.redhat.com
 [10.5.11.16])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 9CCCB308449C
 for <spice-devel@lists.freedesktop.org>; Thu,  5 Sep 2019 13:43:15 +0000 (UTC)
Received: from fziglio.remote.csb (unknown [10.33.32.10])
 by smtp.corp.redhat.com (Postfix) with ESMTP id DCF5F5C1D4;
 Thu,  5 Sep 2019 13:43:14 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Thu,  5 Sep 2019 14:42:36 +0100
Message-Id: <20190905134241.28873-14-fziglio@redhat.com>
In-Reply-To: <20190905134241.28873-1-fziglio@redhat.com>
References: <20190905134241.28873-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.16
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.40]); Thu, 05 Sep 2019 13:43:15 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-gtk v6 13/18] usb-backend: Rewrite USB
 emulation support
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

TWFrZSBpbml0aWFsaXphdGlvbiBlYXNpZXIuCkluaXRpYWxpemUgYm90aCBwYXJzZXIgYW5kIGhv
c3QgZHVyaW5nIHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfbmV3LgpwYXJzZXIgaXMgYWx3YXlz
IGluaXRpYWxpemVkIGFmdGVyIGNyZWF0aW9uIG1ha2luZyBzdXJlIHRoZSBzdGF0ZQppcyBjb25z
aXN0ZW50LgpSZWR1Y2UgbnVtYmVyIG9mIHN0YXRlIHZhcmlhYmxlcy4KVXNlIGEgc2luZ2xlIHN0
YXRlIHZhcmlhYmxlLCBkYXRhIGZsb3dzIGludG8vZnJvbSBhIHNpbmdsZSBwYXJzZXIuClN1cHBv
cnQgbm90IGhhdmluZyBsaWJ1c2IgY29udGV4dCAobm8gcGh5c2ljYWwgZGV2aWNlcykuCgpTaWdu
ZWQtb2ZmLWJ5OiBGcmVkaWFubyBaaWdsaW8gPGZ6aWdsaW9AcmVkaGF0LmNvbT4KLS0tCiBzcmMv
dXNiLWJhY2tlbmQuYyB8IDI0MSArKysrKysrKysrKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgMTIxIGluc2VydGlvbnMoKyksIDEyMCBkZWxldGlv
bnMoLSkKCmRpZmYgLS1naXQgYS9zcmMvdXNiLWJhY2tlbmQuYyBiL3NyYy91c2ItYmFja2VuZC5j
CmluZGV4IDAyZWQ4YmI1Li42NjBhNDAyYSAxMDA2NDQKLS0tIGEvc3JjL3VzYi1iYWNrZW5kLmMK
KysrIGIvc3JjL3VzYi1iYWNrZW5kLmMKQEAgLTc4LDIxICs3OCwyMSBAQCBzdHJ1Y3QgX1NwaWNl
VXNiQmFja2VuZAogICAgIHVpbnQzMl90IG93bl9kZXZpY2VzX21hc2s7CiB9OwogCit0eXBlZGVm
IGVudW0geworICAgIFVTQl9DSEFOTkVMX1NUQVRFX0lOSVRJQUxJWklORywKKyAgICBVU0JfQ0hB
Tk5FTF9TVEFURV9IT1NULAorICAgIFVTQl9DSEFOTkVMX1NUQVRFX1BBUlNFUiwKK30gU3BpY2VV
c2JCYWNrZW5kQ2hhbm5lbFN0YXRlOworCiBzdHJ1Y3QgX1NwaWNlVXNiQmFja2VuZENoYW5uZWwK
IHsKICAgICBzdHJ1Y3QgdXNicmVkaXJob3N0ICp1c2JyZWRpcmhvc3Q7Ci0gICAgc3RydWN0IHVz
YnJlZGlyaG9zdCAqaGlkZGVuX2hvc3Q7CiAgICAgc3RydWN0IHVzYnJlZGlycGFyc2VyICpwYXJz
ZXI7Ci0gICAgc3RydWN0IHVzYnJlZGlycGFyc2VyICpoaWRkZW5fcGFyc2VyOworICAgIFNwaWNl
VXNiQmFja2VuZENoYW5uZWxTdGF0ZSBzdGF0ZTsKICAgICB1aW50OF90ICpyZWFkX2J1ZjsKICAg
ICBpbnQgcmVhZF9idWZfc2l6ZTsKICAgICBzdHJ1Y3QgdXNicmVkaXJmaWx0ZXJfcnVsZSAqcnVs
ZXM7CiAgICAgaW50IHJ1bGVzX2NvdW50OwotICAgIHVpbnQzMl90IGhvc3RfY2FwczsKLSAgICB1
aW50MzJfdCBwYXJzZXJfaW5pdF9kb25lICA6IDE7Ci0gICAgdWludDMyX3QgcGFyc2VyX3dpdGhf
aGVsbG8gOiAxOwotICAgIHVpbnQzMl90IGhlbGxvX2RvbmVfcGFyc2VyIDogMTsKLSAgICB1aW50
MzJfdCBoZWxsb19zZW50ICAgICAgICA6IDE7CiAgICAgdWludDMyX3QgcmVqZWN0ZWQgICAgICAg
ICAgOiAxOwogICAgIHVpbnQzMl90IHdhaXRfZGlzY29ubmVjdF9hY2sgOiAxOwogICAgIFNwaWNl
VXNiQmFja2VuZERldmljZSAqYXR0YWNoZWQ7CkBAIC00MTIsMTUgKzQxMiwxNiBAQCBmcm9tIGJv
dGggdGhlIG1haW4gdGhyZWFkIGFzIHdlbGwgYXMgZnJvbSB0aGUgdXNiIGV2ZW50IGhhbmRsaW5n
IHRocmVhZCAqLwogc3RhdGljIHZvaWQgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2sodm9p
ZCAqdXNlcl9kYXRhKQogewogICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gdXNlcl9k
YXRhOworICAgIGlmIChjaC0+cGFyc2VyID09IE5VTEwpIHsKKyAgICAgICAgcmV0dXJuOworICAg
IH0KICAgICBpZiAoaXNfY2hhbm5lbF9yZWFkeShjaC0+dXNicmVkaXJfY2hhbm5lbCkpIHsKLSAg
ICAgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKKyAgICAgICAgaWYgKGNoLT5zdGF0ZSA9PSBV
U0JfQ0hBTk5FTF9TVEFURV9IT1NUKSB7CiAgICAgICAgICAgICBTUElDRV9ERUJVRygiJXMgY2gg
JXAgLT4gdXNicmVkaXJob3N0IiwgX19GVU5DVElPTl9fLCBjaCk7CiAgICAgICAgICAgICB1c2Jy
ZWRpcmhvc3Rfd3JpdGVfZ3Vlc3RfZGF0YShjaC0+dXNicmVkaXJob3N0KTsKLSAgICAgICAgfSBl
bHNlIGlmIChjaC0+cGFyc2VyKSB7CisgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICBTUElD
RV9ERUJVRygiJXMgY2ggJXAgLT4gcGFyc2VyIiwgX19GVU5DVElPTl9fLCBjaCk7CiAgICAgICAg
ICAgICB1c2JyZWRpcnBhcnNlcl9kb193cml0ZShjaC0+cGFyc2VyKTsKLSAgICAgICAgfSBlbHNl
IHsKLSAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAoTk9UIEFDVElWRSkiLCBfX0ZV
TkNUSU9OX18sIGNoKTsKICAgICAgICAgfQogICAgIH0gZWxzZSB7CiAgICAgICAgIFNQSUNFX0RF
QlVHKCIlcyBjaCAlcCAobm90IHJlYWR5KSIsIF9fRlVOQ1RJT05fXywgY2gpOwpAQCAtNjgwLDIx
ICs2ODEsNDcgQEAgc3RhdGljIHZvaWQgdXNicmVkaXJfbG9nKHZvaWQgKnVzZXJfZGF0YSwgaW50
IGxldmVsLCBjb25zdCBjaGFyICptc2cpCiAgICAgfQogfQogCitzdGF0aWMgc3RydWN0IHVzYnJl
ZGlycGFyc2VyICpjcmVhdGVfcGFyc2VyKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoKTsKKwog
c3RhdGljIGludCB1c2JyZWRpcl93cml0ZV9jYWxsYmFjayh2b2lkICp1c2VyX2RhdGEsIHVpbnQ4
X3QgKmRhdGEsIGludCBjb3VudCkKIHsKICAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9
IHVzZXJfZGF0YTsKICAgICBpbnQgcmVzOwogICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCwgJWQg
Ynl0ZXMiLCBfX0ZVTkNUSU9OX18sIGNoLCBjb3VudCk7Ci0gICAgaWYgKCFjaC0+aGVsbG9fc2Vu
dCkgewotICAgICAgICAvKiBoZWxsbyBpcyBzaG9ydCBoZWFkZXIgKDEyKSArIGhlbGxvIHN0cnVj
dCAoNjQpICsgY2FwYWJpbGl0aWVzICg0KSAqLwotICAgICAgICBpbnQgaGVsbG9fc2l6ZSA9IHNp
emVvZihzdHJ1Y3QgdXNiX3JlZGlyX2hlYWRlcikgKyBzaXplb2Yoc3RydWN0IHVzYl9yZWRpcl9o
ZWxsb19oZWFkZXIpOwotICAgICAgICBjaC0+aGVsbG9fc2VudCA9IDE7Ci0gICAgICAgIGlmIChj
b3VudCA9PSBoZWxsb19zaXplKSB7Ci0gICAgICAgICAgICBtZW1jcHkoJmNoLT5ob3N0X2NhcHMs
IGRhdGEgKyBoZWxsb19zaXplIC0gc2l6ZW9mKGNoLT5ob3N0X2NhcHMpLAotICAgICAgICAgICAg
ICAgICAgIHNpemVvZihjaC0+aG9zdF9jYXBzKSk7Ci0gICAgICAgICAgICBTUElDRV9ERUJVRygi
JXMgY2ggJXAsIHNlbmRpbmcgZmlyc3QgaGVsbG8sIGNhcHMgJTA4WCIsCi0gICAgICAgICAgICAg
ICAgICAgICAgICBfX0ZVTkNUSU9OX18sIGNoLCBjaC0+aG9zdF9jYXBzKTsKKworICAgIC8vIGhh
bmRsZSBmaXJzdCBwYWNrZXQgKEhFTExPKSBjcmVhdGluZyBwYXJzZXIgZnJvbSBjYXBhYmlsaXRp
ZXMKKyAgICBpZiAoU1BJQ0VfVU5MSUtFTFkoY2gtPnBhcnNlciA9PSBOVUxMKSkgeworICAgICAg
ICAvLyBIZXJlIHdlIHJldHVybiAwIGZyb20gdGhpcyBmdW5jdGlvbiB0byBrZWVwIHRoZSBwYWNr
ZXQgaW4KKyAgICAgICAgLy8gdGhlIHF1ZXVlLiBUaGUgcGFja2V0IHdpbGwgdGhlbiBiZSBzZW50
IHRvIHRoZSBndWVzdC4KKyAgICAgICAgLy8gV2UgYXJlIGluaXRpYWxpemluZyBTcGljZVVzYkJh
Y2tlbmRDaGFubmVsLCB0aGUKKyAgICAgICAgLy8gU3BpY2VVc2JyZWRpckNoYW5uZWwgaXMgbm90
IHJlYWR5IHRvIHJlY2VpdmUgcGFja2V0cy4KKworICAgICAgICAvLyB3ZSBhcmUgc3RpbGwgaW5p
dGlhbGl6aW5nIHRoZSBob3N0CisgICAgICAgIGlmIChjaC0+dXNicmVkaXJob3N0ID09IE5VTEwp
IHsKKyAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICB9CisKKyAgICAgICAgY2gtPnBhcnNl
ciA9IGNyZWF0ZV9wYXJzZXIoY2gpOworICAgICAgICBpZiAoIWNoLT5wYXJzZXIpIHsKKyAgICAg
ICAgICAgIHJldHVybiAwOworICAgICAgICB9CisKKyAgICAgICAgLyogaGVsbG8gaXMgc2hvcnQg
aGVhZGVyICgxMikgKyBoZWxsbyBzdHJ1Y3QgKDY0KSAqLworICAgICAgICBjb25zdCBpbnQgaGVs
bG9fc2l6ZSA9IDEyICsgc2l6ZW9mKHN0cnVjdCB1c2JfcmVkaXJfaGVsbG9faGVhZGVyKTsKKyAg
ICAgICAgZ19hc3NlcnQoY291bnQgPj0gaGVsbG9fc2l6ZSArIDQpOworICAgICAgICBnX2Fzc2Vy
dChTUElDRV9BTElHTkVEX0NBU1Qoc3RydWN0IHVzYl9yZWRpcl9oZWFkZXIgKiwgZGF0YSktPnR5
cGUgPT0gdXNiX3JlZGlyX2hlbGxvKTsKKworICAgICAgICBjb25zdCB1aW50MzJfdCBmbGFncyA9
CisgICAgICAgICAgICB1c2JyZWRpcnBhcnNlcl9mbF93cml0ZV9jYl9vd25zX2J1ZmZlciB8IHVz
YnJlZGlycGFyc2VyX2ZsX3VzYl9ob3N0IHwKKyAgICAgICAgICAgIHVzYnJlZGlycGFyc2VyX2Zs
X25vX2hlbGxvOworCisgICAgICAgIHVzYnJlZGlycGFyc2VyX2luaXQoY2gtPnBhcnNlciwKKyAg
ICAgICAgICAgICAgICAgICAgICAgICAgICBQQUNLQUdFX1NUUklORywKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICBTUElDRV9BTElHTkVEX0NBU1QodWludDMyX3QgKiwgZGF0YSArIGhlbGxv
X3NpemUpLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgIChjb3VudCAtIGhlbGxvX3NpemUp
IC8gc2l6ZW9mKHVpbnQzMl90KSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbGFncyk7
CisKKyAgICAgICAgcmV0dXJuIDA7CiAgICAgfQogICAgIHJlcyA9IHNwaWNlX3VzYnJlZGlyX3dy
aXRlKGNoLT51c2JyZWRpcl9jaGFubmVsLCBkYXRhLCBjb3VudCk7CiAgICAgcmV0dXJuIHJlczsK
QEAgLTcxNCwzMSArNzQxLDMzIEBAIGludCBzcGljZV91c2JfYmFja2VuZF9yZWFkX2d1ZXN0X2Rh
dGEoU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsIHVpbnQ4X3QgKmRhdGEsCiAKICAgICBjaC0+
cmVhZF9idWYgPSBkYXRhOwogICAgIGNoLT5yZWFkX2J1Zl9zaXplID0gY291bnQ7Ci0gICAgaWYg
KGNoLT51c2JyZWRpcmhvc3QpIHsKLSAgICAgICAgcmVzID0gdXNicmVkaXJob3N0X3JlYWRfZ3Vl
c3RfZGF0YShjaC0+dXNicmVkaXJob3N0KTsKLSAgICAgICAgaWYgKCFjaC0+aGVsbG9fZG9uZV9w
YXJzZXIpIHsKLSAgICAgICAgICAgIGludCByZXNfcGFyc2VyOworICAgIGlmIChTUElDRV9VTkxJ
S0VMWShjaC0+c3RhdGUgPT0gVVNCX0NIQU5ORUxfU1RBVEVfSU5JVElBTElaSU5HKSkgeworICAg
ICAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCAhPSBOVUxMKSB7CisgICAgICAgICAgICByZXMgPSB1
c2JyZWRpcmhvc3RfcmVhZF9ndWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3QpOworICAgICAgICAg
ICAgaWYgKHJlcyAhPSAwKSB7CisgICAgICAgICAgICAgICAgcmV0dXJuIHJlczsKKyAgICAgICAg
ICAgIH0KKyAgICAgICAgICAgIGNoLT5zdGF0ZSA9IFVTQl9DSEFOTkVMX1NUQVRFX0hPU1Q7CisK
ICAgICAgICAgICAgIC8qIHVzYnJlZGlyaG9zdCBzaG91bGQgY29uc3VtZSBoZWxsbyByZXNwb25z
ZSAqLwogICAgICAgICAgICAgZ19yZXR1cm5fdmFsX2lmX2ZhaWwoY2gtPnJlYWRfYnVmID09IE5V
TEwsIFVTQl9SRURJUl9FUlJPUl9SRUFEX1BBUlNFKTsKKyAgICAgICAgfSBlbHNlIHsKKyAgICAg
ICAgICAgIGNoLT5zdGF0ZSA9IFVTQl9DSEFOTkVMX1NUQVRFX1BBUlNFUjsKKyAgICAgICAgfQog
Ci0gICAgICAgICAgICBjaC0+cmVhZF9idWYgPSBkYXRhOwotICAgICAgICAgICAgY2gtPnJlYWRf
YnVmX3NpemUgPSBjb3VudDsKLSAgICAgICAgICAgIGNoLT5oZWxsb19kb25lX3BhcnNlciA9IDE7
Ci0gICAgICAgICAgICBpZiAoY2gtPmF0dGFjaGVkICYmIGNoLT5hdHRhY2hlZC0+ZWRldikgewot
ICAgICAgICAgICAgICAgIC8qIGNhc2Ugb2YgQ0Qgc2hhcmluZyBvbiBjb25uZWN0ICovCi0gICAg
ICAgICAgICAgICAgY2gtPnVzYnJlZGlyaG9zdCA9IE5VTEw7Ci0gICAgICAgICAgICAgICAgY2gt
PnBhcnNlciA9IGNoLT5oaWRkZW5fcGFyc2VyOwotICAgICAgICAgICAgICAgIFNQSUNFX0RFQlVH
KCIlczogc3dpdGNoICVwIHRvIHBhcnNlciIsIF9fRlVOQ1RJT05fXywgY2gpOwotICAgICAgICAg
ICAgfQotICAgICAgICAgICAgcmVzX3BhcnNlciA9IHVzYnJlZGlycGFyc2VyX2RvX3JlYWQoY2gt
PmhpZGRlbl9wYXJzZXIpOwotICAgICAgICAgICAgaWYgKHJlcyA+PSAwKSB7Ci0gICAgICAgICAg
ICAgICAgcmVzID0gcmVzX3BhcnNlcjsKLSAgICAgICAgICAgIH0KKyAgICAgICAgY2gtPnJlYWRf
YnVmID0gZGF0YTsKKyAgICAgICAgY2gtPnJlYWRfYnVmX3NpemUgPSBjb3VudDsKKyAgICAgICAg
aWYgKGNoLT5hdHRhY2hlZCAmJiBjaC0+YXR0YWNoZWQtPmVkZXYpIHsKKyAgICAgICAgICAgIC8q
IGNhc2Ugb2YgQ0Qgc2hhcmluZyBvbiBjb25uZWN0ICovCisgICAgICAgICAgICBjaC0+c3RhdGUg
PSBVU0JfQ0hBTk5FTF9TVEFURV9QQVJTRVI7CisgICAgICAgICAgICBTUElDRV9ERUJVRygiJXM6
IHN3aXRjaCAlcCB0byBwYXJzZXIiLCBfX0ZVTkNUSU9OX18sIGNoKTsKICAgICAgICAgfQotICAg
IH0gZWxzZSBpZiAoY2gtPnBhcnNlcikgewotICAgICAgICByZXMgPSB1c2JyZWRpcnBhcnNlcl9k
b19yZWFkKGNoLT5wYXJzZXIpOworICAgICAgICByZXR1cm4gdXNicmVkaXJwYXJzZXJfZG9fcmVh
ZChjaC0+cGFyc2VyKTsKKyAgICB9CisgICAgaWYgKGNoLT5zdGF0ZSA9PSBVU0JfQ0hBTk5FTF9T
VEFURV9IT1NUKSB7CisgICAgICAgIHJlcyA9IHVzYnJlZGlyaG9zdF9yZWFkX2d1ZXN0X2RhdGEo
Y2gtPnVzYnJlZGlyaG9zdCk7CiAgICAgfSBlbHNlIHsKLSAgICAgICAgcmVzID0gVVNCX1JFRElS
X0VSUk9SX0lPOworICAgICAgICByZXMgPSB1c2JyZWRpcnBhcnNlcl9kb19yZWFkKGNoLT5wYXJz
ZXIpOwogICAgIH0KICAgICBzd2l0Y2ggKHJlcykKICAgICB7CkBAIC03OTAsMTQgKzgxOSwxMiBA
QCBHRXJyb3IgKnNwaWNlX3VzYl9iYWNrZW5kX2dldF9lcnJvcl9kZXRhaWxzKGludCBlcnJvcl9j
b2RlLCBnY2hhciAqZGVzYykKIAogdm9pZCBzcGljZV91c2JfYmFja2VuZF9yZXR1cm5fd3JpdGVf
ZGF0YShTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwgdm9pZCAqZGF0YSkKIHsKLSAgICBpZiAo
Y2gtPnVzYnJlZGlyaG9zdCkgeworICAgIGlmIChjaC0+c3RhdGUgPT0gVVNCX0NIQU5ORUxfU1RB
VEVfSE9TVCkgewogICAgICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAgLT4gdXNicmVkaXJob3N0
IiwgX19GVU5DVElPTl9fLCBjaCk7CiAgICAgICAgIHVzYnJlZGlyaG9zdF9mcmVlX3dyaXRlX2J1
ZmZlcihjaC0+dXNicmVkaXJob3N0LCBkYXRhKTsKLSAgICB9IGVsc2UgaWYgKGNoLT5wYXJzZXIp
IHsKKyAgICB9IGVsc2UgewogICAgICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAgLT4gcGFyc2Vy
IiwgX19GVU5DVElPTl9fLCBjaCk7CiAgICAgICAgIHVzYnJlZGlycGFyc2VyX2ZyZWVfd3JpdGVf
YnVmZmVyKGNoLT5wYXJzZXIsIGRhdGEpOwotICAgIH0gZWxzZSB7Ci0gICAgICAgIFNQSUNFX0RF
QlVHKCIlcyBjaCAlcCAtIE5PQk9EWSBUTyBDQUxMIiwgX19GVU5DVElPTl9fLCBjaCk7CiAgICAg
fQogfQogCkBAIC0xMDEyLDEwICsxMDM5LDEwIEBAIHN0YXRpYyB2b2lkIHVzYnJlZGlyX2Rldmlj
ZV9kaXNjb25uZWN0X2Fjayh2b2lkICpwcml2KQogewogICAgIFNwaWNlVXNiQmFja2VuZENoYW5u
ZWwgKmNoID0gcHJpdjsKICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAiLCBfX0ZVTkNUSU9OX18s
IGNoKTsKLSAgICBpZiAoY2gtPnBhcnNlciAmJiBjaC0+d2FpdF9kaXNjb25uZWN0X2Fjaykgewot
ICAgICAgICBjaC0+cGFyc2VyID0gTlVMTDsKKyAgICBpZiAoY2gtPnN0YXRlID09IFVTQl9DSEFO
TkVMX1NUQVRFX1BBUlNFUiAmJiBjaC0+dXNicmVkaXJob3N0ICE9IE5VTEwgJiYKKyAgICAgICAg
Y2gtPndhaXRfZGlzY29ubmVjdF9hY2spIHsKKyAgICAgICAgY2gtPnN0YXRlID0gVVNCX0NIQU5O
RUxfU1RBVEVfSE9TVDsKICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIHN3aXRjaCB0byB1c2JyZWRp
cmhvc3QiLCBfX0ZVTkNUSU9OX18pOwotICAgICAgICBjaC0+dXNicmVkaXJob3N0ID0gY2gtPmhp
ZGRlbl9ob3N0OwogICAgIH0KICAgICBjaC0+d2FpdF9kaXNjb25uZWN0X2FjayA9IDA7CiB9CkBA
IC0xMDM0LDkgKzEwNjEsNiBAQCB1c2JyZWRpcl9oZWxsbyh2b2lkICpwcml2LCBzdHJ1Y3QgdXNi
X3JlZGlyX2hlbGxvX2hlYWRlciAqaGVsbG8pCiAgICAgU1BJQ0VfREVCVUcoIiVzICVwICVzYXR0
YWNoZWQgJXMiLCBfX0ZVTkNUSU9OX18sIGNoLAogICAgICAgICBlZGV2ID8gIiIgOiAibm90ICIs
ICBoZWxsbyA/ICIiIDogIihpbnRlcm5hbCkiKTsKIAotICAgIGlmIChoZWxsbykgewotICAgICAg
ICBjaC0+aGVsbG9fZG9uZV9wYXJzZXIgPSAxOwotICAgIH0KICAgICBpZiAoIWVkZXYpIHsKICAg
ICAgICAgcmV0dXJuOwogICAgIH0KQEAgLTEwODYsNTMgKzExMTAsMjQgQEAgdXNicmVkaXJfaGVs
bG8odm9pZCAqcHJpdiwgc3RydWN0IHVzYl9yZWRpcl9oZWxsb19oZWFkZXIgKmhlbGxvKQogICAg
IHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsKIH0KIAotc3RhdGljIHZvaWQgaW5p
dGlhbGl6ZV9wYXJzZXIoU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsIGdib29sZWFuIGRvX2hl
bGxvKQorc3RhdGljIHZvaWQgaW5pdGlhbGl6ZV9wYXJzZXIoU3BpY2VVc2JCYWNrZW5kQ2hhbm5l
bCAqY2gpCiB7CiAgICAgdWludDMyX3QgZmxhZ3MsIGNhcHNbVVNCX1JFRElSX0NBUFNfU0laRV0g
PSB7IDAgfTsKIAotICAgIGdfcmV0dXJuX2lmX2ZhaWwoY2gtPmhpZGRlbl9wYXJzZXIgIT0gTlVM
TCk7Ci0gICAgaWYgKGNoLT5wYXJzZXJfaW5pdF9kb25lKSB7Ci0gICAgICAgIGlmIChjaC0+cGFy
c2VyX3dpdGhfaGVsbG8gIT0gZG9faGVsbG8pIHsKLSAgICAgICAgICAgIGdfcmV0dXJuX2lmX3Jl
YWNoZWQoKTsKLSAgICAgICAgfQotICAgICAgICByZXR1cm47Ci0gICAgfQorICAgIGdfYXNzZXJ0
KGNoLT51c2JyZWRpcmhvc3QgPT0gTlVMTCk7CiAKLSAgICBjaC0+cGFyc2VyX2luaXRfZG9uZSA9
IDE7Ci0gICAgY2gtPnBhcnNlcl93aXRoX2hlbGxvID0gZG9faGVsbG87CiAgICAgZmxhZ3MgPSB1
c2JyZWRpcnBhcnNlcl9mbF93cml0ZV9jYl9vd25zX2J1ZmZlciB8IHVzYnJlZGlycGFyc2VyX2Zs
X3VzYl9ob3N0OwogCi0gICAgaWYgKGRvX2hlbGxvKSB7Ci0gICAgICAgIGNoLT5oZWxsb19zZW50
ID0gMTsKLSAgICAgICAgY2gtPmhvc3RfY2FwcyB8PSAxIDw8IHVzYl9yZWRpcl9jYXBfY29ubmVj
dF9kZXZpY2VfdmVyc2lvbjsKLSAgICAgICAgY2gtPmhvc3RfY2FwcyB8PSAxIDw8IHVzYl9yZWRp
cl9jYXBfZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrOwotICAgICAgICBjaC0+aG9zdF9jYXBzIHw9IDEg
PDwgdXNiX3JlZGlyX2NhcF9lcF9pbmZvX21heF9wYWNrZXRfc2l6ZTsKLSAgICAgICAgY2gtPmhv
c3RfY2FwcyB8PSAxIDw8IHVzYl9yZWRpcl9jYXBfNjRiaXRzX2lkczsKLSAgICAgICAgY2gtPmhv
c3RfY2FwcyB8PSAxIDw8IHVzYl9yZWRpcl9jYXBfMzJiaXRzX2J1bGtfbGVuZ3RoOwotICAgIH0g
ZWxzZSB7Ci0gICAgICAgIGZsYWdzIHw9IHVzYnJlZGlycGFyc2VyX2ZsX25vX2hlbGxvOwotICAg
IH0KLQotICAgIGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF9jb25uZWN0
X2RldmljZV92ZXJzaW9uKSkgewotICAgICAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAo
Y2FwcywgdXNiX3JlZGlyX2NhcF9jb25uZWN0X2RldmljZV92ZXJzaW9uKTsKLSAgICB9CisgICAg
dXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfY29ubmVjdF9k
ZXZpY2VfdmVyc2lvbik7CiAgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVz
Yl9yZWRpcl9jYXBfZmlsdGVyKTsKLSAgICBpZiAoY2gtPmhvc3RfY2FwcyAmICgxIDw8IHVzYl9y
ZWRpcl9jYXBfZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrKSkgewotICAgICAgICB1c2JyZWRpcnBhcnNl
cl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF9kZXZpY2VfZGlzY29ubmVjdF9hY2sp
OwotICAgIH0KLSAgICBpZiAoY2gtPmhvc3RfY2FwcyAmICgxIDw8IHVzYl9yZWRpcl9jYXBfZXBf
aW5mb19tYXhfcGFja2V0X3NpemUpKSB7Ci0gICAgICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0
X2NhcChjYXBzLCB1c2JfcmVkaXJfY2FwX2VwX2luZm9fbWF4X3BhY2tldF9zaXplKTsKLSAgICB9
Ci0gICAgaWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJfY2FwXzY0Yml0c19pZHMp
KSB7Ci0gICAgICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJf
Y2FwXzY0Yml0c19pZHMpOwotICAgIH0KLSAgICBpZiAoY2gtPmhvc3RfY2FwcyAmICgxIDw8IHVz
Yl9yZWRpcl9jYXBfMzJiaXRzX2J1bGtfbGVuZ3RoKSkgewotICAgICAgICB1c2JyZWRpcnBhcnNl
cl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF8zMmJpdHNfYnVsa19sZW5ndGgpOwot
ICAgIH0KLSAgICBpZiAoY2gtPmhvc3RfY2FwcyAmICgxIDw8IHVzYl9yZWRpcl9jYXBfYnVsa19z
dHJlYW1zKSkgewotICAgICAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNi
X3JlZGlyX2NhcF9idWxrX3N0cmVhbXMpOwotICAgIH0KLSAgICB1c2JyZWRpcnBhcnNlcl9pbml0
KGNoLT5oaWRkZW5fcGFyc2VyLCBQQUNLQUdFX1NUUklORywgY2FwcywgVVNCX1JFRElSX0NBUFNf
U0laRSwgZmxhZ3MpOworICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2Jf
cmVkaXJfY2FwX2RldmljZV9kaXNjb25uZWN0X2Fjayk7CisgICAgdXNicmVkaXJwYXJzZXJfY2Fw
c19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfZXBfaW5mb19tYXhfcGFja2V0X3NpemUpOwor
ICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJfY2FwXzY0Yml0
c19pZHMpOworICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJf
Y2FwXzMyYml0c19idWxrX2xlbmd0aCk7CisgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2Fw
KGNhcHMsIHVzYl9yZWRpcl9jYXBfYnVsa19yZWNlaXZpbmcpOworICAgIHVzYnJlZGlycGFyc2Vy
X2NhcHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJfY2FwX2J1bGtfc3RyZWFtcyk7CisKKyAgICB1
c2JyZWRpcnBhcnNlcl9pbml0KGNoLT5wYXJzZXIsIFBBQ0tBR0VfU1RSSU5HLCBjYXBzLCBVU0Jf
UkVESVJfQ0FQU19TSVpFLCBmbGFncyk7CiB9CiAKIC8qCkBAIC0xMTg3LDcgKzExODIsNyBAQCBz
dGF0aWMgZ2Jvb2xlYW4gYXR0YWNoX2VkZXYoU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsCiAg
ICAgICAgICAgIF8oIkZhaWxlZCB0byByZWRpcmVjdCBkZXZpY2UgJWQiKSwgMSk7CiAgICAgICAg
IHJldHVybiBGQUxTRTsKICAgICB9Ci0gICAgaWYgKGNoLT51c2JyZWRpcmhvc3QgJiYgIWNoLT5o
ZWxsb19kb25lX3BhcnNlcikgeworICAgIGlmIChjaC0+c3RhdGUgPT0gVVNCX0NIQU5ORUxfU1RB
VEVfSU5JVElBTElaSU5HKSB7CiAgICAgICAgIC8qCiAgICAgICAgICAgICB3ZSBjYW4ndCBpbml0
aWFsaXplIHBhcnNlciB1bnRpbCB3ZSBzZWUgaGVsbG8gZnJvbSB1c2JyZWRpcgogICAgICAgICAg
ICAgYW5kIHRoZSBwYXJzZXIgY2FuJ3Qgd29yayB1bnRpbCBpdCBzZWVzIHRoZSBoZWxsbyByZXNw
b25zZS4KQEAgLTExOTcsMTUgKzExOTIsMTMgQEAgc3RhdGljIGdib29sZWFuIGF0dGFjaF9lZGV2
KFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLAogICAgICAgICBTUElDRV9ERUJVRygiJXMgd2Fp
dGluZyB1bnRpbCB0aGUgY2hhbm5lbCBpcyByZWFkeSIsIF9fRlVOQ1RJT05fXyk7CiAKICAgICB9
IGVsc2UgewotICAgICAgICBpbml0aWFsaXplX3BhcnNlcihjaCwgY2gtPmhpZGRlbl9ob3N0ID09
IE5VTEwpOwotICAgICAgICBjaC0+dXNicmVkaXJob3N0ID0gTlVMTDsKLSAgICAgICAgY2gtPnBh
cnNlciA9IGNoLT5oaWRkZW5fcGFyc2VyOworICAgICAgICBjaC0+c3RhdGUgPSBVU0JfQ0hBTk5F
TF9TVEFURV9QQVJTRVI7CiAgICAgfQogICAgIGNoLT53YWl0X2Rpc2Nvbm5lY3RfYWNrID0gMDsK
ICAgICBjaC0+YXR0YWNoZWQgPSBkZXY7CiAgICAgZGV2LT5hdHRhY2hlZF90byA9IGNoOwotICAg
IGRldmljZV9vcHMoZGV2LT5lZGV2KS0+YXR0YWNoKGRldi0+ZWRldiwgY2gtPmhpZGRlbl9wYXJz
ZXIpOwotICAgIGlmIChjaC0+aGVsbG9fZG9uZV9wYXJzZXIpIHsKKyAgICBkZXZpY2Vfb3BzKGRl
di0+ZWRldiktPmF0dGFjaChkZXYtPmVkZXYsIGNoLT5wYXJzZXIpOworICAgIGlmIChjaC0+c3Rh
dGUgPT0gVVNCX0NIQU5ORUxfU1RBVEVfUEFSU0VSKSB7CiAgICAgICAgIC8qIHNlbmQgZGV2aWNl
IGluZm8gKi8KICAgICAgICAgdXNicmVkaXJfaGVsbG8oY2gsIE5VTEwpOwogICAgIH0KQEAgLTEy
MjUsOSArMTIxOCwxNSBAQCBnYm9vbGVhbiBzcGljZV91c2JfYmFja2VuZF9jaGFubmVsX2F0dGFj
aChTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwKICAgICAgICAgcmV0dXJuIGF0dGFjaF9lZGV2
KGNoLCBkZXYsIGVycm9yKTsKICAgICB9CiAKKyAgICAvLyBubyBwaHlzaWNhbCBkZXZpY2UgZW5h
YmxlZAorICAgIGlmIChjaC0+dXNicmVkaXJob3N0ID09IE5VTEwpIHsKKyAgICAgICAgcmV0dXJu
IEZBTFNFOworICAgIH0KKwogICAgIGxpYnVzYl9kZXZpY2VfaGFuZGxlICpoYW5kbGUgPSBOVUxM
OwotICAgIGNoLT51c2JyZWRpcmhvc3QgPSBjaC0+aGlkZGVuX2hvc3Q7Ci0gICAgY2gtPnBhcnNl
ciA9IE5VTEw7CisgICAgaWYgKGNoLT5zdGF0ZSAhPSBVU0JfQ0hBTk5FTF9TVEFURV9JTklUSUFM
SVpJTkcpIHsKKyAgICAgICAgY2gtPnN0YXRlID0gVVNCX0NIQU5ORUxfU1RBVEVfSE9TVDsKKyAg
ICB9CiAKICAgICAvKgogICAgICAgIFVuZGVyIFdpbmRvd3Mgd2UgbmVlZCB0byBhdm9pZCB1cGRh
dGluZwpAQCAtMTI2OCwxMCArMTI2NywxMCBAQCB2b2lkIHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5u
ZWxfZGV0YWNoKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoKQogICAgICAgICBTUElDRV9ERUJV
RygiJXM6IG5vdGhpbmcgdG8gZGV0YWNoIiwgX19GVU5DVElPTl9fKTsKICAgICAgICAgcmV0dXJu
OwogICAgIH0KLSAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgeworICAgIGlmIChjaC0+c3RhdGUg
PT0gVVNCX0NIQU5ORUxfU1RBVEVfSE9TVCkgewogICAgICAgICAvKiBpdCB3aWxsIGNhbGwgbGli
dXNiX2Nsb3NlIGludGVybmFsbHkgKi8KICAgICAgICAgdXNicmVkaXJob3N0X3NldF9kZXZpY2Uo
Y2gtPnVzYnJlZGlyaG9zdCwgTlVMTCk7Ci0gICAgfSBlbHNlIGlmIChjaC0+cGFyc2VyKSB7Cisg
ICAgfSBlbHNlIHsKICAgICAgICAgaWYgKGVkZXYpIHsKICAgICAgICAgICAgIGRldmljZV9vcHMo
ZWRldiktPmRldGFjaChlZGV2KTsKICAgICAgICAgfQpAQCAtMTI3OSw5ICsxMjc4LDggQEAgdm9p
ZCBzcGljZV91c2JfYmFja2VuZF9jaGFubmVsX2RldGFjaChTcGljZVVzYkJhY2tlbmRDaGFubmVs
ICpjaCkKICAgICAgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2soY2gpOwogICAgICAg
ICBjaC0+d2FpdF9kaXNjb25uZWN0X2FjayA9CiAgICAgICAgICAgICB1c2JyZWRpcnBhcnNlcl9w
ZWVyX2hhc19jYXAoY2gtPnBhcnNlciwgdXNiX3JlZGlyX2NhcF9kZXZpY2VfZGlzY29ubmVjdF9h
Y2spOwotICAgICAgICBpZiAoIWNoLT53YWl0X2Rpc2Nvbm5lY3RfYWNrKSB7Ci0gICAgICAgICAg
ICBjaC0+dXNicmVkaXJob3N0ID0gY2gtPmhpZGRlbl9ob3N0OwotICAgICAgICAgICAgY2gtPnBh
cnNlciA9IE5VTEw7CisgICAgICAgIGlmICghY2gtPndhaXRfZGlzY29ubmVjdF9hY2sgJiYgY2gt
PnVzYnJlZGlyaG9zdCAhPSBOVUxMKSB7CisgICAgICAgICAgICBjaC0+c3RhdGUgPSBVU0JfQ0hB
Tk5FTF9TVEFURV9IT1NUOwogICAgICAgICB9CiAgICAgfQogICAgIFNQSUNFX0RFQlVHKCIlcyBj
aCAlcCwgZGV0YWNoIGRvbmUiLCBfX0ZVTkNUSU9OX18sIGNoKTsKQEAgLTEzMTcsMTYgKzEzMTUs
MjIgQEAgc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9uZXcoU3BpY2VVc2JCYWNrZW5kICpiZSwK
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2JyZWRpcnBhcnNlcl93
YXJuaW5nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2JyZWRpcmhvc3Rf
Zmxfd3JpdGVfY2Jfb3duc19idWZmZXIpOwogICAgICAgICBnX3dhcm5faWZfZmFpbChjaC0+dXNi
cmVkaXJob3N0ICE9IE5VTEwpOworICAgICAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCAhPSBOVUxM
KSB7CisgICAgICAgICAgICB1c2JyZWRpcmhvc3Rfc2V0X2J1ZmZlcmVkX291dHB1dF9zaXplX2Ni
KGNoLT51c2JyZWRpcmhvc3QsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgIHVzYnJlZGlyX2J1ZmZlcmVkX291dHB1dF9zaXplX2NhbGxiYWNrKTsK
KyAgICAgICAgICAgIC8vIGZvcmNlIGZsdXNoIG9mIEhFTExPIHBhY2tldCBhbmQgY3JlYXRpb24g
b2YgcGFyc2VyCisgICAgICAgICAgICB1c2JyZWRpcmhvc3Rfd3JpdGVfZ3Vlc3RfZGF0YShjaC0+
dXNicmVkaXJob3N0KTsKKyAgICAgICAgfQorICAgIH0gZWxzZSB7CisgICAgICAgIC8vIG5vIHBo
eXNpY2FsIGRldmljZSBzdXBwb3J0LCBvbmx5IGVtdWxhdGVkLCBjcmVhdGUgdGhlCisgICAgICAg
IC8vIHBhcnNlcgorICAgICAgICBjaC0+cGFyc2VyID0gY3JlYXRlX3BhcnNlcihjaCk7CisgICAg
ICAgIGlmIChjaC0+cGFyc2VyICE9IE5VTEwpIHsKKyAgICAgICAgICAgIGluaXRpYWxpemVfcGFy
c2VyKGNoKTsKKyAgICAgICAgfQogICAgIH0KIAotICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7
Ci0gICAgICAgIGNoLT5oaWRkZW5fcGFyc2VyID0gY3JlYXRlX3BhcnNlcihjaCk7Ci0gICAgICAg
IGNoLT5oaWRkZW5faG9zdCA9IGNoLT51c2JyZWRpcmhvc3Q7Ci0gICAgICAgIHVzYnJlZGlyaG9z
dF9zZXRfYnVmZmVyZWRfb3V0cHV0X3NpemVfY2IoY2gtPnVzYnJlZGlyaG9zdCwKLSAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2JyZWRpcl9idWZmZXJl
ZF9vdXRwdXRfc2l6ZV9jYWxsYmFjayk7Ci0gICAgfQotCi0gICAgaWYgKCFjaC0+aGlkZGVuX3Bh
cnNlcikgeworICAgIGlmICghY2gtPnBhcnNlcikgewogICAgICAgICBzcGljZV91c2JfYmFja2Vu
ZF9jaGFubmVsX2RlbGV0ZShjaCk7CiAgICAgICAgIGNoID0gTlVMTDsKICAgICB9CkBAIC0xMzM4
LDEyICsxMzQyLDkgQEAgc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9uZXcoU3BpY2VVc2JCYWNr
ZW5kICpiZSwKIHZvaWQgc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9mbHVzaF93cml0ZXMoU3Bp
Y2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gpCiB7CiAgICAgU1BJQ0VfREVCVUcoIiVzICVwIGlzIHVw
IiwgX19GVU5DVElPTl9fLCBjaCk7Ci0gICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKKyAgICBp
ZiAoY2gtPnN0YXRlICE9IFVTQl9DSEFOTkVMX1NUQVRFX1BBUlNFUiAmJiBjaC0+dXNicmVkaXJo
b3N0ICE9IE5VTEwpIHsKICAgICAgICAgdXNicmVkaXJob3N0X3dyaXRlX2d1ZXN0X2RhdGEoY2gt
PnVzYnJlZGlyaG9zdCk7Ci0gICAgICAgIGluaXRpYWxpemVfcGFyc2VyKGNoLCBGQUxTRSk7CiAg
ICAgfSBlbHNlIHsKLSAgICAgICAgaW5pdGlhbGl6ZV9wYXJzZXIoY2gsIFRSVUUpOwotICAgICAg
ICBjaC0+cGFyc2VyID0gY2gtPmhpZGRlbl9wYXJzZXI7CiAgICAgICAgIHVzYnJlZGlycGFyc2Vy
X2RvX3dyaXRlKGNoLT5wYXJzZXIpOwogICAgIH0KIH0KQEAgLTEzNTQsMTEgKzEzNTUsMTEgQEAg
dm9pZCBzcGljZV91c2JfYmFja2VuZF9jaGFubmVsX2RlbGV0ZShTcGljZVVzYkJhY2tlbmRDaGFu
bmVsICpjaCkKICAgICBpZiAoIWNoKSB7CiAgICAgICAgIHJldHVybjsKICAgICB9Ci0gICAgaWYg
KGNoLT5oaWRkZW5faG9zdCkgewotICAgICAgICB1c2JyZWRpcmhvc3RfY2xvc2UoY2gtPmhpZGRl
bl9ob3N0KTsKKyAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgeworICAgICAgICB1c2JyZWRpcmhv
c3RfY2xvc2UoY2gtPnVzYnJlZGlyaG9zdCk7CiAgICAgfQotICAgIGlmIChjaC0+aGlkZGVuX3Bh
cnNlcikgewotICAgICAgICB1c2JyZWRpcnBhcnNlcl9kZXN0cm95KGNoLT5oaWRkZW5fcGFyc2Vy
KTsKKyAgICBpZiAoY2gtPnBhcnNlcikgeworICAgICAgICB1c2JyZWRpcnBhcnNlcl9kZXN0cm95
KGNoLT5wYXJzZXIpOwogICAgIH0KIAogICAgIGlmIChjaC0+cnVsZXMpIHsKQEAgLTEzNzgsNyAr
MTM3OSw3IEBAIHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfZ2V0X2d1ZXN0X2ZpbHRlcihTcGlj
ZVVzYkJhY2tlbmRDaGFubmVsICpjaCwKICAgICBpbnQgaTsKICAgICAqciA9IE5VTEw7CiAgICAg
KmNvdW50ID0gMDsKLSAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgeworICAgIGlmIChjaC0+dXNi
cmVkaXJob3N0ICE9IE5VTEwpIHsKICAgICAgICAgdXNicmVkaXJob3N0X2dldF9ndWVzdF9maWx0
ZXIoY2gtPnVzYnJlZGlyaG9zdCwgciwgY291bnQpOwogICAgIH0KICAgICBpZiAoKnIgPT0gTlVM
TCkgewotLSAKMi4yMC4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fXwpTcGljZS1kZXZlbCBtYWlsaW5nIGxpc3QKU3BpY2UtZGV2ZWxAbGlzdHMuZnJlZWRl
c2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8v
c3BpY2UtZGV2ZWw=
