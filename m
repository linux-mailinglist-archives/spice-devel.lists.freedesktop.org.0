Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 0595890AA4
	for <lists+spice-devel@lfdr.de>; Sat, 17 Aug 2019 00:02:03 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 894486E9AC;
	Fri, 16 Aug 2019 22:02:01 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mail.codeweavers.com (mail.codeweavers.com [50.203.203.244])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 35D206E9AC
 for <spice-devel@lists.freedesktop.org>; Fri, 16 Aug 2019 22:02:00 +0000 (UTC)
Received: from cpe-107-184-2-226.socal.res.rr.com ([107.184.2.226]
 helo=brendan-dell.bslabs.net)
 by mail.codeweavers.com with esmtpsa (TLS1.2:ECDHE_RSA_AES_128_GCM_SHA256:128)
 (Exim 4.89) (envelope-from <bshanks@codeweavers.com>)
 id 1hykIH-00055d-PY; Fri, 16 Aug 2019 17:01:58 -0500
From: Brendan Shanks <bshanks@codeweavers.com>
To: spice-devel@lists.freedesktop.org
Date: Fri, 16 Aug 2019 15:01:29 -0700
Message-Id: <20190816220129.22027-4-bshanks@codeweavers.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190816220129.22027-1-bshanks@codeweavers.com>
References: <20190816220129.22027-1-bshanks@codeweavers.com>
X-Spam-Score: -106.0
X-Spam-Report: Spam detection software,
 running on the system "mail.codeweavers.com", 
 has NOT identified this incoming email as spam.  The original
 message has been attached to this so you can view it or label
 similar future email.  If you have any questions, see
 the administrator of that system for details.
 Content preview: Add a cache to allow the reuse of SHM segments. Shared memory
 segments are added to the cache instead of being deallocated, and the cache
 is searched instead of/before allocating a new segment. Both the SHM segments
 and their attachment with the X server are cached. 
 Content analysis details:   (-106.0 points, 5.0 required)
 pts rule name              description
 ---- ---------------------- --------------------------------------------------
 -100 USER_IN_WHITELIST      From: address is in the user's white-list
 -6.0 ALL_TRUSTED            Passed through trusted hosts only via SMTP
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt;
 c=relaxed/relaxed; 
 d=codeweavers.com; s=6377696661; h=References:In-Reply-To:Message-Id:Date:
 Subject:Cc:To:From:Sender:Reply-To:MIME-Version:Content-Type:
 Content-Transfer-Encoding:Content-ID:Content-Description:Resent-Date:
 Resent-From:Resent-Sender:Resent-To:Resent-Cc:Resent-Message-ID:List-Id:
 List-Help:List-Unsubscribe:List-Subscribe:List-Post:List-Owner:List-Archive;
 bh=53aLC8eOJUad/cAjh6Ef9gmCGMBoqbGYrzMGaDiXl6U=; b=cMWcNPYVbFHFhLWJaJchrakR1
 KSWWs2qfgP2qQE2lRCrZBEH9InN8pjbTbtPmefMxO2GCC3wtSPXllF+SUIRtAas/Aq5yONcecYYcv
 rT6PvP5FJPc3F7VkfzpuAVQfe2LuOkFLD3F2tbFE04ffUxOL4fs+4HqdF/RrFC0bT2xd4=;
Subject: [Spice-devel] [PATCH x11spice v3 3/3] Add cache for SHM segments
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

QWRkIGEgY2FjaGUgdG8gYWxsb3cgdGhlIHJldXNlIG9mIFNITSBzZWdtZW50cy4KU2hhcmVkIG1l
bW9yeSBzZWdtZW50cyBhcmUgYWRkZWQgdG8gdGhlIGNhY2hlIGluc3RlYWQgb2YgYmVpbmcKZGVh
bGxvY2F0ZWQsIGFuZCB0aGUgY2FjaGUgaXMgc2VhcmNoZWQgaW5zdGVhZCBvZi9iZWZvcmUgYWxs
b2NhdGluZyBhCm5ldyBzZWdtZW50LgoKQm90aCB0aGUgU0hNIHNlZ21lbnRzIGFuZCB0aGVpciBh
dHRhY2htZW50IHdpdGggdGhlIFggc2VydmVyIGFyZSBjYWNoZWQuCgpUaGUgY2FjaGUgY3VycmVu
dGx5IGhhcyBhIGZpeGVkIG51bWJlciBvZiAxMCBlbnRyaWVzLCB0aGlzIHByb3ZpZGVkIGEKZ29v
ZCBjYWNoZSBoaXQgcmF0ZSB3aGlsZSBrZWVwaW5nIG1lbW9yeSB1c2FnZSB1bmRlciBjb250cm9s
LgpCdWlsZGluZyB3aXRoIERFQlVHX1NITV9DQUNIRSBkZWZpbmVkIGFuZCBydW5uaW5nIHdpdGgK
R19NRVNTQUdFU19ERUJVRz1hbGwgd2lsbCBwZXJpb2RpY2FsbHkgcHJpbnQgb3V0IHRoZSBTSE0g
Y2FjaGUgaGl0CnJhdGUuCgpPbiBteSBVYnVudHUgMTguMDQgc3lzdGVtIHJ1bm5pbmcgWEZDRTQg
d2l0aCBhIDI1NjB4MTQ0MCBzY3JlZW4sIHRoZQpjYWNoZSBoaXQgcmF0ZSBzdGFydHMgYXJvdW5k
IDcyJS4gT24tc2NyZWVuIHdpbmRvd3MgdGhhdCB1cGRhdGUgb2Z0ZW4KYW5kIGhhdmUgY29uc2lz
dGVudGx5LXNpemVkIGRhbWFnZSByZWN0YW5nbGVzIGFyZSB0aGUgYmVzdCBjYXNlLiBXaXRoCnNl
dmVyYWwgb2YgdGhvc2UgKHNjcm9sbGluZyB0ZXJtaW5hbCB3aW5kb3dzLCB3ZWIgYnJvd3NlciBz
aG93aW5nIGEKV2ViR0wgZGVtbyksIHRoZSBoaXQgcmF0ZSBzbG93bHkgcmlzZXMgdG8gYXJvdW5k
IDkyJS4KT3BlcmF0aW9ucyB0aGF0IGdlbmVyYXRlIHJhcGlkIGRhbWFnZSByZXBvcnRzIChsaWtl
IHJlc2l6aW5nIG9yIG1vdmluZwp3aW5kb3dzKSB3aWxsIGxvd2VyIHRoZSBoaXQgcmF0ZS4KClNp
Z25lZC1vZmYtYnk6IEJyZW5kYW4gU2hhbmtzIDxic2hhbmtzQGNvZGV3ZWF2ZXJzLmNvbT4KLS0t
CiBzcmMvZGlzcGxheS5jIHwgMTc1ICsrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrKysrKystLS0tCiBzcmMvZGlzcGxheS5oIHwgIDExICsrKy0KIDIgZmlsZXMgY2hhbmdl
ZCwgMTcwIGluc2VydGlvbnMoKyksIDE2IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL3NyYy9k
aXNwbGF5LmMgYi9zcmMvZGlzcGxheS5jCmluZGV4IGEyYTE4YjguLjU1NDYxYTIgMTAwNjQ0Ci0t
LSBhL3NyYy9kaXNwbGF5LmMKKysrIGIvc3JjL2Rpc3BsYXkuYwpAQCAtMjEzLDExICsyMTMsMTU1
IEBAIHN0YXRpYyBpbnQgcmVnaXN0ZXJfZm9yX2V2ZW50cyhkaXNwbGF5X3QgKmQpCiAgICAgcmV0
dXJuIDA7CiB9CiAKK3N0YXRpYyB2b2lkIHNobV9zZWdtZW50X2Rlc3Ryb3koZGlzcGxheV90ICpk
LCBzaG1fc2VnbWVudF90ICpzZWdtZW50KQoreworICAgIGlmIChzZWdtZW50LT5zaG1pZCA9PSAt
MSkgeworICAgICAgICByZXR1cm47CisgICAgfQorCisgICAgeGNiX3NobV9kZXRhY2goZC0+Yywg
c2VnbWVudC0+c2htc2VnKTsKKyAgICBzZWdtZW50LT5zaG1zZWcgPSAtMTsKKworICAgIHNobWR0
KHNlZ21lbnQtPnNobWFkZHIpOworICAgIHNlZ21lbnQtPnNobWFkZHIgPSBOVUxMOworCisgICAg
c2htY3RsKHNlZ21lbnQtPnNobWlkLCBJUENfUk1JRCwgTlVMTCk7CisgICAgc2VnbWVudC0+c2ht
aWQgPSAtMTsKK30KKworCitzdGF0aWMgaW50IHNobV9jYWNoZV9nZXQoZGlzcGxheV90ICpkLCBz
aXplX3Qgc2l6ZSwgc2htX3NlZ21lbnRfdCAqc2VnbWVudCkKK3sKKyAgICBpbnQgaSwgcmV0Owor
ICAgIHNobV9zZWdtZW50X3QgKmJpZ2dlcl9lbnRyeSA9IE5VTEw7CisgICAgc2htX3NlZ21lbnRf
dCAqZW50cnlfdG9fdXNlID0gTlVMTDsKKworI2lmIGRlZmluZWQoREVCVUdfU0hNX0NBQ0hFKQor
ICAgIHN0YXRpYyBndWludCBjYWNoZV9oaXRzID0gMDsKKyAgICBzdGF0aWMgZ3VpbnQgY2FjaGVf
dG90YWwgPSAwOworCisgICAgY2FjaGVfdG90YWwrKzsKKyNlbmRpZgorCisgICAgZ19tdXRleF9s
b2NrKCZkLT5zaG1fY2FjaGVfbXV0ZXgpOworCisgICAgLyogQ2hlY2sgdGhlIGNhY2hlIGZvciBh
IHNlZ21lbnQgb2Ygc2l6ZSAnc2l6ZScgb3IgYmlnZ2VyLgorICAgICAqIFVzZSBhbiBleGFjdC1z
aXplIHNlZ21lbnQgaWYgZm91bmQuCisgICAgICogSWYgbm90LCB1c2UgdGhlIHNtYWxsZXN0IGVu
dHJ5IHRoYXQgaXMgYmlnIGVub3VnaC4KKyAgICAgKi8KKyAgICBmb3IgKGkgPSAwOyBpIDwgR19O
X0VMRU1FTlRTKGQtPnNobV9jYWNoZSk7IGkrKykgeworICAgICAgICBzaG1fc2VnbWVudF90ICpl
bnRyeSA9ICZkLT5zaG1fY2FjaGVbaV07CisKKyAgICAgICAgaWYgKGVudHJ5LT5zaG1pZCAhPSAt
MSkgeworICAgICAgICAgICAgLyogSWYgYSBjYWNoZSBlbnRyeSBvZiB0aGUgZXhhY3Qgc2l6ZSBi
ZWluZyByZXF1ZXN0ZWQgaXMgZm91bmQsIHVzZSB0aGF0ICovCisgICAgICAgICAgICBpZiAoc2l6
ZSA9PSBlbnRyeS0+c2l6ZSkgeworICAgICAgICAgICAgICAgIGVudHJ5X3RvX3VzZSA9IGVudHJ5
OworICAgICAgICAgICAgICAgIGJyZWFrOworICAgICAgICAgICAgfQorCisgICAgICAgICAgICAv
KiBLZWVwIHRyYWNrIG9mIHRoZSBuZXh0LWJpZ2dlc3QgZW50cnkgaW4gY2FzZSBhbiBleGFjdC1z
aXplIG1hdGNoIGlzbid0IGZvdW5kICovCisgICAgICAgICAgICBpZiAoc2l6ZSA8IGVudHJ5LT5z
aXplKSB7CisgICAgICAgICAgICAgICAgaWYgKChiaWdnZXJfZW50cnkgJiYgZW50cnktPnNpemUg
PCBiaWdnZXJfZW50cnktPnNpemUpIHx8ICFiaWdnZXJfZW50cnkpIHsKKyAgICAgICAgICAgICAg
ICAgICAgYmlnZ2VyX2VudHJ5ID0gZW50cnk7CisgICAgICAgICAgICAgICAgfQorICAgICAgICAg
ICAgfQorICAgICAgICB9CisgICAgfQorCisgICAgLyogQW4gZXhhY3Qtc2l6ZSBlbnRyeSB3YXNu
J3QgZm91bmQsIHVzZSB0aGUgbmV4dCBiaWdnZXN0IGVudHJ5IHRoYXQgd2FzIGZvdW5kICovCisg
ICAgaWYgKCFlbnRyeV90b191c2UpIHsKKyAgICAgICAgZW50cnlfdG9fdXNlID0gYmlnZ2VyX2Vu
dHJ5OworICAgIH0KKworICAgIGlmIChlbnRyeV90b191c2UpIHsKKyAgICAgICAgKnNlZ21lbnQg
PSAqZW50cnlfdG9fdXNlOworICAgICAgICBlbnRyeV90b191c2UtPnNobWlkID0gLTE7CisKKyAg
ICAgICAgcmV0ID0gMTsKKworI2lmIGRlZmluZWQoREVCVUdfU0hNX0NBQ0hFKQorICAgICAgICBj
YWNoZV9oaXRzKys7CisgICAgICAgIGlmICgoY2FjaGVfaGl0cyAlIDEwMCA9PSAwKSkgeworICAg
ICAgICAgICAgZ19kZWJ1ZygiU0hNIGNhY2hlIGhpdHJhdGU6ICV1LyV1ICglLjJmJSUpIiwgY2Fj
aGVfaGl0cywgY2FjaGVfdG90YWwsCisgICAgICAgICAgICAgICAgICAgIChmbG9hdCkgKChmbG9h
dCkgY2FjaGVfaGl0cyAvIChmbG9hdCkgY2FjaGVfdG90YWwpICogMTAwKTsKKyAgICAgICAgfQor
I2VuZGlmCisgICAgfSBlbHNlIHsKKyAgICAgICAgLyogTm8gdXNhYmxlIGVudHJ5IGZvdW5kIGlu
IHRoZSBjYWNoZSAqLworICAgICAgICByZXQgPSAwOworICAgIH0KKworICAgIGdfbXV0ZXhfdW5s
b2NrKCZkLT5zaG1fY2FjaGVfbXV0ZXgpOworICAgIHJldHVybiByZXQ7Cit9CisKK3N0YXRpYyBp
bnQgc2htX2NhY2hlX2FkZChkaXNwbGF5X3QgKmQsIHNobV9zZWdtZW50X3QgKnNlZ21lbnQpCit7
CisgICAgaW50IGksIHJldDsKKyAgICBzaG1fc2VnbWVudF90ICpzbWFsbGVzdF9lbnRyeSA9IE5V
TEw7CisgICAgc2htX3NlZ21lbnRfdCAqZW50cnlfdG9fdXNlID0gTlVMTDsKKworICAgIGdfbXV0
ZXhfbG9jaygmZC0+c2htX2NhY2hlX211dGV4KTsKKworICAgIC8qICdzZWdtZW50JyBpcyBub3cg
dW51c2VkLCB0cnkgdG8gYWRkIGl0IHRvIHRoZSBjYWNoZS4KKyAgICAgKiBVc2UgYW4gZW1wdHkg
c2xvdCBpbiB0aGUgY2FjaGUgaWYgYXZhaWxhYmxlLgorICAgICAqIElmIG5vdCwgZXZpY3QgdGhl
IHNtYWxsZXN0IGVudHJ5ICh3aGljaCBhbHNvIG11c3QgYmUgc21hbGxlciB0aGFuICdzZWdtZW50
JykgZnJvbSB0aGUgY2FjaGUuCisgICAgICovCisgICAgZm9yIChpID0gMDsgaSA8IEdfTl9FTEVN
RU5UUyhkLT5zaG1fY2FjaGUpOyBpKyspIHsKKyAgICAgICAgc2htX3NlZ21lbnRfdCAqZW50cnkg
PSAmZC0+c2htX2NhY2hlW2ldOworCisgICAgICAgIGlmIChlbnRyeS0+c2htaWQgPT0gLTEpIHsK
KyAgICAgICAgICAgIC8qIFVzZSBhbiBlbXB0eSBzbG90IGlmIGZvdW5kICovCisgICAgICAgICAg
ICBlbnRyeV90b191c2UgPSBlbnRyeTsKKyAgICAgICAgICAgIGJyZWFrOworICAgICAgICB9CisK
KyAgICAgICAgLyogS2VlcCB0cmFjayBvZiB0aGUgc21hbGxlc3QgZW50cnkgdGhhdCdzIHNtYWxs
ZXIgdGhhbiAnc2VnbWVudCcgKi8KKyAgICAgICAgaWYgKGVudHJ5LT5zaXplIDwgc2VnbWVudC0+
c2l6ZSkgeworICAgICAgICAgICAgaWYgKHNtYWxsZXN0X2VudHJ5ICYmIGVudHJ5LT5zaXplIDwg
c21hbGxlc3RfZW50cnktPnNpemUpIHsKKyAgICAgICAgICAgICAgICBzbWFsbGVzdF9lbnRyeSA9
IGVudHJ5OworICAgICAgICAgICAgfSBlbHNlIGlmICghc21hbGxlc3RfZW50cnkpIHsKKyAgICAg
ICAgICAgICAgICBzbWFsbGVzdF9lbnRyeSA9IGVudHJ5OworICAgICAgICAgICAgfQorICAgICAg
ICB9CisgICAgfQorCisgICAgLyogSWYgbm8gZW1wdHkgZW50cmllcyB3ZXJlIGZvdW5kLCBldmlj
dCAnc21hbGxlc3RfZW50cnknIGFuZCByZXVzZSBpdCAqLworICAgIGlmICghZW50cnlfdG9fdXNl
ICYmIHNtYWxsZXN0X2VudHJ5KSB7CisgICAgICAgIHNobV9zZWdtZW50X2Rlc3Ryb3koZCwgc21h
bGxlc3RfZW50cnkpOworICAgICAgICBlbnRyeV90b191c2UgPSBzbWFsbGVzdF9lbnRyeTsKKyAg
ICB9CisKKyAgICBpZiAoZW50cnlfdG9fdXNlKSB7CisgICAgICAgICplbnRyeV90b191c2UgPSAq
c2VnbWVudDsKKyAgICAgICAgcmV0ID0gMTsKKyAgICB9IGVsc2UgeworICAgICAgICAvKiBDYWNo
ZSBpcyBmdWxsLCBhbmQgY29udGFpbmVkIG5vIGVudHJpZXMgc21hbGxlciB0aGFuIHRoZSBvbmUg
YmVpbmcgYWRkZWQgKi8KKyAgICAgICAgcmV0ID0gMDsKKyAgICB9CisKKyAgICBnX211dGV4X3Vu
bG9jaygmZC0+c2htX2NhY2hlX211dGV4KTsKKyAgICByZXR1cm4gcmV0OworfQorCitzdGF0aWMg
dm9pZCBzaG1fY2FjaGVfZGVzdHJveShkaXNwbGF5X3QgKmQpCit7CisgICAgaW50IGk7CisKKyAg
ICBnX211dGV4X2xvY2soJmQtPnNobV9jYWNoZV9tdXRleCk7CisgICAgZm9yIChpID0gMDsgaSA8
IEdfTl9FTEVNRU5UUyhkLT5zaG1fY2FjaGUpOyBpKyspIHsKKyAgICAgICAgc2htX3NlZ21lbnRf
dCAqZW50cnkgPSAmZC0+c2htX2NhY2hlW2ldOworCisgICAgICAgIHNobV9zZWdtZW50X2Rlc3Ry
b3koZCwgZW50cnkpOworICAgIH0KKyAgICBnX211dGV4X3VubG9jaygmZC0+c2htX2NhY2hlX211
dGV4KTsKK30KIAogaW50IGRpc3BsYXlfb3BlbihkaXNwbGF5X3QgKmQsIHNlc3Npb25fdCAqc2Vz
c2lvbikKIHsKICAgICBpbnQgc2NyOwogICAgIGludCByYzsKKyAgICBpbnQgaTsKICAgICB4Y2Jf
ZGFtYWdlX3F1ZXJ5X3ZlcnNpb25fY29va2llX3QgZGNvb2tpZTsKICAgICB4Y2JfZGFtYWdlX3F1
ZXJ5X3ZlcnNpb25fcmVwbHlfdCAqZGFtYWdlX3ZlcnNpb247CiAgICAgeGNiX3hrYl91c2VfZXh0
ZW5zaW9uX2Nvb2tpZV90IHVzZV9jb29raWU7CkBAIC0zMTQsNiArNDU4LDExIEBAIGludCBkaXNw
bGF5X29wZW4oZGlzcGxheV90ICpkLCBzZXNzaW9uX3QgKnNlc3Npb24pCiAgICAgaWYgKHJjKQog
ICAgICAgICByZXR1cm4gcmM7CiAKKyAgICBnX211dGV4X2luaXQoJmQtPnNobV9jYWNoZV9tdXRl
eCk7CisgICAgZm9yIChpID0gMDsgaSA8IEdfTl9FTEVNRU5UUyhkLT5zaG1fY2FjaGUpOyBpKysp
IHsKKyAgICAgICAgZC0+c2htX2NhY2hlW2ldLnNobWlkID0gLTE7CisgICAgfQorCiAgICAgcmMg
PSBkaXNwbGF5X2NyZWF0ZV9zY3JlZW5faW1hZ2VzKGQpOwogCiAgICAgZ19tZXNzYWdlKCJEaXNw
bGF5ICVzIG9wZW5lZCIsIHNlc3Npb24tPm9wdGlvbnMuZGlzcGxheSA/IHNlc3Npb24tPm9wdGlv
bnMuZGlzcGxheSA6ICIiKTsKQEAgLTMyMSwxNyArNDcwLDYgQEAgaW50IGRpc3BsYXlfb3Blbihk
aXNwbGF5X3QgKmQsIHNlc3Npb25fdCAqc2Vzc2lvbikKICAgICByZXR1cm4gcmM7CiB9CiAKLS8q
IAotICBUT0RPOiBJbXBsZW1lbnQgYSBjYWNoZSBmb3Igc2hhcmVkIG1lbW9yeSBoYW5kbGVzCi0g
ICAgICAgIFRoYXQgaXMsIGluc3RlYWQgb2YgZG9pbmcgdGhlIHNobWdldC9zaG1hdCBmb3IgZXZl
cnkgcmVhZCwKLSAgICAgICAgd2Ugc2hvdWxkIGNhY2hlIHRoZSBzaG1pZCwgYW5kIHJldXNlIGlm
IHdlJ3JlIGRvaW5nIGEgbGF0ZXIKLSAgICAgICAgcmVhZCBvZiBhIHNpbWlsYXIgc2l6ZS4KLQot
ICAgICAgICBXZSB3b3VsZCBsaWtlbHkgc2VlIGEgNDAlIGltcHJvdmVtZW50IGluIHJhdyByZWFk
IHRpbWUuICBOb3RlCi0gICAgICAgIHRoYXQgYSBjYWxsZ3JpbmQgcnVuIHN1Z2dlc3RlZCB0aGF0
IHdvdWxkIGJlIG9uIHRoZSBvcmRlciBvZiA1JQotICAgICAgICBvdmVyYWxsLgotKi8KLQogc2ht
X2ltYWdlX3QgKmNyZWF0ZV9zaG1faW1hZ2UoZGlzcGxheV90ICpkLCB1bnNpZ25lZCBpbnQgdywg
dW5zaWduZWQgaW50IGgpCiB7CiAgICAgc2htX2ltYWdlX3QgKnNobWk7CkBAIC0zNDksNiArNDg3
LDExIEBAIHNobV9pbWFnZV90ICpjcmVhdGVfc2htX2ltYWdlKGRpc3BsYXlfdCAqZCwgdW5zaWdu
ZWQgaW50IHcsIHVuc2lnbmVkIGludCBoKQogICAgIHNobWktPmJ5dGVzX3Blcl9saW5lID0gKGJp
dHNfcGVyX3BpeGVsKGQpIC8gOCkgKiBzaG1pLT53OwogICAgIGltZ3NpemUgPSBzaG1pLT5ieXRl
c19wZXJfbGluZSAqIHNobWktPmg7CiAKKyAgICBpZiAoc2htX2NhY2hlX2dldChkLCBpbWdzaXpl
LCAmc2htaS0+c2VnbWVudCkpIHsKKyAgICAgICAgcmV0dXJuIHNobWk7CisgICAgfQorCisgICAg
LyogTm8gdXNhYmxlIHNoYXJlZCBtZW1vcnkgc2VnbWVudCBmb3VuZCBpbiBjYWNoZSwgYWxsb2Nh
dGUgYSBuZXcgb25lICovCiAgICAgc2htaS0+c2VnbWVudC5zaG1pZCA9IHNobWdldChJUENfUFJJ
VkFURSwgaW1nc2l6ZSwgSVBDX0NSRUFUIHwgMDcwMCk7CiAgICAgaWYgKHNobWktPnNlZ21lbnQu
c2htaWQgIT0gLTEpCiAgICAgICAgIHNobWktPnNlZ21lbnQuc2htYWRkciA9IHNobWF0KHNobWkt
PnNlZ21lbnQuc2htaWQsIDAsIDApOwpAQCAtMzYwLDYgKzUwMyw3IEBAIHNobV9pbWFnZV90ICpj
cmVhdGVfc2htX2ltYWdlKGRpc3BsYXlfdCAqZCwgdW5zaWduZWQgaW50IHcsIHVuc2lnbmVkIGlu
dCBoKQogICAgIC8qIFdlIHRlbGwgc2htY3RsIHRvIGRldGFjaCBub3c7IHRoYXQgcHJldmVudHMg
dXMgZnJvbSBob2xkaW5nIHRoaXMKICAgICAgICBzaGFyZWQgbWVtb3J5IHNlZ21lbnQgZm9yZXZl
ciBpbiBjYXNlIG9mIGFibm9ybWFsIHByb2Nlc3MgZXhpdC4gKi8KICAgICBzaG1jdGwoc2htaS0+
c2VnbWVudC5zaG1pZCwgSVBDX1JNSUQsIE5VTEwpOworICAgIHNobWktPnNlZ21lbnQuc2l6ZSA9
IGltZ3NpemU7CiAKICAgICBzaG1pLT5zZWdtZW50LnNobXNlZyA9IHhjYl9nZW5lcmF0ZV9pZChk
LT5jKTsKICAgICBjb29raWUgPSB4Y2Jfc2htX2F0dGFjaF9jaGVja2VkKGQtPmMsIHNobWktPnNl
Z21lbnQuc2htc2VnLCBzaG1pLT5zZWdtZW50LnNobWlkLCAwKTsKQEAgLTQ1MSw5ICs1OTUsMTAg
QEAgdm9pZCBkaXNwbGF5X2NvcHlfaW1hZ2VfaW50b19mdWxsc2NyZWVuKGRpc3BsYXlfdCAqZCwg
c2htX2ltYWdlX3QgKnNobWksIGludCB4LAogCiB2b2lkIGRlc3Ryb3lfc2htX2ltYWdlKGRpc3Bs
YXlfdCAqZCwgc2htX2ltYWdlX3QgKnNobWkpCiB7Ci0gICAgeGNiX3NobV9kZXRhY2goZC0+Yywg
c2htaS0+c2VnbWVudC5zaG1zZWcpOwotICAgIHNobWR0KHNobWktPnNlZ21lbnQuc2htYWRkcik7
Ci0gICAgc2htY3RsKHNobWktPnNlZ21lbnQuc2htaWQsIElQQ19STUlELCBOVUxMKTsKKyAgICBp
ZiAoIXNobV9jYWNoZV9hZGQoZCwgJnNobWktPnNlZ21lbnQpKSB7CisgICAgICAgIC8qIENvdWxk
IG5vdCBhZGQgdG8gY2FjaGUsIGRlc3Ryb3kgdGhpcyBzZWdtZW50ICovCisgICAgICAgIHNobV9z
ZWdtZW50X2Rlc3Ryb3koZCwgJnNobWktPnNlZ21lbnQpOworICAgIH0KICAgICBpZiAoc2htaS0+
ZHJhd2FibGVfcHRyKQogICAgICAgICBmcmVlKHNobWktPmRyYXdhYmxlX3B0cik7CiAgICAgZnJl
ZShzaG1pKTsKQEAgLTUyMSw2ICs2NjYsOCBAQCB2b2lkIGRpc3BsYXlfc3RvcF9ldmVudF90aHJl
YWQoZGlzcGxheV90ICpkKQogCiB2b2lkIGRpc3BsYXlfY2xvc2UoZGlzcGxheV90ICpkKQogewor
ICAgIHNobV9jYWNoZV9kZXN0cm95KGQpOworICAgIGdfbXV0ZXhfY2xlYXIoJmQtPnNobV9jYWNo
ZV9tdXRleCk7CiAgICAgeGNiX2RhbWFnZV9kZXN0cm95KGQtPmMsIGQtPmRhbWFnZSk7CiAgICAg
ZGlzcGxheV9kZXN0cm95X3NjcmVlbl9pbWFnZXMoZCk7CiAgICAgeGNiX2Rpc2Nvbm5lY3QoZC0+
Yyk7CmRpZmYgLS1naXQgYS9zcmMvZGlzcGxheS5oIGIvc3JjL2Rpc3BsYXkuaAppbmRleCBkYTFi
OTkxLi4wYWVhMzQ4IDEwMDY0NAotLS0gYS9zcmMvZGlzcGxheS5oCisrKyBiL3NyYy9kaXNwbGF5
LmgKQEAgLTIxLDE4ICsyMSwxOSBAQAogI2lmbmRlZiBESVNQTEFZX0hfCiAjZGVmaW5lIERJU1BM
QVlfSF8KIAorI2luY2x1ZGUgPGdsaWIuaD4KICNpbmNsdWRlIDx4Y2IveGNiLmg+CiAjaW5jbHVk
ZSA8eGNiL2RhbWFnZS5oPgogI2luY2x1ZGUgPHhjYi9zaG0uaD4KIAotCiBzdHJ1Y3Qgc2Vzc2lv
bl9zdHJ1Y3Q7CiAKIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogKiogIFN0cnVjdHVyZSBkZWZpbml0
aW9ucwogKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiB0eXBlZGVmIHN0cnVjdCB7Ci0gICAgaW50IHNo
bWlkOworICAgIGludCBzaG1pZDsgICAgICAvKiBpZiBzaG1pZCBpcyAtMTogdGhlIHNobV9zZWdt
ZW50X3QgaXMgImVtcHR5Iiwgb3RoZXIgbWVtYmVycyBhcmUgdW5kZWZpbmVkICovCisgICAgc2l6
ZV90IHNpemU7CiAgICAgeGNiX3NobV9zZWdfdCBzaG1zZWc7CiAgICAgdm9pZCAqc2htYWRkcjsK
IH0gc2htX3NlZ21lbnRfdDsKQEAgLTYzLDYgKzY0LDEyIEBAIHR5cGVkZWYgc3RydWN0IHsKICAg
ICBzaG1faW1hZ2VfdCAqZnVsbHNjcmVlbjsKICAgICBzaG1faW1hZ2VfdCAqc2NhbmxpbmU7CiAK
KyAgICAvKiBUaGUgU0hNIGNhY2hlIGhvbGRzIHVwIHRvIDEwIHNlZ21lbnRzLCB0aGlzIHByb3Zp
ZGVzIGEgZ29vZCBjYWNoZQorICAgICAqIGhpdCByYXRlIHdoaWxlIGtlZXBpbmcgbWVtb3J5IHVz
YWdlIHJlYXNvbmFibGUuCisgICAgICovCisgICAgc2htX3NlZ21lbnRfdCBzaG1fY2FjaGVbMTBd
OworICAgIEdNdXRleCBzaG1fY2FjaGVfbXV0ZXg7CisKICAgICBwdGhyZWFkX3QgZXZlbnRfdGhy
ZWFkOwogICAgIHN0cnVjdCBzZXNzaW9uX3N0cnVjdCAqc2Vzc2lvbjsKIH0gZGlzcGxheV90Owot
LSAKMi4xNy4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
XwpTcGljZS1kZXZlbCBtYWlsaW5nIGxpc3QKU3BpY2UtZGV2ZWxAbGlzdHMuZnJlZWRlc2t0b3Au
b3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlzdGluZm8vc3BpY2Ut
ZGV2ZWw=
