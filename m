Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 11B587A78A
	for <lists+spice-devel@lfdr.de>; Tue, 30 Jul 2019 14:04:28 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 906606E4E8;
	Tue, 30 Jul 2019 12:04:26 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 64917891BB
 for <spice-devel@lists.freedesktop.org>; Tue, 30 Jul 2019 12:04:24 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx05.intmail.prod.int.phx2.redhat.com
 [10.5.11.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 0A51630A6960;
 Tue, 30 Jul 2019 12:04:24 +0000 (UTC)
Received: from fziglio.remote.csb (unknown [10.33.32.10])
 by smtp.corp.redhat.com (Postfix) with ESMTP id 90F955D6B2;
 Tue, 30 Jul 2019 12:04:22 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Tue, 30 Jul 2019 13:03:18 +0100
Message-Id: <20190730120331.17967-30-fziglio@redhat.com>
In-Reply-To: <20190730120331.17967-1-fziglio@redhat.com>
References: <20190730120331.17967-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.15
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.47]); Tue, 30 Jul 2019 12:04:24 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-gtk 30/44] usb-redir: add implementation
 of emulated CD device
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

RnJvbTogWXVyaSBCZW5kaXRvdmljaCA8eXVyaS5iZW5kaXRvdmljaEBkYXluaXguY29tPgoKVGhp
cyBtb2R1bGUgY29udGFpbnMgaW1wbGVtZW50YXRpb24gb2YgZW11bGF0ZWQgZGV2aWNlCmludGVy
ZmFjZSBmb3Igc2hhcmVkIENELgoKU2lnbmVkLW9mZi1ieTogWXVyaSBCZW5kaXRvdmljaCA8eXVy
aS5iZW5kaXRvdmljaEBkYXluaXguY29tPgotLS0KIHNyYy91c2ItZGV2aWNlLWNkLmMgfCA3OTQg
KysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysKIDEgZmlsZSBjaGFu
Z2VkLCA3OTQgaW5zZXJ0aW9ucygrKQogY3JlYXRlIG1vZGUgMTAwNjQ0IHNyYy91c2ItZGV2aWNl
LWNkLmMKCmRpZmYgLS1naXQgYS9zcmMvdXNiLWRldmljZS1jZC5jIGIvc3JjL3VzYi1kZXZpY2Ut
Y2QuYwpuZXcgZmlsZSBtb2RlIDEwMDY0NAppbmRleCAwMDAwMDAwMC4uMThkYmNlYTgKLS0tIC9k
ZXYvbnVsbAorKysgYi9zcmMvdXNiLWRldmljZS1jZC5jCkBAIC0wLDAgKzEsNzk0IEBACisvKiAt
Ki0gTW9kZTogQzsgYy1iYXNpYy1vZmZzZXQ6IDQ7IGluZGVudC10YWJzLW1vZGU6IG5pbCAtKi0g
Ki8KKy8qCisgICAgQ29weXJpZ2h0IChDKSAyMDE5IFJlZCBIYXQsIEluYy4KKworICAgIFJlZCBI
YXQgQXV0aG9yczoKKyAgICBZdXJpIEJlbmRpdG92aWNoPHliZW5kaXRvQHJlZGhhdC5jb20+CisK
KyAgICBUaGlzIGxpYnJhcnkgaXMgZnJlZSBzb2Z0d2FyZTsgeW91IGNhbiByZWRpc3RyaWJ1dGUg
aXQgYW5kL29yCisgICAgbW9kaWZ5IGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIExlc3Nl
ciBHZW5lcmFsIFB1YmxpYworICAgIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5IHRoZSBGcmVlIFNv
ZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlcgorICAgIHZlcnNpb24gMi4xIG9mIHRoZSBMaWNlbnNl
LCBvciAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgorCisgICAgVGhpcyBsaWJy
YXJ5IGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsCisg
ICAgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2Fy
cmFudHkgb2YKKyAgICBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFS
IFBVUlBPU0UuICBTZWUgdGhlIEdOVQorICAgIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNl
IGZvciBtb3JlIGRldGFpbHMuCisKKyAgICBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5
IG9mIHRoZSBHTlUgTGVzc2VyIEdlbmVyYWwgUHVibGljCisgICAgTGljZW5zZSBhbG9uZyB3aXRo
IHRoaXMgbGlicmFyeTsgaWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+
LgorKi8KKworI2luY2x1ZGUgImNvbmZpZy5oIgorCisjaWZkZWYgVVNFX1VTQlJFRElSCisKKyNp
bmNsdWRlIDxnbGliLW9iamVjdC5oPgorI2luY2x1ZGUgPGludHR5cGVzLmg+CisjaW5jbHVkZSA8
Z2lvL2dpby5oPgorI2luY2x1ZGUgPGdsaWIvZ2kxOG4tbGliLmg+CisjaW5jbHVkZSA8ZXJybm8u
aD4KKyNpbmNsdWRlIDxsaWJ1c2IuaD4KKyNpbmNsdWRlIDxmY250bC5oPgorCisjaWZkZWYgR19P
U19XSU4zMgorI2luY2x1ZGUgPHdpbmRvd3MuaD4KKyNpbmNsdWRlIDxudGRkY2RybS5oPgorI2lu
Y2x1ZGUgPG50ZGRtbWMuaD4KKyNlbHNlCisjaW5jbHVkZSA8c3lzL3N0YXQuaD4KKyNpbmNsdWRl
IDxzeXMvaW9jdGwuaD4KKyNpbmNsdWRlIDxsaW51eC9mcy5oPgorI2luY2x1ZGUgPGxpbnV4L2Nk
cm9tLmg+CisjZW5kaWYKKworI2luY2x1ZGUgInVzYi1lbXVsYXRpb24uaCIKKyNpbmNsdWRlICJj
ZC11c2ItYnVsay1tc2QuaCIKKwordHlwZWRlZiBzdHJ1Y3QgU3BpY2VDZExVCit7CisgICAgY2hh
ciAqZmlsZW5hbWU7CisgICAgR0ZpbGUgKmZpbGVfb2JqZWN0OworICAgIEdGaWxlSW5wdXRTdHJl
YW0gKnN0cmVhbTsKKyAgICB1aW50NjRfdCBzaXplOworICAgIHVpbnQzMl90IGJsb2NrU2l6ZTsK
KyAgICB1aW50MzJfdCBsb2FkZWQgOiAxOworICAgIHVpbnQzMl90IGRldmljZSA6IDE7Cit9IFNw
aWNlQ2RMVTsKKworI2RlZmluZSBNQVhfTFVOX1BFUl9ERVZJQ0UgICAgICAgICAgICAgIDEKKyNk
ZWZpbmUgVVNCMl9CQ0QgICAgICAgICAgICAgICAgICAgICAgICAweDIwMAorI2RlZmluZSBDRF9E
RVZfVklEICAgICAgICAgICAgICAgICAgICAgIDB4MmIyMworI2RlZmluZSBDRF9ERVZfUElEICAg
ICAgICAgICAgICAgICAgICAgIDB4Q0RDRAorI2RlZmluZSBDRF9ERVZfQ0xBU1MgICAgICAgICAg
ICAgICAgICAgIDgKKyNkZWZpbmUgQ0RfREVWX1NVQkNMQVNTICAgICAgICAgICAgICAgICA2Cisj
ZGVmaW5lIENEX0RFVl9QUk9UT0NPTCAgICAgICAgICAgICAgICAgMHg1MAorI2RlZmluZSBDRF9E
RVZfQkxPQ0tfU0laRSAgICAgICAgICAgICAgIDB4MjAwCisjZGVmaW5lIENEX0RFVl9NQVhfU0la
RSAgICAgICAgICAgICAgICAgNzM3MjgwMDAwCisjZGVmaW5lIERWRF9ERVZfQkxPQ0tfU0laRSAg
ICAgICAgICAgICAgMHg4MDAKKyNkZWZpbmUgTUFYX0JVTEtfSU5fUkVRVUVTVFMgICAgICAgICAg
ICA2NAorCitzdHJ1Y3QgQnVmZmVyZWRCdWxrUmVhZAoreworICAgIHN0cnVjdCB1c2JfcmVkaXJf
YnVsa19wYWNrZXRfaGVhZGVyIGhvdXQ7CisgICAgdWludDY0X3QgaWQ7Cit9OworCitzdHJ1Y3Qg
X1NwaWNlVXNiRW11bGF0ZWREZXZpY2UKK3sKKyAgICBVc2JEZXZpY2VPcHMgZGV2X29wczsKKyAg
ICBTcGljZVVzYkJhY2tlbmQgKmJhY2tlbmQ7CisgICAgU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpw
YXJlbnQ7CisgICAgc3RydWN0IHVzYnJlZGlycGFyc2VyICpwYXJzZXI7CisgICAgdm9pZCAqIG1z
YzsKKyAgICBTcGljZUNkTFUgdW5pdHNbTUFYX0xVTl9QRVJfREVWSUNFXTsKKyAgICBnYm9vbGVh
biBsb2NrZWQ7CisgICAgZ2Jvb2xlYW4gZGVsZXRlX29uX2VqZWN0OworICAgIGdib29sZWFuIGRl
bGV0aW5nOworICAgIHVpbnQzMl90IG51bV9yZWFkczsKKyAgICBzdHJ1Y3QgQnVmZmVyZWRCdWxr
UmVhZCByZWFkX2J1bGtbTUFYX0JVTEtfSU5fUkVRVUVTVFNdOworICAgIHVpbnQxNl90IHNlcmlh
bFs0XTsKKyAgICB1aW50OF90ICBtYXhfbHVuX2luZGV4OworfTsKKwordHlwZWRlZiBTcGljZVVz
YkVtdWxhdGVkRGV2aWNlIFVzYkNkOworCisjaWZuZGVmIEdfT1NfV0lOMzIKKworc3RhdGljIGlu
dCBjZF9kZXZpY2Vfb3Blbl9zdHJlYW0oU3BpY2VDZExVICp1bml0LCBjb25zdCBjaGFyICpmaWxl
bmFtZSkKK3sKKyAgICBpbnQgZXJyb3IgPSAwOworICAgIHVuaXQtPmRldmljZSA9IDA7CisKKyAg
ICBpZiAoIXVuaXQtPmZpbGVuYW1lICYmICFmaWxlbmFtZSkgeworICAgICAgICBTUElDRV9ERUJV
RygiJXM6IGZpbGUgbmFtZSBub3QgcHJvdmlkZWQiLCBfX0ZVTkNUSU9OX18pOworICAgICAgICBy
ZXR1cm4gLTE7CisgICAgfQorICAgIGlmICh1bml0LT5maWxlbmFtZSAmJiBmaWxlbmFtZSkgewor
ICAgICAgICBnX2ZyZWUodW5pdC0+ZmlsZW5hbWUpOworICAgICAgICB1bml0LT5maWxlbmFtZSA9
IE5VTEw7CisgICAgfQorICAgIGlmIChmaWxlbmFtZSkgeworICAgICAgICB1bml0LT5maWxlbmFt
ZSA9IGdfc3RyZHVwKGZpbGVuYW1lKTsKKyAgICB9CisKKyAgICBpbnQgZmQgPSBvcGVuKHVuaXQt
PmZpbGVuYW1lLCBPX1JET05MWSB8IE9fTk9OQkxPQ0spOworICAgIGlmIChmZCA+IDApIHsKKyAg
ICAgICAgc3RydWN0IHN0YXQgZmlsZV9zdGF0ID0geyAwIH07CisgICAgICAgIGlmIChmc3RhdChm
ZCwgJmZpbGVfc3RhdCkgfHwgZmlsZV9zdGF0LnN0X3NpemUgPT0gMCkgeworICAgICAgICAgICAg
ZmlsZV9zdGF0LnN0X3NpemUgPSAwOworICAgICAgICAgICAgdW5pdC0+ZGV2aWNlID0gMTsKKyAg
ICAgICAgICAgIGlmICghaW9jdGwoZmQsIEJMS0dFVFNJWkU2NCwgJmZpbGVfc3RhdC5zdF9zaXpl
KSAmJgorICAgICAgICAgICAgICAgICFpb2N0bChmZCwgQkxLU1NaR0VULCAmdW5pdC0+YmxvY2tT
aXplKSkgeworICAgICAgICAgICAgfQorICAgICAgICB9CisgICAgICAgIHVuaXQtPnNpemUgPSBm
aWxlX3N0YXQuc3Rfc2l6ZTsKKyAgICAgICAgY2xvc2UoZmQpOworICAgICAgICBpZiAodW5pdC0+
c2l6ZSkgeworICAgICAgICAgICAgdW5pdC0+ZmlsZV9vYmplY3QgPSBnX2ZpbGVfbmV3X2Zvcl9w
YXRoKHVuaXQtPmZpbGVuYW1lKTsKKyAgICAgICAgICAgIHVuaXQtPnN0cmVhbSA9IGdfZmlsZV9y
ZWFkKHVuaXQtPmZpbGVfb2JqZWN0LCBOVUxMLCBOVUxMKTsKKyAgICAgICAgfQorICAgICAgICBp
ZiAoIXVuaXQtPnN0cmVhbSkgeworICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBjYW4ndCBv
cGVuIHN0cmVhbSBvbiAlcyIsIF9fRlVOQ1RJT05fXywgdW5pdC0+ZmlsZW5hbWUpOworICAgICAg
ICAgICAgZ19vYmplY3RfdW5yZWYodW5pdC0+ZmlsZV9vYmplY3QpOworICAgICAgICAgICAgdW5p
dC0+ZmlsZV9vYmplY3QgPSBOVUxMOworICAgICAgICAgICAgZXJyb3IgPSAtMTsKKyAgICAgICAg
fQorICAgIH0KKyAgICBlbHNlIHsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBjYW4ndCBvcGVu
IGZpbGUgJXMiLCBfX0ZVTkNUSU9OX18sIHVuaXQtPmZpbGVuYW1lKTsKKyAgICAgICAgZXJyb3Ig
PSAtMTsKKyAgICB9CisKKyAgICByZXR1cm4gZXJyb3I7Cit9CisKK3N0YXRpYyBpbnQgY2RfZGV2
aWNlX2xvYWQoU3BpY2VDZExVICp1bml0LCBnYm9vbGVhbiBsb2FkKQoreworICAgIGludCBlcnJv
cjsKKyAgICBpZiAoIXVuaXQtPmRldmljZSB8fCAhdW5pdC0+ZmlsZW5hbWUpIHsKKyAgICAgICAg
cmV0dXJuIC0xOworICAgIH0KKyAgICBpbnQgZmQgPSBvcGVuKHVuaXQtPmZpbGVuYW1lLCBPX1JE
T05MWSB8IE9fTk9OQkxPQ0spOworICAgIGlmIChmZCA8IDApIHsKKyAgICAgICAgcmV0dXJuIC0x
OworICAgIH0KKyAgICBpZiAobG9hZCkgeworICAgICAgICBlcnJvciA9IGlvY3RsKGZkLCBDRFJP
TUNMT1NFVFJBWSwgMCk7CisgICAgfSBlbHNlIHsKKyAgICAgICAgZXJyb3IgPSBpb2N0bChmZCwg
Q0RST01fTE9DS0RPT1IsIDApOworICAgICAgICBlcnJvciA9IGlvY3RsKGZkLCBDRFJPTUVKRUNU
LCAwKTsKKyAgICB9CisgICAgaWYgKGVycm9yKSB7CisgICAgICAgIC8vIG5vdGUgdGhhdCBlamVj
dGluZyBtaWdodCBiZSBhdmFpbGFibGUgb25seSBmb3Igcm9vdAorICAgICAgICAvLyBsb2FkaW5n
IG1pZ2h0IGJlIGF2YWlsYWJsZSBhbHNvIGZvciByZWd1bGFyIHVzZXIKKyAgICAgICAgU1BJQ0Vf
REVCVUcoIiVzOiBjYW4ndCAlc2xvYWQgJXMsIHJlcyAlZCwgZXJybm8gJWQiLAorICAgICAgICAg
ICAgX19GVU5DVElPTl9fLCBsb2FkID8gIiIgOiAidW4iLCB1bml0LT5maWxlbmFtZSwgZXJyb3Is
IGVycm5vKTsKKyAgICB9CisgICAgY2xvc2UoZmQpOworICAgIHJldHVybiBlcnJvcjsKK30KKwor
c3RhdGljIGludCBjZF9kZXZpY2VfY2hlY2soU3BpY2VDZExVICp1bml0KQoreworICAgIGludCBl
cnJvcjsKKyAgICBpZiAoIXVuaXQtPmRldmljZSB8fCAhdW5pdC0+ZmlsZW5hbWUpIHsKKyAgICAg
ICAgcmV0dXJuIC0xOworICAgIH0KKyAgICBpbnQgZmQgPSBvcGVuKHVuaXQtPmZpbGVuYW1lLCBP
X1JET05MWSB8IE9fTk9OQkxPQ0spOworICAgIGlmIChmZCA8IDApIHsKKyAgICAgICAgcmV0dXJu
IC0xOworICAgIH0KKyAgICBlcnJvciA9IGlvY3RsKGZkLCBDRFJPTV9EUklWRV9TVEFUVVMsIDAp
OworICAgIGVycm9yID0gKGVycm9yID09IENEU19ESVNDX09LKSA/IDAgOiAtMTsKKyAgICBpZiAo
IWVycm9yKSB7CisgICAgICAgIGVycm9yID0gaW9jdGwoZmQsIENEUk9NX0RJU0NfU1RBVFVTLCAw
KTsKKyAgICAgICAgZXJyb3IgPSAoZXJyb3IgPT0gQ0RTX0RBVEFfMSkgPyAwIDogLTE7CisgICAg
fQorICAgIGNsb3NlKGZkKTsKKyAgICByZXR1cm4gZXJyb3I7Cit9CisKKyNlbHNlCisKK3N0YXRp
YyBnYm9vbGVhbiBpc19kZXZpY2VfbmFtZShjb25zdCBjaGFyICpmaWxlbmFtZSkKK3sKKyAgICBn
Ym9vbGVhbiBiID0gc3RybGVuKGZpbGVuYW1lKSA9PSAyICYmIGZpbGVuYW1lWzFdID09ICc6JzsK
KyAgICByZXR1cm4gYjsKK30KKworc3RhdGljIEhBTkRMRSBvcGVuX2ZpbGUoY29uc3QgY2hhciAq
ZmlsZW5hbWUpCit7CisgICAgSEFORExFIGggPSBDcmVhdGVGaWxlQShmaWxlbmFtZSwKKyAgICAg
ICAgICAgICAgICAgICAgICAgICAgIEdFTkVSSUNfUkVBRCwKKyAgICAgICAgICAgICAgICAgICAg
ICAgICAgIEZJTEVfU0hBUkVfUkVBRCB8IEZJTEVfU0hBUkVfV1JJVEUsCisgICAgICAgICAgICAg
ICAgICAgICAgICAgICBOVUxMLCBPUEVOX0VYSVNUSU5HLAorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgMCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgIE5VTEwpOworICAgIGlmIChoID09
IElOVkFMSURfSEFORExFX1ZBTFVFKSB7CisgICAgICAgIGggPSBOVUxMOworICAgIH0KKyAgICBy
ZXR1cm4gaDsKK30KKworc3RhdGljIHVpbnQzMl90IGlvY3RsX291dChIQU5ETEUgaCwgdWludDMy
X3QgY29kZSwgdm9pZCAqb3V0X2J1ZmZlciwgdWludDMyX3Qgb3V0X3NpemUpCit7CisgICAgdWlu
dDMyX3QgZXJyb3I7CisgICAgRFdPUkQgcmV0OworICAgIEJPT0wgYiA9IERldmljZUlvQ29udHJv
bChoLCBjb2RlLCBOVUxMLCAwLCBvdXRfYnVmZmVyLCBvdXRfc2l6ZSwgJnJldCwgTlVMTCk7Cisg
ICAgZXJyb3IgPSBiID8gMCA6IEdldExhc3RFcnJvcigpOworICAgIHJldHVybiBlcnJvcjsKK30K
Kworc3RhdGljIHVpbnQzMl90IGlvY3RsX25vbmUoSEFORExFIGgsIHVpbnQzMl90IGNvZGUpCit7
CisgICAgcmV0dXJuIGlvY3RsX291dChoLCBjb2RlLCBOVUxMLCAwKTsKK30KKworc3RhdGljIGdi
b29sZWFuIGNoZWNrX2RldmljZShIQU5ETEUgaCkKK3sKKyAgICBHRVRfQ09ORklHVVJBVElPTl9J
T0NUTF9JTlBVVCBjZmdJbiA9CisgICAgICAgIHsgRmVhdHVyZUNkUmVhZCwgU0NTSV9HRVRfQ09O
RklHVVJBVElPTl9SRVFVRVNUX1RZUEVfQUxMLCB7fSB9OworICAgIERXT1JEIHJldDsKKyAgICBH
RVRfQ09ORklHVVJBVElPTl9IRUFERVIgY2ZnT3V0OworICAgIHJldHVybiBEZXZpY2VJb0NvbnRy
b2woaCwgSU9DVExfQ0RST01fR0VUX0NPTkZJR1VSQVRJT04sCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAmY2ZnSW4sIHNpemVvZihjZmdJbiksICZjZmdPdXQsIHNpemVvZihjZmdPdXQpLAor
ICAgICAgICAgICAgICAgICAgICAgICAgICAgJnJldCwgTlVMTCk7Cit9CisKK3N0YXRpYyBpbnQg
Y2RfZGV2aWNlX29wZW5fc3RyZWFtKFNwaWNlQ2RMVSAqdW5pdCwgY29uc3QgY2hhciAqZmlsZW5h
bWUpCit7CisgICAgaW50IGVycm9yID0gMDsKKyAgICBIQU5ETEUgaDsKKyAgICB1bml0LT5kZXZp
Y2UgPSAwOworICAgIGlmICghdW5pdC0+ZmlsZW5hbWUgJiYgIWZpbGVuYW1lKSB7CisgICAgICAg
IFNQSUNFX0RFQlVHKCIlczogdW5uYW1lZCBmaWxlIiwgX19GVU5DVElPTl9fKTsKKyAgICAgICAg
cmV0dXJuIC0xOworICAgIH0KKyAgICBpZiAodW5pdC0+ZmlsZW5hbWUgJiYgZmlsZW5hbWUpIHsK
KyAgICAgICAgZ19mcmVlKHVuaXQtPmZpbGVuYW1lKTsKKyAgICAgICAgdW5pdC0+ZmlsZW5hbWUg
PSBOVUxMOworICAgIH0KKyAgICBpZiAoIWZpbGVuYW1lKSB7CisgICAgICAgIC8vIHJlb3Blbmlu
ZyB0aGUgc3RyZWFtIG9uIGV4aXN0aW5nIGZpbGUgbmFtZQorICAgIH0gZWxzZSBpZiAoaXNfZGV2
aWNlX25hbWUoZmlsZW5hbWUpKSB7CisgICAgICAgIHVuaXQtPmZpbGVuYW1lID0gZ19zdHJkdXBf
cHJpbnRmKCJcXFxcLlxcJXMiLCBmaWxlbmFtZSk7CisgICAgfSBlbHNlIHsKKyAgICAgICAgdW5p
dC0+ZmlsZW5hbWUgPSBnX3N0cmR1cChmaWxlbmFtZSk7CisgICAgfQorICAgIGggPSBvcGVuX2Zp
bGUodW5pdC0+ZmlsZW5hbWUpOworICAgIGlmIChoKSB7CisgICAgICAgIExBUkdFX0lOVEVHRVIg
c2l6ZSA9IHsgMCB9OworICAgICAgICBpZiAoIUdldEZpbGVTaXplRXgoaCwgJnNpemUpKSB7Cisg
ICAgICAgICAgICB1aW50NjRfdCBidWZmZXJbMjU2XTsKKyAgICAgICAgICAgIHVpbnQzMl90IHJl
czsKKyAgICAgICAgICAgIHVuaXQtPmRldmljZSA9IGNoZWNrX2RldmljZShoKTsKKyAgICAgICAg
ICAgIFNQSUNFX0RFQlVHKCIlczogQ0QgZGV2aWNlICVzcmVjb2duaXplZCBvbiAlcyIsCisgICAg
ICAgICAgICAgICAgX19GVU5DVElPTl9fLCB1bml0LT5kZXZpY2UgPyAiIiA6ICJOT1QgIiwgdW5p
dC0+ZmlsZW5hbWUpOworICAgICAgICAgICAgcmVzID0gaW9jdGxfb3V0KGgsIElPQ1RMX0RJU0tf
R0VUX0RSSVZFX0dFT01FVFJZX0VYLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZl
ciwgc2l6ZW9mKGJ1ZmZlcikpOworICAgICAgICAgICAgaWYgKCFyZXMpCisgICAgICAgICAgICB7
CisgICAgICAgICAgICAgICAgRElTS19HRU9NRVRSWV9FWCAqcGcgPSAoRElTS19HRU9NRVRSWV9F
WCAqKWJ1ZmZlcjsKKyAgICAgICAgICAgICAgICB1bml0LT5ibG9ja1NpemUgPSBwZy0+R2VvbWV0
cnkuQnl0ZXNQZXJTZWN0b3I7CisgICAgICAgICAgICAgICAgc2l6ZSA9IHBnLT5EaXNrU2l6ZTsK
KyAgICAgICAgICAgIH0gZWxzZSB7CisgICAgICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBj
YW4ndCBvYnRhaW4gc2l6ZSBvZiAlcyAoZXJyb3IgJXUpIiwKKyAgICAgICAgICAgICAgICAgICAg
X19GVU5DVElPTl9fLCB1bml0LT5maWxlbmFtZSwgcmVzKTsKKyAgICAgICAgICAgIH0KKyAgICAg
ICAgfQorICAgICAgICB1bml0LT5zaXplID0gc2l6ZS5RdWFkUGFydDsKKyAgICAgICAgQ2xvc2VI
YW5kbGUoaCk7CisgICAgICAgIGlmICh1bml0LT5zaXplKSB7CisgICAgICAgICAgICB1bml0LT5m
aWxlX29iamVjdCA9IGdfZmlsZV9uZXdfZm9yX3BhdGgodW5pdC0+ZmlsZW5hbWUpOworICAgICAg
ICAgICAgdW5pdC0+c3RyZWFtID0gZ19maWxlX3JlYWQodW5pdC0+ZmlsZV9vYmplY3QsIE5VTEws
IE5VTEwpOworICAgICAgICB9CisgICAgICAgIGlmICghdW5pdC0+c3RyZWFtKSB7CisgICAgICAg
ICAgICBTUElDRV9ERUJVRygiJXM6IGNhbid0IG9wZW4gc3RyZWFtIG9uICVzIiwgX19GVU5DVElP
Tl9fLCB1bml0LT5maWxlbmFtZSk7CisgICAgICAgICAgICBnX29iamVjdF91bnJlZih1bml0LT5m
aWxlX29iamVjdCk7CisgICAgICAgICAgICB1bml0LT5maWxlX29iamVjdCA9IE5VTEw7CisgICAg
ICAgICAgICBlcnJvciA9IC0xOworICAgICAgICB9CisgICAgfSBlbHNlIHsKKyAgICAgICAgU1BJ
Q0VfREVCVUcoIiVzOiBjYW4ndCBvcGVuIGZpbGUgJXMiLCBfX0ZVTkNUSU9OX18sIHVuaXQtPmZp
bGVuYW1lKTsKKyAgICAgICAgZXJyb3IgPSAtMTsKKyAgICB9CisgICAgcmV0dXJuIGVycm9yOwor
fQorCitzdGF0aWMgaW50IGNkX2RldmljZV9sb2FkKFNwaWNlQ2RMVSAqdW5pdCwgZ2Jvb2xlYW4g
bG9hZCkKK3sKKyAgICBpbnQgZXJyb3IgPSAwOworICAgIEhBTkRMRSBoOworICAgIGlmICghdW5p
dC0+ZGV2aWNlIHx8ICF1bml0LT5maWxlbmFtZSkgeworICAgICAgICByZXR1cm4gLTE7CisgICAg
fQorICAgIGggPSBvcGVuX2ZpbGUodW5pdC0+ZmlsZW5hbWUpOworICAgIGlmIChoKSB7CisgICAg
ICAgIHVpbnQzMl90IHJlcyA9IGlvY3RsX25vbmUoaCwgbG9hZCA/IElPQ1RMX1NUT1JBR0VfTE9B
RF9NRURJQSA6IElPQ1RMX1NUT1JBR0VfRUpFQ1RfTUVESUEpOworICAgICAgICBpZiAocmVzKSB7
CisgICAgICAgICAgICBTUElDRV9ERUJVRygiJXM6IGNhbid0ICVzbG9hZCAlcywgd2luIGVycm9y
ICV1IiwKKyAgICAgICAgICAgICAgICAgICAgICAgIF9fRlVOQ1RJT05fXywgbG9hZCA/ICIiIDog
InVuIiwgdW5pdC0+ZmlsZW5hbWUsIHJlcyk7CisgICAgICAgICAgICBlcnJvciA9IC0xOworICAg
ICAgICB9IGVsc2UgeworICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBkZXZpY2UgJXMgWyVz
XSIsCisgICAgICAgICAgICAgICAgICAgICAgICBfX0ZVTkNUSU9OX18sIGxvYWQgPyAibG9hZGVk
IiA6ICJlamVjdGVkIiwgdW5pdC0+ZmlsZW5hbWUpOworICAgICAgICB9CisgICAgICAgIENsb3Nl
SGFuZGxlKGgpOworICAgIH0KKyAgICByZXR1cm4gZXJyb3I7Cit9CisKK3N0YXRpYyBpbnQgY2Rf
ZGV2aWNlX2NoZWNrKFNwaWNlQ2RMVSAqdW5pdCkKK3sKKyAgICBpbnQgZXJyb3IgPSAwOworICAg
IENEUk9NX0RJU0tfREFUQSBkYXRhOworICAgIEhBTkRMRSBoOworICAgIGlmICghdW5pdC0+ZGV2
aWNlIHx8ICF1bml0LT5maWxlbmFtZSkgeworICAgICAgICByZXR1cm4gLTE7CisgICAgfQorICAg
IGggPSBvcGVuX2ZpbGUodW5pdC0+ZmlsZW5hbWUpOworICAgIGlmIChoKSB7CisgICAgICAgIHVp
bnQzMl90IHJlcyA9IGlvY3RsX25vbmUoaCwgSU9DVExfU1RPUkFHRV9DSEVDS19WRVJJRlkpOwor
ICAgICAgICBpZiAoIXJlcykgeworICAgICAgICAgICAgcmVzID0gaW9jdGxfb3V0KGgsIElPQ1RM
X0NEUk9NX0RJU0tfVFlQRSwgJmRhdGEsIHNpemVvZihkYXRhKSk7CisgICAgICAgIH0KKyAgICAg
ICAgaWYgKHJlcyAhPSAwIHx8IGRhdGEuRGlza0RhdGEgIT0gQ0RST01fRElTS19EQVRBX1RSQUNL
KSB7CisgICAgICAgICAgICBlcnJvciA9IC0xOworICAgICAgICB9CisgICAgICAgIENsb3NlSGFu
ZGxlKGgpOworICAgIH0KKyAgICByZXR1cm4gZXJyb3I7Cit9CisKKyNlbmRpZgorCitzdGF0aWMg
Z2Jvb2xlYW4gb3Blbl9zdHJlYW0oU3BpY2VDZExVICp1bml0LCBjb25zdCBjaGFyICpmaWxlbmFt
ZSkKK3sKKyAgICBnYm9vbGVhbiBiID0gRkFMU0U7CisgICAgYiA9IGNkX2RldmljZV9vcGVuX3N0
cmVhbSh1bml0LCBmaWxlbmFtZSkgPT0gMDsKKyAgICByZXR1cm4gYjsKK30KKworc3RhdGljIHZv
aWQgY2xvc2Vfc3RyZWFtKFNwaWNlQ2RMVSAqdW5pdCkKK3sKKyAgICBpZiAodW5pdC0+c3RyZWFt
KSB7CisgICAgICAgIGdfb2JqZWN0X3VucmVmKHVuaXQtPnN0cmVhbSk7CisgICAgICAgIHVuaXQt
PnN0cmVhbSA9IE5VTEw7CisgICAgfQorICAgIGlmICh1bml0LT5maWxlX29iamVjdCkgeworICAg
ICAgICBnX29iamVjdF91bnJlZih1bml0LT5maWxlX29iamVjdCk7CisgICAgICAgIHVuaXQtPmZp
bGVfb2JqZWN0ID0gTlVMTDsKKyAgICB9Cit9CisKK3N0YXRpYyBnYm9vbGVhbiBsb2FkX2x1bihV
c2JDZCAqZCwgaW50IHVuaXQsIGdib29sZWFuIGxvYWQpCit7CisgICAgZ2Jvb2xlYW4gYiA9IFRS
VUU7CisgICAgaWYgKGxvYWQgJiYgZC0+dW5pdHNbdW5pdF0uZGV2aWNlKSB7CisgICAgICAgIC8v
IHRoZXJlIGlzIG9uZSBwb3NzaWJsZSBwcm9ibGVtIGluIGNhc2Ugb3VyIGJhY2tlbmQgaXMgdGhl
CisgICAgICAgIC8vIGxvY2FsIENEIGRldmljZSBhbmQgaXQgaXMgZWplY3RlZAorICAgICAgICBj
ZF9kZXZpY2VfbG9hZCgmZC0+dW5pdHNbdW5pdF0sIFRSVUUpOworICAgICAgICBjbG9zZV9zdHJl
YW0oJmQtPnVuaXRzW3VuaXRdKTsKKyAgICAgICAgaWYgKGNkX2RldmljZV9jaGVjaygmZC0+dW5p
dHNbdW5pdF0pIHx8ICFvcGVuX3N0cmVhbSgmZC0+dW5pdHNbdW5pdF0sIE5VTEwpKSB7CisgICAg
ICAgICAgICByZXR1cm4gRkFMU0U7CisgICAgICAgIH0KKyAgICB9CisKKyAgICBpZiAobG9hZCkg
eworICAgICAgICBDZFNjc2lNZWRpYVBhcmFtZXRlcnMgbWVkaWFfcGFyYW1zID0geyAwIH07CisK
KyAgICAgICAgbWVkaWFfcGFyYW1zLnN0cmVhbSA9IGQtPnVuaXRzW3VuaXRdLnN0cmVhbTsKKyAg
ICAgICAgbWVkaWFfcGFyYW1zLnNpemUgPSBkLT51bml0c1t1bml0XS5zaXplOworICAgICAgICBt
ZWRpYV9wYXJhbXMuYmxvY2tfc2l6ZSA9IGQtPnVuaXRzW3VuaXRdLmJsb2NrU2l6ZTsKKyAgICAg
ICAgaWYgKG1lZGlhX3BhcmFtcy5ibG9ja19zaXplID09IENEX0RFVl9CTE9DS19TSVpFICYmCisg
ICAgICAgICAgICBtZWRpYV9wYXJhbXMuc2l6ZSAlIERWRF9ERVZfQkxPQ0tfU0laRSA9PSAwKSB7
CisgICAgICAgICAgICBtZWRpYV9wYXJhbXMuYmxvY2tfc2l6ZSA9IERWRF9ERVZfQkxPQ0tfU0la
RTsKKyAgICAgICAgfQorICAgICAgICBTUElDRV9ERUJVRygiJXM6IGxvYWRpbmcgJXMsIHNpemUg
JSIgUFJJdTY0ICIsIGJsb2NrICV1IiwKKyAgICAgICAgICAgICAgICAgICAgX19GVU5DVElPTl9f
LCBkLT51bml0c1t1bml0XS5maWxlbmFtZSwgbWVkaWFfcGFyYW1zLnNpemUsIG1lZGlhX3BhcmFt
cy5ibG9ja19zaXplKTsKKworICAgICAgICBiID0gIWNkX3VzYl9idWxrX21zZF9sb2FkKGQtPm1z
YywgdW5pdCwgJm1lZGlhX3BhcmFtcyk7CisKKyAgICAgICAgZC0+dW5pdHNbdW5pdF0ubG9hZGVk
ID0gISFiOworCisgICAgfSBlbHNlIHsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiB1bmxvYWRp
bmcgJXMiLCBfX0ZVTkNUSU9OX18sIGQtPnVuaXRzW3VuaXRdLmZpbGVuYW1lKTsKKyAgICAgICAg
Y2RfdXNiX2J1bGtfbXNkX3VubG9hZChkLT5tc2MsIHVuaXQpOworICAgICAgICBkLT51bml0c1t1
bml0XS5sb2FkZWQgPSBGQUxTRTsKKyAgICB9CisgICAgcmV0dXJuIGI7Cit9CisKK3N0YXRpYyB2
b2lkIHVzYl9jZF9kZWxldGUoVXNiQ2QgKmQpCit7CisgICAgdWludDMyX3QgdW5pdCA9IDA7Cisg
ICAgY2RfdXNiX2J1bGtfbXNkX3VucmVhbGl6ZShkLT5tc2MsIHVuaXQpOworICAgIGdfY2xlYXJf
cG9pbnRlcigmZC0+dW5pdHNbdW5pdF0uZmlsZW5hbWUsIGdfZnJlZSk7CisgICAgY2xvc2Vfc3Ry
ZWFtKCZkLT51bml0c1t1bml0XSk7CisgICAgZ19jbGVhcl9wb2ludGVyKCZkLT5tc2MsIGNkX3Vz
Yl9idWxrX21zZF9mcmVlKTsKKyAgICBnX2ZyZWUoZCk7Cit9CisKK3N0YXRpYyBnYm9vbGVhbiB1
c2JfY2RfZ2V0X2Rlc2NyaXB0b3IoVXNiQ2QgKmQsIHVpbnQ4X3QgdHlwZSwgdWludDhfdCBpbmRl
eCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdm9pZCAqKmJ1ZmZlciwg
dWludDE2X3QgKnNpemUpCit7CisgICAgc3RhdGljIHN0cnVjdCBsaWJ1c2JfZGV2aWNlX2Rlc2Ny
aXB0b3IgZGVzYyA9CisgICAgeworICAgICAgICAuYkxlbmd0aCA9IDE4LAorICAgICAgICAuYkRl
c2NyaXB0b3JUeXBlID0gTElCVVNCX0RUX0RFVklDRSwKKyAgICAgICAgLmJjZFVTQiA9IFVTQjJf
QkNELAorICAgICAgICAuYkRldmljZUNsYXNzID0gMCwKKyAgICAgICAgLmJEZXZpY2VTdWJDbGFz
cyA9IDAsCisgICAgICAgIC5iRGV2aWNlUHJvdG9jb2wgPSAwLAorICAgICAgICAuYk1heFBhY2tl
dFNpemUwID0gNjQsCisgICAgICAgIC5pZFZlbmRvciA9IENEX0RFVl9WSUQsCisgICAgICAgIC5p
ZFByb2R1Y3QgPSBDRF9ERVZfUElELAorICAgICAgICAuYmNkRGV2aWNlID0gMHgxMDAsCisgICAg
ICAgIC5pTWFudWZhY3R1cmVyID0gMSwKKyAgICAgICAgLmlQcm9kdWN0ID0gMiwKKyAgICAgICAg
LmlTZXJpYWxOdW1iZXIgPSAzLAorICAgICAgICAuYk51bUNvbmZpZ3VyYXRpb25zID0gMQorICAg
IH07CisgICAgc3RhdGljIHVpbnQ4X3QgY2ZnW10gPQorICAgIHsKKyAgICAgICAgOSwgLy9sZW4g
b2YgY2ZnIGRlc2MKKyAgICAgICAgTElCVVNCX0RUX0NPTkZJRywgLy8gZGVzYyB0eXBlCisgICAg
ICAgIDB4MjAsIC8vIHdsZW4KKyAgICAgICAgMCwKKyAgICAgICAgMSwgLy8gbnVtIGlmCisgICAg
ICAgIDEsIC8vIGNmZyB2YWwKKyAgICAgICAgMCwgLy8gY2ZnIG5hbWUKKyAgICAgICAgMHg4MCwg
Ly8gYnVzIHBvd2VyZWQKKyAgICAgICAgMHgzMiwgLy8gMTAwIG1hCisgICAgICAgIDksIC8vIGxl
biBvZiBJRiBkZXNjCisgICAgICAgIExJQlVTQl9EVF9JTlRFUkZBQ0UsCisgICAgICAgIDAsIC8v
IG51bSBpZgorICAgICAgICAwLCAvLyBhbHQgc2V0dGluZworICAgICAgICAyLCAvLyBudW0gb2Yg
ZW5kcG9pbnRzCisgICAgICAgIENEX0RFVl9DTEFTUywKKyAgICAgICAgQ0RfREVWX1NVQkNMQVNT
LAorICAgICAgICBDRF9ERVZfUFJPVE9DT0wsCisgICAgICAgIDAsIC8vIGlmIG5hbWUKKyAgICAg
ICAgNywKKyAgICAgICAgTElCVVNCX0RUX0VORFBPSU5ULAorICAgICAgICAweDgxLCAvLy0+RGly
ZWN0aW9uIDogSU4gLSBFbmRwb2ludElEIDogMQorICAgICAgICAweDAyLCAvLy0+QnVsayBUcmFu
c2ZlciBUeXBlCisgICAgICAgIDAsICAgIC8vd01heFBhY2tldFNpemUgOiAweDAyMDAgPSAweDIw
MCBtYXggYnl0ZXMKKyAgICAgICAgMiwKKyAgICAgICAgMCwgICAgLy9iSW50ZXJ2YWwKKyAgICAg
ICAgNywKKyAgICAgICAgTElCVVNCX0RUX0VORFBPSU5ULAorICAgICAgICAweDAyLCAvLy0+RGly
ZWN0aW9uIDogT1VUIC0gRW5kcG9pbnRJRCA6IDIKKyAgICAgICAgMHgwMiwgLy8tPkJ1bGsgVHJh
bnNmZXIgVHlwZQorICAgICAgICAwLCAgICAvL3dNYXhQYWNrZXRTaXplIDogMHgwMjAwID0gMHgy
MDAgbWF4IGJ5dGVzCisgICAgICAgIDIsCisgICAgICAgIDAsICAgIC8vYkludGVydmFsCisgICAg
fTsKKyAgICBzdGF0aWMgdWludDE2X3QgczBbMl0gPSB7IDB4MzA0LCAweDQwOSB9OworICAgIHN0
YXRpYyB1aW50MTZfdCBzMVs4XSA9IHsgMHgzMTAsICdSJywgJ2UnLCAnZCcsICcgJywgJ0gnLCAn
YScsICd0JyB9OworICAgIHN0YXRpYyB1aW50MTZfdCBzMls5XSA9IHsgMHgzMTIsICdTJywgJ3An
LCAnaScsICdjJywgJ2UnLCAnICcsICdDJywgJ0QnIH07CisKKyAgICB2b2lkICpwID0gTlVMTDsK
KyAgICB1aW50MTZfdCBsZW4gPSAwOworCisgICAgc3dpdGNoICh0eXBlKQorICAgIHsKKyAgICAg
ICAgY2FzZSBMSUJVU0JfRFRfREVWSUNFOgorICAgICAgICAgICAgcCA9ICZkZXNjOworICAgICAg
ICAgICAgbGVuID0gc2l6ZW9mKGRlc2MpOworICAgICAgICAgICAgYnJlYWs7CisgICAgICAgIGNh
c2UgTElCVVNCX0RUX0NPTkZJRzoKKyAgICAgICAgICAgIHAgPSBjZmc7CisgICAgICAgICAgICBs
ZW4gPSBzaXplb2YoY2ZnKTsKKyAgICAgICAgICAgIGJyZWFrOworICAgICAgICBjYXNlIExJQlVT
Ql9EVF9TVFJJTkc6CisgICAgICAgICAgICBpZiAoaW5kZXggPT0gMCkgeworICAgICAgICAgICAg
ICAgIHAgPSBzMDsgbGVuID0gc2l6ZW9mKHMwKTsKKyAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5k
ZXggPT0gMSkgeworICAgICAgICAgICAgICAgIHAgPSBzMTsgbGVuID0gc2l6ZW9mKHMxKTsKKyAg
ICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPT0gMikgeworICAgICAgICAgICAgICAgIHAgPSBz
MjsgbGVuID0gc2l6ZW9mKHMyKTsKKyAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPT0gMykg
eworICAgICAgICAgICAgICAgIHAgPSBkLT5zZXJpYWw7IGxlbiA9IHNpemVvZihkLT5zZXJpYWwp
OworICAgICAgICAgICAgfQorICAgICAgICAgICAgYnJlYWs7CisgICAgfQorCisgICAgaWYgKHAp
IHsKKyAgICAgICAgKmJ1ZmZlciA9IHA7CisgICAgICAgICpzaXplID0gbGVuOworICAgIH0KKwor
ICAgIHJldHVybiBwICE9IE5VTEw7Cit9CisKK3N0YXRpYyB2b2lkIHVzYl9jZF9hdHRhY2goVXNi
Q2QgKmRldmljZSwgc3RydWN0IHVzYnJlZGlycGFyc2VyICpwYXJzZXIpCit7CisgICAgZGV2aWNl
LT5wYXJzZXIgPSBwYXJzZXI7Cit9CisKK3N0YXRpYyB2b2lkIHVzYl9jZF9kZXRhY2goVXNiQ2Qg
KmRldmljZSkKK3sKKyAgICBkZXZpY2UtPnBhcnNlciA9IE5VTEw7Cit9CisKK3N0YXRpYyB2b2lk
IHVzYl9jZF9yZXNldChVc2JDZCAqZGV2aWNlKQoreworICAgIGNkX3VzYl9idWxrX21zZF9yZXNl
dChkZXZpY2UtPm1zYyk7Cit9CisKK3N0YXRpYyB2b2lkIHVzYl9jZF9jb250cm9sX3JlcXVlc3Qo
VXNiQ2QgKmRldmljZSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludDhf
dCAqZGF0YSwgaW50IGRhdGFfbGVuLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICBzdHJ1Y3QgdXNiX3JlZGlyX2NvbnRyb2xfcGFja2V0X2hlYWRlciAqaCwKKyAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgdm9pZCAqKmJ1ZmZlcikKK3sKKyAgICB1aW50OF90IHJl
cXR5cGUgPSBoLT5yZXF1ZXN0dHlwZSAmIDB4N2Y7CisgICAgaWYgKCFkZXZpY2UtPm1zYykgewor
ICAgICAgICByZXR1cm47CisgICAgfQorICAgIGlmIChyZXF0eXBlID09IChMSUJVU0JfUkVRVUVT
VF9UWVBFX1NUQU5EQVJEIHwgTElCVVNCX1JFQ0lQSUVOVF9FTkRQT0lOVCkpIHsKKyAgICAgICAg
Ly8gbWlnaHQgYmUgY2xlYXIgc3RhbGwgcmVxdWVzdAorICAgICAgICBoLT5sZW5ndGggPSAwOwor
ICAgICAgICBoLT5zdGF0dXMgPSB1c2JfcmVkaXJfc3VjY2Vzczs7CisgICAgICAgIHJldHVybjsK
KyAgICB9CisKKyAgICBpZiAocmVxdHlwZSA9PSAoTElCVVNCX1JFUVVFU1RfVFlQRV9DTEFTUyB8
IExJQlVTQl9SRUNJUElFTlRfSU5URVJGQUNFKSkgeworICAgICAgICBzd2l0Y2ggKGgtPnJlcXVl
c3QpIHsKKyAgICAgICAgICAgIGNhc2UgMHhGRjoKKyAgICAgICAgICAgICAgICAvLyBtYXNzLXN0
b3JhZ2UgY2xhc3MgcmVxdWVzdCAncmVzZXQnCisgICAgICAgICAgICAgICAgdXNiX2NkX3Jlc2V0
KGRldmljZSk7CisgICAgICAgICAgICAgICAgaC0+bGVuZ3RoID0gMDsKKyAgICAgICAgICAgICAg
ICBoLT5zdGF0dXMgPSB1c2JfcmVkaXJfc3VjY2VzczsKKyAgICAgICAgICAgICAgICBicmVhazsK
KyAgICAgICAgICAgIGNhc2UgMHhGRToKKyAgICAgICAgICAgICAgICAvLyBtYXNzLXN0b3JhZ2Ug
Y2xhc3MgcmVxdWVzdCAnZ2V0IG1heCBsdW4nCisgICAgICAgICAgICAgICAgLy8gcmV0dXJuaW5n
IG9uZSBieXRlCisgICAgICAgICAgICAgICAgaWYgKGgtPmxlbmd0aCkgeworICAgICAgICAgICAg
ICAgICAgICBoLT5sZW5ndGggPSAxOworICAgICAgICAgICAgICAgICAgICBoLT5zdGF0dXMgPSB1
c2JfcmVkaXJfc3VjY2Vzczs7CisgICAgICAgICAgICAgICAgICAgICpidWZmZXIgPSAmZGV2aWNl
LT5tYXhfbHVuX2luZGV4OworICAgICAgICAgICAgICAgIH0KKyAgICAgICAgICAgICAgICBicmVh
azsKKyAgICAgICAgfQorICAgIH0KK30KKworc3RhdGljIHZvaWQgdXNiX2NkX2J1bGtfb3V0X3Jl
cXVlc3QoVXNiQ2QgKmRldmljZSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
IHVpbnQ4X3QgZXAsIHVpbnQ4X3QgKmRhdGEsIGludCBkYXRhX2xlbiwKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIHVpbnQ4X3QgKnN0YXR1cykKK3sKKyAgICBpZiAoIWNkX3Vz
Yl9idWxrX21zZF93cml0ZShkZXZpY2UtPm1zYywgZGF0YSwgZGF0YV9sZW4pKSB7CisgICAgICAg
ICpzdGF0dXMgPSB1c2JfcmVkaXJfc3VjY2VzczsKKyAgICB9Cit9CisKK3ZvaWQgY2RfdXNiX2J1
bGtfbXNkX3JlYWRfY29tcGxldGUodm9pZCAqdXNlcl9kYXRhLAorICAgIHVpbnQ4X3QgKmRhdGEs
IHVpbnQzMl90IGxlbmd0aCwgQ2RVc2JCdWxrU3RhdHVzIHN0YXR1cykKK3sKKyAgICBVc2JDZCAq
ZCA9IChVc2JDZCAqKXVzZXJfZGF0YTsKKworICAgIGlmIChkLT5kZWxldGluZykgeworICAgICAg
ICBkLT5kZWxldGluZyA9IEZBTFNFOworICAgICAgICBzcGljZV91c2JfYmFja2VuZF9kZXZpY2Vf
ZWplY3QoZC0+YmFja2VuZCwgZC0+cGFyZW50KTsKKyAgICB9CisKKyAgICBpZiAoZC0+cGFyc2Vy
KSB7CisgICAgICAgIGludCBucmVhZDsKKyAgICAgICAgdWludDMyX3Qgb2Zmc2V0ID0gMDsKKwor
ICAgICAgICBmb3IgKG5yZWFkID0gMDsgbnJlYWQgPCBkLT5udW1fcmVhZHM7IG5yZWFkKyspIHsK
KyAgICAgICAgICAgIHVpbnQzMl90IG1heF9sZW47CisgICAgICAgICAgICBtYXhfbGVuID0gKGQt
PnJlYWRfYnVsa1tucmVhZF0uaG91dC5sZW5ndGhfaGlnaCA8PCAxNikgfAorICAgICAgICAgICAg
ICAgICAgICAgICAgZC0+cmVhZF9idWxrW25yZWFkXS5ob3V0Lmxlbmd0aDsKKyAgICAgICAgICAg
IGlmIChtYXhfbGVuID4gbGVuZ3RoKSB7CisgICAgICAgICAgICAgICAgbWF4X2xlbiA9IGxlbmd0
aDsKKyAgICAgICAgICAgICAgICBkLT5yZWFkX2J1bGtbbnJlYWRdLmhvdXQubGVuZ3RoID0gbGVu
Z3RoOworICAgICAgICAgICAgICAgIGQtPnJlYWRfYnVsa1tucmVhZF0uaG91dC5sZW5ndGhfaGln
aCA9IGxlbmd0aCA+PiAxNjsKKyAgICAgICAgICAgIH0KKworICAgICAgICAgICAgc3dpdGNoIChz
dGF0dXMpIHsKKyAgICAgICAgICAgIGNhc2UgQlVMS19TVEFUVVNfR09PRDoKKyAgICAgICAgICAg
ICAgICBkLT5yZWFkX2J1bGtbbnJlYWRdLmhvdXQuc3RhdHVzID0gdXNiX3JlZGlyX3N1Y2Nlc3M7
CisgICAgICAgICAgICAgICAgYnJlYWs7CisgICAgICAgICAgICBjYXNlIEJVTEtfU1RBVFVTX0NB
TkNFTEVEOgorICAgICAgICAgICAgICAgIGQtPnJlYWRfYnVsa1tucmVhZF0uaG91dC5zdGF0dXMg
PSB1c2JfcmVkaXJfY2FuY2VsbGVkOworICAgICAgICAgICAgICAgIGJyZWFrOworICAgICAgICAg
ICAgY2FzZSBCVUxLX1NUQVRVU19FUlJPUjoKKyAgICAgICAgICAgICAgICBkLT5yZWFkX2J1bGtb
bnJlYWRdLmhvdXQuc3RhdHVzID0gdXNiX3JlZGlyX2lvZXJyb3I7CisgICAgICAgICAgICAgICAg
YnJlYWs7CisgICAgICAgICAgICBjYXNlIEJVTEtfU1RBVFVTX1NUQUxMOgorICAgICAgICAgICAg
ZGVmYXVsdDoKKyAgICAgICAgICAgICAgICBkLT5yZWFkX2J1bGtbbnJlYWRdLmhvdXQuc3RhdHVz
ID0gdXNiX3JlZGlyX3N0YWxsOworICAgICAgICAgICAgICAgIGJyZWFrOworICAgICAgICAgICAg
fQorCisgICAgICAgICAgICBTUElDRV9ERUJVRygiJXM6IHJlc3BvbmRpbmcgJSIgUFJJdTY0ICIg
d2l0aCBsZW4gJXUgb3V0IG9mICV1LCBzdGF0dXMgJWQiLAorICAgICAgICAgICAgICAgICAgICAg
ICAgX19GVU5DVElPTl9fLCBkLT5yZWFkX2J1bGtbbnJlYWRdLmlkLCBtYXhfbGVuLAorICAgICAg
ICAgICAgICAgICAgICAgICAgbGVuZ3RoLCBkLT5yZWFkX2J1bGtbbnJlYWRdLmhvdXQuc3RhdHVz
KTsKKyAgICAgICAgICAgIHVzYnJlZGlycGFyc2VyX3NlbmRfYnVsa19wYWNrZXQoZC0+cGFyc2Vy
LCBkLT5yZWFkX2J1bGtbbnJlYWRdLmlkLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAmZC0+cmVhZF9idWxrW25yZWFkXS5ob3V0LAorICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhfbGVuID8gKGRhdGEgKyBvZmZzZXQpIDog
TlVMTCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4X2xl
bik7CisgICAgICAgICAgICBvZmZzZXQgKz0gbWF4X2xlbjsKKyAgICAgICAgICAgIGxlbmd0aCAt
PSBtYXhfbGVuOworICAgICAgICB9CisgICAgICAgIGQtPm51bV9yZWFkcyA9IDA7CisgICAgICAg
IHVzYnJlZGlycGFyc2VyX2RvX3dyaXRlKGQtPnBhcnNlcik7CisKKyAgICAgICAgaWYgKGxlbmd0
aCkgeworICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBFUlJPUjogJXUgYnl0ZXMgd2VyZSBu
b3QgcmVwb3J0ZWQhIiwgX19GVU5DVElPTl9fLCBsZW5ndGgpOworICAgICAgICB9CisKKyAgICB9
IGVsc2UgeworICAgICAgICBTUElDRV9ERUJVRygiJXM6IGJyb2tlbiBkZXZpY2U8LT5jaGFubmVs
IHJlbGF0aW9uc2hpcCEiLCBfX0ZVTkNUSU9OX18pOworICAgIH0KK30KKworLyogZGV2aWNlIHJl
c2V0IGNvbXBsZXRpb24gY2FsbGJhY2sgKi8KK3ZvaWQgY2RfdXNiX2J1bGtfbXNkX3Jlc2V0X2Nv
bXBsZXRlKHZvaWQgKnVzZXJfZGF0YSwgaW50IHN0YXR1cykKK3sKKyAgICAvLyBVc2JDZCAqZCA9
IChVc2JDZCAqKXVzZXJfZGF0YTsKK30KKworc3RhdGljIGdib29sZWFuIHVzYl9jZF9idWxrX2lu
X3JlcXVlc3QoVXNiQ2QgKmQsIHVpbnQ2NF90IGlkLAorICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICBzdHJ1Y3QgdXNiX3JlZGlyX2J1bGtfcGFja2V0X2hlYWRlciAqaCkKK3sKKyAg
ICBpbnQgcmVzOworICAgIHVpbnQzMl90IGxlbiA9IChoLT5sZW5ndGhfaGlnaCA8PCAxNikgfCBo
LT5sZW5ndGg7CisgICAgaWYgKGQtPm51bV9yZWFkcyA+PSBNQVhfQlVMS19JTl9SRVFVRVNUUykg
eworICAgICAgICBoLT5sZW5ndGggPSBoLT5sZW5ndGhfaGlnaCA9IDA7CisgICAgICAgIFNQSUNF
X0RFQlVHKCIlczogdG9vIG1hbnkgcGVuZGluZyByZWFkcyIsIF9fRlVOQ1RJT05fXyk7CisgICAg
ICAgIGgtPnN0YXR1cyA9IHVzYl9yZWRpcl9iYWJibGU7CisgICAgICAgIHJldHVybiBGQUxTRTsK
KyAgICB9CisKKyAgICBpZiAoZC0+bnVtX3JlYWRzKSB7CisgICAgICAgIFNQSUNFX0RFQlVHKCIl
czogYWxyZWFkeSBoYXMgJXUgcGVuZGluZyByZWFkcyIsIF9fRlVOQ1RJT05fXywgZC0+bnVtX3Jl
YWRzKTsKKyAgICB9CisKKyAgICBkLT5yZWFkX2J1bGtbZC0+bnVtX3JlYWRzXS5ob3V0ID0gKmg7
CisgICAgZC0+cmVhZF9idWxrW2QtPm51bV9yZWFkc10uaWQgPSBpZDsKKyAgICBkLT5udW1fcmVh
ZHMrKzsKKyAgICByZXMgPSBjZF91c2JfYnVsa19tc2RfcmVhZChkLT5tc2MsIGxlbik7CisgICAg
aWYgKCFyZXMpIHsKKyAgICAgICAgcmV0dXJuIFRSVUU7CisgICAgfQorCisgICAgU1BJQ0VfREVC
VUcoIiVzOiBlcnJvciBvbiBidWxrIHJlYWQiLCBfX0ZVTkNUSU9OX18pOworICAgIGQtPm51bV9y
ZWFkcy0tOworICAgIGgtPmxlbmd0aCA9IGgtPmxlbmd0aF9oaWdoID0gMDsKKyAgICBoLT5zdGF0
dXMgPSB1c2JfcmVkaXJfaW9lcnJvcjsKKworICAgIHJldHVybiBGQUxTRTsKK30KKworc3RhdGlj
IHZvaWQgdXNiX2NkX2NhbmNlbF9yZXF1ZXN0KFVzYkNkICpkLCB1aW50NjRfdCBpZCkKK3sKKyAg
ICB1aW50MzJfdCBucmVhZDsKKworICAgIGZvciAobnJlYWQgPSAwOyBucmVhZCA8IGQtPm51bV9y
ZWFkczsgbnJlYWQrKykgeworICAgICAgICBpZiAoZC0+cmVhZF9idWxrW25yZWFkXS5pZCA9PSBp
ZCkgeworICAgICAgICAgICAgaWYgKGNkX3VzYl9idWxrX21zZF9jYW5jZWxfcmVhZChkLT5tc2Mp
KSB7CisgICAgICAgICAgICAgICAgY2RfdXNiX2J1bGtfbXNkX3JlYWRfY29tcGxldGUoZCwgTlVM
TCwgMCwgQlVMS19TVEFUVVNfQ0FOQ0VMRUQpOworICAgICAgICAgICAgfQorICAgICAgICAgICAg
cmV0dXJuOworICAgICAgICB9CisgICAgfQorICAgIFNQSUNFX0RFQlVHKCIlczogRVJST1I6IG5v
IHN1Y2ggaWQgdG8gY2FuY2VsISIsIF9fRlVOQ1RJT05fXyk7Cit9CisKKy8vIGNhbGxlZCB3aGVu
IGEgY2hhbmdlIGhhcHBlbnMgb24gU0NTSSBsYXllcgordm9pZCBjZF91c2JfYnVsa19tc2RfbHVu
X2NoYW5nZWQodm9pZCAqdXNlcl9kYXRhLCB1aW50MzJfdCBsdW4pCit7CisgICAgVXNiQ2QgKmQg
PSAoVXNiQ2QgKil1c2VyX2RhdGE7CisgICAgQ2RTY3NpRGV2aWNlSW5mbyBjZF9pbmZvOworCisg
ICAgaWYgKCFjZF91c2JfYnVsa19tc2RfZ2V0X2luZm8oZC0+bXNjLCBsdW4sICZjZF9pbmZvKSkg
eworICAgICAgICAvLyBsb2FkIG9yIHVubG9hZCBjb21tYW5kIHJlY2VpdmVkIGZyb20gU0NTSQor
ICAgICAgICBpZiAoZC0+dW5pdHNbbHVuXS5sb2FkZWQgIT0gY2RfaW5mby5sb2FkZWQpIHsKKyAg
ICAgICAgICAgIGlmICghbG9hZF9sdW4oZCwgbHVuLCBjZF9pbmZvLmxvYWRlZCkpIHsKKyAgICAg
ICAgICAgICAgICBTUElDRV9ERUJVRygiJXM6IGxvYWQgZmFpbGVkLCB1bmxvYWRpbmcgdW5pdCIs
IF9fRlVOQ1RJT05fXyk7CisgICAgICAgICAgICAgICAgY2RfdXNiX2J1bGtfbXNkX3VubG9hZChk
LT5tc2MsIGx1bik7CisgICAgICAgICAgICB9CisgICAgICAgIH0KKyAgICB9CisKKyAgICBpZiAo
ZC0+ZGVsZXRlX29uX2VqZWN0KSB7CisgICAgICAgIGQtPmRlbGV0ZV9vbl9lamVjdCA9IEZBTFNF
OworICAgICAgICBkLT5kZWxldGluZyA9IFRSVUU7CisgICAgfSBlbHNlIHsKKyAgICAgICAgc3Bp
Y2VfdXNiX2JhY2tlbmRfZGV2aWNlX3JlcG9ydF9jaGFuZ2UoZC0+YmFja2VuZCwgZC0+cGFyZW50
KTsKKyAgICB9Cit9CisKK3N0YXRpYyBnY2hhciAqdXNiX2NkX2dldF9wcm9kdWN0X2Rlc2NyaXB0
aW9uKFVzYkNkICpkZXZpY2UpCit7CisgICAgZ2NoYXIgKmJhc2VfbmFtZSA9IGdfcGF0aF9nZXRf
YmFzZW5hbWUoZGV2aWNlLT51bml0c1swXS5maWxlbmFtZSk7CisgICAgZ2NoYXIgKnJlcyA9IGdf
c3RyZHVwX3ByaW50ZigiU1BJQ0UgQ0QoJXMpIiwgYmFzZV9uYW1lKTsKKyAgICBnX2ZyZWUoYmFz
ZV9uYW1lKTsKKyAgICByZXR1cm4gcmVzOworfQorCitzdGF0aWMgY29uc3QgVXNiRGV2aWNlT3Bz
IGRldm9wcyA9Cit7CisgICAgLmdldF9kZXNjcmlwdG9yID0gdXNiX2NkX2dldF9kZXNjcmlwdG9y
LAorICAgIC5nZXRfcHJvZHVjdF9kZXNjcmlwdGlvbiA9IHVzYl9jZF9nZXRfcHJvZHVjdF9kZXNj
cmlwdGlvbiwKKyAgICAuYXR0YWNoID0gdXNiX2NkX2F0dGFjaCwKKyAgICAucmVzZXQgPSB1c2Jf
Y2RfcmVzZXQsCisgICAgLmRldGFjaCA9IHVzYl9jZF9kZXRhY2gsCisgICAgLmNvbnRyb2xfcmVx
dWVzdCA9IHVzYl9jZF9jb250cm9sX3JlcXVlc3QsCisgICAgLmJ1bGtfb3V0X3JlcXVlc3QgPSB1
c2JfY2RfYnVsa19vdXRfcmVxdWVzdCwKKyAgICAuYnVsa19pbl9yZXF1ZXN0ID0gdXNiX2NkX2J1
bGtfaW5fcmVxdWVzdCwKKyAgICAuY2FuY2VsX3JlcXVlc3QgPSB1c2JfY2RfY2FuY2VsX3JlcXVl
c3QsCisgICAgLmRlbGV0ZSA9IHVzYl9jZF9kZWxldGUsCit9OworCitzdGF0aWMgaW50IHVzYl9j
ZF9jcmVhdGUoU3BpY2VVc2JCYWNrZW5kICpiZSwKKyAgICAgICAgICAgICAgICAgICAgICAgICBT
cGljZVVzYkJhY2tlbmREZXZpY2UgKnBhcmVudCwKKyAgICAgICAgICAgICAgICAgICAgICAgICBV
c2JDcmVhdGVEZXZpY2VQYXJhbWV0ZXJzICpwYXJhbSwKKyAgICAgICAgICAgICAgICAgICAgICAg
ICBVc2JDZCAqKmRldikKK3sKKyAgICBpbnQgZXJyb3IgPSAwOworICAgIHVpbnQzMl90IHVuaXQg
PSAwOworICAgIFVzYkNkICpkID0gZ19uZXcwKFVzYkNkLCAxKTsKKyAgICBDZFNjc2lEZXZpY2VQ
YXJhbWV0ZXJzIGRldl9wYXJhbXMgPSB7IDAgfTsKKworICAgIGQtPmRldl9vcHMgPSBkZXZvcHM7
CisgICAgZC0+YmFja2VuZCA9IGJlOworICAgIGQtPnBhcmVudCAgPSBwYXJlbnQ7CisgICAgZC0+
ZGVsZXRlX29uX2VqZWN0ID0gISFwYXJhbS0+ZGV2aWNlX3BhcmFtLmNyZWF0ZV9jZC5kZWxldGVf
b25fZWplY3Q7CisgICAgZC0+bG9ja2VkID0gIWQtPmRlbGV0ZV9vbl9lamVjdDsKKyAgICBkLT5z
ZXJpYWxbMF0gPSAweDAzMDg7CisgICAgZC0+c2VyaWFsWzFdID0gJ1gnOworICAgIGQtPnNlcmlh
bFsyXSA9ICcwJyArIHBhcmFtLT5hZGRyZXNzIC8gMTA7CisgICAgZC0+c2VyaWFsWzNdID0gJzAn
ICsgcGFyYW0tPmFkZHJlc3MgJSAxMDsKKyAgICBkLT5tYXhfbHVuX2luZGV4ID0gTUFYX0xVTl9Q
RVJfREVWSUNFIC0gMTsKKworICAgIGRldl9wYXJhbXMudmVuZG9yID0gIlNQSUNFIjsKKyAgICBk
ZXZfcGFyYW1zLnByb2R1Y3QgPSAic2hhcmVkIENEIjsKKyAgICBkZXZfcGFyYW1zLnZlcnNpb24g
PSAiMCI7CisKKyAgICBkLT5tc2MgPSBjZF91c2JfYnVsa19tc2RfYWxsb2MoZCwgTUFYX0xVTl9Q
RVJfREVWSUNFKTsKKyAgICBpZiAoIWQtPm1zYykgeworICAgICAgICBnX2NsZWFyX3BvaW50ZXIo
JmQsIGdfZnJlZSk7CisgICAgICAgIHBhcmFtLT5lcnJvciA9IGdfZXJyb3JfbmV3KFNQSUNFX0NM
SUVOVF9FUlJPUiwgU1BJQ0VfQ0xJRU5UX0VSUk9SX0ZBSUxFRCwKKyAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgXygiY2FuJ3QgYWxsb2NhdGUgZGV2aWNlIikpOworICAgICAgICBy
ZXR1cm4gMTsKKyAgICB9CisgICAgZC0+dW5pdHNbdW5pdF0uYmxvY2tTaXplID0gQ0RfREVWX0JM
T0NLX1NJWkU7CisgICAgaWYgKCFjZF91c2JfYnVsa19tc2RfcmVhbGl6ZShkLT5tc2MsIHVuaXQs
ICZkZXZfcGFyYW1zKSkgeworICAgICAgICBpZiAob3Blbl9zdHJlYW0oJmQtPnVuaXRzW3VuaXRd
LCBwYXJhbS0+ZGV2aWNlX3BhcmFtLmNyZWF0ZV9jZC5maWxlbmFtZSkgJiYKKyAgICAgICAgICAg
IGxvYWRfbHVuKGQsIHVuaXQsIFRSVUUpKSB7CisgICAgICAgICAgICBpZiAoZC0+bG9ja2VkKSB7
CisgICAgICAgICAgICAgICAgY2RfdXNiX2J1bGtfbXNkX2xvY2soZC0+bXNjLCB1bml0LCBUUlVF
KTsKKyAgICAgICAgICAgIH0KKyAgICAgICAgfSBlbHNlIHsKKyAgICAgICAgICAgIGNsb3NlX3N0
cmVhbSgmZC0+dW5pdHNbdW5pdF0pOworICAgICAgICAgICAgY2RfdXNiX2J1bGtfbXNkX3VucmVh
bGl6ZShkLT5tc2MsIHVuaXQpOworICAgICAgICAgICAgcGFyYW0tPmVycm9yID0gZ19lcnJvcl9u
ZXcoU1BJQ0VfQ0xJRU5UX0VSUk9SLCBTUElDRV9DTElFTlRfRVJST1JfRkFJTEVELAorICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXygiY2FuJ3QgY3JlYXRlIGRldmljZSB3
aXRoICVzIiksCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJhbS0+
ZGV2aWNlX3BhcmFtLmNyZWF0ZV9jZC5maWxlbmFtZSk7CisgICAgICAgICAgICBlcnJvciA9IDM7
CisgICAgICAgIH0KKyAgICB9IGVsc2UgeworICAgICAgICBlcnJvciA9IDI7CisgICAgICAgIHBh
cmFtLT5lcnJvciA9IGdfZXJyb3JfbmV3KFNQSUNFX0NMSUVOVF9FUlJPUiwgU1BJQ0VfQ0xJRU5U
X0VSUk9SX0ZBSUxFRCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXygiY2Fu
J3QgYWxsb2NhdGUgZGV2aWNlIikpOworICAgIH0KKyAgICBpZiAoZXJyb3IpIHsKKyAgICAgICAg
Z19jbGVhcl9wb2ludGVyKCZkLT5tc2MsIGNkX3VzYl9idWxrX21zZF9mcmVlKTsKKyAgICAgICAg
Z19jbGVhcl9wb2ludGVyKCZkLCBnX2ZyZWUpOworICAgIH0KKworICAgICpkZXYgPSBkOworICAg
IHJldHVybiBlcnJvcjsKK30KKwordm9pZCBzcGljZV91c2JfZGV2aWNlX3JlZ2lzdGVyX2NkKFNw
aWNlVXNiQmFja2VuZCAqYmUpCit7CisgICAgc3BpY2VfdXNiX2JhY2tlbmRfcmVnaXN0ZXJfZGV2
aWNlX3R5cGUoYmUsIFVTQl9ERVZfVFlQRV9DRCwgdXNiX2NkX2NyZWF0ZSk7Cit9CisKKyNlbmRp
ZiAvKiBVU0VfVVNCUkVESVIgKi8KLS0gCjIuMjAuMQoKX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX18KU3BpY2UtZGV2ZWwgbWFpbGluZyBsaXN0ClNwaWNlLWRl
dmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9t
YWlsbWFuL2xpc3RpbmZvL3NwaWNlLWRldmVs
