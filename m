Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 3857E89AA5
	for <lists+spice-devel@lfdr.de>; Mon, 12 Aug 2019 11:57:56 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id B5BDA6E4CD;
	Mon, 12 Aug 2019 09:57:54 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mail-wm1-x332.google.com (mail-wm1-x332.google.com
 [IPv6:2a00:1450:4864:20::332])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 538E66E4E3
 for <spice-devel@lists.freedesktop.org>; Mon, 12 Aug 2019 09:57:53 +0000 (UTC)
Received: by mail-wm1-x332.google.com with SMTP id p77so10496169wme.0
 for <spice-devel@lists.freedesktop.org>; Mon, 12 Aug 2019 02:57:53 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
 :references;
 bh=tmMDjdoATp8BxhY53wA6JTmHSAKlzKW+cHrKAkfSy/g=;
 b=WJ/da7W1JLJYaI+UB0zFsFp1YrFZpr3Nu92lx/hStYJ/1ujuxGAasVaEXN/AJuAdiX
 BMrl+eM56mhI1p+RFi3caRFElpZki4KyKk11SBuxJZkj3YO7DOFogut0TVZ+TtFtSKbt
 Kze7RvJN9Xrt0Na01BdKIvTI/ZiuvYkrRuGovNBc9UfeeZJWPORirVFnb68fB/uhTGjH
 wWwHTkkoODwXrwFkUgFGmEObHC/Z1mBZaSclzyw0g/GJobINkeIV6m2I5Cv5PdoQa35O
 zoReE1+GwS8pw6p45X+lPVrQ6xFrAUOCc/fxKstgTG05of0hVGR+4/kGnrTD38ZMpw/I
 0KCA==
X-Gm-Message-State: APjAAAXsrTxpQ2pgPpxKpFhC2OwBF5qXwKq95onT7ZYz0hUoRnQ49Mrm
 km6G5W0fKXijY+NaiW7xAuKcc+gcnoY=
X-Google-Smtp-Source: APXvYqxw+Kek7jv10pB7qi0e65K7lPSW9IZOLJCEkyT+29oSNf5dNNo13oTLgVMqGhCtnVDAOwnOeQ==
X-Received: by 2002:a05:600c:2102:: with SMTP id
 u2mr27542188wml.105.1565603871208; 
 Mon, 12 Aug 2019 02:57:51 -0700 (PDT)
Received: from f2.redhat.com (bzq-79-182-115-245.red.bezeqint.net.
 [79.182.115.245])
 by smtp.gmail.com with ESMTPSA id g14sm11930659wrb.38.2019.08.12.02.57.49
 (version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
 Mon, 12 Aug 2019 02:57:50 -0700 (PDT)
From: Yuri Benditovich <yuri.benditovich@daynix.com>
To: spice-devel@lists.freedesktop.org
Date: Mon, 12 Aug 2019 12:57:27 +0300
Message-Id: <20190812095729.32692-8-yuri.benditovich@daynix.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190812095729.32692-1-yuri.benditovich@daynix.com>
References: <20190812095729.32692-1-yuri.benditovich@daynix.com>
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=daynix-com.20150623.gappssmtp.com; s=20150623;
 h=from:to:cc:subject:date:message-id:in-reply-to:references;
 bh=tmMDjdoATp8BxhY53wA6JTmHSAKlzKW+cHrKAkfSy/g=;
 b=bSwWO/TEH2FpUC7LCHL3fAK4oTdoanObKs+t8mSdqvgdiM1Tam/0maZpqbDpKVX/vL
 w5EFjUK0lTHUzkgs8uwfYoiR9xzuJ1lB2db+CvqO2QWMFFv0ltOFjPX/WBnnh5rgdIyi
 GSZ+oW3mZg+I0Tqa1azkpmubn435c0B/XJv7so0rtKK9ApJE0UUvYxizzQb2bVH/SKxf
 Wiet3avpv4ThAQd9Pu9L7MWO/7wV4z9Kx1PyopgrJuFO16dmqfFQkQXEbNhu4bkQgUJq
 1WP656phXvEY8wFmhiVWa5/Lwb/EmB5BF9Ib1ss86mAPqP90z9CuHJsjwAAKR0XiWKDj
 JhvQ==
Subject: [Spice-devel] [spice-gtk v3 7/9] usb-redir: add implementation of
 emulated CD device
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Cc: yan@daynix.com
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

VGhpcyBtb2R1bGUgY29udGFpbnMgaW1wbGVtZW50YXRpb24gb2YgZW11bGF0ZWQgZGV2aWNlCmlu
dGVyZmFjZSBmb3Igc2hhcmVkIENELgoKU2lnbmVkLW9mZi1ieTogWXVyaSBCZW5kaXRvdmljaCA8
eXVyaS5iZW5kaXRvdmljaEBkYXluaXguY29tPgotLS0KIHNyYy91c2ItZGV2aWNlLWNkLmMgfCA3
ODMgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysKIHNyYy91c2It
ZGV2aWNlLWNkLmggfCAgMzQgKysKIDIgZmlsZXMgY2hhbmdlZCwgODE3IGluc2VydGlvbnMoKykK
IGNyZWF0ZSBtb2RlIDEwMDY0NCBzcmMvdXNiLWRldmljZS1jZC5jCiBjcmVhdGUgbW9kZSAxMDA2
NDQgc3JjL3VzYi1kZXZpY2UtY2QuaAoKZGlmZiAtLWdpdCBhL3NyYy91c2ItZGV2aWNlLWNkLmMg
Yi9zcmMvdXNiLWRldmljZS1jZC5jCm5ldyBmaWxlIG1vZGUgMTAwNjQ0CmluZGV4IDAwMDAwMDAu
LmMzM2JiMjkKLS0tIC9kZXYvbnVsbAorKysgYi9zcmMvdXNiLWRldmljZS1jZC5jCkBAIC0wLDAg
KzEsNzgzIEBACisvKiAtKi0gTW9kZTogQzsgYy1iYXNpYy1vZmZzZXQ6IDQ7IGluZGVudC10YWJz
LW1vZGU6IG5pbCAtKi0gKi8KKy8qCisgICAgQ29weXJpZ2h0IChDKSAyMDE5IFJlZCBIYXQsIElu
Yy4KKworICAgIFJlZCBIYXQgQXV0aG9yczoKKyAgICBZdXJpIEJlbmRpdG92aWNoPHliZW5kaXRv
QHJlZGhhdC5jb20+CisKKyAgICBUaGlzIGxpYnJhcnkgaXMgZnJlZSBzb2Z0d2FyZTsgeW91IGNh
biByZWRpc3RyaWJ1dGUgaXQgYW5kL29yCisgICAgbW9kaWZ5IGl0IHVuZGVyIHRoZSB0ZXJtcyBv
ZiB0aGUgR05VIExlc3NlciBHZW5lcmFsIFB1YmxpYworICAgIExpY2Vuc2UgYXMgcHVibGlzaGVk
IGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlcgorICAgIHZlcnNpb24gMi4x
IG9mIHRoZSBMaWNlbnNlLCBvciAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgor
CisgICAgVGhpcyBsaWJyYXJ5IGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2ls
bCBiZSB1c2VmdWwsCisgICAgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4g
dGhlIGltcGxpZWQgd2FycmFudHkgb2YKKyAgICBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBG
T1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlIEdOVQorICAgIExlc3NlciBHZW5lcmFs
IFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCisKKyAgICBZb3Ugc2hvdWxkIGhhdmUg
cmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgTGVzc2VyIEdlbmVyYWwgUHVibGljCisgICAgTGlj
ZW5zZSBhbG9uZyB3aXRoIHRoaXMgbGlicmFyeTsgaWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251
Lm9yZy9saWNlbnNlcy8+LgorKi8KKworI2luY2x1ZGUgImNvbmZpZy5oIgorCisjaWZkZWYgVVNF
X1VTQlJFRElSCisKKyNpbmNsdWRlIDxnbGliLW9iamVjdC5oPgorI2luY2x1ZGUgPGludHR5cGVz
Lmg+CisjaW5jbHVkZSA8Z2lvL2dpby5oPgorI2luY2x1ZGUgPGdsaWIvZ2kxOG4tbGliLmg+Cisj
aW5jbHVkZSA8ZXJybm8uaD4KKyNpbmNsdWRlIDxsaWJ1c2IuaD4KKyNpbmNsdWRlIDxmY250bC5o
PgorCisjaWZkZWYgR19PU19XSU4zMgorI2luY2x1ZGUgPHdpbmRvd3MuaD4KKyNpbmNsdWRlIDxu
dGRkY2RybS5oPgorI2luY2x1ZGUgPG50ZGRtbWMuaD4KKyNlbHNlCisjaW5jbHVkZSA8c3lzL3N0
YXQuaD4KKyNpbmNsdWRlIDxzeXMvaW9jdGwuaD4KKyNpbmNsdWRlIDxsaW51eC9mcy5oPgorI2lu
Y2x1ZGUgPGxpbnV4L2Nkcm9tLmg+CisjZW5kaWYKKworI2luY2x1ZGUgInVzYi1lbXVsYXRpb24u
aCIKKyNpbmNsdWRlICJ1c2ItZGV2aWNlLWNkLmgiCisjaW5jbHVkZSAiY2QtdXNiLWJ1bGstbXNk
LmgiCisKK3R5cGVkZWYgc3RydWN0IFNwaWNlQ2RMVSB7CisgICAgY2hhciAqZmlsZW5hbWU7Cisg
ICAgR0ZpbGVJbnB1dFN0cmVhbSAqc3RyZWFtOworICAgIHVpbnQ2NF90IHNpemU7CisgICAgdWlu
dDMyX3QgYmxvY2tTaXplOworICAgIHVpbnQzMl90IGxvYWRlZCA6IDE7CisgICAgdWludDMyX3Qg
ZGV2aWNlIDogMTsKK30gU3BpY2VDZExVOworCisjZGVmaW5lIE1BWF9MVU5fUEVSX0RFVklDRSAg
ICAgICAgICAgICAgMQorI2RlZmluZSBVU0IyX0JDRCAgICAgICAgICAgICAgICAgICAgICAgIDB4
MjAwCisjZGVmaW5lIENEX0RFVl9WSUQgICAgICAgICAgICAgICAgICAgICAgMHgyYjIzCisjZGVm
aW5lIENEX0RFVl9QSUQgICAgICAgICAgICAgICAgICAgICAgMHhDRENECisjZGVmaW5lIENEX0RF
Vl9DTEFTUyAgICAgICAgICAgICAgICAgICAgOAorI2RlZmluZSBDRF9ERVZfU1VCQ0xBU1MgICAg
ICAgICAgICAgICAgIDYKKyNkZWZpbmUgQ0RfREVWX1BST1RPQ09MICAgICAgICAgICAgICAgICAw
eDUwCisjZGVmaW5lIENEX0RFVl9CTE9DS19TSVpFICAgICAgICAgICAgICAgMHgyMDAKKyNkZWZp
bmUgRFZEX0RFVl9CTE9DS19TSVpFICAgICAgICAgICAgICAweDgwMAorI2RlZmluZSBNQVhfQlVM
S19JTl9SRVFVRVNUUyAgICAgICAgICAgIDY0CisKK3N0cnVjdCBCdWZmZXJlZEJ1bGtSZWFkIHsK
KyAgICBzdHJ1Y3QgdXNiX3JlZGlyX2J1bGtfcGFja2V0X2hlYWRlciBob3V0OworICAgIHVpbnQ2
NF90IGlkOworfTsKKworc3RydWN0IFNwaWNlVXNiRW11bGF0ZWREZXZpY2UgeworICAgIFVzYkRl
dmljZU9wcyBkZXZfb3BzOworICAgIFNwaWNlVXNiQmFja2VuZCAqYmFja2VuZDsKKyAgICBTcGlj
ZVVzYkJhY2tlbmREZXZpY2UgKnBhcmVudDsKKyAgICBzdHJ1Y3QgdXNicmVkaXJwYXJzZXIgKnBh
cnNlcjsKKyAgICBVc2JDZEJ1bGtNc2REZXZpY2UqIG1zYzsKKyAgICBTcGljZUNkTFUgdW5pdHNb
TUFYX0xVTl9QRVJfREVWSUNFXTsKKyAgICBnYm9vbGVhbiBsb2NrZWQ7CisgICAgZ2Jvb2xlYW4g
ZGVsZXRlX29uX2VqZWN0OworICAgIGdib29sZWFuIGRlbGV0aW5nOworICAgIHVpbnQzMl90IG51
bV9yZWFkczsKKyAgICBzdHJ1Y3QgQnVmZmVyZWRCdWxrUmVhZCByZWFkX2J1bGtbTUFYX0JVTEtf
SU5fUkVRVUVTVFNdOworICAgIC8qIGFjY29yZGluZyB0byBVU0IgTVNDIHNwZWMgKi8KKyAgICB1
aW50MTZfdCBzZXJpYWxbMTJdOworICAgIHVpbnQ4X3QgIG1heF9sdW5faW5kZXg7Cit9OworCit0
eXBlZGVmIHN0cnVjdCBTcGljZVVzYkVtdWxhdGVkRGV2aWNlIFVzYkNkOworCisjaWZuZGVmIEdf
T1NfV0lOMzIKKworc3RhdGljIGludCBjZF9kZXZpY2Vfb3Blbl9zdHJlYW0oU3BpY2VDZExVICp1
bml0LCBjb25zdCBjaGFyICpmaWxlbmFtZSkKK3sKKyAgICB1bml0LT5kZXZpY2UgPSAwOworCisg
ICAgaWYgKCF1bml0LT5maWxlbmFtZSAmJiAhZmlsZW5hbWUpIHsKKyAgICAgICAgU1BJQ0VfREVC
VUcoIiVzOiBmaWxlIG5hbWUgbm90IHByb3ZpZGVkIiwgX19GVU5DVElPTl9fKTsKKyAgICAgICAg
cmV0dXJuIC0xOworICAgIH0KKyAgICBpZiAodW5pdC0+ZmlsZW5hbWUgJiYgZmlsZW5hbWUpIHsK
KyAgICAgICAgZ19mcmVlKHVuaXQtPmZpbGVuYW1lKTsKKyAgICAgICAgdW5pdC0+ZmlsZW5hbWUg
PSBOVUxMOworICAgIH0KKyAgICBpZiAoZmlsZW5hbWUpIHsKKyAgICAgICAgdW5pdC0+ZmlsZW5h
bWUgPSBnX3N0cmR1cChmaWxlbmFtZSk7CisgICAgfQorCisgICAgaW50IGZkID0gb3Blbih1bml0
LT5maWxlbmFtZSwgT19SRE9OTFkgfCBPX05PTkJMT0NLKTsKKyAgICBpZiAoZmQgPCAwKSB7Cisg
ICAgICAgIFNQSUNFX0RFQlVHKCIlczogY2FuJ3Qgb3BlbiBmaWxlICVzIiwgX19GVU5DVElPTl9f
LCB1bml0LT5maWxlbmFtZSk7CisgICAgICAgIHJldHVybiAtMTsKKyAgICB9CisKKyAgICBzdHJ1
Y3Qgc3RhdCBmaWxlX3N0YXQgPSB7IDAgfTsKKyAgICBpZiAoZnN0YXQoZmQsICZmaWxlX3N0YXQp
IHx8IGZpbGVfc3RhdC5zdF9zaXplID09IDApIHsKKyAgICAgICAgZmlsZV9zdGF0LnN0X3NpemUg
PSAwOworICAgICAgICB1bml0LT5kZXZpY2UgPSAxOworICAgICAgICBpZiAoIWlvY3RsKGZkLCBC
TEtHRVRTSVpFNjQsICZmaWxlX3N0YXQuc3Rfc2l6ZSkgJiYKKyAgICAgICAgICAgICFpb2N0bChm
ZCwgQkxLU1NaR0VULCAmdW5pdC0+YmxvY2tTaXplKSkgeworICAgICAgICB9CisgICAgfQorICAg
IHVuaXQtPnNpemUgPSBmaWxlX3N0YXQuc3Rfc2l6ZTsKKyAgICBjbG9zZShmZCk7CisgICAgaWYg
KHVuaXQtPnNpemUpIHsKKyAgICAgICAgR0ZpbGUgKmZpbGVfb2JqZWN0ID0gZ19maWxlX25ld19m
b3JfcGF0aCh1bml0LT5maWxlbmFtZSk7CisgICAgICAgIHVuaXQtPnN0cmVhbSA9IGdfZmlsZV9y
ZWFkKGZpbGVfb2JqZWN0LCBOVUxMLCBOVUxMKTsKKyAgICAgICAgZ19jbGVhcl9vYmplY3QoJmZp
bGVfb2JqZWN0KTsKKyAgICB9CisgICAgaWYgKCF1bml0LT5zdHJlYW0pIHsKKyAgICAgICAgU1BJ
Q0VfREVCVUcoIiVzOiBjYW4ndCBvcGVuIHN0cmVhbSBvbiAlcyIsIF9fRlVOQ1RJT05fXywgdW5p
dC0+ZmlsZW5hbWUpOworICAgICAgICByZXR1cm4gLTE7CisgICAgfQorCisgICAgcmV0dXJuIDA7
Cit9CisKK3N0YXRpYyBpbnQgY2RfZGV2aWNlX2xvYWQoU3BpY2VDZExVICp1bml0LCBnYm9vbGVh
biBsb2FkKQoreworICAgIGludCBlcnJvcjsKKyAgICBpZiAoIXVuaXQtPmRldmljZSB8fCAhdW5p
dC0+ZmlsZW5hbWUpIHsKKyAgICAgICAgcmV0dXJuIC0xOworICAgIH0KKyAgICBpbnQgZmQgPSBv
cGVuKHVuaXQtPmZpbGVuYW1lLCBPX1JET05MWSB8IE9fTk9OQkxPQ0spOworICAgIGlmIChmZCA8
IDApIHsKKyAgICAgICAgcmV0dXJuIC0xOworICAgIH0KKyAgICBpZiAobG9hZCkgeworICAgICAg
ICBlcnJvciA9IGlvY3RsKGZkLCBDRFJPTUNMT1NFVFJBWSwgMCk7CisgICAgfSBlbHNlIHsKKyAg
ICAgICAgZXJyb3IgPSBpb2N0bChmZCwgQ0RST01fTE9DS0RPT1IsIDApOworICAgICAgICBlcnJv
ciA9IGlvY3RsKGZkLCBDRFJPTUVKRUNULCAwKTsKKyAgICB9CisgICAgaWYgKGVycm9yKSB7Cisg
ICAgICAgIC8vIG5vdGUgdGhhdCBlamVjdGluZyBtaWdodCBiZSBhdmFpbGFibGUgb25seSBmb3Ig
cm9vdAorICAgICAgICAvLyBsb2FkaW5nIG1pZ2h0IGJlIGF2YWlsYWJsZSBhbHNvIGZvciByZWd1
bGFyIHVzZXIKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBjYW4ndCAlc2xvYWQgJXMsIHJlcyAl
ZCwgZXJybm8gJWQiLAorICAgICAgICAgICAgX19GVU5DVElPTl9fLCBsb2FkID8gIiIgOiAidW4i
LCB1bml0LT5maWxlbmFtZSwgZXJyb3IsIGVycm5vKTsKKyAgICB9CisgICAgY2xvc2UoZmQpOwor
ICAgIHJldHVybiBlcnJvcjsKK30KKworc3RhdGljIGludCBjZF9kZXZpY2VfY2hlY2soU3BpY2VD
ZExVICp1bml0KQoreworICAgIGludCBlcnJvcjsKKyAgICBpZiAoIXVuaXQtPmRldmljZSB8fCAh
dW5pdC0+ZmlsZW5hbWUpIHsKKyAgICAgICAgcmV0dXJuIC0xOworICAgIH0KKyAgICBpbnQgZmQg
PSBvcGVuKHVuaXQtPmZpbGVuYW1lLCBPX1JET05MWSB8IE9fTk9OQkxPQ0spOworICAgIGlmIChm
ZCA8IDApIHsKKyAgICAgICAgcmV0dXJuIC0xOworICAgIH0KKyAgICBlcnJvciA9IGlvY3RsKGZk
LCBDRFJPTV9EUklWRV9TVEFUVVMsIDApOworICAgIGVycm9yID0gKGVycm9yID09IENEU19ESVND
X09LKSA/IDAgOiAtMTsKKyAgICBpZiAoIWVycm9yKSB7CisgICAgICAgIGVycm9yID0gaW9jdGwo
ZmQsIENEUk9NX0RJU0NfU1RBVFVTLCAwKTsKKyAgICAgICAgZXJyb3IgPSAoZXJyb3IgPT0gQ0RT
X0RBVEFfMSkgPyAwIDogLTE7CisgICAgfQorICAgIGNsb3NlKGZkKTsKKyAgICByZXR1cm4gZXJy
b3I7Cit9CisKKyNlbHNlCisKK3N0YXRpYyBnYm9vbGVhbiBpc19kZXZpY2VfbmFtZShjb25zdCBj
aGFyICpmaWxlbmFtZSkKK3sKKyAgICByZXR1cm4gZ19hc2NpaV9pc2FscGhhKGZpbGVuYW1lWzBd
KSAmJiBmaWxlbmFtZVsxXSA9PSAnOicgJiYKKyAgICAgICAgZmlsZW5hbWVbMl0gPT0gMDsKK30K
Kworc3RhdGljIEhBTkRMRSBvcGVuX2ZpbGUoY29uc3QgY2hhciAqZmlsZW5hbWUpCit7CisgICAg
SEFORExFIGggPSBDcmVhdGVGaWxlQShmaWxlbmFtZSwKKyAgICAgICAgICAgICAgICAgICAgICAg
ICAgIEdFTkVSSUNfUkVBRCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgIEZJTEVfU0hBUkVf
UkVBRCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgIE5VTEwsIE9QRU5fRVhJU1RJTkcsCisg
ICAgICAgICAgICAgICAgICAgICAgICAgICAwLAorICAgICAgICAgICAgICAgICAgICAgICAgICAg
TlVMTCk7CisgICAgaWYgKGggPT0gSU5WQUxJRF9IQU5ETEVfVkFMVUUpIHsKKyAgICAgICAgaCA9
IE5VTEw7CisgICAgfQorICAgIHJldHVybiBoOworfQorCitzdGF0aWMgdWludDMyX3QgaW9jdGxf
b3V0KEhBTkRMRSBoLCB1aW50MzJfdCBjb2RlLCB2b2lkICpvdXRfYnVmZmVyLCB1aW50MzJfdCBv
dXRfc2l6ZSkKK3sKKyAgICB1aW50MzJfdCBlcnJvcjsKKyAgICBEV09SRCByZXQ7CisgICAgQk9P
TCBiID0gRGV2aWNlSW9Db250cm9sKGgsIGNvZGUsIE5VTEwsIDAsIG91dF9idWZmZXIsIG91dF9z
aXplLCAmcmV0LCBOVUxMKTsKKyAgICBlcnJvciA9IGIgPyAwIDogR2V0TGFzdEVycm9yKCk7Cisg
ICAgcmV0dXJuIGVycm9yOworfQorCitzdGF0aWMgdWludDMyX3QgaW9jdGxfbm9uZShIQU5ETEUg
aCwgdWludDMyX3QgY29kZSkKK3sKKyAgICByZXR1cm4gaW9jdGxfb3V0KGgsIGNvZGUsIE5VTEws
IDApOworfQorCitzdGF0aWMgZ2Jvb2xlYW4gY2hlY2tfZGV2aWNlKEhBTkRMRSBoKQoreworICAg
IEdFVF9DT05GSUdVUkFUSU9OX0lPQ1RMX0lOUFVUIGNmZ0luID0KKyAgICAgICAgeyBGZWF0dXJl
Q2RSZWFkLCBTQ1NJX0dFVF9DT05GSUdVUkFUSU9OX1JFUVVFU1RfVFlQRV9BTEwsIHt9IH07Cisg
ICAgRFdPUkQgcmV0OworICAgIEdFVF9DT05GSUdVUkFUSU9OX0hFQURFUiBjZmdPdXQ7CisgICAg
cmV0dXJuIERldmljZUlvQ29udHJvbChoLCBJT0NUTF9DRFJPTV9HRVRfQ09ORklHVVJBVElPTiwK
KyAgICAgICAgICAgICAgICAgICAgICAgICAgICZjZmdJbiwgc2l6ZW9mKGNmZ0luKSwgJmNmZ091
dCwgc2l6ZW9mKGNmZ091dCksCisgICAgICAgICAgICAgICAgICAgICAgICAgICAmcmV0LCBOVUxM
KTsKK30KKworc3RhdGljIGludCBjZF9kZXZpY2Vfb3Blbl9zdHJlYW0oU3BpY2VDZExVICp1bml0
LCBjb25zdCBjaGFyICpmaWxlbmFtZSkKK3sKKyAgICBIQU5ETEUgaDsKKyAgICB1bml0LT5kZXZp
Y2UgPSAwOworICAgIGlmICghdW5pdC0+ZmlsZW5hbWUgJiYgIWZpbGVuYW1lKSB7CisgICAgICAg
IFNQSUNFX0RFQlVHKCIlczogdW5uYW1lZCBmaWxlIiwgX19GVU5DVElPTl9fKTsKKyAgICAgICAg
cmV0dXJuIC0xOworICAgIH0KKyAgICBpZiAodW5pdC0+ZmlsZW5hbWUgJiYgZmlsZW5hbWUpIHsK
KyAgICAgICAgZ19mcmVlKHVuaXQtPmZpbGVuYW1lKTsKKyAgICAgICAgdW5pdC0+ZmlsZW5hbWUg
PSBOVUxMOworICAgIH0KKyAgICBpZiAoIWZpbGVuYW1lKSB7CisgICAgICAgIC8vIHJlb3Blbmlu
ZyB0aGUgc3RyZWFtIG9uIGV4aXN0aW5nIGZpbGUgbmFtZQorICAgIH0gZWxzZSBpZiAoaXNfZGV2
aWNlX25hbWUoZmlsZW5hbWUpKSB7CisgICAgICAgIHVuaXQtPmZpbGVuYW1lID0gZ19zdHJkdXBf
cHJpbnRmKCJcXFxcLlxcJXMiLCBmaWxlbmFtZSk7CisgICAgfSBlbHNlIHsKKyAgICAgICAgdW5p
dC0+ZmlsZW5hbWUgPSBnX3N0cmR1cChmaWxlbmFtZSk7CisgICAgfQorICAgIGggPSBvcGVuX2Zp
bGUodW5pdC0+ZmlsZW5hbWUpOworICAgIGlmICghaCkgeworICAgICAgICBTUElDRV9ERUJVRygi
JXM6IGNhbid0IG9wZW4gZmlsZSAlcyIsIF9fRlVOQ1RJT05fXywgdW5pdC0+ZmlsZW5hbWUpOwor
ICAgICAgICByZXR1cm4gLTE7CisgICAgfQorCisgICAgTEFSR0VfSU5URUdFUiBzaXplID0geyAw
IH07CisgICAgaWYgKCFHZXRGaWxlU2l6ZUV4KGgsICZzaXplKSkgeworICAgICAgICB1aW50NjRf
dCBidWZmZXJbMjU2XTsKKyAgICAgICAgdWludDMyX3QgcmVzOworICAgICAgICB1bml0LT5kZXZp
Y2UgPSBjaGVja19kZXZpY2UoaCk7CisgICAgICAgIFNQSUNFX0RFQlVHKCIlczogQ0QgZGV2aWNl
ICVzcmVjb2duaXplZCBvbiAlcyIsCisgICAgICAgICAgICBfX0ZVTkNUSU9OX18sIHVuaXQtPmRl
dmljZSA/ICIiIDogIk5PVCAiLCB1bml0LT5maWxlbmFtZSk7CisgICAgICAgIHJlcyA9IGlvY3Rs
X291dChoLCBJT0NUTF9ESVNLX0dFVF9EUklWRV9HRU9NRVRSWV9FWCwKKyAgICAgICAgICAgICAg
ICAgICAgICAgIGJ1ZmZlciwgc2l6ZW9mKGJ1ZmZlcikpOworICAgICAgICBpZiAoIXJlcykgewor
ICAgICAgICAgICAgRElTS19HRU9NRVRSWV9FWCAqcGcgPSAoRElTS19HRU9NRVRSWV9FWCAqKWJ1
ZmZlcjsKKyAgICAgICAgICAgIHVuaXQtPmJsb2NrU2l6ZSA9IHBnLT5HZW9tZXRyeS5CeXRlc1Bl
clNlY3RvcjsKKyAgICAgICAgICAgIHNpemUgPSBwZy0+RGlza1NpemU7CisgICAgICAgIH0gZWxz
ZSB7CisgICAgICAgICAgICBTUElDRV9ERUJVRygiJXM6IGNhbid0IG9idGFpbiBzaXplIG9mICVz
IChlcnJvciAldSkiLAorICAgICAgICAgICAgICAgIF9fRlVOQ1RJT05fXywgdW5pdC0+ZmlsZW5h
bWUsIHJlcyk7CisgICAgICAgIH0KKyAgICB9CisgICAgdW5pdC0+c2l6ZSA9IHNpemUuUXVhZFBh
cnQ7CisgICAgQ2xvc2VIYW5kbGUoaCk7CisgICAgaWYgKHVuaXQtPnNpemUpIHsKKyAgICAgICAg
R0ZpbGUgKmZpbGVfb2JqZWN0ID0gZ19maWxlX25ld19mb3JfcGF0aCh1bml0LT5maWxlbmFtZSk7
CisgICAgICAgIHVuaXQtPnN0cmVhbSA9IGdfZmlsZV9yZWFkKGZpbGVfb2JqZWN0LCBOVUxMLCBO
VUxMKTsKKyAgICAgICAgZ19jbGVhcl9vYmplY3QoJmZpbGVfb2JqZWN0KTsKKyAgICB9CisgICAg
aWYgKCF1bml0LT5zdHJlYW0pIHsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBjYW4ndCBvcGVu
IHN0cmVhbSBvbiAlcyIsIF9fRlVOQ1RJT05fXywgdW5pdC0+ZmlsZW5hbWUpOworICAgICAgICBy
ZXR1cm4gLTE7CisgICAgfQorICAgIHJldHVybiAwOworfQorCitzdGF0aWMgaW50IGNkX2Rldmlj
ZV9sb2FkKFNwaWNlQ2RMVSAqdW5pdCwgZ2Jvb2xlYW4gbG9hZCkKK3sKKyAgICBpbnQgZXJyb3Ig
PSAwOworICAgIEhBTkRMRSBoOworICAgIGlmICghdW5pdC0+ZGV2aWNlIHx8ICF1bml0LT5maWxl
bmFtZSkgeworICAgICAgICByZXR1cm4gLTE7CisgICAgfQorICAgIGggPSBvcGVuX2ZpbGUodW5p
dC0+ZmlsZW5hbWUpOworICAgIGlmIChoKSB7CisgICAgICAgIHVpbnQzMl90IHJlcyA9IGlvY3Rs
X25vbmUoaCwgbG9hZCA/IElPQ1RMX1NUT1JBR0VfTE9BRF9NRURJQSA6IElPQ1RMX1NUT1JBR0Vf
RUpFQ1RfTUVESUEpOworICAgICAgICBpZiAocmVzKSB7CisgICAgICAgICAgICBTUElDRV9ERUJV
RygiJXM6IGNhbid0ICVzbG9hZCAlcywgd2luIGVycm9yICV1IiwKKyAgICAgICAgICAgICAgICAg
ICAgICAgIF9fRlVOQ1RJT05fXywgbG9hZCA/ICIiIDogInVuIiwgdW5pdC0+ZmlsZW5hbWUsIHJl
cyk7CisgICAgICAgICAgICBlcnJvciA9IC0xOworICAgICAgICB9IGVsc2UgeworICAgICAgICAg
ICAgU1BJQ0VfREVCVUcoIiVzOiBkZXZpY2UgJXMgWyVzXSIsCisgICAgICAgICAgICAgICAgICAg
ICAgICBfX0ZVTkNUSU9OX18sIGxvYWQgPyAibG9hZGVkIiA6ICJlamVjdGVkIiwgdW5pdC0+Zmls
ZW5hbWUpOworICAgICAgICB9CisgICAgICAgIENsb3NlSGFuZGxlKGgpOworICAgIH0KKyAgICBy
ZXR1cm4gZXJyb3I7Cit9CisKK3N0YXRpYyBpbnQgY2RfZGV2aWNlX2NoZWNrKFNwaWNlQ2RMVSAq
dW5pdCkKK3sKKyAgICBpbnQgZXJyb3IgPSAwOworICAgIENEUk9NX0RJU0tfREFUQSBkYXRhOwor
ICAgIEhBTkRMRSBoOworICAgIGlmICghdW5pdC0+ZGV2aWNlIHx8ICF1bml0LT5maWxlbmFtZSkg
eworICAgICAgICByZXR1cm4gLTE7CisgICAgfQorICAgIGggPSBvcGVuX2ZpbGUodW5pdC0+Zmls
ZW5hbWUpOworICAgIGlmIChoKSB7CisgICAgICAgIHVpbnQzMl90IHJlcyA9IGlvY3RsX25vbmUo
aCwgSU9DVExfU1RPUkFHRV9DSEVDS19WRVJJRlkpOworICAgICAgICBpZiAoIXJlcykgeworICAg
ICAgICAgICAgcmVzID0gaW9jdGxfb3V0KGgsIElPQ1RMX0NEUk9NX0RJU0tfVFlQRSwgJmRhdGEs
IHNpemVvZihkYXRhKSk7CisgICAgICAgIH0KKyAgICAgICAgaWYgKHJlcyAhPSAwIHx8IGRhdGEu
RGlza0RhdGEgIT0gQ0RST01fRElTS19EQVRBX1RSQUNLKSB7CisgICAgICAgICAgICBlcnJvciA9
IC0xOworICAgICAgICB9CisgICAgICAgIENsb3NlSGFuZGxlKGgpOworICAgIH0KKyAgICByZXR1
cm4gZXJyb3I7Cit9CisKKyNlbmRpZgorCitzdGF0aWMgZ2Jvb2xlYW4gb3Blbl9zdHJlYW0oU3Bp
Y2VDZExVICp1bml0LCBjb25zdCBjaGFyICpmaWxlbmFtZSkKK3sKKyAgICBnYm9vbGVhbiBiOwor
ICAgIGIgPSBjZF9kZXZpY2Vfb3Blbl9zdHJlYW0odW5pdCwgZmlsZW5hbWUpID09IDA7CisgICAg
cmV0dXJuIGI7Cit9CisKK3N0YXRpYyB2b2lkIGNsb3NlX3N0cmVhbShTcGljZUNkTFUgKnVuaXQp
Cit7CisgICAgZ19jbGVhcl9vYmplY3QoJnVuaXQtPnN0cmVhbSk7Cit9CisKK3N0YXRpYyBnYm9v
bGVhbiBsb2FkX2x1bihVc2JDZCAqZCwgaW50IHVuaXQsIGdib29sZWFuIGxvYWQpCit7CisgICAg
Z2Jvb2xlYW4gYiA9IFRSVUU7CisgICAgaWYgKGxvYWQgJiYgZC0+dW5pdHNbdW5pdF0uZGV2aWNl
KSB7CisgICAgICAgIC8vIHRoZXJlIGlzIG9uZSBwb3NzaWJsZSBwcm9ibGVtIGluIGNhc2Ugb3Vy
IGJhY2tlbmQgaXMgdGhlCisgICAgICAgIC8vIGxvY2FsIENEIGRldmljZSBhbmQgaXQgaXMgZWpl
Y3RlZAorICAgICAgICBjZF9kZXZpY2VfbG9hZCgmZC0+dW5pdHNbdW5pdF0sIFRSVUUpOworICAg
ICAgICBjbG9zZV9zdHJlYW0oJmQtPnVuaXRzW3VuaXRdKTsKKyAgICAgICAgaWYgKGNkX2Rldmlj
ZV9jaGVjaygmZC0+dW5pdHNbdW5pdF0pIHx8ICFvcGVuX3N0cmVhbSgmZC0+dW5pdHNbdW5pdF0s
IE5VTEwpKSB7CisgICAgICAgICAgICByZXR1cm4gRkFMU0U7CisgICAgICAgIH0KKyAgICB9CisK
KyAgICBpZiAobG9hZCkgeworICAgICAgICBDZFNjc2lNZWRpYVBhcmFtZXRlcnMgbWVkaWFfcGFy
YW1zID0geyAwIH07CisKKyAgICAgICAgbWVkaWFfcGFyYW1zLnN0cmVhbSA9IGQtPnVuaXRzW3Vu
aXRdLnN0cmVhbTsKKyAgICAgICAgbWVkaWFfcGFyYW1zLnNpemUgPSBkLT51bml0c1t1bml0XS5z
aXplOworICAgICAgICBtZWRpYV9wYXJhbXMuYmxvY2tfc2l6ZSA9IGQtPnVuaXRzW3VuaXRdLmJs
b2NrU2l6ZTsKKyAgICAgICAgaWYgKG1lZGlhX3BhcmFtcy5ibG9ja19zaXplID09IENEX0RFVl9C
TE9DS19TSVpFICYmCisgICAgICAgICAgICBtZWRpYV9wYXJhbXMuc2l6ZSAlIERWRF9ERVZfQkxP
Q0tfU0laRSA9PSAwKSB7CisgICAgICAgICAgICBtZWRpYV9wYXJhbXMuYmxvY2tfc2l6ZSA9IERW
RF9ERVZfQkxPQ0tfU0laRTsKKyAgICAgICAgfQorICAgICAgICBTUElDRV9ERUJVRygiJXM6IGxv
YWRpbmcgJXMsIHNpemUgJSIgR19HVUlOVDY0X0ZPUk1BVCAiLCBibG9jayAldSIsCisgICAgICAg
ICAgICAgICAgICAgIF9fRlVOQ1RJT05fXywgZC0+dW5pdHNbdW5pdF0uZmlsZW5hbWUsIG1lZGlh
X3BhcmFtcy5zaXplLCBtZWRpYV9wYXJhbXMuYmxvY2tfc2l6ZSk7CisKKyAgICAgICAgYiA9ICFj
ZF91c2JfYnVsa19tc2RfbG9hZChkLT5tc2MsIHVuaXQsICZtZWRpYV9wYXJhbXMpOworCisgICAg
ICAgIGQtPnVuaXRzW3VuaXRdLmxvYWRlZCA9ICEhYjsKKworICAgIH0gZWxzZSB7CisgICAgICAg
IFNQSUNFX0RFQlVHKCIlczogdW5sb2FkaW5nICVzIiwgX19GVU5DVElPTl9fLCBkLT51bml0c1t1
bml0XS5maWxlbmFtZSk7CisgICAgICAgIGNkX3VzYl9idWxrX21zZF91bmxvYWQoZC0+bXNjLCB1
bml0KTsKKyAgICAgICAgZC0+dW5pdHNbdW5pdF0ubG9hZGVkID0gRkFMU0U7CisgICAgfQorICAg
IHJldHVybiBiOworfQorCitzdGF0aWMgdm9pZCB1c2JfY2RfdW5yZWFsaXplKFVzYkNkICpkKQor
eworICAgIHVpbnQzMl90IHVuaXQgPSAwOworICAgIGNkX3VzYl9idWxrX21zZF91bnJlYWxpemUo
ZC0+bXNjLCB1bml0KTsKKyAgICBnX2NsZWFyX3BvaW50ZXIoJmQtPnVuaXRzW3VuaXRdLmZpbGVu
YW1lLCBnX2ZyZWUpOworICAgIGNsb3NlX3N0cmVhbSgmZC0+dW5pdHNbdW5pdF0pOworICAgIGdf
Y2xlYXJfcG9pbnRlcigmZC0+bXNjLCBjZF91c2JfYnVsa19tc2RfZnJlZSk7CisgICAgZ19mcmVl
KGQpOworfQorCitzdGF0aWMgZ2Jvb2xlYW4gdXNiX2NkX2dldF9kZXNjcmlwdG9yKFVzYkNkICpk
LCB1aW50OF90IHR5cGUsIHVpbnQ4X3QgaW5kZXgsCisgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIHZvaWQgKipidWZmZXIsIHVpbnQxNl90ICpzaXplKQoreworICAgIHN0YXRp
YyBzdHJ1Y3QgbGlidXNiX2RldmljZV9kZXNjcmlwdG9yIGRlc2MgPSB7CisgICAgICAgIC5iTGVu
Z3RoID0gMTgsCisgICAgICAgIC5iRGVzY3JpcHRvclR5cGUgPSBMSUJVU0JfRFRfREVWSUNFLAor
ICAgICAgICAuYmNkVVNCID0gVVNCMl9CQ0QsCisgICAgICAgIC5iRGV2aWNlQ2xhc3MgPSAwLAor
ICAgICAgICAuYkRldmljZVN1YkNsYXNzID0gMCwKKyAgICAgICAgLmJEZXZpY2VQcm90b2NvbCA9
IDAsCisgICAgICAgIC5iTWF4UGFja2V0U2l6ZTAgPSA2NCwKKyAgICAgICAgLmlkVmVuZG9yID0g
Q0RfREVWX1ZJRCwKKyAgICAgICAgLmlkUHJvZHVjdCA9IENEX0RFVl9QSUQsCisgICAgICAgIC5i
Y2REZXZpY2UgPSAweDEwMCwKKyAgICAgICAgLmlNYW51ZmFjdHVyZXIgPSAxLAorICAgICAgICAu
aVByb2R1Y3QgPSAyLAorICAgICAgICAuaVNlcmlhbE51bWJlciA9IDMsCisgICAgICAgIC5iTnVt
Q29uZmlndXJhdGlvbnMgPSAxCisgICAgfTsKKyAgICBzdGF0aWMgdWludDhfdCBjZmdbXSA9Cisg
ICAgeworICAgICAgICA5LCAvL2xlbiBvZiBjZmcgZGVzYworICAgICAgICBMSUJVU0JfRFRfQ09O
RklHLCAvLyBkZXNjIHR5cGUKKyAgICAgICAgMHgyMCwgLy8gd2xlbgorICAgICAgICAwLAorICAg
ICAgICAxLCAvLyBudW0gaWYKKyAgICAgICAgMSwgLy8gY2ZnIHZhbAorICAgICAgICAwLCAvLyBj
ZmcgbmFtZQorICAgICAgICAweDgwLCAvLyBidXMgcG93ZXJlZAorICAgICAgICAweDMyLCAvLyAx
MDAgbWEKKyAgICAgICAgOSwgLy8gbGVuIG9mIElGIGRlc2MKKyAgICAgICAgTElCVVNCX0RUX0lO
VEVSRkFDRSwKKyAgICAgICAgMCwgLy8gbnVtIGlmCisgICAgICAgIDAsIC8vIGFsdCBzZXR0aW5n
CisgICAgICAgIDIsIC8vIG51bSBvZiBlbmRwb2ludHMKKyAgICAgICAgQ0RfREVWX0NMQVNTLAor
ICAgICAgICBDRF9ERVZfU1VCQ0xBU1MsCisgICAgICAgIENEX0RFVl9QUk9UT0NPTCwKKyAgICAg
ICAgMCwgLy8gaWYgbmFtZQorICAgICAgICA3LAorICAgICAgICBMSUJVU0JfRFRfRU5EUE9JTlQs
CisgICAgICAgIDB4ODEsIC8vLT5EaXJlY3Rpb24gOiBJTiAtIEVuZHBvaW50SUQgOiAxCisgICAg
ICAgIDB4MDIsIC8vLT5CdWxrIFRyYW5zZmVyIFR5cGUKKyAgICAgICAgMCwgICAgLy93TWF4UGFj
a2V0U2l6ZSA6IDB4MDIwMCA9IDB4MjAwIG1heCBieXRlcworICAgICAgICAyLAorICAgICAgICAw
LCAgICAvL2JJbnRlcnZhbAorICAgICAgICA3LAorICAgICAgICBMSUJVU0JfRFRfRU5EUE9JTlQs
CisgICAgICAgIDB4MDIsIC8vLT5EaXJlY3Rpb24gOiBPVVQgLSBFbmRwb2ludElEIDogMgorICAg
ICAgICAweDAyLCAvLy0+QnVsayBUcmFuc2ZlciBUeXBlCisgICAgICAgIDAsICAgIC8vd01heFBh
Y2tldFNpemUgOiAweDAyMDAgPSAweDIwMCBtYXggYnl0ZXMKKyAgICAgICAgMiwKKyAgICAgICAg
MCwgICAgLy9iSW50ZXJ2YWwKKyAgICB9OworICAgIHN0YXRpYyB1aW50MTZfdCBzMFsyXSA9IHsg
MHgzMDQsIDB4NDA5IH07CisgICAgc3RhdGljIHVpbnQxNl90IHMxWzhdID0geyAweDMxMCwgJ1In
LCAnZScsICdkJywgJyAnLCAnSCcsICdhJywgJ3QnIH07CisgICAgc3RhdGljIHVpbnQxNl90IHMy
WzldID0geyAweDMxMiwgJ1MnLCAncCcsICdpJywgJ2MnLCAnZScsICcgJywgJ0MnLCAnRCcgfTsK
KworICAgIHZvaWQgKnAgPSBOVUxMOworICAgIHVpbnQxNl90IGxlbiA9IDA7CisKKyAgICBzd2l0
Y2ggKHR5cGUpIHsKKyAgICBjYXNlIExJQlVTQl9EVF9ERVZJQ0U6CisgICAgICAgIHAgPSAmZGVz
YzsKKyAgICAgICAgbGVuID0gc2l6ZW9mKGRlc2MpOworICAgICAgICBicmVhazsKKyAgICBjYXNl
IExJQlVTQl9EVF9DT05GSUc6CisgICAgICAgIHAgPSBjZmc7CisgICAgICAgIGxlbiA9IHNpemVv
ZihjZmcpOworICAgICAgICBicmVhazsKKyAgICBjYXNlIExJQlVTQl9EVF9TVFJJTkc6CisgICAg
ICAgIGlmIChpbmRleCA9PSAwKSB7CisgICAgICAgICAgICBwID0gczA7IGxlbiA9IHNpemVvZihz
MCk7CisgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPT0gMSkgeworICAgICAgICAgICAgcCA9IHMx
OyBsZW4gPSBzaXplb2YoczEpOworICAgICAgICB9IGVsc2UgaWYgKGluZGV4ID09IDIpIHsKKyAg
ICAgICAgICAgIHAgPSBzMjsgbGVuID0gc2l6ZW9mKHMyKTsKKyAgICAgICAgfSBlbHNlIGlmIChp
bmRleCA9PSAzKSB7CisgICAgICAgICAgICBwID0gZC0+c2VyaWFsOyBsZW4gPSBzaXplb2YoZC0+
c2VyaWFsKTsKKyAgICAgICAgfQorICAgICAgICBicmVhazsKKyAgICB9CisKKyAgICBpZiAocCkg
eworICAgICAgICAqYnVmZmVyID0gcDsKKyAgICAgICAgKnNpemUgPSBsZW47CisgICAgfQorCisg
ICAgcmV0dXJuIHAgIT0gTlVMTDsKK30KKworc3RhdGljIHZvaWQgdXNiX2NkX2F0dGFjaChVc2JD
ZCAqZGV2aWNlLCBzdHJ1Y3QgdXNicmVkaXJwYXJzZXIgKnBhcnNlcikKK3sKKyAgICBkZXZpY2Ut
PnBhcnNlciA9IHBhcnNlcjsKK30KKworc3RhdGljIHZvaWQgdXNiX2NkX2RldGFjaChVc2JDZCAq
ZGV2aWNlKQoreworICAgIGRldmljZS0+cGFyc2VyID0gTlVMTDsKK30KKworc3RhdGljIHZvaWQg
dXNiX2NkX3Jlc2V0KFVzYkNkICpkZXZpY2UpCit7CisgICAgY2RfdXNiX2J1bGtfbXNkX3Jlc2V0
KGRldmljZS0+bXNjKTsKK30KKworc3RhdGljIHZvaWQgdXNiX2NkX2NvbnRyb2xfcmVxdWVzdChV
c2JDZCAqZGV2aWNlLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1aW50OF90
ICpkYXRhLCBpbnQgZGF0YV9sZW4sCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
IHN0cnVjdCB1c2JfcmVkaXJfY29udHJvbF9wYWNrZXRfaGVhZGVyICpoLAorICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICB2b2lkICoqYnVmZmVyKQoreworICAgIHVpbnQ4X3QgcmVx
dHlwZSA9IGgtPnJlcXVlc3R0eXBlICYgMHg3ZjsKKyAgICBpZiAoIWRldmljZS0+bXNjKSB7Cisg
ICAgICAgIHJldHVybjsKKyAgICB9CisgICAgaWYgKHJlcXR5cGUgPT0gKExJQlVTQl9SRVFVRVNU
X1RZUEVfU1RBTkRBUkQgfCBMSUJVU0JfUkVDSVBJRU5UX0VORFBPSU5UKSkgeworICAgICAgICAv
LyBtaWdodCBiZSBjbGVhciBzdGFsbCByZXF1ZXN0CisgICAgICAgIGgtPmxlbmd0aCA9IDA7Cisg
ICAgICAgIGgtPnN0YXR1cyA9IHVzYl9yZWRpcl9zdWNjZXNzOzsKKyAgICAgICAgcmV0dXJuOwor
ICAgIH0KKworICAgIGlmIChyZXF0eXBlID09IChMSUJVU0JfUkVRVUVTVF9UWVBFX0NMQVNTIHwg
TElCVVNCX1JFQ0lQSUVOVF9JTlRFUkZBQ0UpKSB7CisgICAgICAgIHN3aXRjaCAoaC0+cmVxdWVz
dCkgeworICAgICAgICBjYXNlIDB4RkY6CisgICAgICAgICAgICAvLyBtYXNzLXN0b3JhZ2UgY2xh
c3MgcmVxdWVzdCAncmVzZXQnCisgICAgICAgICAgICB1c2JfY2RfcmVzZXQoZGV2aWNlKTsKKyAg
ICAgICAgICAgIGgtPmxlbmd0aCA9IDA7CisgICAgICAgICAgICBoLT5zdGF0dXMgPSB1c2JfcmVk
aXJfc3VjY2VzczsKKyAgICAgICAgICAgIGJyZWFrOworICAgICAgICBjYXNlIDB4RkU6CisgICAg
ICAgICAgICAvLyBtYXNzLXN0b3JhZ2UgY2xhc3MgcmVxdWVzdCAnZ2V0IG1heCBsdW4nCisgICAg
ICAgICAgICAvLyByZXR1cm5pbmcgb25lIGJ5dGUKKyAgICAgICAgICAgIGlmIChoLT5sZW5ndGgp
IHsKKyAgICAgICAgICAgICAgICBoLT5sZW5ndGggPSAxOworICAgICAgICAgICAgICAgIGgtPnN0
YXR1cyA9IHVzYl9yZWRpcl9zdWNjZXNzOzsKKyAgICAgICAgICAgICAgICAqYnVmZmVyID0gJmRl
dmljZS0+bWF4X2x1bl9pbmRleDsKKyAgICAgICAgICAgIH0KKyAgICAgICAgICAgIGJyZWFrOwor
ICAgICAgICB9CisgICAgfQorfQorCitzdGF0aWMgdm9pZCB1c2JfY2RfYnVsa19vdXRfcmVxdWVz
dChVc2JDZCAqZGV2aWNlLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWlu
dDhfdCBlcCwgdWludDhfdCAqZGF0YSwgaW50IGRhdGFfbGVuLAorICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgdWludDhfdCAqc3RhdHVzKQoreworICAgIGlmICghY2RfdXNiX2J1
bGtfbXNkX3dyaXRlKGRldmljZS0+bXNjLCBkYXRhLCBkYXRhX2xlbikpIHsKKyAgICAgICAgKnN0
YXR1cyA9IHVzYl9yZWRpcl9zdWNjZXNzOworICAgIH0KK30KKwordm9pZCBjZF91c2JfYnVsa19t
c2RfcmVhZF9jb21wbGV0ZSh2b2lkICp1c2VyX2RhdGEsCisgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIHVpbnQ4X3QgKmRhdGEsIHVpbnQzMl90IGxlbmd0aCwgQ2RVc2JCdWxrU3Rh
dHVzIHN0YXR1cykKK3sKKyAgICBVc2JDZCAqZCA9IChVc2JDZCAqKXVzZXJfZGF0YTsKKworICAg
IGlmIChkLT5kZWxldGluZykgeworICAgICAgICBkLT5kZWxldGluZyA9IEZBTFNFOworICAgICAg
ICBzcGljZV91c2JfYmFja2VuZF9kZXZpY2VfZWplY3QoZC0+YmFja2VuZCwgZC0+cGFyZW50KTsK
KyAgICB9CisKKyAgICBpZiAoZC0+cGFyc2VyKSB7CisgICAgICAgIGludCBucmVhZDsKKyAgICAg
ICAgdWludDMyX3Qgb2Zmc2V0ID0gMDsKKworICAgICAgICBmb3IgKG5yZWFkID0gMDsgbnJlYWQg
PCBkLT5udW1fcmVhZHM7IG5yZWFkKyspIHsKKyAgICAgICAgICAgIHVpbnQzMl90IG1heF9sZW47
CisgICAgICAgICAgICBtYXhfbGVuID0gKGQtPnJlYWRfYnVsa1tucmVhZF0uaG91dC5sZW5ndGhf
aGlnaCA8PCAxNikgfAorICAgICAgICAgICAgICAgICAgICAgICAgZC0+cmVhZF9idWxrW25yZWFk
XS5ob3V0Lmxlbmd0aDsKKyAgICAgICAgICAgIGlmIChtYXhfbGVuID4gbGVuZ3RoKSB7CisgICAg
ICAgICAgICAgICAgbWF4X2xlbiA9IGxlbmd0aDsKKyAgICAgICAgICAgICAgICBkLT5yZWFkX2J1
bGtbbnJlYWRdLmhvdXQubGVuZ3RoID0gbGVuZ3RoOworICAgICAgICAgICAgICAgIGQtPnJlYWRf
YnVsa1tucmVhZF0uaG91dC5sZW5ndGhfaGlnaCA9IGxlbmd0aCA+PiAxNjsKKyAgICAgICAgICAg
IH0KKworICAgICAgICAgICAgc3dpdGNoIChzdGF0dXMpIHsKKyAgICAgICAgICAgIGNhc2UgQlVM
S19TVEFUVVNfR09PRDoKKyAgICAgICAgICAgICAgICBkLT5yZWFkX2J1bGtbbnJlYWRdLmhvdXQu
c3RhdHVzID0gdXNiX3JlZGlyX3N1Y2Nlc3M7CisgICAgICAgICAgICAgICAgYnJlYWs7CisgICAg
ICAgICAgICBjYXNlIEJVTEtfU1RBVFVTX0NBTkNFTEVEOgorICAgICAgICAgICAgICAgIGQtPnJl
YWRfYnVsa1tucmVhZF0uaG91dC5zdGF0dXMgPSB1c2JfcmVkaXJfY2FuY2VsbGVkOworICAgICAg
ICAgICAgICAgIGJyZWFrOworICAgICAgICAgICAgY2FzZSBCVUxLX1NUQVRVU19FUlJPUjoKKyAg
ICAgICAgICAgICAgICBkLT5yZWFkX2J1bGtbbnJlYWRdLmhvdXQuc3RhdHVzID0gdXNiX3JlZGly
X2lvZXJyb3I7CisgICAgICAgICAgICAgICAgYnJlYWs7CisgICAgICAgICAgICBjYXNlIEJVTEtf
U1RBVFVTX1NUQUxMOgorICAgICAgICAgICAgZGVmYXVsdDoKKyAgICAgICAgICAgICAgICBkLT5y
ZWFkX2J1bGtbbnJlYWRdLmhvdXQuc3RhdHVzID0gdXNiX3JlZGlyX3N0YWxsOworICAgICAgICAg
ICAgICAgIGJyZWFrOworICAgICAgICAgICAgfQorCisgICAgICAgICAgICBTUElDRV9ERUJVRygi
JXM6IHJlc3BvbmRpbmcgJSIgR19HVUlOVDY0X0ZPUk1BVCAiIHdpdGggbGVuICV1IG91dCBvZiAl
dSwgc3RhdHVzICVkIiwKKyAgICAgICAgICAgICAgICAgICAgICAgIF9fRlVOQ1RJT05fXywgZC0+
cmVhZF9idWxrW25yZWFkXS5pZCwgbWF4X2xlbiwKKyAgICAgICAgICAgICAgICAgICAgICAgIGxl
bmd0aCwgZC0+cmVhZF9idWxrW25yZWFkXS5ob3V0LnN0YXR1cyk7CisgICAgICAgICAgICB1c2Jy
ZWRpcnBhcnNlcl9zZW5kX2J1bGtfcGFja2V0KGQtPnBhcnNlciwgZC0+cmVhZF9idWxrW25yZWFk
XS5pZCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJmQtPnJl
YWRfYnVsa1tucmVhZF0uaG91dCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgbWF4X2xlbiA/IChkYXRhICsgb2Zmc2V0KSA6IE5VTEwsCisgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heF9sZW4pOworICAgICAgICAgICAgb2Zm
c2V0ICs9IG1heF9sZW47CisgICAgICAgICAgICBsZW5ndGggLT0gbWF4X2xlbjsKKyAgICAgICAg
fQorICAgICAgICBkLT5udW1fcmVhZHMgPSAwOworICAgICAgICB1c2JyZWRpcnBhcnNlcl9kb193
cml0ZShkLT5wYXJzZXIpOworCisgICAgICAgIGlmIChsZW5ndGgpIHsKKyAgICAgICAgICAgIFNQ
SUNFX0RFQlVHKCIlczogRVJST1I6ICV1IGJ5dGVzIHdlcmUgbm90IHJlcG9ydGVkISIsIF9fRlVO
Q1RJT05fXywgbGVuZ3RoKTsKKyAgICAgICAgfQorCisgICAgfSBlbHNlIHsKKyAgICAgICAgU1BJ
Q0VfREVCVUcoIiVzOiBicm9rZW4gZGV2aWNlPC0+Y2hhbm5lbCByZWxhdGlvbnNoaXAhIiwgX19G
VU5DVElPTl9fKTsKKyAgICB9Cit9CisKKy8qIGRldmljZSByZXNldCBjb21wbGV0aW9uIGNhbGxi
YWNrICovCit2b2lkIGNkX3VzYl9idWxrX21zZF9yZXNldF9jb21wbGV0ZSh2b2lkICp1c2VyX2Rh
dGEsIGludCBzdGF0dXMpCit7CisgICAgLy8gVXNiQ2QgKmQgPSAoVXNiQ2QgKil1c2VyX2RhdGE7
Cit9CisKK3N0YXRpYyBnYm9vbGVhbiB1c2JfY2RfYnVsa19pbl9yZXF1ZXN0KFVzYkNkICpkLCB1
aW50NjRfdCBpZCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cnVj
dCB1c2JfcmVkaXJfYnVsa19wYWNrZXRfaGVhZGVyICpoKQoreworICAgIGludCByZXM7CisgICAg
dWludDMyX3QgbGVuID0gKGgtPmxlbmd0aF9oaWdoIDw8IDE2KSB8IGgtPmxlbmd0aDsKKyAgICBp
ZiAoZC0+bnVtX3JlYWRzID49IE1BWF9CVUxLX0lOX1JFUVVFU1RTKSB7CisgICAgICAgIGgtPmxl
bmd0aCA9IGgtPmxlbmd0aF9oaWdoID0gMDsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiB0b28g
bWFueSBwZW5kaW5nIHJlYWRzIiwgX19GVU5DVElPTl9fKTsKKyAgICAgICAgaC0+c3RhdHVzID0g
dXNiX3JlZGlyX2JhYmJsZTsKKyAgICAgICAgcmV0dXJuIEZBTFNFOworICAgIH0KKworICAgIGlm
IChkLT5udW1fcmVhZHMpIHsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBhbHJlYWR5IGhhcyAl
dSBwZW5kaW5nIHJlYWRzIiwgX19GVU5DVElPTl9fLCBkLT5udW1fcmVhZHMpOworICAgIH0KKwor
ICAgIGQtPnJlYWRfYnVsa1tkLT5udW1fcmVhZHNdLmhvdXQgPSAqaDsKKyAgICBkLT5yZWFkX2J1
bGtbZC0+bnVtX3JlYWRzXS5pZCA9IGlkOworICAgIGQtPm51bV9yZWFkcysrOworICAgIHJlcyA9
IGNkX3VzYl9idWxrX21zZF9yZWFkKGQtPm1zYywgbGVuKTsKKyAgICBpZiAoIXJlcykgeworICAg
ICAgICByZXR1cm4gVFJVRTsKKyAgICB9CisKKyAgICBTUElDRV9ERUJVRygiJXM6IGVycm9yIG9u
IGJ1bGsgcmVhZCIsIF9fRlVOQ1RJT05fXyk7CisgICAgZC0+bnVtX3JlYWRzLS07CisgICAgaC0+
bGVuZ3RoID0gaC0+bGVuZ3RoX2hpZ2ggPSAwOworICAgIGgtPnN0YXR1cyA9IHVzYl9yZWRpcl9p
b2Vycm9yOworCisgICAgcmV0dXJuIEZBTFNFOworfQorCitzdGF0aWMgdm9pZCB1c2JfY2RfY2Fu
Y2VsX3JlcXVlc3QoVXNiQ2QgKmQsIHVpbnQ2NF90IGlkKQoreworICAgIHVpbnQzMl90IG5yZWFk
OworCisgICAgZm9yIChucmVhZCA9IDA7IG5yZWFkIDwgZC0+bnVtX3JlYWRzOyBucmVhZCsrKSB7
CisgICAgICAgIGlmIChkLT5yZWFkX2J1bGtbbnJlYWRdLmlkID09IGlkKSB7CisgICAgICAgICAg
ICBpZiAoY2RfdXNiX2J1bGtfbXNkX2NhbmNlbF9yZWFkKGQtPm1zYykpIHsKKyAgICAgICAgICAg
ICAgICBjZF91c2JfYnVsa19tc2RfcmVhZF9jb21wbGV0ZShkLCBOVUxMLCAwLCBCVUxLX1NUQVRV
U19DQU5DRUxFRCk7CisgICAgICAgICAgICB9CisgICAgICAgICAgICByZXR1cm47CisgICAgICAg
IH0KKyAgICB9CisgICAgU1BJQ0VfREVCVUcoIiVzOiBFUlJPUjogbm8gc3VjaCBpZCB0byBjYW5j
ZWwhIiwgX19GVU5DVElPTl9fKTsKK30KKworLy8gY2FsbGVkIHdoZW4gYSBjaGFuZ2UgaGFwcGVu
cyBvbiBTQ1NJIGxheWVyCit2b2lkIGNkX3VzYl9idWxrX21zZF9sdW5fY2hhbmdlZCh2b2lkICp1
c2VyX2RhdGEsIHVpbnQzMl90IGx1bikKK3sKKyAgICBVc2JDZCAqZCA9IChVc2JDZCAqKXVzZXJf
ZGF0YTsKKyAgICBDZFNjc2lEZXZpY2VJbmZvIGNkX2luZm87CisKKyAgICBpZiAoIWNkX3VzYl9i
dWxrX21zZF9nZXRfaW5mbyhkLT5tc2MsIGx1biwgJmNkX2luZm8pKSB7CisgICAgICAgIC8vIGxv
YWQgb3IgdW5sb2FkIGNvbW1hbmQgcmVjZWl2ZWQgZnJvbSBTQ1NJCisgICAgICAgIGlmIChkLT51
bml0c1tsdW5dLmxvYWRlZCAhPSBjZF9pbmZvLmxvYWRlZCkgeworICAgICAgICAgICAgaWYgKCFs
b2FkX2x1bihkLCBsdW4sIGNkX2luZm8ubG9hZGVkKSkgeworICAgICAgICAgICAgICAgIFNQSUNF
X0RFQlVHKCIlczogbG9hZCBmYWlsZWQsIHVubG9hZGluZyB1bml0IiwgX19GVU5DVElPTl9fKTsK
KyAgICAgICAgICAgICAgICBjZF91c2JfYnVsa19tc2RfdW5sb2FkKGQtPm1zYywgbHVuKTsKKyAg
ICAgICAgICAgIH0KKyAgICAgICAgfQorICAgIH0KKworICAgIGlmIChkLT5kZWxldGVfb25fZWpl
Y3QpIHsKKyAgICAgICAgZC0+ZGVsZXRlX29uX2VqZWN0ID0gRkFMU0U7CisgICAgICAgIGQtPmRl
bGV0aW5nID0gVFJVRTsKKyAgICB9IGVsc2UgeworICAgICAgICBzcGljZV91c2JfYmFja2VuZF9k
ZXZpY2VfcmVwb3J0X2NoYW5nZShkLT5iYWNrZW5kLCBkLT5wYXJlbnQpOworICAgIH0KK30KKwor
c3RhdGljIGdjaGFyICp1c2JfY2RfZ2V0X3Byb2R1Y3RfZGVzY3JpcHRpb24oVXNiQ2QgKmRldmlj
ZSkKK3sKKyAgICBnY2hhciAqYmFzZV9uYW1lID0gZ19wYXRoX2dldF9iYXNlbmFtZShkZXZpY2Ut
PnVuaXRzWzBdLmZpbGVuYW1lKTsKKyAgICBnY2hhciAqcmVzID0gZ19zdHJkdXBfcHJpbnRmKCJT
UElDRSBDRCAoJXMpIiwgYmFzZV9uYW1lKTsKKyAgICBnX2ZyZWUoYmFzZV9uYW1lKTsKKyAgICBy
ZXR1cm4gcmVzOworfQorCitzdGF0aWMgY29uc3QgVXNiRGV2aWNlT3BzIGRldm9wcyA9Cit7Cisg
ICAgLmdldF9kZXNjcmlwdG9yID0gdXNiX2NkX2dldF9kZXNjcmlwdG9yLAorICAgIC5nZXRfcHJv
ZHVjdF9kZXNjcmlwdGlvbiA9IHVzYl9jZF9nZXRfcHJvZHVjdF9kZXNjcmlwdGlvbiwKKyAgICAu
YXR0YWNoID0gdXNiX2NkX2F0dGFjaCwKKyAgICAucmVzZXQgPSB1c2JfY2RfcmVzZXQsCisgICAg
LmRldGFjaCA9IHVzYl9jZF9kZXRhY2gsCisgICAgLmNvbnRyb2xfcmVxdWVzdCA9IHVzYl9jZF9j
b250cm9sX3JlcXVlc3QsCisgICAgLmJ1bGtfb3V0X3JlcXVlc3QgPSB1c2JfY2RfYnVsa19vdXRf
cmVxdWVzdCwKKyAgICAuYnVsa19pbl9yZXF1ZXN0ID0gdXNiX2NkX2J1bGtfaW5fcmVxdWVzdCwK
KyAgICAuY2FuY2VsX3JlcXVlc3QgPSB1c2JfY2RfY2FuY2VsX3JlcXVlc3QsCisgICAgLnVucmVh
bGl6ZSA9IHVzYl9jZF91bnJlYWxpemUsCit9OworCitzdGF0aWMgVXNiQ2QqIHVzYl9jZF9jcmVh
dGUoU3BpY2VVc2JCYWNrZW5kICpiZSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICBTcGlj
ZVVzYkJhY2tlbmREZXZpY2UgKnBhcmVudCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICB2
b2lkICpvcGFxdWVfcGFyYW0sCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgR0Vycm9yICoq
ZXJyKQoreworICAgIENkRW11bGF0aW9uUGFyYW1zICpwYXJhbSA9IG9wYXF1ZV9wYXJhbTsKKyAg
ICBpbnQgZXJyb3IgPSAwLCBpOworICAgIHVpbnQzMl90IHVuaXQgPSAwOworICAgIFVzYkNkICpk
ID0gZ19uZXcwKFVzYkNkLCAxKTsKKyAgICBDZFNjc2lEZXZpY2VQYXJhbWV0ZXJzIGRldl9wYXJh
bXMgPSB7IDAgfTsKKyAgICB1aW50MTZfdCBhZGRyZXNzID0gc3BpY2VfdXNiX2JhY2tlbmRfZGV2
aWNlX2dldF9pbmZvKHBhcmVudCktPmFkZHJlc3M7CisKKyAgICBkLT5kZXZfb3BzID0gZGV2b3Bz
OworICAgIGQtPmJhY2tlbmQgPSBiZTsKKyAgICBkLT5wYXJlbnQgID0gcGFyZW50OworICAgIGQt
PmRlbGV0ZV9vbl9lamVjdCA9ICEhcGFyYW0tPmRlbGV0ZV9vbl9lamVjdDsKKyAgICBkLT5sb2Nr
ZWQgPSAhZC0+ZGVsZXRlX29uX2VqZWN0OworICAgIGQtPnNlcmlhbFswXSA9IDB4MDMwMCArIHNp
emVvZihkLT5zZXJpYWwpOworICAgIGQtPnNlcmlhbFsxXSA9ICcwJyArIGFkZHJlc3MgLyAxMDsK
KyAgICBkLT5zZXJpYWxbMl0gPSAnMCcgKyBhZGRyZXNzICUgMTA7CisgICAgZm9yIChpID0gMzsg
aSA8IEdfTl9FTEVNRU5UUyhkLT5zZXJpYWwpOyArK2kpIHsKKyAgICAgICAgZC0+c2VyaWFsW2ld
ID0gJzAnOworICAgIH0KKyAgICBkLT5tYXhfbHVuX2luZGV4ID0gTUFYX0xVTl9QRVJfREVWSUNF
IC0gMTsKKworICAgIGRldl9wYXJhbXMudmVuZG9yID0gIlJlZCBIYXQiOworICAgIGRldl9wYXJh
bXMucHJvZHVjdCA9ICJTUElDRSBDRCI7CisgICAgZGV2X3BhcmFtcy52ZXJzaW9uID0gIjAiOwor
CisgICAgZC0+bXNjID0gY2RfdXNiX2J1bGtfbXNkX2FsbG9jKGQsIE1BWF9MVU5fUEVSX0RFVklD
RSk7CisgICAgaWYgKCFkLT5tc2MpIHsKKyAgICAgICAgZ19jbGVhcl9wb2ludGVyKCZkLCBnX2Zy
ZWUpOworICAgICAgICBnX3NldF9lcnJvcihlcnIsIFNQSUNFX0NMSUVOVF9FUlJPUiwgU1BJQ0Vf
Q0xJRU5UX0VSUk9SX0ZBSUxFRCwKKyAgICAgICAgICAgICAgICAgICAgXygiY2FuJ3QgYWxsb2Nh
dGUgZGV2aWNlIikpOworICAgICAgICByZXR1cm4gTlVMTDsKKyAgICB9CisgICAgZC0+dW5pdHNb
dW5pdF0uYmxvY2tTaXplID0gQ0RfREVWX0JMT0NLX1NJWkU7CisgICAgaWYgKCFjZF91c2JfYnVs
a19tc2RfcmVhbGl6ZShkLT5tc2MsIHVuaXQsICZkZXZfcGFyYW1zKSkgeworICAgICAgICBpZiAo
b3Blbl9zdHJlYW0oJmQtPnVuaXRzW3VuaXRdLCBwYXJhbS0+ZmlsZW5hbWUpICYmCisgICAgICAg
ICAgICBsb2FkX2x1bihkLCB1bml0LCBUUlVFKSkgeworICAgICAgICAgICAgaWYgKGQtPmxvY2tl
ZCkgeworICAgICAgICAgICAgICAgIGNkX3VzYl9idWxrX21zZF9sb2NrKGQtPm1zYywgdW5pdCwg
VFJVRSk7CisgICAgICAgICAgICB9CisgICAgICAgIH0gZWxzZSB7CisgICAgICAgICAgICBjbG9z
ZV9zdHJlYW0oJmQtPnVuaXRzW3VuaXRdKTsKKyAgICAgICAgICAgIGNkX3VzYl9idWxrX21zZF91
bnJlYWxpemUoZC0+bXNjLCB1bml0KTsKKyAgICAgICAgICAgIGdfc2V0X2Vycm9yKGVyciwgU1BJ
Q0VfQ0xJRU5UX0VSUk9SLCBTUElDRV9DTElFTlRfRVJST1JfRkFJTEVELAorICAgICAgICAgICAg
ICAgICAgICAgICAgXygiY2FuJ3QgY3JlYXRlIGRldmljZSB3aXRoICVzIiksCisgICAgICAgICAg
ICAgICAgICAgICAgICBwYXJhbS0+ZmlsZW5hbWUpOworICAgICAgICAgICAgZXJyb3IgPSAxOwor
ICAgICAgICB9CisgICAgfSBlbHNlIHsKKyAgICAgICAgZ19zZXRfZXJyb3IoZXJyLCBTUElDRV9D
TElFTlRfRVJST1IsIFNQSUNFX0NMSUVOVF9FUlJPUl9GQUlMRUQsCisgICAgICAgICAgICAgICAg
ICAgIF8oImNhbid0IGFsbG9jYXRlIGRldmljZSIpKTsKKyAgICAgICAgZXJyb3IgPSAxOworICAg
IH0KKyAgICBpZiAoZXJyb3IpIHsKKyAgICAgICAgZ19jbGVhcl9wb2ludGVyKCZkLT5tc2MsIGNk
X3VzYl9idWxrX21zZF9mcmVlKTsKKyAgICAgICAgZ19jbGVhcl9wb2ludGVyKCZkLCBnX2ZyZWUp
OworICAgICAgICByZXR1cm4gTlVMTDsKKyAgICB9CisKKyAgICByZXR1cm4gZDsKK30KKworZ2Jv
b2xlYW4KK2NyZWF0ZV9lbXVsYXRlZF9jZChTcGljZVVzYkJhY2tlbmQgKmJlLAorICAgICAgICAg
ICAgICAgICAgIENkRW11bGF0aW9uUGFyYW1zICpwYXJhbSwKKyAgICAgICAgICAgICAgICAgICBH
RXJyb3IgKiplcnIpCit7CisgICAgcmV0dXJuIHNwaWNlX3VzYl9iYWNrZW5kX2NyZWF0ZV9lbXVs
YXRlZF9kZXZpY2UoYmUsIHVzYl9jZF9jcmVhdGUsIHBhcmFtLCBlcnIpOworfQorCisjZW5kaWYg
LyogVVNFX1VTQlJFRElSICovCmRpZmYgLS1naXQgYS9zcmMvdXNiLWRldmljZS1jZC5oIGIvc3Jj
L3VzYi1kZXZpY2UtY2QuaApuZXcgZmlsZSBtb2RlIDEwMDY0NAppbmRleCAwMDAwMDAwLi5lOTg1
MjQyCi0tLSAvZGV2L251bGwKKysrIGIvc3JjL3VzYi1kZXZpY2UtY2QuaApAQCAtMCwwICsxLDM0
IEBACisvKiAtKi0gTW9kZTogQzsgYy1iYXNpYy1vZmZzZXQ6IDQ7IGluZGVudC10YWJzLW1vZGU6
IG5pbCAtKi0gKi8KKy8qCisgICAgQ29weXJpZ2h0IChDKSAyMDE5IFJlZCBIYXQsIEluYy4KKwor
ICAgIFJlZCBIYXQgQXV0aG9yczoKKyAgICBZdXJpIEJlbmRpdG92aWNoPHliZW5kaXRvQHJlZGhh
dC5jb20+CisKKyAgICBUaGlzIGxpYnJhcnkgaXMgZnJlZSBzb2Z0d2FyZTsgeW91IGNhbiByZWRp
c3RyaWJ1dGUgaXQgYW5kL29yCisgICAgbW9kaWZ5IGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUg
R05VIExlc3NlciBHZW5lcmFsIFB1YmxpYworICAgIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5IHRo
ZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlcgorICAgIHZlcnNpb24gMi4xIG9mIHRo
ZSBMaWNlbnNlLCBvciAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgorCisgICAg
VGhpcyBsaWJyYXJ5IGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1
c2VmdWwsCisgICAgYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGlt
cGxpZWQgd2FycmFudHkgb2YKKyAgICBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQ
QVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlIEdOVQorICAgIExlc3NlciBHZW5lcmFsIFB1Ymxp
YyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuCisKKyAgICBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2
ZWQgYSBjb3B5IG9mIHRoZSBHTlUgTGVzc2VyIEdlbmVyYWwgUHVibGljCisgICAgTGljZW5zZSBh
bG9uZyB3aXRoIHRoaXMgbGlicmFyeTsgaWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9s
aWNlbnNlcy8+LgorKi8KKworI3ByYWdtYSBvbmNlCisKKyNpbmNsdWRlICJ1c2ItYmFja2VuZC5o
IgorCit0eXBlZGVmIHN0cnVjdCBDZEVtdWxhdGlvblBhcmFtcyB7CisgICAgY29uc3QgY2hhciAq
ZmlsZW5hbWU7CisgICAgdWludDMyX3QgZGVsZXRlX29uX2VqZWN0IDogMTsKK30gQ2RFbXVsYXRp
b25QYXJhbXM7CisKK2dib29sZWFuCitjcmVhdGVfZW11bGF0ZWRfY2QoU3BpY2VVc2JCYWNrZW5k
ICpiZSwKKyAgICAgICAgICAgICAgICAgICBDZEVtdWxhdGlvblBhcmFtcyAqcGFyYW0sCisgICAg
ICAgICAgICAgICAgICAgR0Vycm9yICoqZXJyKTsKLS0gCjIuMTcuMQoKX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KU3BpY2UtZGV2ZWwgbWFpbGluZyBsaXN0
ClNwaWNlLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNr
dG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL3NwaWNlLWRldmVs
