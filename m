Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 8934F5541F
	for <lists+spice-devel@lfdr.de>; Tue, 25 Jun 2019 18:12:08 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 0B9AF6E181;
	Tue, 25 Jun 2019 16:12:07 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id E58706E17F
 for <spice-devel@lists.freedesktop.org>; Tue, 25 Jun 2019 16:12:05 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx05.intmail.prod.int.phx2.redhat.com
 [10.5.11.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 9076A30860BE
 for <spice-devel@lists.freedesktop.org>; Tue, 25 Jun 2019 16:12:05 +0000 (UTC)
Received: from fziglio.remote.csb (unknown [10.33.32.4])
 by smtp.corp.redhat.com (Postfix) with ESMTP id 8628D5D721;
 Tue, 25 Jun 2019 16:12:04 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Tue, 25 Jun 2019 17:11:36 +0100
Message-Id: <20190625161147.25211-13-fziglio@redhat.com>
In-Reply-To: <20190625161147.25211-1-fziglio@redhat.com>
References: <20190625161147.25211-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.15
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.44]); Tue, 25 Jun 2019 16:12:05 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-server 12/23] websocket: Propagate some
 variable
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

VGhlc2Ugd2VyZSBpbnRyb2R1Y2VkIG1vdmluZyBjb2RlIGFyb3VuZC4KTm8gbW9yZSByZWFzb24g
dG8gY29weSwganVzdCB1c2UgZGlyZWN0bHkgc3RydWN0dXJlIGZpZWxkcy4KClNpZ25lZC1vZmYt
Ynk6IEZyZWRpYW5vIFppZ2xpbyA8ZnppZ2xpb0ByZWRoYXQuY29tPgotLS0KIHNlcnZlci93ZWJz
b2NrZXQuYyB8IDQ3ICsrKysrKysrKysrKysrKysrKysrLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0KIDEgZmlsZSBjaGFuZ2VkLCAyMCBpbnNlcnRpb25zKCspLCAyNyBkZWxldGlvbnMoLSkKCmRp
ZmYgLS1naXQgYS9zZXJ2ZXIvd2Vic29ja2V0LmMgYi9zZXJ2ZXIvd2Vic29ja2V0LmMKaW5kZXgg
Mzg0OTZmYjVhLi5hZmI3NTAyYTEgMTAwNjQ0Ci0tLSBhL3NlcnZlci93ZWJzb2NrZXQuYworKysg
Yi9zZXJ2ZXIvd2Vic29ja2V0LmMKQEAgLTkwLDcgKzkwLDcgQEAgc3RydWN0IFJlZHNXZWJTb2Nr
ZXQgewogICAgIHdlYnNvY2tldF93cml0ZXZfY2JfdCByYXdfd3JpdGV2OwogfTsKIAotc3RhdGlj
IHZvaWQgd2Vic29ja2V0X2Fja19jbG9zZSh2b2lkICpvcGFxdWUsIHdlYnNvY2tldF93cml0ZV9j
Yl90IHdyaXRlX2NiKTsKK3N0YXRpYyB2b2lkIHdlYnNvY2tldF9hY2tfY2xvc2Uodm9pZCAqc3Ry
ZWFtLCB3ZWJzb2NrZXRfd3JpdGVfY2JfdCB3cml0ZV9jYik7CiAKIC8qIFBlcmZvcm0gYSBjYXNl
IGluc2Vuc2l0aXZlIHNlYXJjaCBmb3IgbmVlZGxlIGluIGhheXN0YWNrLgogICAgSWYgZm91bmQs
IHJldHVybiBhIHBvaW50ZXIgdG8gdGhlIGJ5dGUgYWZ0ZXIgdGhlIGVuZCBvZiBuZWVkbGUuCkBA
IC0yNzksOSArMjc5LDYgQEAgaW50IHdlYnNvY2tldF9yZWFkKFJlZHNXZWJTb2NrZXQgKndzLCB1
aW50OF90ICpidWYsIHNpemVfdCBzaXplKQogICAgIGludCBuID0gMDsKICAgICBpbnQgcmM7CiAg
ICAgd2Vic29ja2V0X2ZyYW1lX3QgKmZyYW1lID0gJndzLT5yZWFkX2ZyYW1lOwotICAgIHZvaWQg
Km9wYXF1ZSA9IHdzLT5yYXdfc3RyZWFtOwotICAgIHdlYnNvY2tldF9yZWFkX2NiX3QgcmVhZF9j
YiA9ICh3ZWJzb2NrZXRfcmVhZF9jYl90KSB3cy0+cmF3X3JlYWQ7Ci0gICAgd2Vic29ja2V0X3dy
aXRlX2NiX3Qgd3JpdGVfY2IgPSAod2Vic29ja2V0X3dyaXRlX2NiX3QpIHdzLT5yYXdfd3JpdGU7
CiAKICAgICBpZiAod3MtPmNsb3NlZCkgewogICAgICAgICByZXR1cm4gMDsKQEAgLTI5MCw3ICsy
ODcsOCBAQCBpbnQgd2Vic29ja2V0X3JlYWQoUmVkc1dlYlNvY2tldCAqd3MsIHVpbnQ4X3QgKmJ1
Ziwgc2l6ZV90IHNpemUpCiAgICAgd2hpbGUgKHNpemUgPiAwKSB7CiAgICAgICAgIC8vIG1ha2Ug
c3VyZSB3ZSBoYXZlIGEgcHJvcGVyIGZyYW1lIHJlYWR5CiAgICAgICAgIGlmICghZnJhbWUtPmZy
YW1lX3JlYWR5KSB7Ci0gICAgICAgICAgICByYyA9IHJlYWRfY2Iod3MtPnJhd19zdHJlYW0sIGZy
YW1lLT5oZWFkZXIgKyBmcmFtZS0+aGVhZGVyX3BvcywgZnJhbWVfYnl0ZXNfbmVlZGVkKGZyYW1l
KSk7CisgICAgICAgICAgICByYyA9IHdzLT5yYXdfcmVhZCh3cy0+cmF3X3N0cmVhbSwgZnJhbWUt
PmhlYWRlciArIGZyYW1lLT5oZWFkZXJfcG9zLAorICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgZnJhbWVfYnl0ZXNfbmVlZGVkKGZyYW1lKSk7CiAgICAgICAgICAgICBpZiAocmMgPD0gMCkg
ewogICAgICAgICAgICAgICAgIGdvdG8gcmVhZF9lcnJvcjsKICAgICAgICAgICAgIH0KQEAgLTMw
MiwxMiArMzAwLDEzIEBAIGludCB3ZWJzb2NrZXRfcmVhZChSZWRzV2ViU29ja2V0ICp3cywgdWlu
dDhfdCAqYnVmLCBzaXplX3Qgc2l6ZSkKICAgICAgICAgICAgICAgICByZXR1cm4gLTE7CiAgICAg
ICAgICAgICB9CiAgICAgICAgIH0gZWxzZSBpZiAoZnJhbWUtPnR5cGUgPT0gQ0xPU0VfRlJBTUUp
IHsKLSAgICAgICAgICAgIHdlYnNvY2tldF9hY2tfY2xvc2Uob3BhcXVlLCB3cml0ZV9jYik7Cisg
ICAgICAgICAgICB3ZWJzb2NrZXRfYWNrX2Nsb3NlKHdzLT5yYXdfc3RyZWFtLCB3cy0+cmF3X3dy
aXRlKTsKICAgICAgICAgICAgIHdlYnNvY2tldF9jbGVhcl9mcmFtZShmcmFtZSk7CiAgICAgICAg
ICAgICB3cy0+Y2xvc2VkID0gdHJ1ZTsKICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICB9
IGVsc2UgaWYgKGZyYW1lLT50eXBlID09IEJJTkFSWV9GUkFNRSkgewotICAgICAgICAgICAgcmMg
PSByZWFkX2NiKG9wYXF1ZSwgYnVmLCBNSU4oc2l6ZSwgZnJhbWUtPmV4cGVjdGVkX2xlbiAtIGZy
YW1lLT5yZWxheWVkKSk7CisgICAgICAgICAgICByYyA9IHdzLT5yYXdfcmVhZCh3cy0+cmF3X3N0
cmVhbSwgYnVmLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTUlOKHNpemUsIGZyYW1l
LT5leHBlY3RlZF9sZW4gLSBmcmFtZS0+cmVsYXllZCkpOwogICAgICAgICAgICAgaWYgKHJjIDw9
IDApIHsKICAgICAgICAgICAgICAgICBnb3RvIHJlYWRfZXJyb3I7CiAgICAgICAgICAgICB9CkBA
IC00MDMsMjQgKzQwMiwyMSBAQCBpbnQgd2Vic29ja2V0X3dyaXRldihSZWRzV2ViU29ja2V0ICp3
cywgY29uc3Qgc3RydWN0IGlvdmVjICppb3YsIGludCBpb3ZjbnQpCiAgICAgaW50IGlvdl9vdXRf
Y250OwogICAgIGludCBpOwogICAgIGludCBoZWFkZXJfbGVuOwotICAgIHZvaWQgKm9wYXF1ZSA9
IHdzLT5yYXdfc3RyZWFtOwotICAgIHdlYnNvY2tldF93cml0ZXZfY2JfdCB3cml0ZXZfY2IgPSAo
d2Vic29ja2V0X3dyaXRldl9jYl90KSB3cy0+cmF3X3dyaXRldjsKLSAgICB1aW50NjRfdCAqcmVt
YWluZGVyID0gJndzLT53cml0ZV9yZW1haW5kZXI7CiAKICAgICBpZiAod3MtPmNsb3NlZCkgewog
ICAgICAgICBlcnJubyA9IEVQSVBFOwogICAgICAgICByZXR1cm4gLTE7CiAgICAgfQotICAgIGlm
ICgqcmVtYWluZGVyID4gMCkgewotICAgICAgICBjb25zdHJhaW5faW92KChzdHJ1Y3QgaW92ZWMg
KikgaW92LCBpb3ZjbnQsICZpb3Zfb3V0LCAmaW92X291dF9jbnQsICpyZW1haW5kZXIpOwotICAg
ICAgICByYyA9IHdyaXRldl9jYihvcGFxdWUsIGlvdl9vdXQsIGlvdl9vdXRfY250KTsKKyAgICBp
ZiAod3MtPndyaXRlX3JlbWFpbmRlciA+IDApIHsKKyAgICAgICAgY29uc3RyYWluX2lvdigoc3Ry
dWN0IGlvdmVjICopIGlvdiwgaW92Y250LCAmaW92X291dCwgJmlvdl9vdXRfY250LCB3cy0+d3Jp
dGVfcmVtYWluZGVyKTsKKyAgICAgICAgcmMgPSB3cy0+cmF3X3dyaXRldih3cy0+cmF3X3N0cmVh
bSwgaW92X291dCwgaW92X291dF9jbnQpOwogICAgICAgICBpZiAoaW92X291dCAhPSBpb3YpIHsK
ICAgICAgICAgICAgIGdfZnJlZShpb3Zfb3V0KTsKICAgICAgICAgfQogICAgICAgICBpZiAocmMg
PD0gMCkgewogICAgICAgICAgICAgcmV0dXJuIHJjOwogICAgICAgICB9Ci0gICAgICAgICpyZW1h
aW5kZXIgLT0gcmM7CisgICAgICAgIHdzLT53cml0ZV9yZW1haW5kZXIgLT0gcmM7CiAgICAgICAg
IHJldHVybiByYzsKICAgICB9CiAKQEAgLTQzNiw3ICs0MzIsNyBAQCBpbnQgd2Vic29ja2V0X3dy
aXRldihSZWRzV2ViU29ja2V0ICp3cywgY29uc3Qgc3RydWN0IGlvdmVjICppb3YsIGludCBpb3Zj
bnQpCiAgICAgaGVhZGVyX2xlbiA9IGZpbGxfaGVhZGVyKGhlYWRlciwgbGVuKTsKICAgICBpb3Zf
b3V0WzBdLmlvdl9sZW4gPSBoZWFkZXJfbGVuOwogICAgIGlvdl9vdXRbMF0uaW92X2Jhc2UgPSBo
ZWFkZXI7Ci0gICAgcmMgPSB3cml0ZXZfY2Iob3BhcXVlLCBpb3Zfb3V0LCBpb3Zfb3V0X2NudCk7
CisgICAgcmMgPSB3cy0+cmF3X3dyaXRldih3cy0+cmF3X3N0cmVhbSwgaW92X291dCwgaW92X291
dF9jbnQpOwogICAgIGdfZnJlZShpb3Zfb3V0KTsKICAgICBpZiAocmMgPD0gMCkgewogICAgICAg
ICByZXR1cm4gcmM7CkBAIC00NDgsNyArNDQ0LDcgQEAgaW50IHdlYnNvY2tldF93cml0ZXYoUmVk
c1dlYlNvY2tldCAqd3MsIGNvbnN0IHN0cnVjdCBpb3ZlYyAqaW92LCBpbnQgaW92Y250KQogICAg
IC8qIEtleSBwb2ludDogIGlmIHdlIGRpZCBub3Qgd3JpdGUgb3V0IGFsbCB0aGUgZGF0YSwgcmVt
ZW1iZXIgaG93CiAgICAgICAgbXVjaCBtb3JlIGRhdGEgdGhlIGNsaWVudCBpcyBleHBlY3Rpbmcs
IGFuZCB3cml0ZSB0aGF0IGRhdGEgd2l0aG91dAogICAgICAgIGEgaGVhZGVyIG9mIGFueSBraW5k
IHRoZSBuZXh0IHRpbWUgYXJvdW5kICovCi0gICAgKnJlbWFpbmRlciA9IGxlbiAtIHJjOworICAg
IHdzLT53cml0ZV9yZW1haW5kZXIgPSBsZW4gLSByYzsKIAogICAgIHJldHVybiByYzsKIH0KQEAg
LTQ1OCwxOCArNDU0LDE1IEBAIGludCB3ZWJzb2NrZXRfd3JpdGUoUmVkc1dlYlNvY2tldCAqd3Ms
IGNvbnN0IHZvaWQgKmJ1Ziwgc2l6ZV90IGxlbikKICAgICB1aW50OF90IGhlYWRlcltXRUJTT0NL
RVRfTUFYX0hFQURFUl9TSVpFXTsKICAgICBpbnQgcmM7CiAgICAgaW50IGhlYWRlcl9sZW47Ci0g
ICAgdm9pZCAqb3BhcXVlID0gd3MtPnJhd19zdHJlYW07Ci0gICAgd2Vic29ja2V0X3dyaXRlX2Ni
X3Qgd3JpdGVfY2IgPSAod2Vic29ja2V0X3dyaXRlX2NiX3QpIHdzLT5yYXdfd3JpdGU7Ci0gICAg
dWludDY0X3QgKnJlbWFpbmRlciA9ICZ3cy0+d3JpdGVfcmVtYWluZGVyOwogCiAgICAgaWYgKHdz
LT5jbG9zZWQpIHsKICAgICAgICAgZXJybm8gPSBFUElQRTsKICAgICAgICAgcmV0dXJuIC0xOwog
ICAgIH0KIAotICAgIGlmICgqcmVtYWluZGVyID09IDApIHsKKyAgICBpZiAod3MtPndyaXRlX3Jl
bWFpbmRlciA9PSAwKSB7CiAgICAgICAgIGhlYWRlcl9sZW4gPSBmaWxsX2hlYWRlcihoZWFkZXIs
IGxlbik7Ci0gICAgICAgIHJjID0gd3JpdGVfY2Iob3BhcXVlLCBoZWFkZXIsIGhlYWRlcl9sZW4p
OworICAgICAgICByYyA9IHdzLT5yYXdfd3JpdGUod3MtPnJhd19zdHJlYW0sIGhlYWRlciwgaGVh
ZGVyX2xlbik7CiAgICAgICAgIGlmIChyYyA8PSAwKSB7CiAgICAgICAgICAgICByZXR1cm4gcmM7
CiAgICAgICAgIH0KQEAgLTQ4MSwyNiArNDc0LDI2IEBAIGludCB3ZWJzb2NrZXRfd3JpdGUoUmVk
c1dlYlNvY2tldCAqd3MsIGNvbnN0IHZvaWQgKmJ1Ziwgc2l6ZV90IGxlbikKICAgICAgICAgICAg
IHJldHVybiAtMTsKICAgICAgICAgfQogICAgIH0gZWxzZSB7Ci0gICAgICAgIGxlbiA9IE1JTigq
cmVtYWluZGVyLCBsZW4pOworICAgICAgICBsZW4gPSBNSU4od3MtPndyaXRlX3JlbWFpbmRlciwg
bGVuKTsKICAgICB9CiAKLSAgICByYyA9IHdyaXRlX2NiKG9wYXF1ZSwgYnVmLCBsZW4pOworICAg
IHJjID0gd3MtPnJhd193cml0ZSh3cy0+cmF3X3N0cmVhbSwgYnVmLCBsZW4pOwogICAgIGlmIChy
YyA8PSAwKSB7Ci0gICAgICAgICpyZW1haW5kZXIgPSBsZW47CisgICAgICAgIHdzLT53cml0ZV9y
ZW1haW5kZXIgPSBsZW47CiAgICAgfSBlbHNlIHsKLSAgICAgICAgKnJlbWFpbmRlciA9IGxlbiAt
IHJjOworICAgICAgICB3cy0+d3JpdGVfcmVtYWluZGVyID0gbGVuIC0gcmM7CiAgICAgfQogICAg
IHJldHVybiByYzsKIH0KIAotc3RhdGljIHZvaWQgd2Vic29ja2V0X2Fja19jbG9zZSh2b2lkICpv
cGFxdWUsIHdlYnNvY2tldF93cml0ZV9jYl90IHdyaXRlX2NiKQorc3RhdGljIHZvaWQgd2Vic29j
a2V0X2Fja19jbG9zZSh2b2lkICpzdHJlYW0sIHdlYnNvY2tldF93cml0ZV9jYl90IHdyaXRlX2Ni
KQogewogICAgIHVuc2lnbmVkIGNoYXIgaGVhZGVyWzJdOwogCiAgICAgaGVhZGVyWzBdID0gRklO
X0ZMQUcgfCBDTE9TRV9GUkFNRTsKICAgICBoZWFkZXJbMV0gPSAwOwogCi0gICAgd3JpdGVfY2Io
b3BhcXVlLCBoZWFkZXIsIHNpemVvZihoZWFkZXIpKTsKKyAgICB3cml0ZV9jYihzdHJlYW0sIGhl
YWRlciwgc2l6ZW9mKGhlYWRlcikpOwogfQogCiBzdGF0aWMgYm9vbCB3ZWJzb2NrZXRfaXNfc3Rh
cnQoY2hhciAqYnVmKQotLSAKMi4yMC4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fXwpTcGljZS1kZXZlbCBtYWlsaW5nIGxpc3QKU3BpY2UtZGV2ZWxAbGlz
dHMuZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4v
bGlzdGluZm8vc3BpY2UtZGV2ZWw=
