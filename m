Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id E59E37F7ED
	for <lists+spice-devel@lfdr.de>; Fri,  2 Aug 2019 15:10:50 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 668826EE0E;
	Fri,  2 Aug 2019 13:10:49 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mail-wr1-f68.google.com (mail-wr1-f68.google.com
 [209.85.221.68])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 2AFB36EE0C
 for <spice-devel@lists.freedesktop.org>; Fri,  2 Aug 2019 13:10:48 +0000 (UTC)
Received: by mail-wr1-f68.google.com with SMTP id n9so77236546wru.0
 for <spice-devel@lists.freedesktop.org>; Fri, 02 Aug 2019 06:10:48 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:subject:date:message-id:mime-version
 :content-transfer-encoding;
 bh=NgYE/3LrwyxeWV7Y6KhSIuo2PNnnN6nLoVvK5fENvBM=;
 b=Z8e+gnt0y4FABGyZckH4nzCUsQCasJ5A0u1fciazzP0VW60+dPpCwoywx0hhOXcxlX
 SNzIUBfhNCtOnd1MtESlLUHFfIBwSr2nU2V7rDh1FPybr1DJlxmf/UgmMI+aoyNiqvnM
 uzpv54Co4wtB+LVibrAnUUt4qaSheMJrrZdk8G7ntU8kkJQJMGonOKxjDWMZVYC00Na0
 kAHAelySkTAVk5lzHzQYfjTjwttNOt6uXk/+jk33eUGklstdCgNW0PM8fhMu9KcORQRF
 JNOCwcn7aURh04Otq4yMHcLGBJ0Ne8ZvLLvKmuuDH97DT/kCZKOtbnZ8KBDUelNpYeIL
 jOvA==
X-Gm-Message-State: APjAAAUVODPsk/e4b2Bi7UVXgsfQf3GkrCLx/9gvxVsc8ckDe5tUawMa
 mefJhqo1NfXZiTzokH4wX3zjarld9CYLIg==
X-Google-Smtp-Source: APXvYqzGtgQ4Cfpe4tqZ0CrTWjQGU+vp34xje0r1Bqi1F3uwz45DG72Cy4j1QB9kEE5opRURkDUjQA==
X-Received: by 2002:adf:f94a:: with SMTP id q10mr12359807wrr.341.1564751446486; 
 Fri, 02 Aug 2019 06:10:46 -0700 (PDT)
Received: from pinea.redhat.com (25.119.19.109.rev.sfr.net. [109.19.119.25])
 by smtp.gmail.com with ESMTPSA id f204sm119333037wme.18.2019.08.02.06.10.45
 for <spice-devel@lists.freedesktop.org>
 (version=TLS1_3 cipher=AEAD-AES256-GCM-SHA384 bits=256/256);
 Fri, 02 Aug 2019 06:10:45 -0700 (PDT)
From: Kevin Pouget <kpouget@redhat.com>
To: spice-devel <spice-devel@lists.freedesktop.org>
Date: Fri,  2 Aug 2019 15:10:42 +0200
Message-Id: <20190802131043.28274-1-kpouget@redhat.com>
X-Mailer: git-send-email 2.21.0
MIME-Version: 1.0
Subject: [Spice-devel] [RFC v2 1/2] stream-channel: Use the preferred codec
 list instead of supported
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

VGhpcyBwYXRjaCBjb21wdXRlcyBhbmQgc2VuZHMgdGhlIGxpc3Qgb2YgdGhlIHZpZGVvIGNvZGVj
cyBwcmVmZXJyZWQKYnkgYWxsIHRoZSBjbGllbnRzIHdoZW4gcmVxdWVzdGluZyB0byBzdGFydCBh
IG5ldyB2aWRlbyBzdHJlYW0uCgpJdCB1c2VkIHRvIGJlIHRoZSBsaXN0IG9mIHRoZSBzdXBwb3J0
ZWQgY29kZWNzLgoKVGhlIE1KUEVHIGNvZGVjIGlzIHVzZWQgYXMgYSBmYWxsYmFjayBpcyB0aGVy
ZSBpZiBubyBjb2RlYyBwcmVmZXJyZWQKYnkgYWxsIHRoZSBjbGllbnRzLgoKU2lnbmVkLW9mZi1i
eTogS2V2aW4gUG91Z2V0IDxrcG91Z2V0QHJlZGhhdC5jb20+Ci0tLQogc2VydmVyL3N0cmVhbS1j
aGFubmVsLmMgfCA0MiArKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKystLS0tLS0tLQog
MSBmaWxlIGNoYW5nZWQsIDM0IGluc2VydGlvbnMoKyksIDggZGVsZXRpb25zKC0pCgpkaWZmIC0t
Z2l0IGEvc2VydmVyL3N0cmVhbS1jaGFubmVsLmMgYi9zZXJ2ZXIvc3RyZWFtLWNoYW5uZWwuYwpp
bmRleCA3OTUzMDE4ZS4uYWU1ZDdiODEgMTAwNjQ0Ci0tLSBhL3NlcnZlci9zdHJlYW0tY2hhbm5l
bC5jCisrKyBiL3NlcnZlci9zdHJlYW0tY2hhbm5lbC5jCkBAIC0zNDYsOSArMzQ2LDkgQEAgc3Ry
ZWFtX2NoYW5uZWxfbmV3KFJlZHNTdGF0ZSAqc2VydmVyLCB1aW50MzJfdCBpZCkKCiAjZGVmaW5l
IE1BWF9TVVBQT1JURURfQ09ERUNTIFNQSUNFX1ZJREVPX0NPREVDX1RZUEVfRU5VTV9FTkQKCi0v
LyBmaW5kIGNvbW1vbiBjb2RlY3Mgc3VwcG9ydGVkIGJ5IGFsbCBjbGllbnRzCisvLyBmaW5kIGNv
bW1vbiBjb2RlY3MgcHJlZmVycmVkIGJ5IGFsbCBjbGllbnRzCiBzdGF0aWMgdWludDhfdAotc3Ry
ZWFtX2NoYW5uZWxfZ2V0X3N1cHBvcnRlZF9jb2RlY3MoU3RyZWFtQ2hhbm5lbCAqY2hhbm5lbCwg
dWludDhfdCAqb3V0X2NvZGVjcykKK3N0cmVhbV9jaGFubmVsX2dldF9wcmVmZXJyZWRfY29kZWNz
KFN0cmVhbUNoYW5uZWwgKmNoYW5uZWwsIHVpbnQ4X3QgKm91dF9jb2RlY3MpCiB7CiAgICAgUmVk
Q2hhbm5lbENsaWVudCAqcmNjOwogICAgIGludCBjb2RlYzsKQEAgLTM2OSwxNyArMzY5LDM4IEBA
IHN0cmVhbV9jaGFubmVsX2dldF9zdXBwb3J0ZWRfY29kZWNzKFN0cmVhbUNoYW5uZWwgKmNoYW5u
ZWwsIHVpbnQ4X3QgKm91dF9jb2RlY3MpCiAgICAgfQoKICAgICBGT1JFQUNIX0NMSUVOVChjaGFu
bmVsLCByY2MpIHsKKyAgICAgICAgUmVkQ2hhbm5lbCAqcmVkX2NoYW5uZWwgPSByZWRfY2hhbm5l
bF9jbGllbnRfZ2V0X2NoYW5uZWwocmNjKTsKKyAgICAgICAgUmVkc1N0YXRlICpyZWRzID0gcmVk
X2NoYW5uZWxfZ2V0X3NlcnZlcihyZWRfY2hhbm5lbCk7CisgICAgICAgIEdBcnJheSAqcHJlZmVy
cmVkX2NvZGVjcyA9IHJlZHNfZ2V0X3ZpZGVvX2NvZGVjcyhyZWRzKTsKKwogICAgICAgICBmb3Ig
KGNvZGVjID0gMTsgY29kZWMgPCBTUElDRV9OX0VMRU1FTlRTKGNvZGVjMmNhcCk7ICsrY29kZWMp
IHsKLSAgICAgICAgICAgIC8vIGlmIGRvIG5vdCBzdXBwb3J0IGNvZGVjIGRlbGV0ZSBmcm9tIGxp
c3QKKyAgICAgICAgICAgIC8vIHNraXAgdGhlIGNvZGVjIGlmIGl0IGlzIGFscmVhZHkgbm90IHN1
cHBvcnRlZAorICAgICAgICAgICAgaWYgKCFzdXBwb3J0ZWRbY29kZWNdKSB7CisgICAgICAgICAg
ICAgICAgY29udGludWU7CisgICAgICAgICAgICB9CisKKyAgICAgICAgICAgIC8vIGRlbGV0ZSB0
aGUgY29kZWMgZnJvbSB0aGUgbGlzdCBpZiBpdCdzIG5vdCBzdXBwb3J0ZWQKICAgICAgICAgICAg
IGlmICghcmVkX2NoYW5uZWxfY2xpZW50X3Rlc3RfcmVtb3RlX2NhcChyY2MsIGNvZGVjMmNhcFtj
b2RlY10pKSB7CiAgICAgICAgICAgICAgICAgc3VwcG9ydGVkW2NvZGVjXSA9IGZhbHNlOworICAg
ICAgICAgICAgICAgIGNvbnRpbnVlOworICAgICAgICAgICAgfQorCisgICAgICAgICAgICAvLyBk
ZWxldGUgdGhlIGNvZGVjIGZyb20gdGhlIGxpc3QgaWYgaXQncyBub3QgaW4gdGhlIHByZWZlcnJl
ZCBsaXN0CisgICAgICAgICAgICBib29sIHByZWZlcnJlZF9oYXNfY29kZWMgPSBmYWxzZTsKKyAg
ICAgICAgICAgIGludCBpOworCisgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcHJlZmVycmVk
X2NvZGVjcy0+bGVuOyBpKyspIHsKKyAgICAgICAgICAgICAgICBSZWRWaWRlb0NvZGVjIHByZWZf
Y29kZWMgPSBnX2FycmF5X2luZGV4KHByZWZlcnJlZF9jb2RlY3MsIFJlZFZpZGVvQ29kZWMsIGkp
OworCisgICAgICAgICAgICAgICAgaWYgKHByZWZfY29kZWMudHlwZSA9PSBjb2RlYykgeworICAg
ICAgICAgICAgICAgICAgICBwcmVmZXJyZWRfaGFzX2NvZGVjID0gdHJ1ZTsKKyAgICAgICAgICAg
ICAgICAgICAgYnJlYWs7CisgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgfQorICAgICAg
ICAgICAgc3VwcG9ydGVkW2NvZGVjXSA9IHByZWZlcnJlZF9oYXNfY29kZWM7CiAgICAgICAgIH0K
ICAgICB9CgotICAgIC8vIHN1cmVseSBtanBlZyBpcyBzdXBwb3J0ZWQKLSAgICBzdXBwb3J0ZWRb
U1BJQ0VfVklERU9fQ09ERUNfVFlQRV9NSlBFR10gPSB0cnVlOwotCiAgICAgaW50IG51bSA9IDA7
CiAgICAgZm9yIChjb2RlYyA9IDE7IGNvZGVjIDwgU1BJQ0VfTl9FTEVNRU5UUyhjb2RlYzJjYXAp
OyArK2NvZGVjKSB7CiAgICAgICAgIGlmIChzdXBwb3J0ZWRbY29kZWNdKSB7CkBAIC0zODcsNiAr
NDA4LDExIEBAIHN0cmVhbV9jaGFubmVsX2dldF9zdXBwb3J0ZWRfY29kZWNzKFN0cmVhbUNoYW5u
ZWwgKmNoYW5uZWwsIHVpbnQ4X3QgKm91dF9jb2RlY3MpCiAgICAgICAgIH0KICAgICB9CgorICAg
IGlmIChudW0gPT0gMCkgeworICAgICAgICAvLyBzdXJlbHkgbWpwZWcgaXMgc3VwcG9ydGVkCisg
ICAgICAgIHN1cHBvcnRlZFtTUElDRV9WSURFT19DT0RFQ19UWVBFX01KUEVHXSA9IHRydWU7Cisg
ICAgfQorCiAgICAgcmV0dXJuIG51bTsKIH0KCkBAIC00MDgsNyArNDM0LDcgQEAgc3RyZWFtX2No
YW5uZWxfY29ubmVjdChSZWRDaGFubmVsICpyZWRfY2hhbm5lbCwgUmVkQ2xpZW50ICpyZWRfY2xp
ZW50LCBSZWRTdHJlYW0KICAgICBzcGljZV9yZXR1cm5faWZfZmFpbChjbGllbnQgIT0gTlVMTCk7
CgogICAgIC8vIHJlcXVlc3QgbmV3IHN0cmVhbQotICAgIHN0YXJ0LT5udW1fY29kZWNzID0gc3Ry
ZWFtX2NoYW5uZWxfZ2V0X3N1cHBvcnRlZF9jb2RlY3MoY2hhbm5lbCwgc3RhcnQtPmNvZGVjcyk7
CisgICAgc3RhcnQtPm51bV9jb2RlY3MgPSBzdHJlYW1fY2hhbm5lbF9nZXRfcHJlZmVycmVkX2Nv
ZGVjcyhjaGFubmVsLCBzdGFydC0+Y29kZWNzKTsKICAgICAvLyBzZW5kIGluIGFueSBjYXNlLCBl
dmVuIGlmIGxpc3QgaXMgbm90IGNoYW5nZWQKICAgICAvLyBub3RpZnkgZGV2aWNlIGFib3V0IGNo
YW5nZXMKICAgICByZXF1ZXN0X25ld19zdHJlYW0oY2hhbm5lbCwgc3RhcnQpOwpAQCAtNjA3LDcg
KzYzMyw3IEBAIHN0cmVhbV9jaGFubmVsX3Jlc2V0KFN0cmVhbUNoYW5uZWwgKmNoYW5uZWwpCgog
ICAgIC8vIHRyeSB0byByZXF1ZXN0IGEgbmV3IHN0cmVhbSwgdGhpcyBzaG91bGQgc3RhcnQgYSBu
ZXcgc3RyZWFtCiAgICAgLy8gaWYgdGhlIGd1ZXN0IGlzIGNvbm5lY3RlZCB0byB0aGUgZGV2aWNl
IGFuZCBhIGNsaWVudCBpcyBhbHJlYWR5IGNvbm5lY3RlZAotICAgIHN0YXJ0LT5udW1fY29kZWNz
ID0gc3RyZWFtX2NoYW5uZWxfZ2V0X3N1cHBvcnRlZF9jb2RlY3MoY2hhbm5lbCwgc3RhcnQtPmNv
ZGVjcyk7CisgICAgc3RhcnQtPm51bV9jb2RlY3MgPSBzdHJlYW1fY2hhbm5lbF9nZXRfcHJlZmVy
cmVkX2NvZGVjcyhjaGFubmVsLCBzdGFydC0+Y29kZWNzKTsKICAgICAvLyBzZW5kIGluIGFueSBj
YXNlLCBldmVuIGlmIGxpc3QgaXMgbm90IGNoYW5nZWQKICAgICAvLyBub3RpZnkgZGV2aWNlIGFi
b3V0IGNoYW5nZXMKICAgICByZXF1ZXN0X25ld19zdHJlYW0oY2hhbm5lbCwgc3RhcnQpOwotLQoy
LjIxLjAKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KU3Bp
Y2UtZGV2ZWwgbWFpbGluZyBsaXN0ClNwaWNlLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpo
dHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL3NwaWNlLWRldmVs
