Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id B267A952F4
	for <lists+spice-devel@lfdr.de>; Tue, 20 Aug 2019 03:03:56 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 44BCB6E4B2;
	Tue, 20 Aug 2019 01:03:55 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mail.codeweavers.com (mail.codeweavers.com [50.203.203.244])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 1CECD6E4B2
 for <spice-devel@lists.freedesktop.org>; Tue, 20 Aug 2019 01:03:54 +0000 (UTC)
Received: from cpe-107-184-2-226.socal.res.rr.com ([107.184.2.226]
 helo=brendan-dell.bslabs.net)
 by mail.codeweavers.com with esmtpsa (TLS1.2:ECDHE_RSA_AES_128_GCM_SHA256:128)
 (Exim 4.89) (envelope-from <bshanks@codeweavers.com>)
 id 1hzsYx-0001V5-JL; Mon, 19 Aug 2019 20:03:53 -0500
From: Brendan Shanks <bshanks@codeweavers.com>
To: spice-devel@lists.freedesktop.org
Date: Mon, 19 Aug 2019 18:03:34 -0700
Message-Id: <20190820010334.24224-4-bshanks@codeweavers.com>
X-Mailer: git-send-email 2.17.1
In-Reply-To: <20190820010334.24224-1-bshanks@codeweavers.com>
References: <20190820010334.24224-1-bshanks@codeweavers.com>
X-Spam-Score: -106.0
X-Spam-Report: Spam detection software,
 running on the system "mail.codeweavers.com", 
 has NOT identified this incoming email as spam.  The original
 message has been attached to this so you can view it or label
 similar future email.  If you have any questions, see
 the administrator of that system for details.
 Content preview: Add a cache to allow the reuse of SHM segments. Shared memory
 segments are added to the cache instead of being deallocated, and the cache
 is searched instead of/before allocating a new segment. Both the SHM segments
 and their attachment with the X server are cached. 
 Content analysis details:   (-106.0 points, 5.0 required)
 pts rule name              description
 ---- ---------------------- --------------------------------------------------
 -100 USER_IN_WHITELIST      From: address is in the user's white-list
 -6.0 ALL_TRUSTED            Passed through trusted hosts only via SMTP
X-Mailman-Original-DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt;
 c=relaxed/relaxed; 
 d=codeweavers.com; s=6377696661; h=References:In-Reply-To:Message-Id:Date:
 Subject:Cc:To:From:Sender:Reply-To:MIME-Version:Content-Type:
 Content-Transfer-Encoding:Content-ID:Content-Description:Resent-Date:
 Resent-From:Resent-Sender:Resent-To:Resent-Cc:Resent-Message-ID:List-Id:
 List-Help:List-Unsubscribe:List-Subscribe:List-Post:List-Owner:List-Archive;
 bh=GQAyIKZ02Yt6ubUTatRc6/bT1Tszm5JcuqSafaQD0So=; b=ODHbxoLrgmVNBQveHIlS6Y1jp
 3Mlpd+qxg/H/uCJWpeQP483q3/UMOvFWpOlt/XxkamOC/XgGeHH/SEBRZDDUW48UN+VmPtFvR8y3L
 VfUNPiXK34PrGnTTI7cgDt83AwRG8FsuYHsE8Gf2J4P+cmEVYi29dLLg+zJlVUcyM5eAU=;
Subject: [Spice-devel] [PATCH x11spice v4 3/3] Add cache for SHM segments
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

QWRkIGEgY2FjaGUgdG8gYWxsb3cgdGhlIHJldXNlIG9mIFNITSBzZWdtZW50cy4KU2hhcmVkIG1l
bW9yeSBzZWdtZW50cyBhcmUgYWRkZWQgdG8gdGhlIGNhY2hlIGluc3RlYWQgb2YgYmVpbmcKZGVh
bGxvY2F0ZWQsIGFuZCB0aGUgY2FjaGUgaXMgc2VhcmNoZWQgaW5zdGVhZCBvZi9iZWZvcmUgYWxs
b2NhdGluZyBhCm5ldyBzZWdtZW50LgoKQm90aCB0aGUgU0hNIHNlZ21lbnRzIGFuZCB0aGVpciBh
dHRhY2htZW50IHdpdGggdGhlIFggc2VydmVyIGFyZSBjYWNoZWQuCgpUaGUgY2FjaGUgY3VycmVu
dGx5IGhhcyBhIGZpeGVkIG51bWJlciBvZiAxMCBlbnRyaWVzLCB0aGlzIHByb3ZpZGVkIGEKZ29v
ZCBjYWNoZSBoaXQgcmF0ZSB3aGlsZSBrZWVwaW5nIG1lbW9yeSB1c2FnZSB1bmRlciBjb250cm9s
LgpCdWlsZGluZyB3aXRoIERFQlVHX1NITV9DQUNIRSBkZWZpbmVkIGFuZCBydW5uaW5nIHdpdGgK
R19NRVNTQUdFU19ERUJVRz1hbGwgd2lsbCBwZXJpb2RpY2FsbHkgcHJpbnQgb3V0IHRoZSBTSE0g
Y2FjaGUgaGl0CnJhdGUuCgpPbiBteSBVYnVudHUgMTguMDQgc3lzdGVtIHJ1bm5pbmcgWEZDRTQg
d2l0aCBhIDI1NjB4MTQ0MCBzY3JlZW4sIHRoZQpjYWNoZSBoaXQgcmF0ZSBzdGFydHMgYXJvdW5k
IDcyJS4gT24tc2NyZWVuIHdpbmRvd3MgdGhhdCB1cGRhdGUgb2Z0ZW4KYW5kIGhhdmUgY29uc2lz
dGVudGx5LXNpemVkIGRhbWFnZSByZWN0YW5nbGVzIGFyZSB0aGUgYmVzdCBjYXNlLiBXaXRoCnNl
dmVyYWwgb2YgdGhvc2UgKHNjcm9sbGluZyB0ZXJtaW5hbCB3aW5kb3dzLCB3ZWIgYnJvd3NlciBz
aG93aW5nIGEKV2ViR0wgZGVtbyksIHRoZSBoaXQgcmF0ZSBzbG93bHkgcmlzZXMgdG8gYXJvdW5k
IDkyJS4KT3BlcmF0aW9ucyB0aGF0IGdlbmVyYXRlIHJhcGlkIGRhbWFnZSByZXBvcnRzIChsaWtl
IHJlc2l6aW5nIG9yIG1vdmluZwp3aW5kb3dzKSB3aWxsIGxvd2VyIHRoZSBoaXQgcmF0ZS4KClNp
Z25lZC1vZmYtYnk6IEJyZW5kYW4gU2hhbmtzIDxic2hhbmtzQGNvZGV3ZWF2ZXJzLmNvbT4KLS0t
CiBzcmMvZGlzcGxheS5jIHwgMTczICsrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrKysrKystLS0tCiBzcmMvZGlzcGxheS5oIHwgIDExICsrKy0KIDIgZmlsZXMgY2hhbmdl
ZCwgMTY4IGluc2VydGlvbnMoKyksIDE2IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL3NyYy9k
aXNwbGF5LmMgYi9zcmMvZGlzcGxheS5jCmluZGV4IGEyYTE4YjguLmFlODAwMmUgMTAwNjQ0Ci0t
LSBhL3NyYy9kaXNwbGF5LmMKKysrIGIvc3JjL2Rpc3BsYXkuYwpAQCAtMjEzLDExICsyMTMsMTUz
IEBAIHN0YXRpYyBpbnQgcmVnaXN0ZXJfZm9yX2V2ZW50cyhkaXNwbGF5X3QgKmQpCiAgICAgcmV0
dXJuIDA7CiB9CiAKK3N0YXRpYyB2b2lkIHNobV9zZWdtZW50X2Rlc3Ryb3koZGlzcGxheV90ICpk
LCBzaG1fc2VnbWVudF90ICpzZWdtZW50KQoreworICAgIGlmIChzZWdtZW50LT5zaG1pZCA9PSAt
MSkgeworICAgICAgICByZXR1cm47CisgICAgfQorCisgICAgeGNiX3NobV9kZXRhY2goZC0+Yywg
c2VnbWVudC0+c2htc2VnKTsKKyAgICBzZWdtZW50LT5zaG1zZWcgPSAtMTsKKworICAgIHNobWR0
KHNlZ21lbnQtPnNobWFkZHIpOworICAgIHNlZ21lbnQtPnNobWFkZHIgPSBOVUxMOworCisgICAg
c2htY3RsKHNlZ21lbnQtPnNobWlkLCBJUENfUk1JRCwgTlVMTCk7CisgICAgc2VnbWVudC0+c2ht
aWQgPSAtMTsKK30KKworCitzdGF0aWMgaW50IHNobV9jYWNoZV9nZXQoZGlzcGxheV90ICpkLCBz
aXplX3Qgc2l6ZSwgc2htX3NlZ21lbnRfdCAqc2VnbWVudCkKK3sKKyAgICBpbnQgaSwgcmV0Owor
ICAgIHNobV9zZWdtZW50X3QgKmJpZ2dlcl9lbnRyeSA9IE5VTEw7CisgICAgc2htX3NlZ21lbnRf
dCAqZW50cnlfdG9fdXNlID0gTlVMTDsKKworI2lmIGRlZmluZWQoREVCVUdfU0hNX0NBQ0hFKQor
ICAgIHN0YXRpYyBndWludCBjYWNoZV9oaXRzID0gMDsKKyAgICBzdGF0aWMgZ3VpbnQgY2FjaGVf
dG90YWwgPSAwOworCisgICAgY2FjaGVfdG90YWwrKzsKKyNlbmRpZgorCisgICAgZ19tdXRleF9s
b2NrKCZkLT5zaG1fY2FjaGVfbXV0ZXgpOworCisgICAgLyogQ2hlY2sgdGhlIGNhY2hlIGZvciBh
IHNlZ21lbnQgb2Ygc2l6ZSAnc2l6ZScgb3IgYmlnZ2VyLgorICAgICAqIFVzZSBhbiBleGFjdC1z
aXplIHNlZ21lbnQgaWYgZm91bmQuCisgICAgICogSWYgbm90LCB1c2UgdGhlIHNtYWxsZXN0IGVu
dHJ5IHRoYXQgaXMgYmlnIGVub3VnaC4KKyAgICAgKi8KKyAgICBmb3IgKGkgPSAwOyBpIDwgR19O
X0VMRU1FTlRTKGQtPnNobV9jYWNoZSk7IGkrKykgeworICAgICAgICBzaG1fc2VnbWVudF90ICpl
bnRyeSA9ICZkLT5zaG1fY2FjaGVbaV07CisKKyAgICAgICAgaWYgKGVudHJ5LT5zaG1pZCAhPSAt
MSkgeworICAgICAgICAgICAgLyogSWYgYSBjYWNoZSBlbnRyeSBvZiB0aGUgZXhhY3Qgc2l6ZSBi
ZWluZyByZXF1ZXN0ZWQgaXMgZm91bmQsIHVzZSB0aGF0ICovCisgICAgICAgICAgICBpZiAoc2l6
ZSA9PSBlbnRyeS0+c2l6ZSkgeworICAgICAgICAgICAgICAgIGVudHJ5X3RvX3VzZSA9IGVudHJ5
OworICAgICAgICAgICAgICAgIGJyZWFrOworICAgICAgICAgICAgfQorCisgICAgICAgICAgICAv
KiBLZWVwIHRyYWNrIG9mIHRoZSBuZXh0LWJpZ2dlc3QgZW50cnkgaW4gY2FzZSBhbiBleGFjdC1z
aXplIG1hdGNoIGlzbid0IGZvdW5kICovCisgICAgICAgICAgICBpZiAoc2l6ZSA8IGVudHJ5LT5z
aXplKSB7CisgICAgICAgICAgICAgICAgaWYgKCFiaWdnZXJfZW50cnkgfHwgZW50cnktPnNpemUg
PCBiaWdnZXJfZW50cnktPnNpemUpIHsKKyAgICAgICAgICAgICAgICAgICAgYmlnZ2VyX2VudHJ5
ID0gZW50cnk7CisgICAgICAgICAgICAgICAgfQorICAgICAgICAgICAgfQorICAgICAgICB9Cisg
ICAgfQorCisgICAgLyogQW4gZXhhY3Qtc2l6ZSBlbnRyeSB3YXNuJ3QgZm91bmQsIHVzZSB0aGUg
bmV4dCBiaWdnZXN0IGVudHJ5IHRoYXQgd2FzIGZvdW5kICovCisgICAgaWYgKCFlbnRyeV90b191
c2UpIHsKKyAgICAgICAgZW50cnlfdG9fdXNlID0gYmlnZ2VyX2VudHJ5OworICAgIH0KKworICAg
IGlmIChlbnRyeV90b191c2UpIHsKKyAgICAgICAgKnNlZ21lbnQgPSAqZW50cnlfdG9fdXNlOwor
ICAgICAgICBlbnRyeV90b191c2UtPnNobWlkID0gLTE7CisKKyAgICAgICAgcmV0ID0gMTsKKwor
I2lmIGRlZmluZWQoREVCVUdfU0hNX0NBQ0hFKQorICAgICAgICBjYWNoZV9oaXRzKys7CisgICAg
ICAgIGlmICgoY2FjaGVfaGl0cyAlIDEwMCA9PSAwKSkgeworICAgICAgICAgICAgZ19kZWJ1Zygi
U0hNIGNhY2hlIGhpdHJhdGU6ICV1LyV1ICglLjJmJSUpIiwgY2FjaGVfaGl0cywgY2FjaGVfdG90
YWwsCisgICAgICAgICAgICAgICAgICAgIChmbG9hdCkgKChmbG9hdCkgY2FjaGVfaGl0cyAvIChm
bG9hdCkgY2FjaGVfdG90YWwpICogMTAwKTsKKyAgICAgICAgfQorI2VuZGlmCisgICAgfSBlbHNl
IHsKKyAgICAgICAgLyogTm8gdXNhYmxlIGVudHJ5IGZvdW5kIGluIHRoZSBjYWNoZSAqLworICAg
ICAgICByZXQgPSAwOworICAgIH0KKworICAgIGdfbXV0ZXhfdW5sb2NrKCZkLT5zaG1fY2FjaGVf
bXV0ZXgpOworICAgIHJldHVybiByZXQ7Cit9CisKK3N0YXRpYyBpbnQgc2htX2NhY2hlX2FkZChk
aXNwbGF5X3QgKmQsIHNobV9zZWdtZW50X3QgKnNlZ21lbnQpCit7CisgICAgaW50IGksIHJldDsK
KyAgICBzaG1fc2VnbWVudF90ICpzbWFsbGVzdF9lbnRyeSA9IE5VTEw7CisgICAgc2htX3NlZ21l
bnRfdCAqZW50cnlfdG9fdXNlID0gTlVMTDsKKworICAgIGdfbXV0ZXhfbG9jaygmZC0+c2htX2Nh
Y2hlX211dGV4KTsKKworICAgIC8qICdzZWdtZW50JyBpcyBub3cgdW51c2VkLCB0cnkgdG8gYWRk
IGl0IHRvIHRoZSBjYWNoZS4KKyAgICAgKiBVc2UgYW4gZW1wdHkgc2xvdCBpbiB0aGUgY2FjaGUg
aWYgYXZhaWxhYmxlLgorICAgICAqIElmIG5vdCwgZXZpY3QgdGhlIHNtYWxsZXN0IGVudHJ5ICh3
aGljaCBhbHNvIG11c3QgYmUgc21hbGxlciB0aGFuICdzZWdtZW50JykgZnJvbSB0aGUgY2FjaGUu
CisgICAgICovCisgICAgZm9yIChpID0gMDsgaSA8IEdfTl9FTEVNRU5UUyhkLT5zaG1fY2FjaGUp
OyBpKyspIHsKKyAgICAgICAgc2htX3NlZ21lbnRfdCAqZW50cnkgPSAmZC0+c2htX2NhY2hlW2ld
OworCisgICAgICAgIGlmIChlbnRyeS0+c2htaWQgPT0gLTEpIHsKKyAgICAgICAgICAgIC8qIFVz
ZSBhbiBlbXB0eSBzbG90IGlmIGZvdW5kICovCisgICAgICAgICAgICBlbnRyeV90b191c2UgPSBl
bnRyeTsKKyAgICAgICAgICAgIGJyZWFrOworICAgICAgICB9CisKKyAgICAgICAgLyogS2VlcCB0
cmFjayBvZiB0aGUgc21hbGxlc3QgZW50cnkgdGhhdCdzIHNtYWxsZXIgdGhhbiAnc2VnbWVudCcg
Ki8KKyAgICAgICAgaWYgKGVudHJ5LT5zaXplIDwgc2VnbWVudC0+c2l6ZSkgeworICAgICAgICAg
ICAgaWYgKCFzbWFsbGVzdF9lbnRyeSB8fCBlbnRyeS0+c2l6ZSA8IHNtYWxsZXN0X2VudHJ5LT5z
aXplKSB7CisgICAgICAgICAgICAgICAgc21hbGxlc3RfZW50cnkgPSBlbnRyeTsKKyAgICAgICAg
ICAgIH0KKyAgICAgICAgfQorICAgIH0KKworICAgIC8qIElmIG5vIGVtcHR5IGVudHJpZXMgd2Vy
ZSBmb3VuZCwgZXZpY3QgJ3NtYWxsZXN0X2VudHJ5JyBhbmQgcmV1c2UgaXQgKi8KKyAgICBpZiAo
IWVudHJ5X3RvX3VzZSAmJiBzbWFsbGVzdF9lbnRyeSkgeworICAgICAgICBzaG1fc2VnbWVudF9k
ZXN0cm95KGQsIHNtYWxsZXN0X2VudHJ5KTsKKyAgICAgICAgZW50cnlfdG9fdXNlID0gc21hbGxl
c3RfZW50cnk7CisgICAgfQorCisgICAgaWYgKGVudHJ5X3RvX3VzZSkgeworICAgICAgICAqZW50
cnlfdG9fdXNlID0gKnNlZ21lbnQ7CisgICAgICAgIHJldCA9IDE7CisgICAgfSBlbHNlIHsKKyAg
ICAgICAgLyogQ2FjaGUgaXMgZnVsbCwgYW5kIGNvbnRhaW5lZCBubyBlbnRyaWVzIHNtYWxsZXIg
dGhhbiB0aGUgb25lIGJlaW5nIGFkZGVkICovCisgICAgICAgIHJldCA9IDA7CisgICAgfQorCisg
ICAgZ19tdXRleF91bmxvY2soJmQtPnNobV9jYWNoZV9tdXRleCk7CisgICAgcmV0dXJuIHJldDsK
K30KKworc3RhdGljIHZvaWQgc2htX2NhY2hlX2Rlc3Ryb3koZGlzcGxheV90ICpkKQoreworICAg
IGludCBpOworCisgICAgZ19tdXRleF9sb2NrKCZkLT5zaG1fY2FjaGVfbXV0ZXgpOworICAgIGZv
ciAoaSA9IDA7IGkgPCBHX05fRUxFTUVOVFMoZC0+c2htX2NhY2hlKTsgaSsrKSB7CisgICAgICAg
IHNobV9zZWdtZW50X3QgKmVudHJ5ID0gJmQtPnNobV9jYWNoZVtpXTsKKworICAgICAgICBzaG1f
c2VnbWVudF9kZXN0cm95KGQsIGVudHJ5KTsKKyAgICB9CisgICAgZ19tdXRleF91bmxvY2soJmQt
PnNobV9jYWNoZV9tdXRleCk7Cit9CiAKIGludCBkaXNwbGF5X29wZW4oZGlzcGxheV90ICpkLCBz
ZXNzaW9uX3QgKnNlc3Npb24pCiB7CiAgICAgaW50IHNjcjsKICAgICBpbnQgcmM7CisgICAgaW50
IGk7CiAgICAgeGNiX2RhbWFnZV9xdWVyeV92ZXJzaW9uX2Nvb2tpZV90IGRjb29raWU7CiAgICAg
eGNiX2RhbWFnZV9xdWVyeV92ZXJzaW9uX3JlcGx5X3QgKmRhbWFnZV92ZXJzaW9uOwogICAgIHhj
Yl94a2JfdXNlX2V4dGVuc2lvbl9jb29raWVfdCB1c2VfY29va2llOwpAQCAtMzE0LDYgKzQ1Niwx
MSBAQCBpbnQgZGlzcGxheV9vcGVuKGRpc3BsYXlfdCAqZCwgc2Vzc2lvbl90ICpzZXNzaW9uKQog
ICAgIGlmIChyYykKICAgICAgICAgcmV0dXJuIHJjOwogCisgICAgZ19tdXRleF9pbml0KCZkLT5z
aG1fY2FjaGVfbXV0ZXgpOworICAgIGZvciAoaSA9IDA7IGkgPCBHX05fRUxFTUVOVFMoZC0+c2ht
X2NhY2hlKTsgaSsrKSB7CisgICAgICAgIGQtPnNobV9jYWNoZVtpXS5zaG1pZCA9IC0xOworICAg
IH0KKwogICAgIHJjID0gZGlzcGxheV9jcmVhdGVfc2NyZWVuX2ltYWdlcyhkKTsKIAogICAgIGdf
bWVzc2FnZSgiRGlzcGxheSAlcyBvcGVuZWQiLCBzZXNzaW9uLT5vcHRpb25zLmRpc3BsYXkgPyBz
ZXNzaW9uLT5vcHRpb25zLmRpc3BsYXkgOiAiIik7CkBAIC0zMjEsMTcgKzQ2OCw2IEBAIGludCBk
aXNwbGF5X29wZW4oZGlzcGxheV90ICpkLCBzZXNzaW9uX3QgKnNlc3Npb24pCiAgICAgcmV0dXJu
IHJjOwogfQogCi0vKiAKLSAgVE9ETzogSW1wbGVtZW50IGEgY2FjaGUgZm9yIHNoYXJlZCBtZW1v
cnkgaGFuZGxlcwotICAgICAgICBUaGF0IGlzLCBpbnN0ZWFkIG9mIGRvaW5nIHRoZSBzaG1nZXQv
c2htYXQgZm9yIGV2ZXJ5IHJlYWQsCi0gICAgICAgIHdlIHNob3VsZCBjYWNoZSB0aGUgc2htaWQs
IGFuZCByZXVzZSBpZiB3ZSdyZSBkb2luZyBhIGxhdGVyCi0gICAgICAgIHJlYWQgb2YgYSBzaW1p
bGFyIHNpemUuCi0KLSAgICAgICAgV2Ugd291bGQgbGlrZWx5IHNlZSBhIDQwJSBpbXByb3ZlbWVu
dCBpbiByYXcgcmVhZCB0aW1lLiAgTm90ZQotICAgICAgICB0aGF0IGEgY2FsbGdyaW5kIHJ1biBz
dWdnZXN0ZWQgdGhhdCB3b3VsZCBiZSBvbiB0aGUgb3JkZXIgb2YgNSUKLSAgICAgICAgb3ZlcmFs
bC4KLSovCi0KIHNobV9pbWFnZV90ICpjcmVhdGVfc2htX2ltYWdlKGRpc3BsYXlfdCAqZCwgdW5z
aWduZWQgaW50IHcsIHVuc2lnbmVkIGludCBoKQogewogICAgIHNobV9pbWFnZV90ICpzaG1pOwpA
QCAtMzQ5LDYgKzQ4NSwxMSBAQCBzaG1faW1hZ2VfdCAqY3JlYXRlX3NobV9pbWFnZShkaXNwbGF5
X3QgKmQsIHVuc2lnbmVkIGludCB3LCB1bnNpZ25lZCBpbnQgaCkKICAgICBzaG1pLT5ieXRlc19w
ZXJfbGluZSA9IChiaXRzX3Blcl9waXhlbChkKSAvIDgpICogc2htaS0+dzsKICAgICBpbWdzaXpl
ID0gc2htaS0+Ynl0ZXNfcGVyX2xpbmUgKiBzaG1pLT5oOwogCisgICAgaWYgKHNobV9jYWNoZV9n
ZXQoZCwgaW1nc2l6ZSwgJnNobWktPnNlZ21lbnQpKSB7CisgICAgICAgIHJldHVybiBzaG1pOwor
ICAgIH0KKworICAgIC8qIE5vIHVzYWJsZSBzaGFyZWQgbWVtb3J5IHNlZ21lbnQgZm91bmQgaW4g
Y2FjaGUsIGFsbG9jYXRlIGEgbmV3IG9uZSAqLwogICAgIHNobWktPnNlZ21lbnQuc2htaWQgPSBz
aG1nZXQoSVBDX1BSSVZBVEUsIGltZ3NpemUsIElQQ19DUkVBVCB8IDA3MDApOwogICAgIGlmIChz
aG1pLT5zZWdtZW50LnNobWlkICE9IC0xKQogICAgICAgICBzaG1pLT5zZWdtZW50LnNobWFkZHIg
PSBzaG1hdChzaG1pLT5zZWdtZW50LnNobWlkLCAwLCAwKTsKQEAgLTM2MCw2ICs1MDEsNyBAQCBz
aG1faW1hZ2VfdCAqY3JlYXRlX3NobV9pbWFnZShkaXNwbGF5X3QgKmQsIHVuc2lnbmVkIGludCB3
LCB1bnNpZ25lZCBpbnQgaCkKICAgICAvKiBXZSB0ZWxsIHNobWN0bCB0byBkZXRhY2ggbm93OyB0
aGF0IHByZXZlbnRzIHVzIGZyb20gaG9sZGluZyB0aGlzCiAgICAgICAgc2hhcmVkIG1lbW9yeSBz
ZWdtZW50IGZvcmV2ZXIgaW4gY2FzZSBvZiBhYm5vcm1hbCBwcm9jZXNzIGV4aXQuICovCiAgICAg
c2htY3RsKHNobWktPnNlZ21lbnQuc2htaWQsIElQQ19STUlELCBOVUxMKTsKKyAgICBzaG1pLT5z
ZWdtZW50LnNpemUgPSBpbWdzaXplOwogCiAgICAgc2htaS0+c2VnbWVudC5zaG1zZWcgPSB4Y2Jf
Z2VuZXJhdGVfaWQoZC0+Yyk7CiAgICAgY29va2llID0geGNiX3NobV9hdHRhY2hfY2hlY2tlZChk
LT5jLCBzaG1pLT5zZWdtZW50LnNobXNlZywgc2htaS0+c2VnbWVudC5zaG1pZCwgMCk7CkBAIC00
NTEsOSArNTkzLDEwIEBAIHZvaWQgZGlzcGxheV9jb3B5X2ltYWdlX2ludG9fZnVsbHNjcmVlbihk
aXNwbGF5X3QgKmQsIHNobV9pbWFnZV90ICpzaG1pLCBpbnQgeCwKIAogdm9pZCBkZXN0cm95X3No
bV9pbWFnZShkaXNwbGF5X3QgKmQsIHNobV9pbWFnZV90ICpzaG1pKQogewotICAgIHhjYl9zaG1f
ZGV0YWNoKGQtPmMsIHNobWktPnNlZ21lbnQuc2htc2VnKTsKLSAgICBzaG1kdChzaG1pLT5zZWdt
ZW50LnNobWFkZHIpOwotICAgIHNobWN0bChzaG1pLT5zZWdtZW50LnNobWlkLCBJUENfUk1JRCwg
TlVMTCk7CisgICAgaWYgKCFzaG1fY2FjaGVfYWRkKGQsICZzaG1pLT5zZWdtZW50KSkgeworICAg
ICAgICAvKiBDb3VsZCBub3QgYWRkIHRvIGNhY2hlLCBkZXN0cm95IHRoaXMgc2VnbWVudCAqLwor
ICAgICAgICBzaG1fc2VnbWVudF9kZXN0cm95KGQsICZzaG1pLT5zZWdtZW50KTsKKyAgICB9CiAg
ICAgaWYgKHNobWktPmRyYXdhYmxlX3B0cikKICAgICAgICAgZnJlZShzaG1pLT5kcmF3YWJsZV9w
dHIpOwogICAgIGZyZWUoc2htaSk7CkBAIC01MjEsNiArNjY0LDggQEAgdm9pZCBkaXNwbGF5X3N0
b3BfZXZlbnRfdGhyZWFkKGRpc3BsYXlfdCAqZCkKIAogdm9pZCBkaXNwbGF5X2Nsb3NlKGRpc3Bs
YXlfdCAqZCkKIHsKKyAgICBzaG1fY2FjaGVfZGVzdHJveShkKTsKKyAgICBnX211dGV4X2NsZWFy
KCZkLT5zaG1fY2FjaGVfbXV0ZXgpOwogICAgIHhjYl9kYW1hZ2VfZGVzdHJveShkLT5jLCBkLT5k
YW1hZ2UpOwogICAgIGRpc3BsYXlfZGVzdHJveV9zY3JlZW5faW1hZ2VzKGQpOwogICAgIHhjYl9k
aXNjb25uZWN0KGQtPmMpOwpkaWZmIC0tZ2l0IGEvc3JjL2Rpc3BsYXkuaCBiL3NyYy9kaXNwbGF5
LmgKaW5kZXggZGExYjk5MS4uMGFlYTM0OCAxMDA2NDQKLS0tIGEvc3JjL2Rpc3BsYXkuaAorKysg
Yi9zcmMvZGlzcGxheS5oCkBAIC0yMSwxOCArMjEsMTkgQEAKICNpZm5kZWYgRElTUExBWV9IXwog
I2RlZmluZSBESVNQTEFZX0hfCiAKKyNpbmNsdWRlIDxnbGliLmg+CiAjaW5jbHVkZSA8eGNiL3hj
Yi5oPgogI2luY2x1ZGUgPHhjYi9kYW1hZ2UuaD4KICNpbmNsdWRlIDx4Y2Ivc2htLmg+CiAKLQog
c3RydWN0IHNlc3Npb25fc3RydWN0OwogCiAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICoqICBTdHJ1
Y3R1cmUgZGVmaW5pdGlvbnMKICoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogdHlwZWRlZiBzdHJ1Y3Qg
ewotICAgIGludCBzaG1pZDsKKyAgICBpbnQgc2htaWQ7ICAgICAgLyogaWYgc2htaWQgaXMgLTE6
IHRoZSBzaG1fc2VnbWVudF90IGlzICJlbXB0eSIsIG90aGVyIG1lbWJlcnMgYXJlIHVuZGVmaW5l
ZCAqLworICAgIHNpemVfdCBzaXplOwogICAgIHhjYl9zaG1fc2VnX3Qgc2htc2VnOwogICAgIHZv
aWQgKnNobWFkZHI7CiB9IHNobV9zZWdtZW50X3Q7CkBAIC02Myw2ICs2NCwxMiBAQCB0eXBlZGVm
IHN0cnVjdCB7CiAgICAgc2htX2ltYWdlX3QgKmZ1bGxzY3JlZW47CiAgICAgc2htX2ltYWdlX3Qg
KnNjYW5saW5lOwogCisgICAgLyogVGhlIFNITSBjYWNoZSBob2xkcyB1cCB0byAxMCBzZWdtZW50
cywgdGhpcyBwcm92aWRlcyBhIGdvb2QgY2FjaGUKKyAgICAgKiBoaXQgcmF0ZSB3aGlsZSBrZWVw
aW5nIG1lbW9yeSB1c2FnZSByZWFzb25hYmxlLgorICAgICAqLworICAgIHNobV9zZWdtZW50X3Qg
c2htX2NhY2hlWzEwXTsKKyAgICBHTXV0ZXggc2htX2NhY2hlX211dGV4OworCiAgICAgcHRocmVh
ZF90IGV2ZW50X3RocmVhZDsKICAgICBzdHJ1Y3Qgc2Vzc2lvbl9zdHJ1Y3QgKnNlc3Npb247CiB9
IGRpc3BsYXlfdDsKLS0gCjIuMTcuMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX18KU3BpY2UtZGV2ZWwgbWFpbGluZyBsaXN0ClNwaWNlLWRldmVsQGxpc3Rz
LmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xp
c3RpbmZvL3NwaWNlLWRldmVs
