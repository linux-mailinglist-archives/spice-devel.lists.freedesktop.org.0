Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 14B1DA67F8
	for <lists+spice-devel@lfdr.de>; Tue,  3 Sep 2019 14:01:18 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 966F38908E;
	Tue,  3 Sep 2019 12:01:16 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 7150A8908E
 for <spice-devel@lists.freedesktop.org>; Tue,  3 Sep 2019 12:01:15 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx01.intmail.prod.int.phx2.redhat.com
 [10.5.11.11])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 0F7FA155E0
 for <spice-devel@lists.freedesktop.org>; Tue,  3 Sep 2019 12:01:15 +0000 (UTC)
Received: from lub.tlv (dhcp-4-176.tlv.redhat.com [10.35.4.176])
 by smtp.corp.redhat.com (Postfix) with ESMTPS id 0F0ED60127;
 Tue,  3 Sep 2019 12:01:13 +0000 (UTC)
To: Frediano Ziglio <fziglio@redhat.com>, spice-devel@lists.freedesktop.org
References: <20190827092246.10276-1-fziglio@redhat.com>
 <20190827092246.10276-25-fziglio@redhat.com>
From: Uri Lublin <uril@redhat.com>
Organization: Red Hat
Message-ID: <2d4fe923-43e3-ee91-1ebf-f1d815e14f4a@redhat.com>
Date: Tue, 3 Sep 2019 15:01:11 +0300
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101
 Thunderbird/60.8.0
MIME-Version: 1.0
In-Reply-To: <20190827092246.10276-25-fziglio@redhat.com>
Content-Language: en-US
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.11
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.29]); Tue, 03 Sep 2019 12:01:15 +0000 (UTC)
Subject: Re: [Spice-devel] [PATCH spice-gtk v4 24/29] usb-backend: Rewrite
 USB emulation support
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Reply-To: uril@redhat.com
Content-Transfer-Encoding: base64
Content-Type: text/plain; charset="utf-8"; Format="flowed"
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

SGksCgpPbiA4LzI3LzE5IDEyOjIyIFBNLCBGcmVkaWFubyBaaWdsaW8gd3JvdGU6Cj4gTWFrZSBp
bml0aWFsaXNhdGlvbiBlYXNpZXIuCj4gQWx3YXlzIGluaXRpYWxpc2UgcGFyc2VyLgo+IEluaXRp
YWxpc2UgYm90aCBwYXJzZXIgYW5kIGhvc3QgZHVyaW5nIHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5u
ZWxfbmV3Lgo+IFN1cHBvcnQgbm90IGhhdmluZyBsaWJ1c2IgY29udGV4dCAobm8gcGh5c2ljYWwg
ZGV2aWNlcykuCj4gQXZvaWRzIHRvbyBtdWNoIHN0YXRlIHZhcmlhYmxlcy4KPiBwYXJzZXIgaXMg
YWx3YXlzIGluaXRpYWxpc2VkIGFmdGVyIGNyZWF0aW9uIG1ha2luZyBzdXJlIHRoZSBzdGF0ZQo+
IGlzIGNvbnNpc3RlbnQuCgpJZiB1c2JyZWRpcmhvc3QgaXMgdXNlZCwgd2h5IGlzIHRoZXJlIGEg
bmVlZCBmb3IgYSBwYXJzZXIgdG9vID8KQWxzbyBiZWxvdyBpbiBpbml0aWFsaXplX3BhcnNlciB0
aGVyZSBpcyBhIGNoZWNrIHRoYXQKY2gtPnVzYnJlZGlyaG9zdCBpcyBOVUxMIChwb3NzaWJseSBi
ZWNhdXNlIHRoZSBwYXJzZXIgaXMgYWx3YXlzCmJlaW5nIGluaXRpYWxpemVkIGJlZm9yZSB0aGUg
aG9zdCkuCgo+IFVzZSBhIHNpbmdsZSBzdGF0ZSB2YXJpYWJsZSwgZGF0YSBmbG93cyBpbnRvL2Zy
b20gYSBzaW5nbGUgcGFyc2VyLgo+IAo+IFNpZ25lZC1vZmYtYnk6IEZyZWRpYW5vIFppZ2xpbyA8
ZnppZ2xpb0ByZWRoYXQuY29tPgo+IC0tLQo+ICAgc3JjL3VzYi1iYWNrZW5kLmMgfCAyMzYgKysr
KysrKysrKysrKysrKysrKysrKystLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQo+ICAgMSBmaWxlIGNo
YW5nZWQsIDExNiBpbnNlcnRpb25zKCspLCAxMjAgZGVsZXRpb25zKC0pCj4gCj4gZGlmZiAtLWdp
dCBhL3NyYy91c2ItYmFja2VuZC5jIGIvc3JjL3VzYi1iYWNrZW5kLmMKPiBpbmRleCAzNmE3M2E4
OS4uZDYxNGU2OTMgMTAwNjQ0Cj4gLS0tIGEvc3JjL3VzYi1iYWNrZW5kLmMKPiArKysgYi9zcmMv
dXNiLWJhY2tlbmQuYwo+IEBAIC03OCwyMSArNzgsMjEgQEAgc3RydWN0IF9TcGljZVVzYkJhY2tl
bmQKPiAgICAgICB1aW50MzJfdCBvd25fZGV2aWNlc19tYXNrOwo+ICAgfTsKPiAgIAo+ICt0eXBl
ZGVmIGVudW0gewo+ICsgICAgVVNCX0NIQU5ORUxfU1RBVEVfSU5JVElBTElaSU5HLAo+ICsgICAg
VVNCX0NIQU5ORUxfU1RBVEVfSE9TVCwKPiArICAgIFVTQl9DSEFOTkVMX1NUQVRFX1BBUlNFUiwK
PiArfSBTcGljZVVzYkJhY2tlbmRDaGFubmVsU3RhdGU7Cj4gKwo+ICAgc3RydWN0IF9TcGljZVVz
YkJhY2tlbmRDaGFubmVsCj4gICB7Cj4gICAgICAgc3RydWN0IHVzYnJlZGlyaG9zdCAqdXNicmVk
aXJob3N0Owo+IC0gICAgc3RydWN0IHVzYnJlZGlyaG9zdCAqaGlkZGVuX2hvc3Q7Cj4gICAgICAg
c3RydWN0IHVzYnJlZGlycGFyc2VyICpwYXJzZXI7Cj4gLSAgICBzdHJ1Y3QgdXNicmVkaXJwYXJz
ZXIgKmhpZGRlbl9wYXJzZXI7Cj4gKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsU3RhdGUgc3Rh
dGU7Cj4gICAgICAgdWludDhfdCAqcmVhZF9idWY7Cj4gICAgICAgaW50IHJlYWRfYnVmX3NpemU7
Cj4gICAgICAgc3RydWN0IHVzYnJlZGlyZmlsdGVyX3J1bGUgKnJ1bGVzOwo+ICAgICAgIGludCBy
dWxlc19jb3VudDsKPiAtICAgIHVpbnQzMl90IGhvc3RfY2FwczsKPiAtICAgIHVpbnQzMl90IHBh
cnNlcl9pbml0X2RvbmUgIDogMTsKPiAtICAgIHVpbnQzMl90IHBhcnNlcl93aXRoX2hlbGxvIDog
MTsKPiAtICAgIHVpbnQzMl90IGhlbGxvX2RvbmVfcGFyc2VyIDogMTsKPiAtICAgIHVpbnQzMl90
IGhlbGxvX3NlbnQgICAgICAgIDogMTsKPiAgICAgICB1aW50MzJfdCByZWplY3RlZCAgICAgICAg
ICA6IDE7Cj4gICAgICAgdWludDMyX3Qgd2FpdF9kaXNjb25uZWN0X2FjayA6IDE7Cj4gICAgICAg
U3BpY2VVc2JCYWNrZW5kRGV2aWNlICphdHRhY2hlZDsKPiBAQCAtNDA1LDE1ICs0MDUsMTYgQEAg
ZnJvbSBib3RoIHRoZSBtYWluIHRocmVhZCBhcyB3ZWxsIGFzIGZyb20gdGhlIHVzYiBldmVudCBo
YW5kbGluZyB0aHJlYWQgKi8KPiAgIHN0YXRpYyB2b2lkIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2Nh
bGxiYWNrKHZvaWQgKnVzZXJfZGF0YSkKPiAgIHsKPiAgICAgICBTcGljZVVzYkJhY2tlbmRDaGFu
bmVsICpjaCA9IHVzZXJfZGF0YTsKPiArICAgIGlmIChjaC0+cGFyc2VyID09IE5VTEwpIHsKPiAr
ICAgICAgICByZXR1cm47Cj4gKyAgICB9Cj4gICAgICAgaWYgKGlzX2NoYW5uZWxfcmVhZHkoY2gt
PnVzZXJfZGF0YSkpIHsKPiAtICAgICAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgewoKRG8geW91
IG5lZWQgdGhlIGZvbGxvd2luZyBnX2Fzc2VydCwgb3IgaXMgdGhlIGNoLT5wYXJzZXI9PU5VTEwg
ZW5vdWdoCiAgICBnX2Fzc2VydChjaC0+c3RhdGUgIT0gVVNCX0NIQU5ORUxfU1RBVEVfSU5JVElB
TElaSU5HKTsKCj4gKyAgICAgICAgaWYgKGNoLT5zdGF0ZSA9PSBVU0JfQ0hBTk5FTF9TVEFURV9I
T1NUKSB7Cj4gICAgICAgICAgICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAgLT4gdXNicmVkaXJo
b3N0IiwgX19GVU5DVElPTl9fLCBjaCk7Cj4gICAgICAgICAgICAgICB1c2JyZWRpcmhvc3Rfd3Jp
dGVfZ3Vlc3RfZGF0YShjaC0+dXNicmVkaXJob3N0KTsKPiAtICAgICAgICB9IGVsc2UgaWYgKGNo
LT5wYXJzZXIpIHsKPiArICAgICAgICB9IGVsc2Ugewo+ICAgICAgICAgICAgICAgU1BJQ0VfREVC
VUcoIiVzIGNoICVwIC0+IHBhcnNlciIsIF9fRlVOQ1RJT05fXywgY2gpOwo+ICAgICAgICAgICAg
ICAgdXNicmVkaXJwYXJzZXJfZG9fd3JpdGUoY2gtPnBhcnNlcik7Cj4gLSAgICAgICAgfSBlbHNl
IHsKPiAtICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIChOT1QgQUNUSVZFKSIsIF9f
RlVOQ1RJT05fXywgY2gpOwo+ICAgICAgICAgICB9Cj4gICAgICAgfSBlbHNlIHsKPiAgICAgICAg
ICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIChub3QgcmVhZHkpIiwgX19GVU5DVElPTl9fLCBjaCk7
Cj4gQEAgLTY3MywyMSArNjc0LDQyIEBAIHN0YXRpYyB2b2lkIHVzYnJlZGlyX2xvZyh2b2lkICp1
c2VyX2RhdGEsIGludCBsZXZlbCwgY29uc3QgY2hhciAqbXNnKQo+ICAgICAgIH0KPiAgIH0KPiAg
IAo+ICtzdGF0aWMgc3RydWN0IHVzYnJlZGlycGFyc2VyICpjcmVhdGVfcGFyc2VyKFNwaWNlVXNi
QmFja2VuZENoYW5uZWwgKmNoKTsKPiArCj4gICBzdGF0aWMgaW50IHVzYnJlZGlyX3dyaXRlX2Nh
bGxiYWNrKHZvaWQgKnVzZXJfZGF0YSwgdWludDhfdCAqZGF0YSwgaW50IGNvdW50KQo+ICAgewo+
ICAgICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gdXNlcl9kYXRhOwo+ICAgICAgIGlu
dCByZXM7Cj4gICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwLCAlZCBieXRlcyIsIF9fRlVOQ1RJ
T05fXywgY2gsIGNvdW50KTsKPiAtICAgIGlmICghY2gtPmhlbGxvX3NlbnQpIHsKPiAtICAgICAg
ICAvKiBoZWxsbyBpcyBzaG9ydCBoZWFkZXIgKDEyKSArIGhlbGxvIHN0cnVjdCAoNjQpICsgY2Fw
YWJpbGl0aWVzICg0KSAqLwo+IC0gICAgICAgIGludCBoZWxsb19zaXplID0gc2l6ZW9mKHN0cnVj
dCB1c2JfcmVkaXJfaGVhZGVyKSArIHNpemVvZihzdHJ1Y3QgdXNiX3JlZGlyX2hlbGxvX2hlYWRl
cik7Cj4gLSAgICAgICAgY2gtPmhlbGxvX3NlbnQgPSAxOwo+IC0gICAgICAgIGlmIChjb3VudCA9
PSBoZWxsb19zaXplKSB7Cj4gLSAgICAgICAgICAgIG1lbWNweSgmY2gtPmhvc3RfY2FwcywgZGF0
YSArIGhlbGxvX3NpemUgLSBzaXplb2YoY2gtPmhvc3RfY2FwcyksCj4gLSAgICAgICAgICAgICAg
ICAgICBzaXplb2YoY2gtPmhvc3RfY2FwcykpOwo+IC0gICAgICAgICAgICBTUElDRV9ERUJVRygi
JXMgY2ggJXAsIHNlbmRpbmcgZmlyc3QgaGVsbG8sIGNhcHMgJTA4WCIsCj4gLSAgICAgICAgICAg
ICAgICAgICAgICAgIF9fRlVOQ1RJT05fXywgY2gsIGNoLT5ob3N0X2NhcHMpOwo+ICsKPiArICAg
IC8vIGhhbmRsZSBmaXJzdCBwYWNrZXQgKEhFTExPKSBjcmVhdGluZyBwYXJzZXIgZnJvbSBjYXBh
YmlsaXRpZXMKPiArICAgIGlmIChTUElDRV9VTkxJS0VMWShjaC0+cGFyc2VyID09IE5VTEwpKSB7
Cj4gKyAgICAgICAgLy8gd2UgYXJlIHN0aWxsIGluaXRpYWxpemluZyB0aGUgaG9zdAo+ICsgICAg
ICAgIGlmIChjaC0+dXNicmVkaXJob3N0ID09IE5VTEwpIHsKPiArICAgICAgICAgICAgcmV0dXJu
IDA7Cj4gICAgICAgICAgIH0KPiArCj4gKyAgICAgICAgY2gtPnBhcnNlciA9IGNyZWF0ZV9wYXJz
ZXIoY2gpOwo+ICsgICAgICAgIGlmICghY2gtPnBhcnNlcikgewo+ICsgICAgICAgICAgICByZXR1
cm4gMDsKPiArICAgICAgICB9Cj4gKwo+ICsgICAgICAgIC8qIGhlbGxvIGlzIHNob3J0IGhlYWRl
ciAoMTIpICsgaGVsbG8gc3RydWN0ICg2NCkgKi8KPiArICAgICAgICBjb25zdCBpbnQgaGVsbG9f
c2l6ZSA9IDEyICsgc2l6ZW9mKHN0cnVjdCB1c2JfcmVkaXJfaGVsbG9faGVhZGVyKTsKCnNpemVv
ZihzdHJ1Y3QgdXNiX3JlZGlyX2hlYWRlcikgaW5zdGVhZCBvZiAxMiAoYW5kIGJ0dyBpdCdzIDE2
KQoKPiArICAgICAgICBnX2Fzc2VydChjb3VudCA+PSBoZWxsb19zaXplICsgNCk7CgpuaXQ6IE1h
eWJlIHJlcGxhY2UgNCB3aXRoCiAgIGNvbnN0IHNpemVfdCBjYXBzX3NpemUgPSBzaXplb2YodWlu
dDMyX3QpICogVVNCX1JFRElSX0NBUFNfU0laRTsKICAgZ19hc3NlcnQoY291bnQgPj0gaGVsbG9f
c2l6ZSArIGNhcHNfc2l6ZSk7CgoKVXJpLgoKPiArICAgICAgICBnX2Fzc2VydChTUElDRV9BTElH
TkVEX0NBU1Qoc3RydWN0IHVzYl9yZWRpcl9oZWFkZXIgKiwgZGF0YSktPnR5cGUgPT0gdXNiX3Jl
ZGlyX2hlbGxvKTsKPiArCj4gKyAgICAgICAgY29uc3QgdWludDMyX3QgZmxhZ3MgPQo+ICsgICAg
ICAgICAgICB1c2JyZWRpcnBhcnNlcl9mbF93cml0ZV9jYl9vd25zX2J1ZmZlciB8IHVzYnJlZGly
cGFyc2VyX2ZsX3VzYl9ob3N0IHwKPiArICAgICAgICAgICAgdXNicmVkaXJwYXJzZXJfZmxfbm9f
aGVsbG87Cj4gKwo+ICsgICAgICAgIHVzYnJlZGlycGFyc2VyX2luaXQoY2gtPnBhcnNlciwKPiAr
ICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBBQ0tBR0VfU1RSSU5HLAo+ICsgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgU1BJQ0VfQUxJR05FRF9DQVNUKHVpbnQzMl90ICosIGRhdGEgKyBo
ZWxsb19zaXplKSwKPiArICAgICAgICAgICAgICAgICAgICAgICAgICAgIChjb3VudCAtIGhlbGxv
X3NpemUpIC8gc2l6ZW9mKHVpbnQzMl90KSwKPiArICAgICAgICAgICAgICAgICAgICAgICAgICAg
IGZsYWdzKTsKPiArCj4gKyAgICAgICAgcmV0dXJuIDA7Cj4gICAgICAgfQo+ICAgICAgIHJlcyA9
IHNwaWNlX3VzYnJlZGlyX3dyaXRlX2NhbGxiYWNrKGNoLT51c2VyX2RhdGEsIGRhdGEsIGNvdW50
KTsKPiAgICAgICByZXR1cm4gcmVzOwo+IEBAIC03MDcsMzEgKzcyOSwzMyBAQCBpbnQgc3BpY2Vf
dXNiX2JhY2tlbmRfcmVhZF9ndWVzdF9kYXRhKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLCB1
aW50OF90ICpkYXRhLAo+ICAgCj4gICAgICAgY2gtPnJlYWRfYnVmID0gZGF0YTsKPiAgICAgICBj
aC0+cmVhZF9idWZfc2l6ZSA9IGNvdW50Owo+IC0gICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsK
PiAtICAgICAgICByZXMgPSB1c2JyZWRpcmhvc3RfcmVhZF9ndWVzdF9kYXRhKGNoLT51c2JyZWRp
cmhvc3QpOwo+IC0gICAgICAgIGlmICghY2gtPmhlbGxvX2RvbmVfcGFyc2VyKSB7Cj4gLSAgICAg
ICAgICAgIGludCByZXNfcGFyc2VyOwo+ICsgICAgaWYgKFNQSUNFX1VOTElLRUxZKGNoLT5zdGF0
ZSA9PSBVU0JfQ0hBTk5FTF9TVEFURV9JTklUSUFMSVpJTkcpKSB7Cj4gKyAgICAgICAgaWYgKGNo
LT51c2JyZWRpcmhvc3QgIT0gTlVMTCkgewo+ICsgICAgICAgICAgICByZXMgPSB1c2JyZWRpcmhv
c3RfcmVhZF9ndWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3QpOwo+ICsgICAgICAgICAgICBpZiAo
cmVzICE9IDApIHsKPiArICAgICAgICAgICAgICAgIHJldHVybiByZXM7Cj4gKyAgICAgICAgICAg
IH0KPiArICAgICAgICAgICAgY2gtPnN0YXRlID0gVVNCX0NIQU5ORUxfU1RBVEVfSE9TVDsKPiAr
Cj4gICAgICAgICAgICAgICAvKiB1c2JyZWRpcmhvc3Qgc2hvdWxkIGNvbnN1bWUgaGVsbG8gcmVz
cG9uc2UgKi8KPiAgICAgICAgICAgICAgIGdfcmV0dXJuX3ZhbF9pZl9mYWlsKGNoLT5yZWFkX2J1
ZiA9PSBOVUxMLCBVU0JfUkVESVJfRVJST1JfUkVBRF9QQVJTRSk7Cj4gKyAgICAgICAgfSBlbHNl
IHsKPiArICAgICAgICAgICAgY2gtPnN0YXRlID0gVVNCX0NIQU5ORUxfU1RBVEVfUEFSU0VSOwo+
ICsgICAgICAgIH0KPiAgIAo+IC0gICAgICAgICAgICBjaC0+cmVhZF9idWYgPSBkYXRhOwo+IC0g
ICAgICAgICAgICBjaC0+cmVhZF9idWZfc2l6ZSA9IGNvdW50Owo+IC0gICAgICAgICAgICBjaC0+
aGVsbG9fZG9uZV9wYXJzZXIgPSAxOwo+IC0gICAgICAgICAgICBpZiAoY2gtPmF0dGFjaGVkICYm
IGNoLT5hdHRhY2hlZC0+ZWRldikgewo+IC0gICAgICAgICAgICAgICAgLyogY2FzZSBvZiBDRCBz
aGFyaW5nIG9uIGNvbm5lY3QgKi8KPiAtICAgICAgICAgICAgICAgIGNoLT51c2JyZWRpcmhvc3Qg
PSBOVUxMOwo+IC0gICAgICAgICAgICAgICAgY2gtPnBhcnNlciA9IGNoLT5oaWRkZW5fcGFyc2Vy
Owo+IC0gICAgICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBzd2l0Y2ggJXAgdG8gcGFyc2Vy
IiwgX19GVU5DVElPTl9fLCBjaCk7Cj4gLSAgICAgICAgICAgIH0KPiAtICAgICAgICAgICAgcmVz
X3BhcnNlciA9IHVzYnJlZGlycGFyc2VyX2RvX3JlYWQoY2gtPmhpZGRlbl9wYXJzZXIpOwo+IC0g
ICAgICAgICAgICBpZiAocmVzID49IDApIHsKPiAtICAgICAgICAgICAgICAgIHJlcyA9IHJlc19w
YXJzZXI7Cj4gLSAgICAgICAgICAgIH0KPiArICAgICAgICBjaC0+cmVhZF9idWYgPSBkYXRhOwo+
ICsgICAgICAgIGNoLT5yZWFkX2J1Zl9zaXplID0gY291bnQ7Cj4gKyAgICAgICAgaWYgKGNoLT5h
dHRhY2hlZCAmJiBjaC0+YXR0YWNoZWQtPmVkZXYpIHsKPiArICAgICAgICAgICAgLyogY2FzZSBv
ZiBDRCBzaGFyaW5nIG9uIGNvbm5lY3QgKi8KPiArICAgICAgICAgICAgY2gtPnN0YXRlID0gVVNC
X0NIQU5ORUxfU1RBVEVfUEFSU0VSOwo+ICsgICAgICAgICAgICBTUElDRV9ERUJVRygiJXM6IHN3
aXRjaCAlcCB0byBwYXJzZXIiLCBfX0ZVTkNUSU9OX18sIGNoKTsKPiAgICAgICAgICAgfQo+IC0g
ICAgfSBlbHNlIGlmIChjaC0+cGFyc2VyKSB7Cj4gLSAgICAgICAgcmVzID0gdXNicmVkaXJwYXJz
ZXJfZG9fcmVhZChjaC0+cGFyc2VyKTsKPiArICAgICAgICByZXR1cm4gdXNicmVkaXJwYXJzZXJf
ZG9fcmVhZChjaC0+cGFyc2VyKTsKPiArICAgIH0KPiArICAgIGlmIChjaC0+c3RhdGUgPT0gVVNC
X0NIQU5ORUxfU1RBVEVfSE9TVCkgewo+ICsgICAgICAgIHJlcyA9IHVzYnJlZGlyaG9zdF9yZWFk
X2d1ZXN0X2RhdGEoY2gtPnVzYnJlZGlyaG9zdCk7Cj4gICAgICAgfSBlbHNlIHsKPiAtICAgICAg
ICByZXMgPSBVU0JfUkVESVJfRVJST1JfSU87Cj4gKyAgICAgICAgcmVzID0gdXNicmVkaXJwYXJz
ZXJfZG9fcmVhZChjaC0+cGFyc2VyKTsKPiAgICAgICB9Cj4gICAgICAgc3dpdGNoIChyZXMpCj4g
ICAgICAgewo+IEBAIC03ODMsMTQgKzgwNywxMiBAQCBHRXJyb3IgKnNwaWNlX3VzYl9iYWNrZW5k
X2dldF9lcnJvcl9kZXRhaWxzKGludCBlcnJvcl9jb2RlLCBnY2hhciAqZGVzYykKPiAgIAo+ICAg
dm9pZCBzcGljZV91c2JfYmFja2VuZF9yZXR1cm5fd3JpdGVfZGF0YShTcGljZVVzYkJhY2tlbmRD
aGFubmVsICpjaCwgdm9pZCAqZGF0YSkKPiAgIHsKPiAtICAgIGlmIChjaC0+dXNicmVkaXJob3N0
KSB7Cj4gKyAgICBpZiAoY2gtPnN0YXRlID09IFVTQl9DSEFOTkVMX1NUQVRFX0hPU1QpIHsKPiAg
ICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIC0+IHVzYnJlZGlyaG9zdCIsIF9fRlVOQ1RJ
T05fXywgY2gpOwo+ICAgICAgICAgICB1c2JyZWRpcmhvc3RfZnJlZV93cml0ZV9idWZmZXIoY2gt
PnVzYnJlZGlyaG9zdCwgZGF0YSk7Cj4gLSAgICB9IGVsc2UgaWYgKGNoLT5wYXJzZXIpIHsKPiAr
ICAgIH0gZWxzZSB7Cj4gICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAtPiBwYXJzZXIi
LCBfX0ZVTkNUSU9OX18sIGNoKTsKPiAgICAgICAgICAgdXNicmVkaXJwYXJzZXJfZnJlZV93cml0
ZV9idWZmZXIoY2gtPnBhcnNlciwgZGF0YSk7Cj4gLSAgICB9IGVsc2Ugewo+IC0gICAgICAgIFNQ
SUNFX0RFQlVHKCIlcyBjaCAlcCAtIE5PQk9EWSBUTyBDQUxMIiwgX19GVU5DVElPTl9fLCBjaCk7
Cj4gICAgICAgfQo+ICAgfQo+ICAgCj4gQEAgLTEwMDUsMTAgKzEwMjcsMTAgQEAgc3RhdGljIHZv
aWQgdXNicmVkaXJfZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrKHZvaWQgKnByaXYpCj4gICB7Cj4gICAg
ICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2Owo+ICAgICAgIFNQSUNFX0RFQlVH
KCIlcyBjaCAlcCIsIF9fRlVOQ1RJT05fXywgY2gpOwo+IC0gICAgaWYgKGNoLT5wYXJzZXIgJiYg
Y2gtPndhaXRfZGlzY29ubmVjdF9hY2spIHsKPiAtICAgICAgICBjaC0+cGFyc2VyID0gTlVMTDsK
PiArICAgIGlmIChjaC0+c3RhdGUgPT0gVVNCX0NIQU5ORUxfU1RBVEVfUEFSU0VSICYmIGNoLT51
c2JyZWRpcmhvc3QgIT0gTlVMTCAmJgo+ICsgICAgICAgIGNoLT53YWl0X2Rpc2Nvbm5lY3RfYWNr
KSB7Cj4gKyAgICAgICAgY2gtPnN0YXRlID0gVVNCX0NIQU5ORUxfU1RBVEVfSE9TVDsKPiAgICAg
ICAgICAgU1BJQ0VfREVCVUcoIiVzIHN3aXRjaCB0byB1c2JyZWRpcmhvc3QiLCBfX0ZVTkNUSU9O
X18pOwo+IC0gICAgICAgIGNoLT51c2JyZWRpcmhvc3QgPSBjaC0+aGlkZGVuX2hvc3Q7Cj4gICAg
ICAgfQo+ICAgICAgIGNoLT53YWl0X2Rpc2Nvbm5lY3RfYWNrID0gMDsKPiAgIH0KPiBAQCAtMTAy
Nyw5ICsxMDQ5LDYgQEAgdXNicmVkaXJfaGVsbG8odm9pZCAqcHJpdiwgc3RydWN0IHVzYl9yZWRp
cl9oZWxsb19oZWFkZXIgKmhlbGxvKQo+ICAgICAgIFNQSUNFX0RFQlVHKCIlcyAlcCAlc2F0dGFj
aGVkICVzIiwgX19GVU5DVElPTl9fLCBjaCwKPiAgICAgICAgICAgZWRldiA/ICIiIDogIm5vdCAi
LCAgaGVsbG8gPyAiIiA6ICIoaW50ZXJuYWwpIik7Cj4gICAKPiAtICAgIGlmIChoZWxsbykgewo+
IC0gICAgICAgIGNoLT5oZWxsb19kb25lX3BhcnNlciA9IDE7Cj4gLSAgICB9Cj4gICAgICAgaWYg
KCFlZGV2KSB7Cj4gICAgICAgICAgIHJldHVybjsKPiAgICAgICB9Cj4gQEAgLTEwNzksNTMgKzEw
OTgsMjQgQEAgdXNicmVkaXJfaGVsbG8odm9pZCAqcHJpdiwgc3RydWN0IHVzYl9yZWRpcl9oZWxs
b19oZWFkZXIgKmhlbGxvKQo+ICAgICAgIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrKGNo
KTsKPiAgIH0KPiAgIAo+IC1zdGF0aWMgdm9pZCBpbml0aWFsaXplX3BhcnNlcihTcGljZVVzYkJh
Y2tlbmRDaGFubmVsICpjaCwgZ2Jvb2xlYW4gZG9faGVsbG8pCj4gK3N0YXRpYyB2b2lkIGluaXRp
YWxpemVfcGFyc2VyKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoKQo+ICAgewo+ICAgICAgIHVp
bnQzMl90IGZsYWdzLCBjYXBzW1VTQl9SRURJUl9DQVBTX1NJWkVdID0geyAwIH07Cj4gICAKPiAt
ICAgIGdfcmV0dXJuX2lmX2ZhaWwoY2gtPmhpZGRlbl9wYXJzZXIgIT0gTlVMTCk7Cj4gLSAgICBp
ZiAoY2gtPnBhcnNlcl9pbml0X2RvbmUpIHsKPiAtICAgICAgICBpZiAoY2gtPnBhcnNlcl93aXRo
X2hlbGxvICE9IGRvX2hlbGxvKSB7Cj4gLSAgICAgICAgICAgIGdfcmV0dXJuX2lmX3JlYWNoZWQo
KTsKPiAtICAgICAgICB9Cj4gLSAgICAgICAgcmV0dXJuOwo+IC0gICAgfQo+ICsgICAgZ19hc3Nl
cnQoY2gtPnVzYnJlZGlyaG9zdCA9PSBOVUxMKTsKPiAgIAo+IC0gICAgY2gtPnBhcnNlcl9pbml0
X2RvbmUgPSAxOwo+IC0gICAgY2gtPnBhcnNlcl93aXRoX2hlbGxvID0gZG9faGVsbG87Cj4gICAg
ICAgZmxhZ3MgPSB1c2JyZWRpcnBhcnNlcl9mbF93cml0ZV9jYl9vd25zX2J1ZmZlciB8IHVzYnJl
ZGlycGFyc2VyX2ZsX3VzYl9ob3N0Owo+ICAgCj4gLSAgICBpZiAoZG9faGVsbG8pIHsKPiAtICAg
ICAgICBjaC0+aGVsbG9fc2VudCA9IDE7Cj4gLSAgICAgICAgY2gtPmhvc3RfY2FwcyB8PSAxIDw8
IHVzYl9yZWRpcl9jYXBfY29ubmVjdF9kZXZpY2VfdmVyc2lvbjsKPiAtICAgICAgICBjaC0+aG9z
dF9jYXBzIHw9IDEgPDwgdXNiX3JlZGlyX2NhcF9kZXZpY2VfZGlzY29ubmVjdF9hY2s7Cj4gLSAg
ICAgICAgY2gtPmhvc3RfY2FwcyB8PSAxIDw8IHVzYl9yZWRpcl9jYXBfZXBfaW5mb19tYXhfcGFj
a2V0X3NpemU7Cj4gLSAgICAgICAgY2gtPmhvc3RfY2FwcyB8PSAxIDw8IHVzYl9yZWRpcl9jYXBf
NjRiaXRzX2lkczsKPiAtICAgICAgICBjaC0+aG9zdF9jYXBzIHw9IDEgPDwgdXNiX3JlZGlyX2Nh
cF8zMmJpdHNfYnVsa19sZW5ndGg7Cj4gLSAgICB9IGVsc2Ugewo+IC0gICAgICAgIGZsYWdzIHw9
IHVzYnJlZGlycGFyc2VyX2ZsX25vX2hlbGxvOwo+IC0gICAgfQo+IC0KPiAtICAgIGlmIChjaC0+
aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF9jb25uZWN0X2RldmljZV92ZXJzaW9uKSkg
ewo+IC0gICAgICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJf
Y2FwX2Nvbm5lY3RfZGV2aWNlX3ZlcnNpb24pOwo+IC0gICAgfQo+ICsgICAgdXNicmVkaXJwYXJz
ZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfY29ubmVjdF9kZXZpY2VfdmVyc2lv
bik7Cj4gICAgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9j
YXBfZmlsdGVyKTsKPiAtICAgIGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2Nh
cF9kZXZpY2VfZGlzY29ubmVjdF9hY2spKSB7Cj4gLSAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fw
c19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrKTsKPiAt
ICAgIH0KPiAtICAgIGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF9lcF9p
bmZvX21heF9wYWNrZXRfc2l6ZSkpIHsKPiAtICAgICAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3Nl
dF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF9lcF9pbmZvX21heF9wYWNrZXRfc2l6ZSk7Cj4gLSAg
ICB9Cj4gLSAgICBpZiAoY2gtPmhvc3RfY2FwcyAmICgxIDw8IHVzYl9yZWRpcl9jYXBfNjRiaXRz
X2lkcykpIHsKPiAtICAgICAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNi
X3JlZGlyX2NhcF82NGJpdHNfaWRzKTsKPiAtICAgIH0KPiAtICAgIGlmIChjaC0+aG9zdF9jYXBz
ICYgKDEgPDwgdXNiX3JlZGlyX2NhcF8zMmJpdHNfYnVsa19sZW5ndGgpKSB7Cj4gLSAgICAgICAg
dXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfMzJiaXRzX2J1
bGtfbGVuZ3RoKTsKPiAtICAgIH0KPiAtICAgIGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNi
X3JlZGlyX2NhcF9idWxrX3N0cmVhbXMpKSB7Cj4gLSAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fw
c19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfYnVsa19zdHJlYW1zKTsKPiAtICAgIH0KPiAt
ICAgIHVzYnJlZGlycGFyc2VyX2luaXQoY2gtPmhpZGRlbl9wYXJzZXIsIFBBQ0tBR0VfU1RSSU5H
LCBjYXBzLCBVU0JfUkVESVJfQ0FQU19TSVpFLCBmbGFncyk7Cj4gKyAgICB1c2JyZWRpcnBhcnNl
cl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF9kZXZpY2VfZGlzY29ubmVjdF9hY2sp
Owo+ICsgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBf
ZXBfaW5mb19tYXhfcGFja2V0X3NpemUpOwo+ICsgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRf
Y2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfNjRiaXRzX2lkcyk7Cj4gKyAgICB1c2JyZWRpcnBhcnNl
cl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF8zMmJpdHNfYnVsa19sZW5ndGgpOwo+
ICsgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfYnVs
a19yZWNlaXZpbmcpOwo+ICsgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVz
Yl9yZWRpcl9jYXBfYnVsa19zdHJlYW1zKTsKPiArCj4gKyAgICB1c2JyZWRpcnBhcnNlcl9pbml0
KGNoLT5wYXJzZXIsIFBBQ0tBR0VfU1RSSU5HLCBjYXBzLCBVU0JfUkVESVJfQ0FQU19TSVpFLCBm
bGFncyk7Cj4gICB9Cj4gICAKPiAgIC8qCj4gQEAgLTExODAsNyArMTE3MCw3IEBAIHN0YXRpYyBn
Ym9vbGVhbiBhdHRhY2hfZWRldihTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwKPiAgICAgICAg
ICAgICAgXygiRmFpbGVkIHRvIHJlZGlyZWN0IGRldmljZSAlZCIpLCAxKTsKPiAgICAgICAgICAg
cmV0dXJuIEZBTFNFOwo+ICAgICAgIH0KPiAtICAgIGlmIChjaC0+dXNicmVkaXJob3N0ICYmICFj
aC0+aGVsbG9fZG9uZV9wYXJzZXIpIHsKPiArICAgIGlmIChjaC0+c3RhdGUgPT0gVVNCX0NIQU5O
RUxfU1RBVEVfSU5JVElBTElaSU5HKSB7Cj4gICAgICAgICAgIC8qCj4gICAgICAgICAgICAgICB3
ZSBjYW4ndCBpbml0aWFsaXplIHBhcnNlciB1bnRpbCB3ZSBzZWUgaGVsbG8gZnJvbSB1c2JyZWRp
cgo+ICAgICAgICAgICAgICAgYW5kIHRoZSBwYXJzZXIgY2FuJ3Qgd29yayB1bnRpbCBpdCBzZWVz
IHRoZSBoZWxsbyByZXNwb25zZS4KPiBAQCAtMTE5MCwxNSArMTE4MCwxMyBAQCBzdGF0aWMgZ2Jv
b2xlYW4gYXR0YWNoX2VkZXYoU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsCj4gICAgICAgICAg
IFNQSUNFX0RFQlVHKCIlcyB3YWl0aW5nIHVudGlsIHRoZSBjaGFubmVsIGlzIHJlYWR5IiwgX19G
VU5DVElPTl9fKTsKPiAgIAo+ICAgICAgIH0gZWxzZSB7Cj4gLSAgICAgICAgaW5pdGlhbGl6ZV9w
YXJzZXIoY2gsIGNoLT5oaWRkZW5faG9zdCA9PSBOVUxMKTsKPiAtICAgICAgICBjaC0+dXNicmVk
aXJob3N0ID0gTlVMTDsKPiAtICAgICAgICBjaC0+cGFyc2VyID0gY2gtPmhpZGRlbl9wYXJzZXI7
Cj4gKyAgICAgICAgY2gtPnN0YXRlID0gVVNCX0NIQU5ORUxfU1RBVEVfUEFSU0VSOwo+ICAgICAg
IH0KPiAgICAgICBjaC0+d2FpdF9kaXNjb25uZWN0X2FjayA9IDA7Cj4gICAgICAgY2gtPmF0dGFj
aGVkID0gZGV2Owo+ICAgICAgIGRldi0+YXR0YWNoZWRfdG8gPSBjaDsKPiAtICAgIGRldmljZV9v
cHMoZGV2LT5lZGV2KS0+YXR0YWNoKGRldi0+ZWRldiwgY2gtPmhpZGRlbl9wYXJzZXIpOwo+IC0g
ICAgaWYgKGNoLT5oZWxsb19kb25lX3BhcnNlcikgewo+ICsgICAgZGV2aWNlX29wcyhkZXYtPmVk
ZXYpLT5hdHRhY2goZGV2LT5lZGV2LCBjaC0+cGFyc2VyKTsKPiArICAgIGlmIChjaC0+c3RhdGUg
PT0gVVNCX0NIQU5ORUxfU1RBVEVfUEFSU0VSKSB7Cj4gICAgICAgICAgIC8qIHNlbmQgZGV2aWNl
IGluZm8gKi8KPiAgICAgICAgICAgdXNicmVkaXJfaGVsbG8oY2gsIE5VTEwpOwo+ICAgICAgIH0K
PiBAQCAtMTIxOCw5ICsxMjA2LDE1IEBAIGdib29sZWFuIHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5u
ZWxfYXR0YWNoKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLAo+ICAgICAgICAgICByZXR1cm4g
YXR0YWNoX2VkZXYoY2gsIGRldiwgZXJyb3IpOwo+ICAgICAgIH0KPiAgIAo+ICsgICAgLy8gbm8g
cGh5c2ljYWwgZGV2aWNlIGVuYWJsZWQKPiArICAgIGlmIChjaC0+dXNicmVkaXJob3N0ID09IE5V
TEwpIHsKPiArICAgICAgICByZXR1cm4gRkFMU0U7Cj4gKyAgICB9Cj4gKwo+ICAgICAgIGxpYnVz
Yl9kZXZpY2VfaGFuZGxlICpoYW5kbGUgPSBOVUxMOwo+IC0gICAgY2gtPnVzYnJlZGlyaG9zdCA9
IGNoLT5oaWRkZW5faG9zdDsKPiAtICAgIGNoLT5wYXJzZXIgPSBOVUxMOwo+ICsgICAgaWYgKGNo
LT5zdGF0ZSAhPSBVU0JfQ0hBTk5FTF9TVEFURV9JTklUSUFMSVpJTkcpIHsKPiArICAgICAgICBj
aC0+c3RhdGUgPSBVU0JfQ0hBTk5FTF9TVEFURV9IT1NUOwo+ICsgICAgfQo+ICAgCj4gICAgICAg
LyoKPiAgICAgICAgICBVbmRlciBXaW5kb3dzIHdlIG5lZWQgdG8gYXZvaWQgdXBkYXRpbmcKPiBA
QCAtMTI2MSwxMCArMTI1NSwxMCBAQCB2b2lkIHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfZGV0
YWNoKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoKQo+ICAgICAgICAgICBTUElDRV9ERUJVRygi
JXM6IG5vdGhpbmcgdG8gZGV0YWNoIiwgX19GVU5DVElPTl9fKTsKPiAgICAgICAgICAgcmV0dXJu
Owo+ICAgICAgIH0KPiAtICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7Cj4gKyAgICBpZiAoY2gt
PnN0YXRlID09IFVTQl9DSEFOTkVMX1NUQVRFX0hPU1QpIHsKPiAgICAgICAgICAgLyogaXQgd2ls
bCBjYWxsIGxpYnVzYl9jbG9zZSBpbnRlcm5hbGx5ICovCj4gICAgICAgICAgIHVzYnJlZGlyaG9z
dF9zZXRfZGV2aWNlKGNoLT51c2JyZWRpcmhvc3QsIE5VTEwpOwo+IC0gICAgfSBlbHNlIGlmIChj
aC0+cGFyc2VyKSB7Cj4gKyAgICB9IGVsc2Ugewo+ICAgICAgICAgICBpZiAoZWRldikgewo+ICAg
ICAgICAgICAgICAgZGV2aWNlX29wcyhlZGV2KS0+ZGV0YWNoKGVkZXYpOwo+ICAgICAgICAgICB9
Cj4gQEAgLTEyNzIsOSArMTI2Niw4IEBAIHZvaWQgc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9k
ZXRhY2goU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gpCj4gICAgICAgICAgIHVzYnJlZGlyX3dy
aXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsKPiAgICAgICAgICAgY2gtPndhaXRfZGlzY29ubmVjdF9h
Y2sgPQo+ICAgICAgICAgICAgICAgdXNicmVkaXJwYXJzZXJfcGVlcl9oYXNfY2FwKGNoLT5wYXJz
ZXIsIHVzYl9yZWRpcl9jYXBfZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrKTsKPiAtICAgICAgICBpZiAo
IWNoLT53YWl0X2Rpc2Nvbm5lY3RfYWNrKSB7Cj4gLSAgICAgICAgICAgIGNoLT51c2JyZWRpcmhv
c3QgPSBjaC0+aGlkZGVuX2hvc3Q7Cj4gLSAgICAgICAgICAgIGNoLT5wYXJzZXIgPSBOVUxMOwo+
ICsgICAgICAgIGlmICghY2gtPndhaXRfZGlzY29ubmVjdF9hY2sgJiYgY2gtPnVzYnJlZGlyaG9z
dCAhPSBOVUxMKSB7Cj4gKyAgICAgICAgICAgIGNoLT5zdGF0ZSA9IFVTQl9DSEFOTkVMX1NUQVRF
X0hPU1Q7Cj4gICAgICAgICAgIH0KPiAgICAgICB9Cj4gICAgICAgU1BJQ0VfREVCVUcoIiVzIGNo
ICVwLCBkZXRhY2ggZG9uZSIsIF9fRlVOQ1RJT05fXywgY2gpOwo+IEBAIC0xMzExLDE2ICsxMzA0
LDIyIEBAIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKnNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxf
bmV3KFNwaWNlVXNiQmFja2VuZCAqYmUsCj4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgdXNicmVkaXJwYXJzZXJfd2FybmluZywKPiAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgdXNicmVkaXJob3N0X2ZsX3dyaXRlX2NiX293bnNfYnVmZmVyKTsK
PiAgICAgICAgICAgZ193YXJuX2lmX2ZhaWwoY2gtPnVzYnJlZGlyaG9zdCAhPSBOVUxMKTsKPiAr
ICAgICAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCAhPSBOVUxMKSB7Cj4gKyAgICAgICAgICAgIHVz
YnJlZGlyaG9zdF9zZXRfYnVmZmVyZWRfb3V0cHV0X3NpemVfY2IoY2gtPnVzYnJlZGlyaG9zdCwK
PiArICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1
c2JyZWRpcl9idWZmZXJlZF9vdXRwdXRfc2l6ZV9jYWxsYmFjayk7Cj4gKyAgICAgICAgICAgIC8v
IGZvcmNlIGZsdXNoIG9mIEhFTExPIHBhY2tldCBhbmQgY3JlYXRpb24gb2YgcGFyc2VyCj4gKyAg
ICAgICAgICAgIHVzYnJlZGlyaG9zdF93cml0ZV9ndWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3Qp
Owo+ICsgICAgICAgIH0KPiArICAgIH0gZWxzZSB7Cj4gKyAgICAgICAgLy8gbm8gcGh5c2ljYWwg
ZGV2aWNlIHN1cHBvcnQsIG9ubHkgZW11bGF0ZWQsIGNyZWF0ZSB0aGUKPiArICAgICAgICAvLyBw
YXJzZXIKPiArICAgICAgICBjaC0+cGFyc2VyID0gY3JlYXRlX3BhcnNlcihjaCk7Cj4gKyAgICAg
ICAgaWYgKGNoLT5wYXJzZXIgIT0gTlVMTCkgewo+ICsgICAgICAgICAgICBpbml0aWFsaXplX3Bh
cnNlcihjaCk7Cj4gKyAgICAgICAgfQo+ICAgICAgIH0KPiAgIAo+IC0gICAgaWYgKGNoLT51c2Jy
ZWRpcmhvc3QpIHsKPiAtICAgICAgICBjaC0+aGlkZGVuX3BhcnNlciA9IGNyZWF0ZV9wYXJzZXIo
Y2gpOwo+IC0gICAgICAgIGNoLT5oaWRkZW5faG9zdCA9IGNoLT51c2JyZWRpcmhvc3Q7Cj4gLSAg
ICAgICAgdXNicmVkaXJob3N0X3NldF9idWZmZXJlZF9vdXRwdXRfc2l6ZV9jYihjaC0+dXNicmVk
aXJob3N0LAo+IC0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgdXNicmVkaXJfYnVmZmVyZWRfb3V0cHV0X3NpemVfY2FsbGJhY2spOwo+IC0gICAgfQo+IC0K
PiAtICAgIGlmICghY2gtPmhpZGRlbl9wYXJzZXIpIHsKPiArICAgIGlmICghY2gtPnBhcnNlcikg
ewo+ICAgICAgICAgICBzcGljZV91c2JfYmFja2VuZF9jaGFubmVsX2RlbGV0ZShjaCk7Cj4gICAg
ICAgICAgIGNoID0gTlVMTDsKPiAgICAgICB9Cj4gQEAgLTEzMzIsMTIgKzEzMzEsOSBAQCBTcGlj
ZVVzYkJhY2tlbmRDaGFubmVsICpzcGljZV91c2JfYmFja2VuZF9jaGFubmVsX25ldyhTcGljZVVz
YkJhY2tlbmQgKmJlLAo+ICAgdm9pZCBzcGljZV91c2JfYmFja2VuZF9jaGFubmVsX2ZsdXNoX3dy
aXRlcyhTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCkKPiAgIHsKPiAgICAgICBTUElDRV9ERUJV
RygiJXMgJXAgaXMgdXAiLCBfX0ZVTkNUSU9OX18sIGNoKTsKPiAtICAgIGlmIChjaC0+dXNicmVk
aXJob3N0KSB7Cj4gKyAgICBpZiAoY2gtPnN0YXRlICE9IFVTQl9DSEFOTkVMX1NUQVRFX1BBUlNF
UiAmJiBjaC0+dXNicmVkaXJob3N0ICE9IE5VTEwpIHsKPiAgICAgICAgICAgdXNicmVkaXJob3N0
X3dyaXRlX2d1ZXN0X2RhdGEoY2gtPnVzYnJlZGlyaG9zdCk7Cj4gLSAgICAgICAgaW5pdGlhbGl6
ZV9wYXJzZXIoY2gsIEZBTFNFKTsKPiAgICAgICB9IGVsc2Ugewo+IC0gICAgICAgIGluaXRpYWxp
emVfcGFyc2VyKGNoLCBUUlVFKTsKPiAtICAgICAgICBjaC0+cGFyc2VyID0gY2gtPmhpZGRlbl9w
YXJzZXI7Cj4gICAgICAgICAgIHVzYnJlZGlycGFyc2VyX2RvX3dyaXRlKGNoLT5wYXJzZXIpOwo+
ICAgICAgIH0KPiAgIH0KPiBAQCAtMTM0OCwxMSArMTM0NCwxMSBAQCB2b2lkIHNwaWNlX3VzYl9i
YWNrZW5kX2NoYW5uZWxfZGVsZXRlKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoKQo+ICAgICAg
IGlmICghY2gpIHsKPiAgICAgICAgICAgcmV0dXJuOwo+ICAgICAgIH0KPiAtICAgIGlmIChjaC0+
aGlkZGVuX2hvc3QpIHsKPiAtICAgICAgICB1c2JyZWRpcmhvc3RfY2xvc2UoY2gtPmhpZGRlbl9o
b3N0KTsKPiArICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7Cj4gKyAgICAgICAgdXNicmVkaXJo
b3N0X2Nsb3NlKGNoLT51c2JyZWRpcmhvc3QpOwo+ICAgICAgIH0KPiAtICAgIGlmIChjaC0+aGlk
ZGVuX3BhcnNlcikgewo+IC0gICAgICAgIHVzYnJlZGlycGFyc2VyX2Rlc3Ryb3koY2gtPmhpZGRl
bl9wYXJzZXIpOwo+ICsgICAgaWYgKGNoLT5wYXJzZXIpIHsKPiArICAgICAgICB1c2JyZWRpcnBh
cnNlcl9kZXN0cm95KGNoLT5wYXJzZXIpOwo+ICAgICAgIH0KPiAgIAo+ICAgICAgIGlmIChjaC0+
cnVsZXMpIHsKPiBAQCAtMTM3Miw3ICsxMzY4LDcgQEAgc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5l
bF9nZXRfZ3Vlc3RfZmlsdGVyKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLAo+ICAgICAgIGlu
dCBpOwo+ICAgICAgICpyID0gTlVMTDsKPiAgICAgICAqY291bnQgPSAwOwo+IC0gICAgaWYgKGNo
LT51c2JyZWRpcmhvc3QpIHsKPiArICAgIGlmIChjaC0+dXNicmVkaXJob3N0ICE9IE5VTEwpIHsK
PiAgICAgICAgICAgdXNicmVkaXJob3N0X2dldF9ndWVzdF9maWx0ZXIoY2gtPnVzYnJlZGlyaG9z
dCwgciwgY291bnQpOwo+ICAgICAgIH0KPiAgICAgICBpZiAoKnIgPT0gTlVMTCkgewo+IAoKX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KU3BpY2UtZGV2ZWwg
bWFpbGluZyBsaXN0ClNwaWNlLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xp
c3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL3NwaWNlLWRldmVs
