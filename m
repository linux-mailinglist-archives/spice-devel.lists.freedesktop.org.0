Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id 45C947A77A
	for <lists+spice-devel@lfdr.de>; Tue, 30 Jul 2019 14:04:02 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 9F03C6E4D4;
	Tue, 30 Jul 2019 12:04:00 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 6864D6E4CE
 for <spice-devel@lists.freedesktop.org>; Tue, 30 Jul 2019 12:03:59 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx05.intmail.prod.int.phx2.redhat.com
 [10.5.11.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 0B5BD30860C9;
 Tue, 30 Jul 2019 12:03:59 +0000 (UTC)
Received: from fziglio.remote.csb (unknown [10.33.32.10])
 by smtp.corp.redhat.com (Postfix) with ESMTP id 95EB35D6B0;
 Tue, 30 Jul 2019 12:03:57 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Tue, 30 Jul 2019 13:03:03 +0100
Message-Id: <20190730120331.17967-15-fziglio@redhat.com>
In-Reply-To: <20190730120331.17967-1-fziglio@redhat.com>
References: <20190730120331.17967-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.15
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.44]); Tue, 30 Jul 2019 12:03:59 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-gtk 14/44] usb-redir: extend USB backend
 to support emulated devices
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

RnJvbTogWXVyaSBCZW5kaXRvdmljaCA8eXVyaS5iZW5kaXRvdmljaEBkYXluaXguY29tPgoKUmVk
aXJlY3Rpb24gb2YgZW11bGF0ZWQgZGV2aWNlcyByZXF1aXJlcyBzcGVjaWFsIGFwcHJvYWNoLAph
cyB1c2JyZWRpcmhvc3QgY2FuJ3QgYmUgdXNlZCBmb3IgdGhhdCAoaXQgd29ya3Mgb25seSB3aXRo
CmxpYnVzYiBkZXZpY2VzKS4gRm9yIGVtdWxhdGVkIGRldmljZXMgd2UgY3JlYXRlIGluc3RhbmNl
IG9mCnVzYnJlZGlycGFyc2VyIHRoYXQgaW1wbGVtZW50cyBVU0IgcmVkaXJlY3Rpb24gcHJvdG9j
b2wuCkluIG9yZGVyIHRvIHdvcmsgd2l0aCB0aGUgc2FtZSBzZXQgb2YgcHJvdG9jb2wgY2FwYWJp
bGl0aWVzCnRoYXQgdXNicmVkaXJob3N0IHNldHMgdXAgd2l0aCByZW1vdGUgc2lkZSwgdGhlIHBh
cnNlciBzaGFsbDoKLSBub3Qgc2VuZCBpdHMgb3duICdoZWxsbycgdG8gdGhlIHNlcnZlcgotIGlu
aXRpYWxpemUgdGhlIHNhbWUgY2FwYWJpbGl0aWVzIHRoYXQgdXNicmVkaXJob3N0Ci0gcmVjZWl2
ZSB0aGUgc2FtZSAnaGVsbG8nIHJlc3BvbnNlCkZvciB0aGF0IHdlIGFuYWx5emUgJ2hlbGxvJyBz
ZW50IGJ5IFVTQiByZWRpciBwYXJzZXIgYW5kCmV4dHJhY3Qgc2V0IG9mIGNhcGFiaWxpdGllcyBm
cm9tIGl0IGFuZCB1cG9uIHJlY2VpdmUgb2YKJ2hlbGxvJyByZXNwb25zZSB3ZSBwcm92aWRlIGl0
IGFsc28gdG8gdGhlIHBhcnNlci4KV2hlbiBsaWJ1c2IgZGV2aWNlIGlzIHJlZGlyZWN0ZWQgdmlh
IGEgY2hhbm5lbCwgaW5zdGFuY2Ugb2YKdXNicmVkaXJob3N0IHNlcnZlcyBpdC4KV2hlbiBlbXVs
YXRlZCBkZXZpY2UgaXMgcmVkaXJlY3RlZCB2aWEgYSBjaGFubmVsLCBpbnN0YW5jZQpvZiB1c2Jy
ZWRpcnBhcnNlciBkb2VzIHRoZSBqb2IuCgpTaWduZWQtb2ZmLWJ5OiBZdXJpIEJlbmRpdG92aWNo
IDx5dXJpLmJlbmRpdG92aWNoQGRheW5peC5jb20+Ci0tLQogc3JjL3VzYi1iYWNrZW5kLmMgfCA1
ODUgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKystLQogMSBmaWxl
IGNoYW5nZWQsIDU2OCBpbnNlcnRpb25zKCspLCAxNyBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQg
YS9zcmMvdXNiLWJhY2tlbmQuYyBiL3NyYy91c2ItYmFja2VuZC5jCmluZGV4IDlhZGZkMTI1Li5j
ZjFhZTJiOCAxMDA2NDQKLS0tIGEvc3JjL3VzYi1iYWNrZW5kLmMKKysrIGIvc3JjL3VzYi1iYWNr
ZW5kLmMKQEAgLTU1LDYgKzU1LDcgQEAgc3RydWN0IF9TcGljZVVzYkJhY2tlbmREZXZpY2UKICAg
ICBnaW50IHJlZl9jb3VudDsKICAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICphdHRhY2hlZF90
bzsKICAgICBVc2JEZXZpY2VJbmZvcm1hdGlvbiBkZXZpY2VfaW5mbzsKKyAgICBnYm9vbGVhbiBl
ZGV2X2NvbmZpZ3VyZWQ7CiB9OwogCiBzdHJ1Y3QgX1NwaWNlVXNiQmFja2VuZApAQCAtODAsMTAg
KzgxLDIwIEBAIHN0cnVjdCBfU3BpY2VVc2JCYWNrZW5kCiBzdHJ1Y3QgX1NwaWNlVXNiQmFja2Vu
ZENoYW5uZWwKIHsKICAgICBzdHJ1Y3QgdXNicmVkaXJob3N0ICp1c2JyZWRpcmhvc3Q7CisgICAg
c3RydWN0IHVzYnJlZGlyaG9zdCAqaGlkZGVuX2hvc3Q7CisgICAgc3RydWN0IHVzYnJlZGlycGFy
c2VyICpwYXJzZXI7CisgICAgc3RydWN0IHVzYnJlZGlycGFyc2VyICpoaWRkZW5fcGFyc2VyOwog
ICAgIHVpbnQ4X3QgKnJlYWRfYnVmOwogICAgIGludCByZWFkX2J1Zl9zaXplOwogICAgIHN0cnVj
dCB1c2JyZWRpcmZpbHRlcl9ydWxlICpydWxlczsKICAgICBpbnQgcnVsZXNfY291bnQ7CisgICAg
dWludDMyX3QgaG9zdF9jYXBzOworICAgIHVpbnQzMl90IHBhcnNlcl9pbml0X2RvbmUgIDogMTsK
KyAgICB1aW50MzJfdCBwYXJzZXJfd2l0aF9oZWxsbyA6IDE7CisgICAgdWludDMyX3QgaGVsbG9f
ZG9uZV9wYXJzZXIgOiAxOworICAgIHVpbnQzMl90IGhlbGxvX3NlbnQgICAgICAgIDogMTsKKyAg
ICB1aW50MzJfdCByZWplY3RlZCAgICAgICAgICA6IDE7CisgICAgdWludDMyX3Qgd2FpdF9kaXNj
X2FjayAgICAgOiAxOwogICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqYXR0YWNoZWQ7CiAgICAg
U3BpY2VVc2JyZWRpckNoYW5uZWwgICp1c2VyX2RhdGE7CiAgICAgU3BpY2VVc2JCYWNrZW5kICpi
YWNrZW5kOwpAQCAtMzU1LDcgKzM2NiwxMSBAQCBnYm9vbGVhbiBzcGljZV91c2JfYmFja2VuZF9k
ZXZpY2VfaXNvY2goU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkZXYpCiAgICAgZ2ludCBpLCBqLCBr
OwogICAgIGludCByYzsKIAotICAgIGdfcmV0dXJuX3ZhbF9pZl9mYWlsKGxpYmRldiAhPSBOVUxM
LCAwKTsKKyAgICBnX3JldHVybl92YWxfaWZfZmFpbChsaWJkZXYgIT0gTlVMTCB8fCBkZXYtPmVk
ZXYgIT0gTlVMTCwgMCk7CisgICAgaWYgKGRldi0+ZWRldikgeworICAgICAgICAvKiBjdXJyZW50
bHkgd2UgZG8gbm90IGVtdWxhdGUgaXNvY2ggZGV2aWNlcyAqLworICAgICAgICByZXR1cm4gRkFM
U0U7CisgICAgfQogCiAgICAgcmMgPSBsaWJ1c2JfZ2V0X2FjdGl2ZV9jb25maWdfZGVzY3JpcHRv
cihsaWJkZXYsICZjb25mX2Rlc2MpOwogICAgIGlmIChyYykgewpAQCAtMzkwLDEzICs0MDUsMTYg
QEAgZnJvbSBib3RoIHRoZSBtYWluIHRocmVhZCBhcyB3ZWxsIGFzIGZyb20gdGhlIHVzYiBldmVu
dCBoYW5kbGluZyB0aHJlYWQgKi8KIHN0YXRpYyB2b2lkIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2Nh
bGxiYWNrKHZvaWQgKnVzZXJfZGF0YSkKIHsKICAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpj
aCA9IHVzZXJfZGF0YTsKLSAgICBpZiAoIWNoLT51c2JyZWRpcmhvc3QpIHsKLSAgICAgICAgLyog
anVzdCB0byBiZSBvbiB0aGUgc2FmZSBzaWRlICovCi0gICAgICAgIHJldHVybjsKLSAgICB9CiAg
ICAgaWYgKGlzX2NoYW5uZWxfcmVhZHkoY2gtPnVzZXJfZGF0YSkpIHsKLSAgICAgICAgU1BJQ0Vf
REVCVUcoIiVzIGNoICVwIC0+IHVzYnJlZGlyaG9zdCIsIF9fRlVOQ1RJT05fXywgY2gpOwotICAg
ICAgICB1c2JyZWRpcmhvc3Rfd3JpdGVfZ3Vlc3RfZGF0YShjaC0+dXNicmVkaXJob3N0KTsKKyAg
ICAgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIl
cyBjaCAlcCAtPiB1c2JyZWRpcmhvc3QiLCBfX0ZVTkNUSU9OX18sIGNoKTsKKyAgICAgICAgICAg
IHVzYnJlZGlyaG9zdF93cml0ZV9ndWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3QpOworICAgICAg
ICB9IGVsc2UgaWYgKGNoLT5wYXJzZXIpIHsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBj
aCAlcCAtPiBwYXJzZXIiLCBfX0ZVTkNUSU9OX18sIGNoKTsKKyAgICAgICAgICAgIHVzYnJlZGly
cGFyc2VyX2RvX3dyaXRlKGNoLT5wYXJzZXIpOworICAgICAgICB9IGVsc2UgeworICAgICAgICAg
ICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIChOT1QgQUNUSVZFKSIsIF9fRlVOQ1RJT05fXywgY2gp
OworICAgICAgICB9CiAgICAgfSBlbHNlIHsKICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVw
IChub3QgcmVhZHkpIiwgX19GVU5DVElPTl9fLCBjaCk7CiAgICAgfQpAQCAtNTU0LDEzICs1NzIs
NTcgQEAgdm9pZCBzcGljZV91c2JfYmFja2VuZF9kZXZpY2VfdW5yZWYoU3BpY2VVc2JCYWNrZW5k
RGV2aWNlICpkZXYpCiAgICAgfQogfQogCitzdGF0aWMgaW50IGNoZWNrX2VkZXZfZGV2aWNlX2Zp
bHRlcihTcGljZVVzYkJhY2tlbmREZXZpY2UgKmRldiwKKyAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgIGNvbnN0IHN0cnVjdCB1c2JyZWRpcmZpbHRlcl9ydWxlICpydWxlcywKKyAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludCBjb3VudCkKK3sKKyAgICBTcGlj
ZVVzYkVtdWxhdGVkRGV2aWNlICplZGV2ID0gZGV2LT5lZGV2OworICAgIHVpbnQ4X3QgY2xzWzMy
XSwgc3ViY2xzWzMyXSwgcHJvdG9bMzJdLCAqY2ZnLCBpZm51bSA9IDA7CisgICAgdWludDE2X3Qg
c2l6ZSwgb2Zmc2V0ID0gMDsKKyAgICBpZiAoIWVkZXYpIHsKKyAgICAgICAgcmV0dXJuIDE7Cisg
ICAgfQorICAgIGlmICghZGV2aWNlX29wcyhlZGV2KS0+Z2V0X2Rlc2NyaXB0b3IoCisgICAgICAg
ICAgICBlZGV2LCBMSUJVU0JfRFRfQ09ORklHLCAwLCAodm9pZCAqKikmY2ZnLCAmc2l6ZSkpIHsK
KyAgICAgICAgcmV0dXJuIDE7CisgICAgfQorICAgIHdoaWxlICgob2Zmc2V0ICsgMSkgPCBzaXpl
KSB7CisgICAgICAgIHVpbnQ4X3QgbGVuICA9IGNmZ1tvZmZzZXRdOworICAgICAgICB1aW50OF90
IHR5cGUgPSBjZmdbb2Zmc2V0ICsgMV07CisgICAgICAgIGlmICgob2Zmc2V0ICsgbGVuKSA+IHNp
emUpIHsKKyAgICAgICAgICAgIGJyZWFrOworICAgICAgICB9CisgICAgICAgIGlmICh0eXBlID09
IExJQlVTQl9EVF9JTlRFUkZBQ0UpIHsKKyAgICAgICAgICAgIGNsc1tpZm51bV0gPSBjZmdbb2Zm
c2V0ICsgNV07CisgICAgICAgICAgICBzdWJjbHNbaWZudW1dID0gY2ZnW29mZnNldCArIDZdOwor
ICAgICAgICAgICAgcHJvdG9baWZudW1dID0gY2ZnW29mZnNldCArIDddOworICAgICAgICAgICAg
aWZudW0rKzsKKyAgICAgICAgfQorICAgICAgICBvZmZzZXQgKz0gbGVuOworICAgIH0KKworICAg
IHJldHVybiB1c2JyZWRpcmZpbHRlcl9jaGVjaygKKyAgICAgICAgcnVsZXMsIGNvdW50LAorICAg
ICAgICBkZXYtPmRldmljZV9pbmZvLmNsYXNzLAorICAgICAgICBkZXYtPmRldmljZV9pbmZvLnN1
YmNsYXNzLAorICAgICAgICBkZXYtPmRldmljZV9pbmZvLnByb3RvY29sLAorICAgICAgICBjbHMs
IHN1YmNscywgcHJvdG8sIGlmbnVtLAorICAgICAgICBkZXYtPmRldmljZV9pbmZvLnZpZCwKKyAg
ICAgICAgZGV2LT5kZXZpY2VfaW5mby5waWQsCisgICAgICAgIGRldi0+ZGV2aWNlX2luZm8uYmNk
VVNCLCAwKTsKK30KKwogaW50IHNwaWNlX3VzYl9iYWNrZW5kX2RldmljZV9jaGVja19maWx0ZXIo
CiAgICAgU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkZXYsCiAgICAgY29uc3Qgc3RydWN0IHVzYnJl
ZGlyZmlsdGVyX3J1bGUgKnJ1bGVzLAogICAgIGludCBjb3VudCkKIHsKLSAgICByZXR1cm4gdXNi
cmVkaXJob3N0X2NoZWNrX2RldmljZV9maWx0ZXIoCi0gICAgICAgIHJ1bGVzLCBjb3VudCwgZGV2
LT5saWJ1c2JfZGV2aWNlLCAwKTsKKyAgICBpZiAoZGV2LT5saWJ1c2JfZGV2aWNlKSB7CisgICAg
ICAgIHJldHVybiB1c2JyZWRpcmhvc3RfY2hlY2tfZGV2aWNlX2ZpbHRlcigKKyAgICAgICAgICAg
IHJ1bGVzLCBjb3VudCwgZGV2LT5saWJ1c2JfZGV2aWNlLCAwKTsKKyAgICB9IGVsc2UgeworICAg
ICAgICByZXR1cm4gY2hlY2tfZWRldl9kZXZpY2VfZmlsdGVyKGRldiwgcnVsZXMsIGNvdW50KTsK
KyAgICB9CiB9CiAKIHN0YXRpYyBpbnQgdXNicmVkaXJfcmVhZF9jYWxsYmFjayh2b2lkICp1c2Vy
X2RhdGEsIHVpbnQ4X3QgKmRhdGEsIGludCBjb3VudCkKQEAgLTYyNCw2ICs2ODYsMTcgQEAgc3Rh
dGljIGludCB1c2JyZWRpcl93cml0ZV9jYWxsYmFjayh2b2lkICp1c2VyX2RhdGEsIHVpbnQ4X3Qg
KmRhdGEsIGludCBjb3VudCkKICAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHVzZXJf
ZGF0YTsKICAgICBpbnQgcmVzOwogICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCwgJWQgYnl0ZXMi
LCBfX0ZVTkNUSU9OX18sIGNoLCBjb3VudCk7CisgICAgaWYgKCFjaC0+aGVsbG9fc2VudCkgewor
ICAgICAgICAvKiBoZWxsbyBpcyBzaG9ydCBoZWFkZXIgKDEyKSArIGhlbGxvIHN0cnVjdCAoNjQp
ICsgY2FwYWJpbGl0aWVzICg0KSAqLworICAgICAgICBpbnQgaGVsbG9fc2l6ZSA9IHNpemVvZihz
dHJ1Y3QgdXNiX3JlZGlyX2hlYWRlcikgKyBzaXplb2Yoc3RydWN0IHVzYl9yZWRpcl9oZWxsb19o
ZWFkZXIpOworICAgICAgICBjaC0+aGVsbG9fc2VudCA9IDE7CisgICAgICAgIGlmIChjb3VudCA9
PSBoZWxsb19zaXplKSB7CisgICAgICAgICAgICBtZW1jcHkoJmNoLT5ob3N0X2NhcHMsIGRhdGEg
KyBoZWxsb19zaXplIC0gc2l6ZW9mKGNoLT5ob3N0X2NhcHMpLAorICAgICAgICAgICAgICAgICAg
IHNpemVvZihjaC0+aG9zdF9jYXBzKSk7CisgICAgICAgICAgICBTUElDRV9ERUJVRygiJXMgY2gg
JXAsIHNlbmRpbmcgZmlyc3QgaGVsbG8sIGNhcHMgJTA4WCIsCisgICAgICAgICAgICAgICAgICAg
ICAgICBfX0ZVTkNUSU9OX18sIGNoLCBjaC0+aG9zdF9jYXBzKTsKKyAgICAgICAgfQorICAgIH0K
ICAgICByZXMgPSBzcGljZV91c2JyZWRpcl93cml0ZV9jYWxsYmFjayhjaC0+dXNlcl9kYXRhLCBk
YXRhLCBjb3VudCk7CiAgICAgcmV0dXJuIHJlczsKIH0KQEAgLTY0NCw2ICs3MTcsMjcgQEAgaW50
IHNwaWNlX3VzYl9iYWNrZW5kX3JlYWRfZ3Vlc3RfZGF0YShTcGljZVVzYkJhY2tlbmRDaGFubmVs
ICpjaCwgdWludDhfdCAqZGF0YSwKICAgICBjaC0+cmVhZF9idWZfc2l6ZSA9IGNvdW50OwogICAg
IGlmIChjaC0+dXNicmVkaXJob3N0KSB7CiAgICAgICAgIHJlcyA9IHVzYnJlZGlyaG9zdF9yZWFk
X2d1ZXN0X2RhdGEoY2gtPnVzYnJlZGlyaG9zdCk7CisgICAgICAgIGlmICghY2gtPmhlbGxvX2Rv
bmVfcGFyc2VyKSB7CisgICAgICAgICAgICBpbnQgcmVzX3BhcnNlcjsKKyAgICAgICAgICAgIC8q
IHVzYnJlZGlyaG9zdCBzaG91bGQgY29uc3VtZSBoZWxsbyByZXNwb25zZSAqLworICAgICAgICAg
ICAgZ19yZXR1cm5fdmFsX2lmX2ZhaWwoY2gtPnJlYWRfYnVmID09IE5VTEwsIFVTQl9SRURJUl9F
UlJPUl9SRUFEX1BBUlNFKTsKKworICAgICAgICAgICAgY2gtPnJlYWRfYnVmID0gZGF0YTsKKyAg
ICAgICAgICAgIGNoLT5yZWFkX2J1Zl9zaXplID0gY291bnQ7CisgICAgICAgICAgICBjaC0+aGVs
bG9fZG9uZV9wYXJzZXIgPSAxOworICAgICAgICAgICAgaWYgKGNoLT5hdHRhY2hlZCAmJiBjaC0+
YXR0YWNoZWQtPmVkZXYpIHsKKyAgICAgICAgICAgICAgICAvKiBjYXNlIG9mIENEIHNoYXJpbmcg
b24gY29ubmVjdCAqLworICAgICAgICAgICAgICAgIGNoLT51c2JyZWRpcmhvc3QgPSBOVUxMOwor
ICAgICAgICAgICAgICAgIGNoLT5wYXJzZXIgPSBjaC0+aGlkZGVuX3BhcnNlcjsKKyAgICAgICAg
ICAgICAgICBTUElDRV9ERUJVRygiJXM6IHN3aXRjaCAlcCB0byBwYXJzZXIiLCBfX0ZVTkNUSU9O
X18sIGNoKTsKKyAgICAgICAgICAgIH0KKyAgICAgICAgICAgIHJlc19wYXJzZXIgPSB1c2JyZWRp
cnBhcnNlcl9kb19yZWFkKGNoLT5oaWRkZW5fcGFyc2VyKTsKKyAgICAgICAgICAgIGlmIChyZXMg
Pj0gMCkgeworICAgICAgICAgICAgICAgIHJlcyA9IHJlc19wYXJzZXI7CisgICAgICAgICAgICB9
CisgICAgICAgIH0KKyAgICB9IGVsc2UgaWYgKGNoLT5wYXJzZXIpIHsKKyAgICAgICAgcmVzID0g
dXNicmVkaXJwYXJzZXJfZG9fcmVhZChjaC0+cGFyc2VyKTsKICAgICB9IGVsc2UgewogICAgICAg
ICByZXMgPSBVU0JfUkVESVJfRVJST1JfSU87CiAgICAgfQpAQCAtNjY0LDYgKzc1OCwxMSBAQCBp
bnQgc3BpY2VfdXNiX2JhY2tlbmRfcmVhZF9ndWVzdF9kYXRhKFNwaWNlVXNiQmFja2VuZENoYW5u
ZWwgKmNoLCB1aW50OF90ICpkYXRhLAogICAgIH0KICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAs
ICVkIGJ5dGVzLCByZXMgJWQiLCBfX0ZVTkNUSU9OX18sIGNoLCBjb3VudCwgcmVzKTsKIAorICAg
IGlmIChjaC0+cmVqZWN0ZWQpIHsKKyAgICAgICAgY2gtPnJlamVjdGVkID0gMDsKKyAgICAgICAg
cmVzID0gVVNCX1JFRElSX0VSUk9SX0RFVl9SRUpFQ1RFRDsKKyAgICB9CisKICAgICByZXR1cm4g
cmVzOwogfQogCkBAIC02OTMsMTMgKzc5Miw0MzAgQEAgR0Vycm9yICpzcGljZV91c2JfYmFja2Vu
ZF9nZXRfZXJyb3JfZGV0YWlscyhpbnQgZXJyb3JfY29kZSwgZ2NoYXIgKmRlc2MpCiB2b2lkIHNw
aWNlX3VzYl9iYWNrZW5kX3JldHVybl93cml0ZV9kYXRhKFNwaWNlVXNiQmFja2VuZENoYW5uZWwg
KmNoLCB2b2lkICpkYXRhKQogewogICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7Ci0gICAgICAg
IFNQSUNFX0RFQlVHKCIlcyBjaCAlcCIsIF9fRlVOQ1RJT05fXywgY2gpOworICAgICAgICBTUElD
RV9ERUJVRygiJXMgY2ggJXAgLT4gdXNicmVkaXJob3N0IiwgX19GVU5DVElPTl9fLCBjaCk7CiAg
ICAgICAgIHVzYnJlZGlyaG9zdF9mcmVlX3dyaXRlX2J1ZmZlcihjaC0+dXNicmVkaXJob3N0LCBk
YXRhKTsKKyAgICB9IGVsc2UgaWYgKGNoLT5wYXJzZXIpIHsKKyAgICAgICAgU1BJQ0VfREVCVUco
IiVzIGNoICVwIC0+IHBhcnNlciIsIF9fRlVOQ1RJT05fXywgY2gpOworICAgICAgICB1c2JyZWRp
cnBhcnNlcl9mcmVlX3dyaXRlX2J1ZmZlcihjaC0+cGFyc2VyLCBkYXRhKTsKICAgICB9IGVsc2Ug
ewogICAgICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAgLSBOT0JPRFkgVE8gQ0FMTCIsIF9fRlVO
Q1RJT05fXywgY2gpOwogICAgIH0KIH0KIAorc3RhdGljIHZvaWQgdXNicmVkaXJfY29udHJvbF9w
YWNrZXQodm9pZCAqcHJpdiwKKyAgICB1aW50NjRfdCBpZCwgc3RydWN0IHVzYl9yZWRpcl9jb250
cm9sX3BhY2tldF9oZWFkZXIgKmgsCisgICAgdWludDhfdCAqZGF0YSwgaW50IGRhdGFfbGVuKQor
eworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBTcGljZVVzYkJh
Y2tlbmREZXZpY2UgKmQgPSBjaC0+YXR0YWNoZWQ7CisgICAgU3BpY2VVc2JFbXVsYXRlZERldmlj
ZSAqZWRldiA9IGQgPyBkLT5lZGV2IDogTlVMTDsKKyAgICBzdHJ1Y3QgdXNiX3JlZGlyX2NvbnRy
b2xfcGFja2V0X2hlYWRlciByZXNwb25zZSA9ICpoOworICAgIHVpbnQ4X3QgcmVxdHlwZSA9IGgt
PnJlcXVlc3R0eXBlICYgMHg3ZjsKKyAgICBnYm9vbGVhbiBkb25lID0gRkFMU0U7CisgICAgdm9p
ZCAqb3V0X2J1ZmZlciA9IE5VTEw7CisKKyAgICByZXNwb25zZS5zdGF0dXMgPSB1c2JfcmVkaXJf
c3RhbGw7CisgICAgU1BJQ0VfREVCVUcoIiVzICVwOiBUUlZJTCAlMDJYICUwMlggJTA0WCAlMDRY
ICUwNFgiLAorICAgICAgICAgICAgICAgIF9fRlVOQ1RJT05fXywKKyAgICAgICAgICAgICAgICBj
aCwgaC0+cmVxdWVzdHR5cGUsIGgtPnJlcXVlc3QsCisgICAgICAgICAgICAgICAgaC0+dmFsdWUs
IGgtPmluZGV4LCBoLT5sZW5ndGgpOworCisgICAgaWYgKCFlZGV2KSB7CisgICAgICAgIFNQSUNF
X0RFQlVHKCIlczogZGV2aWNlIG5vdCBhdHRhY2hlZCIsIF9fRlVOQ1RJT05fXyk7CisgICAgICAg
IHJlc3BvbnNlLnN0YXR1cyA9IHVzYl9yZWRpcl9pb2Vycm9yOworICAgICAgICBkb25lID0gVFJV
RTsKKyAgICB9IGVsc2UgaWYgKHJlcXR5cGUgPT0gKExJQlVTQl9SRVFVRVNUX1RZUEVfU1RBTkRB
UkQgfCBMSUJVU0JfUkVDSVBJRU5UX0RFVklDRSkgJiYKKyAgICAgICAgICAgICAgIGgtPnJlcXVl
c3QgPT0gTElCVVNCX1JFUVVFU1RfR0VUX0RFU0NSSVBUT1IpIHsKKyAgICAgICAgdWludDE2X3Qg
c2l6ZTsKKyAgICAgICAgZG9uZSA9IGRldmljZV9vcHMoZWRldiktPmdldF9kZXNjcmlwdG9yKAor
ICAgICAgICAgICAgZWRldiwgaC0+dmFsdWUgPj4gOCwgaC0+dmFsdWUgJiAweGZmLAorICAgICAg
ICAgICAgJm91dF9idWZmZXIsICZzaXplKTsKKyAgICAgICAgcmVzcG9uc2UubGVuZ3RoID0gc2l6
ZTsKKyAgICAgICAgaWYgKGRvbmUpIHsKKyAgICAgICAgICAgIHJlc3BvbnNlLnN0YXR1cyA9IDA7
CisgICAgICAgIH0KKyAgICAgICAgZG9uZSA9IFRSVUU7CisgICAgfQorCisgICAgaWYgKCFkb25l
KSB7CisgICAgICAgIGRldmljZV9vcHMoZWRldiktPmNvbnRyb2xfcmVxdWVzdCgKKyAgICAgICAg
ICAgIGVkZXYsIGRhdGEsIGRhdGFfbGVuLCAmcmVzcG9uc2UsICZvdXRfYnVmZmVyKTsKKyAgICAg
ICAgZG9uZSA9IFRSVUU7CisgICAgfQorCisgICAgaWYgKHJlc3BvbnNlLnN0YXR1cykgeworICAg
ICAgICByZXNwb25zZS5sZW5ndGggPSAwOworICAgIH0gZWxzZSBpZiAocmVzcG9uc2UubGVuZ3Ro
ID4gaC0+bGVuZ3RoKSB7CisgICAgICAgIHJlc3BvbnNlLmxlbmd0aCA9IGgtPmxlbmd0aDsKKyAg
ICB9CisKKyAgICBTUElDRV9ERUJVRygiJXMgcmVzcG9uZGluZyB3aXRoIHBheWxvYWQgb2YgJTAy
WCwgc3RhdHVzICVYIiwKKyAgICAgICAgICAgICAgICBfX0ZVTkNUSU9OX18sIHJlc3BvbnNlLmxl
bmd0aCwgcmVzcG9uc2Uuc3RhdHVzKTsKKyAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2NvbnRyb2xf
cGFja2V0KAorICAgICAgICBjaC0+cGFyc2VyLCBpZCwgJnJlc3BvbnNlLAorICAgICAgICByZXNw
b25zZS5sZW5ndGggPyBvdXRfYnVmZmVyIDogTlVMTCwKKyAgICAgICAgcmVzcG9uc2UubGVuZ3Ro
KTsKKworICAgIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsKKyAgICB1c2JyZWRp
cnBhcnNlcl9mcmVlX3BhY2tldF9kYXRhKGNoLT5wYXJzZXIsIGRhdGEpOworfQorCitzdGF0aWMg
dm9pZCB1c2JyZWRpcl9idWxrX3BhY2tldCh2b2lkICpwcml2LAorICAgIHVpbnQ2NF90IGlkLCBz
dHJ1Y3QgdXNiX3JlZGlyX2J1bGtfcGFja2V0X2hlYWRlciAqaCwKKyAgICB1aW50OF90ICpkYXRh
LCBpbnQgZGF0YV9sZW4pCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2
OworICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqZCA9IGNoLT5hdHRhY2hlZDsKKyAgICBTcGlj
ZVVzYkVtdWxhdGVkRGV2aWNlICplZGV2ID0gZCA/IGQtPmVkZXYgOiBOVUxMOworICAgIHN0cnVj
dCB1c2JfcmVkaXJfYnVsa19wYWNrZXRfaGVhZGVyIGhvdXQgPSAqaDsKKyAgICB1aW50MzJfdCBs
ZW4gPSAoaC0+bGVuZ3RoX2hpZ2ggPDwgMTYpIHwgaC0+bGVuZ3RoOworICAgIFNQSUNFX0RFQlVH
KCIlcyAlcDogZXAgJVgsIGxlbiAldSwgaWQgJSIgUFJJdTY0LCBfX0ZVTkNUSU9OX18sCisgICAg
ICAgICAgICAgICAgY2gsIGgtPmVuZHBvaW50LCBsZW4sIGlkKTsKKworICAgIGlmICghZWRldikg
eworICAgICAgICBTUElDRV9ERUJVRygiJXM6IGRldmljZSBub3QgYXR0YWNoZWQiLCBfX0ZVTkNU
SU9OX18pOworICAgICAgICBob3V0LnN0YXR1cyA9IHVzYl9yZWRpcl9pb2Vycm9yOworICAgICAg
ICBob3V0Lmxlbmd0aCA9IGhvdXQubGVuZ3RoX2hpZ2ggPSAwOworICAgICAgICBTUElDRV9ERUJV
RygiJXM6IHJlc3BvbmRpbmcgd2l0aCBaTFAgc3RhdHVzICVkIiwgX19GVU5DVElPTl9fLCBob3V0
LnN0YXR1cyk7CisgICAgfSBlbHNlIGlmIChoLT5lbmRwb2ludCAmIExJQlVTQl9FTkRQT0lOVF9J
TikgeworICAgICAgICBpZiAoZGV2aWNlX29wcyhlZGV2KS0+YnVsa19pbl9yZXF1ZXN0KGVkZXYs
IGlkLCAmaG91dCkpIHsKKyAgICAgICAgICAgIHVzYnJlZGlycGFyc2VyX2ZyZWVfcGFja2V0X2Rh
dGEoY2gtPnBhcnNlciwgZGF0YSk7CisgICAgICAgICAgICAvKiBjb21wbGV0aW9uIGlzIGFzeW5j
aHJvbm91cyAqLworICAgICAgICAgICAgcmV0dXJuOworICAgICAgICB9CisgICAgfSBlbHNlIHsK
KyAgICAgICAgaG91dC5zdGF0dXMgPSB1c2JfcmVkaXJfc3RhbGw7CisgICAgICAgIGRldmljZV9v
cHMoZWRldiktPmJ1bGtfb3V0X3JlcXVlc3QoZWRldiwgaC0+ZW5kcG9pbnQsIGRhdGEsIGRhdGFf
bGVuLCAmaG91dC5zdGF0dXMpOworICAgICAgICBTUElDRV9ERUJVRygiJXM6IHJlc3BvbmRpbmcg
c3RhdHVzICVkIiwgX19GVU5DVElPTl9fLCBob3V0LnN0YXR1cyk7CisgICAgfQorCisgICAgdXNi
cmVkaXJwYXJzZXJfc2VuZF9idWxrX3BhY2tldChjaC0+cGFyc2VyLCBpZCwgJmhvdXQsIE5VTEws
IDApOworICAgIHVzYnJlZGlycGFyc2VyX2ZyZWVfcGFja2V0X2RhdGEoY2gtPnBhcnNlciwgZGF0
YSk7CisgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2soY2gpOworfQorCitzdGF0aWMg
dm9pZCB1c2JyZWRpcl9kZXZpY2VfcmVzZXQodm9pZCAqcHJpdikKK3sKKyAgICBTcGljZVVzYkJh
Y2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkID0g
Y2gtPmF0dGFjaGVkOworICAgIFNwaWNlVXNiRW11bGF0ZWREZXZpY2UgKmVkZXYgPSBkID8gZC0+
ZWRldiA6IE5VTEw7CisgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIiwgX19GVU5DVElPTl9fLCBj
aCk7CisgICAgaWYgKGVkZXYpIHsKKyAgICAgICAgZGV2aWNlX29wcyhlZGV2KS0+cmVzZXQoZWRl
dik7CisgICAgfQorfQorCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9pbnRlcmZhY2VfaW5mbyh2b2lk
ICpwcml2LAorICAgIHN0cnVjdCB1c2JfcmVkaXJfaW50ZXJmYWNlX2luZm9faGVhZGVyICppbnRl
cmZhY2VfaW5mbykKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7Cisg
ICAgU1BJQ0VfREVCVUcoIiVzIG5vdCBpbXBsZW1lbnRlZCAlcCIsIF9fRlVOQ1RJT05fXywgY2gp
OworfQorCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9pbnRlcmZhY2VfZXBfaW5mbyh2b2lkICpwcml2
LAorICAgIHN0cnVjdCB1c2JfcmVkaXJfZXBfaW5mb19oZWFkZXIgKmVwX2luZm8pCit7CisgICAg
U3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIFNQSUNFX0RFQlVHKCIlcyBu
b3QgaW1wbGVtZW50ZWQgJXAiLCBfX0ZVTkNUSU9OX18sIGNoKTsKK30KKworc3RhdGljIHZvaWQg
dXNicmVkaXJfc2V0X2NvbmZpZ3VyYXRpb24odm9pZCAqcHJpdiwKKyAgICB1aW50NjRfdCBpZCwg
c3RydWN0IHVzYl9yZWRpcl9zZXRfY29uZmlndXJhdGlvbl9oZWFkZXIgKnNldF9jb25maWd1cmF0
aW9uKQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBzdHJ1
Y3QgdXNiX3JlZGlyX2NvbmZpZ3VyYXRpb25fc3RhdHVzX2hlYWRlciBoOworICAgIGguc3RhdHVz
ID0gMDsKKyAgICBoLmNvbmZpZ3VyYXRpb24gPSBzZXRfY29uZmlndXJhdGlvbi0+Y29uZmlndXJh
dGlvbjsKKyAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAsIGNmZyAlZCIsIF9fRlVOQ1RJT05fXywg
Y2gsIGguY29uZmlndXJhdGlvbik7CisgICAgaWYgKGNoLT5hdHRhY2hlZCkgeworICAgICAgICBj
aC0+YXR0YWNoZWQtPmVkZXZfY29uZmlndXJlZCA9IGguY29uZmlndXJhdGlvbiAhPSAwOworICAg
IH0KKyAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2NvbmZpZ3VyYXRpb25fc3RhdHVzKGNoLT5wYXJz
ZXIsIGlkLCAmaCk7CisgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2soY2gpOworfQor
CitzdGF0aWMgdm9pZCB1c2JyZWRpcl9nZXRfY29uZmlndXJhdGlvbih2b2lkICpwcml2LCB1aW50
NjRfdCBpZCkKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAg
c3RydWN0IHVzYl9yZWRpcl9jb25maWd1cmF0aW9uX3N0YXR1c19oZWFkZXIgaDsKKyAgICBoLnN0
YXR1cyA9IDA7CisgICAgaC5jb25maWd1cmF0aW9uID0gY2gtPmF0dGFjaGVkICYmIGNoLT5hdHRh
Y2hlZC0+ZWRldl9jb25maWd1cmVkOworICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCwgY2ZnICVk
IiwgX19GVU5DVElPTl9fLCBjaCwgaC5jb25maWd1cmF0aW9uKTsKKyAgICB1c2JyZWRpcnBhcnNl
cl9zZW5kX2NvbmZpZ3VyYXRpb25fc3RhdHVzKGNoLT5wYXJzZXIsIGlkLCAmaCk7CisgICAgdXNi
cmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2soY2gpOworfQorCitzdGF0aWMgdm9pZCB1c2JyZWRp
cl9zZXRfYWx0X3NldHRpbmcodm9pZCAqcHJpdiwKKyAgICB1aW50NjRfdCBpZCwgc3RydWN0IHVz
Yl9yZWRpcl9zZXRfYWx0X3NldHRpbmdfaGVhZGVyICpzKQoreworICAgIFNwaWNlVXNiQmFja2Vu
ZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBzdHJ1Y3QgdXNiX3JlZGlyX2FsdF9zZXR0aW5nX3N0
YXR1c19oZWFkZXIgc2g7CisgICAgc2guc3RhdHVzID0gKCFzLT5pbnRlcmZhY2UgJiYgIXMtPmFs
dCkgPyAwIDogdXNiX3JlZGlyX3N0YWxsOworICAgIHNoLmludGVyZmFjZSA9IHMtPmludGVyZmFj
ZTsKKyAgICBzaC5hbHQgPSBzLT5hbHQ7CisgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwLCAlZDol
ZCIsIF9fRlVOQ1RJT05fXywgY2gsIHMtPmludGVyZmFjZSwgcy0+YWx0KTsKKyAgICB1c2JyZWRp
cnBhcnNlcl9zZW5kX2FsdF9zZXR0aW5nX3N0YXR1cyhjaC0+cGFyc2VyLCBpZCwgJnNoKTsKKyAg
ICB1c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFjayhjaCk7Cit9CisKK3N0YXRpYyB2b2lkIHVz
YnJlZGlyX2dldF9hbHRfc2V0dGluZyh2b2lkICpwcml2LAorICAgIHVpbnQ2NF90IGlkLCBzdHJ1
Y3QgdXNiX3JlZGlyX2dldF9hbHRfc2V0dGluZ19oZWFkZXIgKnMpCit7CisgICAgU3BpY2VVc2JC
YWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIHN0cnVjdCB1c2JfcmVkaXJfYWx0X3NldHRp
bmdfc3RhdHVzX2hlYWRlciBzaDsKKyAgICBzaC5zdGF0dXMgPSAocy0+aW50ZXJmYWNlID09IDAp
ID8gMCA6IHVzYl9yZWRpcl9zdGFsbDsKKyAgICBzaC5pbnRlcmZhY2UgPSBzLT5pbnRlcmZhY2U7
CisgICAgc2guYWx0ID0gMDsKKyAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAsIGlmICVkIiwgX19G
VU5DVElPTl9fLCBjaCwgcy0+aW50ZXJmYWNlKTsKKyAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2Fs
dF9zZXR0aW5nX3N0YXR1cyhjaC0+cGFyc2VyLCBpZCwgJnNoKTsKKyAgICB1c2JyZWRpcl93cml0
ZV9mbHVzaF9jYWxsYmFjayhjaCk7Cit9CisKK3N0YXRpYyB2b2lkIHVzYnJlZGlyX2NhbmNlbF9k
YXRhKHZvaWQgKnByaXYsIHVpbnQ2NF90IGlkKQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5u
ZWwgKmNoID0gcHJpdjsKKyAgICBTcGljZVVzYkJhY2tlbmREZXZpY2UgKmQgPSBjaC0+YXR0YWNo
ZWQ7CisgICAgU3BpY2VVc2JFbXVsYXRlZERldmljZSAqZWRldiA9IGQgPyBkLT5lZGV2IDogTlVM
TDsKKyAgICBpZiAoIWVkZXYpIHsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBkZXZpY2Ugbm90
IGF0dGFjaGVkIiwgX19GVU5DVElPTl9fKTsKKyAgICAgICAgcmV0dXJuOworICAgIH0KKyAgICBk
ZXZpY2Vfb3BzKGVkZXYpLT5jYW5jZWxfcmVxdWVzdChlZGV2LCBpZCk7Cit9CisKK3N0YXRpYyB2
b2lkIHVzYnJlZGlyX2ZpbHRlcl9yZWplY3Qodm9pZCAqcHJpdikKK3sKKyAgICBTcGljZVVzYkJh
Y2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU1BJQ0VfREVCVUcoIiVzICVwIiwgX19GVU5D
VElPTl9fLCBjaCk7CisgICAgY2gtPnJlamVjdGVkID0gMTsKK30KKworLyogTm90ZSB0aGF0IHRo
ZSBvd25lcnNoaXAgb2YgdGhlIHJ1bGVzIGFycmF5IGlzIHBhc3NlZCBvbiB0byB0aGUgY2FsbGJh
Y2suICovCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9maWx0ZXJfZmlsdGVyKHZvaWQgKnByaXYsCisg
ICAgc3RydWN0IHVzYnJlZGlyZmlsdGVyX3J1bGUgKnIsIGludCBjb3VudCkKK3sKKyAgICBTcGlj
ZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVw
ICVkIGZpbHRlcnMiLCBfX0ZVTkNUSU9OX18sIGNoLCBjb3VudCk7CisKKyAgICBmcmVlKGNoLT5y
dWxlcyk7CisKKyAgICBjaC0+cnVsZXMgPSByOworICAgIGNoLT5ydWxlc19jb3VudCA9IGNvdW50
OworICAgIGlmIChjb3VudCkgeworICAgICAgICBpbnQgaTsKKyAgICAgICAgZm9yIChpID0gMDsg
aSA8IGNvdW50OyBpKyspIHsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjbGFzcyAlZCwg
JVg6JVgiLAorICAgICAgICAgICAgICAgIHJbaV0uYWxsb3cgPyAiYWxsb3dlZCIgOiAiZGVuaWVk
IiwgcltpXS5kZXZpY2VfY2xhc3MsCisgICAgICAgICAgICAgICAgKHVpbnQzMl90KXJbaV0udmVu
ZG9yX2lkLCAodWludDMyX3QpcltpXS5wcm9kdWN0X2lkKTsKKyAgICAgICAgfQorICAgIH0KK30K
Kworc3RhdGljIHZvaWQgdXNicmVkaXJfZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrKHZvaWQgKnByaXYp
Cit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIFNQSUNFX0RF
QlVHKCIlcyBjaCAlcCIsIF9fRlVOQ1RJT05fXywgY2gpOworICAgIGlmIChjaC0+cGFyc2VyICYm
IGNoLT53YWl0X2Rpc2NfYWNrKSB7CisgICAgICAgIGNoLT5wYXJzZXIgPSBOVUxMOworICAgICAg
ICBTUElDRV9ERUJVRygiJXMgc3dpdGNoIHRvIHVzYnJlZGlyaG9zdCIsIF9fRlVOQ1RJT05fXyk7
CisgICAgICAgIGNoLT51c2JyZWRpcmhvc3QgPSBjaC0+aGlkZGVuX2hvc3Q7CisgICAgfQorICAg
IGNoLT53YWl0X2Rpc2NfYWNrID0gMDsKK30KKworc3RhdGljIHZvaWQgdXNicmVkaXJfaGVsbG8o
dm9pZCAqcHJpdiwKKyAgICBzdHJ1Y3QgdXNiX3JlZGlyX2hlbGxvX2hlYWRlciAqaGVsbG8pCit7
CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIFNwaWNlVXNiQmFj
a2VuZERldmljZSAqZCA9IGNoLT5hdHRhY2hlZDsKKyAgICBTcGljZVVzYkVtdWxhdGVkRGV2aWNl
ICplZGV2ID0gZCA/IGQtPmVkZXYgOiBOVUxMOworICAgIHN0cnVjdCB1c2JfcmVkaXJfZGV2aWNl
X2Nvbm5lY3RfaGVhZGVyIGRldmljZV9jb25uZWN0OworICAgIHN0cnVjdCB1c2JfcmVkaXJfZXBf
aW5mb19oZWFkZXIgZXBfaW5mbyA9IHsgMCB9OworICAgIHN0cnVjdCB1c2JfcmVkaXJfaW50ZXJm
YWNlX2luZm9faGVhZGVyIGludGVyZmFjZV9pbmZvID0geyAwIH07CisgICAgdWludDhfdCAqY2Zn
OworICAgIHVpbnQxNl90IHNpemUsIG9mZnNldCA9IDA7CisgICAgU1BJQ0VfREVCVUcoIiVzICVw
ICVzYXR0YWNoZWQgJXMiLCBfX0ZVTkNUSU9OX18sIGNoLAorICAgICAgICBlZGV2ID8gIiIgOiAi
bm90ICIsICBoZWxsbyA/ICIiIDogIihpbnRlcm5hbCkiKTsKKworICAgIGlmIChoZWxsbykgewor
ICAgICAgICBjaC0+aGVsbG9fZG9uZV9wYXJzZXIgPSAxOworICAgIH0KKyAgICBpZiAoIWVkZXYp
IHsKKyAgICAgICAgcmV0dXJuOworICAgIH0KKyAgICBpZiAoIWRldmljZV9vcHMoZWRldiktPmdl
dF9kZXNjcmlwdG9yKAorICAgICAgICAgICAgZWRldiwgTElCVVNCX0RUX0NPTkZJRywgMCwgKHZv
aWQgKiopJmNmZywgJnNpemUpKSB7CisgICAgICAgIHJldHVybjsKKyAgICB9CisgICAgd2hpbGUg
KChvZmZzZXQgKyAxKSA8IHNpemUpIHsKKyAgICAgICAgdWludDhfdCBsZW4gID0gY2ZnW29mZnNl
dF07CisgICAgICAgIHVpbnQ4X3QgdHlwZSA9IGNmZ1tvZmZzZXQgKyAxXTsKKyAgICAgICAgaWYg
KChvZmZzZXQgKyBsZW4pID4gc2l6ZSkgeworICAgICAgICAgICAgYnJlYWs7CisgICAgICAgIH0K
KyAgICAgICAgaWYgKHR5cGUgPT0gTElCVVNCX0RUX0lOVEVSRkFDRSkgeworICAgICAgICAgICAg
dWludDMyX3QgaSA9IGludGVyZmFjZV9pbmZvLmludGVyZmFjZV9jb3VudDsKKyAgICAgICAgICAg
IHVpbnQ4X3QgY2xhc3MsIHN1YmNsYXNzLCBwcm90b2NvbDsKKyAgICAgICAgICAgIGNsYXNzID0g
Y2ZnW29mZnNldCArIDVdOworICAgICAgICAgICAgc3ViY2xhc3MgPSBjZmdbb2Zmc2V0ICsgNl07
CisgICAgICAgICAgICBwcm90b2NvbCA9IGNmZ1tvZmZzZXQgKyA3XTsKKyAgICAgICAgICAgIGlu
dGVyZmFjZV9pbmZvLmludGVyZmFjZV9jbGFzc1tpXSA9IGNsYXNzOworICAgICAgICAgICAgaW50
ZXJmYWNlX2luZm8uaW50ZXJmYWNlX3N1YmNsYXNzW2ldID0gc3ViY2xhc3M7CisgICAgICAgICAg
ICBpbnRlcmZhY2VfaW5mby5pbnRlcmZhY2VfcHJvdG9jb2xbaV0gPSBwcm90b2NvbDsKKyAgICAg
ICAgICAgIGludGVyZmFjZV9pbmZvLmludGVyZmFjZV9jb3VudCsrOworICAgICAgICAgICAgU1BJ
Q0VfREVCVUcoIiVzIElGJWQ6ICVkLyVkLyVkIiwgX19GVU5DVElPTl9fLCBpLCBjbGFzcywgc3Vi
Y2xhc3MsIHByb3RvY29sKTsKKyAgICAgICAgfSBlbHNlIGlmICh0eXBlID09IExJQlVTQl9EVF9F
TkRQT0lOVCkgeworICAgICAgICAgICAgdWludDhfdCBhZGRyZXNzID0gY2ZnW29mZnNldCArIDJd
OworICAgICAgICAgICAgdWludDE2X3QgbWF4X3BhY2tldF9zaXplID0gMHgxMDAgKiBjZmdbb2Zm
c2V0ICsgNV0gKyBjZmdbb2Zmc2V0ICsgNF07CisgICAgICAgICAgICB1aW50OF90IGluZGV4ID0g
YWRkcmVzcyAmIDB4ZjsKKyAgICAgICAgICAgIGlmIChhZGRyZXNzICYgMHg4MCkgaW5kZXggKz0g
MHgxMDsKKyAgICAgICAgICAgIGVwX2luZm8udHlwZVtpbmRleF0gPSBjZmdbb2Zmc2V0ICsgM10g
JiAweDM7CisgICAgICAgICAgICBlcF9pbmZvLm1heF9wYWNrZXRfc2l6ZVtpbmRleF0gPSBtYXhf
cGFja2V0X3NpemU7CisgICAgICAgICAgICBTUElDRV9ERUJVRygiJXMgRVBbJTAyWF06ICVkLyVk
IiwgX19GVU5DVElPTl9fLCBpbmRleCwgZXBfaW5mby50eXBlW2luZGV4XSwgbWF4X3BhY2tldF9z
aXplKTsKKyAgICAgICAgfQorICAgICAgICBvZmZzZXQgKz0gbGVuOworICAgIH0KKworICAgIHVz
YnJlZGlycGFyc2VyX3NlbmRfaW50ZXJmYWNlX2luZm8oY2gtPnBhcnNlciwgJmludGVyZmFjZV9p
bmZvKTsKKyAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2VwX2luZm8oY2gtPnBhcnNlciwgJmVwX2lu
Zm8pOworCisgICAgZGV2aWNlX2Nvbm5lY3QuZGV2aWNlX2NsYXNzID0gMDsgLy9kLT5kZXZpY2Vf
aW5mby5jbGFzczsKKyAgICBkZXZpY2VfY29ubmVjdC5kZXZpY2Vfc3ViY2xhc3MgPSAwOyAvL2Qt
PmRldmljZV9pbmZvLnN1YmNsYXNzOworICAgIGRldmljZV9jb25uZWN0LmRldmljZV9wcm90b2Nv
bCA9IDA7IC8vZC0+ZGV2aWNlX2luZm8ucHJvdG9jb2w7OworICAgIGRldmljZV9jb25uZWN0LnZl
bmRvcl9pZCA9IGQtPmRldmljZV9pbmZvLnZpZDsKKyAgICBkZXZpY2VfY29ubmVjdC5wcm9kdWN0
X2lkID0gZC0+ZGV2aWNlX2luZm8ucGlkOworICAgIGRldmljZV9jb25uZWN0LmRldmljZV92ZXJz
aW9uX2JjZCA9IGQtPmRldmljZV9pbmZvLmJjZFVTQjsKKyAgICBkZXZpY2VfY29ubmVjdC5zcGVl
ZCA9IHVzYl9yZWRpcl9zcGVlZF9oaWdoOworICAgIHVzYnJlZGlycGFyc2VyX3NlbmRfZGV2aWNl
X2Nvbm5lY3QoY2gtPnBhcnNlciwgJmRldmljZV9jb25uZWN0KTsKKyAgICB1c2JyZWRpcl93cml0
ZV9mbHVzaF9jYWxsYmFjayhjaCk7Cit9CisKK3N0YXRpYyB2b2lkIGluaXRpYWxpemVfcGFyc2Vy
KFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLCBnYm9vbGVhbiBkb19oZWxsbykKK3sKKyAgICB1
aW50MzJfdCBmbGFncywgY2Fwc1tVU0JfUkVESVJfQ0FQU19TSVpFXSA9IHsgMCB9OworCisgICAg
Z19yZXR1cm5faWZfZmFpbChjaC0+aGlkZGVuX3BhcnNlciAhPSBOVUxMKTsKKyAgICBpZiAoY2gt
PnBhcnNlcl9pbml0X2RvbmUpIHsKKyAgICAgICAgaWYgKGNoLT5wYXJzZXJfd2l0aF9oZWxsbyAh
PSBkb19oZWxsbykgeworICAgICAgICAgICAgZ19yZXR1cm5faWZfcmVhY2hlZCgpOworICAgICAg
ICB9CisgICAgICAgIHJldHVybjsKKyAgICB9CisKKyAgICBjaC0+cGFyc2VyX2luaXRfZG9uZSA9
IDE7CisgICAgY2gtPnBhcnNlcl93aXRoX2hlbGxvID0gZG9faGVsbG87CisgICAgZmxhZ3MgPSB1
c2JyZWRpcnBhcnNlcl9mbF93cml0ZV9jYl9vd25zX2J1ZmZlciB8IHVzYnJlZGlycGFyc2VyX2Zs
X3VzYl9ob3N0OworCisgICAgaWYgKGRvX2hlbGxvKSB7CisgICAgICAgIGNoLT5oZWxsb19zZW50
ID0gMTsKKyAgICAgICAgY2gtPmhvc3RfY2FwcyB8PSAxIDw8IHVzYl9yZWRpcl9jYXBfY29ubmVj
dF9kZXZpY2VfdmVyc2lvbjsKKyAgICAgICAgY2gtPmhvc3RfY2FwcyB8PSAxIDw8IHVzYl9yZWRp
cl9jYXBfZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrOworICAgICAgICBjaC0+aG9zdF9jYXBzIHw9IDEg
PDwgdXNiX3JlZGlyX2NhcF9lcF9pbmZvX21heF9wYWNrZXRfc2l6ZTsKKyAgICAgICAgY2gtPmhv
c3RfY2FwcyB8PSAxIDw8IHVzYl9yZWRpcl9jYXBfNjRiaXRzX2lkczsKKyAgICAgICAgY2gtPmhv
c3RfY2FwcyB8PSAxIDw8IHVzYl9yZWRpcl9jYXBfMzJiaXRzX2J1bGtfbGVuZ3RoOworICAgIH0g
ZWxzZSB7CisgICAgICAgIGZsYWdzIHw9IHVzYnJlZGlycGFyc2VyX2ZsX25vX2hlbGxvOworICAg
IH0KKworICAgIGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF9jb25uZWN0
X2RldmljZV92ZXJzaW9uKSkgeworICAgICAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAo
Y2FwcywgdXNiX3JlZGlyX2NhcF9jb25uZWN0X2RldmljZV92ZXJzaW9uKTsKKyAgICB9CisgICAg
dXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfZmlsdGVyKTsK
KyAgICBpZiAoY2gtPmhvc3RfY2FwcyAmICgxIDw8IHVzYl9yZWRpcl9jYXBfZGV2aWNlX2Rpc2Nv
bm5lY3RfYWNrKSkgeworICAgICAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2Fwcywg
dXNiX3JlZGlyX2NhcF9kZXZpY2VfZGlzY29ubmVjdF9hY2spOworICAgIH0KKyAgICBpZiAoY2gt
Pmhvc3RfY2FwcyAmICgxIDw8IHVzYl9yZWRpcl9jYXBfZXBfaW5mb19tYXhfcGFja2V0X3NpemUp
KSB7CisgICAgICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJf
Y2FwX2VwX2luZm9fbWF4X3BhY2tldF9zaXplKTsKKyAgICB9CisgICAgaWYgKGNoLT5ob3N0X2Nh
cHMgJiAoMSA8PCB1c2JfcmVkaXJfY2FwXzY0Yml0c19pZHMpKSB7CisgICAgICAgIHVzYnJlZGly
cGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJfY2FwXzY0Yml0c19pZHMpOworICAg
IH0KKyAgICBpZiAoY2gtPmhvc3RfY2FwcyAmICgxIDw8IHVzYl9yZWRpcl9jYXBfMzJiaXRzX2J1
bGtfbGVuZ3RoKSkgeworICAgICAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2Fwcywg
dXNiX3JlZGlyX2NhcF8zMmJpdHNfYnVsa19sZW5ndGgpOworICAgIH0KKyAgICBpZiAoY2gtPmhv
c3RfY2FwcyAmICgxIDw8IHVzYl9yZWRpcl9jYXBfYnVsa19zdHJlYW1zKSkgeworICAgICAgICB1
c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF9idWxrX3N0cmVh
bXMpOworICAgIH0KKyAgICB1c2JyZWRpcnBhcnNlcl9pbml0KGNoLT5oaWRkZW5fcGFyc2VyLCBQ
QUNLQUdFX1NUUklORywgY2FwcywgVVNCX1JFRElSX0NBUFNfU0laRSwgZmxhZ3MpOworfQorCisv
KgorICAgIFdlIGNhbiBpbml0aWFsaXplIHRoZSB1c2JyZWRpcnBhcnNlciB3aXRoIEhFTExPIGVu
YWJsZWQgb25seSBpbiBjYXNlCisgICAgdGhlIGxpYnVzYiBpcyBub3QgYWN0aXZlIGFuZCB0aGUg
dXNicmVkaXJob3N0IGRvZXMgbm90IGZ1bmN0aW9uLgorICAgIFRoZW4gdGhlIHBhcnNlciBzZW5k
cyBzZXNzaW9uIEhFTExPIGFuZCByZWNlaXZlcyBzZXJ2ZXIncyByZXNwb25zZS4KKyAgICBPdGhl
cndpc2UgKHVzYnJlZGlycGFyc2VyIGluaXRpYWxpemVkIHdpdGggSEVMTE8gZGlzYWJsZWQpOgor
ICAgIC0gdGhlIHVzYnJlZGlyaG9zdCBzZW5kcyBzZXNzaW9uIEhFTExPCisgICAgLSB3ZSBsb29r
IGludG8gaXQgdG8ga25vdyBzZXQgb2YgY2FwYWJpbGl0aWVzIHdlIHNoYWxsIGluaXRpYWxpemUK
KyAgICAgIHRoZSBwYXJzZXIgd2l0aAorICAgIC0gd2hlbiB3ZSByZWNlaXZlIHNlcnZlcidzIHJl
c3BvbnNlIHRvIEhFTExPIHdlIHByb3ZpZGUgaXQgYWxzbyB0bworICAgICAgcGFyc2VyIHRvIGxl
dCBpdCBzeW5jaHJvbml6ZSB3aXRoIHNlcnZlcidzIGNhcGFiaWxpdGllcworKi8KK3N0YXRpYyBz
dHJ1Y3QgdXNicmVkaXJwYXJzZXIgKmNyZWF0ZV9wYXJzZXIoU3BpY2VVc2JCYWNrZW5kQ2hhbm5l
bCAqY2gpCit7CisgICAgc3RydWN0IHVzYnJlZGlycGFyc2VyICpwYXJzZXIgPSB1c2JyZWRpcnBh
cnNlcl9jcmVhdGUoKTsKKworICAgIGdfcmV0dXJuX3ZhbF9pZl9mYWlsKHBhcnNlciAhPSBOVUxM
LCBOVUxMKTsKKworICAgIHBhcnNlci0+cHJpdiA9IGNoOworICAgIHBhcnNlci0+bG9nX2Z1bmMg
PSB1c2JyZWRpcl9sb2c7CisgICAgcGFyc2VyLT5yZWFkX2Z1bmMgPSB1c2JyZWRpcl9yZWFkX2Nh
bGxiYWNrOworICAgIHBhcnNlci0+d3JpdGVfZnVuYyA9IHVzYnJlZGlyX3dyaXRlX2NhbGxiYWNr
OworICAgIHBhcnNlci0+cmVzZXRfZnVuYyA9IHVzYnJlZGlyX2RldmljZV9yZXNldDsKKyAgICBw
YXJzZXItPnNldF9jb25maWd1cmF0aW9uX2Z1bmMgPSB1c2JyZWRpcl9zZXRfY29uZmlndXJhdGlv
bjsKKyAgICBwYXJzZXItPmdldF9jb25maWd1cmF0aW9uX2Z1bmMgPSB1c2JyZWRpcl9nZXRfY29u
ZmlndXJhdGlvbjsKKyAgICBwYXJzZXItPnNldF9hbHRfc2V0dGluZ19mdW5jID0gdXNicmVkaXJf
c2V0X2FsdF9zZXR0aW5nOworICAgIHBhcnNlci0+Z2V0X2FsdF9zZXR0aW5nX2Z1bmMgPSB1c2Jy
ZWRpcl9nZXRfYWx0X3NldHRpbmc7CisgICAgcGFyc2VyLT5jYW5jZWxfZGF0YV9wYWNrZXRfZnVu
YyA9IHVzYnJlZGlyX2NhbmNlbF9kYXRhOworICAgIHBhcnNlci0+Y29udHJvbF9wYWNrZXRfZnVu
YyA9IHVzYnJlZGlyX2NvbnRyb2xfcGFja2V0OworICAgIHBhcnNlci0+YnVsa19wYWNrZXRfZnVu
YyA9IHVzYnJlZGlyX2J1bGtfcGFja2V0OworICAgIHBhcnNlci0+YWxsb2NfbG9ja19mdW5jID0g
dXNicmVkaXJfYWxsb2NfbG9jazsKKyAgICBwYXJzZXItPmxvY2tfZnVuYyA9IHVzYnJlZGlyX2xv
Y2tfbG9jazsKKyAgICBwYXJzZXItPnVubG9ja19mdW5jID0gdXNicmVkaXJfdW5sb2NrX2xvY2s7
CisgICAgcGFyc2VyLT5mcmVlX2xvY2tfZnVuYyA9IHVzYnJlZGlyX2ZyZWVfbG9jazsKKyAgICBw
YXJzZXItPmhlbGxvX2Z1bmMgPSB1c2JyZWRpcl9oZWxsbzsKKyAgICBwYXJzZXItPmZpbHRlcl9y
ZWplY3RfZnVuYyA9IHVzYnJlZGlyX2ZpbHRlcl9yZWplY3Q7CisgICAgcGFyc2VyLT5kZXZpY2Vf
ZGlzY29ubmVjdF9hY2tfZnVuYyA9IHVzYnJlZGlyX2RldmljZV9kaXNjb25uZWN0X2FjazsKKyAg
ICBwYXJzZXItPmludGVyZmFjZV9pbmZvX2Z1bmMgPSB1c2JyZWRpcl9pbnRlcmZhY2VfaW5mbzsK
KyAgICBwYXJzZXItPmVwX2luZm9fZnVuYyA9IHVzYnJlZGlyX2ludGVyZmFjZV9lcF9pbmZvOwor
ICAgIHBhcnNlci0+ZmlsdGVyX2ZpbHRlcl9mdW5jID0gdXNicmVkaXJfZmlsdGVyX2ZpbHRlcjsK
KworICAgIHJldHVybiBwYXJzZXI7Cit9CisKK3N0YXRpYyBnYm9vbGVhbiBhdHRhY2hfZWRldihT
cGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICBT
cGljZVVzYkJhY2tlbmREZXZpY2UgKmRldiwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICBH
RXJyb3IgKiplcnJvcikKK3sKKyAgICBpZiAoIWRldi0+ZWRldikgeworICAgICAgICBnX3NldF9l
cnJvcihlcnJvciwgU1BJQ0VfQ0xJRU5UX0VSUk9SLCBTUElDRV9DTElFTlRfRVJST1JfRkFJTEVE
LAorICAgICAgICAgICBfKCJGYWlsZWQgdG8gcmVkaXJlY3QgZGV2aWNlICVkIiksIDEpOworICAg
ICAgICByZXR1cm4gRkFMU0U7CisgICAgfQorICAgIGlmIChjaC0+dXNicmVkaXJob3N0ICYmICFj
aC0+aGVsbG9fZG9uZV9wYXJzZXIpIHsKKyAgICAgICAgLyoKKyAgICAgICAgICAgIHdlIGNhbid0
IGluaXRpYWxpemUgcGFyc2VyIHVudGlsIHdlIHNlZSBoZWxsbyBmcm9tIHVzYnJlZGlyCisgICAg
ICAgICAgICBhbmQgdGhlIHBhcnNlciBjYW4ndCB3b3JrIHVudGlsIGl0IHNlZXMgdGhlIGhlbGxv
IHJlc3BvbnNlLgorICAgICAgICAgICAgdGhpcyBpcyBjYXNlIG9mIGF1dG9jb25uZWN0IHdoZW4g
ZW11bGF0ZWQgZGV2aWNlIGlzIGF0dGFjaGVkCisgICAgICAgICAgICBiZWZvcmUgdGhlIGNoYW5u
ZWwgaXMgdXAKKyAgICAgICAgKi8KKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzIHdhaXRpbmcgdW50
aWwgdGhlIGNoYW5uZWwgaXMgcmVhZHkiLCBfX0ZVTkNUSU9OX18pOworCisgICAgfSBlbHNlIHsK
KyAgICAgICAgaW5pdGlhbGl6ZV9wYXJzZXIoY2gsIGNoLT5oaWRkZW5faG9zdCA9PSBOVUxMKTsK
KyAgICAgICAgY2gtPnVzYnJlZGlyaG9zdCA9IE5VTEw7CisgICAgICAgIGNoLT5wYXJzZXIgPSBj
aC0+aGlkZGVuX3BhcnNlcjsKKyAgICB9CisgICAgY2gtPndhaXRfZGlzY19hY2sgPSAwOworICAg
IGNoLT5hdHRhY2hlZCA9IGRldjsKKyAgICBkZXYtPmF0dGFjaGVkX3RvID0gY2g7CisgICAgZGV2
aWNlX29wcyhkZXYtPmVkZXYpLT5hdHRhY2goZGV2LT5lZGV2LCBjaC0+aGlkZGVuX3BhcnNlcik7
CisgICAgaWYgKGNoLT5oZWxsb19kb25lX3BhcnNlcikgeworICAgICAgICAvKiBzZW5kIGRldmlj
ZSBpbmZvICovCisgICAgICAgIHVzYnJlZGlyX2hlbGxvKGNoLCBOVUxMKTsKKyAgICB9CisgICAg
cmV0dXJuIFRSVUU7Cit9CisKIGdib29sZWFuIHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfYXR0
YWNoKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLAogICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkZXYsCiAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBHRXJyb3IgKiplcnJvcikKQEAgLTcwOSw3
ICsxMjI1LDEzIEBAIGdib29sZWFuIHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfYXR0YWNoKFNw
aWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLAogCiAgICAgZ19yZXR1cm5fdmFsX2lmX2ZhaWwoZGV2
ICE9IE5VTEwsIEZBTFNFKTsKIAorICAgIGlmICghZGV2LT5saWJ1c2JfZGV2aWNlKSB7CisgICAg
ICAgIHJldHVybiBhdHRhY2hfZWRldihjaCwgZGV2LCBlcnJvcik7CisgICAgfQorCiAgICAgbGli
dXNiX2RldmljZV9oYW5kbGUgKmhhbmRsZSA9IE5VTEw7CisgICAgY2gtPnVzYnJlZGlyaG9zdCA9
IGNoLT5oaWRkZW5faG9zdDsKKyAgICBjaC0+cGFyc2VyID0gTlVMTDsKIAogICAgIC8qCiAgICAg
ICAgVW5kZXIgV2luZG93cyB3ZSBuZWVkIHRvIGF2b2lkIHVwZGF0aW5nCkBAIC03NDMsMTggKzEy
NjUsMzMgQEAgZ2Jvb2xlYW4gc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9hdHRhY2goU3BpY2VV
c2JCYWNrZW5kQ2hhbm5lbCAqY2gsCiAKIHZvaWQgc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9k
ZXRhY2goU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gpCiB7CisgICAgU3BpY2VVc2JCYWNrZW5k
RGV2aWNlICpkID0gY2gtPmF0dGFjaGVkOworICAgIFNwaWNlVXNiRW11bGF0ZWREZXZpY2UgKmVk
ZXYgPSBkID8gZC0+ZWRldiA6IE5VTEw7CiAgICAgU1BJQ0VfREVCVUcoIiVzID4+IGNoICVwLCB3
YXMgYXR0YWNoZWQgJXAiLCBfX0ZVTkNUSU9OX18sIGNoLCBjaC0+YXR0YWNoZWQpOwotICAgIGlm
ICghY2gtPmF0dGFjaGVkKSB7CisgICAgaWYgKCFkKSB7CiAgICAgICAgIFNQSUNFX0RFQlVHKCIl
czogbm90aGluZyB0byBkZXRhY2giLCBfX0ZVTkNUSU9OX18pOwogICAgICAgICByZXR1cm47CiAg
ICAgfQogICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7CiAgICAgICAgIC8qIGl0IHdpbGwgY2Fs
bCBsaWJ1c2JfY2xvc2UgaW50ZXJuYWxseSAqLwogICAgICAgICB1c2JyZWRpcmhvc3Rfc2V0X2Rl
dmljZShjaC0+dXNicmVkaXJob3N0LCBOVUxMKTsKKyAgICB9IGVsc2UgaWYgKGNoLT5wYXJzZXIp
IHsKKyAgICAgICAgaWYgKGVkZXYpIHsKKyAgICAgICAgICAgIGRldmljZV9vcHMoZWRldiktPmRl
dGFjaChlZGV2KTsKKyAgICAgICAgfQorICAgICAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2Rldmlj
ZV9kaXNjb25uZWN0KGNoLT5wYXJzZXIpOworICAgICAgICB1c2JyZWRpcl93cml0ZV9mbHVzaF9j
YWxsYmFjayhjaCk7CisgICAgICAgIGNoLT53YWl0X2Rpc2NfYWNrID0gdXNicmVkaXJwYXJzZXJf
cGVlcl9oYXNfY2FwKGNoLT5wYXJzZXIsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIHVzYl9yZWRpcl9jYXBfZGV2aWNlX2Rpc2Nvbm5lY3Rf
YWNrKTsKKyAgICAgICAgaWYgKCFjaC0+d2FpdF9kaXNjX2FjaykgeworICAgICAgICAgICAgY2gt
PnVzYnJlZGlyaG9zdCA9IGNoLT5oaWRkZW5faG9zdDsKKyAgICAgICAgICAgIGNoLT5wYXJzZXIg
PSBOVUxMOworICAgICAgICB9CiAgICAgfQogICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCwgZGV0
YWNoIGRvbmUiLCBfX0ZVTkNUSU9OX18sIGNoKTsKICAgICBjaC0+YXR0YWNoZWQtPmF0dGFjaGVk
X3RvID0gTlVMTDsKICAgICBjaC0+YXR0YWNoZWQgPSBOVUxMOworICAgIGNoLT5yZWplY3RlZCA9
IDA7CiB9CiAKIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKnNwaWNlX3VzYl9iYWNrZW5kX2NoYW5u
ZWxfbmV3KFNwaWNlVXNiQmFja2VuZCAqYmUsCkBAIC03ODUsMTAgKzEzMjIsMTUgQEAgU3BpY2VV
c2JCYWNrZW5kQ2hhbm5lbCAqc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9uZXcoU3BpY2VVc2JC
YWNrZW5kICpiZSwKICAgICAgICAgICAgIHVzYnJlZGlyaG9zdF9mbF93cml0ZV9jYl9vd25zX2J1
ZmZlcik7CiAgICAgICAgIGdfd2Fybl9pZl9mYWlsKGNoLT51c2JyZWRpcmhvc3QgIT0gTlVMTCk7
CiAgICAgfQorCiAgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKKyAgICAgICAgY2gtPmhpZGRl
bl9wYXJzZXIgPSBjcmVhdGVfcGFyc2VyKGNoKTsKKyAgICAgICAgY2gtPmhpZGRlbl9ob3N0ID0g
Y2gtPnVzYnJlZGlyaG9zdDsKICAgICAgICAgdXNicmVkaXJob3N0X3NldF9idWZmZXJlZF9vdXRw
dXRfc2l6ZV9jYihjaC0+dXNicmVkaXJob3N0LCB1c2JyZWRpcl9idWZmZXJlZF9vdXRwdXRfc2l6
ZV9jYWxsYmFjayk7Ci0gICAgfSBlbHNlIHsKLSAgICAgICAgZ19mcmVlKGNoKTsKKyAgICB9CisK
KyAgICBpZiAoIWNoLT5oaWRkZW5fcGFyc2VyKSB7CisgICAgICAgIHNwaWNlX3VzYl9iYWNrZW5k
X2NoYW5uZWxfZGVsZXRlKGNoKTsKICAgICAgICAgY2ggPSBOVUxMOwogICAgIH0KIApAQCAtNzk4
LDkgKzEzNDAsMTQgQEAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqc3BpY2VfdXNiX2JhY2tlbmRf
Y2hhbm5lbF9uZXcoU3BpY2VVc2JCYWNrZW5kICpiZSwKIAogdm9pZCBzcGljZV91c2JfYmFja2Vu
ZF9jaGFubmVsX2ZsdXNoX3dyaXRlcyhTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCkKIHsKLSAg
ICBTUElDRV9ERUJVRygiJXMgJXAsIGhvc3QgJXAiLCBfX0ZVTkNUSU9OX18sIGNoLCBjaC0+dXNi
cmVkaXJob3N0KTsKKyAgICBTUElDRV9ERUJVRygiJXMgJXAgaXMgdXAiLCBfX0ZVTkNUSU9OX18s
IGNoKTsKICAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgewogICAgICAgICB1c2JyZWRpcmhvc3Rf
d3JpdGVfZ3Vlc3RfZGF0YShjaC0+dXNicmVkaXJob3N0KTsKKyAgICAgICAgaW5pdGlhbGl6ZV9w
YXJzZXIoY2gsIEZBTFNFKTsKKyAgICB9IGVsc2UgeworICAgICAgICBpbml0aWFsaXplX3BhcnNl
cihjaCwgVFJVRSk7CisgICAgICAgIGNoLT5wYXJzZXIgPSBjaC0+aGlkZGVuX3BhcnNlcjsKKyAg
ICAgICAgdXNicmVkaXJwYXJzZXJfZG9fd3JpdGUoY2gtPnBhcnNlcik7CiAgICAgfQogfQogCkBA
IC04MTAsMTIgKzEzNTcsMTYgQEAgdm9pZCBzcGljZV91c2JfYmFja2VuZF9jaGFubmVsX2RlbGV0
ZShTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCkKICAgICBpZiAoIWNoKSB7CiAgICAgICAgIHJl
dHVybjsKICAgICB9Ci0gICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKLSAgICAgICAgdXNicmVk
aXJob3N0X2Nsb3NlKGNoLT51c2JyZWRpcmhvc3QpOworICAgIGlmIChjaC0+aGlkZGVuX2hvc3Qp
IHsKKyAgICAgICAgdXNicmVkaXJob3N0X2Nsb3NlKGNoLT5oaWRkZW5faG9zdCk7CisgICAgfQor
ICAgIGlmIChjaC0+aGlkZGVuX3BhcnNlcikgeworICAgICAgICB1c2JyZWRpcnBhcnNlcl9kZXN0
cm95KGNoLT5oaWRkZW5fcGFyc2VyKTsKICAgICB9CiAKICAgICBpZiAoY2gtPnJ1bGVzKSB7Ci0g
ICAgICAgIGdfZnJlZShjaC0+cnVsZXMpOworICAgICAgICAvKiBydWxlcyB3ZXJlIGFsbG9jYXRl
ZCBieSB1c2JyZWRpcnBhcnNlciAqLworICAgICAgICBmcmVlKGNoLT5ydWxlcyk7CiAgICAgfQog
CiAgICAgZ19mcmVlKGNoKTsKLS0gCjIuMjAuMQoKX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX18KU3BpY2UtZGV2ZWwgbWFpbGluZyBsaXN0ClNwaWNlLWRldmVs
QGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWls
bWFuL2xpc3RpbmZvL3NwaWNlLWRldmVs
