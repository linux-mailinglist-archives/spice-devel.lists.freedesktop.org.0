Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id 4F910AA4D2
	for <lists+spice-devel@lfdr.de>; Thu,  5 Sep 2019 15:43:01 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id B96006E0DB;
	Thu,  5 Sep 2019 13:42:59 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 4E3016E0E7
 for <spice-devel@lists.freedesktop.org>; Thu,  5 Sep 2019 13:42:58 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx06.intmail.prod.int.phx2.redhat.com
 [10.5.11.16])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id EB32F18C4282;
 Thu,  5 Sep 2019 13:42:57 +0000 (UTC)
Received: from fziglio.remote.csb (unknown [10.33.32.10])
 by smtp.corp.redhat.com (Postfix) with ESMTP id EF1EC5C219;
 Thu,  5 Sep 2019 13:42:56 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Thu,  5 Sep 2019 14:42:27 +0100
Message-Id: <20190905134241.28873-5-fziglio@redhat.com>
In-Reply-To: <20190905134241.28873-1-fziglio@redhat.com>
References: <20190905134241.28873-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.16
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.6.2
 (mx1.redhat.com [10.5.110.62]); Thu, 05 Sep 2019 13:42:57 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-gtk v6 04/18] usb-redir: extend USB
 backend to support emulated devices
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

RnJvbTogWXVyaSBCZW5kaXRvdmljaCA8eXVyaS5iZW5kaXRvdmljaEBkYXluaXguY29tPgoKUmVk
aXJlY3Rpb24gb2YgZW11bGF0ZWQgZGV2aWNlcyByZXF1aXJlcyBzcGVjaWFsIGFwcHJvYWNoLAph
cyB1c2JyZWRpcmhvc3QgY2FuJ3QgYmUgdXNlZCBmb3IgdGhhdCAoaXQgd29ya3Mgb25seSB3aXRo
CmxpYnVzYiBkZXZpY2VzKS4gRm9yIGVtdWxhdGVkIGRldmljZXMgd2UgY3JlYXRlIGluc3RhbmNl
IG9mCnVzYnJlZGlycGFyc2VyIHRoYXQgaW1wbGVtZW50cyBVU0IgcmVkaXJlY3Rpb24gcHJvdG9j
b2wuCkluIG9yZGVyIHRvIHdvcmsgd2l0aCB0aGUgc2FtZSBzZXQgb2YgcHJvdG9jb2wgY2FwYWJp
bGl0aWVzCnRoYXQgdXNicmVkaXJob3N0IHNldHMgdXAgd2l0aCByZW1vdGUgc2lkZSwgdGhlIHBh
cnNlciBzaGFsbDoKLSBub3Qgc2VuZCBpdHMgb3duICdoZWxsbycgdG8gdGhlIHNlcnZlcgotIGlu
aXRpYWxpemUgdGhlIHNhbWUgY2FwYWJpbGl0aWVzIHRoYXQgdXNicmVkaXJob3N0Ci0gcmVjZWl2
ZSB0aGUgc2FtZSAnaGVsbG8nIHJlc3BvbnNlCkZvciB0aGF0IHdlIGFuYWx5emUgJ2hlbGxvJyBz
ZW50IGJ5IFVTQiByZWRpciBwYXJzZXIgYW5kCmV4dHJhY3Qgc2V0IG9mIGNhcGFiaWxpdGllcyBm
cm9tIGl0IGFuZCB1cG9uIHJlY2VpdmUgb2YKJ2hlbGxvJyByZXNwb25zZSB3ZSBwcm92aWRlIGl0
IGFsc28gdG8gdGhlIHBhcnNlci4KV2hlbiBsaWJ1c2IgZGV2aWNlIGlzIHJlZGlyZWN0ZWQgdmlh
IGEgY2hhbm5lbCwgaW5zdGFuY2Ugb2YKdXNicmVkaXJob3N0IHNlcnZlcyBpdC4KV2hlbiBlbXVs
YXRlZCBkZXZpY2UgaXMgcmVkaXJlY3RlZCB2aWEgYSBjaGFubmVsLCBpbnN0YW5jZQpvZiB1c2Jy
ZWRpcnBhcnNlciBkb2VzIHRoZSBqb2IuCgpTaWduZWQtb2ZmLWJ5OiBZdXJpIEJlbmRpdG92aWNo
IDx5dXJpLmJlbmRpdG92aWNoQGRheW5peC5jb20+Ci0tLQogc3JjL3VzYi1iYWNrZW5kLmMgfCA2
MTcgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKy0tLQogMSBmaWxl
IGNoYW5nZWQsIDU4MSBpbnNlcnRpb25zKCspLCAzNiBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQg
YS9zcmMvdXNiLWJhY2tlbmQuYyBiL3NyYy91c2ItYmFja2VuZC5jCmluZGV4IDViNTJhNDBkLi45
MGUwMGYzYiAxMDA2NDQKLS0tIGEvc3JjL3VzYi1iYWNrZW5kLmMKKysrIGIvc3JjL3VzYi1iYWNr
ZW5kLmMKQEAgLTU3LDYgKzU3LDcgQEAgc3RydWN0IF9TcGljZVVzYkRldmljZQogICAgIFVzYkRl
dmljZUluZm9ybWF0aW9uIGRldmljZV9pbmZvOwogICAgIGJvb2wgY2FjaGVkX2lzb2Nocm9ub3Vz
X3ZhbGlkOwogICAgIGJvb2wgY2FjaGVkX2lzb2Nocm9ub3VzOworICAgIGdib29sZWFuIGVkZXZf
Y29uZmlndXJlZDsKIH07CiAKIHN0cnVjdCBfU3BpY2VVc2JCYWNrZW5kCkBAIC04MiwxMCArODMs
MjAgQEAgc3RydWN0IF9TcGljZVVzYkJhY2tlbmQKIHN0cnVjdCBfU3BpY2VVc2JCYWNrZW5kQ2hh
bm5lbAogewogICAgIHN0cnVjdCB1c2JyZWRpcmhvc3QgKnVzYnJlZGlyaG9zdDsKKyAgICBzdHJ1
Y3QgdXNicmVkaXJob3N0ICpoaWRkZW5faG9zdDsKKyAgICBzdHJ1Y3QgdXNicmVkaXJwYXJzZXIg
KnBhcnNlcjsKKyAgICBzdHJ1Y3QgdXNicmVkaXJwYXJzZXIgKmhpZGRlbl9wYXJzZXI7CiAgICAg
dWludDhfdCAqcmVhZF9idWY7CiAgICAgaW50IHJlYWRfYnVmX3NpemU7CiAgICAgc3RydWN0IHVz
YnJlZGlyZmlsdGVyX3J1bGUgKnJ1bGVzOwogICAgIGludCBydWxlc19jb3VudDsKKyAgICB1aW50
MzJfdCBob3N0X2NhcHM7CisgICAgdWludDMyX3QgcGFyc2VyX2luaXRfZG9uZSAgOiAxOworICAg
IHVpbnQzMl90IHBhcnNlcl93aXRoX2hlbGxvIDogMTsKKyAgICB1aW50MzJfdCBoZWxsb19kb25l
X3BhcnNlciA6IDE7CisgICAgdWludDMyX3QgaGVsbG9fc2VudCAgICAgICAgOiAxOworICAgIHVp
bnQzMl90IHJlamVjdGVkICAgICAgICAgIDogMTsKKyAgICB1aW50MzJfdCB3YWl0X2Rpc2Nvbm5l
Y3RfYWNrIDogMTsKICAgICBTcGljZVVzYkJhY2tlbmREZXZpY2UgKmF0dGFjaGVkOwogICAgIFNw
aWNlVXNicmVkaXJDaGFubmVsICp1c2JyZWRpcl9jaGFubmVsOwogICAgIFNwaWNlVXNiQmFja2Vu
ZCAqYmFja2VuZDsKQEAgLTM2MSw3ICszNzIsMTEgQEAgZ2Jvb2xlYW4gc3BpY2VfdXNiX2JhY2tl
bmRfZGV2aWNlX2lzb2NoKFNwaWNlVXNiQmFja2VuZERldmljZSAqZGV2KQogICAgICAgICByZXR1
cm4gZGV2LT5jYWNoZWRfaXNvY2hyb25vdXM7CiAgICAgfQogCi0gICAgZ19yZXR1cm5fdmFsX2lm
X2ZhaWwobGliZGV2ICE9IE5VTEwsIDApOworICAgIGdfcmV0dXJuX3ZhbF9pZl9mYWlsKGxpYmRl
diAhPSBOVUxMIHx8IGRldi0+ZWRldiAhPSBOVUxMLCAwKTsKKyAgICBpZiAoZGV2LT5lZGV2KSB7
CisgICAgICAgIC8qIGN1cnJlbnRseSB3ZSBkbyBub3QgZW11bGF0ZSBpc29jaCBkZXZpY2VzICov
CisgICAgICAgIHJldHVybiBGQUxTRTsKKyAgICB9CiAKICAgICByYyA9IGxpYnVzYl9nZXRfYWN0
aXZlX2NvbmZpZ19kZXNjcmlwdG9yKGxpYmRldiwgJmNvbmZfZGVzYyk7CiAgICAgaWYgKHJjKSB7
CkBAIC0zOTksMTMgKzQxNCwxNiBAQCBmcm9tIGJvdGggdGhlIG1haW4gdGhyZWFkIGFzIHdlbGwg
YXMgZnJvbSB0aGUgdXNiIGV2ZW50IGhhbmRsaW5nIHRocmVhZCAqLwogc3RhdGljIHZvaWQgdXNi
cmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2sodm9pZCAqdXNlcl9kYXRhKQogewogICAgIFNwaWNl
VXNiQmFja2VuZENoYW5uZWwgKmNoID0gdXNlcl9kYXRhOwotICAgIGlmICghY2gtPnVzYnJlZGly
aG9zdCkgewotICAgICAgICAvKiBqdXN0IHRvIGJlIG9uIHRoZSBzYWZlIHNpZGUgKi8KLSAgICAg
ICAgcmV0dXJuOwotICAgIH0KICAgICBpZiAoaXNfY2hhbm5lbF9yZWFkeShjaC0+dXNicmVkaXJf
Y2hhbm5lbCkpIHsKLSAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIC0+IHVzYnJlZGlyaG9z
dCIsIF9fRlVOQ1RJT05fXywgY2gpOwotICAgICAgICB1c2JyZWRpcmhvc3Rfd3JpdGVfZ3Vlc3Rf
ZGF0YShjaC0+dXNicmVkaXJob3N0KTsKKyAgICAgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsK
KyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAtPiB1c2JyZWRpcmhvc3QiLCBfX0ZV
TkNUSU9OX18sIGNoKTsKKyAgICAgICAgICAgIHVzYnJlZGlyaG9zdF93cml0ZV9ndWVzdF9kYXRh
KGNoLT51c2JyZWRpcmhvc3QpOworICAgICAgICB9IGVsc2UgaWYgKGNoLT5wYXJzZXIpIHsKKyAg
ICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAtPiBwYXJzZXIiLCBfX0ZVTkNUSU9OX18s
IGNoKTsKKyAgICAgICAgICAgIHVzYnJlZGlycGFyc2VyX2RvX3dyaXRlKGNoLT5wYXJzZXIpOwor
ICAgICAgICB9IGVsc2UgeworICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIChOT1Qg
QUNUSVZFKSIsIF9fRlVOQ1RJT05fXywgY2gpOworICAgICAgICB9CiAgICAgfSBlbHNlIHsKICAg
ICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIChub3QgcmVhZHkpIiwgX19GVU5DVElPTl9fLCBj
aCk7CiAgICAgfQpAQCAtNTYwLDEzICs1NzgsNTIgQEAgdm9pZCBzcGljZV91c2JfYmFja2VuZF9k
ZXZpY2VfdW5yZWYoU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkZXYpCiAgICAgfQogfQogCi1pbnQg
c3BpY2VfdXNiX2JhY2tlbmRfZGV2aWNlX2NoZWNrX2ZpbHRlcigKLSAgICBTcGljZVVzYkJhY2tl
bmREZXZpY2UgKmRldiwKLSAgICBjb25zdCBzdHJ1Y3QgdXNicmVkaXJmaWx0ZXJfcnVsZSAqcnVs
ZXMsCi0gICAgaW50IGNvdW50KQorc3RhdGljIGludCBjaGVja19lZGV2X2RldmljZV9maWx0ZXIo
U3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkZXYsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICBjb25zdCBzdHJ1Y3QgdXNicmVkaXJmaWx0ZXJfcnVsZSAqcnVsZXMsCisgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnQgY291bnQpCiB7Ci0gICAgcmV0dXJuIHVz
YnJlZGlyaG9zdF9jaGVja19kZXZpY2VfZmlsdGVyKAotICAgICAgICBydWxlcywgY291bnQsIGRl
di0+bGlidXNiX2RldmljZSwgMCk7CisgICAgU3BpY2VVc2JFbXVsYXRlZERldmljZSAqZWRldiA9
IGRldi0+ZWRldjsKKyAgICB1aW50OF90IGNsc1szMl0sIHN1YmNsc1szMl0sIHByb3RvWzMyXSwg
KmNmZywgaWZudW0gPSAwOworICAgIHVpbnQxNl90IHNpemUsIG9mZnNldCA9IDA7CisgICAgaWYg
KCFlZGV2KSB7CisgICAgICAgIHJldHVybiAxOworICAgIH0KKyAgICBpZiAoIWRldmljZV9vcHMo
ZWRldiktPmdldF9kZXNjcmlwdG9yKGVkZXYsIExJQlVTQl9EVF9DT05GSUcsIDAsICh2b2lkICoq
KSZjZmcsICZzaXplKSkgeworICAgICAgICByZXR1cm4gMTsKKyAgICB9CisgICAgd2hpbGUgKChv
ZmZzZXQgKyAxKSA8IHNpemUpIHsKKyAgICAgICAgdWludDhfdCBsZW4gID0gY2ZnW29mZnNldF07
CisgICAgICAgIHVpbnQ4X3QgdHlwZSA9IGNmZ1tvZmZzZXQgKyAxXTsKKyAgICAgICAgaWYgKChv
ZmZzZXQgKyBsZW4pID4gc2l6ZSkgeworICAgICAgICAgICAgYnJlYWs7CisgICAgICAgIH0KKyAg
ICAgICAgaWYgKHR5cGUgPT0gTElCVVNCX0RUX0lOVEVSRkFDRSkgeworICAgICAgICAgICAgY2xz
W2lmbnVtXSA9IGNmZ1tvZmZzZXQgKyA1XTsKKyAgICAgICAgICAgIHN1YmNsc1tpZm51bV0gPSBj
Zmdbb2Zmc2V0ICsgNl07CisgICAgICAgICAgICBwcm90b1tpZm51bV0gPSBjZmdbb2Zmc2V0ICsg
N107CisgICAgICAgICAgICBpZm51bSsrOworICAgICAgICB9CisgICAgICAgIG9mZnNldCArPSBs
ZW47CisgICAgfQorCisgICAgcmV0dXJuIHVzYnJlZGlyZmlsdGVyX2NoZWNrKHJ1bGVzLCBjb3Vu
dCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGV2LT5kZXZpY2VfaW5mby5jbGFz
cywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGV2LT5kZXZpY2VfaW5mby5zdWJj
bGFzcywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGV2LT5kZXZpY2VfaW5mby5w
cm90b2NvbCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xzLCBzdWJjbHMsIHBy
b3RvLCBpZm51bSwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGV2LT5kZXZpY2Vf
aW5mby52aWQsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRldi0+ZGV2aWNlX2lu
Zm8ucGlkLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXYtPmRldmljZV9pbmZv
LmJjZFVTQiwgMCk7Cit9CisKK2ludCBzcGljZV91c2JfYmFja2VuZF9kZXZpY2VfY2hlY2tfZmls
dGVyKFNwaWNlVXNiQmFja2VuZERldmljZSAqZGV2LAorICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgY29uc3Qgc3RydWN0IHVzYnJlZGlyZmlsdGVyX3J1bGUgKnJ1bGVz
LCBpbnQgY291bnQpCit7CisgICAgaWYgKGRldi0+bGlidXNiX2RldmljZSkgeworICAgICAgICBy
ZXR1cm4gdXNicmVkaXJob3N0X2NoZWNrX2RldmljZV9maWx0ZXIocnVsZXMsIGNvdW50LCBkZXYt
PmxpYnVzYl9kZXZpY2UsIDApOworICAgIH0gZWxzZSB7CisgICAgICAgIHJldHVybiBjaGVja19l
ZGV2X2RldmljZV9maWx0ZXIoZGV2LCBydWxlcywgY291bnQpOworICAgIH0KIH0KIAogc3RhdGlj
IGludCB1c2JyZWRpcl9yZWFkX2NhbGxiYWNrKHZvaWQgKnVzZXJfZGF0YSwgdWludDhfdCAqZGF0
YSwgaW50IGNvdW50KQpAQCAtNjMwLDYgKzY4NywxNyBAQCBzdGF0aWMgaW50IHVzYnJlZGlyX3dy
aXRlX2NhbGxiYWNrKHZvaWQgKnVzZXJfZGF0YSwgdWludDhfdCAqZGF0YSwgaW50IGNvdW50KQog
ICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gdXNlcl9kYXRhOwogICAgIGludCByZXM7
CiAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwLCAlZCBieXRlcyIsIF9fRlVOQ1RJT05fXywgY2gs
IGNvdW50KTsKKyAgICBpZiAoIWNoLT5oZWxsb19zZW50KSB7CisgICAgICAgIC8qIGhlbGxvIGlz
IHNob3J0IGhlYWRlciAoMTIpICsgaGVsbG8gc3RydWN0ICg2NCkgKyBjYXBhYmlsaXRpZXMgKDQp
ICovCisgICAgICAgIGludCBoZWxsb19zaXplID0gc2l6ZW9mKHN0cnVjdCB1c2JfcmVkaXJfaGVh
ZGVyKSArIHNpemVvZihzdHJ1Y3QgdXNiX3JlZGlyX2hlbGxvX2hlYWRlcik7CisgICAgICAgIGNo
LT5oZWxsb19zZW50ID0gMTsKKyAgICAgICAgaWYgKGNvdW50ID09IGhlbGxvX3NpemUpIHsKKyAg
ICAgICAgICAgIG1lbWNweSgmY2gtPmhvc3RfY2FwcywgZGF0YSArIGhlbGxvX3NpemUgLSBzaXpl
b2YoY2gtPmhvc3RfY2FwcyksCisgICAgICAgICAgICAgICAgICAgc2l6ZW9mKGNoLT5ob3N0X2Nh
cHMpKTsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCwgc2VuZGluZyBmaXJzdCBo
ZWxsbywgY2FwcyAlMDhYIiwKKyAgICAgICAgICAgICAgICAgICAgICAgIF9fRlVOQ1RJT05fXywg
Y2gsIGNoLT5ob3N0X2NhcHMpOworICAgICAgICB9CisgICAgfQogICAgIHJlcyA9IHNwaWNlX3Vz
YnJlZGlyX3dyaXRlKGNoLT51c2JyZWRpcl9jaGFubmVsLCBkYXRhLCBjb3VudCk7CiAgICAgcmV0
dXJuIHJlczsKIH0KQEAgLTY1MCw2ICs3MTgsMjcgQEAgaW50IHNwaWNlX3VzYl9iYWNrZW5kX3Jl
YWRfZ3Vlc3RfZGF0YShTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwgdWludDhfdCAqZGF0YSwK
ICAgICBjaC0+cmVhZF9idWZfc2l6ZSA9IGNvdW50OwogICAgIGlmIChjaC0+dXNicmVkaXJob3N0
KSB7CiAgICAgICAgIHJlcyA9IHVzYnJlZGlyaG9zdF9yZWFkX2d1ZXN0X2RhdGEoY2gtPnVzYnJl
ZGlyaG9zdCk7CisgICAgICAgIGlmICghY2gtPmhlbGxvX2RvbmVfcGFyc2VyKSB7CisgICAgICAg
ICAgICBpbnQgcmVzX3BhcnNlcjsKKyAgICAgICAgICAgIC8qIHVzYnJlZGlyaG9zdCBzaG91bGQg
Y29uc3VtZSBoZWxsbyByZXNwb25zZSAqLworICAgICAgICAgICAgZ19yZXR1cm5fdmFsX2lmX2Zh
aWwoY2gtPnJlYWRfYnVmID09IE5VTEwsIFVTQl9SRURJUl9FUlJPUl9SRUFEX1BBUlNFKTsKKwor
ICAgICAgICAgICAgY2gtPnJlYWRfYnVmID0gZGF0YTsKKyAgICAgICAgICAgIGNoLT5yZWFkX2J1
Zl9zaXplID0gY291bnQ7CisgICAgICAgICAgICBjaC0+aGVsbG9fZG9uZV9wYXJzZXIgPSAxOwor
ICAgICAgICAgICAgaWYgKGNoLT5hdHRhY2hlZCAmJiBjaC0+YXR0YWNoZWQtPmVkZXYpIHsKKyAg
ICAgICAgICAgICAgICAvKiBjYXNlIG9mIENEIHNoYXJpbmcgb24gY29ubmVjdCAqLworICAgICAg
ICAgICAgICAgIGNoLT51c2JyZWRpcmhvc3QgPSBOVUxMOworICAgICAgICAgICAgICAgIGNoLT5w
YXJzZXIgPSBjaC0+aGlkZGVuX3BhcnNlcjsKKyAgICAgICAgICAgICAgICBTUElDRV9ERUJVRygi
JXM6IHN3aXRjaCAlcCB0byBwYXJzZXIiLCBfX0ZVTkNUSU9OX18sIGNoKTsKKyAgICAgICAgICAg
IH0KKyAgICAgICAgICAgIHJlc19wYXJzZXIgPSB1c2JyZWRpcnBhcnNlcl9kb19yZWFkKGNoLT5o
aWRkZW5fcGFyc2VyKTsKKyAgICAgICAgICAgIGlmIChyZXMgPj0gMCkgeworICAgICAgICAgICAg
ICAgIHJlcyA9IHJlc19wYXJzZXI7CisgICAgICAgICAgICB9CisgICAgICAgIH0KKyAgICB9IGVs
c2UgaWYgKGNoLT5wYXJzZXIpIHsKKyAgICAgICAgcmVzID0gdXNicmVkaXJwYXJzZXJfZG9fcmVh
ZChjaC0+cGFyc2VyKTsKICAgICB9IGVsc2UgewogICAgICAgICByZXMgPSBVU0JfUkVESVJfRVJS
T1JfSU87CiAgICAgfQpAQCAtNjcwLDYgKzc1OSwxMSBAQCBpbnQgc3BpY2VfdXNiX2JhY2tlbmRf
cmVhZF9ndWVzdF9kYXRhKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLCB1aW50OF90ICpkYXRh
LAogICAgIH0KICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAsICVkIGJ5dGVzLCByZXMgJWQiLCBf
X0ZVTkNUSU9OX18sIGNoLCBjb3VudCwgcmVzKTsKIAorICAgIGlmIChjaC0+cmVqZWN0ZWQpIHsK
KyAgICAgICAgY2gtPnJlamVjdGVkID0gMDsKKyAgICAgICAgcmVzID0gVVNCX1JFRElSX0VSUk9S
X0RFVl9SRUpFQ1RFRDsKKyAgICB9CisKICAgICByZXR1cm4gcmVzOwogfQogCkBAIC02OTksMTMg
Kzc5Myw0MjcgQEAgR0Vycm9yICpzcGljZV91c2JfYmFja2VuZF9nZXRfZXJyb3JfZGV0YWlscyhp
bnQgZXJyb3JfY29kZSwgZ2NoYXIgKmRlc2MpCiB2b2lkIHNwaWNlX3VzYl9iYWNrZW5kX3JldHVy
bl93cml0ZV9kYXRhKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLCB2b2lkICpkYXRhKQogewog
ICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7Ci0gICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAl
cCIsIF9fRlVOQ1RJT05fXywgY2gpOworICAgICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAgLT4g
dXNicmVkaXJob3N0IiwgX19GVU5DVElPTl9fLCBjaCk7CiAgICAgICAgIHVzYnJlZGlyaG9zdF9m
cmVlX3dyaXRlX2J1ZmZlcihjaC0+dXNicmVkaXJob3N0LCBkYXRhKTsKKyAgICB9IGVsc2UgaWYg
KGNoLT5wYXJzZXIpIHsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIC0+IHBhcnNlciIs
IF9fRlVOQ1RJT05fXywgY2gpOworICAgICAgICB1c2JyZWRpcnBhcnNlcl9mcmVlX3dyaXRlX2J1
ZmZlcihjaC0+cGFyc2VyLCBkYXRhKTsKICAgICB9IGVsc2UgewogICAgICAgICBTUElDRV9ERUJV
RygiJXMgY2ggJXAgLSBOT0JPRFkgVE8gQ0FMTCIsIF9fRlVOQ1RJT05fXywgY2gpOwogICAgIH0K
IH0KIAorc3RhdGljIHZvaWQKK3VzYnJlZGlyX2NvbnRyb2xfcGFja2V0KHZvaWQgKnByaXYsIHVp
bnQ2NF90IGlkLCBzdHJ1Y3QgdXNiX3JlZGlyX2NvbnRyb2xfcGFja2V0X2hlYWRlciAqaCwKKyAg
ICAgICAgICAgICAgICAgICAgICAgIHVpbnQ4X3QgKmRhdGEsIGludCBkYXRhX2xlbikKK3sKKyAg
ICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU3BpY2VVc2JCYWNrZW5k
RGV2aWNlICpkID0gY2gtPmF0dGFjaGVkOworICAgIFNwaWNlVXNiRW11bGF0ZWREZXZpY2UgKmVk
ZXYgPSBkID8gZC0+ZWRldiA6IE5VTEw7CisgICAgc3RydWN0IHVzYl9yZWRpcl9jb250cm9sX3Bh
Y2tldF9oZWFkZXIgcmVzcG9uc2UgPSAqaDsKKyAgICB1aW50OF90IHJlcXR5cGUgPSBoLT5yZXF1
ZXN0dHlwZSAmIDB4N2Y7CisgICAgZ2Jvb2xlYW4gZG9uZSA9IEZBTFNFOworICAgIHZvaWQgKm91
dF9idWZmZXIgPSBOVUxMOworCisgICAgcmVzcG9uc2Uuc3RhdHVzID0gdXNiX3JlZGlyX3N0YWxs
OworICAgIFNQSUNFX0RFQlVHKCIlcyAlcDogVFJWSUwgJTAyWCAlMDJYICUwNFggJTA0WCAlMDRY
IiwKKyAgICAgICAgICAgICAgICBfX0ZVTkNUSU9OX18sCisgICAgICAgICAgICAgICAgY2gsIGgt
PnJlcXVlc3R0eXBlLCBoLT5yZXF1ZXN0LAorICAgICAgICAgICAgICAgIGgtPnZhbHVlLCBoLT5p
bmRleCwgaC0+bGVuZ3RoKTsKKworICAgIGlmICghZWRldikgeworICAgICAgICBTUElDRV9ERUJV
RygiJXM6IGRldmljZSBub3QgYXR0YWNoZWQiLCBfX0ZVTkNUSU9OX18pOworICAgICAgICByZXNw
b25zZS5zdGF0dXMgPSB1c2JfcmVkaXJfaW9lcnJvcjsKKyAgICAgICAgZG9uZSA9IFRSVUU7Cisg
ICAgfSBlbHNlIGlmIChyZXF0eXBlID09IChMSUJVU0JfUkVRVUVTVF9UWVBFX1NUQU5EQVJEIHwg
TElCVVNCX1JFQ0lQSUVOVF9ERVZJQ0UpICYmCisgICAgICAgICAgICAgICBoLT5yZXF1ZXN0ID09
IExJQlVTQl9SRVFVRVNUX0dFVF9ERVNDUklQVE9SKSB7CisgICAgICAgIHVpbnQxNl90IHNpemU7
CisgICAgICAgIGRvbmUgPSBkZXZpY2Vfb3BzKGVkZXYpLT5nZXRfZGVzY3JpcHRvcihlZGV2LCBo
LT52YWx1ZSA+PiA4LCBoLT52YWx1ZSAmIDB4ZmYsCisgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAmb3V0X2J1ZmZlciwgJnNpemUpOworICAgICAgICByZXNw
b25zZS5sZW5ndGggPSBzaXplOworICAgICAgICBpZiAoZG9uZSkgeworICAgICAgICAgICAgcmVz
cG9uc2Uuc3RhdHVzID0gMDsKKyAgICAgICAgfQorICAgICAgICBkb25lID0gVFJVRTsKKyAgICB9
CisKKyAgICBpZiAoIWRvbmUpIHsKKyAgICAgICAgZGV2aWNlX29wcyhlZGV2KS0+Y29udHJvbF9y
ZXF1ZXN0KGVkZXYsIGRhdGEsIGRhdGFfbGVuLCAmcmVzcG9uc2UsICZvdXRfYnVmZmVyKTsKKyAg
ICAgICAgZG9uZSA9IFRSVUU7CisgICAgfQorCisgICAgaWYgKHJlc3BvbnNlLnN0YXR1cykgewor
ICAgICAgICByZXNwb25zZS5sZW5ndGggPSAwOworICAgIH0gZWxzZSBpZiAocmVzcG9uc2UubGVu
Z3RoID4gaC0+bGVuZ3RoKSB7CisgICAgICAgIHJlc3BvbnNlLmxlbmd0aCA9IGgtPmxlbmd0aDsK
KyAgICB9CisKKyAgICBTUElDRV9ERUJVRygiJXMgcmVzcG9uZGluZyB3aXRoIHBheWxvYWQgb2Yg
JTAyWCwgc3RhdHVzICVYIiwKKyAgICAgICAgICAgICAgICBfX0ZVTkNUSU9OX18sIHJlc3BvbnNl
Lmxlbmd0aCwgcmVzcG9uc2Uuc3RhdHVzKTsKKyAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2NvbnRy
b2xfcGFja2V0KGNoLT5wYXJzZXIsIGlkLCAmcmVzcG9uc2UsCisgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5sZW5ndGggPyBvdXRfYnVmZmVyIDogTlVMTCwK
KyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmxlbmd0aCk7
CisKKyAgICB1c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFjayhjaCk7CisgICAgdXNicmVkaXJw
YXJzZXJfZnJlZV9wYWNrZXRfZGF0YShjaC0+cGFyc2VyLCBkYXRhKTsKK30KKworc3RhdGljIHZv
aWQKK3VzYnJlZGlyX2J1bGtfcGFja2V0KHZvaWQgKnByaXYsIHVpbnQ2NF90IGlkLCBzdHJ1Y3Qg
dXNiX3JlZGlyX2J1bGtfcGFja2V0X2hlYWRlciAqaCwKKyAgICAgICAgICAgICAgICAgICAgIHVp
bnQ4X3QgKmRhdGEsIGludCBkYXRhX2xlbikKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVs
ICpjaCA9IHByaXY7CisgICAgU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkID0gY2gtPmF0dGFjaGVk
OworICAgIFNwaWNlVXNiRW11bGF0ZWREZXZpY2UgKmVkZXYgPSBkID8gZC0+ZWRldiA6IE5VTEw7
CisgICAgc3RydWN0IHVzYl9yZWRpcl9idWxrX3BhY2tldF9oZWFkZXIgaG91dCA9ICpoOworICAg
IHVpbnQzMl90IGxlbiA9IChoLT5sZW5ndGhfaGlnaCA8PCAxNikgfCBoLT5sZW5ndGg7CisgICAg
U1BJQ0VfREVCVUcoIiVzICVwOiBlcCAlWCwgbGVuICV1LCBpZCAlIiBHX0dVSU5UNjRfRk9STUFU
LCBfX0ZVTkNUSU9OX18sCisgICAgICAgICAgICAgICAgY2gsIGgtPmVuZHBvaW50LCBsZW4sIGlk
KTsKKworICAgIGlmICghZWRldikgeworICAgICAgICBTUElDRV9ERUJVRygiJXM6IGRldmljZSBu
b3QgYXR0YWNoZWQiLCBfX0ZVTkNUSU9OX18pOworICAgICAgICBob3V0LnN0YXR1cyA9IHVzYl9y
ZWRpcl9pb2Vycm9yOworICAgICAgICBob3V0Lmxlbmd0aCA9IGhvdXQubGVuZ3RoX2hpZ2ggPSAw
OworICAgICAgICBTUElDRV9ERUJVRygiJXM6IHJlc3BvbmRpbmcgd2l0aCBaTFAgc3RhdHVzICVk
IiwgX19GVU5DVElPTl9fLCBob3V0LnN0YXR1cyk7CisgICAgfSBlbHNlIGlmIChoLT5lbmRwb2lu
dCAmIExJQlVTQl9FTkRQT0lOVF9JTikgeworICAgICAgICBpZiAoZGV2aWNlX29wcyhlZGV2KS0+
YnVsa19pbl9yZXF1ZXN0KGVkZXYsIGlkLCAmaG91dCkpIHsKKyAgICAgICAgICAgIHVzYnJlZGly
cGFyc2VyX2ZyZWVfcGFja2V0X2RhdGEoY2gtPnBhcnNlciwgZGF0YSk7CisgICAgICAgICAgICAv
KiBjb21wbGV0aW9uIGlzIGFzeW5jaHJvbm91cyAqLworICAgICAgICAgICAgcmV0dXJuOworICAg
ICAgICB9CisgICAgfSBlbHNlIHsKKyAgICAgICAgaG91dC5zdGF0dXMgPSB1c2JfcmVkaXJfc3Rh
bGw7CisgICAgICAgIGRldmljZV9vcHMoZWRldiktPmJ1bGtfb3V0X3JlcXVlc3QoZWRldiwgaC0+
ZW5kcG9pbnQsIGRhdGEsIGRhdGFfbGVuLCAmaG91dC5zdGF0dXMpOworICAgICAgICBTUElDRV9E
RUJVRygiJXM6IHJlc3BvbmRpbmcgc3RhdHVzICVkIiwgX19GVU5DVElPTl9fLCBob3V0LnN0YXR1
cyk7CisgICAgfQorCisgICAgdXNicmVkaXJwYXJzZXJfc2VuZF9idWxrX3BhY2tldChjaC0+cGFy
c2VyLCBpZCwgJmhvdXQsIE5VTEwsIDApOworICAgIHVzYnJlZGlycGFyc2VyX2ZyZWVfcGFja2V0
X2RhdGEoY2gtPnBhcnNlciwgZGF0YSk7CisgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJh
Y2soY2gpOworfQorCitzdGF0aWMgdm9pZCB1c2JyZWRpcl9kZXZpY2VfcmVzZXQodm9pZCAqcHJp
dikKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgU3BpY2VV
c2JCYWNrZW5kRGV2aWNlICpkID0gY2gtPmF0dGFjaGVkOworICAgIFNwaWNlVXNiRW11bGF0ZWRE
ZXZpY2UgKmVkZXYgPSBkID8gZC0+ZWRldiA6IE5VTEw7CisgICAgU1BJQ0VfREVCVUcoIiVzIGNo
ICVwIiwgX19GVU5DVElPTl9fLCBjaCk7CisgICAgaWYgKGVkZXYpIHsKKyAgICAgICAgZGV2aWNl
X29wcyhlZGV2KS0+cmVzZXQoZWRldik7CisgICAgfQorfQorCitzdGF0aWMgdm9pZAordXNicmVk
aXJfaW50ZXJmYWNlX2luZm8odm9pZCAqcHJpdiwgc3RydWN0IHVzYl9yZWRpcl9pbnRlcmZhY2Vf
aW5mb19oZWFkZXIgKmludGVyZmFjZV9pbmZvKQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5u
ZWwgKmNoID0gcHJpdjsKKyAgICBTUElDRV9ERUJVRygiJXMgbm90IGltcGxlbWVudGVkICVwIiwg
X19GVU5DVElPTl9fLCBjaCk7Cit9CisKK3N0YXRpYyB2b2lkCit1c2JyZWRpcl9pbnRlcmZhY2Vf
ZXBfaW5mbyh2b2lkICpwcml2LCBzdHJ1Y3QgdXNiX3JlZGlyX2VwX2luZm9faGVhZGVyICplcF9p
bmZvKQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAgICBTUElD
RV9ERUJVRygiJXMgbm90IGltcGxlbWVudGVkICVwIiwgX19GVU5DVElPTl9fLCBjaCk7Cit9CisK
K3N0YXRpYyB2b2lkCit1c2JyZWRpcl9zZXRfY29uZmlndXJhdGlvbih2b2lkICpwcml2LCB1aW50
NjRfdCBpZCwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cnVjdCB1c2JfcmVkaXJfc2V0
X2NvbmZpZ3VyYXRpb25faGVhZGVyICpzZXRfY29uZmlndXJhdGlvbikKK3sKKyAgICBTcGljZVVz
YkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7CisgICAgc3RydWN0IHVzYl9yZWRpcl9jb25maWd1
cmF0aW9uX3N0YXR1c19oZWFkZXIgaDsKKyAgICBoLnN0YXR1cyA9IDA7CisgICAgaC5jb25maWd1
cmF0aW9uID0gc2V0X2NvbmZpZ3VyYXRpb24tPmNvbmZpZ3VyYXRpb247CisgICAgU1BJQ0VfREVC
VUcoIiVzIGNoICVwLCBjZmcgJWQiLCBfX0ZVTkNUSU9OX18sIGNoLCBoLmNvbmZpZ3VyYXRpb24p
OworICAgIGlmIChjaC0+YXR0YWNoZWQpIHsKKyAgICAgICAgY2gtPmF0dGFjaGVkLT5lZGV2X2Nv
bmZpZ3VyZWQgPSBoLmNvbmZpZ3VyYXRpb24gIT0gMDsKKyAgICB9CisgICAgdXNicmVkaXJwYXJz
ZXJfc2VuZF9jb25maWd1cmF0aW9uX3N0YXR1cyhjaC0+cGFyc2VyLCBpZCwgJmgpOworICAgIHVz
YnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsKK30KKworc3RhdGljIHZvaWQgdXNicmVk
aXJfZ2V0X2NvbmZpZ3VyYXRpb24odm9pZCAqcHJpdiwgdWludDY0X3QgaWQpCit7CisgICAgU3Bp
Y2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIHN0cnVjdCB1c2JfcmVkaXJfY29u
ZmlndXJhdGlvbl9zdGF0dXNfaGVhZGVyIGg7CisgICAgaC5zdGF0dXMgPSAwOworICAgIGguY29u
ZmlndXJhdGlvbiA9IGNoLT5hdHRhY2hlZCAmJiBjaC0+YXR0YWNoZWQtPmVkZXZfY29uZmlndXJl
ZDsKKyAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAsIGNmZyAlZCIsIF9fRlVOQ1RJT05fXywgY2gs
IGguY29uZmlndXJhdGlvbik7CisgICAgdXNicmVkaXJwYXJzZXJfc2VuZF9jb25maWd1cmF0aW9u
X3N0YXR1cyhjaC0+cGFyc2VyLCBpZCwgJmgpOworICAgIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2Nh
bGxiYWNrKGNoKTsKK30KKworc3RhdGljIHZvaWQKK3VzYnJlZGlyX3NldF9hbHRfc2V0dGluZyh2
b2lkICpwcml2LCB1aW50NjRfdCBpZCwgc3RydWN0IHVzYl9yZWRpcl9zZXRfYWx0X3NldHRpbmdf
aGVhZGVyICpzKQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAg
ICBzdHJ1Y3QgdXNiX3JlZGlyX2FsdF9zZXR0aW5nX3N0YXR1c19oZWFkZXIgc2g7CisgICAgc2gu
c3RhdHVzID0gKCFzLT5pbnRlcmZhY2UgJiYgIXMtPmFsdCkgPyAwIDogdXNiX3JlZGlyX3N0YWxs
OworICAgIHNoLmludGVyZmFjZSA9IHMtPmludGVyZmFjZTsKKyAgICBzaC5hbHQgPSBzLT5hbHQ7
CisgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwLCAlZDolZCIsIF9fRlVOQ1RJT05fXywgY2gsIHMt
PmludGVyZmFjZSwgcy0+YWx0KTsKKyAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2FsdF9zZXR0aW5n
X3N0YXR1cyhjaC0+cGFyc2VyLCBpZCwgJnNoKTsKKyAgICB1c2JyZWRpcl93cml0ZV9mbHVzaF9j
YWxsYmFjayhjaCk7Cit9CisKK3N0YXRpYyB2b2lkCit1c2JyZWRpcl9nZXRfYWx0X3NldHRpbmco
dm9pZCAqcHJpdiwgdWludDY0X3QgaWQsIHN0cnVjdCB1c2JfcmVkaXJfZ2V0X2FsdF9zZXR0aW5n
X2hlYWRlciAqcykKK3sKKyAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCA9IHByaXY7Cisg
ICAgc3RydWN0IHVzYl9yZWRpcl9hbHRfc2V0dGluZ19zdGF0dXNfaGVhZGVyIHNoOworICAgIHNo
LnN0YXR1cyA9IChzLT5pbnRlcmZhY2UgPT0gMCkgPyAwIDogdXNiX3JlZGlyX3N0YWxsOworICAg
IHNoLmludGVyZmFjZSA9IHMtPmludGVyZmFjZTsKKyAgICBzaC5hbHQgPSAwOworICAgIFNQSUNF
X0RFQlVHKCIlcyBjaCAlcCwgaWYgJWQiLCBfX0ZVTkNUSU9OX18sIGNoLCBzLT5pbnRlcmZhY2Up
OworICAgIHVzYnJlZGlycGFyc2VyX3NlbmRfYWx0X3NldHRpbmdfc3RhdHVzKGNoLT5wYXJzZXIs
IGlkLCAmc2gpOworICAgIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsKK30KKwor
c3RhdGljIHZvaWQgdXNicmVkaXJfY2FuY2VsX2RhdGEodm9pZCAqcHJpdiwgdWludDY0X3QgaWQp
Cit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2OworICAgIFNwaWNlVXNi
QmFja2VuZERldmljZSAqZCA9IGNoLT5hdHRhY2hlZDsKKyAgICBTcGljZVVzYkVtdWxhdGVkRGV2
aWNlICplZGV2ID0gZCA/IGQtPmVkZXYgOiBOVUxMOworICAgIGlmICghZWRldikgeworICAgICAg
ICBTUElDRV9ERUJVRygiJXM6IGRldmljZSBub3QgYXR0YWNoZWQiLCBfX0ZVTkNUSU9OX18pOwor
ICAgICAgICByZXR1cm47CisgICAgfQorICAgIGRldmljZV9vcHMoZWRldiktPmNhbmNlbF9yZXF1
ZXN0KGVkZXYsIGlkKTsKK30KKworc3RhdGljIHZvaWQgdXNicmVkaXJfZmlsdGVyX3JlamVjdCh2
b2lkICpwcml2KQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gcHJpdjsKKyAg
ICBTUElDRV9ERUJVRygiJXMgJXAiLCBfX0ZVTkNUSU9OX18sIGNoKTsKKyAgICBjaC0+cmVqZWN0
ZWQgPSAxOworfQorCisvKiBOb3RlIHRoYXQgdGhlIG93bmVyc2hpcCBvZiB0aGUgcnVsZXMgYXJy
YXkgaXMgcGFzc2VkIG9uIHRvIHRoZSBjYWxsYmFjay4gKi8KK3N0YXRpYyB2b2lkCit1c2JyZWRp
cl9maWx0ZXJfZmlsdGVyKHZvaWQgKnByaXYsIHN0cnVjdCB1c2JyZWRpcmZpbHRlcl9ydWxlICpy
LCBpbnQgY291bnQpCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2ggPSBwcml2Owor
ICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAlZCBmaWx0ZXJzIiwgX19GVU5DVElPTl9fLCBjaCwg
Y291bnQpOworCisgICAgZnJlZShjaC0+cnVsZXMpOworCisgICAgY2gtPnJ1bGVzID0gcjsKKyAg
ICBjaC0+cnVsZXNfY291bnQgPSBjb3VudDsKKyAgICBpZiAoY291bnQpIHsKKyAgICAgICAgaW50
IGk7CisgICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CisgICAgICAgICAgICBT
UElDRV9ERUJVRygiJXMgY2xhc3MgJWQsICVYOiVYIiwKKyAgICAgICAgICAgICAgICByW2ldLmFs
bG93ID8gImFsbG93ZWQiIDogImRlbmllZCIsIHJbaV0uZGV2aWNlX2NsYXNzLAorICAgICAgICAg
ICAgICAgICh1aW50MzJfdClyW2ldLnZlbmRvcl9pZCwgKHVpbnQzMl90KXJbaV0ucHJvZHVjdF9p
ZCk7CisgICAgICAgIH0KKyAgICB9Cit9CisKK3N0YXRpYyB2b2lkIHVzYnJlZGlyX2RldmljZV9k
aXNjb25uZWN0X2Fjayh2b2lkICpwcml2KQoreworICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwg
KmNoID0gcHJpdjsKKyAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAiLCBfX0ZVTkNUSU9OX18sIGNo
KTsKKyAgICBpZiAoY2gtPnBhcnNlciAmJiBjaC0+d2FpdF9kaXNjb25uZWN0X2FjaykgeworICAg
ICAgICBjaC0+cGFyc2VyID0gTlVMTDsKKyAgICAgICAgU1BJQ0VfREVCVUcoIiVzIHN3aXRjaCB0
byB1c2JyZWRpcmhvc3QiLCBfX0ZVTkNUSU9OX18pOworICAgICAgICBjaC0+dXNicmVkaXJob3N0
ID0gY2gtPmhpZGRlbl9ob3N0OworICAgIH0KKyAgICBjaC0+d2FpdF9kaXNjb25uZWN0X2FjayA9
IDA7Cit9CisKK3N0YXRpYyB2b2lkCit1c2JyZWRpcl9oZWxsbyh2b2lkICpwcml2LCBzdHJ1Y3Qg
dXNiX3JlZGlyX2hlbGxvX2hlYWRlciAqaGVsbG8pCit7CisgICAgU3BpY2VVc2JCYWNrZW5kQ2hh
bm5lbCAqY2ggPSBwcml2OworICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqZCA9IGNoLT5hdHRh
Y2hlZDsKKyAgICBTcGljZVVzYkVtdWxhdGVkRGV2aWNlICplZGV2ID0gZCA/IGQtPmVkZXYgOiBO
VUxMOworICAgIHN0cnVjdCB1c2JfcmVkaXJfZGV2aWNlX2Nvbm5lY3RfaGVhZGVyIGRldmljZV9j
b25uZWN0OworICAgIHN0cnVjdCB1c2JfcmVkaXJfZXBfaW5mb19oZWFkZXIgZXBfaW5mbyA9IHsg
MCB9OworICAgIHN0cnVjdCB1c2JfcmVkaXJfaW50ZXJmYWNlX2luZm9faGVhZGVyIGludGVyZmFj
ZV9pbmZvID0geyAwIH07CisgICAgdWludDhfdCAqY2ZnOworICAgIHVpbnQxNl90IHNpemUsIG9m
ZnNldCA9IDA7CisgICAgU1BJQ0VfREVCVUcoIiVzICVwICVzYXR0YWNoZWQgJXMiLCBfX0ZVTkNU
SU9OX18sIGNoLAorICAgICAgICBlZGV2ID8gIiIgOiAibm90ICIsICBoZWxsbyA/ICIiIDogIihp
bnRlcm5hbCkiKTsKKworICAgIGlmIChoZWxsbykgeworICAgICAgICBjaC0+aGVsbG9fZG9uZV9w
YXJzZXIgPSAxOworICAgIH0KKyAgICBpZiAoIWVkZXYpIHsKKyAgICAgICAgcmV0dXJuOworICAg
IH0KKyAgICBpZiAoIWRldmljZV9vcHMoZWRldiktPmdldF9kZXNjcmlwdG9yKGVkZXYsIExJQlVT
Ql9EVF9DT05GSUcsIDAsICh2b2lkICoqKSZjZmcsICZzaXplKSkgeworICAgICAgICByZXR1cm47
CisgICAgfQorICAgIHdoaWxlICgob2Zmc2V0ICsgMSkgPCBzaXplKSB7CisgICAgICAgIHVpbnQ4
X3QgbGVuICA9IGNmZ1tvZmZzZXRdOworICAgICAgICB1aW50OF90IHR5cGUgPSBjZmdbb2Zmc2V0
ICsgMV07CisgICAgICAgIGlmICgob2Zmc2V0ICsgbGVuKSA+IHNpemUpIHsKKyAgICAgICAgICAg
IGJyZWFrOworICAgICAgICB9CisgICAgICAgIGlmICh0eXBlID09IExJQlVTQl9EVF9JTlRFUkZB
Q0UpIHsKKyAgICAgICAgICAgIHVpbnQzMl90IGkgPSBpbnRlcmZhY2VfaW5mby5pbnRlcmZhY2Vf
Y291bnQ7CisgICAgICAgICAgICB1aW50OF90IGNsYXNzLCBzdWJjbGFzcywgcHJvdG9jb2w7Cisg
ICAgICAgICAgICBjbGFzcyA9IGNmZ1tvZmZzZXQgKyA1XTsKKyAgICAgICAgICAgIHN1YmNsYXNz
ID0gY2ZnW29mZnNldCArIDZdOworICAgICAgICAgICAgcHJvdG9jb2wgPSBjZmdbb2Zmc2V0ICsg
N107CisgICAgICAgICAgICBpbnRlcmZhY2VfaW5mby5pbnRlcmZhY2VfY2xhc3NbaV0gPSBjbGFz
czsKKyAgICAgICAgICAgIGludGVyZmFjZV9pbmZvLmludGVyZmFjZV9zdWJjbGFzc1tpXSA9IHN1
YmNsYXNzOworICAgICAgICAgICAgaW50ZXJmYWNlX2luZm8uaW50ZXJmYWNlX3Byb3RvY29sW2ld
ID0gcHJvdG9jb2w7CisgICAgICAgICAgICBpbnRlcmZhY2VfaW5mby5pbnRlcmZhY2VfY291bnQr
KzsKKyAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBJRiVkOiAlZC8lZC8lZCIsIF9fRlVOQ1RJ
T05fXywgaSwgY2xhc3MsIHN1YmNsYXNzLCBwcm90b2NvbCk7CisgICAgICAgIH0gZWxzZSBpZiAo
dHlwZSA9PSBMSUJVU0JfRFRfRU5EUE9JTlQpIHsKKyAgICAgICAgICAgIHVpbnQ4X3QgYWRkcmVz
cyA9IGNmZ1tvZmZzZXQgKyAyXTsKKyAgICAgICAgICAgIHVpbnQxNl90IG1heF9wYWNrZXRfc2l6
ZSA9IDB4MTAwICogY2ZnW29mZnNldCArIDVdICsgY2ZnW29mZnNldCArIDRdOworICAgICAgICAg
ICAgdWludDhfdCBpbmRleCA9IGFkZHJlc3MgJiAweGY7CisgICAgICAgICAgICBpZiAoYWRkcmVz
cyAmIDB4ODApIGluZGV4ICs9IDB4MTA7CisgICAgICAgICAgICBlcF9pbmZvLnR5cGVbaW5kZXhd
ID0gY2ZnW29mZnNldCArIDNdICYgMHgzOworICAgICAgICAgICAgZXBfaW5mby5tYXhfcGFja2V0
X3NpemVbaW5kZXhdID0gbWF4X3BhY2tldF9zaXplOworICAgICAgICAgICAgU1BJQ0VfREVCVUco
IiVzIEVQWyUwMlhdOiAlZC8lZCIsIF9fRlVOQ1RJT05fXywgaW5kZXgsIGVwX2luZm8udHlwZVtp
bmRleF0sIG1heF9wYWNrZXRfc2l6ZSk7CisgICAgICAgIH0KKyAgICAgICAgb2Zmc2V0ICs9IGxl
bjsKKyAgICB9CisKKyAgICB1c2JyZWRpcnBhcnNlcl9zZW5kX2ludGVyZmFjZV9pbmZvKGNoLT5w
YXJzZXIsICZpbnRlcmZhY2VfaW5mbyk7CisgICAgdXNicmVkaXJwYXJzZXJfc2VuZF9lcF9pbmZv
KGNoLT5wYXJzZXIsICZlcF9pbmZvKTsKKworICAgIGRldmljZV9jb25uZWN0LmRldmljZV9jbGFz
cyA9IDA7IC8vZC0+ZGV2aWNlX2luZm8uY2xhc3M7CisgICAgZGV2aWNlX2Nvbm5lY3QuZGV2aWNl
X3N1YmNsYXNzID0gMDsgLy9kLT5kZXZpY2VfaW5mby5zdWJjbGFzczsKKyAgICBkZXZpY2VfY29u
bmVjdC5kZXZpY2VfcHJvdG9jb2wgPSAwOyAvL2QtPmRldmljZV9pbmZvLnByb3RvY29sOzsKKyAg
ICBkZXZpY2VfY29ubmVjdC52ZW5kb3JfaWQgPSBkLT5kZXZpY2VfaW5mby52aWQ7CisgICAgZGV2
aWNlX2Nvbm5lY3QucHJvZHVjdF9pZCA9IGQtPmRldmljZV9pbmZvLnBpZDsKKyAgICBkZXZpY2Vf
Y29ubmVjdC5kZXZpY2VfdmVyc2lvbl9iY2QgPSBkLT5kZXZpY2VfaW5mby5iY2RVU0I7CisgICAg
ZGV2aWNlX2Nvbm5lY3Quc3BlZWQgPSB1c2JfcmVkaXJfc3BlZWRfaGlnaDsKKyAgICB1c2JyZWRp
cnBhcnNlcl9zZW5kX2RldmljZV9jb25uZWN0KGNoLT5wYXJzZXIsICZkZXZpY2VfY29ubmVjdCk7
CisgICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2soY2gpOworfQorCitzdGF0aWMgdm9p
ZCBpbml0aWFsaXplX3BhcnNlcihTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwgZ2Jvb2xlYW4g
ZG9faGVsbG8pCit7CisgICAgdWludDMyX3QgZmxhZ3MsIGNhcHNbVVNCX1JFRElSX0NBUFNfU0la
RV0gPSB7IDAgfTsKKworICAgIGdfcmV0dXJuX2lmX2ZhaWwoY2gtPmhpZGRlbl9wYXJzZXIgIT0g
TlVMTCk7CisgICAgaWYgKGNoLT5wYXJzZXJfaW5pdF9kb25lKSB7CisgICAgICAgIGlmIChjaC0+
cGFyc2VyX3dpdGhfaGVsbG8gIT0gZG9faGVsbG8pIHsKKyAgICAgICAgICAgIGdfcmV0dXJuX2lm
X3JlYWNoZWQoKTsKKyAgICAgICAgfQorICAgICAgICByZXR1cm47CisgICAgfQorCisgICAgY2gt
PnBhcnNlcl9pbml0X2RvbmUgPSAxOworICAgIGNoLT5wYXJzZXJfd2l0aF9oZWxsbyA9IGRvX2hl
bGxvOworICAgIGZsYWdzID0gdXNicmVkaXJwYXJzZXJfZmxfd3JpdGVfY2Jfb3duc19idWZmZXIg
fCB1c2JyZWRpcnBhcnNlcl9mbF91c2JfaG9zdDsKKworICAgIGlmIChkb19oZWxsbykgeworICAg
ICAgICBjaC0+aGVsbG9fc2VudCA9IDE7CisgICAgICAgIGNoLT5ob3N0X2NhcHMgfD0gMSA8PCB1
c2JfcmVkaXJfY2FwX2Nvbm5lY3RfZGV2aWNlX3ZlcnNpb247CisgICAgICAgIGNoLT5ob3N0X2Nh
cHMgfD0gMSA8PCB1c2JfcmVkaXJfY2FwX2RldmljZV9kaXNjb25uZWN0X2FjazsKKyAgICAgICAg
Y2gtPmhvc3RfY2FwcyB8PSAxIDw8IHVzYl9yZWRpcl9jYXBfZXBfaW5mb19tYXhfcGFja2V0X3Np
emU7CisgICAgICAgIGNoLT5ob3N0X2NhcHMgfD0gMSA8PCB1c2JfcmVkaXJfY2FwXzY0Yml0c19p
ZHM7CisgICAgICAgIGNoLT5ob3N0X2NhcHMgfD0gMSA8PCB1c2JfcmVkaXJfY2FwXzMyYml0c19i
dWxrX2xlbmd0aDsKKyAgICB9IGVsc2UgeworICAgICAgICBmbGFncyB8PSB1c2JyZWRpcnBhcnNl
cl9mbF9ub19oZWxsbzsKKyAgICB9CisKKyAgICBpZiAoY2gtPmhvc3RfY2FwcyAmICgxIDw8IHVz
Yl9yZWRpcl9jYXBfY29ubmVjdF9kZXZpY2VfdmVyc2lvbikpIHsKKyAgICAgICAgdXNicmVkaXJw
YXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfY29ubmVjdF9kZXZpY2VfdmVy
c2lvbik7CisgICAgfQorICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2Jf
cmVkaXJfY2FwX2ZpbHRlcik7CisgICAgaWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVk
aXJfY2FwX2RldmljZV9kaXNjb25uZWN0X2FjaykpIHsKKyAgICAgICAgdXNicmVkaXJwYXJzZXJf
Y2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrKTsK
KyAgICB9CisgICAgaWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJfY2FwX2VwX2lu
Zm9fbWF4X3BhY2tldF9zaXplKSkgeworICAgICAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9j
YXAoY2FwcywgdXNiX3JlZGlyX2NhcF9lcF9pbmZvX21heF9wYWNrZXRfc2l6ZSk7CisgICAgfQor
ICAgIGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF82NGJpdHNfaWRzKSkg
eworICAgICAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2Nh
cF82NGJpdHNfaWRzKTsKKyAgICB9CisgICAgaWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2Jf
cmVkaXJfY2FwXzMyYml0c19idWxrX2xlbmd0aCkpIHsKKyAgICAgICAgdXNicmVkaXJwYXJzZXJf
Y2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfMzJiaXRzX2J1bGtfbGVuZ3RoKTsKKyAg
ICB9CisgICAgaWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJfY2FwX2J1bGtfc3Ry
ZWFtcykpIHsKKyAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9y
ZWRpcl9jYXBfYnVsa19zdHJlYW1zKTsKKyAgICB9CisgICAgdXNicmVkaXJwYXJzZXJfaW5pdChj
aC0+aGlkZGVuX3BhcnNlciwgUEFDS0FHRV9TVFJJTkcsIGNhcHMsIFVTQl9SRURJUl9DQVBTX1NJ
WkUsIGZsYWdzKTsKK30KKworLyoKKyAgICBXZSBjYW4gaW5pdGlhbGl6ZSB0aGUgdXNicmVkaXJw
YXJzZXIgd2l0aCBIRUxMTyBlbmFibGVkIG9ubHkgaW4gY2FzZQorICAgIHRoZSBsaWJ1c2IgaXMg
bm90IGFjdGl2ZSBhbmQgdGhlIHVzYnJlZGlyaG9zdCBkb2VzIG5vdCBmdW5jdGlvbi4KKyAgICBU
aGVuIHRoZSBwYXJzZXIgc2VuZHMgc2Vzc2lvbiBIRUxMTyBhbmQgcmVjZWl2ZXMgc2VydmVyJ3Mg
cmVzcG9uc2UuCisgICAgT3RoZXJ3aXNlICh1c2JyZWRpcnBhcnNlciBpbml0aWFsaXplZCB3aXRo
IEhFTExPIGRpc2FibGVkKToKKyAgICAtIHRoZSB1c2JyZWRpcmhvc3Qgc2VuZHMgc2Vzc2lvbiBI
RUxMTworICAgIC0gd2UgbG9vayBpbnRvIGl0IHRvIGtub3cgc2V0IG9mIGNhcGFiaWxpdGllcyB3
ZSBzaGFsbCBpbml0aWFsaXplCisgICAgICB0aGUgcGFyc2VyIHdpdGgKKyAgICAtIHdoZW4gd2Ug
cmVjZWl2ZSBzZXJ2ZXIncyByZXNwb25zZSB0byBIRUxMTyB3ZSBwcm92aWRlIGl0IGFsc28gdG8K
KyAgICAgIHBhcnNlciB0byBsZXQgaXQgc3luY2hyb25pemUgd2l0aCBzZXJ2ZXIncyBjYXBhYmls
aXRpZXMKKyovCitzdGF0aWMgc3RydWN0IHVzYnJlZGlycGFyc2VyICpjcmVhdGVfcGFyc2VyKFNw
aWNlVXNiQmFja2VuZENoYW5uZWwgKmNoKQoreworICAgIHN0cnVjdCB1c2JyZWRpcnBhcnNlciAq
cGFyc2VyID0gdXNicmVkaXJwYXJzZXJfY3JlYXRlKCk7CisKKyAgICBnX3JldHVybl92YWxfaWZf
ZmFpbChwYXJzZXIgIT0gTlVMTCwgTlVMTCk7CisKKyAgICBwYXJzZXItPnByaXYgPSBjaDsKKyAg
ICBwYXJzZXItPmxvZ19mdW5jID0gdXNicmVkaXJfbG9nOworICAgIHBhcnNlci0+cmVhZF9mdW5j
ID0gdXNicmVkaXJfcmVhZF9jYWxsYmFjazsKKyAgICBwYXJzZXItPndyaXRlX2Z1bmMgPSB1c2Jy
ZWRpcl93cml0ZV9jYWxsYmFjazsKKyAgICBwYXJzZXItPnJlc2V0X2Z1bmMgPSB1c2JyZWRpcl9k
ZXZpY2VfcmVzZXQ7CisgICAgcGFyc2VyLT5zZXRfY29uZmlndXJhdGlvbl9mdW5jID0gdXNicmVk
aXJfc2V0X2NvbmZpZ3VyYXRpb247CisgICAgcGFyc2VyLT5nZXRfY29uZmlndXJhdGlvbl9mdW5j
ID0gdXNicmVkaXJfZ2V0X2NvbmZpZ3VyYXRpb247CisgICAgcGFyc2VyLT5zZXRfYWx0X3NldHRp
bmdfZnVuYyA9IHVzYnJlZGlyX3NldF9hbHRfc2V0dGluZzsKKyAgICBwYXJzZXItPmdldF9hbHRf
c2V0dGluZ19mdW5jID0gdXNicmVkaXJfZ2V0X2FsdF9zZXR0aW5nOworICAgIHBhcnNlci0+Y2Fu
Y2VsX2RhdGFfcGFja2V0X2Z1bmMgPSB1c2JyZWRpcl9jYW5jZWxfZGF0YTsKKyAgICBwYXJzZXIt
PmNvbnRyb2xfcGFja2V0X2Z1bmMgPSB1c2JyZWRpcl9jb250cm9sX3BhY2tldDsKKyAgICBwYXJz
ZXItPmJ1bGtfcGFja2V0X2Z1bmMgPSB1c2JyZWRpcl9idWxrX3BhY2tldDsKKyAgICBwYXJzZXIt
PmFsbG9jX2xvY2tfZnVuYyA9IHVzYnJlZGlyX2FsbG9jX2xvY2s7CisgICAgcGFyc2VyLT5sb2Nr
X2Z1bmMgPSB1c2JyZWRpcl9sb2NrX2xvY2s7CisgICAgcGFyc2VyLT51bmxvY2tfZnVuYyA9IHVz
YnJlZGlyX3VubG9ja19sb2NrOworICAgIHBhcnNlci0+ZnJlZV9sb2NrX2Z1bmMgPSB1c2JyZWRp
cl9mcmVlX2xvY2s7CisgICAgcGFyc2VyLT5oZWxsb19mdW5jID0gdXNicmVkaXJfaGVsbG87Cisg
ICAgcGFyc2VyLT5maWx0ZXJfcmVqZWN0X2Z1bmMgPSB1c2JyZWRpcl9maWx0ZXJfcmVqZWN0Owor
ICAgIHBhcnNlci0+ZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrX2Z1bmMgPSB1c2JyZWRpcl9kZXZpY2Vf
ZGlzY29ubmVjdF9hY2s7CisgICAgcGFyc2VyLT5pbnRlcmZhY2VfaW5mb19mdW5jID0gdXNicmVk
aXJfaW50ZXJmYWNlX2luZm87CisgICAgcGFyc2VyLT5lcF9pbmZvX2Z1bmMgPSB1c2JyZWRpcl9p
bnRlcmZhY2VfZXBfaW5mbzsKKyAgICBwYXJzZXItPmZpbHRlcl9maWx0ZXJfZnVuYyA9IHVzYnJl
ZGlyX2ZpbHRlcl9maWx0ZXI7CisKKyAgICByZXR1cm4gcGFyc2VyOworfQorCitzdGF0aWMgZ2Jv
b2xlYW4gYXR0YWNoX2VkZXYoU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsCisgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgU3BpY2VVc2JCYWNrZW5kRGV2aWNlICpkZXYsCisgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgR0Vycm9yICoqZXJyb3IpCit7CisgICAgaWYgKCFkZXYtPmVkZXYp
IHsKKyAgICAgICAgZ19zZXRfZXJyb3IoZXJyb3IsIFNQSUNFX0NMSUVOVF9FUlJPUiwgU1BJQ0Vf
Q0xJRU5UX0VSUk9SX0ZBSUxFRCwKKyAgICAgICAgICAgXygiRmFpbGVkIHRvIHJlZGlyZWN0IGRl
dmljZSAlZCIpLCAxKTsKKyAgICAgICAgcmV0dXJuIEZBTFNFOworICAgIH0KKyAgICBpZiAoY2gt
PnVzYnJlZGlyaG9zdCAmJiAhY2gtPmhlbGxvX2RvbmVfcGFyc2VyKSB7CisgICAgICAgIC8qCisg
ICAgICAgICAgICB3ZSBjYW4ndCBpbml0aWFsaXplIHBhcnNlciB1bnRpbCB3ZSBzZWUgaGVsbG8g
ZnJvbSB1c2JyZWRpcgorICAgICAgICAgICAgYW5kIHRoZSBwYXJzZXIgY2FuJ3Qgd29yayB1bnRp
bCBpdCBzZWVzIHRoZSBoZWxsbyByZXNwb25zZS4KKyAgICAgICAgICAgIHRoaXMgaXMgY2FzZSBv
ZiBhdXRvY29ubmVjdCB3aGVuIGVtdWxhdGVkIGRldmljZSBpcyBhdHRhY2hlZAorICAgICAgICAg
ICAgYmVmb3JlIHRoZSBjaGFubmVsIGlzIHVwCisgICAgICAgICovCisgICAgICAgIFNQSUNFX0RF
QlVHKCIlcyB3YWl0aW5nIHVudGlsIHRoZSBjaGFubmVsIGlzIHJlYWR5IiwgX19GVU5DVElPTl9f
KTsKKworICAgIH0gZWxzZSB7CisgICAgICAgIGluaXRpYWxpemVfcGFyc2VyKGNoLCBjaC0+aGlk
ZGVuX2hvc3QgPT0gTlVMTCk7CisgICAgICAgIGNoLT51c2JyZWRpcmhvc3QgPSBOVUxMOworICAg
ICAgICBjaC0+cGFyc2VyID0gY2gtPmhpZGRlbl9wYXJzZXI7CisgICAgfQorICAgIGNoLT53YWl0
X2Rpc2Nvbm5lY3RfYWNrID0gMDsKKyAgICBjaC0+YXR0YWNoZWQgPSBkZXY7CisgICAgZGV2LT5h
dHRhY2hlZF90byA9IGNoOworICAgIGRldmljZV9vcHMoZGV2LT5lZGV2KS0+YXR0YWNoKGRldi0+
ZWRldiwgY2gtPmhpZGRlbl9wYXJzZXIpOworICAgIGlmIChjaC0+aGVsbG9fZG9uZV9wYXJzZXIp
IHsKKyAgICAgICAgLyogc2VuZCBkZXZpY2UgaW5mbyAqLworICAgICAgICB1c2JyZWRpcl9oZWxs
byhjaCwgTlVMTCk7CisgICAgfQorICAgIHJldHVybiBUUlVFOworfQorCiBnYm9vbGVhbiBzcGlj
ZV91c2JfYmFja2VuZF9jaGFubmVsX2F0dGFjaChTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwK
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNwaWNlVXNiQmFja2Vu
ZERldmljZSAqZGV2LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
R0Vycm9yICoqZXJyb3IpCkBAIC03MTUsNyArMTIyMywxMyBAQCBnYm9vbGVhbiBzcGljZV91c2Jf
YmFja2VuZF9jaGFubmVsX2F0dGFjaChTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCwKIAogICAg
IGdfcmV0dXJuX3ZhbF9pZl9mYWlsKGRldiAhPSBOVUxMLCBGQUxTRSk7CiAKKyAgICBpZiAoIWRl
di0+bGlidXNiX2RldmljZSkgeworICAgICAgICByZXR1cm4gYXR0YWNoX2VkZXYoY2gsIGRldiwg
ZXJyb3IpOworICAgIH0KKwogICAgIGxpYnVzYl9kZXZpY2VfaGFuZGxlICpoYW5kbGUgPSBOVUxM
OworICAgIGNoLT51c2JyZWRpcmhvc3QgPSBjaC0+aGlkZGVuX2hvc3Q7CisgICAgY2gtPnBhcnNl
ciA9IE5VTEw7CiAKICAgICAvKgogICAgICAgIFVuZGVyIFdpbmRvd3Mgd2UgbmVlZCB0byBhdm9p
ZCB1cGRhdGluZwpAQCAtNzQ5LDE4ICsxMjYzLDMzIEBAIGdib29sZWFuIHNwaWNlX3VzYl9iYWNr
ZW5kX2NoYW5uZWxfYXR0YWNoKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLAogCiB2b2lkIHNw
aWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfZGV0YWNoKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNo
KQogeworICAgIFNwaWNlVXNiQmFja2VuZERldmljZSAqZCA9IGNoLT5hdHRhY2hlZDsKKyAgICBT
cGljZVVzYkVtdWxhdGVkRGV2aWNlICplZGV2ID0gZCA/IGQtPmVkZXYgOiBOVUxMOwogICAgIFNQ
SUNFX0RFQlVHKCIlcyA+PiBjaCAlcCwgd2FzIGF0dGFjaGVkICVwIiwgX19GVU5DVElPTl9fLCBj
aCwgY2gtPmF0dGFjaGVkKTsKLSAgICBpZiAoIWNoLT5hdHRhY2hlZCkgeworICAgIGlmICghZCkg
ewogICAgICAgICBTUElDRV9ERUJVRygiJXM6IG5vdGhpbmcgdG8gZGV0YWNoIiwgX19GVU5DVElP
Tl9fKTsKICAgICAgICAgcmV0dXJuOwogICAgIH0KICAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkg
ewogICAgICAgICAvKiBpdCB3aWxsIGNhbGwgbGlidXNiX2Nsb3NlIGludGVybmFsbHkgKi8KICAg
ICAgICAgdXNicmVkaXJob3N0X3NldF9kZXZpY2UoY2gtPnVzYnJlZGlyaG9zdCwgTlVMTCk7Cisg
ICAgfSBlbHNlIGlmIChjaC0+cGFyc2VyKSB7CisgICAgICAgIGlmIChlZGV2KSB7CisgICAgICAg
ICAgICBkZXZpY2Vfb3BzKGVkZXYpLT5kZXRhY2goZWRldik7CisgICAgICAgIH0KKyAgICAgICAg
dXNicmVkaXJwYXJzZXJfc2VuZF9kZXZpY2VfZGlzY29ubmVjdChjaC0+cGFyc2VyKTsKKyAgICAg
ICAgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2soY2gpOworICAgICAgICBjaC0+d2FpdF9k
aXNjb25uZWN0X2FjayA9CisgICAgICAgICAgICB1c2JyZWRpcnBhcnNlcl9wZWVyX2hhc19jYXAo
Y2gtPnBhcnNlciwgdXNiX3JlZGlyX2NhcF9kZXZpY2VfZGlzY29ubmVjdF9hY2spOworICAgICAg
ICBpZiAoIWNoLT53YWl0X2Rpc2Nvbm5lY3RfYWNrKSB7CisgICAgICAgICAgICBjaC0+dXNicmVk
aXJob3N0ID0gY2gtPmhpZGRlbl9ob3N0OworICAgICAgICAgICAgY2gtPnBhcnNlciA9IE5VTEw7
CisgICAgICAgIH0KICAgICB9CiAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwLCBkZXRhY2ggZG9u
ZSIsIF9fRlVOQ1RJT05fXywgY2gpOwogICAgIGNoLT5hdHRhY2hlZC0+YXR0YWNoZWRfdG8gPSBO
VUxMOwogICAgIGNoLT5hdHRhY2hlZCA9IE5VTEw7CisgICAgY2gtPnJlamVjdGVkID0gMDsKIH0K
IAogU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqCkBAIC03NzQsMjYgKzEzMDMsMzMgQEAgc3BpY2Vf
dXNiX2JhY2tlbmRfY2hhbm5lbF9uZXcoU3BpY2VVc2JCYWNrZW5kICpiZSwKICAgICBjaC0+dXNi
cmVkaXJfY2hhbm5lbCA9IHVzYnJlZGlyX2NoYW5uZWw7CiAgICAgaWYgKGJlLT5saWJ1c2JfY29u
dGV4dCkgewogICAgICAgICBjaC0+YmFja2VuZCA9IGJlOwotICAgICAgICBjaC0+dXNicmVkaXJo
b3N0ID0gdXNicmVkaXJob3N0X29wZW5fZnVsbCgKLSAgICAgICAgICAgIGJlLT5saWJ1c2JfY29u
dGV4dCwKLSAgICAgICAgICAgIE5VTEwsCi0gICAgICAgICAgICB1c2JyZWRpcl9sb2csCi0gICAg
ICAgICAgICB1c2JyZWRpcl9yZWFkX2NhbGxiYWNrLAotICAgICAgICAgICAgdXNicmVkaXJfd3Jp
dGVfY2FsbGJhY2ssCi0gICAgICAgICAgICB1c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFjaywK
LSAgICAgICAgICAgIHVzYnJlZGlyX2FsbG9jX2xvY2ssCi0gICAgICAgICAgICB1c2JyZWRpcl9s
b2NrX2xvY2ssCi0gICAgICAgICAgICB1c2JyZWRpcl91bmxvY2tfbG9jaywKLSAgICAgICAgICAg
IHVzYnJlZGlyX2ZyZWVfbG9jaywKLSAgICAgICAgICAgIGNoLCBQQUNLQUdFX1NUUklORywKLSAg
ICAgICAgICAgIHNwaWNlX3V0aWxfZ2V0X2RlYnVnKCkgPyB1c2JyZWRpcnBhcnNlcl9kZWJ1ZyA6
IHVzYnJlZGlycGFyc2VyX3dhcm5pbmcsCi0gICAgICAgICAgICB1c2JyZWRpcmhvc3RfZmxfd3Jp
dGVfY2Jfb3duc19idWZmZXIpOworICAgICAgICBjaC0+dXNicmVkaXJob3N0ID0KKyAgICAgICAg
ICAgIHVzYnJlZGlyaG9zdF9vcGVuX2Z1bGwoYmUtPmxpYnVzYl9jb250ZXh0LAorICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICBOVUxMLAorICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICB1c2JyZWRpcl9sb2csCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgIHVzYnJlZGlyX3JlYWRfY2FsbGJhY2ssCisgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIHVzYnJlZGlyX3dyaXRlX2NhbGxiYWNrLAorICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICB1c2JyZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFjaywKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgdXNicmVkaXJfYWxsb2NfbG9jaywKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgdXNicmVkaXJfbG9ja19sb2NrLAorICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICB1c2JyZWRpcl91bmxvY2tfbG9jaywKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgdXNicmVkaXJfZnJlZV9sb2NrLAorICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICBjaCwgUEFDS0FHRV9TVFJJTkcsCisgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIHNwaWNlX3V0aWxfZ2V0X2RlYnVnKCkgPyB1c2JyZWRpcnBhcnNl
cl9kZWJ1ZyA6CisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNicmVk
aXJwYXJzZXJfd2FybmluZywKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNi
cmVkaXJob3N0X2ZsX3dyaXRlX2NiX293bnNfYnVmZmVyKTsKICAgICAgICAgZ193YXJuX2lmX2Zh
aWwoY2gtPnVzYnJlZGlyaG9zdCAhPSBOVUxMKTsKICAgICB9CisKICAgICBpZiAoY2gtPnVzYnJl
ZGlyaG9zdCkgewotICAgICAgICB1c2JyZWRpcmhvc3Rfc2V0X2J1ZmZlcmVkX291dHB1dF9zaXpl
X2NiKGNoLT51c2JyZWRpcmhvc3QsIHVzYnJlZGlyX2J1ZmZlcmVkX291dHB1dF9zaXplX2NhbGxi
YWNrKTsKLSAgICB9IGVsc2UgewotICAgICAgICBnX2ZyZWUoY2gpOworICAgICAgICBjaC0+aGlk
ZGVuX3BhcnNlciA9IGNyZWF0ZV9wYXJzZXIoY2gpOworICAgICAgICBjaC0+aGlkZGVuX2hvc3Qg
PSBjaC0+dXNicmVkaXJob3N0OworICAgICAgICB1c2JyZWRpcmhvc3Rfc2V0X2J1ZmZlcmVkX291
dHB1dF9zaXplX2NiKGNoLT51c2JyZWRpcmhvc3QsCisgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgdXNicmVkaXJfYnVmZmVyZWRfb3V0cHV0X3NpemVfY2Fs
bGJhY2spOworICAgIH0KKworICAgIGlmICghY2gtPmhpZGRlbl9wYXJzZXIpIHsKKyAgICAgICAg
c3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9kZWxldGUoY2gpOwogICAgICAgICBjaCA9IE5VTEw7
CiAgICAgfQogCkBAIC04MDMsOSArMTMzOSwxNCBAQCBzcGljZV91c2JfYmFja2VuZF9jaGFubmVs
X25ldyhTcGljZVVzYkJhY2tlbmQgKmJlLAogCiB2b2lkIHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5u
ZWxfZmx1c2hfd3JpdGVzKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoKQogewotICAgIFNQSUNF
X0RFQlVHKCIlcyAlcCwgaG9zdCAlcCIsIF9fRlVOQ1RJT05fXywgY2gsIGNoLT51c2JyZWRpcmhv
c3QpOworICAgIFNQSUNFX0RFQlVHKCIlcyAlcCBpcyB1cCIsIF9fRlVOQ1RJT05fXywgY2gpOwog
ICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7CiAgICAgICAgIHVzYnJlZGlyaG9zdF93cml0ZV9n
dWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3QpOworICAgICAgICBpbml0aWFsaXplX3BhcnNlcihj
aCwgRkFMU0UpOworICAgIH0gZWxzZSB7CisgICAgICAgIGluaXRpYWxpemVfcGFyc2VyKGNoLCBU
UlVFKTsKKyAgICAgICAgY2gtPnBhcnNlciA9IGNoLT5oaWRkZW5fcGFyc2VyOworICAgICAgICB1
c2JyZWRpcnBhcnNlcl9kb193cml0ZShjaC0+cGFyc2VyKTsKICAgICB9CiB9CiAKQEAgLTgxNSwx
MiArMTM1NiwxNiBAQCB2b2lkIHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfZGVsZXRlKFNwaWNl
VXNiQmFja2VuZENoYW5uZWwgKmNoKQogICAgIGlmICghY2gpIHsKICAgICAgICAgcmV0dXJuOwog
ICAgIH0KLSAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCkgewotICAgICAgICB1c2JyZWRpcmhvc3Rf
Y2xvc2UoY2gtPnVzYnJlZGlyaG9zdCk7CisgICAgaWYgKGNoLT5oaWRkZW5faG9zdCkgeworICAg
ICAgICB1c2JyZWRpcmhvc3RfY2xvc2UoY2gtPmhpZGRlbl9ob3N0KTsKKyAgICB9CisgICAgaWYg
KGNoLT5oaWRkZW5fcGFyc2VyKSB7CisgICAgICAgIHVzYnJlZGlycGFyc2VyX2Rlc3Ryb3koY2gt
PmhpZGRlbl9wYXJzZXIpOwogICAgIH0KIAogICAgIGlmIChjaC0+cnVsZXMpIHsKLSAgICAgICAg
Z19mcmVlKGNoLT5ydWxlcyk7CisgICAgICAgIC8qIHJ1bGVzIHdlcmUgYWxsb2NhdGVkIGJ5IHVz
YnJlZGlycGFyc2VyICovCisgICAgICAgIGZyZWUoY2gtPnJ1bGVzKTsKICAgICB9CiAKICAgICBn
X2ZyZWUoY2gpOwotLSAKMi4yMC4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fXwpTcGljZS1kZXZlbCBtYWlsaW5nIGxpc3QKU3BpY2UtZGV2ZWxAbGlzdHMu
ZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlz
dGluZm8vc3BpY2UtZGV2ZWw=
