Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id EC9BAA046C
	for <lists+spice-devel@lfdr.de>; Wed, 28 Aug 2019 16:14:52 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 5A87E895B6;
	Wed, 28 Aug 2019 14:14:51 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 5F57D893CD
 for <spice-devel@lists.freedesktop.org>; Wed, 28 Aug 2019 14:14:49 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx02.intmail.prod.int.phx2.redhat.com
 [10.5.11.12])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 0CC24190C027
 for <spice-devel@lists.freedesktop.org>; Wed, 28 Aug 2019 14:14:49 +0000 (UTC)
Received: from fziglio.remote.csb (unknown [10.33.32.21])
 by smtp.corp.redhat.com (Postfix) with ESMTP id A1EE26107E;
 Wed, 28 Aug 2019 14:14:46 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Wed, 28 Aug 2019 15:14:16 +0100
Message-Id: <20190828141421.18902-14-fziglio@redhat.com>
In-Reply-To: <20190828141421.18902-1-fziglio@redhat.com>
References: <20190828141421.18902-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.12
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.6.2
 (mx1.redhat.com [10.5.110.70]); Wed, 28 Aug 2019 14:14:49 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-gtk v5 13/18] usb-backend: Rewrite USB
 emulation support
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

TWFrZSBpbml0aWFsaXphdGlvbiBlYXNpZXIuCkluaXRpYWxpemUgYm90aCBwYXJzZXIgYW5kIGhv
c3QgZHVyaW5nIHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfbmV3LgpwYXJzZXIgaXMgYWx3YXlz
IGluaXRpYWxpemVkIGFmdGVyIGNyZWF0aW9uIG1ha2luZyBzdXJlIHRoZSBzdGF0ZQppcyBjb25z
aXN0ZW50LgpSZWR1Y2UgbnVtYmVyIG9mIHN0YXRlIHZhcmlhYmxlcy4KVXNlIGEgc2luZ2xlIHN0
YXRlIHZhcmlhYmxlLCBkYXRhIGZsb3dzIGludG8vZnJvbSBhIHNpbmdsZSBwYXJzZXIuClN1cHBv
cnQgbm90IGhhdmluZyBsaWJ1c2IgY29udGV4dCAobm8gcGh5c2ljYWwgZGV2aWNlcykuCgpTaWdu
ZWQtb2ZmLWJ5OiBGcmVkaWFubyBaaWdsaW8gPGZ6aWdsaW9AcmVkaGF0LmNvbT4KLS0tCiBzcmMv
dXNiLWJhY2tlbmQuYyB8IDI0MSArKysrKysrKysrKysrKysrKysrKysrKy0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgMTIxIGluc2VydGlvbnMoKyksIDEyMCBkZWxldGlv
bnMoLSkKCmRpZmYgLS1naXQgYS9zcmMvdXNiLWJhY2tlbmQuYyBiL3NyYy91c2ItYmFja2VuZC5j
CmluZGV4IDg1N2ZmZGY3Li42MzUxN2NlOCAxMDA2NDQKLS0tIGEvc3JjL3VzYi1iYWNrZW5kLmMK
KysrIGIvc3JjL3VzYi1iYWNrZW5kLmMKQEAgLTc2LDIxICs3NiwyMSBAQCBzdHJ1Y3QgX1NwaWNl
VXNiQmFja2VuZAogICAgIHVpbnQzMl90IG93bl9kZXZpY2VzX21hc2s7CiB9OwogCit0eXBlZGVm
IGVudW0geworICAgIFVTQl9DSEFOTkVMX1NUQVRFX0lOSVRJQUxJWklORywKKyAgICBVU0JfQ0hB
Tk5FTF9TVEFURV9IT1NULAorICAgIFVTQl9DSEFOTkVMX1NUQVRFX1BBUlNFUiwKK30gU3BpY2VV
c2JCYWNrZW5kQ2hhbm5lbFN0YXRlOworCiBzdHJ1Y3QgX1NwaWNlVXNiQmFja2VuZENoYW5uZWwK
IHsKICAgICBzdHJ1Y3QgdXNicmVkaXJob3N0ICp1c2JyZWRpcmhvc3Q7Ci0gICAgc3RydWN0IHVz
YnJlZGlyaG9zdCAqaGlkZGVuX2hvc3Q7CiAgICAgc3RydWN0IHVzYnJlZGlycGFyc2VyICpwYXJz
ZXI7Ci0gICAgc3RydWN0IHVzYnJlZGlycGFyc2VyICpoaWRkZW5fcGFyc2VyOworICAgIFNwaWNl
VXNiQmFja2VuZENoYW5uZWxTdGF0ZSBzdGF0ZTsKICAgICB1aW50OF90ICpyZWFkX2J1ZjsKICAg
ICBpbnQgcmVhZF9idWZfc2l6ZTsKICAgICBzdHJ1Y3QgdXNicmVkaXJmaWx0ZXJfcnVsZSAqcnVs
ZXM7CiAgICAgaW50IHJ1bGVzX2NvdW50OwotICAgIHVpbnQzMl90IGhvc3RfY2FwczsKLSAgICB1
aW50MzJfdCBwYXJzZXJfaW5pdF9kb25lICA6IDE7Ci0gICAgdWludDMyX3QgcGFyc2VyX3dpdGhf
aGVsbG8gOiAxOwotICAgIHVpbnQzMl90IGhlbGxvX2RvbmVfcGFyc2VyIDogMTsKLSAgICB1aW50
MzJfdCBoZWxsb19zZW50ICAgICAgICA6IDE7CiAgICAgdWludDMyX3QgcmVqZWN0ZWQgICAgICAg
ICAgOiAxOwogICAgIHVpbnQzMl90IHdhaXRfZGlzY29ubmVjdF9hY2sgOiAxOwogICAgIFNwaWNl
VXNiQmFja2VuZERldmljZSAqYXR0YWNoZWQ7CkBAIC00MDMsMTUgKzQwMywxNiBAQCBmcm9tIGJv
dGggdGhlIG1haW4gdGhyZWFkIGFzIHdlbGwgYXMgZnJvbSB0aGUgdXNiIGV2ZW50IGhhbmRsaW5n
IHRocmVhZCAqLwogc3RhdGljIHZvaWQgdXNicmVkaXJfd3JpdGVfZmx1c2hfY2FsbGJhY2sodm9p
ZCAqdXNlcl9kYXRhKQogewogICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gdXNlcl9k
YXRhOworICAgIGlmIChjaC0+cGFyc2VyID09IE5VTEwpIHsKKyAgICAgICAgcmV0dXJuOworICAg
IH0KICAgICBpZiAoaXNfY2hhbm5lbF9yZWFkeShjaC0+dXNlcl9kYXRhKSkgewotICAgICAgICBp
ZiAoY2gtPnVzYnJlZGlyaG9zdCkgeworICAgICAgICBpZiAoY2gtPnN0YXRlID09IFVTQl9DSEFO
TkVMX1NUQVRFX0hPU1QpIHsKICAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAlcCAtPiB1
c2JyZWRpcmhvc3QiLCBfX0ZVTkNUSU9OX18sIGNoKTsKICAgICAgICAgICAgIHVzYnJlZGlyaG9z
dF93cml0ZV9ndWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3QpOwotICAgICAgICB9IGVsc2UgaWYg
KGNoLT5wYXJzZXIpIHsKKyAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgIFNQSUNFX0RFQlVH
KCIlcyBjaCAlcCAtPiBwYXJzZXIiLCBfX0ZVTkNUSU9OX18sIGNoKTsKICAgICAgICAgICAgIHVz
YnJlZGlycGFyc2VyX2RvX3dyaXRlKGNoLT5wYXJzZXIpOwotICAgICAgICB9IGVsc2UgewotICAg
ICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIChOT1QgQUNUSVZFKSIsIF9fRlVOQ1RJT05f
XywgY2gpOwogICAgICAgICB9CiAgICAgfSBlbHNlIHsKICAgICAgICAgU1BJQ0VfREVCVUcoIiVz
IGNoICVwIChub3QgcmVhZHkpIiwgX19GVU5DVElPTl9fLCBjaCk7CkBAIC02NzEsMjEgKzY3Miw0
NyBAQCBzdGF0aWMgdm9pZCB1c2JyZWRpcl9sb2codm9pZCAqdXNlcl9kYXRhLCBpbnQgbGV2ZWws
IGNvbnN0IGNoYXIgKm1zZykKICAgICB9CiB9CiAKK3N0YXRpYyBzdHJ1Y3QgdXNicmVkaXJwYXJz
ZXIgKmNyZWF0ZV9wYXJzZXIoU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gpOworCiBzdGF0aWMg
aW50IHVzYnJlZGlyX3dyaXRlX2NhbGxiYWNrKHZvaWQgKnVzZXJfZGF0YSwgdWludDhfdCAqZGF0
YSwgaW50IGNvdW50KQogewogICAgIFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoID0gdXNlcl9k
YXRhOwogICAgIGludCByZXM7CiAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwLCAlZCBieXRlcyIs
IF9fRlVOQ1RJT05fXywgY2gsIGNvdW50KTsKLSAgICBpZiAoIWNoLT5oZWxsb19zZW50KSB7Ci0g
ICAgICAgIC8qIGhlbGxvIGlzIHNob3J0IGhlYWRlciAoMTIpICsgaGVsbG8gc3RydWN0ICg2NCkg
KyBjYXBhYmlsaXRpZXMgKDQpICovCi0gICAgICAgIGludCBoZWxsb19zaXplID0gc2l6ZW9mKHN0
cnVjdCB1c2JfcmVkaXJfaGVhZGVyKSArIHNpemVvZihzdHJ1Y3QgdXNiX3JlZGlyX2hlbGxvX2hl
YWRlcik7Ci0gICAgICAgIGNoLT5oZWxsb19zZW50ID0gMTsKLSAgICAgICAgaWYgKGNvdW50ID09
IGhlbGxvX3NpemUpIHsKLSAgICAgICAgICAgIG1lbWNweSgmY2gtPmhvc3RfY2FwcywgZGF0YSAr
IGhlbGxvX3NpemUgLSBzaXplb2YoY2gtPmhvc3RfY2FwcyksCi0gICAgICAgICAgICAgICAgICAg
c2l6ZW9mKGNoLT5ob3N0X2NhcHMpKTsKLSAgICAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBjaCAl
cCwgc2VuZGluZyBmaXJzdCBoZWxsbywgY2FwcyAlMDhYIiwKLSAgICAgICAgICAgICAgICAgICAg
ICAgIF9fRlVOQ1RJT05fXywgY2gsIGNoLT5ob3N0X2NhcHMpOworCisgICAgLy8gaGFuZGxlIGZp
cnN0IHBhY2tldCAoSEVMTE8pIGNyZWF0aW5nIHBhcnNlciBmcm9tIGNhcGFiaWxpdGllcworICAg
IGlmIChTUElDRV9VTkxJS0VMWShjaC0+cGFyc2VyID09IE5VTEwpKSB7CisgICAgICAgIC8vIEhl
cmUgd2UgcmV0dXJuIDAgZnJvbSB0aGlzIGZ1bmN0aW9uIHRvIGtlZXAgdGhlIHBhY2tldCBpbgor
ICAgICAgICAvLyB0aGUgcXVldWUuIFRoZSBwYWNrZXQgd2lsbCB0aGVuIGJlIHNlbnQgdG8gdGhl
IGd1ZXN0LgorICAgICAgICAvLyBXZSBhcmUgaW5pdGlhbGl6aW5nIFNwaWNlVXNiQmFja2VuZENo
YW5uZWwsIHRoZQorICAgICAgICAvLyBTcGljZVVzYnJlZGlyQ2hhbm5lbCBpcyBub3QgcmVhZHkg
dG8gcmVjZWl2ZSBwYWNrZXRzLgorCisgICAgICAgIC8vIHdlIGFyZSBzdGlsbCBpbml0aWFsaXpp
bmcgdGhlIGhvc3QKKyAgICAgICAgaWYgKGNoLT51c2JyZWRpcmhvc3QgPT0gTlVMTCkgeworICAg
ICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgIH0KKworICAgICAgICBjaC0+cGFyc2VyID0gY3Jl
YXRlX3BhcnNlcihjaCk7CisgICAgICAgIGlmICghY2gtPnBhcnNlcikgeworICAgICAgICAgICAg
cmV0dXJuIDA7CisgICAgICAgIH0KKworICAgICAgICAvKiBoZWxsbyBpcyBzaG9ydCBoZWFkZXIg
KDEyKSArIGhlbGxvIHN0cnVjdCAoNjQpICovCisgICAgICAgIGNvbnN0IGludCBoZWxsb19zaXpl
ID0gMTIgKyBzaXplb2Yoc3RydWN0IHVzYl9yZWRpcl9oZWxsb19oZWFkZXIpOworICAgICAgICBn
X2Fzc2VydChjb3VudCA+PSBoZWxsb19zaXplICsgNCk7CisgICAgICAgIGdfYXNzZXJ0KFNQSUNF
X0FMSUdORURfQ0FTVChzdHJ1Y3QgdXNiX3JlZGlyX2hlYWRlciAqLCBkYXRhKS0+dHlwZSA9PSB1
c2JfcmVkaXJfaGVsbG8pOworCisgICAgICAgIGNvbnN0IHVpbnQzMl90IGZsYWdzID0KKyAgICAg
ICAgICAgIHVzYnJlZGlycGFyc2VyX2ZsX3dyaXRlX2NiX293bnNfYnVmZmVyIHwgdXNicmVkaXJw
YXJzZXJfZmxfdXNiX2hvc3QgfAorICAgICAgICAgICAgdXNicmVkaXJwYXJzZXJfZmxfbm9faGVs
bG87CisKKyAgICAgICAgdXNicmVkaXJwYXJzZXJfaW5pdChjaC0+cGFyc2VyLAorICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIFBBQ0tBR0VfU1RSSU5HLAorICAgICAgICAgICAgICAgICAgICAg
ICAgICAgIFNQSUNFX0FMSUdORURfQ0FTVCh1aW50MzJfdCAqLCBkYXRhICsgaGVsbG9fc2l6ZSks
CisgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGNvdW50IC0gaGVsbG9fc2l6ZSkgLyBzaXpl
b2YodWludDMyX3QpLAorICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsYWdzKTsKKworICAg
ICAgICByZXR1cm4gMDsKICAgICB9CiAgICAgcmVzID0gc3BpY2VfdXNicmVkaXJfd3JpdGVfY2Fs
bGJhY2soY2gtPnVzZXJfZGF0YSwgZGF0YSwgY291bnQpOwogICAgIHJldHVybiByZXM7CkBAIC03
MDUsMzEgKzczMiwzMyBAQCBpbnQgc3BpY2VfdXNiX2JhY2tlbmRfcmVhZF9ndWVzdF9kYXRhKFNw
aWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLCB1aW50OF90ICpkYXRhLAogCiAgICAgY2gtPnJlYWRf
YnVmID0gZGF0YTsKICAgICBjaC0+cmVhZF9idWZfc2l6ZSA9IGNvdW50OwotICAgIGlmIChjaC0+
dXNicmVkaXJob3N0KSB7Ci0gICAgICAgIHJlcyA9IHVzYnJlZGlyaG9zdF9yZWFkX2d1ZXN0X2Rh
dGEoY2gtPnVzYnJlZGlyaG9zdCk7Ci0gICAgICAgIGlmICghY2gtPmhlbGxvX2RvbmVfcGFyc2Vy
KSB7Ci0gICAgICAgICAgICBpbnQgcmVzX3BhcnNlcjsKKyAgICBpZiAoU1BJQ0VfVU5MSUtFTFko
Y2gtPnN0YXRlID09IFVTQl9DSEFOTkVMX1NUQVRFX0lOSVRJQUxJWklORykpIHsKKyAgICAgICAg
aWYgKGNoLT51c2JyZWRpcmhvc3QgIT0gTlVMTCkgeworICAgICAgICAgICAgcmVzID0gdXNicmVk
aXJob3N0X3JlYWRfZ3Vlc3RfZGF0YShjaC0+dXNicmVkaXJob3N0KTsKKyAgICAgICAgICAgIGlm
IChyZXMgIT0gMCkgeworICAgICAgICAgICAgICAgIHJldHVybiByZXM7CisgICAgICAgICAgICB9
CisgICAgICAgICAgICBjaC0+c3RhdGUgPSBVU0JfQ0hBTk5FTF9TVEFURV9IT1NUOworCiAgICAg
ICAgICAgICAvKiB1c2JyZWRpcmhvc3Qgc2hvdWxkIGNvbnN1bWUgaGVsbG8gcmVzcG9uc2UgKi8K
ICAgICAgICAgICAgIGdfcmV0dXJuX3ZhbF9pZl9mYWlsKGNoLT5yZWFkX2J1ZiA9PSBOVUxMLCBV
U0JfUkVESVJfRVJST1JfUkVBRF9QQVJTRSk7CisgICAgICAgIH0gZWxzZSB7CisgICAgICAgICAg
ICBjaC0+c3RhdGUgPSBVU0JfQ0hBTk5FTF9TVEFURV9QQVJTRVI7CisgICAgICAgIH0KIAotICAg
ICAgICAgICAgY2gtPnJlYWRfYnVmID0gZGF0YTsKLSAgICAgICAgICAgIGNoLT5yZWFkX2J1Zl9z
aXplID0gY291bnQ7Ci0gICAgICAgICAgICBjaC0+aGVsbG9fZG9uZV9wYXJzZXIgPSAxOwotICAg
ICAgICAgICAgaWYgKGNoLT5hdHRhY2hlZCAmJiBjaC0+YXR0YWNoZWQtPmVkZXYpIHsKLSAgICAg
ICAgICAgICAgICAvKiBjYXNlIG9mIENEIHNoYXJpbmcgb24gY29ubmVjdCAqLwotICAgICAgICAg
ICAgICAgIGNoLT51c2JyZWRpcmhvc3QgPSBOVUxMOwotICAgICAgICAgICAgICAgIGNoLT5wYXJz
ZXIgPSBjaC0+aGlkZGVuX3BhcnNlcjsKLSAgICAgICAgICAgICAgICBTUElDRV9ERUJVRygiJXM6
IHN3aXRjaCAlcCB0byBwYXJzZXIiLCBfX0ZVTkNUSU9OX18sIGNoKTsKLSAgICAgICAgICAgIH0K
LSAgICAgICAgICAgIHJlc19wYXJzZXIgPSB1c2JyZWRpcnBhcnNlcl9kb19yZWFkKGNoLT5oaWRk
ZW5fcGFyc2VyKTsKLSAgICAgICAgICAgIGlmIChyZXMgPj0gMCkgewotICAgICAgICAgICAgICAg
IHJlcyA9IHJlc19wYXJzZXI7Ci0gICAgICAgICAgICB9CisgICAgICAgIGNoLT5yZWFkX2J1ZiA9
IGRhdGE7CisgICAgICAgIGNoLT5yZWFkX2J1Zl9zaXplID0gY291bnQ7CisgICAgICAgIGlmIChj
aC0+YXR0YWNoZWQgJiYgY2gtPmF0dGFjaGVkLT5lZGV2KSB7CisgICAgICAgICAgICAvKiBjYXNl
IG9mIENEIHNoYXJpbmcgb24gY29ubmVjdCAqLworICAgICAgICAgICAgY2gtPnN0YXRlID0gVVNC
X0NIQU5ORUxfU1RBVEVfUEFSU0VSOworICAgICAgICAgICAgU1BJQ0VfREVCVUcoIiVzOiBzd2l0
Y2ggJXAgdG8gcGFyc2VyIiwgX19GVU5DVElPTl9fLCBjaCk7CiAgICAgICAgIH0KLSAgICB9IGVs
c2UgaWYgKGNoLT5wYXJzZXIpIHsKLSAgICAgICAgcmVzID0gdXNicmVkaXJwYXJzZXJfZG9fcmVh
ZChjaC0+cGFyc2VyKTsKKyAgICAgICAgcmV0dXJuIHVzYnJlZGlycGFyc2VyX2RvX3JlYWQoY2gt
PnBhcnNlcik7CisgICAgfQorICAgIGlmIChjaC0+c3RhdGUgPT0gVVNCX0NIQU5ORUxfU1RBVEVf
SE9TVCkgeworICAgICAgICByZXMgPSB1c2JyZWRpcmhvc3RfcmVhZF9ndWVzdF9kYXRhKGNoLT51
c2JyZWRpcmhvc3QpOwogICAgIH0gZWxzZSB7Ci0gICAgICAgIHJlcyA9IFVTQl9SRURJUl9FUlJP
Ul9JTzsKKyAgICAgICAgcmVzID0gdXNicmVkaXJwYXJzZXJfZG9fcmVhZChjaC0+cGFyc2VyKTsK
ICAgICB9CiAgICAgc3dpdGNoIChyZXMpCiAgICAgewpAQCAtNzgxLDE0ICs4MTAsMTIgQEAgR0Vy
cm9yICpzcGljZV91c2JfYmFja2VuZF9nZXRfZXJyb3JfZGV0YWlscyhpbnQgZXJyb3JfY29kZSwg
Z2NoYXIgKmRlc2MpCiAKIHZvaWQgc3BpY2VfdXNiX2JhY2tlbmRfcmV0dXJuX3dyaXRlX2RhdGEo
U3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsIHZvaWQgKmRhdGEpCiB7Ci0gICAgaWYgKGNoLT51
c2JyZWRpcmhvc3QpIHsKKyAgICBpZiAoY2gtPnN0YXRlID09IFVTQl9DSEFOTkVMX1NUQVRFX0hP
U1QpIHsKICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIC0+IHVzYnJlZGlyaG9zdCIsIF9f
RlVOQ1RJT05fXywgY2gpOwogICAgICAgICB1c2JyZWRpcmhvc3RfZnJlZV93cml0ZV9idWZmZXIo
Y2gtPnVzYnJlZGlyaG9zdCwgZGF0YSk7Ci0gICAgfSBlbHNlIGlmIChjaC0+cGFyc2VyKSB7Cisg
ICAgfSBlbHNlIHsKICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIC0+IHBhcnNlciIsIF9f
RlVOQ1RJT05fXywgY2gpOwogICAgICAgICB1c2JyZWRpcnBhcnNlcl9mcmVlX3dyaXRlX2J1ZmZl
cihjaC0+cGFyc2VyLCBkYXRhKTsKLSAgICB9IGVsc2UgewotICAgICAgICBTUElDRV9ERUJVRygi
JXMgY2ggJXAgLSBOT0JPRFkgVE8gQ0FMTCIsIF9fRlVOQ1RJT05fXywgY2gpOwogICAgIH0KIH0K
IApAQCAtMTAwMywxMCArMTAzMCwxMCBAQCBzdGF0aWMgdm9pZCB1c2JyZWRpcl9kZXZpY2VfZGlz
Y29ubmVjdF9hY2sodm9pZCAqcHJpdikKIHsKICAgICBTcGljZVVzYkJhY2tlbmRDaGFubmVsICpj
aCA9IHByaXY7CiAgICAgU1BJQ0VfREVCVUcoIiVzIGNoICVwIiwgX19GVU5DVElPTl9fLCBjaCk7
Ci0gICAgaWYgKGNoLT5wYXJzZXIgJiYgY2gtPndhaXRfZGlzY29ubmVjdF9hY2spIHsKLSAgICAg
ICAgY2gtPnBhcnNlciA9IE5VTEw7CisgICAgaWYgKGNoLT5zdGF0ZSA9PSBVU0JfQ0hBTk5FTF9T
VEFURV9QQVJTRVIgJiYgY2gtPnVzYnJlZGlyaG9zdCAhPSBOVUxMICYmCisgICAgICAgIGNoLT53
YWl0X2Rpc2Nvbm5lY3RfYWNrKSB7CisgICAgICAgIGNoLT5zdGF0ZSA9IFVTQl9DSEFOTkVMX1NU
QVRFX0hPU1Q7CiAgICAgICAgIFNQSUNFX0RFQlVHKCIlcyBzd2l0Y2ggdG8gdXNicmVkaXJob3N0
IiwgX19GVU5DVElPTl9fKTsKLSAgICAgICAgY2gtPnVzYnJlZGlyaG9zdCA9IGNoLT5oaWRkZW5f
aG9zdDsKICAgICB9CiAgICAgY2gtPndhaXRfZGlzY29ubmVjdF9hY2sgPSAwOwogfQpAQCAtMTAy
NSw5ICsxMDUyLDYgQEAgdXNicmVkaXJfaGVsbG8odm9pZCAqcHJpdiwgc3RydWN0IHVzYl9yZWRp
cl9oZWxsb19oZWFkZXIgKmhlbGxvKQogICAgIFNQSUNFX0RFQlVHKCIlcyAlcCAlc2F0dGFjaGVk
ICVzIiwgX19GVU5DVElPTl9fLCBjaCwKICAgICAgICAgZWRldiA/ICIiIDogIm5vdCAiLCAgaGVs
bG8gPyAiIiA6ICIoaW50ZXJuYWwpIik7CiAKLSAgICBpZiAoaGVsbG8pIHsKLSAgICAgICAgY2gt
PmhlbGxvX2RvbmVfcGFyc2VyID0gMTsKLSAgICB9CiAgICAgaWYgKCFlZGV2KSB7CiAgICAgICAg
IHJldHVybjsKICAgICB9CkBAIC0xMDc3LDUzICsxMTAxLDI0IEBAIHVzYnJlZGlyX2hlbGxvKHZv
aWQgKnByaXYsIHN0cnVjdCB1c2JfcmVkaXJfaGVsbG9faGVhZGVyICpoZWxsbykKICAgICB1c2Jy
ZWRpcl93cml0ZV9mbHVzaF9jYWxsYmFjayhjaCk7CiB9CiAKLXN0YXRpYyB2b2lkIGluaXRpYWxp
emVfcGFyc2VyKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLCBnYm9vbGVhbiBkb19oZWxsbykK
K3N0YXRpYyB2b2lkIGluaXRpYWxpemVfcGFyc2VyKFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNo
KQogewogICAgIHVpbnQzMl90IGZsYWdzLCBjYXBzW1VTQl9SRURJUl9DQVBTX1NJWkVdID0geyAw
IH07CiAKLSAgICBnX3JldHVybl9pZl9mYWlsKGNoLT5oaWRkZW5fcGFyc2VyICE9IE5VTEwpOwot
ICAgIGlmIChjaC0+cGFyc2VyX2luaXRfZG9uZSkgewotICAgICAgICBpZiAoY2gtPnBhcnNlcl93
aXRoX2hlbGxvICE9IGRvX2hlbGxvKSB7Ci0gICAgICAgICAgICBnX3JldHVybl9pZl9yZWFjaGVk
KCk7Ci0gICAgICAgIH0KLSAgICAgICAgcmV0dXJuOwotICAgIH0KKyAgICBnX2Fzc2VydChjaC0+
dXNicmVkaXJob3N0ID09IE5VTEwpOwogCi0gICAgY2gtPnBhcnNlcl9pbml0X2RvbmUgPSAxOwot
ICAgIGNoLT5wYXJzZXJfd2l0aF9oZWxsbyA9IGRvX2hlbGxvOwogICAgIGZsYWdzID0gdXNicmVk
aXJwYXJzZXJfZmxfd3JpdGVfY2Jfb3duc19idWZmZXIgfCB1c2JyZWRpcnBhcnNlcl9mbF91c2Jf
aG9zdDsKIAotICAgIGlmIChkb19oZWxsbykgewotICAgICAgICBjaC0+aGVsbG9fc2VudCA9IDE7
Ci0gICAgICAgIGNoLT5ob3N0X2NhcHMgfD0gMSA8PCB1c2JfcmVkaXJfY2FwX2Nvbm5lY3RfZGV2
aWNlX3ZlcnNpb247Ci0gICAgICAgIGNoLT5ob3N0X2NhcHMgfD0gMSA8PCB1c2JfcmVkaXJfY2Fw
X2RldmljZV9kaXNjb25uZWN0X2FjazsKLSAgICAgICAgY2gtPmhvc3RfY2FwcyB8PSAxIDw8IHVz
Yl9yZWRpcl9jYXBfZXBfaW5mb19tYXhfcGFja2V0X3NpemU7Ci0gICAgICAgIGNoLT5ob3N0X2Nh
cHMgfD0gMSA8PCB1c2JfcmVkaXJfY2FwXzY0Yml0c19pZHM7Ci0gICAgICAgIGNoLT5ob3N0X2Nh
cHMgfD0gMSA8PCB1c2JfcmVkaXJfY2FwXzMyYml0c19idWxrX2xlbmd0aDsKLSAgICB9IGVsc2Ug
ewotICAgICAgICBmbGFncyB8PSB1c2JyZWRpcnBhcnNlcl9mbF9ub19oZWxsbzsKLSAgICB9Ci0K
LSAgICBpZiAoY2gtPmhvc3RfY2FwcyAmICgxIDw8IHVzYl9yZWRpcl9jYXBfY29ubmVjdF9kZXZp
Y2VfdmVyc2lvbikpIHsKLSAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMs
IHVzYl9yZWRpcl9jYXBfY29ubmVjdF9kZXZpY2VfdmVyc2lvbik7Ci0gICAgfQorICAgIHVzYnJl
ZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2JfcmVkaXJfY2FwX2Nvbm5lY3RfZGV2aWNl
X3ZlcnNpb24pOwogICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBzLCB1c2JfcmVk
aXJfY2FwX2ZpbHRlcik7Ci0gICAgaWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJf
Y2FwX2RldmljZV9kaXNjb25uZWN0X2FjaykpIHsKLSAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fw
c19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrKTsKLSAg
ICB9Ci0gICAgaWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJfY2FwX2VwX2luZm9f
bWF4X3BhY2tldF9zaXplKSkgewotICAgICAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAo
Y2FwcywgdXNiX3JlZGlyX2NhcF9lcF9pbmZvX21heF9wYWNrZXRfc2l6ZSk7Ci0gICAgfQotICAg
IGlmIChjaC0+aG9zdF9jYXBzICYgKDEgPDwgdXNiX3JlZGlyX2NhcF82NGJpdHNfaWRzKSkgewot
ICAgICAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF82
NGJpdHNfaWRzKTsKLSAgICB9Ci0gICAgaWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVk
aXJfY2FwXzMyYml0c19idWxrX2xlbmd0aCkpIHsKLSAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fw
c19zZXRfY2FwKGNhcHMsIHVzYl9yZWRpcl9jYXBfMzJiaXRzX2J1bGtfbGVuZ3RoKTsKLSAgICB9
Ci0gICAgaWYgKGNoLT5ob3N0X2NhcHMgJiAoMSA8PCB1c2JfcmVkaXJfY2FwX2J1bGtfc3RyZWFt
cykpIHsKLSAgICAgICAgdXNicmVkaXJwYXJzZXJfY2Fwc19zZXRfY2FwKGNhcHMsIHVzYl9yZWRp
cl9jYXBfYnVsa19zdHJlYW1zKTsKLSAgICB9Ci0gICAgdXNicmVkaXJwYXJzZXJfaW5pdChjaC0+
aGlkZGVuX3BhcnNlciwgUEFDS0FHRV9TVFJJTkcsIGNhcHMsIFVTQl9SRURJUl9DQVBTX1NJWkUs
IGZsYWdzKTsKKyAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGly
X2NhcF9kZXZpY2VfZGlzY29ubmVjdF9hY2spOworICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0
X2NhcChjYXBzLCB1c2JfcmVkaXJfY2FwX2VwX2luZm9fbWF4X3BhY2tldF9zaXplKTsKKyAgICB1
c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF82NGJpdHNfaWRz
KTsKKyAgICB1c2JyZWRpcnBhcnNlcl9jYXBzX3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF8z
MmJpdHNfYnVsa19sZW5ndGgpOworICAgIHVzYnJlZGlycGFyc2VyX2NhcHNfc2V0X2NhcChjYXBz
LCB1c2JfcmVkaXJfY2FwX2J1bGtfcmVjZWl2aW5nKTsKKyAgICB1c2JyZWRpcnBhcnNlcl9jYXBz
X3NldF9jYXAoY2FwcywgdXNiX3JlZGlyX2NhcF9idWxrX3N0cmVhbXMpOworCisgICAgdXNicmVk
aXJwYXJzZXJfaW5pdChjaC0+cGFyc2VyLCBQQUNLQUdFX1NUUklORywgY2FwcywgVVNCX1JFRElS
X0NBUFNfU0laRSwgZmxhZ3MpOwogfQogCiAvKgpAQCAtMTE3OCw3ICsxMTczLDcgQEAgc3RhdGlj
IGdib29sZWFuIGF0dGFjaF9lZGV2KFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKmNoLAogICAgICAg
ICAgICBfKCJGYWlsZWQgdG8gcmVkaXJlY3QgZGV2aWNlICVkIiksIDEpOwogICAgICAgICByZXR1
cm4gRkFMU0U7CiAgICAgfQotICAgIGlmIChjaC0+dXNicmVkaXJob3N0ICYmICFjaC0+aGVsbG9f
ZG9uZV9wYXJzZXIpIHsKKyAgICBpZiAoY2gtPnN0YXRlID09IFVTQl9DSEFOTkVMX1NUQVRFX0lO
SVRJQUxJWklORykgewogICAgICAgICAvKgogICAgICAgICAgICAgd2UgY2FuJ3QgaW5pdGlhbGl6
ZSBwYXJzZXIgdW50aWwgd2Ugc2VlIGhlbGxvIGZyb20gdXNicmVkaXIKICAgICAgICAgICAgIGFu
ZCB0aGUgcGFyc2VyIGNhbid0IHdvcmsgdW50aWwgaXQgc2VlcyB0aGUgaGVsbG8gcmVzcG9uc2Uu
CkBAIC0xMTg4LDE1ICsxMTgzLDEzIEBAIHN0YXRpYyBnYm9vbGVhbiBhdHRhY2hfZWRldihTcGlj
ZVVzYkJhY2tlbmRDaGFubmVsICpjaCwKICAgICAgICAgU1BJQ0VfREVCVUcoIiVzIHdhaXRpbmcg
dW50aWwgdGhlIGNoYW5uZWwgaXMgcmVhZHkiLCBfX0ZVTkNUSU9OX18pOwogCiAgICAgfSBlbHNl
IHsKLSAgICAgICAgaW5pdGlhbGl6ZV9wYXJzZXIoY2gsIGNoLT5oaWRkZW5faG9zdCA9PSBOVUxM
KTsKLSAgICAgICAgY2gtPnVzYnJlZGlyaG9zdCA9IE5VTEw7Ci0gICAgICAgIGNoLT5wYXJzZXIg
PSBjaC0+aGlkZGVuX3BhcnNlcjsKKyAgICAgICAgY2gtPnN0YXRlID0gVVNCX0NIQU5ORUxfU1RB
VEVfUEFSU0VSOwogICAgIH0KICAgICBjaC0+d2FpdF9kaXNjb25uZWN0X2FjayA9IDA7CiAgICAg
Y2gtPmF0dGFjaGVkID0gZGV2OwogICAgIGRldi0+YXR0YWNoZWRfdG8gPSBjaDsKLSAgICBkZXZp
Y2Vfb3BzKGRldi0+ZWRldiktPmF0dGFjaChkZXYtPmVkZXYsIGNoLT5oaWRkZW5fcGFyc2VyKTsK
LSAgICBpZiAoY2gtPmhlbGxvX2RvbmVfcGFyc2VyKSB7CisgICAgZGV2aWNlX29wcyhkZXYtPmVk
ZXYpLT5hdHRhY2goZGV2LT5lZGV2LCBjaC0+cGFyc2VyKTsKKyAgICBpZiAoY2gtPnN0YXRlID09
IFVTQl9DSEFOTkVMX1NUQVRFX1BBUlNFUikgewogICAgICAgICAvKiBzZW5kIGRldmljZSBpbmZv
ICovCiAgICAgICAgIHVzYnJlZGlyX2hlbGxvKGNoLCBOVUxMKTsKICAgICB9CkBAIC0xMjE2LDkg
KzEyMDksMTUgQEAgZ2Jvb2xlYW4gc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9hdHRhY2goU3Bp
Y2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gsCiAgICAgICAgIHJldHVybiBhdHRhY2hfZWRldihjaCwg
ZGV2LCBlcnJvcik7CiAgICAgfQogCisgICAgLy8gbm8gcGh5c2ljYWwgZGV2aWNlIGVuYWJsZWQK
KyAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCA9PSBOVUxMKSB7CisgICAgICAgIHJldHVybiBGQUxT
RTsKKyAgICB9CisKICAgICBsaWJ1c2JfZGV2aWNlX2hhbmRsZSAqaGFuZGxlID0gTlVMTDsKLSAg
ICBjaC0+dXNicmVkaXJob3N0ID0gY2gtPmhpZGRlbl9ob3N0OwotICAgIGNoLT5wYXJzZXIgPSBO
VUxMOworICAgIGlmIChjaC0+c3RhdGUgIT0gVVNCX0NIQU5ORUxfU1RBVEVfSU5JVElBTElaSU5H
KSB7CisgICAgICAgIGNoLT5zdGF0ZSA9IFVTQl9DSEFOTkVMX1NUQVRFX0hPU1Q7CisgICAgfQog
CiAgICAgLyoKICAgICAgICBVbmRlciBXaW5kb3dzIHdlIG5lZWQgdG8gYXZvaWQgdXBkYXRpbmcK
QEAgLTEyNTksMTAgKzEyNTgsMTAgQEAgdm9pZCBzcGljZV91c2JfYmFja2VuZF9jaGFubmVsX2Rl
dGFjaChTcGljZVVzYkJhY2tlbmRDaGFubmVsICpjaCkKICAgICAgICAgU1BJQ0VfREVCVUcoIiVz
OiBub3RoaW5nIHRvIGRldGFjaCIsIF9fRlVOQ1RJT05fXyk7CiAgICAgICAgIHJldHVybjsKICAg
ICB9Ci0gICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKKyAgICBpZiAoY2gtPnN0YXRlID09IFVT
Ql9DSEFOTkVMX1NUQVRFX0hPU1QpIHsKICAgICAgICAgLyogaXQgd2lsbCBjYWxsIGxpYnVzYl9j
bG9zZSBpbnRlcm5hbGx5ICovCiAgICAgICAgIHVzYnJlZGlyaG9zdF9zZXRfZGV2aWNlKGNoLT51
c2JyZWRpcmhvc3QsIE5VTEwpOwotICAgIH0gZWxzZSBpZiAoY2gtPnBhcnNlcikgeworICAgIH0g
ZWxzZSB7CiAgICAgICAgIGlmIChlZGV2KSB7CiAgICAgICAgICAgICBkZXZpY2Vfb3BzKGVkZXYp
LT5kZXRhY2goZWRldik7CiAgICAgICAgIH0KQEAgLTEyNzAsOSArMTI2OSw4IEBAIHZvaWQgc3Bp
Y2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9kZXRhY2goU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gp
CiAgICAgICAgIHVzYnJlZGlyX3dyaXRlX2ZsdXNoX2NhbGxiYWNrKGNoKTsKICAgICAgICAgY2gt
PndhaXRfZGlzY29ubmVjdF9hY2sgPQogICAgICAgICAgICAgdXNicmVkaXJwYXJzZXJfcGVlcl9o
YXNfY2FwKGNoLT5wYXJzZXIsIHVzYl9yZWRpcl9jYXBfZGV2aWNlX2Rpc2Nvbm5lY3RfYWNrKTsK
LSAgICAgICAgaWYgKCFjaC0+d2FpdF9kaXNjb25uZWN0X2FjaykgewotICAgICAgICAgICAgY2gt
PnVzYnJlZGlyaG9zdCA9IGNoLT5oaWRkZW5faG9zdDsKLSAgICAgICAgICAgIGNoLT5wYXJzZXIg
PSBOVUxMOworICAgICAgICBpZiAoIWNoLT53YWl0X2Rpc2Nvbm5lY3RfYWNrICYmIGNoLT51c2Jy
ZWRpcmhvc3QgIT0gTlVMTCkgeworICAgICAgICAgICAgY2gtPnN0YXRlID0gVVNCX0NIQU5ORUxf
U1RBVEVfSE9TVDsKICAgICAgICAgfQogICAgIH0KICAgICBTUElDRV9ERUJVRygiJXMgY2ggJXAs
IGRldGFjaCBkb25lIiwgX19GVU5DVElPTl9fLCBjaCk7CkBAIC0xMzA5LDE2ICsxMzA3LDIyIEBA
IFNwaWNlVXNiQmFja2VuZENoYW5uZWwgKnNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfbmV3KFNw
aWNlVXNiQmFja2VuZCAqYmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgdXNicmVkaXJwYXJzZXJfd2FybmluZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgdXNicmVkaXJob3N0X2ZsX3dyaXRlX2NiX293bnNfYnVmZmVyKTsKICAgICAgICAgZ193
YXJuX2lmX2ZhaWwoY2gtPnVzYnJlZGlyaG9zdCAhPSBOVUxMKTsKKyAgICAgICAgaWYgKGNoLT51
c2JyZWRpcmhvc3QgIT0gTlVMTCkgeworICAgICAgICAgICAgdXNicmVkaXJob3N0X3NldF9idWZm
ZXJlZF9vdXRwdXRfc2l6ZV9jYihjaC0+dXNicmVkaXJob3N0LAorICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2JyZWRpcl9idWZmZXJlZF9vdXRw
dXRfc2l6ZV9jYWxsYmFjayk7CisgICAgICAgICAgICAvLyBmb3JjZSBmbHVzaCBvZiBIRUxMTyBw
YWNrZXQgYW5kIGNyZWF0aW9uIG9mIHBhcnNlcgorICAgICAgICAgICAgdXNicmVkaXJob3N0X3dy
aXRlX2d1ZXN0X2RhdGEoY2gtPnVzYnJlZGlyaG9zdCk7CisgICAgICAgIH0KKyAgICB9IGVsc2Ug
eworICAgICAgICAvLyBubyBwaHlzaWNhbCBkZXZpY2Ugc3VwcG9ydCwgb25seSBlbXVsYXRlZCwg
Y3JlYXRlIHRoZQorICAgICAgICAvLyBwYXJzZXIKKyAgICAgICAgY2gtPnBhcnNlciA9IGNyZWF0
ZV9wYXJzZXIoY2gpOworICAgICAgICBpZiAoY2gtPnBhcnNlciAhPSBOVUxMKSB7CisgICAgICAg
ICAgICBpbml0aWFsaXplX3BhcnNlcihjaCk7CisgICAgICAgIH0KICAgICB9CiAKLSAgICBpZiAo
Y2gtPnVzYnJlZGlyaG9zdCkgewotICAgICAgICBjaC0+aGlkZGVuX3BhcnNlciA9IGNyZWF0ZV9w
YXJzZXIoY2gpOwotICAgICAgICBjaC0+aGlkZGVuX2hvc3QgPSBjaC0+dXNicmVkaXJob3N0Owot
ICAgICAgICB1c2JyZWRpcmhvc3Rfc2V0X2J1ZmZlcmVkX291dHB1dF9zaXplX2NiKGNoLT51c2Jy
ZWRpcmhvc3QsCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgdXNicmVkaXJfYnVmZmVyZWRfb3V0cHV0X3NpemVfY2FsbGJhY2spOwotICAgIH0KLQotICAg
IGlmICghY2gtPmhpZGRlbl9wYXJzZXIpIHsKKyAgICBpZiAoIWNoLT5wYXJzZXIpIHsKICAgICAg
ICAgc3BpY2VfdXNiX2JhY2tlbmRfY2hhbm5lbF9kZWxldGUoY2gpOwogICAgICAgICBjaCA9IE5V
TEw7CiAgICAgfQpAQCAtMTMzMCwxMiArMTMzNCw5IEBAIFNwaWNlVXNiQmFja2VuZENoYW5uZWwg
KnNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfbmV3KFNwaWNlVXNiQmFja2VuZCAqYmUsCiB2b2lk
IHNwaWNlX3VzYl9iYWNrZW5kX2NoYW5uZWxfZmx1c2hfd3JpdGVzKFNwaWNlVXNiQmFja2VuZENo
YW5uZWwgKmNoKQogewogICAgIFNQSUNFX0RFQlVHKCIlcyAlcCBpcyB1cCIsIF9fRlVOQ1RJT05f
XywgY2gpOwotICAgIGlmIChjaC0+dXNicmVkaXJob3N0KSB7CisgICAgaWYgKGNoLT5zdGF0ZSAh
PSBVU0JfQ0hBTk5FTF9TVEFURV9QQVJTRVIgJiYgY2gtPnVzYnJlZGlyaG9zdCAhPSBOVUxMKSB7
CiAgICAgICAgIHVzYnJlZGlyaG9zdF93cml0ZV9ndWVzdF9kYXRhKGNoLT51c2JyZWRpcmhvc3Qp
OwotICAgICAgICBpbml0aWFsaXplX3BhcnNlcihjaCwgRkFMU0UpOwogICAgIH0gZWxzZSB7Ci0g
ICAgICAgIGluaXRpYWxpemVfcGFyc2VyKGNoLCBUUlVFKTsKLSAgICAgICAgY2gtPnBhcnNlciA9
IGNoLT5oaWRkZW5fcGFyc2VyOwogICAgICAgICB1c2JyZWRpcnBhcnNlcl9kb193cml0ZShjaC0+
cGFyc2VyKTsKICAgICB9CiB9CkBAIC0xMzQ2LDExICsxMzQ3LDExIEBAIHZvaWQgc3BpY2VfdXNi
X2JhY2tlbmRfY2hhbm5lbF9kZWxldGUoU3BpY2VVc2JCYWNrZW5kQ2hhbm5lbCAqY2gpCiAgICAg
aWYgKCFjaCkgewogICAgICAgICByZXR1cm47CiAgICAgfQotICAgIGlmIChjaC0+aGlkZGVuX2hv
c3QpIHsKLSAgICAgICAgdXNicmVkaXJob3N0X2Nsb3NlKGNoLT5oaWRkZW5faG9zdCk7CisgICAg
aWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKKyAgICAgICAgdXNicmVkaXJob3N0X2Nsb3NlKGNoLT51
c2JyZWRpcmhvc3QpOwogICAgIH0KLSAgICBpZiAoY2gtPmhpZGRlbl9wYXJzZXIpIHsKLSAgICAg
ICAgdXNicmVkaXJwYXJzZXJfZGVzdHJveShjaC0+aGlkZGVuX3BhcnNlcik7CisgICAgaWYgKGNo
LT5wYXJzZXIpIHsKKyAgICAgICAgdXNicmVkaXJwYXJzZXJfZGVzdHJveShjaC0+cGFyc2VyKTsK
ICAgICB9CiAKICAgICBpZiAoY2gtPnJ1bGVzKSB7CkBAIC0xMzcwLDcgKzEzNzEsNyBAQCBzcGlj
ZV91c2JfYmFja2VuZF9jaGFubmVsX2dldF9ndWVzdF9maWx0ZXIoU3BpY2VVc2JCYWNrZW5kQ2hh
bm5lbCAqY2gsCiAgICAgaW50IGk7CiAgICAgKnIgPSBOVUxMOwogICAgICpjb3VudCA9IDA7Ci0g
ICAgaWYgKGNoLT51c2JyZWRpcmhvc3QpIHsKKyAgICBpZiAoY2gtPnVzYnJlZGlyaG9zdCAhPSBO
VUxMKSB7CiAgICAgICAgIHVzYnJlZGlyaG9zdF9nZXRfZ3Vlc3RfZmlsdGVyKGNoLT51c2JyZWRp
cmhvc3QsIHIsIGNvdW50KTsKICAgICB9CiAgICAgaWYgKCpyID09IE5VTEwpIHsKLS0gCjIuMjAu
MQoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KU3BpY2Ut
ZGV2ZWwgbWFpbGluZyBsaXN0ClNwaWNlLWRldmVsQGxpc3RzLmZyZWVkZXNrdG9wLm9yZwpodHRw
czovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZvL3NwaWNlLWRldmVs
