Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id BFF3E55428
	for <lists+spice-devel@lfdr.de>; Tue, 25 Jun 2019 18:12:19 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 355C76E190;
	Tue, 25 Jun 2019 16:12:18 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id DE7366E188
 for <spice-devel@lists.freedesktop.org>; Tue, 25 Jun 2019 16:12:16 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx05.intmail.prod.int.phx2.redhat.com
 [10.5.11.15])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id 8481930860AE
 for <spice-devel@lists.freedesktop.org>; Tue, 25 Jun 2019 16:12:16 +0000 (UTC)
Received: from fziglio.remote.csb (unknown [10.33.32.4])
 by smtp.corp.redhat.com (Postfix) with ESMTP id E33C35B68D;
 Tue, 25 Jun 2019 16:12:14 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Tue, 25 Jun 2019 17:11:41 +0100
Message-Id: <20190625161147.25211-18-fziglio@redhat.com>
In-Reply-To: <20190625161147.25211-1-fziglio@redhat.com>
References: <20190625161147.25211-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.15
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.44]); Tue, 25 Jun 2019 16:12:16 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-server 17/23] websocket: Avoids to write
 close frame in the middle of data
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

U2lnbmVkLW9mZi1ieTogRnJlZGlhbm8gWmlnbGlvIDxmemlnbGlvQHJlZGhhdC5jb20+Ci0tLQog
c2VydmVyL3dlYnNvY2tldC5jIHwgNzUgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrLS0tLS0tLS0tLQogMSBmaWxlIGNoYW5nZWQsIDU5IGluc2VydGlvbnMoKyksIDE2IGRlbGV0
aW9ucygtKQoKZGlmZiAtLWdpdCBhL3NlcnZlci93ZWJzb2NrZXQuYyBiL3NlcnZlci93ZWJzb2Nr
ZXQuYwppbmRleCA5ZmQ1ZmRlNTMuLjcyYTRiMDY0YiAxMDA2NDQKLS0tIGEvc2VydmVyL3dlYnNv
Y2tldC5jCisrKyBiL3NlcnZlci93ZWJzb2NrZXQuYwpAQCAtODUsNiArODUsNyBAQCBzdHJ1Y3Qg
UmVkc1dlYlNvY2tldCB7CiAgICAgdWludDY0X3Qgd3JpdGVfcmVtYWluZGVyOwogICAgIHVpbnQ4
X3Qgd3JpdGVfaGVhZGVyW1dFQlNPQ0tFVF9NQVhfSEVBREVSX1NJWkVdOwogICAgIHVpbnQ4X3Qg
d3JpdGVfaGVhZGVyX3Bvcywgd3JpdGVfaGVhZGVyX2xlbjsKKyAgICBib29sIGNsb3NlX3BlbmRp
bmc7CiAKICAgICB2b2lkICpyYXdfc3RyZWFtOwogICAgIHdlYnNvY2tldF9yZWFkX2NiX3QgcmF3
X3JlYWQ7CkBAIC05Miw3ICs5Myw4IEBAIHN0cnVjdCBSZWRzV2ViU29ja2V0IHsKICAgICB3ZWJz
b2NrZXRfd3JpdGV2X2NiX3QgcmF3X3dyaXRldjsKIH07CiAKLXN0YXRpYyB2b2lkIHdlYnNvY2tl
dF9hY2tfY2xvc2Uodm9pZCAqc3RyZWFtLCB3ZWJzb2NrZXRfd3JpdGVfY2JfdCB3cml0ZV9jYik7
CitzdGF0aWMgaW50IHdlYnNvY2tldF9hY2tfY2xvc2UoUmVkc1dlYlNvY2tldCAqd3MpOworc3Rh
dGljIGludCBzZW5kX3BlbmRpbmdfZGF0YShSZWRzV2ViU29ja2V0ICp3cyk7CiAKIC8qIFBlcmZv
cm0gYSBjYXNlIGluc2Vuc2l0aXZlIHNlYXJjaCBmb3IgbmVlZGxlIGluIGhheXN0YWNrLgogICAg
SWYgZm91bmQsIHJldHVybiBhIHBvaW50ZXIgdG8gdGhlIGJ5dGUgYWZ0ZXIgdGhlIGVuZCBvZiBu
ZWVkbGUuCkBAIC0yODIsNyArMjg0LDExIEBAIGludCB3ZWJzb2NrZXRfcmVhZChSZWRzV2ViU29j
a2V0ICp3cywgdWludDhfdCAqYnVmLCBzaXplX3Qgc2l6ZSkKICAgICBpbnQgcmM7CiAgICAgd2Vi
c29ja2V0X2ZyYW1lX3QgKmZyYW1lID0gJndzLT5yZWFkX2ZyYW1lOwogCi0gICAgaWYgKHdzLT5j
bG9zZWQpIHsKKyAgICBpZiAod3MtPmNsb3NlZCB8fCB3cy0+Y2xvc2VfcGVuZGluZykgeworICAg
ICAgICAvKiB0aGlzIGF2b2lkcyBpbmZpbml0ZSBsb29wIGluIHRoZSBjYXNlIGNvbm5lY3Rpb24g
aXMgc3RpbGwgb3BlbiBhbmQgd2UgaGF2ZQorICAgICAgICAgKiBwZW5kaW5nIGRhdGEgKi8KKyAg
ICAgICAgdWludDhfdCBkaXNjYXJkWzEyOF07CisgICAgICAgIHdzLT5yYXdfcmVhZCh3cy0+cmF3
X3N0cmVhbSwgZGlzY2FyZCwgc2l6ZW9mKGRpc2NhcmQpKTsKICAgICAgICAgcmV0dXJuIDA7CiAg
ICAgfQogCkBAIC0zMDIsOSArMzA4LDkgQEAgaW50IHdlYnNvY2tldF9yZWFkKFJlZHNXZWJTb2Nr
ZXQgKndzLCB1aW50OF90ICpidWYsIHNpemVfdCBzaXplKQogICAgICAgICAgICAgICAgIHJldHVy
biAtMTsKICAgICAgICAgICAgIH0KICAgICAgICAgfSBlbHNlIGlmIChmcmFtZS0+dHlwZSA9PSBD
TE9TRV9GUkFNRSkgewotICAgICAgICAgICAgd2Vic29ja2V0X2Fja19jbG9zZSh3cy0+cmF3X3N0
cmVhbSwgd3MtPnJhd193cml0ZSk7CisgICAgICAgICAgICB3cy0+Y2xvc2VfcGVuZGluZyA9IHRy
dWU7CiAgICAgICAgICAgICB3ZWJzb2NrZXRfY2xlYXJfZnJhbWUoZnJhbWUpOwotICAgICAgICAg
ICAgd3MtPmNsb3NlZCA9IHRydWU7CisgICAgICAgICAgICBzZW5kX3BlbmRpbmdfZGF0YSh3cyk7
CiAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgfSBlbHNlIGlmIChmcmFtZS0+dHlwZSA9
PSBCSU5BUllfRlJBTUUpIHsKICAgICAgICAgICAgIHJjID0gd3MtPnJhd19yZWFkKHdzLT5yYXdf
c3RyZWFtLCBidWYsCkBAIC00MTgsMTUgKzQyNCw0NCBAQCBzdGF0aWMgaW50IHNlbmRfZGF0YV9o
ZWFkZXJfbGVmdChSZWRzV2ViU29ja2V0ICp3cykKIAogc3RhdGljIGludCBzZW5kX2RhdGFfaGVh
ZGVyKFJlZHNXZWJTb2NrZXQgKndzLCB1aW50NjRfdCBsZW4pCiB7Ci0gICAgLyogaWYgd2UgZG9u
J3QgaGF2ZSBhIHBlbmRpbmcgaGVhZGVyIGZpbGwgaXQgKi8KLSAgICBpZiAod3MtPndyaXRlX2hl
YWRlcl9wb3MgPj0gd3MtPndyaXRlX2hlYWRlcl9sZW4pIHsKLSAgICAgICAgd3MtPndyaXRlX2hl
YWRlcl9wb3MgPSAwOwotICAgICAgICB3cy0+d3JpdGVfaGVhZGVyX2xlbiA9IGZpbGxfaGVhZGVy
KHdzLT53cml0ZV9oZWFkZXIsIGxlbik7Ci0gICAgfQorICAgIHNwaWNlX2Fzc2VydCh3cy0+d3Jp
dGVfaGVhZGVyX3BvcyA+PSB3cy0+d3JpdGVfaGVhZGVyX2xlbik7CisgICAgc3BpY2VfYXNzZXJ0
KHdzLT53cml0ZV9yZW1haW5kZXIgPT0gMCk7CisKKyAgICAvKiBmaWxsIGEgbmV3IGhlYWRlciAq
LworICAgIHdzLT53cml0ZV9oZWFkZXJfcG9zID0gMDsKKyAgICB3cy0+d3JpdGVfaGVhZGVyX2xl
biA9IGZpbGxfaGVhZGVyKHdzLT53cml0ZV9oZWFkZXIsIGxlbik7CiAKICAgICByZXR1cm4gc2Vu
ZF9kYXRhX2hlYWRlcl9sZWZ0KHdzKTsKIH0KIAorc3RhdGljIGludCBzZW5kX3BlbmRpbmdfZGF0
YShSZWRzV2ViU29ja2V0ICp3cykKK3sKKyAgICBpbnQgcmM7CisKKyAgICAvKiBkb24ndCBzZW5k
IHdoaWxlIHdlIGFyZSBzZW5kaW5nIGEgZGF0YSBmcmFtZSAqLworICAgIGlmICh3cy0+d3JpdGVf
cmVtYWluZGVyKSB7CisgICAgICAgIHJldHVybiAxOworICAgIH0KKworICAgIC8qIHdyaXRlIHBl
bmRpbmcgZGF0YSBmcmFtZSBoZWFkZXIgbm90IHNlbmQgY29tcGxldGVseSAqLworICAgIGlmICh3
cy0+d3JpdGVfaGVhZGVyX3BvcyA8IHdzLT53cml0ZV9oZWFkZXJfbGVuKSB7CisgICAgICAgIHJj
ID0gc2VuZF9kYXRhX2hlYWRlcl9sZWZ0KHdzKTsKKyAgICAgICAgaWYgKHJjIDw9IDApIHsKKyAg
ICAgICAgICAgIHJldHVybiByYzsKKyAgICAgICAgfQorICAgICAgICByZXR1cm4gMTsKKyAgICB9
CisKKyAgICAvKiB3cml0ZSBjbG9zZSBmcmFtZSAqLworICAgIGlmICh3cy0+Y2xvc2VfcGVuZGlu
ZykgeworICAgICAgICByYyA9IHdlYnNvY2tldF9hY2tfY2xvc2Uod3MpOworICAgICAgICBpZiAo
cmMgPD0gMCkgeworICAgICAgICAgICAgcmV0dXJuIHJjOworICAgICAgICB9CisgICAgfQorICAg
IHJldHVybiAxOworfQorCiAvKiBXcml0ZSBhIFdlYlNvY2tldCBmcmFtZSB3aXRoIHRoZSBlbmNs
b3NlZCBkYXRhIG91dC4gKi8KIGludCB3ZWJzb2NrZXRfd3JpdGV2KFJlZHNXZWJTb2NrZXQgKndz
LCBjb25zdCBzdHJ1Y3QgaW92ZWMgKmlvdiwgaW50IGlvdmNudCkKIHsKQEAgLTQ0MCwxMSArNDc1
LDkgQEAgaW50IHdlYnNvY2tldF93cml0ZXYoUmVkc1dlYlNvY2tldCAqd3MsIGNvbnN0IHN0cnVj
dCBpb3ZlYyAqaW92LCBpbnQgaW92Y250KQogICAgICAgICBlcnJubyA9IEVQSVBFOwogICAgICAg
ICByZXR1cm4gLTE7CiAgICAgfQotICAgIGlmICh3cy0+d3JpdGVfaGVhZGVyX3BvcyA8IHdzLT53
cml0ZV9oZWFkZXJfbGVuKSB7Ci0gICAgICAgIHJjID0gc2VuZF9kYXRhX2hlYWRlcl9sZWZ0KHdz
KTsKLSAgICAgICAgaWYgKHJjIDw9IDApIHsKLSAgICAgICAgICAgIHJldHVybiByYzsKLSAgICAg
ICAgfQorICAgIHJjID0gc2VuZF9wZW5kaW5nX2RhdGEod3MpOworICAgIGlmIChyYyA8PSAwKSB7
CisgICAgICAgIHJldHVybiByYzsKICAgICB9CiAgICAgaWYgKHdzLT53cml0ZV9yZW1haW5kZXIg
PiAwKSB7CiAgICAgICAgIGNvbnN0cmFpbl9pb3YoKHN0cnVjdCBpb3ZlYyAqKSBpb3YsIGlvdmNu
dCwgJmlvdl9vdXQsICZpb3Zfb3V0X2NudCwgd3MtPndyaXRlX3JlbWFpbmRlcik7CkBAIC01MDQs
NiArNTM3LDEwIEBAIGludCB3ZWJzb2NrZXRfd3JpdGUoUmVkc1dlYlNvY2tldCAqd3MsIGNvbnN0
IHZvaWQgKmJ1Ziwgc2l6ZV90IGxlbikKICAgICAgICAgcmV0dXJuIC0xOwogICAgIH0KIAorICAg
IHJjID0gc2VuZF9wZW5kaW5nX2RhdGEod3MpOworICAgIGlmIChyYyA8PSAwKSB7CisgICAgICAg
IHJldHVybiByYzsKKyAgICB9CiAgICAgaWYgKHdzLT53cml0ZV9yZW1haW5kZXIgPT0gMCkgewog
ICAgICAgICByYyA9IHNlbmRfZGF0YV9oZWFkZXIod3MsIGxlbik7CiAgICAgICAgIGlmIChyYyA8
PSAwKSB7CkBAIC01MjEsMTQgKzU1OCwyMCBAQCBpbnQgd2Vic29ja2V0X3dyaXRlKFJlZHNXZWJT
b2NrZXQgKndzLCBjb25zdCB2b2lkICpidWYsIHNpemVfdCBsZW4pCiAgICAgcmV0dXJuIHJjOwog
fQogCi1zdGF0aWMgdm9pZCB3ZWJzb2NrZXRfYWNrX2Nsb3NlKHZvaWQgKnN0cmVhbSwgd2Vic29j
a2V0X3dyaXRlX2NiX3Qgd3JpdGVfY2IpCitzdGF0aWMgaW50IHdlYnNvY2tldF9hY2tfY2xvc2Uo
UmVkc1dlYlNvY2tldCAqd3MpCiB7CiAgICAgdW5zaWduZWQgY2hhciBoZWFkZXJbMl07CisgICAg
aW50IHJjOwogCiAgICAgaGVhZGVyWzBdID0gRklOX0ZMQUcgfCBDTE9TRV9GUkFNRTsKICAgICBo
ZWFkZXJbMV0gPSAwOwogCi0gICAgd3JpdGVfY2Ioc3RyZWFtLCBoZWFkZXIsIHNpemVvZihoZWFk
ZXIpKTsKKyAgICByYyA9IHdzLT5yYXdfd3JpdGUod3MtPnJhd19zdHJlYW0sIGhlYWRlciwgc2l6
ZW9mKGhlYWRlcikpOworICAgIGlmIChyYyA9PSBzaXplb2YoaGVhZGVyKSkgeworICAgICAgICB3
cy0+Y2xvc2VfcGVuZGluZyA9IGZhbHNlOworICAgICAgICB3cy0+Y2xvc2VkID0gdHJ1ZTsKKyAg
ICB9CisgICAgcmV0dXJuIHJjOwogfQogCiBzdGF0aWMgYm9vbCB3ZWJzb2NrZXRfaXNfc3RhcnQo
Y2hhciAqYnVmKQotLSAKMi4yMC4xCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fXwpTcGljZS1kZXZlbCBtYWlsaW5nIGxpc3QKU3BpY2UtZGV2ZWxAbGlzdHMu
ZnJlZWRlc2t0b3Aub3JnCmh0dHBzOi8vbGlzdHMuZnJlZWRlc2t0b3Aub3JnL21haWxtYW4vbGlz
dGluZm8vc3BpY2UtZGV2ZWw=
