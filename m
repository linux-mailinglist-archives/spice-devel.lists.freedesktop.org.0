Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [IPv6:2610:10:20:722:a800:ff:fe36:1795])
	by mail.lfdr.de (Postfix) with ESMTPS id BCEE68355E
	for <lists+spice-devel@lfdr.de>; Tue,  6 Aug 2019 17:35:03 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 5D98E89D7D;
	Tue,  6 Aug 2019 15:35:01 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mail-wm1-f45.google.com (mail-wm1-f45.google.com
 [209.85.128.45])
 by gabe.freedesktop.org (Postfix) with ESMTPS id C52C689D79
 for <spice-devel@lists.freedesktop.org>; Tue,  6 Aug 2019 15:34:59 +0000 (UTC)
Received: by mail-wm1-f45.google.com with SMTP id s3so78642752wms.2
 for <spice-devel@lists.freedesktop.org>; Tue, 06 Aug 2019 08:34:59 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:from:to:subject:date:message-id:in-reply-to
 :references:mime-version:content-transfer-encoding;
 bh=6OZzKm8Tz3CT/Gf6lh4PG/6XM37mWhbrhJKjbhLW6oU=;
 b=X2+FtftZBXj2UDaBBlLSLk0OI2bsy6V/4NMdiGLvSSgWCRJ0QUYJrgOJhqyHCMn0bC
 zz+At/hwnMAMTLnDDjJ3S/bFnBdc4uXBGZH74zmKWJBoP09PlRJxnWvjLYqpZq3ttBBP
 E85Q2VrPg9xwdhxUvdbTAIpyNT/CRNnKdxiDP/s94orQW26HE2osreujJzjD7iNBTe6c
 sjCYCVuPPIbLdbN9unfvJ/OUMXOjHdLPopKGGjuQrLj+0/ZDhL2wYnvRvKLOSCrVXYq4
 tRX0fEmOKKM9ZNKGB9akGA2OWiKQ4n58fn3X4UDN3N01MTOuqww41nt4AOGiZq+QSLW+
 1vqQ==
X-Gm-Message-State: APjAAAVLxKsm4i/Md6c3RKpKvp0rwaSZCzCEGHbArhHrbyGusaPdbJC9
 HsLLOs9kw6r5zuhr+VQkiEGwS+K/chRjxw==
X-Google-Smtp-Source: APXvYqzGpxL61TaSyXeSBiylZe+rNAUL7RUQMzzWgx7yA+i5VqX6V1t7Jdbnw+8JZbhAo0yipw5i6Q==
X-Received: by 2002:a05:600c:214e:: with SMTP id
 v14mr5566420wml.96.1565105698096; 
 Tue, 06 Aug 2019 08:34:58 -0700 (PDT)
Received: from pinea.redhat.com (25.119.19.109.rev.sfr.net. [109.19.119.25])
 by smtp.gmail.com with ESMTPSA id y18sm84860282wmi.23.2019.08.06.08.34.57
 for <spice-devel@lists.freedesktop.org>
 (version=TLS1_3 cipher=AEAD-AES256-GCM-SHA384 bits=256/256);
 Tue, 06 Aug 2019 08:34:57 -0700 (PDT)
From: Kevin Pouget <kpouget@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Tue,  6 Aug 2019 17:34:46 +0200
Message-Id: <20190806153453.20616-3-kpouget@redhat.com>
X-Mailer: git-send-email 2.21.0
In-Reply-To: <20190806153453.20616-1-kpouget@redhat.com>
References: <20190806153453.20616-1-kpouget@redhat.com>
MIME-Version: 1.0
Subject: [Spice-devel] [RFC spice-server 2/3] stream-channel: Use the
 preferred codec list instead of supported
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

VGhpcyBwYXRjaCBjb21wdXRlcyBhbmQgc2VuZHMgdGhlIGxpc3Qgb2YgdGhlIHZpZGVvIGNvZGVj
cyBwcmVmZXJyZWQKYnkgYWxsIHRoZSBjbGllbnRzIHdoZW4gcmVxdWVzdGluZyB0byBzdGFydCBv
ciByZXNldCBhIHZpZGVvIHN0cmVhbS4KCkl0IHVzZWQgdG8gYmUgdGhlIGxpc3Qgb2YgdGhlIHN1
cHBvcnRlZCBjb2RlY3MuCgpUaGUgTUpQRUcgY29kZWMgaXMgdXNlZCBhcyBhIGZhbGxiYWNrIGlm
IHRoZXJlIGlzIG5vIGNvZGVjIHByZWZlcnJlZApieSBhbGwgdGhlIGNsaWVudHMuCgpOb3RlOiBh
dCB0aGUgbW9tZW50LCB0aGUgc2VydmVyJ3MgbGlzdCBvZiBhbGxvd2VkIHZpZGVvLXN0cmVhbSBj
b2RlY3MKaXMgdXNlZCB0byBkaXNhYmxlIHRoZSB1c2FnZSBvZiBzb21lIGNvZGVjcy4gVGhpcyBt
YXkgbm90IGJlIHRoZSBiZXN0Cm9wdGlvbi4gVG8gYmUgZnVydGhlciBkaXNjdXNzZWQgLi4uCgpT
aWduZWQtb2ZmLWJ5OiBLZXZpbiBQb3VnZXQgPGtwb3VnZXRAcmVkaGF0LmNvbT4KLS0tCiBzZXJ2
ZXIvc3RyZWFtLWNoYW5uZWwuYyB8IDg0ICsrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysr
Ky0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgNjkgaW5zZXJ0aW9ucygrKSwgMTUgZGVsZXRpb25z
KC0pCgpkaWZmIC0tZ2l0IGEvc2VydmVyL3N0cmVhbS1jaGFubmVsLmMgYi9zZXJ2ZXIvc3RyZWFt
LWNoYW5uZWwuYwppbmRleCBmYTQ4MDRmMS4uZTBlNDE4OTUgMTAwNjQ0Ci0tLSBhL3NlcnZlci9z
dHJlYW0tY2hhbm5lbC5jCisrKyBiL3NlcnZlci9zdHJlYW0tY2hhbm5lbC5jCkBAIC0zNTYsMTIg
KzM1NiwxNyBAQCBzdHJlYW1fY2hhbm5lbF9uZXcoUmVkc1N0YXRlICpzZXJ2ZXIsIHVpbnQzMl90
IGlkKQoKICNkZWZpbmUgTUFYX1NVUFBPUlRFRF9DT0RFQ1MgU1BJQ0VfVklERU9fQ09ERUNfVFlQ
RV9FTlVNX0VORAoKLS8vIGZpbmQgY29tbW9uIGNvZGVjcyBzdXBwb3J0ZWQgYnkgYWxsIGNsaWVu
dHMKKy8vIGZpbmQgY29tbW9uIGNvZGVjcyBwcmVmZXJyZWQgYnkgYWxsIGNsaWVudHMKIHN0YXRp
YyB1aW50OF90Ci1zdHJlYW1fY2hhbm5lbF9nZXRfc3VwcG9ydGVkX2NvZGVjcyhTdHJlYW1DaGFu
bmVsICpjaGFubmVsLCB1aW50OF90ICpvdXRfY29kZWNzKQorc3RyZWFtX2NoYW5uZWxfZ2V0X3By
ZWZlcnJlZF9jb2RlY3MoU3RyZWFtQ2hhbm5lbCAqY2hhbm5lbCwgdWludDhfdCAqb3V0X2NvZGVj
cykKIHsKKyAgICBSZWRDaGFubmVsICpyZWRfY2hhbm5lbCA9IFJFRF9DSEFOTkVMKGNoYW5uZWwp
OworICAgIFJlZHNTdGF0ZSAqcmVkcyA9IHJlZF9jaGFubmVsX2dldF9zZXJ2ZXIocmVkX2NoYW5u
ZWwpOworICAgIEdBcnJheSAqYWxsb3dlZF9jb2RlY3MgPSByZWRzX2dldF92aWRlb19jb2RlY3Mo
cmVkcyk7CisKICAgICBSZWRDaGFubmVsQ2xpZW50ICpyY2M7CiAgICAgaW50IGNvZGVjOworICAg
IGludCBpOwoKICAgICBzdGF0aWMgY29uc3QgdWludDE2X3QgY29kZWMyY2FwW10gPSB7CiAgICAg
ICAgIDAsIC8vIGludmFsaWQKQEAgLTM3MiwyOSArMzc3LDc4IEBAIHN0cmVhbV9jaGFubmVsX2dl
dF9zdXBwb3J0ZWRfY29kZWNzKFN0cmVhbUNoYW5uZWwgKmNoYW5uZWwsIHVpbnQ4X3QgKm91dF9j
b2RlY3MpCiAgICAgICAgIFNQSUNFX0RJU1BMQVlfQ0FQX0NPREVDX0gyNjUsCiAgICAgfTsKCi0g
ICAgYm9vbCBzdXBwb3J0ZWRbU1BJQ0VfTl9FTEVNRU5UUyhjb2RlYzJjYXApXTsKKyAgICB1bnNp
Z25lZCBpbnQgd2VpZ2h0W1NQSUNFX05fRUxFTUVOVFMoY29kZWMyY2FwKV07CisKKyAgICAvKiBm
aWxsIHRoZSB3ZWlnaHQgYXJyYXkgd2l0aCBhIHByZWZlcmVuY2Ugd2VpZ2h0OiAwIGlzIG5vdAor
ICAgICAqIHN1cHBvcnRlZCwgb3RoZXJ3aXNlOiB3ZWlnaHQgOj0gc3VtKHBvc2l0aW9uIGluIHBy
ZWZlcmVuY2UKKyAgICAgKiBhcnJheSwgZm9yIGVhY2ggY2xpZW50KS4gKi8KCi0gICAgZm9yIChj
b2RlYyA9IDA7IGNvZGVjIDwgU1BJQ0VfTl9FTEVNRU5UUyhjb2RlYzJjYXApOyArK2NvZGVjKSB7
Ci0gICAgICAgIHN1cHBvcnRlZFtjb2RlY10gPSB0cnVlOworICAgIC8vIGRpc2FibGUgY29kZWNz
IG5vdCBhbGxvd2VkIGJ5IHRoZSBzZXJ2ZXIgY29uZmlndXJhdGlvbgorICAgIGZvciAoY29kZWMg
PSAxOyBjb2RlYyA8IFNQSUNFX05fRUxFTUVOVFMoY29kZWMyY2FwKTsgKytjb2RlYykgeworICAg
ICAgICB3ZWlnaHRbY29kZWNdID0gMDsKKyAgICAgICAgZm9yIChpID0gMDsgaSA8IGFsbG93ZWRf
Y29kZWNzLT5sZW47IGkrKykgeworICAgICAgICAgICAgUmVkVmlkZW9Db2RlYyBwcmVmX2NvZGVj
ID0gZ19hcnJheV9pbmRleChhbGxvd2VkX2NvZGVjcywgUmVkVmlkZW9Db2RlYywgaSk7CisKKyAg
ICAgICAgICAgIGlmIChwcmVmX2NvZGVjLnR5cGUgPT0gY29kZWMpIHsKKyAgICAgICAgICAgICAg
ICB3ZWlnaHRbY29kZWNdID0gMTsKKyAgICAgICAgICAgICAgICBicmVhazsKKyAgICAgICAgICAg
IH0KKyAgICAgICAgfQogICAgIH0KCiAgICAgRk9SRUFDSF9DTElFTlQoY2hhbm5lbCwgcmNjKSB7
CisgICAgICAgIFN0cmVhbUNoYW5uZWxDbGllbnQgKnNjYyA9IFNUUkVBTV9DSEFOTkVMX0NMSUVO
VChyY2MpOworICAgICAgICBHQXJyYXkgKnByZWZlcnJlZF9jb2RlY3MgPSBzY2MtPmNsaWVudF9w
cmVmZXJyZWRfdmlkZW9fY29kZWNzOworCisgICAgICAgIGdfYXNzZXJ0KHByZWZlcnJlZF9jb2Rl
Y3MgPT0gTlVMTCB8fAorICAgICAgICAgICAgICAgICBwcmVmZXJyZWRfY29kZWNzLT5sZW4gPT0g
U1BJQ0VfVklERU9fQ09ERUNfVFlQRV9FTlVNX0VORCk7CisKICAgICAgICAgZm9yIChjb2RlYyA9
IDE7IGNvZGVjIDwgU1BJQ0VfTl9FTEVNRU5UUyhjb2RlYzJjYXApOyArK2NvZGVjKSB7Ci0gICAg
ICAgICAgICAvLyBpZiBkbyBub3Qgc3VwcG9ydCBjb2RlYyBkZWxldGUgZnJvbSBsaXN0CisgICAg
ICAgICAgICAvLyBza2lwIHRoZSBjb2RlYyBpZiBpdCBpcyBhbHJlYWR5IG5vdCBzdXBwb3J0ZWQK
KyAgICAgICAgICAgIGlmICghd2VpZ2h0W2NvZGVjXSkgeworICAgICAgICAgICAgICAgIGNvbnRp
bnVlOworICAgICAgICAgICAgfQorCisgICAgICAgICAgICAvLyBkZWxldGUgZnJvbSB0aGUgbGlz
dCBpZiBpdCdzIG5vdCBzdXBwb3J0ZWQgYnkgdGhpcyBjbGllbnQKICAgICAgICAgICAgIGlmICgh
cmVkX2NoYW5uZWxfY2xpZW50X3Rlc3RfcmVtb3RlX2NhcChyY2MsIGNvZGVjMmNhcFtjb2RlY10p
KSB7Ci0gICAgICAgICAgICAgICAgc3VwcG9ydGVkW2NvZGVjXSA9IGZhbHNlOworICAgICAgICAg
ICAgICAgIHdlaWdodFtjb2RlY10gPSAwOworICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAg
ICAgICAgICAgfQorCisgICAgICAgICAgICAvLyB0aGUgY2xpZW50IGRpZG4ndCBwcm92aWRlIGEg
cHJlZmVycmVkIGNvZGVjcyBsaXN0CisgICAgICAgICAgICBpZiAocHJlZmVycmVkX2NvZGVjcyA9
PSBOVUxMKSB7CisgICAgICAgICAgICAgICAgY29udGludWU7CisgICAgICAgICAgICB9CisKKyAg
ICAgICAgICAgIC8vIGRlbGV0ZSB0aGUgY29kZWMgZnJvbSB0aGUgbGlzdCBpZiBpdCdzIG5vdCBp
biB0aGUgcHJlZmVycmVkIGxpc3QKKyAgICAgICAgICAgIHdlaWdodFtjb2RlY10gKz0gZ19hcnJh
eV9pbmRleChwcmVmZXJyZWRfY29kZWNzLCBnaW50LCBjb2RlYyk7CiAgICAgICAgIH0KICAgICB9
CgotICAgIC8vIHN1cmVseSBtanBlZyBpcyBzdXBwb3J0ZWQKLSAgICBzdXBwb3J0ZWRbU1BJQ0Vf
VklERU9fQ09ERUNfVFlQRV9NSlBFR10gPSB0cnVlOwotCisgICAgLyogc29ydCB0aGUgY29kZWMg
YnkgdGhlIHByZWZlcnJlbmNlIHdlaWdodCwgbG93ZXIgaXMgYmV0dGVyICovCiAgICAgaW50IG51
bSA9IDA7Ci0gICAgZm9yIChjb2RlYyA9IDE7IGNvZGVjIDwgU1BJQ0VfTl9FTEVNRU5UUyhjb2Rl
YzJjYXApOyArK2NvZGVjKSB7Ci0gICAgICAgIGlmIChzdXBwb3J0ZWRbY29kZWNdKSB7Ci0gICAg
ICAgICAgICBvdXRfY29kZWNzW251bSsrXSA9IGNvZGVjOworCisgICAgd2hpbGUgKHRydWUpIHsK
KyAgICAgICAgdW5zaWduZWQgaW50IG1pbl9jb2RlYywgbWluX3dlaWdodCA9IFVJTlRfTUFYOwor
CisgICAgICAgIGZvciAoY29kZWMgPSAxOyBjb2RlYyA8IFNQSUNFX05fRUxFTUVOVFMoY29kZWMy
Y2FwKTsgKytjb2RlYykgeworCisgICAgICAgICAgICBpZiAod2VpZ2h0W2NvZGVjXSAmJiB3ZWln
aHRbY29kZWNdIDwgbWluX3dlaWdodCkgeworICAgICAgICAgICAgICAgIG1pbl9jb2RlYyA9IGNv
ZGVjOworICAgICAgICAgICAgICAgIG1pbl93ZWlnaHQgPSB3ZWlnaHRbY29kZWNdOworICAgICAg
ICAgICAgfQorICAgICAgICB9CisgICAgICAgIGlmIChtaW5fd2VpZ2h0ID09IFVJTlRfTUFYKSB7
CisgICAgICAgICAgICBicmVhazsKICAgICAgICAgfQorCisgICAgICAgIG91dF9jb2RlY3NbbnVt
KytdID0gbWluX2NvZGVjOworICAgICAgICB3ZWlnaHRbbWluX2NvZGVjXSA9IDA7CisgICAgfQor
CisgICAgaWYgKG51bSA9PSAwKSB7CisgICAgICAgIC8vIGZhbGxiYWNrLCBzdXJlbHkgbWpwZWcg
aXMgc3VwcG9ydGVkCisgICAgICAgIG91dF9jb2RlY3NbbnVtKytdID0gU1BJQ0VfVklERU9fQ09E
RUNfVFlQRV9NSlBFRzsKICAgICB9CgogICAgIHJldHVybiBudW07CkBAIC00MzIsNyArNDg2LDcg
QEAgc3RyZWFtX2NoYW5uZWxfY29ubmVjdChSZWRDaGFubmVsICpyZWRfY2hhbm5lbCwgUmVkQ2xp
ZW50ICpyZWRfY2xpZW50LCBSZWRTdHJlYW0KICAgICBzcGljZV9yZXR1cm5faWZfZmFpbChjbGll
bnQgIT0gTlVMTCk7CgogICAgIC8vIHJlcXVlc3QgbmV3IHN0cmVhbQotICAgIHN0YXJ0LT5udW1f
Y29kZWNzID0gc3RyZWFtX2NoYW5uZWxfZ2V0X3N1cHBvcnRlZF9jb2RlY3MoY2hhbm5lbCwgc3Rh
cnQtPmNvZGVjcyk7CisgICAgc3RhcnQtPm51bV9jb2RlY3MgPSBzdHJlYW1fY2hhbm5lbF9nZXRf
cHJlZmVycmVkX2NvZGVjcyhjaGFubmVsLCBzdGFydC0+Y29kZWNzKTsKICAgICAvLyBzZW5kIGlu
IGFueSBjYXNlLCBldmVuIGlmIGxpc3QgaXMgbm90IGNoYW5nZWQKICAgICAvLyBub3RpZnkgZGV2
aWNlIGFib3V0IGNoYW5nZXMKICAgICByZXF1ZXN0X25ld19zdHJlYW0oY2hhbm5lbCwgc3RhcnQp
OwpAQCAtNjQ3LDcgKzcwMSw3IEBAIHN0cmVhbV9jaGFubmVsX3Jlc2V0KFN0cmVhbUNoYW5uZWwg
KmNoYW5uZWwpCgogICAgIC8vIHRyeSB0byByZXF1ZXN0IGEgbmV3IHN0cmVhbSwgdGhpcyBzaG91
bGQgc3RhcnQgYSBuZXcgc3RyZWFtCiAgICAgLy8gaWYgdGhlIGd1ZXN0IGlzIGNvbm5lY3RlZCB0
byB0aGUgZGV2aWNlIGFuZCBhIGNsaWVudCBpcyBhbHJlYWR5IGNvbm5lY3RlZAotICAgIHN0YXJ0
LT5udW1fY29kZWNzID0gc3RyZWFtX2NoYW5uZWxfZ2V0X3N1cHBvcnRlZF9jb2RlY3MoY2hhbm5l
bCwgc3RhcnQtPmNvZGVjcyk7CisgICAgc3RhcnQtPm51bV9jb2RlY3MgPSBzdHJlYW1fY2hhbm5l
bF9nZXRfcHJlZmVycmVkX2NvZGVjcyhjaGFubmVsLCBzdGFydC0+Y29kZWNzKTsKICAgICAvLyBz
ZW5kIGluIGFueSBjYXNlLCBldmVuIGlmIGxpc3QgaXMgbm90IGNoYW5nZWQKICAgICAvLyBub3Rp
ZnkgZGV2aWNlIGFib3V0IGNoYW5nZXMKICAgICByZXF1ZXN0X25ld19zdHJlYW0oY2hhbm5lbCwg
c3RhcnQpOwotLQoyLjIxLjAKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX18KU3BpY2UtZGV2ZWwgbWFpbGluZyBsaXN0ClNwaWNlLWRldmVsQGxpc3RzLmZyZWVk
ZXNrdG9wLm9yZwpodHRwczovL2xpc3RzLmZyZWVkZXNrdG9wLm9yZy9tYWlsbWFuL2xpc3RpbmZv
L3NwaWNlLWRldmVs
