Return-Path: <spice-devel-bounces@lists.freedesktop.org>
X-Original-To: lists+spice-devel@lfdr.de
Delivered-To: lists+spice-devel@lfdr.de
Received: from gabe.freedesktop.org (gabe.freedesktop.org [131.252.210.177])
	by mail.lfdr.de (Postfix) with ESMTPS id B4F0448794
	for <lists+spice-devel@lfdr.de>; Mon, 17 Jun 2019 17:40:31 +0200 (CEST)
Received: from gabe.freedesktop.org (localhost [127.0.0.1])
	by gabe.freedesktop.org (Postfix) with ESMTP id 36E73891B3;
	Mon, 17 Jun 2019 15:40:30 +0000 (UTC)
X-Original-To: spice-devel@lists.freedesktop.org
Delivered-To: spice-devel@lists.freedesktop.org
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
 by gabe.freedesktop.org (Postfix) with ESMTPS id 4DE5A89189
 for <spice-devel@lists.freedesktop.org>; Mon, 17 Jun 2019 15:40:28 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx02.intmail.prod.int.phx2.redhat.com
 [10.5.11.12])
 (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
 (No client certificate requested)
 by mx1.redhat.com (Postfix) with ESMTPS id E914C307D96F
 for <spice-devel@lists.freedesktop.org>; Mon, 17 Jun 2019 15:40:27 +0000 (UTC)
Received: from fziglio.remote.csb (unknown [10.40.205.51])
 by smtp.corp.redhat.com (Postfix) with ESMTP id 423DD5C2F5;
 Mon, 17 Jun 2019 15:40:25 +0000 (UTC)
From: Frediano Ziglio <fziglio@redhat.com>
To: spice-devel@lists.freedesktop.org
Date: Mon, 17 Jun 2019 16:40:11 +0100
Message-Id: <20190617154011.20310-4-fziglio@redhat.com>
In-Reply-To: <20190617154011.20310-1-fziglio@redhat.com>
References: <20190617154011.20310-1-fziglio@redhat.com>
MIME-Version: 1.0
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.12
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
 (mx1.redhat.com [10.5.110.48]); Mon, 17 Jun 2019 15:40:27 +0000 (UTC)
Subject: [Spice-devel] [PATCH spice-server 4/4] spicevmc: Avoids DoS if
 guest device is not able to get data faster enough
X-BeenThere: spice-devel@lists.freedesktop.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: <spice-devel.lists.freedesktop.org>
List-Unsubscribe: <https://lists.freedesktop.org/mailman/options/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=unsubscribe>
List-Archive: <https://lists.freedesktop.org/archives/spice-devel>
List-Post: <mailto:spice-devel@lists.freedesktop.org>
List-Help: <mailto:spice-devel-request@lists.freedesktop.org?subject=help>
List-Subscribe: <https://lists.freedesktop.org/mailman/listinfo/spice-devel>, 
 <mailto:spice-devel-request@lists.freedesktop.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: spice-devel-bounces@lists.freedesktop.org
Sender: "Spice-devel" <spice-devel-bounces@lists.freedesktop.org>

VGhpcyBmaXggaGFsZiAob25lIGRpcmVjdGlvbikgb2YKaHR0cHM6Ly9naXRsYWIuZnJlZWRlc2t0
b3Aub3JnL3NwaWNlL3NwaWNlL2lzc3Vlcy8yOS4KU3BlY2lmaWNhbGx5IGlmIHlvdSBoYXZlIGF0
dGVtcHQgdG8gdHJhbnNmZXIgYSBmaWxlIGZyb20gdGhlIGNsaWVudAp1c2luZyBXZWJEQVYuClBy
ZXZpb3VzbHkgdGhlIHF1ZXVlIHRvIHRoZSBkZXZpY2Ugd2FzIHVuYm91bmQuIElmIGRldmljZSB3
YXMgbm90CmdldHRpbmcgZGF0YSBmYXN0IGVub3VnaCB0aGUgc2VydmVyIHN0YXJ0ZWQgcXVldWlu
ZyBkYXRhLgpUbyBlYXNpbHkgdGVzdCB0aGlzIHlvdSBjYW4gc3VzcGVuZCB0aGUgV2ViREFWIGRh
ZW1vbiB3aGlsZSB0cmFuc2ZlcnJpbmcKYSBiaWcgZmlsZSBmcm9tIHRoZSBjbGllbnQuClRvIHNp
bXBsaWZ5IHRoZSBjb2RlIGFuZCByZWR1Y2UgdGhlIGNoYW5nZXMgc2VydmVyIGJ1ZmZlcnMgYXJl
CnVzZWQuIFRoaXMgYXMgY2xpZW50IHRva2VuIGltcGxlbWVudGF0aW9uIGlzIHdyaXR0ZW4gd2l0
aCBhZ2VudAppbiBtaW5kLiBXaGlsZSB3aGVuIHdlIGV4aGF1c3Qgc2VydmVyIHRva2VucyBSZWRD
aGFyRGV2aWNlIGRvZXNuJ3QKY2xvc2UgdGhlIGNsaWVudCB3aGVuIHdlIGV4aGF1c3QgY2xpZW50
IHRva2VucyBSZWRDaGFyRGV2aWNlIGNsb3Nlcwp0aGUgY2xpZW50IHdoaWNoIGluIHRoaXMgY2Fz
ZSBpdCdzIG5vdCB3YW50ZWQuCgpTaWduZWQtb2ZmLWJ5OiBGcmVkaWFubyBaaWdsaW8gPGZ6aWds
aW9AcmVkaGF0LmNvbT4KLS0tCiBzZXJ2ZXIvc3BpY2V2bWMuYyB8IDI2ICsrKysrKysrKysrKysr
KysrLS0tLS0tLS0tCiAxIGZpbGUgY2hhbmdlZCwgMTcgaW5zZXJ0aW9ucygrKSwgOSBkZWxldGlv
bnMoLSkKCmRpZmYgLS1naXQgYS9zZXJ2ZXIvc3BpY2V2bWMuYyBiL3NlcnZlci9zcGljZXZtYy5j
CmluZGV4IDAyZTkwMTk5Yy4uMTIwOWU3MTU1IDEwMDY0NAotLS0gYS9zZXJ2ZXIvc3BpY2V2bWMu
YworKysgYi9zZXJ2ZXIvc3BpY2V2bWMuYwpAQCAtNDkxLDkgKzQ5MSw5IEBAIHN0YXRpYyBib29s
IGhhbmRsZV9jb21wcmVzc2VkX21zZyhSZWRWbWNDaGFubmVsICpjaGFubmVsLCBSZWRDaGFubmVs
Q2xpZW50ICpyY2MsCiAgICAgaW50IGRlY29tcHJlc3NlZF9zaXplOwogICAgIFJlZENoYXJEZXZp
Y2VXcml0ZUJ1ZmZlciAqd3JpdGVfYnVmOwogCi0gICAgd3JpdGVfYnVmID0gcmVkX2NoYXJfZGV2
aWNlX3dyaXRlX2J1ZmZlcl9nZXRfY2xpZW50KGNoYW5uZWwtPmNoYXJkZXYsCi0gICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZF9jaGFubmVs
X2NsaWVudF9nZXRfY2xpZW50KHJjYyksCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXByZXNzZWRfZGF0YV9tc2ctPnVuY29tcHJlc3Nl
ZF9zaXplKTsKKyAgICB3cml0ZV9idWYgPSByZWRfY2hhcl9kZXZpY2Vfd3JpdGVfYnVmZmVyX2dl
dF9zZXJ2ZXIoY2hhbm5lbC0+Y2hhcmRldiwKKyAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcHJlc3NlZF9kYXRhX21zZy0+dW5jb21wcmVz
c2VkX3NpemUsCisgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgIGZhbHNlKTsKICAgICBpZiAoIXdyaXRlX2J1ZikgewogICAgICAgICByZXR1cm4g
RkFMU0U7CiAgICAgfQpAQCAtNTY1LDYgKzU2NSwxNSBAQCBzdGF0aWMgYm9vbCBzcGljZXZtY19y
ZWRfY2hhbm5lbF9jbGllbnRfaGFuZGxlX21lc3NhZ2UoUmVkQ2hhbm5lbENsaWVudCAqcmNjLAog
ICAgIHJldHVybiBUUlVFOwogfQogCisvKiBpZiBkZXZpY2UgbWFuYWdlIHRvIHNlbmQgc29tZSBk
YXRhIGF0dGVtcHQgdG8gdW5ibG9jayB0aGUgY2hhbm5lbCAqLworc3RhdGljIHZvaWQgc3BpY2V2
bWNfb25fZnJlZV9zZWxmX3Rva2VuKFJlZENoYXJEZXZpY2UgKnNlbGYpCit7CisgICAgUmVkQ2hh
ckRldmljZVNwaWNlVm1jICp2bWMgPSBSRURfQ0hBUl9ERVZJQ0VfU1BJQ0VWTUMoc2VsZik7Cisg
ICAgUmVkVm1jQ2hhbm5lbCAqY2hhbm5lbCA9IFJFRF9WTUNfQ0hBTk5FTCh2bWMtPmNoYW5uZWwp
OworCisgICAgcmVkX2NoYW5uZWxfY2xpZW50X3VuYmxvY2tfcmVhZChjaGFubmVsLT5yY2MpOwor
fQorCiBzdGF0aWMgdWludDhfdCAqc3BpY2V2bWNfcmVkX2NoYW5uZWxfYWxsb2NfbXNnX3Jjdl9i
dWYoUmVkQ2hhbm5lbENsaWVudCAqcmNjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgIHVpbnQxNl90IHR5cGUsCiAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdWludDMyX3Qgc2l6ZSkKQEAg
LTU3MiwxNiArNTgxLDE0IEBAIHN0YXRpYyB1aW50OF90ICpzcGljZXZtY19yZWRfY2hhbm5lbF9h
bGxvY19tc2dfcmN2X2J1ZihSZWRDaGFubmVsQ2xpZW50ICpyY2MsCiAKICAgICBzd2l0Y2ggKHR5
cGUpIHsKICAgICBjYXNlIFNQSUNFX01TR0NfU1BJQ0VWTUNfREFUQTogewotICAgICAgICBSZWRD
bGllbnQgKmNsaWVudCA9IHJlZF9jaGFubmVsX2NsaWVudF9nZXRfY2xpZW50KHJjYyk7CiAgICAg
ICAgIFJlZFZtY0NoYW5uZWwgKmNoYW5uZWwgPSBSRURfVk1DX0NIQU5ORUwocmVkX2NoYW5uZWxf
Y2xpZW50X2dldF9jaGFubmVsKHJjYykpOwogCiAgICAgICAgIGFzc2VydCghY2hhbm5lbC0+cmVj
dl9mcm9tX2NsaWVudF9idWYpOwogCi0gICAgICAgIGNoYW5uZWwtPnJlY3ZfZnJvbV9jbGllbnRf
YnVmID0gcmVkX2NoYXJfZGV2aWNlX3dyaXRlX2J1ZmZlcl9nZXRfY2xpZW50KGNoYW5uZWwtPmNo
YXJkZXYsCi0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsaWVudCwKLSAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgc2l6ZSk7CisgICAgICAgIGNoYW5uZWwtPnJlY3ZfZnJvbV9jbGllbnRfYnVmID0gcmVk
X2NoYXJfZGV2aWNlX3dyaXRlX2J1ZmZlcl9nZXRfc2VydmVyKGNoYW5uZWwtPmNoYXJkZXYsCisg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAgIHNpemUsIHRydWUpOwogICAgICAgICBpZiAoIWNoYW5uZWwt
PnJlY3ZfZnJvbV9jbGllbnRfYnVmKSB7Ci0gICAgICAgICAgICBzcGljZV9lcnJvcigiZmFpbGVk
IHRvIGFsbG9jYXRlIHdyaXRlIGJ1ZmZlciIpOworICAgICAgICAgICAgcmVkX2NoYW5uZWxfY2xp
ZW50X2Jsb2NrX3JlYWQocmNjKTsKICAgICAgICAgICAgIHJldHVybiBOVUxMOwogICAgICAgICB9
CiAgICAgICAgIHJldHVybiBjaGFubmVsLT5yZWN2X2Zyb21fY2xpZW50X2J1Zi0+YnVmOwpAQCAt
OTA4LDYgKzkxNSw3IEBAIHJlZF9jaGFyX2RldmljZV9zcGljZXZtY19jbGFzc19pbml0KFJlZENo
YXJEZXZpY2VTcGljZVZtY0NsYXNzICprbGFzcykKICAgICBjaGFyX2Rldl9jbGFzcy0+c2VuZF9t
c2dfdG9fY2xpZW50ID0gc3BpY2V2bWNfY2hhcmRldl9zZW5kX21zZ190b19jbGllbnQ7CiAgICAg
Y2hhcl9kZXZfY2xhc3MtPnJlbW92ZV9jbGllbnQgPSBzcGljZXZtY19jaGFyX2Rldl9yZW1vdmVf
Y2xpZW50OwogICAgIGNoYXJfZGV2X2NsYXNzLT5wb3J0X2V2ZW50ID0gc3BpY2V2bWNfcG9ydF9l
dmVudDsKKyAgICBjaGFyX2Rldl9jbGFzcy0+b25fZnJlZV9zZWxmX3Rva2VuID0gc3BpY2V2bWNf
b25fZnJlZV9zZWxmX3Rva2VuOwogCiAgICAgZ19vYmplY3RfY2xhc3NfaW5zdGFsbF9wcm9wZXJ0
eShvYmplY3RfY2xhc3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQUk9Q
X0NIQU5ORUwsCkBAIC05MzQsNyArOTQyLDcgQEAgcmVkX2NoYXJfZGV2aWNlX3NwaWNldm1jX25l
dyhTcGljZUNoYXJEZXZpY2VJbnN0YW5jZSAqc2luLAogICAgICAgICAgICAgICAgICAgICAgICAg
InNpbiIsIHNpbiwKICAgICAgICAgICAgICAgICAgICAgICAgICJzcGljZS1zZXJ2ZXIiLCByZWRz
LAogICAgICAgICAgICAgICAgICAgICAgICAgImNsaWVudC10b2tlbnMtaW50ZXJ2YWwiLCAwVUxM
LAotICAgICAgICAgICAgICAgICAgICAgICAgInNlbGYtdG9rZW5zIiwgfjBVTEwsCisgICAgICAg
ICAgICAgICAgICAgICAgICAic2VsZi10b2tlbnMiLCAxMjgsIC8vIGxpbWl0IG51bWJlciBvZiBt
ZXNzYWdlcyBzZW50IHRvIGRldmljZQogICAgICAgICAgICAgICAgICAgICAgICAgImNoYW5uZWwi
LCBjaGFubmVsLAogICAgICAgICAgICAgICAgICAgICAgICAgTlVMTCk7CiB9Ci0tIAoyLjIwLjEK
Cl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClNwaWNlLWRl
dmVsIG1haWxpbmcgbGlzdApTcGljZS1kZXZlbEBsaXN0cy5mcmVlZGVza3RvcC5vcmcKaHR0cHM6
Ly9saXN0cy5mcmVlZGVza3RvcC5vcmcvbWFpbG1hbi9saXN0aW5mby9zcGljZS1kZXZlbA==
